<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Defcon CTF 2022: Self-Reflection - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99"><meta property="og:title" content="Defcon CTF 2022: Self-Reflection" />
<meta property="og:description" content="Self-reflection on Defcon CTF 2022" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chovid99.github.io/posts/defcon-ctf-2022-self-reflection/" /><meta property="og:image" content="https://chovid99.github.io/C99-web-card.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-03T21:08:00+07:00" />
<meta property="article:modified_time" content="2023-02-24T14:07:40+07:00" /><meta property="og:site_name" content="Welcome to Chovid99&#39;s Blog" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png" /><meta name="twitter:title" content="Defcon CTF 2022: Self-Reflection"/>
<meta name="twitter:description" content="Self-reflection on Defcon CTF 2022"/>
      <meta name="twitter:site" content="@Chovid99"/>
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/defcon-ctf-2022-self-reflection/" /><link rel="prev" href="https://chovid99.github.io/posts/cyber-apocalypse-ctf-2022/" /><link rel="next" href="https://chovid99.github.io/posts/seetf-2022/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Defcon CTF 2022: Self-Reflection",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/defcon-ctf-2022-self-reflection\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "tech, DefconCTF, reflection, notes, pwn, 2022","wordcount":  3563 ,
        "url": "https:\/\/chovid99.github.io\/posts\/defcon-ctf-2022-self-reflection\/","datePublished": "2022-06-03T21:08:00+07:00","dateModified": "2023-02-24T14:07:40+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Chovid99"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Defcon CTF 2022: Self-Reflection</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Jun 03, 2022">Jun 03, 2022</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;3563 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;17 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#smugglers-cove">Smuggler&rsquo;s Cove</a>
      <ul>
        <li><a href="#initial-analysis">Initial Analysis</a></li>
        <li><a href="#exploitation-plan">Exploitation Plan</a></li>
        <li><a href="#failure">Failure</a></li>
        <li><a href="#reflections">Reflections</a></li>
        <li><a href="#sources">Sources</a></li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/n4uFMzD.png"
        data-srcset="https://i.imgur.com/n4uFMzD.png, https://i.imgur.com/n4uFMzD.png 1.5x, https://i.imgur.com/n4uFMzD.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/n4uFMzD.png"
        title="https://i.imgur.com/n4uFMzD.png" />
I didn&rsquo;t do well on this Defcon, so this isn&rsquo;t a writeup, but just to shared what I&rsquo;ve learned during working on the Defcon, especially on the Luajit chall. I apologize in advance if there is some mistake on this article, as I just learn all of it during the Defcon.</p>
<p>During Defcon, I only work on three challenge with the help of my teammates, which are same_old, hash-it, and smuggler&rsquo;s cove. We submit the flag for same_old and hash-it, and I spend the whole two days on the smuggler&rsquo;s cove, but failed to solve it.</p>
<p>On this article, I&rsquo;ll try to summarize what I learned during working on the chall, my failed attempts on smuggler&rsquo;s cove, and the correct approach which I know after the CTF ended. I write this for my future notes in case I faced this kind of problem again.</p>
<h1 id="smugglers-cove">Smuggler&rsquo;s Cove</h1>
<h2 id="initial-analysis">Initial Analysis</h2>
<p>On this chall, we were given <code>Dockerfile</code>, <code>cove.c</code>, <code>dig_up_the_loot.c</code>, and the binaries of the given source code. Let&rsquo;s take a look on the <code>Dockerfile</code>. The server is running the binary of <code>cove.c</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">FROM ubuntu:20.04
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">WORKDIR /challenge
</span></span><span class="line"><span class="cl">ARG DEBIAN_FRONTEND=noninteractive
</span></span><span class="line"><span class="cl"># upgrade ran at Fri May 27 15:18:42 UTC 2022 (see packages.txt)
</span></span><span class="line"><span class="cl">RUN apt-get update &amp;&amp; apt-get upgrade -y &amp;&amp; apt-get install curl -y &amp;&amp; apt list --installed &gt; /packages.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">COPY libluajit-5.1.so.2 /usr/local/lib/libluajit-5.1.so.2
</span></span><span class="line"><span class="cl">COPY cove dig_up_the_loot /challenge/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">RUN ldconfig &amp;&amp; chmod 111 /challenge/dig_up_the_loot
</span></span><span class="line"><span class="cl">RUN adduser --no-create-home --disabled-password --gecos &#34;&#34; user
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">USER user
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ENTRYPOINT [&#34;/challenge/cove&#34;]
</span></span></code></pre></td></tr></table>
</div>
</div><p>So the server was running the most recent of Ubuntu20.04, which got upgraded just on Friday (D-1 Defcon CTF). I think this will help us a lot, as I also use Ubuntu20.04 on my local, and I can simply run update &amp; upgrade to replicate the server environment.</p>
<p>Now, checking the file <code>dig_up_the_loot.c</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#34;x&#34;</span><span class="p">,</span> <span class="s">&#34;marks&#34;</span><span class="p">,</span> <span class="s">&#34;the&#34;</span><span class="p">,</span> <span class="s">&#34;spot&#34;</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">num_args</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="n">num_args</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Avast ye missing arguments: ./dig_up_the_loot&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">num_args</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34; %s&#34;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">num_args</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Blimey! Are missing your map?&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Shiver me timbers! Thar be your flag: FLAG PLACEHOLDER&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, so seems like we need to run <code>./dig_up_the_loot x marks the spot</code> in order to retrieve the flag. Let&rsquo;s move to the main source code (<code>cove.c</code>), which we should abuse.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;lua.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;lualib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;lauxlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;luajit.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;lj_dispatch.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;lj_obj.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define MAX_SIZE 433
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">GCtrace</span><span class="o">*</span> <span class="nf">getTrace</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">jit_State</span><span class="o">*</span> <span class="n">js</span> <span class="o">=</span> <span class="nf">L2J</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">js</span><span class="o">-&gt;</span><span class="n">sizetrace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">GCtrace</span><span class="o">*</span><span class="p">)</span><span class="nf">gcref</span><span class="p">(</span><span class="n">js</span><span class="o">-&gt;</span><span class="n">trace</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">print</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">lua_gettop</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;expecting at least 1 arguments&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">s</span> <span class="o">=</span> <span class="nf">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">debug_jit</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">lua_gettop</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;expecting exactly 1 arguments&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">luaL_checktype</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LUA_TFUNCTION</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">GCfunc</span><span class="o">*</span> <span class="n">v</span> <span class="o">=</span> <span class="nf">lua_topointer</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">isluafunc</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;expecting lua function&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="nf">lua_tointeger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">bytecode</span> <span class="o">=</span> <span class="nf">mref</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">.</span><span class="n">pc</span><span class="p">,</span> <span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">op</span> <span class="o">=</span> <span class="n">bytecode</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">index</span> <span class="o">=</span> <span class="n">bytecode</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">GCtrace</span><span class="o">*</span> <span class="n">t</span> <span class="o">=</span> <span class="nf">getTrace</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mcode</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">szmcode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;Blimey! There is no cargo in this ship!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;INSPECTION: This ship&#39;s JIT cargo was found to be %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mcode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">szmcode</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nf">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;Avast! Offset too large!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">-&gt;</span><span class="n">mcode</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">-&gt;</span><span class="n">szmcode</span> <span class="o">-=</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;... yarr let ye apply a secret offset, cargo is now %p ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mcode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">set_jit_settings</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">luaL_dostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;jit.opt.start(&#39;3&#39;);&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;jit.opt.start(&#39;hotloop=1&#39;);&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init_lua</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Init JIT lib
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">luaopen_jit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_pushstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">LUA_JITLIBNAME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_call</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">set_jit_settings</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;jit&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_pop</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">debug_jit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;cargo&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">print</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;print&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">run_code</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">max_size</span> <span class="o">=</span> <span class="n">MAX_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">code</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="n">max_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span><span class="o">*</span> <span class="n">f</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s">&#34;r&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Unable to open file&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fseek</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="nf">ftell</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Too large&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">fseek</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fread</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">fclose</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">luaL_dostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Lua error: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Missing lua cargo to inspect&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">L</span> <span class="o">=</span> <span class="nf">luaL_newstate</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Failed to load lua&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">init_lua</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">run_code</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">lua_close</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>I never knew what is Lua before working on this chall, so during working on this chall:</p>
<ul>
<li>I open the <a href="https://www.lua.org/manual/5.1/" target="_blank" rel="noopener noreffer ">Lua documentation</a></li>
<li>I clone the <a href="https://github.com/LuaJIT/LuaJIT" target="_blank" rel="noopener noreffer ">Luajit</a> repo</li>
<li>I debug it with GDB one by one to understand better about it.</li>
</ul>
<p>Based on the file included header, I assume that we are dealing with LuaJIT instead of baseline lua. Which is why I try to clone the Luajit also to understand some method functionality.</p>
<p>Let&rsquo;s try to analysis the source code first. We start by reading the main func</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Missing lua cargo to inspect&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">L</span> <span class="o">=</span> <span class="nf">luaL_newstate</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Failed to load lua&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">init_lua</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">run_code</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">lua_close</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So the main function basically will init some initial state of the luajit (I don&rsquo;t know yet what is lua state?), and we need to pass an arg (?). Let&rsquo;s take a look on the <code>run_code</code> first, so that we know what is the <code>arg</code> value.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">run_code</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">max_size</span> <span class="o">=</span> <span class="n">MAX_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">code</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="n">max_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span><span class="o">*</span> <span class="n">f</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s">&#34;r&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Unable to open file&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fseek</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="nf">ftell</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Too large&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">fseek</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fread</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">fclose</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">luaL_dostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Lua error: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ah, so turn out the arg is the lua script filename. And later, <code>run_code</code> will try to load this code in the memory, and pass it to <code>luaL_dostring</code>. Notes that there is a limit of the lua script size that we can submit. I assume that <code>luaL_dostring</code> is method in the Luajit library, which will execute the given code.
Moving back, let&rsquo;s take a look on what does the <code>init_lua</code> do.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">set_jit_settings</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">luaL_dostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;jit.opt.start(&#39;3&#39;);&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;jit.opt.start(&#39;hotloop=1&#39;);&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init_lua</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Init JIT lib
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">luaopen_jit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_pushstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">LUA_JITLIBNAME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_call</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">set_jit_settings</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;jit&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_pop</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">debug_jit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;cargo&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">print</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;print&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>I don&rsquo;t understand at all what this method do as this is the first time I learn Lua. So, what I do is checking the official documentation of Lua. This is what it says about <code>lua_call</code> API.
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/3gY4Bbu.png"
        data-srcset="https://i.imgur.com/3gY4Bbu.png, https://i.imgur.com/3gY4Bbu.png 1.5x, https://i.imgur.com/3gY4Bbu.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/3gY4Bbu.png"
        title="https://i.imgur.com/3gY4Bbu.png" /></p>
<p>Ah okay! So turn out, you need to push the function that you want to call + the args. So the first four lines is trying to to load <code>LUA_JITLIBNAME</code> library, and then call <code>set_jit_settings</code>, which set the jit configs. Details of what the config means can be found in <a href="https://luajit.org/ext_jit.html" target="_blank" rel="noopener noreffer ">here</a> and <a href="https://luajit.org/running.html" target="_blank" rel="noopener noreffer ">here</a>.</p>
<p>And then, let see the next code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="nf">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;jit&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_pop</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/IjmBm8R.png"
        data-srcset="https://i.imgur.com/IjmBm8R.png, https://i.imgur.com/IjmBm8R.png 1.5x, https://i.imgur.com/IjmBm8R.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/IjmBm8R.png"
        title="https://i.imgur.com/IjmBm8R.png" /></p>
<p>Based on the documentation, basically it set global variable <code>jit</code> to nil. So that means, we can&rsquo;t use library <code>jit</code> during passing our code to the binary.</p>
<p>And the last piece of code is</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="nf">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">debug_jit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;cargo&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">print</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;print&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/i9kw0gg.png"
        data-srcset="https://i.imgur.com/i9kw0gg.png, https://i.imgur.com/i9kw0gg.png 1.5x, https://i.imgur.com/i9kw0gg.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/i9kw0gg.png"
        title="https://i.imgur.com/i9kw0gg.png" /></p>
<p>On this code, what it does is basically, if we call <code>cargo</code> or <code>print</code> in our input lua script, the Luajit will call the defined <code>debug_jit</code> and <code>print</code> c-function instead. Let&rsquo;s take a look on the <code>print</code> method first.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">print</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">lua_gettop</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;expecting at least 1 arguments&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">s</span> <span class="o">=</span> <span class="nf">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Nothing special, basically we can pass one lua element, convert it to string, and print it. Now, let&rsquo;s take a look on the <code>debug_jit</code> method</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">debug_jit</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">lua_gettop</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;expecting exactly 1 arguments&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">luaL_checktype</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LUA_TFUNCTION</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">GCfunc</span><span class="o">*</span> <span class="n">v</span> <span class="o">=</span> <span class="nf">lua_topointer</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">isluafunc</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;expecting lua function&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="nf">lua_tointeger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">bytecode</span> <span class="o">=</span> <span class="nf">mref</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">.</span><span class="n">pc</span><span class="p">,</span> <span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">op</span> <span class="o">=</span> <span class="n">bytecode</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">index</span> <span class="o">=</span> <span class="n">bytecode</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">GCtrace</span><span class="o">*</span> <span class="n">t</span> <span class="o">=</span> <span class="nf">getTrace</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mcode</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">szmcode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;Blimey! There is no cargo in this ship!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;INSPECTION: This ship&#39;s JIT cargo was found to be %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mcode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">szmcode</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nf">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;Avast! Offset too large!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">-&gt;</span><span class="n">mcode</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">-&gt;</span><span class="n">szmcode</span> <span class="o">-=</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;... yarr let ye apply a secret offset, cargo is now %p ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mcode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So based on that code, seems like <code>debug_jit</code> will need 2 arguments. Let&rsquo;s disass it one by one.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="nf">luaL_checktype</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LUA_TFUNCTION</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">GCfunc</span><span class="o">*</span> <span class="n">v</span> <span class="o">=</span> <span class="nf">lua_topointer</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">isluafunc</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;expecting lua function&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So, the first argument needs to be a lua function. Reading through the documentation of <code>lua_topointer</code>
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/tE0du9z.png"
        data-srcset="https://i.imgur.com/tE0du9z.png, https://i.imgur.com/tE0du9z.png 1.5x, https://i.imgur.com/tE0du9z.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/tE0du9z.png"
        title="https://i.imgur.com/tE0du9z.png" />
What it does is generate a c pointer to the given function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="nf">lua_tointeger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">bytecode</span> <span class="o">=</span> <span class="nf">mref</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">.</span><span class="n">pc</span><span class="p">,</span> <span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">op</span> <span class="o">=</span> <span class="n">bytecode</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">index</span> <span class="o">=</span> <span class="n">bytecode</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">GCtrace</span><span class="o">*</span> <span class="n">t</span> <span class="o">=</span> <span class="nf">getTrace</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mcode</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">szmcode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;Blimey! There is no cargo in this ship!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;INSPECTION: This ship&#39;s JIT cargo was found to be %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mcode</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And then, we can see that the second argument is stored as <code>offset</code> with type <code>uint8_t</code>. So offset will never be a negative value. We will back to what <code>offset</code> is actually doing later.</p>
<p>We see that from the retrieved pointer <code>v</code>, we try to get the bytecode, get its <code>op</code> and <code>index</code>, and then the <code>index</code> got passed to <code>getTrace</code> function. And the result isn&rsquo;t allowed to be nil.</p>
<p>I don&rsquo;t know at all what is <code>GCtrace</code>, and I don&rsquo;t know how Luajit working. So let&rsquo;s try to gather some knowledge on what it is, and what the code is doing.</p>
<blockquote>
<p>Notes that what a JIT does is usually parsing the source code into their own bytecode, and then execute it. This bytecodes are machine agnostic. And then, some bytecode will be compiled and stored as native machine code as part of JIT optimization. By doing this, JIT can always ensure that it will always optimize the compiled code based on the target machine architecture.</p>
</blockquote>
<p>Based on this <a href="https://pwparchive.wordpress.com/2012/10/16/peeking-inside-luajit/" target="_blank" rel="noopener noreffer ">nice article</a> about Luajit, I learned that Luajit is a <strong>tracing-JIT</strong> instead of <strong>method-JIT</strong>. So, instead of optimizing hot method (method those are frequently called or executed), it will record sequence of executing operations frequency, and then only compile sequence which are frequently to be executed (hot traces). Based on <a href="https://en.wikipedia.org/wiki/Tracing_just-in-time_compilation" target="_blank" rel="noopener noreffer ">wikipedia</a>, tracing JIT assumes that hot loops (frequent loops or repetition of sequential operations) will make program spend a lot of time.</p>
<blockquote>
<p>trace is an object which refer to the JIT-Compiled machine code version of the sequence of the bytecodes</p>
</blockquote>
<p>Moving back to the given code, now we can deduce more about what it actually does. So, my deduction is, from our chosen function, it will check its bytecode of the function. Based on the <a href="http://wiki.luajit.org/Bytecode-2.0" target="_blank" rel="noopener noreffer ">Luajit bytecode documentation</a>, there are two formats on how a bytecode stored.
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/fPoqo71.png"
        data-srcset="https://i.imgur.com/fPoqo71.png, https://i.imgur.com/fPoqo71.png 1.5x, https://i.imgur.com/fPoqo71.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/fPoqo71.png"
        title="https://i.imgur.com/fPoqo71.png" />
We can see in below image, that for function which is JIT-compiled, it will follow the second format.
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/MvtxuCa.png"
        data-srcset="https://i.imgur.com/MvtxuCa.png, https://i.imgur.com/MvtxuCa.png 1.5x, https://i.imgur.com/MvtxuCa.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/MvtxuCa.png"
        title="https://i.imgur.com/MvtxuCa.png" />
Now, we can understand better on what this snippet code does.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">bytecode</span> <span class="o">=</span> <span class="nf">mref</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">.</span><span class="n">pc</span><span class="p">,</span> <span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">op</span> <span class="o">=</span> <span class="n">bytecode</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">index</span> <span class="o">=</span> <span class="n">bytecode</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Basically, what it want to achieve is, it will try to retrieve the trace number (index) of the given function in the <code>debug_jit</code> arg. And then, it will try to get the trace based on the stored trace&rsquo;s index. Notes that because Luajit is <strong>tracing-JIT</strong>, based on my understanding, it is possible that a function didn&rsquo;t get JIT-Compiled, and it is possible that some sequential operation inside of the method is the one who got traced.</p>
<p>Now, Let&rsquo;s check the <code>getTrace</code> method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">GCtrace</span><span class="o">*</span> <span class="nf">getTrace</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">jit_State</span><span class="o">*</span> <span class="n">js</span> <span class="o">=</span> <span class="nf">L2J</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">js</span><span class="o">-&gt;</span><span class="n">sizetrace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">GCtrace</span><span class="o">*</span><span class="p">)</span><span class="nf">gcref</span><span class="p">(</span><span class="n">js</span><span class="o">-&gt;</span><span class="n">trace</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ah from the code, we can deduce that, in the memory, there are an array of pointer, where each pointer points to a trace object (<code>GCtrace</code>). In the given binary, basically this method will be used to return the method <code>GCTrace</code> object if the method got JIT-Compiled. And the trace-index is retrieved from the function header bytecode (which we have retrieved in the previous snippet).</p>
<p>Let&rsquo;s move to the final code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mcode</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">szmcode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;Blimey! There is no cargo in this ship!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;INSPECTION: This ship&#39;s JIT cargo was found to be %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mcode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">szmcode</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nf">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;Avast! Offset too large!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">-&gt;</span><span class="n">mcode</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">-&gt;</span><span class="n">szmcode</span> <span class="o">-=</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;... yarr let ye apply a secret offset, cargo is now %p ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">mcode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To understand it better, let&rsquo;s check the <code>GCTrace</code> struct definition from our cloned Luajit repository.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* Trace object. */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">GCtrace</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">GCHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint16_t</span> <span class="n">nsnap</span><span class="p">;</span>	<span class="cm">/* Number of snapshots. */</span>
</span></span><span class="line"><span class="cl">  <span class="n">IRRef</span> <span class="n">nins</span><span class="p">;</span>		<span class="cm">/* Next IR instruction. Biased with REF_BIAS. */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if LJ_GC64
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">uint32_t</span> <span class="n">unused_gc64</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">GCRef</span> <span class="n">gclist</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">IRIns</span> <span class="o">*</span><span class="n">ir</span><span class="p">;</span>		<span class="cm">/* IR instructions/constants. Biased with REF_BIAS. */</span>
</span></span><span class="line"><span class="cl">  <span class="n">IRRef</span> <span class="n">nk</span><span class="p">;</span>		<span class="cm">/* Lowest IR constant. Biased with REF_BIAS. */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint32_t</span> <span class="n">nsnapmap</span><span class="p">;</span>	<span class="cm">/* Number of snapshot map elements. */</span>
</span></span><span class="line"><span class="cl">  <span class="n">SnapShot</span> <span class="o">*</span><span class="n">snap</span><span class="p">;</span>	<span class="cm">/* Snapshot array. */</span>
</span></span><span class="line"><span class="cl">  <span class="n">SnapEntry</span> <span class="o">*</span><span class="n">snapmap</span><span class="p">;</span>	<span class="cm">/* Snapshot map. */</span>
</span></span><span class="line"><span class="cl">  <span class="n">GCRef</span> <span class="n">startpt</span><span class="p">;</span>	<span class="cm">/* Starting prototype. */</span>
</span></span><span class="line"><span class="cl">  <span class="n">MRef</span> <span class="n">startpc</span><span class="p">;</span>		<span class="cm">/* Bytecode PC of starting instruction. */</span>
</span></span><span class="line"><span class="cl">  <span class="n">BCIns</span> <span class="n">startins</span><span class="p">;</span>	<span class="cm">/* Original bytecode of starting instruction. */</span>
</span></span><span class="line"><span class="cl">  <span class="n">MSize</span> <span class="n">szmcode</span><span class="p">;</span>	<span class="cm">/* Size of machine code. */</span>
</span></span><span class="line"><span class="cl">  <span class="n">MCode</span> <span class="o">*</span><span class="n">mcode</span><span class="p">;</span>		<span class="cm">/* Start of machine code. */</span>
</span></span><span class="line"><span class="cl">  <span class="n">MSize</span> <span class="n">mcloop</span><span class="p">;</span>		<span class="cm">/* Offset of loop start in machine code. */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint16_t</span> <span class="n">nchild</span><span class="p">;</span>	<span class="cm">/* Number of child traces (root trace only). */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint16_t</span> <span class="n">spadjust</span><span class="p">;</span>	<span class="cm">/* Stack pointer adjustment (offset in bytes). */</span>
</span></span><span class="line"><span class="cl">  <span class="n">TraceNo1</span> <span class="n">traceno</span><span class="p">;</span>	<span class="cm">/* Trace number. */</span>
</span></span><span class="line"><span class="cl">  <span class="n">TraceNo1</span> <span class="n">link</span><span class="p">;</span>	<span class="cm">/* Linked trace (or self for loops). */</span>
</span></span><span class="line"><span class="cl">  <span class="n">TraceNo1</span> <span class="n">root</span><span class="p">;</span>	<span class="cm">/* Root trace of side trace (or 0 for root traces). */</span>
</span></span><span class="line"><span class="cl">  <span class="n">TraceNo1</span> <span class="n">nextroot</span><span class="p">;</span>	<span class="cm">/* Next root trace for same prototype. */</span>
</span></span><span class="line"><span class="cl">  <span class="n">TraceNo1</span> <span class="n">nextside</span><span class="p">;</span>	<span class="cm">/* Next side trace of same root trace. */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint8_t</span> <span class="n">sinktags</span><span class="p">;</span>	<span class="cm">/* Trace has SINK tags. */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint8_t</span> <span class="n">topslot</span><span class="p">;</span>	<span class="cm">/* Top stack slot already checked to be allocated. */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint8_t</span> <span class="n">linktype</span><span class="p">;</span>	<span class="cm">/* Type of link. */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint8_t</span> <span class="n">unused1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef LUAJIT_USE_GDBJIT
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">void</span> <span class="o">*</span><span class="n">gdbjit_entry</span><span class="p">;</span>	<span class="cm">/* GDB JIT entry. */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">}</span> <span class="n">GCtrace</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>I think the comment code is already self-explanatory. What the code does is basically check whether:</p>
<ul>
<li>The returned <code>GCTrace</code> (which is <code>t</code>) from <code>getTrace</code> function is nil or not</li>
<li>The <code>mcode</code> (which is pointer to the start of the compiled machine code) is nil or not</li>
<li>The <code>szmcode</code> (which is the size of the compiled machine code) is 0 or not.</li>
</ul>
<p>Now, the final part is where the <code>offset</code> that we pass during calling the <code>debug_jit</code> is used. Turn out, the <code>debug_jit</code> method will allow us to <strong>shift the start of the compiled machine code</strong>, with restriction that the shift offset need to be less than the size of the compiled machine code. Finally, we understand what the given binary is actually doing.</p>
<h2 id="exploitation-plan">Exploitation Plan</h2>
<p>To summarize, so basically what the binary do is:</p>
<ul>
<li>Initialize a Luajit</li>
<li>Read our given lua script</li>
<li>Run it inside Luajit</li>
</ul>
<p>What make the given binary special is the <code>debug_jit</code> method, where we can use it to shift the start of our method JIT-compiled machine code (Notes that it only allowed us to shift the trace of Lua function which got JIT-Compiled).</p>
<p>So now, it is clear that, what we need to is somehow, use the <code>debug_jit</code> method feature, to do RCE and execute command <code>./dig_up_the_loot x marks the spot</code>.</p>
<p>Reading this <a href="http://pwning.net/pwn/2012/05/21/jit-source-and-writeup/" target="_blank" rel="noopener noreffer ">writeup</a> from past CTF gave me a clear idea on how to do it. Basically, what we need to do is to craft a lua method, which the compiled machine code will have controllable constants. For example, what we aim to do is to have the trace machine code contains instruction like this</p>
<ul>
<li><code>mov rdi, 0x22eb006a61c18348</code></li>
<li><code>cmp ebp, 0x6161616161</code></li>
<li>etc</li>
</ul>
<p>And then, reserve the last 2 byte as our jump instruction to the other constant, and use the remaining bytes to craft our shellcode, which will execute our target command.</p>
<h2 id="failure">Failure</h2>
<p>Well, at the end, I failed to solve it during the CTF, because I couldn&rsquo;t craft any payload which satisfy it. What I found during CTF is that if we able to produce bytecode <code>int LE xxx</code>, we can generate an int constant. But somehow, I can only produce it by using <code>for</code> loop, but as we know that Luajit is a <strong>tracing-method</strong>, it will only traced the <code>for</code> loop instead of the method that I defined. I use <code>luajit</code> to help me debugging it.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/X1H4Ahd.png"
        data-srcset="https://i.imgur.com/X1H4Ahd.png, https://i.imgur.com/X1H4Ahd.png 1.5x, https://i.imgur.com/X1H4Ahd.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/X1H4Ahd.png"
        title="https://i.imgur.com/X1H4Ahd.png" /></p>
<p>Above is the only payload that I found during the CTF that able to produce constants, yet I can&rsquo;t use it because it is not a method trace (The trace is belong to the for loop sequence, not to the method that I defined).</p>
<h2 id="reflections">Reflections</h2>
<p>After the CTF end, the chall&rsquo;s author tell me on the trick how to produce the constants. And also I read two great writeups in ctftime (<a href="https://0xten.gitbook.io/public/defcon/2022/quals/smugglers-cove" target="_blank" rel="noopener noreffer ">here</a> and <a href="https://uz56764.tistory.com/55" target="_blank" rel="noopener noreffer ">here</a>) which is super great.</p>
<p>I missed out that in Lua, every number is by default treated as floating point, so the hex that I should consider inside the compiled machine code is floating-point hex. And turn out, some tricks that we can use to produce constants:</p>
<ul>
<li>Define the constant as index of an array. Ex <code>m[100]=0</code></li>
<li>Add <code>LL</code> suffix in comparison. Ex: <code>if i == 0xdeadbeefcafebabeLL</code></li>
</ul>
<p>I&rsquo;ve actually tried the index of array trick, but as I mentioned before, my mistake is not treating it as floating point, which make me failed to see the constant during debugging with the <code>luajit</code>. So when I specify <code>m[0x61616161]=0</code>, I expect to see <code>0x61616161</code> in the compiled machine code, while what the compiled machine code is converting it to floating-point hex representation due to the fact that Lua treat all numbers as floating point by default, which makes me unable to realize that I actually able to produce constant. This is a great lesson for me, as I failed to notice this during working on the chall.</p>
<p>So after reading the writeup, I managed to try to implement it and solve it in my local. I feel sad because I didn&rsquo;t solve this chall during working on the CTF, but on the bright part, I learned a lot of new things related to Luajit. I hope that if in the future I face a challenge related to Luajit, I&rsquo;ll be able to tackle and solve it.</p>
<p>Thanks for the chall&rsquo;s author and the writeup&rsquo;s author for providing me a new knowledge about this.</p>
<h2 id="sources">Sources</h2>
<ul>
<li><a href="https://0xten.gitbook.io/public/defcon/2022/quals/smugglers-cove" target="_blank" rel="noopener noreffer ">https://0xten.gitbook.io/public/defcon/2022/quals/smugglers-cove</a></li>
<li><a href="https://uz56764.tistory.com/55" target="_blank" rel="noopener noreffer ">https://uz56764.tistory.com/55</a></li>
<li><a href="http://pwning.net/pwn/2012/05/21/jit-source-and-writeup/" target="_blank" rel="noopener noreffer ">http://pwning.net/pwn/2012/05/21/jit-source-and-writeup/</a></li>
<li><a href="https://pwparchive.wordpress.com/2012/10/16/peeking-inside-luajit/" target="_blank" rel="noopener noreffer ">https://pwparchive.wordpress.com/2012/10/16/peeking-inside-luajit/</a></li>
<li><a href="https://www.lua.org/manual/5.1/" target="_blank" rel="noopener noreffer ">https://www.lua.org/manual/5.1/</a></li>
<li><a href="http://wiki.luajit.org/Bytecode-2.0" target="_blank" rel="noopener noreffer ">http://wiki.luajit.org/Bytecode-2.0</a></li>
</ul>
<h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/defcon-ctf-2022-self-reflection/" data-title="Defcon CTF 2022: Self-Reflection" data-via="Chovid99" data-hashtags="tech,DefconCTF,reflection,notes,pwn,2022"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/defcon-ctf-2022-self-reflection/" data-hashtag="tech"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/tech/">Tech</a>,&nbsp;<a href="/tags/defconctf/">DefconCTF</a>,&nbsp;<a href="/tags/reflection/">Reflection</a>,&nbsp;<a href="/tags/notes/">Notes</a>,&nbsp;<a href="/tags/pwn/">Pwn</a>,&nbsp;<a href="/tags/2022/">2022</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/cyber-apocalypse-ctf-2022/" class="prev" rel="prev" title="Cyber Apocalypse CTF 2022"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Cyber Apocalypse CTF 2022</a>
            <a href="/posts/seetf-2022/" class="next" rel="next" title="SEETF 2022">SEETF 2022<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://twitter.com/Chovid99" target="_blank">Chovid99</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
