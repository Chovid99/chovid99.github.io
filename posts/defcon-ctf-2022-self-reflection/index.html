<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Defcon CTF 2022: Self-Reflection | Welcome to Chovid99&#39;s Blog</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta property="og:title" content="Defcon CTF 2022: Self-Reflection" />
<meta property="og:description" content="Self-reflection on Defcon CTF 2022" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chovid99.github.io/posts/defcon-ctf-2022-self-reflection/" /><meta property="og:image" content="https://chovid99.github.io/site-feature-image.jpeg"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-03T21:08:00+07:00" />
<meta property="article:modified_time" content="2022-06-03T21:08:00+07:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image:src" content="https://chovid99.github.io/site-feature-image.jpeg"/>

<meta name="twitter:title" content="Defcon CTF 2022: Self-Reflection"/>
<meta name="twitter:description" content="Self-reflection on Defcon CTF 2022"/>
<meta name="twitter:site" content="@Chovid99"/>
<meta name="twitter:creator" content="@Chovid99"/>
<meta property="og:site_name" content="Chovid99's Blog">

<meta name="generator" content="Hugo 0.95.0" />


  <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">


<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/tocbot.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />


  <script async src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-19HP521HQ9');
  </script>



  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"
    onload="renderMathInElement(document.body, {delimiters: [{left: '$$', right: '$$', display: true}, {left: '\\[', right: '\\[', display: true}, {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}]});"></script>






  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">←</span>Home</a>
	
	<a href="/posts">Posts</a>
	<a href="/tags">Tags</a>
	<a href="/about">About</a>

	

	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">Defcon CTF 2022: Self-Reflection</h1>

    <div class="tip">
        <time datetime="2022-06-03 21:08:00 &#43;0700 &#43;0700">Jun 3, 2022</time>
        <span class="split">
          ·
        </span>
        <span>
          3554 words
        </span>
        <span class="split">
          ·
        </span>
        <span>
          17 minute read
        </span>
    </div>

    <div class="content">
      <div class="post-content js-toc-content">
        <p><p class="markdown-image">
  <img src="https://i.imgur.com/n4uFMzD.png" alt=""  />
</p>
I didn&rsquo;t do well on this Defcon, so this isn&rsquo;t a writeup, but just to shared what I&rsquo;ve learned during working on the Defcon, especially on the Luajit chall. I apologize in advance if there is some mistake on this article, as I just learn all of it during the Defcon.</p>
<p>During Defcon, I only work on three challenge with the help of my teammates, which are same_old, hash-it, and smuggler&rsquo;s cove. We submit the flag for same_old and hash-it, and I spend the whole two days on the smuggler&rsquo;s cove, but failed to solve it.</p>
<p>On this article, I&rsquo;ll try to summarize what I learned during working on the chall, my failed attempts on smuggler&rsquo;s cove, and the correct approach which I know after the CTF ended. I write this for my future notes in case I faced this kind of problem again.</p>
<h2 id="smugglers-cove">Smuggler&rsquo;s Cove <a href="#smugglers-cove" class="anchor">#</a></h2>
<h3 id="initial-analysis">Initial Analysis <a href="#initial-analysis" class="anchor">#</a></h3>
<p>On this chall, we were given <code>Dockerfile</code>, <code>cove.c</code>, <code>dig_up_the_loot.c</code>, and the binaries of the given source code. Let&rsquo;s take a look on the <code>Dockerfile</code>. The server is running the binary of <code>cove.c</code>.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>FROM ubuntu:20.04
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>WORKDIR /challenge
</span></span><span style="display:flex;"><span>ARG DEBIAN_FRONTEND=noninteractive
</span></span><span style="display:flex;"><span># upgrade ran at Fri May 27 15:18:42 UTC 2022 (see packages.txt)
</span></span><span style="display:flex;"><span>RUN apt-get update &amp;&amp; apt-get upgrade -y &amp;&amp; apt-get install curl -y &amp;&amp; apt list --installed &gt; /packages.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COPY libluajit-5.1.so.2 /usr/local/lib/libluajit-5.1.so.2
</span></span><span style="display:flex;"><span>COPY cove dig_up_the_loot /challenge/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RUN ldconfig &amp;&amp; chmod 111 /challenge/dig_up_the_loot
</span></span><span style="display:flex;"><span>RUN adduser --no-create-home --disabled-password --gecos &#34;&#34; user
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USER user
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ENTRYPOINT [&#34;/challenge/cove&#34;]
</span></span></code></pre></td></tr></table>
</div>
</div><p>So the server was running the most recent of Ubuntu20.04, which got upgraded just on Friday (D-1 Defcon CTF). I think this will help us a lot, as I also use Ubuntu20.04 on my local, and I can simply run update &amp; upgrade to replicate the server environment.</p>
<p>Now, checking the file <code>dig_up_the_loot.c</code></p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&lt;stdio.h&gt;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&lt;stdlib.h&gt;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&lt;string.h&gt;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">char</span><span style="color:#555">*</span> args[] <span style="color:#555">=</span> { <span style="color:#c30">&#34;x&#34;</span>, <span style="color:#c30">&#34;marks&#34;</span>, <span style="color:#c30">&#34;the&#34;</span>, <span style="color:#c30">&#34;spot&#34;</span> };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">int</span> <span style="color:#c0f">main</span>(<span style="color:#078;font-weight:bold">int</span> argc, <span style="color:#078;font-weight:bold">char</span><span style="color:#555">**</span> argv) {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">const</span> size_t num_args <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">sizeof</span>(args)<span style="color:#555">/</span><span style="color:#069;font-weight:bold">sizeof</span>(<span style="color:#078;font-weight:bold">char</span><span style="color:#555">*</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (argc <span style="color:#555">!=</span> num_args <span style="color:#555">+</span> <span style="color:#f60">1</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#c30">&#34;Avast ye missing arguments: ./dig_up_the_loot&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">for</span> (size_t i<span style="color:#555">=</span><span style="color:#f60">0</span>; i<span style="color:#555">&lt;</span>num_args; i<span style="color:#555">++</span>)
</span></span><span style="display:flex;"><span>            printf(<span style="color:#c30">&#34; %s&#34;</span>, args[i]);
</span></span><span style="display:flex;"><span>        puts(<span style="color:#c30">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        exit(<span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">for</span> (size_t i<span style="color:#555">=</span><span style="color:#f60">0</span>; i<span style="color:#555">&lt;</span>num_args; i<span style="color:#555">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">if</span> (strcmp(argv[i<span style="color:#555">+</span><span style="color:#f60">1</span>], args[i])) {
</span></span><span style="display:flex;"><span>            puts(<span style="color:#c30">&#34;Blimey! Are missing your map?&#34;</span>);
</span></span><span style="display:flex;"><span>            exit(<span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    puts(<span style="color:#c30">&#34;Shiver me timbers! Thar be your flag: FLAG PLACEHOLDER&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, so seems like we need to run <code>./dig_up_the_loot x marks the spot</code> in order to retrieve the flag. Let&rsquo;s move to the main source code (<code>cove.c</code>), which we should abuse.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&lt;stdio.h&gt;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&lt;lua.h&gt;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&lt;lualib.h&gt;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&lt;lauxlib.h&gt;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&#34;luajit.h&#34;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&#34;lj_dispatch.h&#34;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&#34;lj_obj.h&#34;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&lt;sys/mman.h&gt;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span><span style="color:#099">#define MAX_SIZE 433
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span>GCtrace<span style="color:#555">*</span> <span style="color:#c0f">getTrace</span>(lua_State<span style="color:#555">*</span> L, <span style="color:#078;font-weight:bold">uint8_t</span> index) {
</span></span><span style="display:flex;"><span>    jit_State<span style="color:#555">*</span> js <span style="color:#555">=</span> L2J(L);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (index <span style="color:#555">&gt;=</span> js<span style="color:#555">-&gt;</span>sizetrace)
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> <span style="color:#366">NULL</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> (GCtrace<span style="color:#555">*</span>)gcref(js<span style="color:#555">-&gt;</span>trace[index]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">int</span> <span style="color:#c0f">print</span>(lua_State<span style="color:#555">*</span> L) {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (lua_gettop(L) <span style="color:#555">&lt;</span> <span style="color:#f60">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> luaL_error(L, <span style="color:#c30">&#34;expecting at least 1 arguments&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span><span style="color:#555">*</span> s <span style="color:#555">=</span> lua_tostring(L, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>    puts(s);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">int</span> <span style="color:#c0f">debug_jit</span>(lua_State<span style="color:#555">*</span> L) {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (lua_gettop(L) <span style="color:#555">!=</span> <span style="color:#f60">2</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> luaL_error(L, <span style="color:#c30">&#34;expecting exactly 1 arguments&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    luaL_checktype(L, <span style="color:#f60">1</span>, LUA_TFUNCTION);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">const</span> GCfunc<span style="color:#555">*</span> v <span style="color:#555">=</span> lua_topointer(L, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>isluafunc(v)) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> luaL_error(L, <span style="color:#c30">&#34;expecting lua function&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint8_t</span> offset <span style="color:#555">=</span> lua_tointeger(L, <span style="color:#f60">2</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint8_t</span><span style="color:#555">*</span> bytecode <span style="color:#555">=</span> mref(v<span style="color:#555">-&gt;</span>l.pc, <span style="color:#078;font-weight:bold">void</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint8_t</span> op <span style="color:#555">=</span> bytecode[<span style="color:#f60">0</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint8_t</span> index <span style="color:#555">=</span> bytecode[<span style="color:#f60">2</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    GCtrace<span style="color:#555">*</span> t <span style="color:#555">=</span> getTrace(L, index);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>t <span style="color:#555">||</span> <span style="color:#555">!</span>t<span style="color:#555">-&gt;</span>mcode <span style="color:#555">||</span> <span style="color:#555">!</span>t<span style="color:#555">-&gt;</span>szmcode) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> luaL_error(L, <span style="color:#c30">&#34;Blimey! There is no cargo in this ship!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printf(<span style="color:#c30">&#34;INSPECTION: This ship&#39;s JIT cargo was found to be %p</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>, t<span style="color:#555">-&gt;</span>mcode);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (offset <span style="color:#555">!=</span> <span style="color:#f60">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">if</span> (offset <span style="color:#555">&gt;=</span> t<span style="color:#555">-&gt;</span>szmcode <span style="color:#555">-</span> <span style="color:#f60">1</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#069;font-weight:bold">return</span> luaL_error(L, <span style="color:#c30">&#34;Avast! Offset too large!&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        t<span style="color:#555">-&gt;</span>mcode <span style="color:#555">+=</span> offset;
</span></span><span style="display:flex;"><span>        t<span style="color:#555">-&gt;</span>szmcode <span style="color:#555">-=</span> offset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        printf(<span style="color:#c30">&#34;... yarr let ye apply a secret offset, cargo is now %p ...</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>, t<span style="color:#555">-&gt;</span>mcode);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">set_jit_settings</span>(lua_State<span style="color:#555">*</span> L) {
</span></span><span style="display:flex;"><span>    luaL_dostring(L,
</span></span><span style="display:flex;"><span>        <span style="color:#c30">&#34;jit.opt.start(&#39;3&#39;);&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c30">&#34;jit.opt.start(&#39;hotloop=1&#39;);&#34;</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">init_lua</span>(lua_State<span style="color:#555">*</span> L) {
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">// Init JIT lib
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    lua_pushcfunction(L, luaopen_jit);
</span></span><span style="display:flex;"><span>    lua_pushstring(L, LUA_JITLIBNAME);
</span></span><span style="display:flex;"><span>    lua_call(L, <span style="color:#f60">1</span>, <span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    set_jit_settings(L);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    lua_pushnil(L);
</span></span><span style="display:flex;"><span>    lua_setglobal(L, <span style="color:#c30">&#34;jit&#34;</span>);
</span></span><span style="display:flex;"><span>    lua_pop(L, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    lua_pushcfunction(L, debug_jit);
</span></span><span style="display:flex;"><span>    lua_setglobal(L, <span style="color:#c30">&#34;cargo&#34;</span>);
</span></span><span style="display:flex;"><span>    lua_pushcfunction(L, print);
</span></span><span style="display:flex;"><span>    lua_setglobal(L, <span style="color:#c30">&#34;print&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">run_code</span>(lua_State<span style="color:#555">*</span> L, <span style="color:#078;font-weight:bold">char</span><span style="color:#555">*</span> path) {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">const</span> size_t max_size <span style="color:#555">=</span> MAX_SIZE;
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">char</span><span style="color:#555">*</span> code <span style="color:#555">=</span> calloc(max_size<span style="color:#555">+</span><span style="color:#f60">1</span>, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    FILE<span style="color:#555">*</span> f <span style="color:#555">=</span> fopen(path,<span style="color:#c30">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (f <span style="color:#555">==</span> <span style="color:#366">NULL</span>) {
</span></span><span style="display:flex;"><span>        puts(<span style="color:#c30">&#34;Unable to open file&#34;</span>);
</span></span><span style="display:flex;"><span>        exit(<span style="color:#555">-</span><span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    fseek(f, <span style="color:#f60">0</span>, SEEK_END);
</span></span><span style="display:flex;"><span>    size_t size <span style="color:#555">=</span> ftell(f);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (size <span style="color:#555">&gt;</span> max_size) {
</span></span><span style="display:flex;"><span>        puts(<span style="color:#c30">&#34;Too large&#34;</span>);
</span></span><span style="display:flex;"><span>        exit(<span style="color:#555">-</span><span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    fseek(f, <span style="color:#f60">0</span>, SEEK_SET);
</span></span><span style="display:flex;"><span>    fread(code, <span style="color:#f60">1</span>, size, f);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    fclose(stdin);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">int</span> ret <span style="color:#555">=</span> luaL_dostring(L, code);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (ret <span style="color:#555">!=</span> <span style="color:#f60">0</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#c30">&#34;Lua error: %s</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>, lua_tostring(L, <span style="color:#555">-</span><span style="color:#f60">1</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">int</span> <span style="color:#c0f">main</span>(<span style="color:#078;font-weight:bold">int</span> argc, <span style="color:#078;font-weight:bold">char</span><span style="color:#555">**</span> argv) {
</span></span><span style="display:flex;"><span>    setvbuf(stdout, <span style="color:#366">NULL</span>, _IONBF, <span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    lua_State <span style="color:#555">*</span>L;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (argc <span style="color:#555">&lt;</span> <span style="color:#f60">2</span>) {
</span></span><span style="display:flex;"><span>        puts(<span style="color:#c30">&#34;Missing lua cargo to inspect&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span><span style="color:#f60">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    L <span style="color:#555">=</span> luaL_newstate();
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>L) {
</span></span><span style="display:flex;"><span>        puts(<span style="color:#c30">&#34;Failed to load lua&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span><span style="color:#f60">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    init_lua(L);
</span></span><span style="display:flex;"><span>    run_code(L, argv[<span style="color:#f60">1</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    lua_close(L);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>I never knew what is Lua before working on this chall, so during working on this chall:</p>
<ul>
<li>I open the <a href="https://www.lua.org/manual/5.1/" target="_blank" rel="noopener">Lua documentation</a></li>
<li>I clone the <a href="https://github.com/LuaJIT/LuaJIT" target="_blank" rel="noopener">Luajit</a> repo</li>
<li>I debug it with GDB one by one to understand better about it.</li>
</ul>
<p>Based on the file included header, I assume that we are dealing with LuaJIT instead of baseline lua. Which is why I try to clone the Luajit also to understand some method functionality.</p>
<p>Let&rsquo;s try to analysis the source code first. We start by reading the main func</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">int</span> <span style="color:#c0f">main</span>(<span style="color:#078;font-weight:bold">int</span> argc, <span style="color:#078;font-weight:bold">char</span><span style="color:#555">**</span> argv) {
</span></span><span style="display:flex;"><span>    setvbuf(stdout, <span style="color:#366">NULL</span>, _IONBF, <span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    lua_State <span style="color:#555">*</span>L;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (argc <span style="color:#555">&lt;</span> <span style="color:#f60">2</span>) {
</span></span><span style="display:flex;"><span>        puts(<span style="color:#c30">&#34;Missing lua cargo to inspect&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span><span style="color:#f60">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    L <span style="color:#555">=</span> luaL_newstate();
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>L) {
</span></span><span style="display:flex;"><span>        puts(<span style="color:#c30">&#34;Failed to load lua&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span><span style="color:#f60">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    init_lua(L);
</span></span><span style="display:flex;"><span>    run_code(L, argv[<span style="color:#f60">1</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    lua_close(L);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>So the main function basically will init some initial state of the luajit (I don&rsquo;t know yet what is lua state?), and we need to pass an arg (?). Let&rsquo;s take a look on the <code>run_code</code> first, so that we know what is the <code>arg</code> value.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">run_code</span>(lua_State<span style="color:#555">*</span> L, <span style="color:#078;font-weight:bold">char</span><span style="color:#555">*</span> path) {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">const</span> size_t max_size <span style="color:#555">=</span> MAX_SIZE;
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">char</span><span style="color:#555">*</span> code <span style="color:#555">=</span> calloc(max_size<span style="color:#555">+</span><span style="color:#f60">1</span>, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    FILE<span style="color:#555">*</span> f <span style="color:#555">=</span> fopen(path,<span style="color:#c30">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (f <span style="color:#555">==</span> <span style="color:#366">NULL</span>) {
</span></span><span style="display:flex;"><span>        puts(<span style="color:#c30">&#34;Unable to open file&#34;</span>);
</span></span><span style="display:flex;"><span>        exit(<span style="color:#555">-</span><span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    fseek(f, <span style="color:#f60">0</span>, SEEK_END);
</span></span><span style="display:flex;"><span>    size_t size <span style="color:#555">=</span> ftell(f);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (size <span style="color:#555">&gt;</span> max_size) {
</span></span><span style="display:flex;"><span>        puts(<span style="color:#c30">&#34;Too large&#34;</span>);
</span></span><span style="display:flex;"><span>        exit(<span style="color:#555">-</span><span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    fseek(f, <span style="color:#f60">0</span>, SEEK_SET);
</span></span><span style="display:flex;"><span>    fread(code, <span style="color:#f60">1</span>, size, f);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    fclose(stdin);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">int</span> ret <span style="color:#555">=</span> luaL_dostring(L, code);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (ret <span style="color:#555">!=</span> <span style="color:#f60">0</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#c30">&#34;Lua error: %s</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>, lua_tostring(L, <span style="color:#555">-</span><span style="color:#f60">1</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ah, so turn out the arg is the lua script filename. And later, <code>run_code</code> will try to load this code in the memory, and pass it to <code>luaL_dostring</code>. Notes that there is a limit of the lua script size that we can submit. I assume that <code>luaL_dostring</code> is method in the Luajit library, which will execute the given code.
Moving back, let&rsquo;s take a look on what does the <code>init_lua</code> do.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">set_jit_settings</span>(lua_State<span style="color:#555">*</span> L) {
</span></span><span style="display:flex;"><span>    luaL_dostring(L,
</span></span><span style="display:flex;"><span>        <span style="color:#c30">&#34;jit.opt.start(&#39;3&#39;);&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c30">&#34;jit.opt.start(&#39;hotloop=1&#39;);&#34;</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">init_lua</span>(lua_State<span style="color:#555">*</span> L) {
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">// Init JIT lib
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    lua_pushcfunction(L, luaopen_jit);
</span></span><span style="display:flex;"><span>    lua_pushstring(L, LUA_JITLIBNAME);
</span></span><span style="display:flex;"><span>    lua_call(L, <span style="color:#f60">1</span>, <span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    set_jit_settings(L);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    lua_pushnil(L);
</span></span><span style="display:flex;"><span>    lua_setglobal(L, <span style="color:#c30">&#34;jit&#34;</span>);
</span></span><span style="display:flex;"><span>    lua_pop(L, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    lua_pushcfunction(L, debug_jit);
</span></span><span style="display:flex;"><span>    lua_setglobal(L, <span style="color:#c30">&#34;cargo&#34;</span>);
</span></span><span style="display:flex;"><span>    lua_pushcfunction(L, print);
</span></span><span style="display:flex;"><span>    lua_setglobal(L, <span style="color:#c30">&#34;print&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>I don&rsquo;t understand at all what this method do as this is the first time I learn Lua. So, what I do is checking the official documentation of Lua. This is what it says about <code>lua_call</code> API.
<p class="markdown-image">
  <img src="https://i.imgur.com/3gY4Bbu.png" alt=""  />
</p></p>
<p>Ah okay! So turn out, you need to push the function that you want to call + the args. So the first four lines is trying to to load <code>LUA_JITLIBNAME</code> library, and then call <code>set_jit_settings</code>, which set the jit configs. Details of what the config means can be found in <a href="https://luajit.org/ext_jit.html" target="_blank" rel="noopener">here</a> and <a href="https://luajit.org/running.html" target="_blank" rel="noopener">here</a>.</p>
<p>And then, let see the next code</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    lua_pushnil(L);
</span></span><span style="display:flex;"><span>    lua_setglobal(L, <span style="color:#c30">&#34;jit&#34;</span>);
</span></span><span style="display:flex;"><span>    lua_pop(L, <span style="color:#f60">1</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p><p class="markdown-image">
  <img src="https://i.imgur.com/IjmBm8R.png" alt=""  />
</p></p>
<p>Based on the documentation, basically it set global variable <code>jit</code> to nil. So that means, we can&rsquo;t use library <code>jit</code> during passing our code to the binary.</p>
<p>And the last piece of code is</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    lua_pushcfunction(L, debug_jit);
</span></span><span style="display:flex;"><span>    lua_setglobal(L, <span style="color:#c30">&#34;cargo&#34;</span>);
</span></span><span style="display:flex;"><span>    lua_pushcfunction(L, print);
</span></span><span style="display:flex;"><span>    lua_setglobal(L, <span style="color:#c30">&#34;print&#34;</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p><p class="markdown-image">
  <img src="https://i.imgur.com/i9kw0gg.png" alt=""  />
</p></p>
<p>On this code, what it does is basically, if we call <code>cargo</code> or <code>print</code> in our input lua script, the Luajit will call the defined <code>debug_jit</code> and <code>print</code> c-function instead. Let&rsquo;s take a look on the <code>print</code> method first.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">int</span> <span style="color:#c0f">print</span>(lua_State<span style="color:#555">*</span> L) {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (lua_gettop(L) <span style="color:#555">&lt;</span> <span style="color:#f60">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> luaL_error(L, <span style="color:#c30">&#34;expecting at least 1 arguments&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span><span style="color:#555">*</span> s <span style="color:#555">=</span> lua_tostring(L, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>    puts(s);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Nothing special, basically we can pass one lua element, convert it to string, and print it. Now, let&rsquo;s take a look on the <code>debug_jit</code> method</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">int</span> <span style="color:#c0f">debug_jit</span>(lua_State<span style="color:#555">*</span> L) {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (lua_gettop(L) <span style="color:#555">!=</span> <span style="color:#f60">2</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> luaL_error(L, <span style="color:#c30">&#34;expecting exactly 1 arguments&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    luaL_checktype(L, <span style="color:#f60">1</span>, LUA_TFUNCTION);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">const</span> GCfunc<span style="color:#555">*</span> v <span style="color:#555">=</span> lua_topointer(L, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>isluafunc(v)) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> luaL_error(L, <span style="color:#c30">&#34;expecting lua function&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint8_t</span> offset <span style="color:#555">=</span> lua_tointeger(L, <span style="color:#f60">2</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint8_t</span><span style="color:#555">*</span> bytecode <span style="color:#555">=</span> mref(v<span style="color:#555">-&gt;</span>l.pc, <span style="color:#078;font-weight:bold">void</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint8_t</span> op <span style="color:#555">=</span> bytecode[<span style="color:#f60">0</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint8_t</span> index <span style="color:#555">=</span> bytecode[<span style="color:#f60">2</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    GCtrace<span style="color:#555">*</span> t <span style="color:#555">=</span> getTrace(L, index);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>t <span style="color:#555">||</span> <span style="color:#555">!</span>t<span style="color:#555">-&gt;</span>mcode <span style="color:#555">||</span> <span style="color:#555">!</span>t<span style="color:#555">-&gt;</span>szmcode) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> luaL_error(L, <span style="color:#c30">&#34;Blimey! There is no cargo in this ship!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printf(<span style="color:#c30">&#34;INSPECTION: This ship&#39;s JIT cargo was found to be %p</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>, t<span style="color:#555">-&gt;</span>mcode);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (offset <span style="color:#555">!=</span> <span style="color:#f60">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">if</span> (offset <span style="color:#555">&gt;=</span> t<span style="color:#555">-&gt;</span>szmcode <span style="color:#555">-</span> <span style="color:#f60">1</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#069;font-weight:bold">return</span> luaL_error(L, <span style="color:#c30">&#34;Avast! Offset too large!&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        t<span style="color:#555">-&gt;</span>mcode <span style="color:#555">+=</span> offset;
</span></span><span style="display:flex;"><span>        t<span style="color:#555">-&gt;</span>szmcode <span style="color:#555">-=</span> offset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        printf(<span style="color:#c30">&#34;... yarr let ye apply a secret offset, cargo is now %p ...</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>, t<span style="color:#555">-&gt;</span>mcode);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>So based on that code, seems like <code>debug_jit</code> will need 2 arguments. Let&rsquo;s disass it one by one.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    luaL_checktype(L, <span style="color:#f60">1</span>, LUA_TFUNCTION);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">const</span> GCfunc<span style="color:#555">*</span> v <span style="color:#555">=</span> lua_topointer(L, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>isluafunc(v)) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> luaL_error(L, <span style="color:#c30">&#34;expecting lua function&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>So, the first argument needs to be a lua function. Reading through the documentation of <code>lua_topointer</code>
<p class="markdown-image">
  <img src="https://i.imgur.com/tE0du9z.png" alt=""  />
</p>
What it does is generate a c pointer to the given function.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint8_t</span> offset <span style="color:#555">=</span> lua_tointeger(L, <span style="color:#f60">2</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint8_t</span><span style="color:#555">*</span> bytecode <span style="color:#555">=</span> mref(v<span style="color:#555">-&gt;</span>l.pc, <span style="color:#078;font-weight:bold">void</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint8_t</span> op <span style="color:#555">=</span> bytecode[<span style="color:#f60">0</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint8_t</span> index <span style="color:#555">=</span> bytecode[<span style="color:#f60">2</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    GCtrace<span style="color:#555">*</span> t <span style="color:#555">=</span> getTrace(L, index);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>t <span style="color:#555">||</span> <span style="color:#555">!</span>t<span style="color:#555">-&gt;</span>mcode <span style="color:#555">||</span> <span style="color:#555">!</span>t<span style="color:#555">-&gt;</span>szmcode) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> luaL_error(L, <span style="color:#c30">&#34;Blimey! There is no cargo in this ship!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printf(<span style="color:#c30">&#34;INSPECTION: This ship&#39;s JIT cargo was found to be %p</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>, t<span style="color:#555">-&gt;</span>mcode);
</span></span></code></pre></td></tr></table>
</div>
</div><p>And then, we can see that the second argument is stored as <code>offset</code> with type <code>uint8_t</code>. So offset will never be a negative value. We will back to what <code>offset</code> is actually doing later.</p>
<p>We see that from the retrieved pointer <code>v</code>, we try to get the bytecode, get its <code>op</code> and <code>index</code>, and then the <code>index</code> got passed to <code>getTrace</code> function. And the result isn&rsquo;t allowed to be nil.</p>
<p>I don&rsquo;t know at all what is <code>GCtrace</code>, and I don&rsquo;t know how Luajit working. So let&rsquo;s try to gather some knowledge on what it is, and what the code is doing.</p>
<blockquote>
<p>Notes that what a JIT does is usually parsing the source code into their own bytecode, and then execute it. This bytecodes are machine agnostic. And then, some bytecode will be compiled and stored as native machine code as part of JIT optimization. By doing this, JIT can always ensure that it will always optimize the compiled code based on the target machine architecture.</p>
</blockquote>
<p>Based on this <a href="https://pwparchive.wordpress.com/2012/10/16/peeking-inside-luajit/" target="_blank" rel="noopener">nice article</a> about Luajit, I learned that Luajit is a <strong>tracing-JIT</strong> instead of <strong>method-JIT</strong>. So, instead of optimizing hot method (method those are frequently called or executed), it will record sequence of executing operations frequency, and then only compile sequence which are frequently to be executed (hot traces). Based on <a href="https://en.wikipedia.org/wiki/Tracing_just-in-time_compilation" target="_blank" rel="noopener">wikipedia</a>, tracing JIT assumes that hot loops (frequent loops or repetition of sequential operations) will make program spend a lot of time.</p>
<blockquote>
<p>trace is an object which refer to the JIT-Compiled machine code version of the sequence of the bytecodes</p>
</blockquote>
<p>Moving back to the given code, now we can deduce more about what it actually does. So, my deduction is, from our chosen function, it will check its bytecode of the function. Based on the <a href="http://wiki.luajit.org/Bytecode-2.0" target="_blank" rel="noopener">Luajit bytecode documentation</a>, there are two formats on how a bytecode stored.
<p class="markdown-image">
  <img src="https://i.imgur.com/fPoqo71.png" alt=""  />
</p>
We can see in below image, that for function which is JIT-compiled, it will follow the second format.
<p class="markdown-image">
  <img src="https://i.imgur.com/MvtxuCa.png" alt=""  />
</p>
Now, we can understand better on what this snippet code does.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint8_t</span><span style="color:#555">*</span> bytecode <span style="color:#555">=</span> mref(v<span style="color:#555">-&gt;</span>l.pc, <span style="color:#078;font-weight:bold">void</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint8_t</span> op <span style="color:#555">=</span> bytecode[<span style="color:#f60">0</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint8_t</span> index <span style="color:#555">=</span> bytecode[<span style="color:#f60">2</span>];
</span></span></code></pre></td></tr></table>
</div>
</div><p>Basically, what it want to achieve is, it will try to retrieve the trace number (index) of the given function in the <code>debug_jit</code> arg. And then, it will try to get the trace based on the stored trace&rsquo;s index. Notes that because Luajit is <strong>tracing-JIT</strong>, based on my understanding, it is possible that a function didn&rsquo;t get JIT-Compiled, and it is possible that some sequential operation inside of the method is the one who got traced.</p>
<p>Now, Let&rsquo;s check the <code>getTrace</code> method.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>GCtrace<span style="color:#555">*</span> <span style="color:#c0f">getTrace</span>(lua_State<span style="color:#555">*</span> L, <span style="color:#078;font-weight:bold">uint8_t</span> index) {
</span></span><span style="display:flex;"><span>    jit_State<span style="color:#555">*</span> js <span style="color:#555">=</span> L2J(L);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (index <span style="color:#555">&gt;=</span> js<span style="color:#555">-&gt;</span>sizetrace)
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> <span style="color:#366">NULL</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> (GCtrace<span style="color:#555">*</span>)gcref(js<span style="color:#555">-&gt;</span>trace[index]);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ah from the code, we can deduce that, in the memory, there are an array of pointer, where each pointer points to a trace object (<code>GCtrace</code>). In the given binary, basically this method will be used to return the method <code>GCTrace</code> object if the method got JIT-Compiled. And the trace-index is retrieved from the function header bytecode (which we have retrieved in the previous snippet).</p>
<p>Let&rsquo;s move to the final code</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>t <span style="color:#555">||</span> <span style="color:#555">!</span>t<span style="color:#555">-&gt;</span>mcode <span style="color:#555">||</span> <span style="color:#555">!</span>t<span style="color:#555">-&gt;</span>szmcode) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> luaL_error(L, <span style="color:#c30">&#34;Blimey! There is no cargo in this ship!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printf(<span style="color:#c30">&#34;INSPECTION: This ship&#39;s JIT cargo was found to be %p</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>, t<span style="color:#555">-&gt;</span>mcode);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (offset <span style="color:#555">!=</span> <span style="color:#f60">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">if</span> (offset <span style="color:#555">&gt;=</span> t<span style="color:#555">-&gt;</span>szmcode <span style="color:#555">-</span> <span style="color:#f60">1</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#069;font-weight:bold">return</span> luaL_error(L, <span style="color:#c30">&#34;Avast! Offset too large!&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        t<span style="color:#555">-&gt;</span>mcode <span style="color:#555">+=</span> offset;
</span></span><span style="display:flex;"><span>        t<span style="color:#555">-&gt;</span>szmcode <span style="color:#555">-=</span> offset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        printf(<span style="color:#c30">&#34;... yarr let ye apply a secret offset, cargo is now %p ...</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>, t<span style="color:#555">-&gt;</span>mcode);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> <span style="color:#f60">0</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>To understand it better, let&rsquo;s check the <code>GCTrace</code> struct definition from our cloned Luajit repository.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">/* Trace object. */</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">typedef</span> <span style="color:#069;font-weight:bold">struct</span> GCtrace {
</span></span><span style="display:flex;"><span>  GCHeader;
</span></span><span style="display:flex;"><span>  <span style="color:#078;font-weight:bold">uint16_t</span> nsnap;	<span style="color:#09f;font-style:italic">/* Number of snapshots. */</span>
</span></span><span style="display:flex;"><span>  IRRef nins;		<span style="color:#09f;font-style:italic">/* Next IR instruction. Biased with REF_BIAS. */</span>
</span></span><span style="display:flex;"><span><span style="color:#099">#if LJ_GC64
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>  <span style="color:#078;font-weight:bold">uint32_t</span> unused_gc64;
</span></span><span style="display:flex;"><span><span style="color:#099">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>  GCRef gclist;
</span></span><span style="display:flex;"><span>  IRIns <span style="color:#555">*</span>ir;		<span style="color:#09f;font-style:italic">/* IR instructions/constants. Biased with REF_BIAS. */</span>
</span></span><span style="display:flex;"><span>  IRRef nk;		<span style="color:#09f;font-style:italic">/* Lowest IR constant. Biased with REF_BIAS. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#078;font-weight:bold">uint32_t</span> nsnapmap;	<span style="color:#09f;font-style:italic">/* Number of snapshot map elements. */</span>
</span></span><span style="display:flex;"><span>  SnapShot <span style="color:#555">*</span>snap;	<span style="color:#09f;font-style:italic">/* Snapshot array. */</span>
</span></span><span style="display:flex;"><span>  SnapEntry <span style="color:#555">*</span>snapmap;	<span style="color:#09f;font-style:italic">/* Snapshot map. */</span>
</span></span><span style="display:flex;"><span>  GCRef startpt;	<span style="color:#09f;font-style:italic">/* Starting prototype. */</span>
</span></span><span style="display:flex;"><span>  MRef startpc;		<span style="color:#09f;font-style:italic">/* Bytecode PC of starting instruction. */</span>
</span></span><span style="display:flex;"><span>  BCIns startins;	<span style="color:#09f;font-style:italic">/* Original bytecode of starting instruction. */</span>
</span></span><span style="display:flex;"><span>  MSize szmcode;	<span style="color:#09f;font-style:italic">/* Size of machine code. */</span>
</span></span><span style="display:flex;"><span>  MCode <span style="color:#555">*</span>mcode;		<span style="color:#09f;font-style:italic">/* Start of machine code. */</span>
</span></span><span style="display:flex;"><span>  MSize mcloop;		<span style="color:#09f;font-style:italic">/* Offset of loop start in machine code. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#078;font-weight:bold">uint16_t</span> nchild;	<span style="color:#09f;font-style:italic">/* Number of child traces (root trace only). */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#078;font-weight:bold">uint16_t</span> spadjust;	<span style="color:#09f;font-style:italic">/* Stack pointer adjustment (offset in bytes). */</span>
</span></span><span style="display:flex;"><span>  TraceNo1 traceno;	<span style="color:#09f;font-style:italic">/* Trace number. */</span>
</span></span><span style="display:flex;"><span>  TraceNo1 link;	<span style="color:#09f;font-style:italic">/* Linked trace (or self for loops). */</span>
</span></span><span style="display:flex;"><span>  TraceNo1 root;	<span style="color:#09f;font-style:italic">/* Root trace of side trace (or 0 for root traces). */</span>
</span></span><span style="display:flex;"><span>  TraceNo1 nextroot;	<span style="color:#09f;font-style:italic">/* Next root trace for same prototype. */</span>
</span></span><span style="display:flex;"><span>  TraceNo1 nextside;	<span style="color:#09f;font-style:italic">/* Next side trace of same root trace. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#078;font-weight:bold">uint8_t</span> sinktags;	<span style="color:#09f;font-style:italic">/* Trace has SINK tags. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#078;font-weight:bold">uint8_t</span> topslot;	<span style="color:#09f;font-style:italic">/* Top stack slot already checked to be allocated. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#078;font-weight:bold">uint8_t</span> linktype;	<span style="color:#09f;font-style:italic">/* Type of link. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#078;font-weight:bold">uint8_t</span> unused1;
</span></span><span style="display:flex;"><span><span style="color:#099">#ifdef LUAJIT_USE_GDBJIT
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>  <span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>gdbjit_entry;	<span style="color:#09f;font-style:italic">/* GDB JIT entry. */</span>
</span></span><span style="display:flex;"><span><span style="color:#099">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>} GCtrace;
</span></span></code></pre></td></tr></table>
</div>
</div><p>I think the comment code is already self-explanatory. What the code does is basically check whether:</p>
<ul>
<li>The returned <code>GCTrace</code> (which is <code>t</code>) from <code>getTrace</code> function is nil or not</li>
<li>The <code>mcode</code> (which is pointer to the start of the compiled machine code) is nil or not</li>
<li>The <code>szmcode</code> (which is the size of the compiled machine code) is 0 or not.</li>
</ul>
<p>Now, the final part is where the <code>offset</code> that we pass during calling the <code>debug_jit</code> is used. Turn out, the <code>debug_jit</code> method will allow us to <strong>shift the start of the compiled machine code</strong>, with restriction that the shift offset need to be less than the size of the compiled machine code. Finally, we understand what the given binary is actually doing.</p>
<h3 id="exploitation-plan">Exploitation Plan <a href="#exploitation-plan" class="anchor">#</a></h3>
<p>To summarize, so basically what the binary do is:</p>
<ul>
<li>Initialize a Luajit</li>
<li>Read our given lua script</li>
<li>Run it inside Luajit</li>
</ul>
<p>What make the given binary special is the <code>debug_jit</code> method, where we can use it to shift the start of our method JIT-compiled machine code (Notes that it only allowed us to shift the trace of Lua function which got JIT-Compiled).</p>
<p>So now, it is clear that, what we need to is somehow, use the <code>debug_jit</code> method feature, to do RCE and execute command <code>./dig_up_the_loot x marks the spot</code>.</p>
<p>Reading this <a href="http://pwning.net/pwn/2012/05/21/jit-source-and-writeup/" target="_blank" rel="noopener">writeup</a> from past CTF gave me a clear idea on how to do it. Basically, what we need to do is to craft a lua method, which the compiled machine code will have controllable constants. For example, what we aim to do is to have the trace machine code contains instruction like this</p>
<ul>
<li><code>mov rdi, 0x22eb006a61c18348</code></li>
<li><code>cmp ebp, 0x6161616161</code></li>
<li>etc</li>
</ul>
<p>And then, reserve the last 2 byte as our jump instruction to the other constant, and use the remaining bytes to craft our shellcode, which will execute our target command.</p>
<h3 id="failure">Failure <a href="#failure" class="anchor">#</a></h3>
<p>Well, at the end, I failed to solve it during the CTF, because I couldn&rsquo;t craft any payload which satisfy it. What I found during CTF is that if we able to produce bytecode <code>int LE xxx</code>, we can generate an int constant. But somehow, I can only produce it by using <code>for</code> loop, but as we know that Luajit is a <strong>tracing-method</strong>, it will only traced the <code>for</code> loop instead of the method that I defined. I use <code>luajit</code> to help me debugging it.
<p class="markdown-image">
  <img src="https://i.imgur.com/X1H4Ahd.png" alt=""  />
</p></p>
<p>Above is the only payload that I found during the CTF that able to produce constants, yet I can&rsquo;t use it because it is not a method trace (The trace is belong to the for loop sequence, not to the method that I defined).</p>
<h3 id="reflections">Reflections <a href="#reflections" class="anchor">#</a></h3>
<p>After the CTF end, the chall&rsquo;s author tell me on the trick how to produce the constants. And also I read two great writeups in ctftime (<a href="https://0xten.gitbook.io/public/defcon/2022/quals/smugglers-cove" target="_blank" rel="noopener">here</a> and <a href="https://uz56764.tistory.com/55" target="_blank" rel="noopener">here</a>) which is super great.</p>
<p>I missed out that in Lua, every number is by default treated as floating point, so the hex that I should consider inside the compiled machine code is floating-point hex. And turn out, some tricks that we can use to produce constants:</p>
<ul>
<li>Define the constant as index of an array. Ex <code>m[100]=0</code></li>
<li>Add <code>LL</code> suffix in comparison. Ex: <code>if i == 0xdeadbeefcafebabeLL</code></li>
</ul>
<p>I&rsquo;ve actually tried the index of array trick, but as I mentioned before, my mistake is not treating it as floating point, which make me failed to see the constant during debugging with the <code>luajit</code>. So when I specify <code>m[0x61616161]=0</code>, I expect to see <code>0x61616161</code> in the compiled machine code, while what the compiled machine code is converting it to floating-point hex representation due to the fact that Lua treat all numbers as floating point by default, which makes me unable to realize that I actually able to produce constant. This is a great lesson for me, as I failed to notice this during working on the chall.</p>
<p>So after reading the writeup, I managed to try to implement it and solve it in my local. I feel sad because I didn&rsquo;t solve this chall during working on the CTF, but on the bright part, I learned a lot of new things related to Luajit. I hope that if in the future I face a challenge related to Luajit, I&rsquo;ll be able to tackle and solve it.</p>
<p>Thanks for the chall&rsquo;s author and the writeup&rsquo;s author for providing me a new knowledge about this.</p>
<h3 id="sources">Sources <a href="#sources" class="anchor">#</a></h3>
<ul>
<li><a href="https://0xten.gitbook.io/public/defcon/2022/quals/smugglers-cove" target="_blank" rel="noopener">https://0xten.gitbook.io/public/defcon/2022/quals/smugglers-cove</a></li>
<li><a href="https://uz56764.tistory.com/55" target="_blank" rel="noopener">https://uz56764.tistory.com/55</a></li>
<li><a href="http://pwning.net/pwn/2012/05/21/jit-source-and-writeup/" target="_blank" rel="noopener">http://pwning.net/pwn/2012/05/21/jit-source-and-writeup/</a></li>
<li><a href="https://pwparchive.wordpress.com/2012/10/16/peeking-inside-luajit/" target="_blank" rel="noopener">https://pwparchive.wordpress.com/2012/10/16/peeking-inside-luajit/</a></li>
<li><a href="https://www.lua.org/manual/5.1/" target="_blank" rel="noopener">https://www.lua.org/manual/5.1/</a></li>
<li><a href="http://wiki.luajit.org/Bytecode-2.0" target="_blank" rel="noopener">http://wiki.luajit.org/Bytecode-2.0</a></li>
</ul>

      </div>
      
        
  <aside class="toc-container">
    <a href="#" style="font-weight: 700; color: black;">Defcon CTF 2022: Self-Reflection</a>
    <div class="js-toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li><a href="#smugglers-cove">Smuggler&rsquo;s Cove</a>
      <ul>
        <li><a href="#initial-analysis">Initial Analysis</a></li>
        <li><a href="#exploitation-plan">Exploitation Plan</a></li>
        <li><a href="#failure">Failure</a></li>
        <li><a href="#reflections">Reflections</a></li>
        <li><a href="#sources">Sources</a></li>
      </ul>
    </li>
  </ul>
</nav>
          </div>
      </details>
    </div>
  </aside>


      
    </div>

    
        <div class="tags">
            
                <a href="https://chovid99.github.io/tags/tech">tech</a>
            
                <a href="https://chovid99.github.io/tags/defconctf">DefconCTF</a>
            
                <a href="https://chovid99.github.io/tags/reflection">reflection</a>
            
                <a href="https://chovid99.github.io/tags/notes">notes</a>
            
                <a href="https://chovid99.github.io/tags/pwn">pwn</a>
            
                <a href="https://chovid99.github.io/tags/2022">2022</a>
            
        </div>
    
    
    
  <div id="comment">
    
    
  </div>


</section>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="/js/tocbot.min.js"></script>

<script type="text/javascript">
  tocbot.init({
      
      tocSelector: '.js-toc',
      
      contentSelector: '.js-toc-content',
      headingSelector: 'h1, h2, h3',
      orderedList: false,
      headingLabelCallback: s => s.substr(0, s.length-2),
      collapseDepth: 2
  });
  function initTOC() {
    var windowWidth = 1316;
    var $block_2 = $(".toc-container");
    var lastLeft = parseFloat($block_2.css("left").slice(0, -2))*(100/($(window).width()));
    $block_2.css("left", (lastLeft/lastWindowWidth)*$(window).width() + "vw");
  }
  window.onload = initTOC;

  var lastWindowWidth = $(window).width();
  $(window).resize(function() {
    var $block_2 = $(".toc-container");
    var lastLeft = parseFloat($block_2.css("left").slice(0, -2))*(100/($(window).width()));
    $block_2.css("left", (lastLeft/lastWindowWidth)*$(window).width() + "vw");
    lastWindowWidth = $(window).width();
  });
</script>

    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://github.com/Chovid99" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28"  viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>Github</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)">
            <g id="Github" transform="translate(264.000000, 939.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M35.9985,13 C22.746,13 12,23.7870921 12,37.096644 C12,47.7406712 18.876,56.7718301 28.4145,59.9584121 C29.6145,60.1797862 30.0525,59.4358488 30.0525,58.7973276 C30.0525,58.2250681 30.0315,56.7100863 30.0195,54.6996482 C23.343,56.1558981 21.9345,51.4693938 21.9345,51.4693938 C20.844,48.6864054 19.2705,47.9454799 19.2705,47.9454799 C17.091,46.4500754 19.4355,46.4801943 19.4355,46.4801943 C21.843,46.6503662 23.1105,48.9634994 23.1105,48.9634994 C25.2525,52.6455377 28.728,51.5823398 30.096,50.9649018 C30.3135,49.4077535 30.9345,48.3460615 31.62,47.7436831 C26.2905,47.1352808 20.688,45.0691228 20.688,35.8361671 C20.688,33.2052792 21.6225,31.0547881 23.1585,29.3696344 C22.911,28.7597262 22.0875,26.3110578 23.3925,22.9934585 C23.3925,22.9934585 25.4085,22.3459017 29.9925,25.4632101 C31.908,24.9285993 33.96,24.6620468 36.0015,24.6515052 C38.04,24.6620468 40.0935,24.9285993 42.0105,25.4632101 C46.5915,22.3459017 48.603,22.9934585 48.603,22.9934585 C49.9125,26.3110578 49.089,28.7597262 48.8415,29.3696344 C50.3805,31.0547881 51.309,33.2052792 51.309,35.8361671 C51.309,45.0917119 45.6975,47.1292571 40.3515,47.7256117 C41.2125,48.4695491 41.9805,49.9393525 41.9805,52.1877301 C41.9805,55.4089489 41.9505,58.0067059 41.9505,58.7973276 C41.9505,59.4418726 42.3825,60.1918338 43.6005,59.9554002 C53.13,56.7627944 60,47.7376593 60,37.096644 C60,23.7870921 49.254,13 35.9985,13" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>

    <a class="symbol" href="https://twitter.com/Chovid99" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="438.536px" height="438.536px" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536;"
	 xml:space="preserve">
<g>
	<path d="M414.41,24.123C398.333,8.042,378.963,0,356.315,0H82.228C59.58,0,40.21,8.042,24.126,24.123
		C8.045,40.207,0.003,59.576,0.003,82.225v274.084c0,22.647,8.042,42.018,24.123,58.102c16.084,16.084,35.454,24.126,58.102,24.126
		h274.084c22.648,0,42.018-8.042,58.095-24.126c16.084-16.084,24.126-35.454,24.126-58.102V82.225
		C438.532,59.576,430.49,40.204,414.41,24.123z M335.471,168.735c0.191,1.713,0.288,4.278,0.288,7.71
		c0,15.989-2.334,32.025-6.995,48.104c-4.661,16.087-11.8,31.504-21.416,46.254c-9.606,14.749-21.074,27.791-34.396,39.115
		c-13.325,11.32-29.311,20.365-47.968,27.117c-18.648,6.762-38.637,10.143-59.953,10.143c-33.116,0-63.76-8.952-91.931-26.836
		c4.568,0.568,9.329,0.855,14.275,0.855c27.6,0,52.439-8.565,74.519-25.7c-12.941-0.185-24.506-4.179-34.688-11.991
		c-10.185-7.803-17.273-17.699-21.271-29.691c4.947,0.76,8.658,1.137,11.132,1.137c4.187,0,9.042-0.76,14.56-2.279
		c-13.894-2.669-25.598-9.562-35.115-20.697c-9.519-11.136-14.277-23.84-14.277-38.114v-0.571
		c10.085,4.755,19.602,7.229,28.549,7.422c-17.321-11.613-25.981-28.265-25.981-49.963c0-10.66,2.758-20.747,8.278-30.264
		c15.035,18.464,33.311,33.213,54.816,44.252c21.507,11.038,44.54,17.227,69.092,18.558c-0.95-3.616-1.427-8.186-1.427-13.704
		c0-16.562,5.853-30.692,17.56-42.399c11.703-11.706,25.837-17.561,42.394-17.561c17.515,0,32.079,6.283,43.688,18.846
		c13.134-2.474,25.892-7.33,38.26-14.56c-4.757,14.652-13.613,25.788-26.55,33.402c12.368-1.716,23.88-4.95,34.537-9.708
		C357.458,149.793,347.462,160.166,335.471,168.735z"/>
</g>
</svg>

    </a>


</div>

    

    <div class="copyright">
    
       © Copyright 
       2022 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       Chovid99
    
    </div>

    
</footer>



  </body>
</html>
